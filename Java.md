# SE

## åŸºç¡€

### æ•°æ®

#### å˜é‡ç±»å‹

|          |    æˆå‘˜å˜é‡    |          å±€éƒ¨å˜é‡          |       é™æ€å˜é‡       |
| :------: | :------------: | :------------------------: | :------------------: |
| å®šä¹‰ä½ç½® | åœ¨ç±»ä¸­ï¼Œæ–¹æ³•å¤– |    æ–¹æ³•ä¸­æˆ–è€…æ–¹æ³•çš„å½¢å‚    |    åœ¨ç±»ä¸­ï¼Œæ–¹æ³•å¤–    |
| åˆå§‹åŒ–å€¼ | æœ‰é»˜è®¤åˆå§‹åŒ–å€¼ | æ— ï¼Œå…ˆå®šä¹‰ï¼Œå¤åˆ¶åæ‰èƒ½ä½¿ç”¨ |    æœ‰é»˜è®¤åˆå§‹åŒ–å€¼    |
| è°ƒç”¨æ–¹æ³• |    å¯¹è±¡è°ƒç”¨    |                            |  å¯¹è±¡è°ƒç”¨ï¼Œç±»åè°ƒç”¨  |
| å­˜å‚¨ä½ç½® |      å †ä¸­      |            æ ˆä¸­            |        æ–¹æ³•åŒº        |
| ç”Ÿå‘½å‘¨æœŸ |  ä¸å¯¹è±¡å…±å­˜äº¡  |        ä¸æ–¹æ³•å…±å­˜äº¡        |      ä¸ç±»å…±å­˜äº¡      |
|   åˆ«å   |    å®ä¾‹å˜é‡    |                            | ç±»å˜é‡ï¼Œé™æ€æˆå‘˜å˜é‡ |

**é™æ€å˜é‡åªæœ‰ä¸€ä¸ªï¼Œæˆå‘˜å˜é‡æ˜¯ç±»ä¸­çš„å˜é‡ï¼Œå±€éƒ¨å˜é‡æ˜¯æ–¹æ³•ä¸­çš„å˜é‡**



å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1TE41177mP



***



#### æ•°æ®ç±»å‹

##### åŸºæœ¬ç±»å‹

Java è¯­è¨€æä¾›äº†å…«ç§åŸºæœ¬ç±»å‹ã€‚å…­ç§æ•°å­—ç±»å‹ï¼ˆå››ä¸ªæ•´æ•°å‹ï¼Œä¸¤ä¸ªæµ®ç‚¹å‹ï¼‰ï¼Œä¸€ç§å­—ç¬¦ç±»å‹ï¼Œè¿˜æœ‰ä¸€ç§å¸ƒå°”å‹

**byteï¼š**

- byte æ•°æ®ç±»å‹æ˜¯ 8 ä½ã€æœ‰ç¬¦å·çš„ï¼Œä»¥**äºŒè¿›åˆ¶è¡¥ç **è¡¨ç¤ºçš„æ•´æ•°ï¼Œ**8 ä½ä¸€ä¸ªå­—èŠ‚**ï¼Œé¦–ä½æ˜¯ç¬¦å·ä½
- æœ€å°å€¼æ˜¯ **-128ï¼ˆ-2^7ï¼‰**
- æœ€å¤§å€¼æ˜¯ **127ï¼ˆ2^7-1ï¼‰**
- é»˜è®¤å€¼æ˜¯ **`0`**
- byte ç±»å‹ç”¨åœ¨å¤§å‹æ•°ç»„ä¸­èŠ‚çº¦ç©ºé—´ï¼Œä¸»è¦ä»£æ›¿æ•´æ•°ï¼Œbyte å˜é‡å ç”¨çš„ç©ºé—´åªæœ‰ int ç±»å‹çš„å››åˆ†ä¹‹ä¸€
- ä¾‹å­ï¼š`byte a = 100ï¼Œbyte b = -50`

**shortï¼š**

- short æ•°æ®ç±»å‹æ˜¯ 16 ä½ã€æœ‰ç¬¦å·çš„ä»¥äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„æ•´æ•°
- æœ€å°å€¼æ˜¯ **-32768ï¼ˆ-2^15ï¼‰**
- æœ€å¤§å€¼æ˜¯ **32767ï¼ˆ2^15 - 1ï¼‰**
- short æ•°æ®ç±»å‹ä¹Ÿå¯ä»¥åƒ byte é‚£æ ·èŠ‚çœç©ºé—´ï¼Œä¸€ä¸ªshortå˜é‡æ˜¯intå‹å˜é‡æ‰€å ç©ºé—´çš„äºŒåˆ†ä¹‹ä¸€
- é»˜è®¤å€¼æ˜¯ **`0`**
- ä¾‹å­ï¼š`short s = 1000ï¼Œshort r = -20000`

**intï¼š**

- int æ•°æ®ç±»å‹æ˜¯ 32 ä½ 4 å­—èŠ‚ã€æœ‰ç¬¦å·çš„ä»¥äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„æ•´æ•°
- æœ€å°å€¼æ˜¯ **-2,147,483,648ï¼ˆ-2^31ï¼‰**
- æœ€å¤§å€¼æ˜¯ **2,147,483,647ï¼ˆ2^31 - 1ï¼‰**
- ä¸€èˆ¬åœ°æ•´å‹å˜é‡é»˜è®¤ä¸º int ç±»å‹
- é»˜è®¤å€¼æ˜¯ **`0`** ï¼›
- ä¾‹å­ï¼š`int a = 100000, int b = -200000`

**longï¼š**

- long æ•°æ®ç±»å‹æ˜¯ 64 ä½ 8 å­—èŠ‚ã€æœ‰ç¬¦å·çš„ä»¥äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„æ•´æ•°
- æœ€å°å€¼æ˜¯ **-9,223,372,036,854,775,808ï¼ˆ-2^63ï¼‰**
- æœ€å¤§å€¼æ˜¯ **9,223,372,036,854,775,807ï¼ˆ2^63 -1ï¼‰**
- è¿™ç§ç±»å‹ä¸»è¦ä½¿ç”¨åœ¨éœ€è¦æ¯”è¾ƒå¤§æ•´æ•°çš„ç³»ç»Ÿä¸Š
- é»˜è®¤å€¼æ˜¯ **` 0L`**
- ä¾‹å­ï¼š `long a = 100000Lï¼ŒLong b = -200000L`
  "L"ç†è®ºä¸Šä¸åˆ†å¤§å°å†™ï¼Œä½†æ˜¯è‹¥å†™æˆ"l"å®¹æ˜“ä¸æ•°å­—"1"æ··æ·†ï¼Œä¸å®¹æ˜“åˆ†è¾©ï¼Œæ‰€ä»¥æœ€å¥½å¤§å†™

**floatï¼š**

- float æ•°æ®ç±»å‹æ˜¯å•ç²¾åº¦ã€32 ä½ã€ç¬¦åˆ IEEE 754 æ ‡å‡†çš„æµ®ç‚¹æ•°
- float åœ¨å‚¨å­˜å¤§å‹æµ®ç‚¹æ•°ç»„çš„æ—¶å€™å¯èŠ‚çœå†…å­˜ç©ºé—´
- é»˜è®¤å€¼æ˜¯ **`0.0f`**
- æµ®ç‚¹æ•°ä¸èƒ½ç”¨æ¥è¡¨ç¤ºç²¾ç¡®çš„å€¼ï¼Œå¦‚è´§å¸
- ä¾‹å­ï¼š`float f1 = 234.5F`

**doubleï¼š**

- double æ•°æ®ç±»å‹æ˜¯åŒç²¾åº¦ã€64 ä½ã€ç¬¦åˆ IEEE 754 æ ‡å‡†çš„æµ®ç‚¹æ•°
- æµ®ç‚¹æ•°çš„é»˜è®¤ç±»å‹ä¸º double ç±»å‹
- double ç±»å‹åŒæ ·ä¸èƒ½è¡¨ç¤ºç²¾ç¡®çš„å€¼ï¼Œå¦‚è´§å¸
- é»˜è®¤å€¼æ˜¯ **`0.0d`**
- ä¾‹å­ï¼š`double d1 = 123.4`

**booleanï¼š**

- boolean æ•°æ®ç±»å‹è¡¨ç¤ºä¸€ä½çš„ä¿¡æ¯
- åªæœ‰ä¸¤ä¸ªå–å€¼ï¼štrue å’Œ false
- JVM è§„èŒƒæŒ‡å‡º boolean å½“åš int å¤„ç†ï¼Œboolean æ•°ç»„å½“åš byte æ•°ç»„å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å¾—å‡º boolean ç±»å‹å•ç‹¬ä½¿ç”¨å äº† 4 ä¸ªå­—èŠ‚ï¼Œåœ¨æ•°ç»„ä¸­æ˜¯ 1 ä¸ªå­—èŠ‚
- é»˜è®¤å€¼æ˜¯ **`false`**
- ä¾‹å­ï¼š`boolean one = true`

**charï¼š**

- char ç±»å‹æ˜¯ä¸€ä¸ªå•ä¸€çš„ 16 ä½ä¸¤ä¸ªå­—èŠ‚çš„ Unicode å­—ç¬¦
- æœ€å°å€¼æ˜¯ **`\u0000`**ï¼ˆå³ä¸º 0ï¼‰
- æœ€å¤§å€¼æ˜¯ **`\uffff`**ï¼ˆå³ä¸º 65535ï¼‰
- char æ•°æ®ç±»å‹å¯ä»¥å‚¨å­˜ä»»ä½•å­—ç¬¦
- ä¾‹å­ï¼š`char c = 'A';`   `char c = 'å¼ ';`

```mermaid
graph LR
æ•°æ®èŒƒå›´ä»å°åˆ°å¤§å›¾

A[byte]-->B[short]
C[char]-->D[int]
B-->D
D-->F[long]
G[float]
G-->H[double]
```

ä¸Šä¸‹è½¬å‹

* float ä¸ doubleï¼š

  Java ä¸èƒ½éšå¼æ‰§è¡Œ**å‘ä¸‹è½¬å‹**ï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ç²¾åº¦é™ä½ï¼ˆå‚è€ƒå¤šæ€ï¼‰ï¼Œä½†æ˜¯å¯ä»¥å‘ä¸Šè½¬å‹

  ```java
  //1.1å­—é¢é‡å±äºdoubleç±»å‹ï¼Œä¸èƒ½ç›´æ¥å°†1.1ç›´æ¥èµ‹å€¼ç»™ float å˜é‡ï¼Œå› ä¸ºè¿™æ˜¯å‘ä¸‹è½¬å‹
  float f = 1.1;//æŠ¥é”™
  //1.1f å­—é¢é‡æ‰æ˜¯ float ç±»å‹
  float f = 1.1f;
  ```

  ```java
  float f1 = 1.234f;
  double d1 = f1;
  
  double d2 = 1.23;
  float f2 = (float) d2;//å‘ä¸‹è½¬å‹éœ€è¦å¼ºè½¬
  ```

  ```java
  int i1 = 1245;
  long l1 = i1;
  
  long l2 = 1234;
  int i2 = (int) l2;
  ```

* éšå¼ç±»å‹è½¬æ¢ï¼š

  å­—é¢é‡ 1 æ˜¯ int ç±»å‹ï¼Œå®ƒæ¯” short ç±»å‹ç²¾åº¦è¦é«˜ï¼Œå› æ­¤ä¸èƒ½éšå¼åœ°å°† int ç±»å‹å‘ä¸‹è½¬å‹ä¸º short ç±»å‹

  ä½¿ç”¨ += æˆ–è€… ++ è¿ç®—ç¬¦ä¼šæ‰§è¡Œéšå¼ç±»å‹è½¬æ¢ï¼š

  ```java
  s1 += 1;	//s1++;
  //ä¸Šé¢çš„è¯­å¥ç›¸å½“äºå°† s1 + 1 çš„è®¡ç®—ç»“æœè¿›è¡Œäº†å‘ä¸‹è½¬å‹
  s1 = (short) (s1 + 1);
  ```

  
  
  

***



##### å¼•ç”¨ç±»å‹

å¼•ç”¨æ•°æ®ç±»å‹ï¼šç±»ï¼Œæ¥å£ï¼Œæ•°ç»„éƒ½æ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œåˆå«åŒ…è£…ç±»

åŒ…è£…ç±»çš„ä½œç”¨ï¼š

* åŒ…è£…ç±»ä½œä¸ºç±»é¦–å…ˆæ‹¥æœ‰äº†Objectç±»çš„æ–¹æ³•ã€‚
* åŒ…è£…ç±»ä½œä¸ºå¼•ç”¨ç±»å‹çš„å˜é‡å¯ä»¥å­˜å‚¨nullå€¼ã€‚


```java
åŸºæœ¬æ•°æ®ç±»å‹                åŒ…è£…ç±»ï¼ˆå¼•ç”¨æ•°æ®ç±»å‹ï¼‰
byte                      Byte
short                     Short
int                       Integer(ç‰¹æ®Š)
long                      Long

float                     Float
double                    Double
char                      Character(ç‰¹æ®Š)
boolean                   Boolean
```
Javaä¸ºåŒ…è£…ç±»åšäº†ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ï¼Œå…·ä½“æ¥çœ‹ç‰¹æ®ŠåŠŸèƒ½ä¸»è¦æœ‰ï¼š

* å¯ä»¥æŠŠåŸºæœ¬æ•°æ®ç±»å‹çš„å€¼è½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹çš„å€¼
  1. è°ƒç”¨toString()æ–¹æ³•
  2. è°ƒç”¨Integer.toString(åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼)å¾—åˆ°å­—ç¬¦ä¸²
  3. ç›´æ¥æŠŠåŸºæœ¬æ•°æ®ç±»å‹+ç©ºå­—ç¬¦ä¸²å°±å¾—åˆ°äº†å­—ç¬¦ä¸²ï¼ˆæ¨èä½¿ç”¨ï¼‰

* æŠŠå­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼è½¬æ¢æˆå¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ï¼ˆ**é‡è¦**ï¼‰

  1. Xxx.parseXxx("å­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼") â†’ Integer.parseInt(numStr)
  2. Xxx.valueOf("å­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼")   â†’ Integer.valueOf(numStr) ï¼ˆæ¨èä½¿ç”¨ï¼‰

  ```java
  public class PackageClass02 {
      public static void main(String[] args) {
          // 1.æŠŠåŸºæœ¬æ•°æ®ç±»å‹çš„å€¼è½¬æˆå­—ç¬¦ä¸²
          Integer it = 100 ;
          // a.è°ƒç”¨toString()æ–¹æ³•ã€‚
          String itStr = it.toString();
          System.out.println(itStr+1);//1001
          // b.è°ƒç”¨Integer.toString(åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼)å¾—åˆ°å­—ç¬¦ä¸²ã€‚
          String itStr1 = Integer.toString(it);
          System.out.println(itStr1+1);//1001
          // c.ç›´æ¥æŠŠåŸºæœ¬æ•°æ®ç±»å‹+ç©ºå­—ç¬¦ä¸²å°±å¾—åˆ°äº†å­—ç¬¦ä¸²ã€‚
          String itStr2 = it+"";
          System.out.println(itStr2+1);// 1001
  
          // 2.æŠŠå­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼è½¬æ¢æˆå¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ã€‚ï¼ˆçœŸçš„å¾ˆæœ‰ç”¨ï¼‰
          String numStr = "23";
          //int numInt = Integer.parseInt(numStr);
          int numInt = Integer.valueOf(numStr);
          System.out.println(numInt+1);//24
  
          String doubleStr = "99.9";
          //double doubleDb = Double.parseDouble(doubleStr);
          double doubleDb = Double.valueOf(doubleStr);
          System.out.println(doubleDb+0.1);//100.0
      }
  }
  ```

  

***



#### è£…ç®±æ‹†ç®±

**è‡ªåŠ¨è£…ç®±**ï¼šå¯ä»¥ç›´æ¥æŠŠåŸºæœ¬æ•°æ®ç±»å‹çš„å€¼æˆ–è€…å˜é‡èµ‹å€¼ç»™åŒ…è£…ç±»

**è‡ªåŠ¨æ‹†ç®±**ï¼šå¯ä»¥æŠŠåŒ…è£…ç±»çš„å˜é‡ç›´æ¥èµ‹å€¼ç»™åŸºæœ¬æ•°æ®ç±»å‹

```java
public class PackegeClass {
    public static void main(String[] args) {
        int a = 12 ;
        Integer a1 = 12 ;  // è‡ªåŠ¨è£…ç®±
        Integer a2 = a ;   // è‡ªåŠ¨è£…ç®±
        Integer a3 = null; // å¼•ç”¨æ•°æ®ç±»å‹çš„é»˜è®¤å€¼å¯ä»¥ä¸ºnull

        Integer c = 100 ;
        int c1 = c ;      // è‡ªåŠ¨æ‹†ç®±

        Integer it = Integer.valueOf(12);  // æ‰‹å·¥è£…ç®±ï¼
        // Integer it1 = new Integer(12); // æ‰‹å·¥è£…ç®±ï¼
        Integer it2 = 12;

        Integer it3 = 111 ;
        int it33 = it3.intValue(); // æ‰‹å·¥æ‹†ç®±
    }
}
```



***



#### ç¼“å­˜æ± 

new Integer(123) ä¸ Integer.valueOf(123) çš„åŒºåˆ«åœ¨äºï¼š

- new Integer(123)ï¼šæ¯æ¬¡éƒ½ä¼šæ–°å»ºä¸€ä¸ªå¯¹è±¡

- Integer.valueOf(123)ï¼šä¼šä½¿ç”¨ç¼“å­˜æ± ä¸­çš„å¯¹è±¡ï¼Œå¤šæ¬¡è°ƒç”¨å–å¾—åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨

  ```java
  Integer x = new Integer(123);
  Integer y = new Integer(123);
  System.out.println(x == y);    // false
  Integer z = Integer.valueOf(123);
  Integer k = Integer.valueOf(123);
  System.out.println(z == k);   // true
  ```

valueOf() æ–¹æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å…ˆåˆ¤æ–­å€¼æ˜¯å¦åœ¨ç¼“å­˜æ± ä¸­ï¼Œå¦‚æœåœ¨çš„è¯å°±ç›´æ¥è¿”å›ç¼“å­˜æ± çš„å†…å®¹ã€‚ç¼–è¯‘å™¨ä¼šåœ¨è‡ªåŠ¨è£…ç®±è¿‡ç¨‹è°ƒç”¨ valueOf() æ–¹æ³•ï¼Œå› æ­¤å¤šä¸ªå€¼ç›¸åŒä¸”å€¼åœ¨ç¼“å­˜æ± èŒƒå›´å†…çš„ Integer å®ä¾‹ä½¿ç”¨è‡ªåŠ¨è£…ç®±æ¥åˆ›å»ºï¼Œé‚£ä¹ˆå°±ä¼šå¼•ç”¨ç›¸åŒçš„å¯¹è±¡ã€‚

**åŸºæœ¬ç±»å‹å¯¹åº”çš„ç¼“å­˜æ± å¦‚ä¸‹ï¼š**

- Boolean values true and false
- all byte values
- Short values between -128 and 127
- Long values between -128 and 127
- Integer values between -128 and 127
- Character in the range \u0000 to \u007F (0 and 127)

åœ¨ jdk 1.8 æ‰€æœ‰çš„æ•°å€¼ç±»ç¼“å†²æ± ä¸­ï¼ŒInteger çš„ç¼“å­˜æ±  IntegerCache å¾ˆç‰¹æ®Šï¼Œè¿™ä¸ªç¼“å†²æ± çš„ä¸‹ç•Œæ˜¯ -128ï¼Œä¸Šç•Œé»˜è®¤æ˜¯ 127ï¼Œä½†æ˜¯ä¸Šç•Œæ˜¯å¯è°ƒçš„ï¼Œåœ¨å¯åŠ¨ jvm çš„æ—¶å€™ï¼Œé€šè¿‡ AutoBoxCacheMax=<size> æ¥æŒ‡å®šè¿™ä¸ªç¼“å†²æ± çš„å¤§å°ï¼Œè¯¥é€‰é¡¹åœ¨ JVM åˆå§‹åŒ–çš„æ—¶å€™ä¼šè®¾å®šä¸€ä¸ªåä¸º java.lang.IntegerCache.high ç³»ç»Ÿå±æ€§ï¼Œç„¶å IntegerCache åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šè¯»å–è¯¥ç³»ç»Ÿå±æ€§æ¥å†³å®šä¸Šç•Œ

```java
Integer x = Integer.valueOf(100);
Integer y = Integer.valueOf(100);
System.out.println(x == y);   // true

Integer x = Integer.valueOf(1000);
Integer y = Integer.valueOf(1000);
System.out.println(x == y);   // false
//å› ä¸ºç¼“å­˜æ± æœ€å¤§127
```

åç¼–è¯‘ååº•å±‚è°ƒç”¨ `Integer.valueOf()` å®ç°è‡ªåŠ¨è£…ç®±ï¼Œæºç ï¼š

```java
public static Integer valueOf(int i) {
    if (i >= IntegerCache.low && i <= IntegerCache.high)
        return IntegerCache.cache[i + (-IntegerCache.low)];
    return new Integer(i);
}
```





***



#### è¾“å…¥æ•°æ®

è¯­æ³•ï¼š`Scanner sc = new Scanner(System.in)`

* next()ï¼šé‡åˆ°äº†ç©ºæ ¼ï¼Œå°±ä¸å†å½•å…¥æ•°æ®äº†ï¼Œç»“æŸæ ‡è®°ï¼šç©ºæ ¼ã€tabé”®
* nextLine()ï¼šå¯ä»¥å°†æ•°æ®å®Œæ•´çš„æ¥æ”¶è¿‡æ¥ï¼Œç»“æŸæ ‡è®°ï¼šå›è½¦æ¢è¡Œç¬¦

ä¸€èˆ¬ä½¿ç”¨ `sc.nextInt()` æˆ–è€… `sc.nextLine()` æ¥å—æ•´å‹å’Œå­—ç¬¦ä¸²ï¼Œç„¶åè½¬æˆéœ€è¦çš„æ•°æ®ç±»å‹

Scannerï¼š`BufferedReader br = new BufferedReader(new InputStreamReader(System.in))`
printï¼š`PrintStream.write()`

> ä½¿ç”¨å¼•ç”¨æ•°æ®ç±»å‹çš„API

```java
public static void main(String[] args) {
    Scanner sc = new Scanner(System.in);
    while (sc.hasNextLine()) {
        String msg = sc.nextLine();
    }
}
```



***



#### é¢è¯•é¢˜

* æœ‰äº†åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å¼•ç”¨æ•°æ®ç±»å‹ï¼Ÿ

  > 1ã€å¼•ç”¨æ•°æ®ç±»å‹å°è£…äº†æ•°æ®å’Œå¤„ç†è¯¥æ•°æ®çš„æ–¹æ³•ï¼Œæ¯”å¦‚Integer.parseInt(String)å°±æ˜¯å°†Stringå­—ç¬¦ç±»å‹æ•°æ®è½¬æ¢ä¸ºIntegeræ•´å‹æ•°æ®
  >
  > 2ã€Javaä¸­å¤§éƒ¨åˆ†ç±»å’Œæ–¹æ³•éƒ½æ˜¯é’ˆå¯¹å¼•ç”¨æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬æ³›å‹å’Œé›†åˆ
  
* å¼•ç”¨æ•°æ®ç±»å‹é‚£ä¹ˆå¥½ï¼Œä¸ºä»€ä¹ˆè¿˜ç”¨åŸºæœ¬æ•°æ®ç±»å‹ï¼Ÿ

  > å¼•ç”¨ç±»å‹çš„å¯¹è±¡è¦å¤šå‚¨å­˜å¯¹è±¡å¤´ï¼Œå¯¹åŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ç©ºé—´æµªè´¹ç‡å¤ªé«˜
  > é€»è¾‘ä¸Šæ¥è®²ï¼Œjavaåªæœ‰åŒ…è£…ç±»å°±å¤Ÿäº†ï¼Œä¸ºäº†è¿è¡Œé€Ÿåº¦ï¼Œéœ€è¦ç”¨åˆ°åŸºæœ¬æ•°æ®ç±»å‹ï¼›ä¼˜å…ˆè€ƒè™‘è¿è¡Œæ•ˆç‡çš„é—®é¢˜ï¼Œæ‰€ä»¥äºŒè€…åŒæ—¶å­˜åœ¨æ˜¯åˆä¹æƒ…ç†çš„ã€‚

* Javaé›†åˆä¸èƒ½å­˜æ”¾åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåªå­˜æ”¾å¯¹è±¡çš„å¼•ç”¨ï¼Ÿ

  > ä¸èƒ½æ”¾åŸºæœ¬æ•°æ®ç±»å‹æ˜¯å› ä¸ºä¸æ˜¯Objectçš„å­ç±»ã€‚æ³›å‹æ€æƒ³ï¼Œå¦‚æœä¸ç”¨æ³›å‹è¦å†™å¾ˆå¤šå‚æ•°ç±»å‹ä¸åŒçš„ä½†åŠŸèƒ½ç›¸åŒçš„å‡½æ•°ï¼ˆæ–¹æ³•é‡è½½ï¼‰

* ==

  > == æ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹ï¼šæ¯”è¾ƒçš„æ˜¯å…·ä½“çš„å€¼
  > == æ¯”è¾ƒå¼•ç”¨æ•°æ®ç±»å‹ï¼šæ¯”è¾ƒçš„æ˜¯å¯¹è±¡åœ°å€å€¼



****



### æ•°ç»„

#### åˆå§‹åŒ–

æ•°ç»„å°±æ˜¯å­˜å‚¨æ•°æ®é•¿åº¦å›ºå®šçš„å®¹å™¨ï¼Œå­˜å‚¨å¤šä¸ªæ•°æ®çš„**æ•°æ®ç±»å‹è¦ä¸€è‡´**ï¼Œæ•°ç»„ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡

åˆ›å»ºæ•°ç»„ï¼š

* æ•°æ®ç±»å‹[] æ•°ç»„åï¼š`int[] arr;`  ï¼ˆå¸¸ç”¨ï¼‰
* æ•°æ®ç±»å‹ æ•°ç»„å[]ï¼š`int arr[];`

é™æ€åˆå§‹åŒ–ï¼š

* æ•°æ®ç±»å‹[] æ•°ç»„å = new æ•°æ®ç±»å‹[]{å…ƒç´ 1,å…ƒç´ 2,...}ï¼š`int[] arr = new int[]{11,22,33};`
* æ•°æ®ç±»å‹[] æ•°ç»„å = {å…ƒç´ 1,å…ƒç´ 2,...}ï¼š`int[] arr = {44,55,66};`

åŠ¨æ€åˆå§‹åŒ–

* æ•°æ®ç±»å‹[] æ•°ç»„å = new æ•°æ®ç±»å‹[æ•°ç»„é•¿åº¦]ï¼š`int[] arr = new int[3];`



#### å…ƒç´ è®¿é—®

* **ç´¢å¼•**ï¼šæ¯ä¸€ä¸ªå­˜å‚¨åˆ°æ•°ç»„çš„å…ƒç´ ï¼Œéƒ½ä¼šè‡ªåŠ¨çš„æ‹¥æœ‰ä¸€ä¸ªç¼–å·ï¼Œä»**0**å¼€å§‹ã€‚è¿™ä¸ªè‡ªåŠ¨ç¼–å·ç§°ä¸ºæ•°ç»„ç´¢å¼•(index)ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„çš„ç´¢å¼•è®¿é—®åˆ°æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ 	

* **è®¿é—®æ ¼å¼ï¼š**æ•°ç»„å[ç´¢å¼•]ï¼š`arr[0]`
* **èµ‹å€¼ï¼š**`arr[0] = 10;`



***



#### å†…å­˜åˆ†é…

å†…å­˜æ˜¯è®¡ç®—æœºä¸­çš„é‡è¦åŸä»¶ï¼Œä¸´æ—¶å­˜å‚¨åŒºåŸŸï¼Œä½œç”¨æ˜¯è¿è¡Œç¨‹åºã€‚æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºæ˜¯å­˜æ”¾åœ¨ç¡¬ç›˜ä¸­çš„ï¼Œåœ¨ç¡¬ç›˜ä¸­çš„ç¨‹åºæ˜¯ä¸ä¼šè¿è¡Œçš„ã€‚å¿…é¡»æ”¾è¿›å†…å­˜ä¸­æ‰èƒ½è¿è¡Œï¼Œè¿è¡Œå®Œæ¯•åä¼šæ¸…ç©ºå†…å­˜ã€‚ Javaè™šæ‹Ÿæœºè¦è¿è¡Œç¨‹åºï¼Œå¿…é¡»è¦å¯¹å†…å­˜è¿›è¡Œç©ºé—´çš„åˆ†é…å’Œç®¡ç†ã€‚ 

| åŒºåŸŸåç§°   | ä½œç”¨                                                     |
| ---------- | -------------------------------------------------------- |
| å¯„å­˜å™¨     | ç»™CPUä½¿ç”¨ï¼Œå’Œæˆ‘ä»¬å¼€å‘æ— å…³                                |
| æœ¬åœ°æ–¹æ³•æ ˆ | JVMåœ¨ä½¿ç”¨æ“ä½œç³»ç»ŸåŠŸèƒ½çš„æ—¶å€™ä½¿ç”¨ï¼Œå’Œæˆ‘ä»¬å¼€å‘æ— å…³          |
| æ–¹æ³•åŒº     | å­˜å‚¨å¯ä»¥è¿è¡Œçš„classæ–‡ä»¶                                  |
| å †å†…å­˜     | å­˜å‚¨å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œnewæ¥åˆ›å»ºçš„ï¼Œéƒ½å­˜å‚¨åœ¨å †å†…å­˜            |
| æ–¹æ³•æ ˆ     | æ–¹æ³•è¿è¡Œæ—¶ä½¿ç”¨çš„å†…å­˜ï¼Œæ¯”å¦‚mainæ–¹æ³•è¿è¡Œï¼Œè¿›å…¥æ–¹æ³•æ ˆä¸­æ‰§è¡Œ |

**å†…å­˜åˆ†é…å›¾**ï¼š

* Javaå†…å­˜åˆ†é…-ä¸€ä¸ªæ•°ç»„å†…å­˜å›¾

  ![](https://gitee.com/seazean/images/raw/master/Java/æ•°ç»„å†…å­˜åˆ†é…-ä¸€ä¸ªæ•°ç»„å†…å­˜å›¾.png)

* ä¸¤ä¸ªæ•°ç»„å†…å­˜å›¾

  ![](https://gitee.com/seazean/images/raw/master/Java/æ•°ç»„å†…å­˜åˆ†é…-ä¸¤ä¸ªæ•°ç»„å†…å­˜å›¾.png)

* å¤šä¸ªæ•°ç»„æŒ‡å‘ç›¸åŒå†…å­˜å›¾

  ![](https://gitee.com/seazean/images/raw/master/Java/æ•°ç»„å†…å­˜åˆ†é…-å¤šä¸ªæ•°ç»„æŒ‡å‘ä¸€ä¸ªæ•°ç»„å†…å­˜å›¾.png)

***



#### æ•°ç»„å¼‚å¸¸

* ç´¢å¼•è¶Šç•Œå¼‚å¸¸ï¼šArrayIndexOutOfBoundsException 

* ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼šNullPointerException 

  ```java
  public class ArrayDemo {
      public static void main(String[] args) {
          int[] arr = new int[3];
          //æŠŠnullèµ‹å€¼ç»™æ•°ç»„
          arr = null;
          System.out.println(arr[0]);
      }
  }
  ```

  arr = nullï¼Œè¡¨ç¤ºå˜é‡arrå°†ä¸å†ä¿å­˜æ•°ç»„çš„å†…å­˜åœ°å€ï¼Œä¹Ÿå°±ä¸å…è®¸å†æ“ä½œæ•°ç»„ï¼Œå› æ­¤è¿è¡Œçš„æ—¶å€™ä¼šæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚åœ¨å¼€å‘ä¸­ï¼Œç©ºæŒ‡é’ˆå¼‚å¸¸æ˜¯ä¸èƒ½å‡ºç°çš„ï¼Œä¸€æ—¦å‡ºç°äº†ï¼Œå°±å¿…é¡»è¦ä¿®æ”¹æˆ‘ä»¬ç¼–å†™çš„ä»£ç ã€‚

  è§£å†³æ–¹æ¡ˆï¼šç»™æ•°ç»„ä¸€ä¸ªçœŸæ­£çš„å †å†…å­˜ç©ºé—´å¼•ç”¨å³å¯ï¼
  
  

***



#### äºŒç»´æ•°ç»„

äºŒç»´æ•°ç»„ä¹Ÿæ˜¯ä¸€ç§å®¹å™¨ï¼Œä¸åŒäºä¸€ç»´æ•°ç»„ï¼Œè¯¥å®¹å™¨å­˜å‚¨çš„éƒ½æ˜¯ä¸€ç»´æ•°ç»„å®¹å™¨

åˆå§‹åŒ–ï¼š

* åŠ¨æ€åˆå§‹åŒ–ï¼š
  
  æ•°æ®ç±»å‹[][] å˜é‡å = new æ•°æ®ç±»å‹[m] [n] : `int[][] arr = new int[3][3];`
  
  * m è¡¨ç¤ºè¿™ä¸ªäºŒç»´æ•°ç»„ï¼Œå¯ä»¥å­˜æ”¾å¤šå°‘ä¸ªä¸€ç»´æ•°ç»„ï¼Œè¡Œ
  * n è¡¨ç¤ºæ¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œå¯ä»¥å­˜æ”¾å¤šå°‘ä¸ªå…ƒç´ ï¼Œåˆ—
* é™æ€åˆå§‹åŒ–
  * æ•°æ®ç±»å‹[][] å˜é‡å = new æ•°æ®ç±»å‹[][]{ {å…ƒç´ 1, å…ƒç´ 2...} , {å…ƒç´ 1, å…ƒç´ 2...} 
  * æ•°æ®ç±»å‹[][] å˜é‡å = { {å…ƒç´ 1, å…ƒç´ 2...} , {å…ƒç´ 1, å…ƒç´ 2...} ...}
  * `int[][] arr = {{11,22,33}, {44,55,66}};`

éå†ï¼š

```java
public class Test1 {
    /*
        æ­¥éª¤:
            1. éå†äºŒç»´æ•°ç»„ï¼Œå–å‡ºé‡Œé¢æ¯ä¸€ä¸ªä¸€ç»´æ•°ç»„
            2. åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ç»§ç»­å®Œæˆéå†ï¼Œè·å–å†…éƒ¨å­˜å‚¨çš„æ¯ä¸€ä¸ªå…ƒç´ 
     */
    public static void main(String[] args) {
        int[][] arr = {{11, 22, 33}, {33, 44, 55}};
        // 1. éå†äºŒç»´æ•°ç»„ï¼Œå–å‡ºé‡Œé¢æ¯ä¸€ä¸ªä¸€ç»´æ•°ç»„
        for (int i = 0; i < arr.length; i++) {
            //System.out.println(arr[i]);
            // 2. åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ç»§ç»­å®Œæˆéå†ï¼Œè·å–å†…éƒ¨å­˜å‚¨çš„æ¯ä¸€ä¸ªå…ƒç´ 
            //int[] temp = arr[i];
            for (int j = 0; j < arr[i].length; j++) {
                System.out.println(arr[i][j]);
            }
        }
    }
}
```





****



### è¿ç®—

* i++ä¸++içš„åŒºåˆ«ï¼Ÿ
  i++è¡¨ç¤ºå…ˆå°†iæ”¾åœ¨è¡¨è¾¾å¼ä¸­è¿ç®—ï¼Œç„¶åå†åŠ 1
  ++iè¡¨ç¤ºå…ˆå°†iåŠ 1ï¼Œç„¶åå†æ”¾åœ¨è¡¨è¾¾å¼ä¸­è¿ç®—

* ||å’Œ|ï¼Œ&&å’Œ&çš„åŒºåˆ«ï¼Œé€»è¾‘è¿ç®—ç¬¦

  **&å’Œ| ç§°ä¸ºå¸ƒå°”è¿ç®—ç¬¦ï¼Œä½è¿ç®—ç¬¦ã€‚&&å’Œ|| ç§°ä¸ºæ¡ä»¶å¸ƒå°”è¿ç®—ç¬¦,ä¹Ÿå«çŸ­è·¯è¿ç®—ç¬¦**ã€‚

  ä¸¤ç§è¿ç®—ç¬¦å¾—åˆ°çš„ç»“æœå®Œå…¨ç›¸åŒï¼Œä½†å¾—åˆ°ç»“æœçš„æ–¹å¼åˆä¸€ä¸ªé‡è¦åŒºåˆ«ï¼šæ¡ä»¶å¸ƒå°”è¿ç®—ç¬¦æ€§èƒ½æ¯”è¾ƒå¥½ã€‚ä»–æ£€æŸ¥ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„å€¼ï¼Œå†æ ¹æ®è¯¥æ“ä½œæ•°çš„å€¼è¿›è¡Œæ“ä½œï¼Œå¯èƒ½æ ¹æœ¬å°±ä¸å¤„ç†ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚

  ç»“è®ºï¼šå¦‚æœ&&è¿ç®—ç¬¦çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯falseï¼Œå°±ä¸éœ€è¦è€ƒè™‘ç¬¬äºŒä¸ªæ“ä½œæ•°çš„å€¼äº†ï¼Œå› ä¸ºæ— è®ºç¬¬äºŒä¸ªæ“ä½œæ•°çš„å€¼æ˜¯ä»€ä¹ˆï¼Œå…¶ç»“æœéƒ½æ˜¯falseï¼›åŒæ ·ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯trueï¼Œ||è¿ç®—ç¬¦å°±è¿”å›trueï¼Œæ— éœ€è€ƒè™‘ç¬¬äºŒä¸ªæ“ä½œæ•°çš„å€¼ã€‚ä½†&å’Œ|å´ä¸æ˜¯è¿™æ ·ï¼Œå®ƒä»¬æ€»æ˜¯è¦è®¡ç®—ä¸¤ä¸ªæ“ä½œæ•°ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œ**å°½å¯èƒ½ä½¿ç”¨&&å’Œ||è¿ç®—ç¬¦**

* switch

  ä» Java 7 å¼€å§‹ï¼Œå¯ä»¥åœ¨ switch æ¡ä»¶åˆ¤æ–­è¯­å¥ä¸­ä½¿ç”¨ String å¯¹è±¡

  ```java
  String s = "a";
  switch (s) {
      case "a":
          System.out.println("aaa");
          break;
      case "b":
          System.out.println("bbb");
          break;
      default:
          break;
  }
  ```
  
  switch ä¸æ”¯æŒ longã€floatã€doubleï¼Œswitch çš„è®¾è®¡åˆè¡·æ˜¯å¯¹é‚£äº›åªæœ‰å°‘æ•°å‡ ä¸ªå€¼çš„ç±»å‹è¿›è¡Œç­‰å€¼åˆ¤æ–­ï¼Œå¦‚æœå€¼è¿‡äºå¤æ‚ï¼Œé‚£ä¹ˆç”¨ if æ¯”è¾ƒåˆé€‚
  
* breakï¼šè·³å‡ºä¸€å±‚å¾ªç¯

* ç§»ä½è¿ç®—
  
  è®¡ç®—æœºé‡Œä¸€èˆ¬ç”¨**è¡¥ç è¡¨ç¤ºæ•°å­—**ï¼Œæ­£æ•°ã€è´Ÿæ•°çš„è¡¨ç¤ºåŒºåˆ«å°±æ˜¯æœ€é«˜ä½æ˜¯0è¿˜æ˜¯1
  
  * æ­£æ•°çš„åŸç åç è¡¥ç ç›¸åŒ
  
    ```java
    100:	00000000  00000000  00000000  01100100
    ```
  
  * è´Ÿæ•°ï¼š
    åŸç ï¼šæœ€é«˜ä½ä¸º1ï¼Œå…¶ä½™ä½ç½®å’Œæ­£æ•°ç›¸åŒ
    åç ï¼šä¿è¯ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™ä½ç½®å–å
    è¡¥ç ï¼šä¿è¯ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™ä½ç½®å–ååŠ 1ï¼Œå³åç +1
  
    ```java
    -100åŸç :	10000000  00000000  00000000  01100100	//32ä½
    -100åç :	11111111  11111111  11111111  10011011
    -100è¡¥ç :	11111111  11111111  11111111  10011100
    ```
  
    è¡¥ç  â†’ åŸç ï¼šç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™ä½ç½®å–ååŠ 1
  
  è¿ç®—ç¬¦ï¼š
  
  * `>>`è¿ç®—ç¬¦ï¼šå°†äºŒè¿›åˆ¶ä½è¿›è¡Œå³ç§»æ“ä½œï¼Œç›¸å½“äºé™¤ 2
  * `<<`è¿ç®—ç¬¦ï¼šå°†äºŒè¿›åˆ¶ä½è¿›è¡Œå·¦ç§»æ“ä½œï¼Œç›¸å½“äºä¹˜ 2
  * `>>>`è¿ç®—ç¬¦ï¼šæ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
  
  è¿ç®—è§„åˆ™ï¼š
  
  * æ­£æ•°çš„å·¦ç§»ä¸å³ç§»ï¼Œç©ºä½è¡¥0
  * è´Ÿæ•°åŸç çš„å·¦ç§»ä¸å³ç§»ï¼Œç©ºä½è¡¥0
    è´Ÿæ•°åç çš„å·¦ç§»ä¸å³ç§»ï¼Œç©ºä½è¡¥1
    è´Ÿæ•°è¡¥ç ï¼Œå·¦ç§»ä½ä½è¡¥0ï¼Œå³ç§»é«˜ä½è¡¥1
  * æ— ç¬¦å·ç§»ä½ï¼Œç©ºä½è¡¥0



****



### å‚æ•°

#### å½¢å‚å®å‚

å½¢å‚ï¼š

* å½¢å¼å‚æ•°ï¼Œç”¨äºå®šä¹‰æ–¹æ³•çš„æ—¶å€™ä½¿ç”¨çš„å‚æ•°ï¼Œåªèƒ½æ˜¯å˜é‡
* å½¢å‚åªæœ‰åœ¨æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºæ‰åˆ†é…å†…å­˜å•å…ƒï¼Œæ–¹æ³•è°ƒç”¨ç»“æŸä¹‹åä¾¿ä¼šé‡Šæ”¾æ‰€åˆ†é…çš„å†…å­˜å•å…ƒ

å®å‚ï¼šè°ƒç”¨æ–¹æ³•æ—¶ä¼ é€’çš„æ•°æ®å¯ä»¥æ˜¯å¸¸é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å˜é‡



#### å¯å˜å‚æ•°

å¯å˜å‚æ•°ç”¨åœ¨å½¢å‚ä¸­å¯ä»¥æ¥æ”¶å¤šä¸ªæ•°æ®ã€‚

å¯å˜å‚æ•°çš„æ ¼å¼ï¼šæ•°æ®ç±»å‹... å‚æ•°åç§°

å¯å˜å‚æ•°çš„ä½œç”¨ï¼šä¼ è¾“å‚æ•°éå¸¸çµæ´»ï¼Œæ–¹ä¾¿ã€‚å¯ä»¥ä¸ä¼ è¾“å‚æ•°ã€ä¼ è¾“ä¸€ä¸ªå‚æ•°ã€æˆ–è€…ä¼ è¾“ä¸€ä¸ªæ•°ç»„ã€‚

å¯å˜å‚æ•°åœ¨æ–¹æ³•å†…éƒ¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚

å¯å˜å‚æ•°çš„æ³¨æ„äº‹é¡¹ï¼š
	1.ä¸€ä¸ªå½¢å‚åˆ—è¡¨ä¸­å¯å˜å‚æ•°åªèƒ½æœ‰ä¸€ä¸ªï¼
	2.å¯å˜å‚æ•°å¿…é¡»æ”¾åœ¨å½¢å‚åˆ—è¡¨çš„**æœ€åé¢**ï¼

```java
public static void main(String[] args) {
	sum(); // å¯ä»¥ä¸ä¼ è¾“å‚æ•°ã€‚
	sum(10); // å¯ä»¥ä¼ è¾“ä¸€ä¸ªå‚æ•°ã€‚
	sum(10,20,30); // å¯ä»¥ä¼ è¾“å¤šä¸ªå‚æ•°ã€‚
	sum(new int[]{10,30,50,70,90}); // å¯ä»¥ä¼ è¾“ä¸€ä¸ªæ•°ç»„ã€‚
}

public static void sum(int... nums){
	int sum = 0;
	for(int i : a) {
		sum += i;
	}
	return sum;
}
```



***



### æ–¹æ³•

#### æ–¹æ³•æ¦‚è¿°

æ–¹æ³•ï¼ˆmethodï¼‰æ˜¯å°†å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ä»£ç å—ç»„ç»‡æˆä¸ºä¸€ä¸ªæ•´ä½“ï¼Œä½¿å…¶å…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„ä»£ç é›†

æ³¨æ„ï¼šæ–¹æ³•å¿…é¡»å…ˆåˆ›å»ºæ‰å¯ä»¥ä½¿ç”¨ï¼Œè¯¥è¿‡ç¨‹æˆä¸ºæ–¹æ³•å®šä¹‰
			æ–¹æ³•åˆ›å»ºåå¹¶ä¸æ˜¯ç›´æ¥å¯ä»¥è¿è¡Œçš„ï¼Œéœ€è¦æ‰‹åŠ¨ä½¿ç”¨åï¼Œæ‰æ‰§è¡Œï¼Œè¯¥è¿‡ç¨‹æˆä¸ºæ–¹æ³•è°ƒç”¨

åœ¨æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å«å±€éƒ¨å˜é‡ï¼Œå±€éƒ¨å˜é‡ä¸èƒ½åŠ staticï¼ŒåŒ…æ‹¬protected, private, publicè¿™äº›ä¹Ÿä¸èƒ½åŠ 

åŸå› ï¼šå±€éƒ¨å˜é‡æ˜¯ä¿å­˜åœ¨æ ˆä¸­çš„ï¼Œè€Œé™æ€å˜é‡ä¿å­˜äºæ–¹æ³•åŒºï¼Œå±€éƒ¨å˜é‡å‡ºäº†æ–¹æ³•å°±è¢«æ ˆå›æ”¶äº†ï¼Œè€Œé™æ€å˜é‡ä¸ä¼šï¼Œæ‰€ä»¥åœ¨å±€éƒ¨å˜é‡å‰ä¸èƒ½åŠ staticå…³é”®å­—ï¼Œé™æ€å˜é‡æ˜¯å®šä¹‰åœ¨ç±»ä¸­ï¼Œåˆå«ç±»å˜é‡





***



#### å®šä¹‰è°ƒç”¨

å®šä¹‰æ ¼å¼

```java
public static è¿”å›å€¼ç±»å‹ æ–¹æ³•å(å‚æ•°) {
	//æ–¹æ³•ä½“;
	return æ•°æ® ;
}
```

è°ƒç”¨æ ¼å¼

```java
æ•°æ®ç±»å‹ å˜é‡å = æ–¹æ³•å ( å‚æ•° ) ;
//æ³¨æ„ï¼šæ–¹æ³•çš„è¿”å›å€¼é€šå¸¸ä¼šä½¿ç”¨å˜é‡æ¥æ”¶ï¼Œå¦åˆ™è¯¥è¿”å›å€¼å°†æ— æ„ä¹‰
```

* æ–¹æ³•åï¼šè°ƒç”¨æ–¹æ³•æ—¶å€™ä½¿ç”¨çš„æ ‡è¯†
* å‚æ•°ï¼šç”±æ•°æ®ç±»å‹å’Œå˜é‡åç»„æˆï¼Œå¤šä¸ªå‚æ•°ä¹‹é—´ç”¨é€—å·éš”å¼€
* æ–¹æ³•ä½“ï¼šå®ŒæˆåŠŸèƒ½çš„ä»£ç å—
* returnï¼šå¦‚æœæ–¹æ³•æ“ä½œå®Œæ¯•ï¼Œæœ‰æ•°æ®è¿”å›ï¼Œç”¨äºæŠŠæ•°æ®è¿”å›ç»™è°ƒç”¨è€…

å¦‚æœæ–¹æ³•æ“ä½œå®Œæ¯•

* voidç±»å‹çš„æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨å³å¯ï¼Œè€Œä¸”æ–¹æ³•ä½“ä¸­ä¸€èˆ¬ä¸å†™return
* évoidç±»å‹çš„æ–¹æ³•ï¼Œæ¨èç”¨å˜é‡æ¥æ”¶è°ƒç”¨

åŸç†ï¼šæ¯ä¸ªæ–¹æ³•åœ¨è¢«è°ƒç”¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéƒ½ä¼šè¿›å…¥æ ˆå†…å­˜ï¼Œå¹¶ä¸”æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ–¹æ³•å†…éƒ¨ä»£ç è°ƒç”¨å®Œæ¯•ä¹‹åï¼Œä¼šä»æ ˆå†…å­˜ä¸­å¼¹æ ˆæ¶ˆå¤±ã€‚



***



#### æ³¨æ„äº‹é¡¹

* æ–¹æ³•ä¸èƒ½åµŒå¥—å®šä¹‰

  ```java
  public class MethodDemo {
  	public static void main(String[] args) {
  	}
  	public static void methodOne() {
  		public static void methodTwo() {
  			// è¿™é‡Œä¼šå¼•å‘ç¼–è¯‘é”™è¯¯!!!
  		}
  	}
  }
  ```

* voidè¡¨ç¤ºæ— è¿”å›å€¼ï¼Œå¯ä»¥çœç•¥returnï¼Œä¹Ÿå¯ä»¥å•ç‹¬çš„ä¹¦å†™returnï¼Œåé¢ä¸åŠ æ•°æ®

  ```java
  public static void methodTwo() {
  	//return 100; ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰å…·ä½“è¿”å›å€¼ç±»å‹
  	return;
  	//System.out.println(100); returnè¯­å¥åé¢ä¸èƒ½è·Ÿæ•°æ®æˆ–ä»£ç 
  }
  ```

  

***



#### æ–¹æ³•é‡è½½

##### é‡è½½ä»‹ç»

æ–¹æ³•é‡è½½æŒ‡åŒä¸€ä¸ªç±»ä¸­å®šä¹‰çš„å¤šä¸ªæ–¹æ³•ä¹‹é—´çš„å…³ç³»ï¼Œæ»¡è¶³ä¸‹åˆ—æ¡ä»¶çš„å¤šä¸ªæ–¹æ³•ç›¸äº’æ„æˆé‡è½½ï¼š

1. å¤šä¸ªæ–¹æ³•åœ¨**åŒä¸€ä¸ªç±»**ä¸­
2. å¤šä¸ªæ–¹æ³•å…·æœ‰**ç›¸åŒçš„æ–¹æ³•å**
3. å¤šä¸ªæ–¹æ³•çš„**å‚æ•°ä¸ç›¸åŒ**ï¼Œç±»å‹ä¸åŒæˆ–è€…æ•°é‡ä¸åŒ

é‡è½½ä»…å¯¹åº”æ–¹æ³•çš„å®šä¹‰ï¼Œä¸æ–¹æ³•çš„è°ƒç”¨æ— å…³ï¼Œè°ƒç”¨æ–¹å¼å‚ç…§æ ‡å‡†æ ¼å¼

é‡è½½ä»…é’ˆå¯¹**åŒä¸€ä¸ªç±»**ä¸­æ–¹æ³•çš„åç§°ä¸å‚æ•°è¿›è¡Œè¯†åˆ«ï¼Œ**ä¸è¿”å›å€¼æ— å…³**ï¼Œä¸èƒ½é€šè¿‡è¿”å›å€¼æ¥åˆ¤å®šä¸¤ä¸ªæ–¹æ³•æ˜¯å¦æ„æˆé‡è½½

åŸç†ï¼šJVM â†’ è¿è¡Œæœºåˆ¶ â†’ å­—èŠ‚ç  â†’ æ–¹æ³•è¡¨

```java
public class MethodDemo {
	public static void fn(int a) {
		//æ–¹æ³•ä½“
	}
    
	public static int fn(int a) { /*é”™è¯¯åŸå› ï¼šé‡è½½ä¸è¿”å›å€¼æ— å…³*/
		//æ–¹æ³•ä½“
	}
    
    public static void fn(int a, int b) {/*æ­£ç¡®æ ¼å¼*/
		//æ–¹æ³•ä½“
	}
}
```



***



##### æ–¹æ³•é€‰å–

é‡è½½çš„æ–¹æ³•åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å³å¯å®Œæˆè¯†åˆ«ï¼Œæ–¹æ³•è°ƒç”¨æ—¶ Java ç¼–è¯‘å™¨ä¼šæ ¹æ®æ‰€ä¼ å…¥å‚æ•°çš„å£°æ˜ç±»å‹ï¼ˆæ³¨æ„ä¸å®é™…ç±»å‹åŒºåˆ†ï¼‰æ¥é€‰å–é‡è½½æ–¹æ³•ã€‚é€‰å–çš„è¿‡ç¨‹å…±åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

* åœ¨ä¸è€ƒè™‘å¯¹åŸºæœ¬ç±»å‹è‡ªåŠ¨è£…æ‹†ç®± (auto-boxingï¼Œauto-unboxing)ï¼Œä»¥åŠå¯å˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•
* å¦‚æœç¬¬ 1 ä¸ªé˜¶æ®µä¸­æ²¡æœ‰æ‰¾åˆ°é€‚é…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å…è®¸è‡ªåŠ¨è£…æ‹†ç®±ï¼Œä½†ä¸å…è®¸å¯å˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•
* å¦‚æœç¬¬ 2 ä¸ªé˜¶æ®µä¸­æ²¡æœ‰æ‰¾åˆ°é€‚é…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å…è®¸è‡ªåŠ¨è£…æ‹†ç®±ä»¥åŠå¯å˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•

å¦‚æœ Java ç¼–è¯‘å™¨åœ¨åŒä¸€ä¸ªé˜¶æ®µä¸­æ‰¾åˆ°äº†å¤šä¸ªé€‚é…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©ä¸€ä¸ªæœ€ä¸ºè´´åˆ‡çš„ï¼Œè€Œå†³å®šè´´åˆ‡ç¨‹åº¦çš„ä¸€ä¸ªå…³é”®å°±æ˜¯å½¢å¼å‚æ•°ç±»å‹çš„ç»§æ‰¿å…³ç³»ï¼Œä¸€èˆ¬ä¼šé€‰æ‹©å½¢å‚ä¸ºå‚æ•°ç±»å‹çš„å­ç±»çš„æ–¹æ³•ï¼Œå› ä¸ºå­ç±»æ—¶æ›´å…·ä½“çš„å®ç°ï¼š

```java
public class MethodDemo {
    void invoke(Object obj, Object... args) { ... }
    void invoke(String s, Object obj, Object... args) { ... }

    invoke(null, 1); // è°ƒç”¨ç¬¬äºŒä¸ªinvokeæ–¹æ³•ï¼Œé€‰å–çš„ç¬¬äºŒé˜¶æ®µ
    invoke(null, 1, 2); // è°ƒç”¨ç¬¬äºŒä¸ªinvokeæ–¹æ³•ï¼ŒåŒ¹é…ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªï¼Œä½†Stringæ˜¯Objectçš„å­ç±»
    
    invoke(null, new Object[]{1}); // åªæœ‰æ‰‹åŠ¨ç»•å¼€å¯å˜é•¿å‚æ•°çš„è¯­æ³•ç³–ï¼Œæ‰èƒ½è°ƒç”¨ç¬¬ä¸€ä¸ªinvokeæ–¹æ³•
    							   // å¯å˜å‚æ•°åº•å±‚æ˜¯æ•°ç»„ï¼ŒJVM->è¿è¡Œæœºåˆ¶->ä»£ç ä¼˜åŒ–
}
```

å› æ­¤ä¸æå€¡å¯å˜é•¿å‚æ•°æ–¹æ³•çš„é‡è½½



***



##### ç»§æ‰¿é‡è½½

é™¤äº†åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•ï¼Œé‡è½½ä¹Ÿå¯ä»¥ä½œç”¨äºè¿™ä¸ªç±»æ‰€ç»§æ‰¿è€Œæ¥çš„æ–¹æ³•ã€‚å¦‚æœå­ç±»å®šä¹‰äº†ä¸çˆ¶ç±»ä¸­**éç§æœ‰æ–¹æ³•**åŒåçš„æ–¹æ³•ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹ä¸åŒï¼Œé‚£ä¹ˆåœ¨å­ç±»ä¸­ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åŒæ ·æ„æˆäº†é‡è½½

* å¦‚æœè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼Œé‚£ä¹ˆå­ç±»ä¸­çš„æ–¹æ³•éšè—äº†çˆ¶ç±»ä¸­çš„æ–¹æ³•
* å¦‚æœè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¸æ˜¯é™æ€çš„ï¼Œä¸”éƒ½ä¸æ˜¯ç§æœ‰çš„ï¼Œé‚£ä¹ˆå­ç±»çš„æ–¹æ³•é‡å†™äº†çˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯**å¤šæ€**



***



#### å‚æ•°ä¼ é€’

**Java çš„å‚æ•°æ˜¯ä»¥å€¼ä¼ é€’çš„å½¢å¼ä¼ å…¥æ–¹æ³•ä¸­**

å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’çš„åŒºåˆ«åœ¨äºä¼ é€’åä¼šä¸ä¼šå½±å“å®å‚çš„å€¼ï¼šå€¼ä¼ é€’ä¼šåˆ›å»ºå‰¯æœ¬ï¼Œå¼•ç”¨ä¼ é€’ä¸ä¼šåˆ›å»ºå‰¯æœ¬

* åŸºæœ¬æ•°æ®ç±»å‹ï¼šå½¢å¼å‚æ•°çš„æ”¹å˜ï¼Œä¸å½±å“å®é™…å‚æ•°
  æ¯ä¸ªæ–¹æ³•åœ¨æ ˆå†…å­˜ä¸­ï¼Œéƒ½ä¼šæœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œæ–¹æ³•è¿è¡Œç»“æŸåå°±ä¼šå¼¹æ ˆæ¶ˆå¤±
  
  ```java
  public class ArgsDemo01 {
  	public static void main(String[] args) {
  		int number = 100;
  		System.out.println("è°ƒç”¨changeæ–¹æ³•å‰ï¼š" + number);//100
  		change(number);
  		System.out.println("è°ƒç”¨changeæ–¹æ³•åï¼š" + number);//100
  	}
  	public static void change(int number) {
  		number = 200;
  	}
  }
  ```
  
* å¼•ç”¨ç±»å‹ï¼šå½¢å¼å‚æ•°çš„æ”¹å˜ï¼Œå½±å“å®é™…å‚æ•°çš„å€¼
  **å¼•ç”¨æ•°æ®ç±»å‹çš„ä¼ å‚ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†å¯¹è±¡çš„åœ°å€ä»¥å€¼çš„æ–¹å¼ä¼ é€’åˆ°å½¢å‚ä¸­**ï¼Œå†…å­˜ä¸­ä¼šé€ æˆä¸¤ä¸ªå¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå†…å­˜çš„æ•ˆæœï¼Œæ‰€ä»¥å³ä½¿æ–¹æ³•å¼¹æ ˆï¼Œå †å†…å­˜ä¸­çš„æ•°æ®ä¹Ÿå·²ç»æ˜¯æ”¹å˜åçš„ç»“æœ

  ```java
  public class PassByValueExample {
      public static void main(String[] args) {
          Dog dog = new Dog("A");
          func(dog);
          System.out.println(dog.getName());	// B
      }
      private static void func(Dog dog) {
          dog.setName("B");
      }
  }
  class Dog {
      String name;//.....
  }
  ```

  



***



### æšä¸¾

æšä¸¾æ˜¯Javaä¸­çš„ä¸€ç§ç‰¹æ®Šç±»å‹ï¼Œä¸ºäº†åšä¿¡æ¯çš„æ ‡å¿—å’Œä¿¡æ¯çš„åˆ†ç±»

å®šä¹‰æšä¸¾çš„æ ¼å¼ï¼š

```java
ä¿®é¥°ç¬¦ enum æšä¸¾åç§°{
	ç¬¬ä¸€è¡Œéƒ½æ˜¯ç½—åˆ—æšä¸¾å®ä¾‹çš„åç§°ã€‚
}
```

æšä¸¾çš„ç‰¹ç‚¹ï¼š

* æšä¸¾ç±»æ˜¯ç”¨ final ä¿®é¥°çš„ï¼Œæšä¸¾ç±»ä¸èƒ½è¢«ç»§æ‰¿
* æšä¸¾ç±»é»˜è®¤ç»§æ‰¿äº† java.lang.Enum æšä¸¾ç±»
* æšä¸¾ç±»çš„ç¬¬ä¸€è¡Œéƒ½æ˜¯å¸¸é‡ï¼Œå¿…é¡»æ˜¯ç½—åˆ—æšä¸¾ç±»çš„å®ä¾‹åç§°
* æšä¸¾ç±»ç›¸å½“äºæ˜¯å¤šä¾‹è®¾è®¡æ¨¡å¼
* æ¯ä¸ªæšä¸¾é¡¹éƒ½æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡

| æ–¹æ³•å                                            | è¯´æ˜                                 |
| ------------------------------------------------- | ------------------------------------ |
| String name()                                     | è·å–æšä¸¾é¡¹çš„åç§°                     |
| int ordinal()                                     | è¿”å›æšä¸¾é¡¹åœ¨æšä¸¾ç±»ä¸­çš„ç´¢å¼•å€¼         |
| int compareTo(E  o)                               | æ¯”è¾ƒä¸¤ä¸ªæšä¸¾é¡¹ï¼Œè¿”å›çš„æ˜¯ç´¢å¼•å€¼çš„å·®å€¼ |
| String toString()                                 | è¿”å›æšä¸¾å¸¸é‡çš„åç§°                   |
| static <T> T  valueOf(Class<T> type,String  name) | è·å–æŒ‡å®šæšä¸¾ç±»ä¸­çš„æŒ‡å®šåç§°çš„æšä¸¾å€¼   |
| values()                                          | è·å¾—æ‰€æœ‰çš„æšä¸¾é¡¹                     |

* æºç åˆ†æï¼š

  ```java
  enum Season {
      SPRING , SUMMER , AUTUMN , WINTER;
  }
  //æšä¸¾ç±»çš„ç¼–è¯‘ä»¥åæºä»£ç ï¼š
  public final class Season extends java.lang.Enum<Season> {
  	public static final Season SPRING = new Season();
  	public static final Season SUMMER = new Season();
  	public static final Season AUTUMN = new Season();
  	public static final Season WINTER = new Season();
  
  	public static Season[] values();
  	public static Season valueOf(java.lang.String);
  }
  ```

* APIä½¿ç”¨

  ```java
  public class EnumDemo {
      public static void main(String[] args){
          //è·å–ç´¢å¼•
          Season s = Season.SPRING;  // s = SPRING
          System.out.println(s.ordinal());
          //è·å–å…¨éƒ¨æšä¸¾
          Season[] ss = Season.values();
          for(int i = 0; i < ss.length; i++){
              System.out.println(ss[i]);
          }
          
          int result = Season.SPRING.compareTo(Season.WINTER);
          System.out.println(result);//-3
      }
  }
  enum Season {
      SPRING , SUMMER , AUTUMN , WINTER;
  }
  ```






***



### Debug

Debugæ˜¯ä¾›ç¨‹åºå‘˜ä½¿ç”¨çš„ç¨‹åºè°ƒè¯•å·¥å…·ï¼Œå®ƒå¯ä»¥ç”¨äºæŸ¥çœ‹ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºè¿½è¸ªç¨‹åºæ‰§è¡Œè¿‡ç¨‹æ¥è°ƒè¯•ç¨‹åºã€‚

åŠ æ–­ç‚¹->Debugè¿è¡Œ->å•æ­¥è¿è¡Œ->çœ‹Debuggerçª—å£->çœ‹Consoleçª—å£

![](https://gitee.com/seazean/images/raw/master/Java/DebugæŒ‰é”®è¯´æ˜.png)

<img src="https://gitee.com/seazean/images/raw/master/Java/Debugæ¡ä»¶æ–­ç‚¹.png" alt="Debugæ¡ä»¶æ–­ç‚¹" style="zoom:50%;" />







***





## å¯¹è±¡

### æ¦‚è¿°

**Javaæ˜¯ä¸€ç§é¢å‘å¯¹è±¡çš„é«˜çº§ç¼–ç¨‹è¯­è¨€ã€‚**

**ä¸‰å¤§ç‰¹å¾ï¼šå°è£…ï¼Œç»§æ‰¿ï¼Œå¤šæ€**

é¢å‘å¯¹è±¡æœ€é‡è¦çš„ä¸¤ä¸ªæ¦‚å¿µï¼šç±»å’Œå¯¹è±¡ã€‚

* ç±»ï¼šç›¸åŒäº‹ç‰©å…±åŒç‰¹å¾çš„æè¿°ã€‚ç±»åªæ˜¯å­¦æœ¯ä¸Šçš„ä¸€ä¸ªæ¦‚å¿µå¹¶éçœŸå®å­˜åœ¨çš„ï¼Œåªèƒ½æè¿°ä¸€ç±»äº‹ç‰©ã€‚
* å¯¹è±¡ï¼šæ˜¯çœŸå®å­˜åœ¨çš„å®ä¾‹ï¼Œ å®ä¾‹==å¯¹è±¡ã€‚**å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹åŒ–**ï¼
* ç»“è®ºï¼šæœ‰äº†ç±»å’Œå¯¹è±¡å°±å¯ä»¥æè¿°ä¸‡åƒä¸–ç•Œæ‰€æœ‰çš„äº‹ç‰©ã€‚ å¿…é¡»å…ˆæœ‰ç±»æ‰èƒ½æœ‰å¯¹è±¡ã€‚



***



### ç±»

#### å®šä¹‰

å®šä¹‰æ ¼å¼

```java
ä¿®é¥°ç¬¦ class ç±»å{
}
```

1. ç±»åçš„é¦–å­—æ¯å»ºè®®å¤§å†™ï¼Œæ»¡è¶³é©¼å³°æ¨¡å¼ï¼Œæ¯”å¦‚ StudentNameCode
2. ä¸€ä¸ª Java ä»£ç ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªç±»ï¼ŒæŒ‰ç…§è§„èŒƒä¸€ä¸ª Java æ–‡ä»¶ä¸€ä¸ªç±»
3. ä¸€ä¸ª Java ä»£ç æ–‡ä»¶ä¸­ï¼Œåªèƒ½æœ‰ä¸€ä¸ªç±»æ˜¯ public ä¿®é¥°ï¼Œ**publicä¿®é¥°çš„ç±»åå¿…é¡»æˆä¸ºå½“å‰Javaä»£ç çš„æ–‡ä»¶åç§°**

```java
ç±»ä¸­çš„æˆåˆ†:æœ‰ä¸”ä»…æœ‰äº”å¤§æˆåˆ†
ä¿®é¥°ç¬¦ class ç±»å{
		1.æˆå‘˜å˜é‡(Field):  	æè¿°ç±»æˆ–è€…å¯¹è±¡çš„å±æ€§ä¿¡æ¯çš„ã€‚
        2.æˆå‘˜æ–¹æ³•(Method):		æè¿°ç±»æˆ–è€…å¯¹è±¡çš„è¡Œä¸ºä¿¡æ¯çš„ã€‚
		3.æ„é€ å™¨(Constructor):	 åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡è¿”å›ã€‚
		4.ä»£ç å—
		5.å†…éƒ¨ç±»
	  }
ç±»ä¸­æœ‰ä¸”ä»…æœ‰è¿™äº”ç§æˆåˆ†ï¼Œå¦åˆ™ä»£ç æŠ¥é”™ï¼
public class ClassDemo {
    System.out.println(1);//æŠ¥é”™
}
```



***



#### æ„é€ å™¨

æ„é€ å™¨æ ¼å¼ï¼š

```java
ä¿®é¥°ç¬¦ ç±»å(å½¢å‚åˆ—è¡¨){

}
```

ä½œç”¨ï¼šåˆå§‹åŒ–ç±»çš„ä¸€ä¸ªå¯¹è±¡è¿”å›

åˆ†ç±»ï¼šæ— å‚æ•°æ„é€ å™¨ï¼Œæœ‰å‚æ•°æ„é€ å™¨

æ³¨æ„ï¼š**ä¸€ä¸ªç±»é»˜è®¤è‡ªå¸¦ä¸€ä¸ªæ— å‚æ•°æ„é€ å™¨**ï¼Œå†™äº†æœ‰å‚æ•°æ„é€ å™¨é»˜è®¤çš„æ— å‚æ•°æ„é€ å™¨å°±æ¶ˆå¤±ï¼Œè¿˜éœ€è¦ç”¨æ— å‚æ•°æ„é€ å™¨å°±è¦é‡æ–°å†™

æ„é€ å™¨åˆå§‹åŒ–å¯¹è±¡çš„æ ¼å¼ï¼šç±»å å¯¹è±¡åç§° = new æ„é€ å™¨

* æ— å‚æ•°æ„é€ å™¨çš„ä½œç”¨ï¼šåˆå§‹åŒ–ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼ˆä½¿ç”¨å¯¹è±¡çš„é»˜è®¤å€¼åˆå§‹åŒ–ï¼‰è¿”å›
* æœ‰å‚æ•°æ„é€ å™¨çš„ä½œç”¨ï¼šåˆå§‹åŒ–ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼ˆå¯ä»¥åœ¨åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™ä¸ºå¯¹è±¡èµ‹å€¼ï¼‰è¿”å›



------



### åŒ…

åŒ…ï¼šåˆ†é—¨åˆ«ç±»çš„ç®¡ç†å„ç§ä¸åŒçš„æŠ€æœ¯ï¼Œä¾¿äºç®¡ç†æŠ€æœ¯ï¼Œæ‰©å±•æŠ€æœ¯ï¼Œé˜…è¯»æŠ€æœ¯ã€‚

å®šä¹‰åŒ…çš„æ ¼å¼ï¼š`package åŒ…å; `ï¼Œå¿…é¡»æ”¾åœ¨ç±»åçš„æœ€ä¸Šé¢ã€‚

å¯¼åŒ…æ ¼å¼ï¼š`import åŒ…å.ç±»å;`

ç›¸åŒåŒ…ä¸‹çš„ç±»å¯ä»¥ç›´æ¥è®¿é—®ï¼›ä¸åŒåŒ…ä¸‹çš„ç±»å¿…é¡»å¯¼åŒ…æ‰å¯ä»¥ä½¿ç”¨



***



### å°è£…

å°è£…çš„å“²å­¦æ€ç»´ï¼šåˆç†éšè—ï¼Œåˆç†æš´éœ²
å°è£…æœ€åˆçš„ç›®çš„ï¼šæé«˜ä»£ç çš„å®‰å…¨æ€§å’Œå¤ç”¨æ€§ï¼Œç»„ä»¶åŒ–

å°è£…çš„æ­¥éª¤ï¼š

1. **æˆå‘˜å˜é‡åº”è¯¥ç§æœ‰ï¼Œç”¨privateä¿®é¥°ï¼Œåªèƒ½åœ¨æœ¬ç±»ä¸­ç›´æ¥è®¿é—®**
2. **æä¾›æˆå¥—çš„getterå’Œsetteræ–¹æ³•æš´éœ²æˆå‘˜å˜é‡çš„å–å€¼å’Œèµ‹å€¼**

ä½¿ç”¨ private ä¿®é¥°æˆå‘˜å˜é‡çš„åŸå› ï¼šå®ç°æ•°æ®å°è£…ï¼Œä¸æƒ³è®©åˆ«äººä½¿ç”¨ä¿®æ”¹ä½ çš„æ•°æ®ï¼Œæ¯”è¾ƒå®‰å…¨



***



### this

this å…³é”®å­—çš„ä½œç”¨ï¼š

* this å…³é”®å­—ä»£è¡¨äº†å½“å‰å¯¹è±¡çš„å¼•ç”¨
* this å‡ºç°åœ¨æ–¹æ³•ä¸­ï¼š**å“ªä¸ªå¯¹è±¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•thiså°±ä»£è¡¨è°**
* this å¯ä»¥å‡ºç°åœ¨æ„é€ å™¨ä¸­ï¼šä»£è¡¨æ„é€ å™¨æ­£åœ¨åˆå§‹åŒ–çš„é‚£ä¸ªå¯¹è±¡
* this å¯ä»¥åŒºåˆ†å˜é‡æ˜¯è®¿é—®çš„æˆå‘˜å˜é‡è¿˜æ˜¯å±€éƒ¨å˜é‡



------



### static

#### åŸºæœ¬ä»‹ç»

Javaæ˜¯é€šè¿‡æˆå‘˜å˜é‡æ˜¯å¦æœ‰staticä¿®é¥°æ¥åŒºåˆ†æ˜¯ç±»çš„è¿˜æ˜¯å±äºå¯¹è±¡çš„ã€‚

static é™æ€ä¿®é¥°çš„æˆå‘˜ï¼ˆæ–¹æ³•å’Œæˆå‘˜å˜é‡ï¼‰å±äºç±»æœ¬èº«çš„ã€‚

æŒ‰ç…§æœ‰æ— staticä¿®é¥°ï¼Œæˆå‘˜å˜é‡å’Œæ–¹æ³•å¯ä»¥åˆ†ä¸ºï¼š

* æˆå‘˜å˜é‡ï¼š
  * é™æ€æˆå‘˜å˜é‡ï¼ˆç±»å˜é‡ï¼‰ï¼š
    æœ‰staticä¿®é¥°çš„æˆå‘˜å˜é‡ç§°ä¸ºé™æ€æˆå‘˜å˜é‡ä¹Ÿå«ç±»å˜é‡ï¼Œå±äºç±»æœ¬èº«ï¼Œ**ä¸ç±»ä¸€èµ·åŠ è½½ä¸€æ¬¡ï¼Œåªæœ‰ä¸€ä¸ª**ï¼Œç›´æ¥ç”¨ç±»åè®¿é—®å³å¯ã€‚
  * å®ä¾‹æˆå‘˜å˜é‡ï¼š
    æ— staticä¿®é¥°çš„æˆå‘˜å˜é‡ç§°ä¸ºå®ä¾‹æˆå‘˜å˜é‡ï¼Œå±äºç±»çš„æ¯ä¸ªå¯¹è±¡çš„ã€‚**ä¸ç±»çš„å¯¹è±¡ä¸€èµ·åŠ è½½**ï¼Œå¯¹è±¡æœ‰å¤šå°‘ä¸ªï¼Œå®ä¾‹æˆå‘˜å˜é‡å°±åŠ è½½å¤šå°‘ä¸ªï¼Œå¿…é¡»ç”¨ç±»çš„å¯¹è±¡æ¥è®¿é—®ã€‚

* æˆå‘˜æ–¹æ³•ï¼š
  * é™æ€æ–¹æ³•ï¼š
    æœ‰staticä¿®é¥°çš„æˆå‘˜æ–¹æ³•ç§°ä¸ºé™æ€æ–¹æ³•ä¹Ÿå«ç±»æ–¹æ³•ï¼Œå±äºç±»æœ¬èº«çš„ï¼Œç›´æ¥ç”¨ç±»åè®¿é—®å³å¯ã€‚  
  * å®ä¾‹æ–¹æ³•ï¼š
    æ— staticä¿®é¥°çš„æˆå‘˜æ–¹æ³•ç§°ä¸ºå®ä¾‹æ–¹æ³•ï¼Œå±äºç±»çš„æ¯ä¸ªå¯¹è±¡çš„ï¼Œå¿…é¡»ç”¨ç±»çš„å¯¹è±¡æ¥è®¿é—®ã€‚ 



****



#### staticç”¨æ³•

æˆå‘˜å˜é‡çš„è®¿é—®è¯­æ³•ï¼š

* é™æ€æˆå‘˜å˜é‡ï¼šåªæœ‰ä¸€ä»½å¯ä»¥è¢«ç±»å’Œç±»çš„å¯¹è±¡**å…±äº«è®¿é—®**
  * ç±»å.é™æ€æˆå‘˜å˜é‡ï¼ˆåŒä¸€ä¸ªç±»ä¸­è®¿é—®é™æ€æˆå‘˜å˜é‡å¯ä»¥çœç•¥ç±»åä¸å†™ï¼‰
  * å¯¹è±¡.é™æ€æˆå‘˜å˜é‡ï¼ˆä¸æ¨èï¼‰

* å®ä¾‹æˆå‘˜å˜é‡ï¼š
  * å¯¹è±¡.å®ä¾‹æˆå‘˜å˜é‡ï¼ˆå…ˆåˆ›å»ºå¯¹è±¡ï¼‰

æˆå‘˜æ–¹æ³•çš„è®¿é—®è¯­æ³•ï¼š

* é™æ€æ–¹æ³•ï¼šæœ‰staticä¿®é¥°ï¼Œå±äºç±»

  * ç±»å.é™æ€æ–¹æ³•ï¼ˆåŒä¸€ä¸ªç±»ä¸­è®¿é—®é™æ€æˆå‘˜å¯ä»¥çœç•¥ç±»åä¸å†™ï¼‰
  * å¯¹è±¡.é™æ€æ–¹æ³•ï¼ˆä¸æ¨èï¼Œå‚è€ƒ JVMç±»åŠ è½½--> å­—èŠ‚ç  --> æ–¹æ³•è°ƒç”¨ï¼‰
  
* å®ä¾‹æ–¹æ³•ï¼šæ— staticä¿®é¥°ï¼Œå±äºå¯¹è±¡

  * å¯¹è±¡.å®ä¾‹æ–¹æ³•
  
  ```java
  public class Student {
      // 1.é™æ€æ–¹æ³•ï¼šæœ‰staticä¿®é¥°ï¼Œå±äºç±»ï¼Œç›´æ¥ç”¨ç±»åè®¿é—®å³å¯ï¼
      public static void inAddr(){ }
      // 2.å®ä¾‹æ–¹æ³•ï¼šæ— staticä¿®é¥°ï¼Œå±äºå¯¹è±¡ï¼Œå¿…é¡»ç”¨å¯¹è±¡è®¿é—®ï¼
      public void eat(){}
      
      public static void main(String[] args) {
          // a.ç±»å.é™æ€æ–¹æ³•
          Student.inAddr();
          inAddr();
          // b.å¯¹è±¡.å®ä¾‹æ–¹æ³•
          // Student.eat(); // æŠ¥é”™äº†ï¼
          Student zbj = new Student();
          zbj.eat();
      }
  }
  ```



***



#### ä¸¤ä¸ªé—®é¢˜

å†…å­˜é—®é¢˜ï¼š

* **æ ˆå†…å­˜å­˜æ”¾mainæ–¹æ³•å’Œåœ°å€**

* **å †å†…å­˜å­˜æ”¾å¯¹è±¡å’Œå˜é‡**

* **æ–¹æ³•åŒºå­˜æ”¾classå’Œé™æ€å˜é‡ï¼ˆjdk8ä»¥åç§»å…¥å †ï¼‰**

è®¿é—®é—®é¢˜ï¼š

* å®ä¾‹æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å®ä¾‹æˆå‘˜å˜é‡ï¼Ÿå¯ä»¥çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½å±äºå¯¹è±¡
* å®ä¾‹æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®é™æ€æˆå‘˜å˜é‡ï¼Ÿå¯ä»¥çš„ï¼Œé™æ€æˆå‘˜å˜é‡å¯ä»¥è¢«å…±äº«è®¿é—®
* å®ä¾‹æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å®ä¾‹æ–¹æ³•? å¯ä»¥çš„ï¼Œå®ä¾‹æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•éƒ½å±äºå¯¹è±¡
* å®ä¾‹æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®é™æ€æ–¹æ³•ï¼Ÿå¯ä»¥çš„ï¼Œé™æ€æ–¹æ³•å¯ä»¥è¢«å…±äº«è®¿é—®
* é™æ€æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å®ä¾‹å˜é‡ï¼Ÿ ä¸å¯ä»¥çš„ï¼Œå®ä¾‹å˜é‡å¿…é¡»ç”¨å¯¹è±¡è®¿é—®ï¼ï¼
* é™æ€æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®é™æ€å˜é‡ï¼Ÿ å¯ä»¥çš„ï¼Œé™æ€æˆå‘˜å˜é‡å¯ä»¥è¢«å…±äº«è®¿é—®ã€‚
* é™æ€æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å®ä¾‹æ–¹æ³•? ä¸å¯ä»¥çš„ï¼Œå®ä¾‹æ–¹æ³•å¿…é¡»ç”¨å¯¹è±¡è®¿é—®ï¼ï¼
* é™æ€æ–¹æ³•æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®é™æ€æ–¹æ³•ï¼Ÿå¯ä»¥çš„ï¼Œé™æ€æ–¹æ³•å¯ä»¥è¢«å…±äº«è®¿é—®ï¼ï¼



------



### ç»§æ‰¿

#### åŸºæœ¬ä»‹ç»

ç»§æ‰¿æ˜¯ Java ä¸­ä¸€èˆ¬åˆ°ç‰¹æ®Šçš„å…³ç³»ï¼Œæ˜¯ä¸€ç§å­ç±»åˆ°çˆ¶ç±»çš„å…³ç³»

* è¢«ç»§æ‰¿çš„ç±»ç§°ä¸ºï¼šçˆ¶ç±»/è¶…ç±»ã€‚
* ç»§æ‰¿çˆ¶ç±»çš„ç±»ç§°ä¸ºï¼šå­ç±»ã€‚

ç»§æ‰¿çš„ä½œç”¨ï¼š

* **æé«˜ä»£ç çš„å¤ç”¨**ï¼Œç›¸åŒä»£ç å¯ä»¥å®šä¹‰åœ¨çˆ¶ç±»ä¸­
* å­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨çˆ¶ç±»è¿™äº›ä»£ç ï¼ˆç›¸åŒä»£ç é‡å¤åˆ©ç”¨ï¼‰
* å­ç±»å¾—åˆ°çˆ¶ç±»çš„å±æ€§ï¼ˆæˆå‘˜å˜é‡ï¼‰å’Œè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ï¼Œè¿˜å¯ä»¥å®šä¹‰è‡ªå·±çš„åŠŸèƒ½ï¼Œå­ç±»æ›´å¼ºå¤§

ç»§æ‰¿çš„ç‰¹ç‚¹ï¼š

1. å­ç±»çš„å…¨éƒ¨æ„é€ å™¨é»˜è®¤å…ˆè®¿é—®çˆ¶ç±»çš„æ— å‚æ•°æ„é€ å™¨ï¼Œå†æ‰§è¡Œè‡ªå·±çš„æ„é€ å™¨
2. **å•ç»§æ‰¿**ï¼šä¸€ä¸ªç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªç›´æ¥çˆ¶ç±»
3. å¤šå±‚ç»§æ‰¿ï¼šä¸€ä¸ªç±»å¯ä»¥é—´æ¥ç»§æ‰¿å¤šä¸ªçˆ¶ç±»ï¼ˆå®¶è°±ï¼‰
4. ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå­ç±»
5. ä¸€ä¸ªç±»è¦ä¹ˆé»˜è®¤ç»§æ‰¿äº† Object ç±»ï¼Œè¦ä¹ˆé—´æ¥ç»§æ‰¿äº† Object ç±»ï¼ŒObject ç±»æ˜¯ Java ä¸­çš„ç¥–å®—ç±»

ç»§æ‰¿çš„æ ¼å¼ï¼š

```java
å­ç±» extends çˆ¶ç±»{

}
```

å­ç±»ç»§æ‰¿çˆ¶ç±»çš„ä¸œè¥¿ï¼š

* å­ç±»ä¸èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå­ç±»æœ‰è‡ªå·±çš„æ„é€ å™¨
* å­ç±»æ˜¯ä¸èƒ½å¯ä»¥ç»§æ‰¿çˆ¶ç±»çš„ç§æœ‰æˆå‘˜çš„ï¼Œå¯ä»¥åå°„æš´åŠ›å»è®¿é—®ç»§æ‰¿è‡ªçˆ¶ç±»çš„ç§æœ‰æˆå‘˜
* å­ç±»æ˜¯ä¸èƒ½ç»§æ‰¿çˆ¶ç±»çš„é™æ€æˆå‘˜çš„ï¼Œå­ç±»åªæ˜¯å¯ä»¥è®¿é—®çˆ¶ç±»çš„é™æ€æˆå‘˜ï¼Œçˆ¶ç±»é™æ€æˆå‘˜åªæœ‰ä¸€ä»½å¯ä»¥è¢«å­ç±»å…±äº«è®¿é—®ï¼Œ**å…±äº«å¹¶éç»§æ‰¿**

```java
public class ExtendsDemo {
    public static void main(String[] args) {
        Cat c = new Cat();
        // c.run();
        Cat.test();
        System.out.println(Cat.schoolName);
    }
}
class Cat extends Animal{
}
class Animal{
    public static String schoolName ="seazean";
    public static void test(){}
    private void run(){}
}
```



***



#### ç»§æ‰¿è®¿é—®

ç»§æ‰¿åæˆå‘˜å˜é‡çš„è®¿é—®ç‰¹ç‚¹ï¼š**å°±è¿‘åŸåˆ™**ï¼Œå­ç±»æœ‰æ‰¾å­ç±»ï¼Œå­ç±»æ²¡æœ‰æ‰¾çˆ¶ç±»ï¼Œçˆ¶ç±»æ²¡æœ‰å°±æŠ¥é”™

å¦‚æœè¦ç”³æ˜è®¿é—®çˆ¶ç±»çš„æˆå‘˜å˜é‡å¯ä»¥ä½¿ç”¨ï¼šsuper.çˆ¶ç±»æˆå‘˜å˜é‡ã€‚superæŒ‡çˆ¶ç±»å¼•ç”¨

```java
public class ExtendsDemo {
    public static void wmain(String[] args) {
        Wolf w = new Wolf();w
        w.showName();
    }
}
class Wolf extends Animal{
    private String name = "å­ç±»ç‹¼";
    public void showName(){
        String name = "å±€éƒ¨åç§°";
        System.out.println(name); // å±€éƒ¨name
        System.out.println(this.name); // å­ç±»å¯¹è±¡çš„name
        System.out.println(super.name); // çˆ¶ç±»çš„
        System.out.println(name1); // çˆ¶ç±»çš„
        //System.out.println(name2); // æŠ¥é”™ã€‚å­ç±»çˆ¶ç±»éƒ½æ²¡æœ‰
    }
}

class Animal{
    public String name = "çˆ¶ç±»åŠ¨ç‰©åç§°";
    public String name1 = "çˆ¶ç±»";
}
```



***



#### æ–¹æ³•é‡å†™

æ–¹æ³•é‡å†™ï¼šå­ç±»ç»§æ‰¿äº†çˆ¶ç±»å°±å¾—åˆ°äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œå­ç±»é‡å†™ä¸€ä¸ªä¸çˆ¶ç±»ç”³æ˜ä¸€æ ·çš„æ–¹æ³•æ¥**è¦†ç›–**çˆ¶ç±»çš„è¯¥æ–¹æ³•

æ–¹æ³•é‡å†™çš„æ ¡éªŒæ³¨è§£ï¼š@Override

* æ–¹æ³•åŠ äº†è¿™ä¸ªæ³¨è§£ï¼Œé‚£å°±å¿…é¡»æ˜¯æˆåŠŸé‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¦åˆ™æŠ¥é”™ 
* @Override ä¼˜åŠ¿ï¼šå¯è¯»æ€§å¥½ï¼Œå®‰å…¨ï¼Œä¼˜é›…

å­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ï¼Œé‡å†™æœ‰ä»¥ä¸‹**ä¸‰ä¸ªé™åˆ¶**ï¼š

- å­ç±»æ–¹æ³•çš„è®¿é—®æƒé™å¿…é¡»å¤§äºç­‰äºçˆ¶ç±»æ–¹æ³•
- å­ç±»æ–¹æ³•çš„è¿”å›ç±»å‹å¿…é¡»æ˜¯çˆ¶ç±»æ–¹æ³•è¿”å›ç±»å‹æˆ–ä¸ºå…¶å­ç±»å‹
- å­ç±»æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹å¿…é¡»æ˜¯çˆ¶ç±»æŠ›å‡ºå¼‚å¸¸ç±»å‹æˆ–ä¸ºå…¶å­ç±»å‹

ç»§æ‰¿ä¸­çš„éšè—é—®é¢˜ï¼š

- å­ç±»å’Œçˆ¶ç±»æ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼Œé‚£ä¹ˆå­ç±»ä¸­çš„æ–¹æ³•ä¼šéšè—çˆ¶ç±»ä¸­çš„æ–¹æ³•
- åœ¨å­ç±»ä¸­å¯ä»¥å®šä¹‰å’Œçˆ¶ç±»æˆå‘˜å˜é‡åŒåçš„æˆå‘˜å˜é‡ï¼Œæ­¤æ—¶å­ç±»çš„æˆå‘˜å˜é‡éšè—äº†çˆ¶ç±»çš„æˆå‘˜å˜é‡ï¼Œåœ¨åˆ›å»ºå¯¹è±¡ä¸ºå¯¹è±¡åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œ**éšè—å˜é‡ä¾ç„¶ä¼šè¢«åˆ†é…å†…å­˜**

```java
public class ExtendsDemo {
    public static void main(String[] args) {
        Wolf w = new Wolf();
        w.run();
    }
}
class Wolf extends Animal{
    @Override
    public void run(){}//
}
class Animal{
    public void run(){}
}
```



***



#### é¢è¯•é—®é¢˜

* ä¸ºä»€ä¹ˆå­ç±»æ„é€ å™¨ä¼šå…ˆè°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Ÿ
  
  1. å­ç±»çš„æ„é€ å™¨çš„ç¬¬ä¸€è¡Œé»˜è®¤ super() è°ƒç”¨çˆ¶ç±»çš„æ— å‚æ•°æ„é€ å™¨ï¼Œå†™ä¸å†™éƒ½å­˜åœ¨
  2. å­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œå­ç±»å°±å¾—åˆ°äº†çˆ¶ç±»çš„å±æ€§å’Œè¡Œä¸ºã€‚è°ƒç”¨å­ç±»æ„é€ å™¨åˆå§‹åŒ–å­ç±»å¯¹è±¡æ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆè°ƒç”¨çˆ¶ç±»æ„é€ å™¨åˆå§‹åŒ–ç»§æ‰¿è‡ªçˆ¶ç±»çš„å±æ€§å’Œè¡Œä¸º
  3. å‚è€ƒJVM -> ç±»åŠ è½½ -> å¯¹è±¡åˆ›å»º
  
  ```java
  class Animal{
      public Animal(){
          System.out.println("==çˆ¶ç±»Animalçš„æ— å‚æ•°æ„é€ å™¨==");
      }
  }
  class Tiger extends Animal{
      public Tiger(){
          super(); // é»˜è®¤å­˜åœ¨çš„ï¼Œæ ¹æ®å‚æ•°å»åŒ¹é…è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ã€‚
          System.out.println("==å­ç±»Tigerçš„æ— å‚æ•°æ„é€ å™¨==");
      }
      public Tiger(String name){
          //super();  é»˜è®¤å­˜åœ¨çš„ï¼Œæ ¹æ®å‚æ•°å»åŒ¹é…è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ã€‚
          System.out.println("==å­ç±»Tigerçš„æœ‰å‚æ•°æ„é€ å™¨==");
      }
  }
  ```
  
* **ä¸ºä»€ä¹ˆ Java æ˜¯å•ç»§æ‰¿çš„ï¼Ÿ**
  ç­”ï¼šåè¯æ³•ï¼Œå‡å¦‚ Java å¯ä»¥å¤šç»§æ‰¿ï¼Œè¯·çœ‹å¦‚ä¸‹ä»£ç ï¼š
  
  ```java
  class A{
  	public void test(){
  		System.out.println("A");
  	}
  }
  class B{
  	public void test(){
  		System.out.println("B");
  	}
  }
  class C extends A , B {
  	public static void main(String[] args){
  		C c = new C();
          c.test(); 
          // å‡ºç°äº†ç±»çš„äºŒä¹‰æ€§ï¼æ‰€ä»¥Javaä¸èƒ½å¤šç»§æ‰¿ï¼ï¼
  	}
  }
  ```
  
  



------



### super

ç»§æ‰¿å super è°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œçˆ¶ç±»æ„é€ å™¨åˆå§‹åŒ–ç»§æ‰¿è‡ªçˆ¶ç±»çš„æ•°æ®ã€‚


æ€»ç»“ä¸æ‹“å±•ï¼š

* this ä»£è¡¨äº†å½“å‰å¯¹è±¡çš„å¼•ç”¨ï¼ˆç»§æ‰¿ä¸­æŒ‡ä»£å­ç±»å¯¹è±¡ï¼‰ï¼šthis.å­ç±»æˆå‘˜å˜é‡ã€this.å­ç±»æˆå‘˜æ–¹æ³•ã€**this(...)**å¯ä»¥æ ¹æ®å‚æ•°åŒ¹é…è®¿é—®æœ¬ç±»å…¶ä»–æ„é€ å™¨ã€‚
* super ä»£è¡¨äº†çˆ¶ç±»å¯¹è±¡çš„å¼•ç”¨ï¼ˆç»§æ‰¿ä¸­æŒ‡ä»£äº†çˆ¶ç±»å¯¹è±¡ç©ºé—´ï¼‰ï¼šsuper.çˆ¶ç±»æˆå‘˜å˜é‡ã€super.çˆ¶ç±»çš„æˆå‘˜æ–¹æ³•ã€super(...)å¯ä»¥æ ¹æ®å‚æ•°åŒ¹é…è®¿é—®çˆ¶ç±»çš„æ„é€ å™¨

**æ³¨æ„ï¼š**

* this(...) å€Ÿç”¨æœ¬ç±»å…¶ä»–æ„é€ å™¨ï¼Œsuper(...) è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ã€‚
* this(...) æˆ– super(...) å¿…é¡»æ”¾åœ¨æ„é€ å™¨çš„ç¬¬ä¸€è¡Œï¼Œå¦åˆ™æŠ¥é”™!
* this(...) å’Œ super(...) ä¸èƒ½åŒæ—¶å‡ºç°åœ¨æ„é€ å™¨ä¸­ï¼Œå› ä¸ºæ„é€ å‡½æ•°å¿…é¡»å‡ºç°åœ¨ç¬¬ä¸€è¡Œä¸Šï¼Œåªèƒ½é€‰æ‹©ä¸€ä¸ªã€‚

```java
public class ThisDemo {
    public static void main(String[] args) {
        // éœ€æ±‚ï¼šå¸Œæœ›å¦‚æœä¸å†™å­¦æ ¡é»˜è®¤å°±æ˜¯â€å¼ ä¸‰â€œï¼
        Student s1 = new Student("å¤©è“¬å…ƒå¸…", 1000 );
        Student s2 = new Student("é½å¤©å¤§åœ£", 2000, "æ¸…åå¤§å­¦" );
    }
}
class Study extends Student {
   public Study(String name, int age, String schoolName) {
        super(name , age , schoolName) ; 
       // æ ¹æ®å‚æ•°åŒ¹é…è°ƒç”¨çˆ¶ç±»æ„é€ å™¨
   }
}

class Student{
    private String name ;
    private int age ;
    private String schoolName ;

    public Student() {
    }
    public Student(String name , int age){
        // å€Ÿç”¨å…„å¼Ÿæ„é€ å™¨çš„åŠŸèƒ½ï¼
        this(name , age , "å¼ ä¸‰");
    }
	public Student(String name, int age, String schoolName) {
        this.name = name;
        this.age = age;
        this.schoolName = schoolName;
    }
// .......get + set
}
```



***



### final

#### åŸºæœ¬ä»‹ç»

final ç”¨äºä¿®é¥°ï¼šç±»ï¼Œæ–¹æ³•ï¼Œå˜é‡

* final ä¿®é¥°ç±»ï¼Œç±»ä¸èƒ½è¢«ç»§æ‰¿äº†ï¼Œç±»ä¸­çš„æ–¹æ³•å’Œå˜é‡å¯ä»¥ä½¿ç”¨
* final å¯ä»¥ä¿®é¥°æ–¹æ³•ï¼Œæ–¹æ³•å°±ä¸èƒ½è¢«é‡å†™
* final ä¿®é¥°å˜é‡æ€»è§„åˆ™ï¼šå˜é‡æœ‰ä¸”ä»…èƒ½è¢«èµ‹å€¼ä¸€æ¬¡

**é¢è¯•é¢˜**ï¼šfinal å’Œ abstract çš„å…³ç³»æ˜¯äº’æ–¥å…³ç³»ï¼Œä¸èƒ½åŒæ—¶ä¿®é¥°ç±»æˆ–è€…åŒæ—¶ä¿®é¥°æ–¹æ³•ï¼



***



#### ä¿®é¥°å˜é‡

##### é™æ€å˜é‡

final ä¿®é¥°é™æ€æˆå‘˜å˜é‡ï¼Œå˜é‡å˜æˆäº†å¸¸é‡

**å¸¸é‡ï¼šæœ‰ public static final ä¿®é¥°ï¼Œåç§°å­—æ¯å…¨éƒ¨å¤§å†™ï¼Œå¤šä¸ªå•è¯ç”¨ä¸‹åˆ’çº¿è¿æ¥ã€‚**

final ä¿®é¥°é™æ€æˆå‘˜å˜é‡å¯ä»¥åœ¨å“ªäº›åœ°æ–¹èµ‹å€¼ï¼š

1. å®šä¹‰çš„æ—¶å€™èµ‹å€¼ä¸€æ¬¡

2. å¯ä»¥åœ¨é™æ€ä»£ç å—ä¸­èµ‹å€¼ä¸€æ¬¡

```java
public class FinalDemo {
//å¸¸é‡ï¼špublic static finalä¿®é¥°ï¼Œåç§°å­—æ¯å…¨éƒ¨å¤§å†™ï¼Œä¸‹åˆ’çº¿è¿æ¥ã€‚
    public static final String SCHOOL_NAME = "å¼ ä¸‰" ;
    public static final String SCHOOL_NAME1;

    static{
        //SCHOOL_NAME = "java";//æŠ¥é”™
        SCHOOL_NAME1 = "å¼ ä¸‰1";
        //SCHOOL_NAME1 = "å¼ ä¸‰2"; // æŠ¥é”™ï¼Œç¬¬äºŒæ¬¡èµ‹å€¼ï¼
    }
}
```



##### å®ä¾‹å˜é‡

final ä¿®é¥°å˜é‡çš„æ€»è§„åˆ™ï¼šæœ‰ä¸”ä»…èƒ½è¢«èµ‹å€¼ä¸€æ¬¡

final ä¿®é¥°å®ä¾‹æˆå‘˜å˜é‡å¯ä»¥åœ¨å“ªäº›åœ°æ–¹èµ‹å€¼ 1 æ¬¡ï¼š

1. å®šä¹‰çš„æ—¶å€™èµ‹å€¼ä¸€æ¬¡
2. å¯ä»¥åœ¨å®ä¾‹ä»£ç å—ä¸­èµ‹å€¼ä¸€æ¬¡
3. å¯ä»¥åœ¨æ¯ä¸ªæ„é€ å™¨ä¸­èµ‹å€¼ä¸€æ¬¡

```java
public class FinalDemo {
    private final String name = "å¼ ä¸‰" ;
    private final String name1;
    private final String name2;
    {
        // å¯ä»¥åœ¨å®ä¾‹ä»£ç å—ä¸­èµ‹å€¼ä¸€æ¬¡ã€‚
        name1 = "å¼ ä¸‰1";
    }
	//æ„é€ å™¨èµ‹å€¼ä¸€æ¬¡
    public FinalDemo(){
        name2 = "å¼ ä¸‰2";
    }
    public FinalDemo(String a){
        name2 = "å¼ ä¸‰2";
    }

    public static void main(String[] args) {
        FinalDemo f1 = new FinalDemo();
        //f1.name = "å¼ ä¸‰1"; // ç¬¬äºŒæ¬¡èµ‹å€¼ æŠ¥é”™ï¼
    }
}
```



***



### æŠ½è±¡ç±»

#### åŸºæœ¬ä»‹ç»

> çˆ¶ç±»çŸ¥é“å­ç±»è¦å®ŒæˆæŸä¸ªåŠŸèƒ½ï¼Œä½†æ˜¯æ¯ä¸ªå­ç±»å®ç°æƒ…å†µä¸ä¸€æ ·ã€‚

æŠ½è±¡æ–¹æ³•ï¼šæ²¡æœ‰æ–¹æ³•ä½“ï¼Œåªæœ‰æ–¹æ³•ç­¾åï¼Œå¿…é¡»ç”¨**abstract**ä¿®é¥°çš„æ–¹æ³•å°±æ˜¯æŠ½è±¡æ–¹æ³•
æŠ½è±¡ç±»ï¼šæ‹¥æœ‰æŠ½è±¡æ–¹æ³•çš„ç±»å¿…é¡»å®šä¹‰æˆæŠ½è±¡ç±»ï¼Œå¿…é¡»ç”¨**abstract**ä¿®é¥°ï¼ŒæŠ½è±¡ç±»æ˜¯ä¸ºäº†è¢«ç»§æ‰¿

ä¸€ä¸ªç±»ç»§æ‰¿æŠ½è±¡ç±»ï¼Œ**å¿…é¡»é‡å†™æŠ½è±¡ç±»çš„å…¨éƒ¨æŠ½è±¡æ–¹æ³•**ï¼Œå¦åˆ™è¿™ä¸ªç±»å¿…é¡»å®šä¹‰æˆæŠ½è±¡ç±»ï¼Œå› ä¸ºæ‹¥æœ‰æŠ½è±¡æ–¹æ³•çš„ç±»å¿…é¡»å®šä¹‰æˆæŠ½è±¡ç±»

```java
public class AbstractDemo {
    public static void main(String[] args) {
        Dog d = new Dog();
        d.run();
    }
}

class Dog extends Animal{
    @Override
    public void run() { 
        System.out.println("ğŸ•è·‘"); 
    }
}

abstract class Animal{
    public abstract void run();
}
```



***



#### é¢è¯•é—®é¢˜

ä¸€ã€æŠ½è±¡ç±»æ˜¯å¦æœ‰æ„é€ å™¨ï¼Œæ˜¯å¦å¯ä»¥åˆ›å»ºå¯¹è±¡?
ç­”ï¼šæŠ½è±¡ç±»ä½œä¸ºç±»ä¸€å®šæœ‰æ„é€ å™¨ï¼Œè€Œä¸”å¿…é¡»æœ‰æ„é€ å™¨ï¼Œæä¾›ç»™å­ç±»ç»§æ‰¿åè°ƒç”¨çˆ¶ç±»æ„é€ å™¨ä½¿ç”¨çš„

* æŠ½è±¡ç±»æœ‰æ„é€ å™¨ï¼Œä½†æ˜¯æŠ½è±¡ç±»ä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼Œç±»çš„å…¶ä»–æˆåˆ†å®ƒéƒ½å…·å¤‡
* æŠ½è±¡ç±»ä¸­å­˜åœ¨æŠ½è±¡æ–¹æ³•ï¼Œä½†ä¸èƒ½æ‰§è¡Œï¼Œ**æŠ½è±¡ç±»ä¸­ä¹Ÿå¯æ²¡æœ‰æŠ½è±¡æ–¹æ³•**

> æŠ½è±¡åœ¨å­¦æœ¯ä¸Šæœ¬èº«æ„å‘³ç€ä¸èƒ½å®ä¾‹åŒ–

```java
public class AbstractDemo {
    public static void main(String[] args) {
        //Animal a = new Animal(); æŠ½è±¡ç±»ä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼
        //a.run(); // æŠ½è±¡æ–¹æ³•ä¸èƒ½æ‰§è¡Œ
    }
}
abstract class Animal{
    private String name;
    public static String schoolName = "å¼ ä¸‰";
    public Animal(){ }

    public abstract void run();
    //æ™®é€šæ–¹æ³•
    public void go(){ }
}
```

äºŒã€static ä¸ abstract èƒ½åŒæ—¶ä½¿ç”¨å—ï¼Ÿ
ç­”ï¼šä¸èƒ½ï¼Œè¢« static ä¿®é¥°çš„æ–¹æ³•å±äºç±»ï¼Œæ˜¯ç±»è‡ªå·±çš„ä¸œè¥¿ï¼Œä¸æ˜¯ç»™å­ç±»æ¥ç»§æ‰¿çš„ï¼Œè€ŒæŠ½è±¡æ–¹æ³•æœ¬èº«æ²¡æœ‰å®ç°ï¼Œå°±æ˜¯ç”¨æ¥ç»™å­ç±»ç»§æ‰¿



***



#### å­˜åœ¨æ„ä¹‰

**è¢«ç»§æ‰¿**ï¼ŒæŠ½è±¡ç±»å°±æ˜¯ä¸ºäº†è¢«å­ç±»ç»§æ‰¿ï¼Œå¦åˆ™æŠ½è±¡ç±»å°†æ¯«æ— æ„ä¹‰ï¼ˆæ ¸å¿ƒï¼‰

æŠ½è±¡ç±»ä½“ç°çš„æ˜¯"æ¨¡æ¿æ€æƒ³"ï¼š**éƒ¨åˆ†å®ç°ï¼Œéƒ¨åˆ†æŠ½è±¡**ï¼Œå¯ä»¥ä½¿ç”¨æŠ½è±¡ç±»è®¾è®¡ä¸€ä¸ªæ¨¡æ¿æ¨¡å¼

```java
//ä½œæ–‡æ¨¡æ¿
public class ExtendsDemo {
    public static void main(String[] args) {
        Student xiaoMa = new Student();
        xiaoMa.write();
    }
}
class Student extends Template{
    @Override
    public String writeText() {return "\tå†…å®¹"}
}
// 1.å†™ä¸€ä¸ªæ¨¡æ¿ç±»ï¼šä»£è¡¨äº†ä½œæ–‡æ¨¡æ¿ã€‚
abstract class Template{
    private String title = "\t\t\t\t\tæ ‡é¢˜";
    private String start = "\tå¼€å¤´";
    private String last = "\tç»“å°¾";
    public void write(){
        System.out.println(title+"\n"+start);
        System.out.println(writeText());
        System.out.println(last);
    }
    // æ­£æ–‡éƒ¨åˆ†å®šä¹‰æˆæŠ½è±¡æ–¹æ³•ï¼Œäº¤ç»™å­ç±»é‡å†™ï¼ï¼
    public abstract String writeText();
}
```



***



### æ¥å£

#### åŸºæœ¬ä»‹ç»

æ¥å£ï¼Œæ˜¯ Java è¯­è¨€ä¸­ä¸€ç§å¼•ç”¨ç±»å‹ï¼Œæ˜¯æ–¹æ³•çš„é›†åˆã€‚

æ¥å£æ˜¯æ›´åŠ å½»åº•çš„æŠ½è±¡ï¼Œæ¥å£ä¸­åªæœ‰æŠ½è±¡æ–¹æ³•å’Œå¸¸é‡ï¼Œæ²¡æœ‰å…¶ä»–æˆåˆ†ï¼Œjdk1.8 å‰

```java
 ä¿®é¥°ç¬¦ interface æ¥å£åç§°{
	// æŠ½è±¡æ–¹æ³•
	// é»˜è®¤æ–¹æ³•
	// é™æ€æ–¹æ³•
	// ç§æœ‰æ–¹æ³•
}
```

* æŠ½è±¡æ–¹æ³•ï¼šæ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•é»˜è®¤ä¼šåŠ ä¸Špublic abstractä¿®é¥°ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ä¸å†™

* é™æ€æ–¹æ³•ï¼šé™æ€æ–¹æ³•å¿…é¡»æœ‰æ–¹æ³•ä½“

* å¸¸é‡ï¼šå¸¸é‡æ˜¯public static finalä¿®é¥°çš„æˆå‘˜å˜é‡ï¼Œä»…èƒ½è¢«èµ‹å€¼ä¸€æ¬¡ï¼Œå€¼ä¸èƒ½æ”¹å˜ã€‚å¸¸é‡çš„åç§°è§„èŒƒä¸Šè¦æ±‚å…¨éƒ¨å¤§å†™ï¼Œå¤šä¸ªå•è¯ä¸‹åˆ’çº¿è¿æ¥ã€‚public static finalå¯ä»¥çœç•¥ä¸å†™ã€‚

  ```java
  public interface InterfaceDemo{
      //public static final String SCHOOL_NAME = "å¼ ä¸‰";
  	String SCHOOL_NAME = "å¼ ä¸‰";
      
      //public abstract void run();
      void run();//é»˜è®¤è¡¥å……
  }
  ```




***




#### å®ç°æ¥å£

ä½œç”¨ï¼š**æ¥å£æ˜¯ç”¨æ¥è¢«ç±»å®ç°çš„ã€‚**

ç±»ä¸ç±»æ˜¯ç»§æ‰¿å…³ç³»ï¼šä¸€ä¸ªç±»åªèƒ½ç›´æ¥ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»ï¼Œå•ç»§æ‰¿
ç±»ä¸æ¥å£æ˜¯å®ç°å…³ç³»ï¼šä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œå¤šå®ç°ï¼Œæ¥å£ä¸èƒ½ç»§æ‰¿ç±»
æ¥å£ä¸æ¥å£ç»§æ‰¿å…³ç³»ï¼š**å¤šç»§æ‰¿**

>å­ç±»   ç»§æ‰¿   çˆ¶ç±»
>å®ç°ç±» å®ç°   æ¥å£

```java
ä¿®é¥°ç¬¦ class å®ç°ç±»åç§° implements æ¥å£1,æ¥å£2,æ¥å£3,....{

}
ä¿®é¥°ç¬¦ interface æ¥å£å extend æ¥å£1,æ¥å£2,æ¥å£3,....{
    
}
```

å®ç°å¤šä¸ªæ¥å£çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š

1. å½“ä¸€ä¸ªç±»å®ç°å¤šä¸ªæ¥å£æ—¶ï¼Œå¤šä¸ªæ¥å£ä¸­å­˜åœ¨åŒåçš„é™æ€æ–¹æ³•å¹¶ä¸ä¼šå†²çªï¼Œåªèƒ½é€šè¿‡å„è‡ªæ¥å£åè®¿é—®é™æ€æ–¹æ³•

2. å½“ä¸€ä¸ªç±»å®ç°å¤šä¸ªæ¥å£æ—¶ï¼Œå¤šä¸ªæ¥å£ä¸­å­˜åœ¨åŒåçš„é»˜è®¤æ–¹æ³•ï¼Œå®ç°ç±»å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•

3. å½“ä¸€ä¸ªç±»ï¼Œæ—¢ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»ï¼Œåˆå®ç°è‹¥å¹²ä¸ªæ¥å£æ—¶ï¼Œçˆ¶ç±»ä¸­çš„æˆå‘˜æ–¹æ³•ä¸æ¥å£ä¸­çš„é»˜è®¤æ–¹æ³•é‡åï¼Œå­ç±»**å°±è¿‘é€‰æ‹©æ‰§è¡Œçˆ¶ç±»**çš„æˆå‘˜æ–¹æ³•

4. æ¥å£ä¸­ï¼Œæ²¡æœ‰æ„é€ å™¨ï¼Œ**ä¸èƒ½åˆ›å»ºå¯¹è±¡**ï¼Œæ¥å£æ˜¯æ›´å½»åº•çš„æŠ½è±¡ï¼Œè¿æ„é€ å™¨éƒ½æ²¡æœ‰ï¼Œè‡ªç„¶ä¸èƒ½åˆ›å»ºå¯¹è±¡ï¼ï¼

   ```java
   public class InterfaceDemo {
       public static void main(String[] args) {
           Student s = new Student();
           s.run();
           s.rule();
       }
   }
   class Student implements Food, Person{
       @Override
       public void eat() {}
       
       @Override
       public void run() {}
   }
   interface Food{
       void eat();
   }
   interface Person{
       void run();
   }
   //å¯ä»¥ç›´æ¥ interface Person extend Food,
   //ç„¶å class Student implements Person æ•ˆæœä¸€æ ·
   ```

   

***



#### æ–°å¢åŠŸèƒ½

jdk1.8 ä»¥åæ–°å¢çš„åŠŸèƒ½ï¼š

* é»˜è®¤æ–¹æ³•ï¼ˆå°±æ˜¯æ™®é€šå®ä¾‹æ–¹æ³•ï¼‰
  * å¿…é¡»ç”¨ default ä¿®é¥°ï¼Œé»˜è®¤ä¼š public ä¿®é¥°
  * å¿…é¡»ç”¨æ¥å£çš„å®ç°ç±»çš„å¯¹è±¡æ¥è°ƒç”¨
* é™æ€æ–¹æ³•
  * é»˜è®¤ä¼š public ä¿®é¥°
  * æ¥å£çš„é™æ€æ–¹æ³•å¿…é¡»ç”¨æ¥å£çš„ç±»åæœ¬èº«æ¥è°ƒç”¨
  * è°ƒç”¨æ ¼å¼ï¼šClassName.method()
* ç§æœ‰æ–¹æ³•ï¼šJDK 1.9 æ‰å¼€å§‹æœ‰çš„ï¼Œåªèƒ½åœ¨**æœ¬ç±»ä¸­**è¢«å…¶ä»–çš„é»˜è®¤æ–¹æ³•æˆ–è€…ç§æœ‰æ–¹æ³•è®¿é—®

```java
public class InterfaceDemo {
    public static void main(String[] args) {
        // 1.é»˜è®¤æ–¹æ³•è°ƒç”¨ï¼šå¿…é¡»ç”¨æ¥å£çš„å®ç°ç±»å¯¹è±¡è°ƒç”¨ã€‚
        Man m = new Man();
        m.run();
        m.work();

        // 2.æ¥å£çš„é™æ€æ–¹æ³•å¿…é¡»ç”¨æ¥å£çš„ç±»åæœ¬èº«æ¥è°ƒç”¨ã€‚
        InterfaceJDK8.inAddr();
    }
}
class Man implements InterfaceJDK8{
    @Override
    public void work() {
        System.out.println("å·¥ä½œä¸­ã€‚ã€‚ã€‚");
    }
}

interface InterfaceJDK8{
    //æŠ½è±¡æ–¹æ³•ï¼ï¼
    void work();
    // a.é»˜è®¤æ–¹æ³•ï¼ˆå°±æ˜¯ä¹‹å‰å†™çš„æ™®é€šå®ä¾‹æ–¹æ³•ï¼‰
    // å¿…é¡»ç”¨æ¥å£çš„å®ç°ç±»çš„å¯¹è±¡æ¥è°ƒç”¨ã€‚
    default void run(){
        go();
        System.out.println("å¼€å§‹è·‘æ­¥ğŸƒâ€");
    }

    // b.é™æ€æ–¹æ³•
    // æ³¨æ„ï¼šæ¥å£çš„é™æ€æ–¹æ³•å¿…é¡»ç”¨æ¥å£çš„ç±»åæœ¬èº«æ¥è°ƒç”¨
    static void inAddr(){
        System.out.println("æˆ‘ä»¬åœ¨æ­¦æ±‰");
    }
    
    // c.ç§æœ‰æ–¹æ³•ï¼ˆå°±æ˜¯ç§æœ‰çš„å®ä¾‹æ–¹æ³•ï¼‰: JDK 1.9æ‰å¼€å§‹æœ‰çš„ã€‚
    // åªèƒ½åœ¨æœ¬æ¥å£ä¸­è¢«å…¶ä»–çš„é»˜è®¤æ–¹æ³•æˆ–è€…ç§æœ‰æ–¹æ³•è®¿é—®ã€‚
    private void go(){
        System.out.println("å¼€å§‹ã€‚ã€‚");
    }
}
```



***



#### å¯¹æ¯”æŠ½è±¡ç±»

| **å‚æ•°**           | **æŠ½è±¡ç±»**                                                   | **æ¥å£**                                                     |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| é»˜è®¤çš„æ–¹æ³•å®ç°     | å¯ä»¥æœ‰é»˜è®¤çš„æ–¹æ³•å®ç°                                         | æ¥å£å®Œå…¨æ˜¯æŠ½è±¡çš„ï¼Œjdk8ä»¥åæœ‰é»˜è®¤çš„å®ç°                       |
| å®ç°               | å­ç±»ä½¿ç”¨**extends**å…³é”®å­—æ¥ç»§æ‰¿æŠ½è±¡ç±»ã€‚å¦‚æœå­ç±»ä¸æ˜¯æŠ½è±¡ç±»çš„è¯ï¼Œå®ƒéœ€è¦æä¾›æŠ½è±¡ç±»ä¸­æ‰€æœ‰å£°æ˜çš„æ–¹æ³•çš„å®ç°ã€‚ | å­ç±»ä½¿ç”¨å…³é”®å­—**implements**æ¥å®ç°æ¥å£ã€‚å®ƒéœ€è¦æä¾›æ¥å£ä¸­æ‰€æœ‰å£°æ˜çš„æ–¹æ³•çš„å®ç° |
| æ„é€ å™¨             | æŠ½è±¡ç±»å¯ä»¥æœ‰æ„é€ å™¨                                           | æ¥å£ä¸èƒ½æœ‰æ„é€ å™¨                                             |
| ä¸æ­£å¸¸Javaç±»çš„åŒºåˆ« | é™¤äº†ä¸èƒ½å®ä¾‹åŒ–æŠ½è±¡ç±»ä¹‹å¤–ï¼Œå’Œæ™®é€šJavaç±»æ²¡æœ‰ä»»ä½•åŒºåˆ«           | æ¥å£æ˜¯å®Œå…¨ä¸åŒçš„ç±»å‹                                         |
| è®¿é—®ä¿®é¥°ç¬¦         | æŠ½è±¡æ–¹æ³•å¯ä»¥æœ‰**public**ã€**protected**å’Œ**default**è¿™äº›ä¿®é¥°ç¬¦ | æ¥å£æ–¹æ³•é»˜è®¤ä¿®é¥°ç¬¦æ˜¯**public**ï¼Œåˆ«çš„ä¿®é¥°ç¬¦éœ€è¦æœ‰æ–¹æ³•ä½“       |
| mainæ–¹æ³•           | æŠ½è±¡æ–¹æ³•å¯ä»¥æœ‰mainæ–¹æ³•å¹¶ä¸”æˆ‘ä»¬å¯ä»¥è¿è¡Œå®ƒ                     | jdk8ä»¥å‰æ¥å£æ²¡æœ‰mainæ–¹æ³•ï¼Œä¸èƒ½è¿è¡Œï¼›jdk8ä»¥åæ¥å£å¯ä»¥æœ‰defaultå’Œstaticæ–¹æ³•ï¼Œå¯ä»¥è¿è¡Œmainæ–¹æ³• |
| å¤šç»§æ‰¿             | æŠ½è±¡æ–¹æ³•å¯ä»¥ç»§æ‰¿ä¸€ä¸ªç±»å’Œå®ç°å¤šä¸ªæ¥å£                         | æ¥å£å¯ä»¥ç»§æ‰¿ä¸€ä¸ªæˆ–å¤šä¸ªå…¶å®ƒæ¥å£ï¼Œæ¥å£ä¸å¯ç»§æ‰¿ç±»               |
| é€Ÿåº¦               | æ¯”æ¥å£é€Ÿåº¦è¦å¿«                                               | æ¥å£æ˜¯ç¨å¾®æœ‰ç‚¹æ…¢çš„ï¼Œå› ä¸ºå®ƒéœ€è¦æ—¶é—´å»å¯»æ‰¾åœ¨ç±»ä¸­å®ç°çš„æ–¹æ³•     |
| æ·»åŠ æ–°æ–¹æ³•         | å¦‚æœå¾€æŠ½è±¡ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œå¯ä»¥ç»™å®ƒæä¾›é»˜è®¤çš„å®ç°ï¼Œå› æ­¤ä¸éœ€è¦æ”¹å˜ç°åœ¨çš„ä»£ç  | å¦‚æœå¾€æ¥å£ä¸­æ·»åŠ æ–¹æ³•ï¼Œé‚£ä¹ˆå¿…é¡»æ”¹å˜å®ç°è¯¥æ¥å£çš„ç±»             |





------



### å¤šæ€

#### åŸºæœ¬ä»‹ç»

å¤šæ€çš„æ¦‚å¿µï¼šåŒä¸€ä¸ªå®ä½“åŒæ—¶å…·æœ‰å¤šç§å½¢å¼åŒä¸€ä¸ªç±»å‹çš„å¯¹è±¡ï¼Œæ‰§è¡ŒåŒä¸€ä¸ªè¡Œä¸ºï¼Œåœ¨ä¸åŒçš„çŠ¶æ€ä¸‹ä¼šè¡¨ç°å‡ºä¸åŒçš„è¡Œä¸ºç‰¹å¾ã€‚

å¤šæ€çš„æ ¼å¼ï¼š

* çˆ¶ç±»ç±»å‹èŒƒå›´ > å­ç±»ç±»å‹èŒƒå›´

```java
çˆ¶ç±»ç±»å‹ å¯¹è±¡åç§° = new å­ç±»æ„é€ å™¨;
æ¥å£	  å¯¹è±¡åç§° = new å®ç°ç±»æ„é€ å™¨;
```

å¤šæ€çš„æ‰§è¡Œï¼š

* å¯¹äºæ–¹æ³•çš„è°ƒç”¨ï¼š**ç¼–è¯‘çœ‹å·¦è¾¹ï¼Œè¿è¡Œçœ‹å³è¾¹**ï¼ˆåˆ†æ´¾æœºåˆ¶ï¼‰
* å¯¹äºå˜é‡çš„è°ƒç”¨ï¼š**ç¼–è¯‘çœ‹å·¦è¾¹ï¼Œè¿è¡Œçœ‹å·¦è¾¹**

å¤šæ€çš„ä½¿ç”¨è§„åˆ™ï¼š

* å¿…é¡»å­˜åœ¨ç»§æ‰¿æˆ–è€…å®ç°å…³ç³»
* å¿…é¡»å­˜åœ¨çˆ¶ç±»ç±»å‹çš„å˜é‡å¼•ç”¨å­ç±»ç±»å‹çš„å¯¹è±¡
* å­˜åœ¨æ–¹æ³•é‡å†™

å¤šæ€çš„ä¼˜åŠ¿ï¼š
* åœ¨å¤šæ€å½¢å¼ä¸‹ï¼Œå³è¾¹å¯¹è±¡å¯ä»¥å®ç°ç»„ä»¶åŒ–åˆ‡æ¢ï¼Œä¸šåŠ¡åŠŸèƒ½ä¹Ÿéšä¹‹æ”¹å˜ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚å¯ä»¥å®ç°ç±»ä¸ç±»ä¹‹é—´çš„**è§£è€¦**
* çˆ¶ç±»ç±»å‹ä½œä¸ºæ–¹æ³•å½¢å¼å‚æ•°ï¼Œä¼ é€’å­ç±»å¯¹è±¡ç»™æ–¹æ³•ï¼Œå¯ä»¥ä¼ å…¥ä¸€åˆ‡å­ç±»å¯¹è±¡è¿›è¡Œæ–¹æ³•çš„è°ƒç”¨ï¼Œæ›´èƒ½ä½“ç°å‡ºå¤šæ€çš„**æ‰©å±•æ€§**ä¸ä¾¿åˆ©æ€§

å¤šæ€çš„åŠ£åŠ¿ï¼š 
* å¤šæ€å½¢å¼ä¸‹ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨å­ç±»ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå› ä¸ºç¼–è¯‘çœ‹å·¦è¾¹ï¼Œçˆ¶ç±»ä¸­æ²¡æœ‰å­ç±»ç‹¬æœ‰çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä»£ç åœ¨ç¼–è¯‘é˜¶æ®µå°±ç›´æ¥æŠ¥é”™äº†ï¼ 

```java
public class PolymorphicDemo {
    public static void main(String[] args) {
        Animal c = new Cat();
        c.run();
        //c.eat();//æŠ¥é”™  ç¼–è¯‘çœ‹å·¦è¾¹ éœ€è¦å¼ºè½¬
        go(c);
        go(new Dog);   
    }
    //ç”¨ Dogæˆ–è€…Cat éƒ½æ²¡åŠæ³•è®©æ‰€æœ‰åŠ¨ç‰©å‚ä¸è¿›æ¥ï¼Œåªèƒ½ç”¨Anima
    public static void go(Animal d){}
    
}
class Dog extends Animal{}

class Cat extends Animal{
    public void eat();
    @Override
    public void run(){}
}

class Animal{
    public void run(){}
}
```



***



#### ä¸Šä¸‹è½¬å‹

>åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢ï¼š
>    1.å°èŒƒå›´ç±»å‹çš„å˜é‡æˆ–è€…å€¼å¯ä»¥ç›´æ¥èµ‹å€¼ç»™å¤§èŒƒå›´ç±»å‹çš„å˜é‡ã€‚
>    2.å¤§èŒƒå›´ç±»å‹çš„å˜é‡æˆ–è€…å€¼å¿…é¡»å¼ºåˆ¶ç±»å‹è½¬æ¢ç»™å°èŒƒå›´ç±»å‹çš„å˜é‡ã€‚

å¼•ç”¨æ•°æ®ç±»å‹çš„**è‡ªåŠ¨**ç±»å‹è½¬æ¢è¯­æ³•ï¼šå­ç±»ç±»å‹çš„å¯¹è±¡æˆ–è€…å˜é‡å¯ä»¥è‡ªåŠ¨ç±»å‹è½¬æ¢èµ‹å€¼ç»™çˆ¶ç±»ç±»å‹çš„å˜é‡ã€‚

**çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡**

- **å‘ä¸Šè½¬å‹(upcasting)**ï¼šé€šè¿‡å­ç±»å¯¹è±¡(å°èŒƒå›´)å®ä¾‹åŒ–çˆ¶ç±»å¯¹è±¡(å¤§èŒƒå›´)ï¼Œè¿™ç§å±äºè‡ªåŠ¨è½¬æ¢
- **å‘ä¸‹è½¬å‹(downcasting)**ï¼šé€šè¿‡çˆ¶ç±»å¯¹è±¡(å¤§èŒƒå›´)å®ä¾‹åŒ–å­ç±»å¯¹è±¡(å°èŒƒå›´)ï¼Œè¿™ç§å±äºå¼ºåˆ¶è½¬æ¢

```java
public class PolymorphicDemo {
    public static void main(String[] args){
        Animal a = new Cat();//å‘ä¸Šè½¬å‹
        Cat c = (Cat)a;//å‘ä¸‹è½¬å‹
    }
}
class Animal{}
class Cat extends Animal{}
```



***



#### instanceof

instanceofï¼šåˆ¤æ–­å·¦è¾¹çš„å¯¹è±¡æ˜¯å¦æ˜¯å³è¾¹çš„ç±»çš„å®ä¾‹ï¼Œæˆ–è€…æ˜¯å…¶ç›´æ¥æˆ–é—´æ¥å­ç±»ï¼Œæˆ–è€…æ˜¯å…¶æ¥å£çš„å®ç°ç±»

* å¼•ç”¨ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼šçˆ¶ç±»ç±»å‹çš„å˜é‡æˆ–è€…å¯¹è±¡å¼ºåˆ¶ç±»å‹è½¬æ¢æˆå­ç±»ç±»å‹çš„å˜é‡ï¼Œå¦åˆ™æŠ¥é”™
* å¼ºåˆ¶ç±»å‹è½¬æ¢çš„æ ¼å¼ï¼š**ç±»å‹ å˜é‡åç§° = (ç±»å‹)(å¯¹è±¡æˆ–è€…å˜é‡)**
* æœ‰ç»§æ‰¿/å®ç°å…³ç³»çš„ä¸¤ä¸ªç±»å‹å°±å¯ä»¥è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œç¼–è¯‘é˜¶æ®µä¸€å®šä¸æŠ¥é”™ï¼Œä½†æ˜¯è¿è¡Œé˜¶æ®µå¯èƒ½å‡ºç°ç±»å‹è½¬æ¢å¼‚å¸¸ ClassCastException

```java
public class Demo{
    public static void main(String[] args){
		Aniaml a = new Dog();
		//Dog d = (Dog)a;
        //Cat c = (Cat)a; ç¼–è¯‘ä¸æŠ¥é”™ï¼Œè¿è¡ŒæŠ¥ClassCastExceptioné”™è¯¯
        if(a instanceof Cat){
            Cat c = (Cat)a; 
        } else if(a instanceof Dog) {
            Dog d = (Dog)a;
        }
    }
}
class Dog extends Animal{}
class Cat extends Animal{}
class Animal{}
```



***



### å†…éƒ¨ç±»

#### æ¦‚è¿°

å†…éƒ¨ç±»æ˜¯ç±»çš„äº”å¤§æˆåˆ†ä¹‹ä¸€ï¼šæˆå‘˜å˜é‡ï¼Œæ–¹æ³•ï¼Œæ„é€ å™¨ï¼Œä»£ç å—ï¼Œå†…éƒ¨ç±»

æ¦‚å¿µï¼šå®šä¹‰åœ¨ä¸€ä¸ªç±»é‡Œé¢çš„ç±»å°±æ˜¯å†…éƒ¨ç±»

ä½œç”¨ï¼šæä¾›æ›´å¥½çš„å°è£…æ€§ï¼Œä½“ç°å‡ºç»„ä»¶æ€æƒ³ï¼Œ**é—´æ¥è§£å†³ç±»æ— æ³•å¤šç»§æ‰¿å¼•èµ·çš„ä¸€ç³»åˆ—é—®é¢˜**

åˆ†ç±»ï¼šé™æ€å†…éƒ¨ç±»ã€å®ä¾‹å†…éƒ¨ç±»ï¼ˆæˆå‘˜å†…éƒ¨ç±»ï¼‰ã€å±€éƒ¨å†…éƒ¨ç±»ã€**åŒ¿åå†…éƒ¨ç±»**ï¼ˆé‡ç‚¹ï¼‰



***



#### é™æ€å†…éƒ¨ç±»

å®šä¹‰ï¼šæœ‰staticä¿®é¥°ï¼Œå±äºå¤–éƒ¨ç±»æœ¬èº«ï¼Œä¼šåŠ è½½ä¸€æ¬¡

é™æ€å†…éƒ¨ç±»ä¸­çš„æˆåˆ†ç ”ç©¶ï¼š

* ç±»æœ‰çš„æˆåˆ†å®ƒéƒ½æœ‰ï¼Œé™æ€å†…éƒ¨ç±»å±äºå¤–éƒ¨ç±»æœ¬èº«ï¼Œåªä¼šåŠ è½½ä¸€æ¬¡
* ç‰¹ç‚¹ä¸å¤–éƒ¨ç±»æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªæ˜¯ä½ç½®åœ¨åˆ«äººé‡Œé¢
* å¯ä»¥å®šä¹‰é™æ€æˆå‘˜

é™æ€å†…éƒ¨ç±»çš„è®¿é—®æ ¼å¼ï¼šå¤–éƒ¨ç±»åç§°.å†…éƒ¨ç±»åç§°

é™æ€å†…éƒ¨ç±»åˆ›å»ºå¯¹è±¡çš„æ ¼å¼ï¼šå¤–éƒ¨ç±»åç§°.å†…éƒ¨ç±»åç§° å¯¹è±¡åç§° = new å¤–éƒ¨ç±»åç§°.å†…éƒ¨ç±»æ„é€ å™¨;

é™æ€å†…éƒ¨ç±»çš„è®¿é—®æ‹“å±•ï¼š

* é™æ€å†…éƒ¨ç±»ä¸­æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜?	å¯ä»¥ï¼Œå¤–éƒ¨ç±»çš„é™æ€æˆå‘˜åªæœ‰ä¸€ä»½ï¼Œå¯ä»¥è¢«å…±äº«
* é™æ€å†…éƒ¨ç±»ä¸­æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å¤–éƒ¨ç±»çš„å®ä¾‹æˆå‘˜?	ä¸å¯ä»¥ï¼Œå¤–éƒ¨ç±»çš„æˆå‘˜å¿…é¡»ç”¨å¤–éƒ¨ç±»å¯¹è±¡è®¿é—®

```java
public class Demo{
    public static void main(String[] args){
        Outter.Inner in = new Outter.Inner();
    }
}

static class Outter{
    public static int age;
    private double salary;
    public static class Inner{
         //æ‹¥æœ‰ç±»çš„æ‰€æœ‰åŠŸèƒ½ æ„é€ å™¨ æ–¹æ³• æˆå‘˜å˜é‡
         System.out.println(age);
         //System.out.println(salary);æŠ¥é”™
	}
}
```



***



#### å®ä¾‹å†…éƒ¨ç±»

å®šä¹‰ï¼šæ— staticä¿®é¥°çš„å†…éƒ¨ç±»ï¼Œå±äºå¤–éƒ¨ç±»çš„æ¯ä¸ªå¯¹è±¡ï¼Œè·Ÿç€å¤–éƒ¨ç±»å¯¹è±¡ä¸€èµ·åŠ è½½ã€‚

å®ä¾‹å†…éƒ¨ç±»çš„æˆåˆ†ç‰¹ç‚¹ï¼šå®ä¾‹å†…éƒ¨ç±»ä¸­ä¸èƒ½å®šä¹‰é™æ€æˆå‘˜ï¼Œå…¶ä»–éƒ½å¯ä»¥å®šä¹‰

å®ä¾‹å†…éƒ¨ç±»çš„è®¿é—®æ ¼å¼ï¼šå¤–éƒ¨ç±»åç§°.å†…éƒ¨ç±»åç§°

åˆ›å»ºå¯¹è±¡çš„æ ¼å¼ï¼šå¤–éƒ¨ç±»åç§°.å†…éƒ¨ç±»åç§° å¯¹è±¡åç§° = new å¤–éƒ¨ç±»æ„é€ å™¨.new å†…éƒ¨æ„é€ å™¨;

* `Outter.Inner in = new Outter().new Inner();`

æ‹“å±•ï¼š**å®ä¾‹å†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„å…¨éƒ¨æˆå‘˜**

> * å®ä¾‹å†…éƒ¨ç±»ä¸­æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜ï¼Ÿ
>   å¯ä»¥ï¼Œå¤–éƒ¨ç±»çš„é™æ€æˆå‘˜å¯ä»¥è¢«å…±äº«è®¿é—®ï¼
> * å®ä¾‹å†…éƒ¨ç±»ä¸­æ˜¯å¦å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„å®ä¾‹æˆå‘˜ï¼Ÿ
>   å¯ä»¥ï¼Œå®ä¾‹å†…éƒ¨ç±»å±äºå¤–éƒ¨ç±»å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å¤–éƒ¨ç±»å¯¹è±¡çš„å®ä¾‹æˆå‘˜ï¼



***



#### å±€éƒ¨å†…éƒ¨ç±»

å±€éƒ¨å†…éƒ¨ç±»ï¼šå®šä¹‰åœ¨æ–¹æ³•ä¸­ï¼Œåœ¨æ„é€ å™¨ä¸­ï¼Œä»£ç å—ä¸­ï¼Œforå¾ªç¯ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ã€‚

å±€éƒ¨å†…éƒ¨ç±»ä¸­çš„æˆåˆ†ç‰¹ç‚¹ï¼šåªèƒ½å®šä¹‰å®ä¾‹æˆå‘˜ï¼Œä¸èƒ½å®šä¹‰é™æ€æˆå‘˜

```java
public class InnerClass{
	public static void main(String[] args){
        String name;
        class{}
    }
    public static void test(){
		class Animal{}
		class Cat extends Animal{}  
	}
}
```



***



#### åŒ¿åå†…éƒ¨ç±»

åŒ¿åå†…éƒ¨ç±»ï¼šæ²¡æœ‰åå­—çš„å±€éƒ¨å†…éƒ¨ç±»
ä½œç”¨ï¼šç®€åŒ–ä»£ç ï¼Œæ˜¯å¼€å‘ä¸­å¸¸ç”¨çš„å½¢å¼

åŒ¿åå†…éƒ¨ç±»çš„æ ¼å¼ï¼š

```java
new ç±»å|æŠ½è±¡ç±»|æ¥å£(å½¢å‚){
	//æ–¹æ³•é‡å†™ã€‚
}
```
 åŒ¿åå†…éƒ¨ç±»çš„ç‰¹ç‚¹ï¼š

* åŒ¿åå†…éƒ¨ç±»ä¸èƒ½å®šä¹‰é™æ€æˆå‘˜
* åŒ¿åå†…éƒ¨ç±»ä¸€æ—¦å†™å‡ºæ¥ï¼Œå°±ä¼šç«‹å³åˆ›å»ºä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»çš„å¯¹è±¡è¿”å›
* **åŒ¿åå†…éƒ¨ç±»çš„å¯¹è±¡çš„ç±»å‹ç›¸å½“äºæ˜¯å½“å‰newçš„é‚£ä¸ªçš„ç±»å‹çš„å­ç±»ç±»å‹**
* åŒ¿åå†…éƒ¨ç±»å¼•ç”¨å±€éƒ¨å˜é‡å¿…é¡»æ˜¯**å¸¸é‡**ï¼Œåº•å±‚åˆ›å»ºä¸ºå†…éƒ¨ç±»çš„æˆå‘˜å˜é‡ï¼ˆåŸå› ï¼šJVM â†’ è¿è¡Œæœºåˆ¶ â†’ ä»£ç ä¼˜åŒ–ï¼‰

```java
public class Anonymity {
    public static void main(String[] args) {
        Animal a = new Animal(){
            @Override
            public void run() {
                System.out.println("çŒ«è·‘çš„è´¼æºœ~~");
                //System.out.println(n);
            }
        };
        a.run();
        a.go();
    }
}
abstract class Animal{
    public abstract void run();

    public void go(){
        System.out.println("å¼€å§‹go~~~");
    }
}
```



***



### æƒé™ç¬¦

æƒé™ä¿®é¥°ç¬¦ï¼šæœ‰å››ç§**ï¼ˆprivate -> ç¼ºçœ -> protected - > public ï¼‰**
å¯ä»¥ä¿®é¥°æˆå‘˜å˜é‡ï¼Œä¿®é¥°æ–¹æ³•ï¼Œä¿®é¥°æ„é€ å™¨ï¼Œå†…éƒ¨ç±»ï¼Œä¸åŒä¿®é¥°ç¬¦ä¿®é¥°çš„æˆå‘˜èƒ½å¤Ÿè¢«è®¿é—®çš„æƒé™å°†å—åˆ°é™åˆ¶!

| å››ç§ä¿®é¥°ç¬¦è®¿é—®æƒé™ | private | ç¼ºçœ | protected | public |
| ------------------ | :-----: | :--: | :-------: | :----: |
| æœ¬ç±»ä¸­             |    âˆš    |  âˆš   |     âˆš     |   âˆš    |
| å­ç±»ä¸­             |    X    |  âˆš   |     âˆš     |   âˆš    |
| æœ¬åŒ…ä¸‹å…¶ä»–ç±»ä¸­     |    X    |  âˆš   |     âˆš     |   âˆš    |
| å…¶ä»–åŒ…ä¸‹çš„å­ç±»ä¸­   |    X    |  X   |     âˆš     |   âˆš    |
| å…¶ä»–åŒ…ä¸‹çš„å…¶ä»–ç±»ä¸­ |    X    |  X   |     X     |   âˆš    |

protected ç”¨äºä¿®é¥°æˆå‘˜ï¼Œè¡¨ç¤ºåœ¨ç»§æ‰¿ä½“ç³»ä¸­æˆå‘˜å¯¹äºå­ç±»å¯è§

* åŸºç±»çš„ protected æˆå‘˜æ˜¯åŒ…å†…å¯è§çš„ï¼Œå¹¶ä¸”å¯¹å­ç±»å¯è§
* è‹¥å­ç±»ä¸åŸºç±»ä¸åœ¨åŒä¸€åŒ…ä¸­ï¼Œé‚£ä¹ˆå­ç±»å®ä¾‹å¯ä»¥è®¿é—®å…¶ä»åŸºç±»ç»§æ‰¿è€Œæ¥çš„ protected æ–¹æ³•ï¼ˆé‡å†™ï¼‰ï¼Œè€Œä¸èƒ½è®¿é—®åŸºç±»å®ä¾‹çš„ protected æ–¹æ³•





***



### ä»£ç å—

#### é™æ€ä»£ç å—

é™æ€ä»£ç å—çš„æ ¼å¼ï¼š

 ```java
static {
}
 ```

* é™æ€ä»£ç å—ç‰¹ç‚¹ï¼š 
  * å¿…é¡»æœ‰staticä¿®é¥°
  * ä¼šä¸ç±»ä¸€èµ·ä¼˜å…ˆåŠ è½½ï¼Œä¸”è‡ªåŠ¨è§¦å‘æ‰§è¡Œä¸€æ¬¡
  * åªèƒ½è®¿é—®é™æ€èµ„æº
* é™æ€ä»£ç å—ä½œç”¨ï¼š
  * å¯ä»¥åœ¨æ‰§è¡Œç±»çš„æ–¹æ³•ç­‰æ“ä½œä¹‹å‰å…ˆåœ¨é™æ€ä»£ç å—ä¸­è¿›è¡Œé™æ€èµ„æºçš„åˆå§‹åŒ– 
  * **å…ˆæ‰§è¡Œé™æ€ä»£ç å—ï¼Œåœ¨æ‰§è¡Œmainå‡½æ•°é‡Œçš„æ“ä½œ**

```java
public class CodeDemo {
    public static String schoolName ;
    public static ArrayList<String> lists = new ArrayList<>();

    // é™æ€ä»£ç å—,å±äºç±»ï¼Œä¸ç±»ä¸€èµ·åŠ è½½ä¸€æ¬¡!
    static {
        System.out.println("é™æ€ä»£ç å—è¢«è§¦å‘æ‰§è¡Œ~~~~~~~");
        // åœ¨é™æ€ä»£ç å—ä¸­è¿›è¡Œé™æ€èµ„æºçš„åˆå§‹åŒ–æ“ä½œ
        schoolName = "å¼ ä¸‰";
        lists.add("3");
        lists.add("4");
        lists.add("5");
    }
    public static void main(String[] args) {
        System.out.println("mainæ–¹æ³•è¢«æ‰§è¡Œ");
        System.out.println(schoolName);
        System.out.println(lists);
    }
}
/*é™æ€ä»£ç å—è¢«è§¦å‘æ‰§è¡Œ~~~~~~~
mainæ–¹æ³•è¢«æ‰§è¡Œ
å¼ ä¸‰
[3, 4, 5] */
```



***



#### å®ä¾‹ä»£ç å—

å®ä¾‹ä»£ç å—çš„æ ¼å¼ï¼š

```java
{

}
```

* å®ä¾‹ä»£ç å—çš„ç‰¹ç‚¹ï¼š
  * æ— staticä¿®é¥°ï¼Œå±äºå¯¹è±¡
  * ä¼šä¸ç±»çš„å¯¹è±¡ä¸€èµ·åŠ è½½ï¼Œæ¯æ¬¡åˆ›å»ºç±»çš„å¯¹è±¡çš„æ—¶å€™ï¼Œå®ä¾‹ä»£ç å—éƒ½ä¼šè¢«åŠ è½½ä¸”è‡ªåŠ¨è§¦å‘æ‰§è¡Œä¸€æ¬¡
  * å®ä¾‹ä»£ç å—çš„ä»£ç åœ¨åº•å±‚å®é™…ä¸Šæ˜¯æå–åˆ°æ¯ä¸ªæ„é€ å™¨ä¸­å»æ‰§è¡Œçš„
  
* å®ä¾‹ä»£ç å—çš„ä½œç”¨ï¼šå®ä¾‹ä»£ç å—å¯ä»¥åœ¨åˆ›å»ºå¯¹è±¡ä¹‹å‰è¿›è¡Œå®ä¾‹èµ„æºçš„åˆå§‹åŒ–æ“ä½œ

```java
public class CodeDemo {
    private String name;
    private ArrayList<String> lists = new ArrayList<>();
    {
        name = "ä»£ç å—";
        lists.add("java");
        System.out.println("å®ä¾‹ä»£ç å—è¢«è§¦å‘æ‰§è¡Œä¸€æ¬¡~~~~~~~~");
    }
    public CodeDemo02(){ }//æ„é€ æ–¹æ³•
    public CodeDemo02(String name){}

    public static void main(String[] args) {
        CodeDemo c = new CodeDemo();//å®ä¾‹ä»£ç å—è¢«è§¦å‘æ‰§è¡Œä¸€æ¬¡
        System.out.println(c.name);
        System.out.println(c.lists);
        new CodeDemo02();//å®ä¾‹ä»£ç å—è¢«è§¦å‘æ‰§è¡Œä¸€æ¬¡
    }
}
```



***






## API

### Object

#### åŸºæœ¬ä»‹ç»

Objectç±»æ˜¯Javaä¸­çš„ç¥–å®—ç±»ï¼Œä¸€ä¸ªç±»æˆ–è€…é»˜è®¤ç»§æ‰¿Objectç±»ï¼Œæˆ–è€…é—´æ¥ç»§æ‰¿Objectç±»ï¼ŒObjectç±»çš„æ–¹æ³•æ˜¯ä¸€åˆ‡å­ç±»éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨

Objectç±»å¸¸ç”¨æ–¹æ³•ï¼š

* `public String toString()`ï¼š
  é»˜è®¤æ˜¯è¿”å›å½“å‰å¯¹è±¡åœ¨å †å†…å­˜ä¸­çš„åœ°å€ä¿¡æ¯ï¼šç±»çš„å…¨é™å@å†…å­˜åœ°å€ï¼Œä¾‹ï¼šStudent@735b478ï¼›
  ç›´æ¥è¾“å‡ºå¯¹è±¡åç§°ï¼Œé»˜è®¤ä¼šè°ƒç”¨toString()æ–¹æ³•ï¼Œæ‰€ä»¥çœç•¥toString()ä¸å†™ï¼›
  å¦‚æœè¾“å‡ºå¯¹è±¡çš„å†…å®¹ï¼Œéœ€è¦é‡å†™toString()æ–¹æ³•ï¼ŒtoStringæ–¹æ³•å­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†è¢«å­ç±»é‡å†™
* `public boolean equals(Object o)`ï¼šé»˜è®¤æ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨æ˜¯å¦ç›¸åŒ
* `protected Object clone()`ï¼šåˆ›å»ºå¹¶è¿”å›æ­¤å¯¹è±¡çš„å‰¯æœ¬ 

åªè¦ä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹ä¸€æ ·ï¼Œå°±è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ï¼š

```java
public boolean equals(Object o) {
	// 1.åˆ¤æ–­æ˜¯å¦è‡ªå·±å’Œè‡ªå·±æ¯”è¾ƒï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªå¯¹è±¡æ¯”è¾ƒç›´æ¥è¿”å›true
	if (this == o) return true;
	// 2.åˆ¤æ–­è¢«æ¯”è¾ƒè€…æ˜¯å¦ä¸ºnull ,ä»¥åŠæ˜¯å¦æ˜¯å­¦ç”Ÿç±»å‹ã€‚
	if (o == null || this.getClass() != o.getClass()) return false;
	// 3.oä¸€å®šæ˜¯å­¦ç”Ÿç±»å‹ï¼Œå¼ºåˆ¶è½¬æ¢æˆå­¦ç”Ÿï¼Œå¼€å§‹æ¯”è¾ƒå†…å®¹ï¼
	Student student = (Student) o;
	return age == student.age &&
           sex == student.sex &&
           Objects.equals(name, student.name);
}
```

**é¢è¯•é¢˜**ï¼š== å’Œequalsçš„åŒºåˆ«

* == æ¯”è¾ƒçš„æ˜¯å˜é‡(æ ˆ)å†…å­˜ä¸­å­˜æ”¾çš„å¯¹è±¡çš„(å †)å†…å­˜åœ°å€ï¼Œç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„**åœ°å€**æ˜¯å¦ç›¸åŒï¼Œå³æ˜¯å¦æ˜¯æŒ‡ç›¸åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ¯”è¾ƒçš„æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒ‡é’ˆæ“ä½œã€‚
* é‡å†™equalsæ–¹æ³•æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„**å†…å®¹**æ˜¯å¦ç›¸ç­‰ï¼Œæ‰€æœ‰çš„ç±»éƒ½æ˜¯ç»§æ‰¿è‡ªjava.lang.Objectç±»ï¼Œæ‰€ä»¥é€‚ç”¨äºæ‰€æœ‰å¯¹è±¡ï¼Œå¦‚æœ**æ²¡æœ‰å¯¹è¯¥æ–¹æ³•è¿›è¡Œè¦†ç›–çš„è¯ï¼Œè°ƒç”¨çš„ä»ç„¶æ˜¯Objectç±»ä¸­çš„æ–¹æ³•ï¼Œæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨**

hashCodeçš„ä½œç”¨ï¼š

* hashCodeçš„å­˜åœ¨ä¸»è¦æ˜¯ç”¨äºæŸ¥æ‰¾çš„å¿«æ·æ€§ï¼Œå¦‚Hashtableï¼ŒHashMapç­‰ï¼Œå¯ä»¥åœ¨æ•£åˆ—å­˜å‚¨ç»“æ„ä¸­ç¡®å®šå¯¹è±¡çš„å­˜å‚¨åœ°å€
* å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸åŒï¼Œå°±æ˜¯é€‚ç”¨äºequals(java.lang.Object) æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡çš„hashCodeä¸€å®šè¦ç›¸åŒ
* å“ˆå¸Œå€¼ç›¸åŒçš„æ•°æ®ä¸ä¸€å®šå†…å®¹ç›¸åŒï¼Œå†…å®¹ç›¸åŒçš„æ•°æ®å“ˆå¸Œå€¼ä¸€å®šç›¸åŒ



***



#### æ·±æµ…å…‹éš†

æ·±æµ…æ‹·è´ï¼ˆå…‹éš†ï¼‰çš„æ¦‚å¿µï¼š

* æµ…æ‹·è´ (shallowCopy)ï¼šå¯¹åŸºæœ¬æ•°æ®ç±»å‹è¿›è¡Œå€¼ä¼ é€’ï¼Œå¯¹å¼•ç”¨æ•°æ®ç±»å‹åªæ˜¯å¤åˆ¶äº†å¼•ç”¨ï¼Œè¢«å¤åˆ¶å¯¹è±¡å±æ€§çš„æ‰€æœ‰çš„å¼•ç”¨ä»ç„¶æŒ‡å‘åŸæ¥çš„å¯¹è±¡ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯å¢åŠ äº†ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åŸæ¥å¯¹è±¡çš„å†…å­˜åœ°å€

* æ·±æ‹·è´ (deepCopy)ï¼šå¯¹åŸºæœ¬æ•°æ®ç±»å‹è¿›è¡Œå€¼ä¼ é€’ï¼Œå¯¹å¼•ç”¨æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªæ•´ä¸ªç‹¬ç«‹çš„å¯¹è±¡æ‹·è´ï¼Œä¼šæ‹·è´æ‰€æœ‰çš„å±æ€§å¹¶æŒ‡å‘çš„åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯æŠŠæ‰€æœ‰å±æ€§å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„å†…å­˜ï¼Œå¢åŠ ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ–°å†…å­˜ã€‚æ‰€ä»¥ä½¿ç”¨æ·±æ‹·è´çš„æƒ…å†µä¸‹ï¼Œé‡Šæ”¾å†…å­˜çš„æ—¶å€™ä¸ä¼šå‡ºç°ä½¿ç”¨æµ…æ‹·è´æ—¶é‡Šæ”¾åŒä¸€å—å†…å­˜çš„é”™è¯¯

Object çš„ clone() æ˜¯ protected æ–¹æ³•ï¼Œä¸€ä¸ªç±»ä¸æ˜¾å¼å»é‡å†™ clone()ï¼Œå°±ä¸èƒ½ç›´æ¥å»è°ƒç”¨è¯¥ç±»å®ä¾‹çš„clone()æ–¹æ³•

å…‹éš†å°±æ˜¯åˆ¶é€ ä¸€ä¸ªå¯¹è±¡çš„å‰¯æœ¬ï¼Œæ ¹æ®æ‰€è¦å…‹éš†çš„å¯¹è±¡çš„æˆå‘˜å˜é‡ä¸­æ˜¯å¦å«æœ‰å¼•ç”¨ç±»å‹ï¼Œå¯ä»¥å°†å…‹éš†åˆ†ä¸ºä¸¤ç§ï¼šæµ…å…‹éš†(Shallow Clone) å’Œ æ·±å…‹éš†(Deep Clone)ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨Objectä¸­çš„cloneæ–¹æ³•è¿›è¡Œå…‹éš†å°±æ˜¯æµ…å…‹éš†ï¼Œå³å®Œæˆå¯¹è±¡åŸŸå¯¹åŸŸçš„æ‹·è´

Cloneable æ¥å£æ˜¯ä¸€ä¸ªæ ‡è¯†æ€§æ¥å£ï¼Œå³è¯¥æ¥å£ä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼ˆåŒ…æ‹¬clone()ï¼‰ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªç±»æƒ³åˆæ³•çš„è¿›è¡Œå…‹éš†ï¼Œé‚£ä¹ˆå°±å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ï¼Œåœ¨ä½¿ç”¨clone()æ–¹æ³•æ—¶ï¼Œè‹¥è¯¥ç±»æœªå®ç° Cloneable æ¥å£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸

* Clone & Copyï¼š`Student s = new Student`

  `Student s1 = s`ï¼šåªæ˜¯copyäº†ä¸€ä¸‹referenceï¼Œså’Œs1æŒ‡å‘å†…å­˜ä¸­åŒä¸€ä¸ªobjectï¼Œå¯¹å¯¹è±¡çš„ä¿®æ”¹ä¼šå½±å“å¯¹æ–¹

  `Student s2 = s.clone()`ï¼šä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„Studentå¯¹è±¡ï¼Œå¹¶ä¸”å’Œså…·æœ‰ç›¸åŒçš„å±æ€§å€¼å’Œæ–¹æ³•

* Shallow Clone & Deep Cloneï¼š
  
  æµ…å…‹éš†ï¼šObjectä¸­çš„clone()æ–¹æ³•åœ¨å¯¹æŸä¸ªå¯¹è±¡å…‹éš†æ—¶å¯¹å…¶ä»…ä»…æ˜¯ç®€å•åœ°æ‰§è¡ŒåŸŸå¯¹åŸŸçš„copy
  
  * å¯¹åŸºæœ¬æ•°æ®ç±»å‹å’ŒåŒ…è£…ç±»çš„å…‹éš†æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚Stringã€Integerç­‰åŒ…è£…ç±»å‹åœ¨å†…å­˜ä¸­æ˜¯ä¸å¯ä»¥è¢«æ”¹å˜çš„å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å…‹éš†æ—¶å¯ä»¥è§†ä¸ºåŸºæœ¬ç±»å‹ï¼Œåªéœ€æµ…å…‹éš†å¼•ç”¨å³å¯
  * å¦‚æœå¯¹ä¸€ä¸ªå¼•ç”¨ç±»å‹è¿›è¡Œå…‹éš†æ—¶åªæ˜¯å…‹éš†äº†å®ƒçš„å¼•ç”¨ï¼Œå’ŒåŸå§‹å¯¹è±¡å…±äº«å¯¹è±¡æˆå‘˜å˜é‡

  ![](https://gitee.com/seazean/images/raw/master/Java/Objectæµ…å…‹éš†.jpg)

  æ·±å…‹éš†ï¼šåœ¨å¯¹æ•´ä¸ªå¯¹è±¡æµ…å…‹éš†åï¼Œå¯¹å…¶å¼•ç”¨å˜é‡è¿›è¡Œå…‹éš†ï¼Œå¹¶å°†å…¶æ›´æ–°åˆ°æµ…å…‹éš†å¯¹è±¡ä¸­å»

  ```java
  public class Student  implements Cloneable{
      private String name;
      private Integer age;
      private Date date;
  
      @Override
      protected Object clone() throws CloneNotSupportedException {
          Student s = (Student) super.clone();
          s.date = (Date) date.clone();
          return s;
      }
      //.....
  }
  ```

SDP â†’ åˆ›å»ºå‹ â†’ åŸå‹æ¨¡å¼



***



### Objects

Objects ç±»ä¸ Object æ˜¯ç»§æ‰¿å…³ç³»ã€‚

Objectsçš„æ–¹æ³•ï¼š

* `public static boolean equals(Object a, Object b)` : æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸åŒã€‚
    åº•å±‚è¿›è¡Œéç©ºåˆ¤æ–­ï¼Œä»è€Œå¯ä»¥é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œæ›´å®‰å…¨ï¼ï¼æ¨èä½¿ç”¨ï¼ï¼

  ```java
  public static boolean equals(Object a, Object b) {
      return a == b || a != null && a.equals(b);
  }
  ```

* `public static boolean isNull(Object obj)` : åˆ¤æ–­å˜é‡æ˜¯å¦ä¸ºnull ,ä¸ºnullè¿”å›true ,åä¹‹ï¼

* `public static String toString(å¯¹è±¡)` : è¿”å›å‚æ•°ä¸­å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼

* `public static String toString(å¯¹è±¡, é»˜è®¤å­—ç¬¦ä¸²)` : è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚

```java
public class ObjectsDemo {
    public static void main(String[] args) {
        Student s1 = null;
        Student s2 = new Student();
        System.out.println(Objects.equals(s1 , s2));//æ¨èä½¿ç”¨
        // System.out.println(s1.equals(s2)); // ç©ºæŒ‡é’ˆå¼‚å¸¸
 
        System.out.println(Objects.isNull(s1));
        System.out.println(s1 == null);//ç›´æ¥åˆ¤æ–­æ¯”è¾ƒå¥½
    }
}

public class Student {
}
```



***



### String

#### åŸºæœ¬ä»‹ç»

**String è¢«å£°æ˜ä¸º finalï¼Œå› æ­¤ä¸å¯è¢«ç»§æ‰¿ (Integer ç­‰åŒ…è£…ç±»ä¹Ÿä¸èƒ½è¢«ç»§æ‰¿ï¼‰**

```java
public final class String implements java.io.Serializable, Comparable<String>, CharSequence {
 	/** The value is used for character storage. */
    private final byte[] value;
    /** The identifier of the encoding used to encode the bytes in {@code value}. */
    private final byte coder;
}
```

åœ¨ Java 9 ä¹‹åï¼ŒString ç±»çš„å®ç°æ”¹ç”¨ byte æ•°ç»„å­˜å‚¨å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ä½¿ç”¨ `coder` æ¥æ ‡è¯†ä½¿ç”¨äº†å“ªç§ç¼–ç 

value æ•°ç»„è¢«å£°æ˜ä¸º finalï¼Œè¿™æ„å‘³ç€ value æ•°ç»„åˆå§‹åŒ–ä¹‹åå°±ä¸èƒ½å†å¼•ç”¨å…¶å®ƒæ•°ç»„ï¼Œå¹¶ä¸” String å†…éƒ¨æ²¡æœ‰æ”¹å˜ value æ•°ç»„çš„æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥**ä¿è¯ String ä¸å¯å˜ï¼Œä¹Ÿä¿è¯çº¿ç¨‹å®‰å…¨**

**æ³¨æ„ï¼šä¸èƒ½æ”¹å˜çš„æ„æ€æ˜¯æ¯æ¬¡æ›´æ”¹å­—ç¬¦ä¸²éƒ½ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯å¯¹åŸå§‹å¯¹è±¡è¿›è¡Œæ”¹å˜**

```java
String s = "abc";
s = s + "cd"; //s = abccd æ–°å¯¹è±¡
```



****



#### å¸¸ç”¨æ–¹æ³•

`public boolean equals(String s)` : æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸åŒã€åŒºåˆ†å¤§å°å†™
`public boolean equalsIgnoreCase(String anotherString)` : æ¯”è¾ƒå­—ç¬¦ä¸²çš„å†…å®¹ï¼Œå¿½ç•¥å¤§å°å†™
`public int length()` : è¿”å›æ­¤å­—ç¬¦ä¸²çš„é•¿åº¦
`public String trim()` : è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶å€¼ä¸ºæ­¤å­—ç¬¦ä¸²ï¼Œå¹¶åˆ é™¤ä»»ä½•å‰å¯¼å’Œå°¾éšç©ºæ ¼
`public String[] split(String regex)` : å°†å­—ç¬¦ä¸²æŒ‰ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²æˆå­—ç¬¦ä¸²æ•°ç»„
`public char charAt(int index)` : å–ç´¢å¼•å¤„çš„å€¼
`public char[] toCharArray()` : å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå­—ç¬¦æ•°ç»„åè¿”å›
`public boolean startsWith(String prefix)` : æµ‹è¯•æ­¤å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šçš„å‰ç¼€å¼€å¤´
`public int indexOf(String str)` : è¿”å›æŒ‡å®šå­å­—ç¬¦ä¸²ç¬¬ä¸€æ¬¡å‡ºç°çš„å­—ç¬¦ä¸²å†…çš„ç´¢å¼•ï¼Œæ²¡æœ‰è¿”å›-1
`public int lastIndexOf(String str)` : è¿”å›å­—ç¬¦ä¸²æœ€åä¸€æ¬¡å‡ºç°strçš„ç´¢å¼•ï¼Œæ²¡æœ‰è¿”å›-1
`public String substring(int beginIndex)` : è¿”å›å­å­—ç¬¦ä¸²ï¼Œä»¥åŸå­—ç¬¦ä¸²æŒ‡å®šç´¢å¼•å¤„åˆ°ç»“å°¾
`public String substring(int i, int j)` : æŒ‡å®šç´¢å¼•å¤„æ‰©å±•åˆ° j - 1 çš„ä½ç½®ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º j - i
`public String toLowerCase()` : å°†æ­¤ String æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå°å†™ï¼Œä½¿ç”¨é»˜è®¤è¯­è¨€ç¯å¢ƒçš„è§„åˆ™
`public String toUpperCase()` : ä½¿ç”¨é»˜è®¤è¯­è¨€ç¯å¢ƒçš„è§„åˆ™å°†æ­¤ String æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™
`public String replace(CharSequence target, CharSequence replacement)` : ä½¿ç”¨æ–°å€¼ï¼Œå°†å­—ç¬¦ä¸²ä¸­çš„æ—§å€¼æ›¿æ¢ï¼Œå¾—åˆ°æ–°çš„å­—ç¬¦ä¸²

```java
String s = 123-78;
s.replace("-","");//12378
```



***



#### æ„é€ æ–¹å¼

æ„é€ æ–¹æ³•ï¼š
	`public String()` : åˆ›å»ºä¸€ä¸ªç©ºç™½å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸å«æœ‰ä»»ä½•å†…å®¹
	`public String(char[] chs)` : æ ¹æ®å­—ç¬¦æ•°ç»„çš„å†…å®¹ï¼Œæ¥åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
	`public String(String original)` : æ ¹æ®ä¼ å…¥çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œæ¥åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡

ç›´æ¥èµ‹å€¼ï¼š`String s = â€œabcâ€` ç›´æ¥èµ‹å€¼çš„æ–¹å¼åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†…å®¹å°±æ˜¯abc

- é€šè¿‡æ„é€ æ–¹æ³•åˆ›å»ºï¼šé€šè¿‡ new åˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸€æ¬¡ new éƒ½ä¼šç”³è¯·ä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œè™½ç„¶å†…å®¹ç›¸åŒï¼Œä½†æ˜¯åœ°å€å€¼ä¸åŒï¼Œ**è¿”å›å †å†…å­˜ä¸­å¯¹è±¡çš„å¼•ç”¨**
- ç›´æ¥èµ‹å€¼æ–¹å¼åˆ›å»ºï¼šä»¥â€œ â€æ–¹å¼ç»™å‡ºçš„å­—ç¬¦ä¸²ï¼Œåªè¦å­—ç¬¦åºåˆ—ç›¸åŒï¼ˆé¡ºåºå’Œå¤§å°å†™ï¼‰ï¼Œæ— è®ºåœ¨ç¨‹åºä»£ç ä¸­å‡ºç°å‡ æ¬¡ï¼ŒJVM éƒ½åªä¼š**åœ¨ String Pool ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡**ï¼Œå¹¶åœ¨å­—ç¬¦ä¸²æ± ä¸­ç»´æŠ¤

`String str = new String("abc")`åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼š

* åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼šå­—ç¬¦ä¸²æ± ä¸­å·²ç»å­˜åœ¨"abc"å¯¹è±¡ï¼Œé‚£ä¹ˆç›´æ¥åœ¨åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ”¾å…¥å †ä¸­ï¼Œè¿”å›å †å†…å¼•ç”¨
* åˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼šå­—ç¬¦ä¸²æ± ä¸­æœªæ‰¾åˆ°"abc"å¯¹è±¡ï¼Œé‚£ä¹ˆåˆ†åˆ«åœ¨å †ä¸­å’Œå­—ç¬¦ä¸²æ± ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå­—ç¬¦ä¸²æ± ä¸­çš„æ¯”è¾ƒéƒ½æ˜¯é‡‡ç”¨ equals() æ–¹æ³•
  <img src="https://gitee.com/seazean/images/raw/master/Java/Stringæ„é€ æ–¹æ³•å­—èŠ‚ç .png" style="zoom: 67%;" />

`new String("a") + new String("b")`åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼š

* å¯¹è±¡1ï¼šnew StringBuilder()

* å¯¹è±¡2ï¼šnew String("a")ã€å¯¹è±¡3ï¼šå¸¸é‡æ± ä¸­çš„"a"

* å¯¹è±¡4ï¼šnew String("b")ã€å¯¹è±¡5ï¼šå¸¸é‡æ± ä¸­çš„"b"
  <img src="https://gitee.com/seazean/images/raw/master/Java/Stringæ‹¼æ¥æ–¹æ³•å­—èŠ‚ç .png" style="zoom:67%;" />

*  StringBuilderçš„toString()ï¼š

  ```java
  @Override
  public String toString() {
      return new String(value, 0, count);
  }
  ```

  * å¯¹è±¡6ï¼šnew String("ab")
  * StringBuilder çš„ toString() è°ƒç”¨ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ç”Ÿæˆ"ab"ï¼Œnew String("ab") ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡å› ä¸ºä¼ å‚æ•°çš„æ—¶å€™ä½¿ç”¨å­—é¢é‡åˆ›å»ºäº†å¯¹è±¡ â€œab â€ï¼Œå½“ä½¿ç”¨æ•°ç»„æ„é€  String å¯¹è±¡æ—¶ï¼Œæ²¡æœ‰åŠ å…¥å¸¸é‡æ± çš„æ“ä½œ



***



#### String Pool

##### åŸºæœ¬ä»‹ç»

**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Pool / StringTable / ä¸²æ± ï¼‰**ä¿å­˜ç€æ‰€æœ‰å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆliteral stringsï¼‰ï¼Œè¿™äº›å­—é¢é‡åœ¨ç¼–è¯‘æ—¶æœŸå°±ç¡®å®šï¼Œå¸¸é‡æ± ç±»ä¼¼äºJavaç³»ç»Ÿçº§åˆ«æä¾›çš„**ç¼“å­˜**ï¼Œå­˜æ”¾å¯¹è±¡å’Œå¼•ç”¨

* StringTableï¼Œhashtable ï¼ˆå“ˆå¸Œè¡¨ + é“¾è¡¨ï¼‰ç»“æ„ï¼Œä¸èƒ½æ‰©å®¹ï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯1009
* å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä»…æ˜¯ç¬¦å·ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰å˜ä¸ºå¯¹è±¡ï¼Œå¯ä»¥é¿å…é‡å¤åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
* å­—ç¬¦ä¸²**å˜é‡**çš„æ‹¼æ¥çš„åŸç†æ˜¯StringBuilderï¼ˆjdk1.8ï¼‰ï¼Œappend æ•ˆç‡è¦æ¯”å­—ç¬¦ä¸²æ‹¼æ¥é«˜å¾ˆå¤š
* å­—ç¬¦ä¸²**å¸¸é‡**æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–ï¼Œç»“æœåœ¨å¸¸é‡æ± 
* å¯ä»¥ä½¿ç”¨ String çš„ intern() æ–¹æ³•åœ¨è¿è¡Œè¿‡ç¨‹å°†å­—ç¬¦ä¸²æ·»åŠ åˆ° String Pool ä¸­



***



##### intern()

jdk1.8ï¼šå½“ä¸€ä¸ªå­—ç¬¦ä¸²è°ƒç”¨ intern() æ–¹æ³•æ—¶ï¼Œå¦‚æœ String Pool ä¸­ï¼š
* å­˜åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²å’Œè¯¥å­—ç¬¦ä¸²å€¼ç›¸ç­‰ï¼Œå°±ä¼šè¿”å› String Pool ä¸­å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼ˆéœ€è¦å˜é‡æ¥æ”¶ï¼‰
* ä¸å­˜åœ¨ï¼Œä¼šæŠŠå¯¹è±¡çš„**å¼•ç”¨åœ°å€**å¤åˆ¶ä¸€ä»½æ”¾å…¥ä¸²æ± ï¼Œå¹¶è¿”å›ä¸²æ± ä¸­çš„å¼•ç”¨åœ°å€ï¼Œå‰ææ˜¯å †å†…å­˜æœ‰è¯¥å¯¹è±¡ï¼Œå› ä¸º Pool åœ¨å †ä¸­ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ä¸å†åˆ›å»ºæ–°å¯¹è±¡

jdk1.6ï¼šå°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ï¼Œå¦‚æœæœ‰å°±ä¸æ”¾å…¥ï¼Œè¿”å›å·²æœ‰çš„ä¸²æ± ä¸­çš„å¯¹è±¡çš„åœ°å€ï¼›å¦‚æœæ²¡æœ‰ä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼ŒæŠŠä¸²æ± ä¸­çš„å¯¹è±¡è¿”å›

```java
public class Demo {
//å¸¸é‡æ± ä¸­çš„ä¿¡æ¯éƒ½åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œè¿™æ—¶a b abæ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·ï¼Œè¿˜ä¸æ˜¯javaå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ˜¯æ‡’æƒ°çš„
    // ldc #2 ä¼šæŠŠ a ç¬¦å·å˜ä¸º "a" å­—ç¬¦ä¸²å¯¹è±¡     ldc:åç¼–è¯‘åçš„æŒ‡ä»¤
    // ldc #3 ä¼šæŠŠ b ç¬¦å·å˜ä¸º "b" å­—ç¬¦ä¸²å¯¹è±¡
    // ldc #4 ä¼šæŠŠ ab ç¬¦å·å˜ä¸º "ab" å­—ç¬¦ä¸²å¯¹è±¡
    public static void main(String[] args) {
        String s1 = "a"; // æ‡’æƒ°çš„
        String s2 = "b";
        String s3 = "ab";//ä¸²æ± 
        // new StringBuilder().append("a").append("b").toString()  new String("ab")
        String s4 = s1 + s2;	// å †å†…åœ°å€
        String s5 = "a" + "b";  // javac åœ¨ç¼–è¯‘æœŸé—´çš„ä¼˜åŒ–ï¼Œç»“æœå·²ç»åœ¨ç¼–è¯‘æœŸç¡®å®šä¸ºab

        System.out.println(s3 == s4); // false
        System.out.println(s3 == s5); // true

        String x2 = new String("c") + new String("d"); // new String("cd")
        // è™½ç„¶newï¼Œä½†æ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± æ²¡æœ‰ cd å¯¹è±¡ï¼ŒtoString()æ–¹æ³•
        x2.intern();
        String x1 = "cd";

        System.out.println(x1 == x2); //true
    }
}
```

- == æ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹ï¼šæ¯”è¾ƒçš„æ˜¯å…·ä½“çš„å€¼
- == æ¯”è¾ƒå¼•ç”¨æ•°æ®ç±»å‹ï¼šæ¯”è¾ƒçš„æ˜¯å¯¹è±¡åœ°å€å€¼

ç»“è®ºï¼š

```java
String s1 = "ab";	//ä¸²æ± 
String s2 = new String("a") + new String("b");	//å †
//ä¸Šé¢ä¸¤æ¡æŒ‡ä»¤çš„ç»“æœå’Œä¸‹é¢çš„ æ•ˆæœ ç›¸åŒ
String s = new String("ab");
```



****



##### é¢è¯•é—®é¢˜

é—®é¢˜ä¸€ï¼š

```java
public static void main(String[] args) {
    String s = new String("a") + new String("b");//new String("ab")
    //åœ¨ä¸Šä¸€è¡Œä»£ç æ‰§è¡Œå®Œä»¥åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å¹¶æ²¡æœ‰"ab"

    String s2 = s.intern();
    //jdk6ï¼šä¸²æ± ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²"ab"
    //jdk8ï¼šä¸²æ± ä¸­æ²¡æœ‰åˆ›å»ºå­—ç¬¦ä¸²"ab",è€Œæ˜¯åˆ›å»ºä¸€ä¸ªå¼•ç”¨æŒ‡å‘new String("ab")ï¼Œå°†æ­¤å¼•ç”¨è¿”å›

    System.out.println(s2 == "ab");//jdk6:true  jdk8:true
    System.out.println(s == "ab");//jdk6:false  jdk8:true
}
```

é—®é¢˜äºŒï¼š

```java
public static void main(String[] args) {
    String str1 = new StringBuilder("58").append("tongcheng").toString();
    System.out.println(str1 == str1.intern());//true

    String str2 = new StringBuilder("ja").append("va").toString();
    System.out.println(str2 == str2.intern());//false
}
```

åŸå› ï¼š

* System ç±»å½“è°ƒç”¨ Version çš„é™æ€æ–¹æ³•ï¼Œå¯¼è‡´ Version åˆå§‹åŒ–ï¼š

  ```java
  private static void initializeSystemClass() {
      sun.misc.Version.init();
  }
  ```

* Versionç±»åˆå§‹åŒ–æ—¶éœ€è¦å¯¹é™æ€å¸¸é‡å­—æ®µåˆå§‹åŒ–ï¼Œè¢« launcher_name é™æ€å¸¸é‡å­—æ®µæ‰€å¼•ç”¨çš„"java"å­—ç¬¦ä¸²å­—é¢é‡å°±è¢«æ”¾å…¥çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š

  ```java
  package sun.misc;
  
  public class Version {
      private static final String launcher_name = "java";
      private static final String java_version = "1.8.0_221";
      private static final String java_runtime_name = "Java(TM) SE Runtime Environment";
      private static final String java_profile_name = "";
      private static final String java_runtime_version = "1.8.0_221-b11";
      //...
  }
  ```



***



##### å†…å­˜ä½ç½®

Java 7ä¹‹å‰ï¼ŒString Pool è¢«æ”¾åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œå®ƒå±äºæ°¸ä¹…ä»£ï¼›Java 7ä»¥åï¼ŒString Pool è¢«ç§»åˆ°å †ä¸­ï¼Œè¿™æ˜¯å› ä¸ºæ°¸ä¹…ä»£çš„ç©ºé—´æœ‰é™ï¼Œåœ¨å¤§é‡ä½¿ç”¨å­—ç¬¦ä¸²çš„åœºæ™¯ä¸‹ä¼šå¯¼è‡´OutOfMemoryError é”™è¯¯

æ¼”ç¤º StringTable ä½ç½®ï¼š

* `-Xmx10m`è®¾ç½®å †å†…å­˜10m

* åœ¨jdk8ä¸‹è®¾ç½®ï¼š `-Xmx10m -XX:-UseGCOverheadLimit`ï¼ˆè¿è¡Œå‚æ•°åœ¨Run Configurations VM optionsï¼‰

* åœ¨jdk6ä¸‹è®¾ç½®ï¼š `-XX:MaxPermSize=10m`

  ```java
  public static void main(String[] args) throws InterruptedException {
      List<String> list = new ArrayList<String>();
      int i = 0;
      try {
          for (int j = 0; j < 260000; j++) {
              list.add(String.valueOf(j).intern());
              i++;
          }
      } catch (Throwable e) {
          e.printStackTrace();
      } finally {
          System.out.println(i);
      }
  }
  ```

![](https://gitee.com/seazean/images/raw/master/Java/JVM-å†…å­˜å›¾å¯¹æ¯”.png)



***



#### ä¼˜åŒ–å¸¸é‡æ± 

ä¸¤ç§æ–¹å¼ï¼š

* è°ƒæ•´ -XX:StringTableSize=æ¡¶ä¸ªæ•°ï¼Œæ•°é‡è¶Šå°‘ï¼Œæ€§èƒ½è¶Šå·®

* intern å°†å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥å¸¸é‡æ± ï¼Œé€šè¿‡å¤ç”¨å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œå‡å°‘å†…å­˜å ç”¨

```java
/**
 * æ¼”ç¤º intern å‡å°‘å†…å­˜å ç”¨
 * -XX:StringTableSize=200000 -XX:+PrintStringTableStatistics
 * -Xsx500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000
 */
public class Demo1_25 {
    public static void main(String[] args) throws IOException {
        List<String> address = new ArrayList<>();
        System.in.read();
        for (int i = 0; i < 10; i++) {
            //å¾ˆå¤šæ•°æ®
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream("linux.words"), "utf-8"))) {
                String line = null;
                long start = System.nanoTime();
                while (true) {
                    line = reader.readLine();
                    if(line == null) {
                        break;
                    }
                    address.add(line.intern());
                }
                System.out.println("cost:" +(System.nanoTime()-start)/1000000);
            }
        }
        System.in.read();
    }
}
```



***



#### ä¸å¯å˜å¥½å¤„

* å¯ä»¥ç¼“å­˜ hash å€¼
  å› ä¸º String çš„ hash å€¼ç»å¸¸è¢«ä½¿ç”¨ï¼Œä¾‹å¦‚ String ç”¨åš HashMap çš„ keyã€‚ä¸å¯å˜çš„ç‰¹æ€§å¯ä»¥ä½¿å¾— hash å€¼ä¹Ÿä¸å¯å˜ï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡è®¡ç®—
* String Pool çš„éœ€è¦
  å¦‚æœä¸€ä¸ªStringå¯¹è±¡å·²ç»è¢«åˆ›å»ºè¿‡äº†ï¼Œå°±ä¼šä» String Poolä¸­å–å¾—å¼•ç”¨ã€‚åªæœ‰ Stringæ˜¯ä¸å¯å˜çš„ï¼Œæ‰å¯èƒ½ä½¿ç”¨ String Pool
* å®‰å…¨æ€§
  String ç»å¸¸ä½œä¸ºå‚æ•°ï¼ŒString ä¸å¯å˜æ€§å¯ä»¥ä¿è¯å‚æ•°ä¸å¯å˜ã€‚ä¾‹å¦‚åœ¨ä½œä¸ºç½‘ç»œè¿æ¥å‚æ•°çš„æƒ…å†µä¸‹å¦‚æœ String æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨ç½‘ç»œè¿æ¥è¿‡ç¨‹ä¸­ï¼ŒString è¢«æ”¹å˜ï¼Œæ”¹å˜ String çš„é‚£ä¸€æ–¹ä»¥ä¸ºç°åœ¨è¿æ¥çš„æ˜¯å…¶å®ƒä¸»æœºï¼Œè€Œå®é™…æƒ…å†µå´ä¸ä¸€å®šæ˜¯
* String ä¸å¯å˜æ€§å¤©ç”Ÿå…·å¤‡çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨åœ°ä½¿ç”¨
* é˜²æ­¢å­ç±»ç»§æ‰¿ï¼Œç ´åStringçš„APIçš„ä½¿ç”¨





***



### StringBuilder

String StringBuffer å’Œ StringBuilder åŒºåˆ«ï¼š

* String : **ä¸å¯å˜**çš„å­—ç¬¦åºåˆ—ï¼Œçº¿ç¨‹å®‰å…¨
* StringBuffer : **å¯å˜**çš„å­—ç¬¦åºåˆ—ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œåº•å±‚æ–¹æ³•åŠ  synchronizedï¼Œæ•ˆç‡ä½
* StringBuilder : **å¯å˜**çš„å­—ç¬¦åºåˆ—ï¼ŒJDK5.0æ–°å¢ï¼›çº¿ç¨‹ä¸å®‰å…¨ï¼Œæ•ˆç‡é«˜

ç›¸åŒç‚¹ï¼šåº•å±‚ä½¿ç”¨ char[] å­˜å‚¨

æ„é€ æ–¹æ³•ï¼š

* `public StringBuilder()`ï¼šåˆ›å»ºä¸€ä¸ªç©ºç™½å¯å˜å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸å«æœ‰ä»»ä½•å†…å®¹
* `public StringBuilder(String str)`ï¼šæ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œæ¥åˆ›å»ºå¯å˜å­—ç¬¦ä¸²å¯¹è±¡

å¸¸ç”¨API : 

* `public StringBuilder append(ä»»æ„ç±»å‹)`ï¼šæ·»åŠ æ•°æ®ï¼Œå¹¶è¿”å›å¯¹è±¡æœ¬èº«
* `public StringBuilder reverse()`ï¼šè¿”å›ç›¸åçš„å­—ç¬¦åºåˆ—
* `public String toString()`ï¼šé€šè¿‡ toString() å°±å¯ä»¥å®ç°æŠŠ StringBuilder è½¬æ¢ä¸º String

å­˜å‚¨åŸç†ï¼š

```java
String str = "abc";
char data[] = {'a', 'b', 'c'};
StringBuffer sb1 = new StringBuffer();//new byte[16] 
sb1.append('a'); //value[0] = 'a';
```

append æºç ï¼š

```java
public AbstractStringBuilder append(String str) {
    if (str == null) return appendNull();
    int len = str.length();
    ensureCapacityInternal(count + len);
    str.getChars(0, len, value, count);
    count += len;
    return this;
}
private void ensureCapacityInternal(int minimumCapacity) {
    // åˆ›å»ºè¶…è¿‡æ•°ç»„é•¿åº¦å°±æ–°çš„charæ•°ç»„ï¼ŒæŠŠæ•°æ®æ‹·è´è¿‡å»
    if (minimumCapacity - value.length > 0) {
        //int newCapacity = (value.length << 1) + 2;æ¯æ¬¡æ‰©å®¹2å€+2
        value = Arrays.copyOf(value, newCapacity(minimumCapacity));
    }
}
public void getChars(int srcBegin, int srcEnd, char dst[], int dstBegin) {
    //å°†å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¤åˆ¶åˆ°ç›®æ ‡å­—ç¬¦æ•°ç»„ä¸­
	// å­—ç¬¦ä¸²è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ­¤æ—¶valueæ˜¯å­—ç¬¦ä¸²çš„å€¼ï¼Œdstæ˜¯ç›®æ ‡å­—ç¬¦æ•°ç»„
    System.arraycopy(value, srcBegin, dst, dstBegin, srcEnd - srcBegin);
}
```





****



### Arrays

Array çš„å·¥å…·ç±»

å¸¸ç”¨APIï¼š

* `public static String toString(int[] a)` : è¿”å›æŒ‡å®šæ•°ç»„çš„å†…å®¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼
* `public static void sort(int[] a)` : æŒ‰ç…§æ•°å­—é¡ºåºæ’åˆ—æŒ‡å®šçš„æ•°ç»„
* `public static int binarySearch(int[] a, int key)` : åˆ©ç”¨äºŒåˆ†æŸ¥æ‰¾è¿”å›æŒ‡å®šå…ƒç´ çš„ç´¢å¼•
* `public static <T> List<T> asList(T... a)` : è¿”å›ç”±æŒ‡å®šæ•°ç»„æ”¯æŒçš„åˆ—è¡¨ã€‚

```java
public class MyArraysDemo {
      public static void main(String[] args) {
		//æŒ‰ç…§æ•°å­—é¡ºåºæ’åˆ—æŒ‡å®šçš„æ•°ç»„
        int [] arr = {3,2,4,6,7};
        Arrays.sort(arr);
        System.out.println(Arrays.toString(arr));
		
        int [] arr = {1,2,3,4,5,6,7,8,9,10};
        int index = Arrays.binarySearch(arr, 0);
        System.out.println(index);
        //1,æ•°ç»„å¿…é¡»æœ‰åº
        //2.å¦‚æœè¦æŸ¥æ‰¾çš„å…ƒç´ å­˜åœ¨,é‚£ä¹ˆè¿”å›çš„æ˜¯è¿™ä¸ªå…ƒç´ å®é™…çš„ç´¢å¼•
        //3.å¦‚æœè¦æŸ¥æ‰¾çš„å…ƒç´ ä¸å­˜åœ¨,é‚£ä¹ˆè¿”å›çš„æ˜¯ (-æ’å…¥ç‚¹-1)
            //æ’å…¥ç‚¹:å¦‚æœè¿™ä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­,ä»–åº”è¯¥åœ¨å“ªä¸ªç´¢å¼•ä¸Š.
      }
  }
```





***



### Random

ç”¨äºç”Ÿæˆä¼ªéšæœºæ•°ã€‚

ä½¿ç”¨æ­¥éª¤ï¼š
1. å¯¼å…¥åŒ…ï¼š`import java.util.Random;`
2. åˆ›å»ºå¯¹è±¡ï¼š`Random r = new Random();`
3. éšæœºæ•´æ•°ï¼š`int num = r.nextInt(10);`
è§£é‡Šï¼š10ä»£è¡¨çš„æ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œå¦‚æœæ‹¬å·å†™10ï¼Œäº§ç”Ÿçš„éšæœºæ•°å°±æ˜¯0-9ï¼Œæ‹¬å·å†™20çš„éšæœºæ•°åˆ™æ˜¯0-19
è·å–0-10ï¼š`int num = r.nextInt(10) + 1`

4. éšæœºå°æ•°ï¼š`public double nextDouble()`ä»èŒƒå›´`0.0d`(å«)è‡³`1.0d` (ä¸åŒ…æ‹¬)ï¼Œä¼ªéšæœºåœ°ç”Ÿæˆå¹¶è¿”å›



***



### Date

æ„é€ å™¨ï¼š

* `public Date()`ï¼šåˆ›å»ºå½“å‰ç³»ç»Ÿçš„æ­¤åˆ»æ—¥æœŸæ—¶é—´å¯¹è±¡ã€‚
*  `public Date(long time)`ï¼šæŠŠæ—¶é—´æ¯«ç§’å€¼è½¬æ¢æˆæ—¥æœŸå¯¹è±¡

æ–¹æ³•ï¼š

* `public long getTime()`ï¼šè¿”å›è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ 00:00:00 GMT ä»¥æ¥æ€»çš„æ¯«ç§’æ•°ã€‚

æ—¶é—´è®°å½•çš„ä¸¤ç§æ–¹å¼ï¼š

1. Dateæ—¥æœŸå¯¹è±¡
2. æ—¶é—´æ¯«ç§’å€¼ï¼šä»1970-01-01 00:00:00å¼€å§‹èµ°åˆ°æ­¤åˆ»çš„æ€»çš„æ¯«ç§’å€¼ã€‚ 1s = 1000ms

```java
public class DateDemo {
    public static void main(String[] args) {
        Date d = new Date();
        System.out.println(d);//Fri Oct 16 21:58:44 CST 2020
        long time = d.getTime() + 121*1000;//è¿‡121sæ˜¯ä»€ä¹ˆæ—¶é—´
        System.out.println(time);//1602856875485
        
        Date d1 = new Date(time);
        System.out.println(d1);//Fri Oct 16 22:01:15 CST 2020
    }
}
```

```java
public static void main(String[] args){
    Date d = new Date();
    long startTime = d.getTime();
    for(int i = 0; i < 10000; i++){è¾“å‡ºi}
    long endTime = new Date().getTime();
    System.out.println( (endTime - startTime) / 1000.0 +"s");
    //è¿è¡Œä¸€ä¸‡æ¬¡è¾“å‡ºéœ€è¦å¤šé•¿æ—¶é—´
}
```



***



### DateFormat

DateFormat ä½œç”¨ï¼š

1. å¯ä»¥æŠŠâ€œæ—¥æœŸå¯¹è±¡â€æˆ–è€…â€œæ—¶é—´æ¯«ç§’å€¼â€æ ¼å¼åŒ–æˆæˆ‘ä»¬å–œæ¬¢çš„æ—¶é—´å½¢å¼ï¼ˆæ ¼å¼åŒ–æ—¶é—´ï¼‰
2. å¯ä»¥æŠŠå­—ç¬¦ä¸²çš„æ—¶é—´å½¢å¼è§£ææˆæ—¥æœŸå¯¹è±¡ï¼ˆè§£æå­—ç¬¦ä¸²æ—¶é—´ï¼‰

DateFormat æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä½¿ç”¨å®ƒçš„å­ç±»ï¼šSimpleDateFormat

SimpleDateFormat  ç®€å•æ—¥æœŸæ ¼å¼åŒ–ç±»ï¼š

* `public SimpleDateFormat(String pattern)` : æŒ‡å®šæ—¶é—´çš„æ ¼å¼åˆ›å»ºç®€å•æ—¥æœŸå¯¹è±¡
* `public String format(Date date) ` : æŠŠæ—¥æœŸå¯¹è±¡æ ¼å¼åŒ–æˆæˆ‘ä»¬å–œæ¬¢çš„æ—¶é—´å½¢å¼ï¼Œè¿”å›å­—ç¬¦ä¸²
* `public String format(Object time)` : æŠŠæ—¶é—´æ¯«ç§’å€¼æ ¼å¼åŒ–æˆè®¾å®šçš„æ—¶é—´å½¢å¼ï¼Œè¿”å›å­—ç¬¦ä¸²!
* `public Date parse(String date)` : æŠŠå­—ç¬¦ä¸²çš„æ—¶é—´è§£ææˆæ—¥æœŸå¯¹è±¡

>yyyyå¹´MMæœˆddæ—¥ HH:mm:ss EEE a" å‘¨å‡  ä¸Šåˆä¸‹åˆ

```java
public static void main(String[] args){
	Date date = new Date();
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss);
    String time = sdf.format(date);
    System.out.println(time);//2020-10-18 19:58:34
    //è¿‡121såæ˜¯ä»€ä¹ˆæ—¶é—´
    long time = date.getTime();
    time+=121;
    System.out.println(sdf.formate(time));
    String d = "2020-10-18 20:20:20";//æ ¼å¼ä¸€è‡´
    Date newDate = sdf.parse(d);
    System.out.println(sdf.format(newDate)); //æŒ‰ç…§å‰é¢çš„æ–¹æ³•è¾“å‡º
}
```




****



### Calendar

Calendarä»£è¡¨äº†ç³»ç»Ÿæ­¤åˆ»æ—¥æœŸå¯¹åº”çš„æ—¥å†å¯¹è±¡
Calendaræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½ç›´æ¥åˆ›å»ºå¯¹è±¡
Calendaræ—¥å†ç±»åˆ›å»ºæ—¥å†å¯¹è±¡çš„è¯­æ³•ï¼š
		`Calendar rightNow = Calendar.getInstance()`(**é¥¿æ±‰å•ä¾‹æ¨¡å¼**)
Calendarçš„æ–¹æ³•ï¼š
    	`public static Calendar getInstance()`: è¿”å›ä¸€ä¸ªæ—¥å†ç±»çš„å¯¹è±¡ã€‚
    	`public int get(int field)`ï¼šå–æ—¥æœŸä¸­çš„æŸä¸ªå­—æ®µä¿¡æ¯ã€‚
    	`public void set(int field,int value)`ï¼šä¿®æ”¹æ—¥å†çš„æŸä¸ªå­—æ®µä¿¡æ¯ã€‚
    	`public void add(int field,int amount)`ï¼šä¸ºæŸä¸ªå­—æ®µå¢åŠ /å‡å°‘æŒ‡å®šçš„å€¼
    	`public final Date getTime()`: æ‹¿åˆ°æ­¤åˆ»æ—¥æœŸå¯¹è±¡ã€‚
   	 `public long getTimeInMillis()`: æ‹¿åˆ°æ­¤åˆ»æ—¶é—´æ¯«ç§’å€¼

```java
public static void main(String[] args){
	Calendar rightNow = Calendar.getInsance(); 
	int year = rightNow.get(Calendar.YEAR);//è·å–å¹´
    int month = rightNow.get(Calendar.MONTH) + 1;//æœˆè¦+1
    int days = rightNow.get(Calendar.DAY_OF_YEAR);
    rightNow.set(Calendar.YEAR , 2099);//ä¿®æ”¹æŸä¸ªå­—æ®µ
    rightNow.add(Calendar.HOUR , 15);//åŠ 15å°æ—¶  -15å°±æ˜¯å‡å»15å°æ—¶
    Date date = rightNow.getTime();//æ—¥å†å¯¹è±¡
    long time = rightNow.getTimeInMillis();//æ—¶é—´æ¯«ç§’å€¼
    //700å¤©åæ˜¯ä»€ä¹ˆæ—¥å­
    rightNow.add(Calendar.DAY_OF_YEAR , 701);
    Date date d = rightNow.getTime();
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    System.out.println(sdf.format(d));//è¾“å‡º700å¤©åçš„æ—¥æœŸ
}
```



***



### LocalDateTime

JDK1.8 æ–°å¢ï¼Œçº¿ç¨‹å®‰å…¨

+ LocalDate       è¡¨ç¤ºæ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰  
+ LocalTime       è¡¨ç¤ºæ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼‰
+ LocalDateTime    è¡¨ç¤ºæ—¶é—´+ æ—¥æœŸ ï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼‰

æ„é€ æ–¹æ³•ï¼š

* public static LocalDateTime now()ï¼šè·å–å½“å‰ç³»ç»Ÿæ—¶é—´ 
* public static LocalDateTime of(å¹´, æœˆ , æ—¥, æ—¶, åˆ†, ç§’)ï¼šä½¿ç”¨æŒ‡å®šå¹´æœˆæ—¥å’Œæ—¶åˆ†ç§’åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡

å¸¸ç”¨APIï¼š

| æ–¹æ³•å                                                    | è¯´æ˜                                                        |
| --------------------------------------------------------- | ----------------------------------------------------------- |
| public int getYear()                                      | è·å–å¹´                                                      |
| public int getMonthValue()                                | è·å–æœˆä»½ï¼ˆ1-12ï¼‰                                            |
| public int getDayOfMonth()                                | è·å–æœˆä»½ä¸­çš„ç¬¬å‡ å¤©ï¼ˆ1-31ï¼‰                                  |
| public int getDayOfYear()                                 | è·å–ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼ˆ1-366ï¼‰                                 |
| public DayOfWeek getDayOfWeek()                           | è·å–æ˜ŸæœŸ                                                    |
| public int getMinute()                                    | è·å–åˆ†é’Ÿ                                                    |
| public int getHour()                                      | è·å–å°æ—¶                                                    |
| public LocalDate  toLocalDate()                           | è½¬æ¢æˆä¸ºä¸€ä¸ªLocalDateå¯¹è±¡ï¼ˆå¹´æœˆæ—¥ï¼‰                         |
| public LocalTime toLocalTime()                            | è½¬æ¢æˆä¸ºä¸€ä¸ªLocalTimeå¯¹è±¡ï¼ˆæ—¶åˆ†ç§’ï¼‰                         |
| public String format(æŒ‡å®šæ ¼å¼)                            | æŠŠä¸€ä¸ªLocalDateTimeæ ¼å¼åŒ–æˆä¸ºä¸€ä¸ªå­—ç¬¦ä¸²                     |
| public LocalDateTime parse(å‡†å¤‡è§£æçš„å­—ç¬¦ä¸², è§£ææ ¼å¼)    | æŠŠä¸€ä¸ªæ—¥æœŸå­—ç¬¦ä¸²è§£ææˆä¸ºä¸€ä¸ªLocalDateTimeå¯¹è±¡               |
| public static DateTimeFormatter ofPattern(String pattern) | ä½¿ç”¨æŒ‡å®šçš„æ—¥æœŸæ¨¡æ¿è·å–ä¸€ä¸ªæ—¥æœŸæ ¼å¼åŒ–å™¨DateTimeFormatterå¯¹è±¡ |

```java
public class JDK8DateDemo2 {
    public static void main(String[] args) {
        LocalDateTime now = LocalDateTime.now();
        System.out.println(now);

        LocalDateTime localDateTime = LocalDateTime.of(2020, 11, 11, 11, 11, 11);
        System.out.println(localDateTime);
        DateTimeFormatter pattern = DateTimeFormatter.ofPattern("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss");
        String s = localDateTime.format(pattern);
		LocalDateTime parse = LocalDateTime.parse(s, pattern);
    }
}
```

| æ–¹æ³•å                                              | è¯´æ˜                           |
| --------------------------------------------------- | ------------------------------ |
| public LocalDateTime plusYears (long years)         | æ·»åŠ æˆ–è€…å‡å»å¹´                 |
| public LocalDateTime plusMonths(long months)        | æ·»åŠ æˆ–è€…å‡å»æœˆ                 |
| public LocalDateTime plusDays(long days)            | æ·»åŠ æˆ–è€…å‡å»æ—¥                 |
| public LocalDateTime plusHours(long hours)          | æ·»åŠ æˆ–è€…å‡å»æ—¶                 |
| public LocalDateTime plusMinutes(long minutes)      | æ·»åŠ æˆ–è€…å‡å»åˆ†                 |
| public LocalDateTime plusSeconds(long seconds)      | æ·»åŠ æˆ–è€…å‡å»ç§’                 |
| public LocalDateTime plusWeeks(long weeks)          | æ·»åŠ æˆ–è€…å‡å»å‘¨                 |
| public LocalDateTime  minusYears (long years)       | å‡å»æˆ–è€…æ·»åŠ å¹´                 |
| public LocalDateTime withYear(int year)             | ç›´æ¥ä¿®æ”¹å¹´                     |
| public LocalDateTime withMonth(int month)           | ç›´æ¥ä¿®æ”¹æœˆ                     |
| public LocalDateTime withDayOfMonth(int dayofmonth) | ç›´æ¥ä¿®æ”¹æ—¥æœŸ(ä¸€ä¸ªæœˆä¸­çš„ç¬¬å‡ å¤©) |
| public LocalDateTime withDayOfYear(int dayOfYear)   | ç›´æ¥ä¿®æ”¹æ—¥æœŸ(ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©)   |
| public LocalDateTime withHour(int hour)             | ç›´æ¥ä¿®æ”¹å°æ—¶                   |
| public LocalDateTime withMinute(int minute)         | ç›´æ¥ä¿®æ”¹åˆ†é’Ÿ                   |
| public LocalDateTime withSecond(int second)         | ç›´æ¥ä¿®æ”¹ç§’                     |



**æ—¶é—´é—´éš”** Duration ç±»APIï¼š

| æ–¹æ³•å                                           | è¯´æ˜                 |
| ------------------------------------------------ | -------------------- |
| public static Period between(å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´)  | è®¡ç®—ä¸¤ä¸ªâ€œæ—¶é—´"çš„é—´éš” |
| public int getYears()                            | è·å¾—è¿™æ®µæ—¶é—´çš„å¹´æ•°   |
| public int getMonths()                           | è·å¾—æ­¤æœŸé—´çš„æ€»æœˆæ•°   |
| public int getDays()                             | è·å¾—æ­¤æœŸé—´çš„å¤©æ•°     |
| public long toTotalMonths()                      | è·å–æ­¤æœŸé—´çš„æ€»æœˆæ•°   |
| public static Durationbetween(å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´) | è®¡ç®—ä¸¤ä¸ªâ€œæ—¶é—´"çš„é—´éš” |
| public long toSeconds()                          | è·å¾—æ­¤æ—¶é—´é—´éš”çš„ç§’   |
| public long toMillis()                           | è·å¾—æ­¤æ—¶é—´é—´éš”çš„æ¯«ç§’ |
| public long toNanos()                            | è·å¾—æ­¤æ—¶é—´é—´éš”çš„çº³ç§’ |

```java
public class JDK8DateDemo9 {
    public static void main(String[] args) {
        LocalDate localDate1 = LocalDate.of(2020, 1, 1);
        LocalDate localDate2 = LocalDate.of(2048, 12, 12);
        Period period = Period.between(localDate1, localDate2);
        System.out.println(period);//P28Y11M11D
		Duration duration = Duration.between(localDateTime1, localDateTime2);
        System.out.println(duration);//PT21H57M58S
    }
}
```



***



### Math

Math ç”¨äºåšæ•°å­¦è¿ç®—
Math ç±»ä¸­çš„æ–¹æ³•å…¨éƒ¨æ˜¯é™æ€æ–¹æ³•ï¼Œç›´æ¥ç”¨ç±»åè°ƒç”¨å³å¯
æ–¹æ³•ï¼š

| æ–¹æ³•                                         | è¯´æ˜                              |
| -------------------------------------------- | --------------------------------- |
| public static int abs(int a)                 | è·å–å‚æ•°açš„ç»å¯¹å€¼                 |
| public static double ceil(double a)          | å‘ä¸Šå–æ•´                          |
| public static double floor(double a)         | å‘ä¸‹å–æ•´                          |
| public static double pow(double a, double b) | è·å– a çš„ b æ¬¡å¹‚                  |
| public static long round(double a)           | å››èˆäº”å…¥å–æ•´                      |
| public static int max(int a,int b)           | è¿”å›è¾ƒå¤§å€¼                        |
| public static int min(int a,int b)           | è¿”å›è¾ƒå°å€¼                        |
| public static double random()                | è¿”å›å€¼ä¸º double çš„æ­£å€¼ï¼Œ[0.0,1.0) |

```java
public class MathDemo {
    public static void main(String[] args) {
        // 1.å–ç»å¯¹å€¼:è¿”å›æ­£æ•°ã€‚
        System.out.println(Math.abs(10));
        System.out.println(Math.abs(-10.3));
        // 2.å‘ä¸Šå–æ•´: 5
        System.out.println(Math.ceil(4.00000001)); // 5.0
        System.out.println(Math.ceil(-4.00000001));//4.0
        // 3.å‘ä¸‹å–æ•´ï¼š4
        System.out.println(Math.floor(4.99999999)); // 4.0
        System.out.println(Math.floor(-4.99999999)); // 5.0
        // 4.æ±‚æŒ‡æ•°æ¬¡æ–¹
        System.out.println(Math.pow(2 , 3)); // 2^3 = 8.0
        // 5.å››èˆäº”å…¥ 10
        System.out.println(Math.round(4.49999)); // 4
        System.out.println(Math.round(4.500001)); // 5
        System.out.println(Math.round(5.5));//6
    }
}
```



### DecimalFormat

ä½¿ä»»ä½•å½¢å¼çš„æ•°å­—è§£æå’Œæ ¼å¼åŒ–

```java
public static void main(String[]args){
    double pi = 3.1415927;ã€€//åœ†å‘¨ç‡
    //å–ä¸€ä½æ•´æ•°
    System.out.println(new DecimalFormat("0").format(pi));ã€€ã€€ã€€//3
    //å–ä¸€ä½æ•´æ•°å’Œä¸¤ä½å°æ•°
    System.out.println(new DecimalFormat("0.00").format(pi));ã€€//3.14
    //å–ä¸¤ä½æ•´æ•°å’Œä¸‰ä½å°æ•°ï¼Œæ•´æ•°ä¸è¶³éƒ¨åˆ†ä»¥0å¡«è¡¥ã€‚
    System.out.println(new DecimalFormat("00.000").format(pi));// 03.142
    //å–æ‰€æœ‰æ•´æ•°éƒ¨åˆ†
    System.out.println(new DecimalFormat("#").format(pi));ã€€ã€€ã€€//3
    //ä»¥ç™¾åˆ†æ¯”æ–¹å¼è®¡æ•°ï¼Œå¹¶å–ä¸¤ä½å°æ•°
    System.out.println(new DecimalFormat("#.##%").format(pi));ã€€//314.16%

    long c =299792458;ã€€ã€€//å…‰é€Ÿ
    //æ˜¾ç¤ºä¸ºç§‘å­¦è®¡æ•°æ³•ï¼Œå¹¶å–äº”ä½å°æ•°
    System.out.println(new DecimalFormat("#.#####E0").format(c));//2.99792E8
    //æ˜¾ç¤ºä¸ºä¸¤ä½æ•´æ•°çš„ç§‘å­¦è®¡æ•°æ³•ï¼Œå¹¶å–å››ä½å°æ•°
    System.out.println(new DecimalFormat("00.####E0").format(c));//29.9792E7
    //æ¯ä¸‰ä½ä»¥é€—å·è¿›è¡Œåˆ†éš”ã€‚
    System.out.println(new DecimalFormat(",###").format(c));//299,792,458
    //å°†æ ¼å¼åµŒå…¥æ–‡æœ¬
    System.out.println(new DecimalFormat("å…‰é€Ÿå¤§å°ä¸ºæ¯ç§’,###ç±³ã€‚").format(c));

}
```



***



### System

Systemä»£è¡¨å½“å‰ç³»ç»Ÿã€‚

é™æ€æ–¹æ³•ï¼š

1. `public static void exit(int status)` : ç»ˆæ­¢JVMè™šæ‹Ÿæœºï¼Œé0æ˜¯å¼‚å¸¸ç»ˆæ­¢
2. `public static long currentTimeMillis()` : è·å–å½“å‰ç³»ç»Ÿæ­¤åˆ»æ—¶é—´æ¯«ç§’å€¼
3. `static void arraycopy(Object var0, int var1, Object var2, int var3, int var4)` : æ•°ç»„æ‹·è´
   å‚æ•°ä¸€ï¼šåŸæ•°ç»„
   å‚æ•°äºŒï¼šä»åŸæ•°ç»„çš„å“ªä¸ªä½ç½®å¼€å§‹èµ‹å€¼ã€‚
   å‚æ•°ä¸‰ï¼šç›®æ ‡æ•°ç»„
   å‚æ•°å››ï¼šä»ç›®æ ‡æ•°ç»„çš„å“ªä¸ªä½ç½®å¼€å§‹èµ‹å€¼
   å‚æ•°äº”ï¼šèµ‹å€¼å‡ ä¸ªã€‚

```java
public class SystemDemo {
    public static void main(String[] args) {
        //System.exit(0); // 0ä»£è¡¨æ­£å¸¸ç»ˆæ­¢!!
        long startTime = System.currentTimeMillis();//å®šä¹‰sdf æŒ‰ç…§æ ¼å¼è¾“å‡º
        for(int i = 0; i < 10000; i++){è¾“å‡ºi}
		long endTime = new Date().getTime();
		System.out.println( (endTime - startTime)/1000.0 +"s");//ç¨‹åºç”¨æ—¶

        int[] arr1 = new int[]{10 ,20 ,30 ,40 ,50 ,60 ,70};
        int[] arr2 = new int[6]; // [ 0 , 0 , 0 , 0 , 0 , 0]
        // å˜æˆarrs2 = [0 , 30 , 40 , 50 , 0 , 0 ]
        System.arraycopy(arr1, 2, arr2, 1, 3);
    }
}
```



***



### BigDecimal

Java åœ¨ java.math åŒ…ä¸­æä¾›çš„ API ç±»ï¼Œç”¨æ¥å¯¹è¶…è¿‡16ä½æœ‰æ•ˆä½çš„æ•°è¿›è¡Œç²¾ç¡®çš„è¿ç®—

æ„é€ æ–¹æ³•ï¼š
	`public static BigDecimal valueOf(double val)` : åŒ…è£…æµ®ç‚¹æ•°æˆä¸ºå¤§æ•°æ®å¯¹è±¡ã€‚
	`public BigDecimal(double val)` : 
	`public BigDecimal(String val)` : 

å¸¸ç”¨APIï¼š
	`public BigDecimal add(BigDecimal value)` : åŠ æ³•è¿ç®—
	`public BigDecimal subtract(BigDecimal value)` : å‡æ³•è¿ç®— 
	`public BigDecimal multiply(BigDecimal value)` : ä¹˜æ³•è¿ç®— 
	`public BigDecimal divide(BigDecimal value)` : é™¤æ³•è¿ç®—
	`public double doubleValue()` : æŠŠBigDecimalè½¬æ¢æˆdoubleç±»å‹ã€‚
	`public int intValue()` : è½¬ä¸ºint  å…¶ä»–ç±»å‹ç›¸åŒ
	`public BigDecimal divide (BigDecimal valueï¼Œç²¾ç¡®å‡ ä½ï¼Œèˆå…¥æ¨¡å¼)` : é™¤æ³•

```java
public class BigDecimalDemo {
    public static void main(String[] args) {
        // æµ®ç‚¹å‹è¿ç®—çš„æ—¶å€™ç›´æ¥+ - * / å¯èƒ½ä¼šå‡ºç°æ•°æ®å¤±çœŸï¼ˆç²¾åº¦é—®é¢˜ï¼‰ã€‚
        System.out.println(0.1 + 0.2);
        System.out.println(1.301 / 100);
        
        double a = 0.1 ;
        double b = 0.2 ;
        double c = a + b ;
        System.out.println(c);//0.30000000000000004
        
        // 1.æŠŠæµ®ç‚¹æ•°è½¬æ¢æˆå¤§æ•°æ®å¯¹è±¡è¿ç®—
        BigDecimal a1 = BigDecimal.valueOf(a);
        BigDecimal b1 = BigDecimal.valueOf(b);
        BigDecimal c1 = a1.add(b1);//a1.divide(b1);ä¹Ÿå¯ä»¥
		System.out.println(c1);

        // BigDecimalåªæ˜¯è§£å†³ç²¾åº¦é—®é¢˜çš„æ‰‹æ®µï¼Œdoubleæ•°æ®æ‰æ˜¯æˆ‘ä»¬çš„ç›®çš„ï¼ï¼
        double d = c1.doubleValue();
    }
}
```

æ€»ç»“

1. BigDecimal æ˜¯ç”¨æ¥è¿›è¡Œç²¾ç¡®è®¡ç®—çš„
2. åˆ›å»º BigDecimal çš„å¯¹è±¡ï¼Œæ„é€ æ–¹æ³•ä½¿ç”¨å‚æ•°ç±»å‹ä¸ºå­—ç¬¦ä¸²çš„ã€‚
3. å››åˆ™è¿ç®—ä¸­çš„é™¤æ³•ï¼Œå¦‚æœé™¤ä¸å°½è¯·ä½¿ç”¨ divide çš„ä¸‰ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚

```java
BigDecimal divide = bd1.divide(å‚ä¸è¿ç®—çš„å¯¹è±¡,å°æ•°ç‚¹åç²¾ç¡®åˆ°å¤šå°‘ä½,èˆå…¥æ¨¡å¼);
å‚æ•°1ï¼šè¡¨ç¤ºå‚ä¸è¿ç®—çš„BigDecimal å¯¹è±¡ã€‚
å‚æ•°2ï¼šè¡¨ç¤ºå°æ•°ç‚¹åé¢ç²¾ç¡®åˆ°å¤šå°‘ä½
å‚æ•°3ï¼šèˆå…¥æ¨¡å¼  
  BigDecimal.ROUND_UP  è¿›ä¸€æ³•
  BigDecimal.ROUND_FLOOR å»å°¾æ³•
  BigDecimal.ROUND_HALF_UP å››èˆäº”å…¥
```



***



### Regex

#### æ¦‚è¿°

æ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨ï¼šæ˜¯ä¸€äº›ç‰¹æ®Šå­—ç¬¦ç»„æˆçš„æ ¡éªŒè§„åˆ™ï¼Œå¯ä»¥æ ¡éªŒä¿¡æ¯çš„æ­£ç¡®æ€§ï¼Œæ ¡éªŒé‚®ç®±ã€ç”µè¯å·ç ã€é‡‘é¢ç­‰ã€‚

æ¯”å¦‚æ£€éªŒqqå·ï¼š

```java
public static boolean checkQQRegex(String qq){
    return qq!=null && qq.matches("\\d{4,}");//å³æ˜¯æ•°å­— å¿…é¡»å¤§äº4ä½æ•°
}// ç”¨\\d  æ˜¯å› ä¸º\ç”¨æ¥å‘Šè¯‰å®ƒæ˜¯ä¸€ä¸ªæ ¡éªŒç±»ï¼Œä¸æ˜¯æ™®é€šçš„å­—ç¬¦ æ¯”å¦‚ \t \n
```

java.util.regex åŒ…ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªç±»ï¼š

- Pattern ç±»ï¼š

  pattern å¯¹è±¡æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ç¼–è¯‘è¡¨ç¤ºã€‚Pattern ç±»æ²¡æœ‰å…¬å…±æ„é€ æ–¹æ³•ï¼Œè¦åˆ›å»ºä¸€ä¸ª Pattern å¯¹è±¡ï¼Œå¿…é¡»é¦–å…ˆè°ƒç”¨å…¶å…¬å…±é™æ€ç¼–è¯‘æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª Pattern å¯¹è±¡ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä½œä¸ºå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°

- Matcher ç±»ï¼š

  Matcher å¯¹è±¡æ˜¯å¯¹è¾“å…¥å­—ç¬¦ä¸²è¿›è¡Œè§£é‡Šå’ŒåŒ¹é…æ“ä½œçš„å¼•æ“ã€‚ä¸Pattern ç±»ä¸€æ ·ï¼ŒMatcher ä¹Ÿæ²¡æœ‰å…¬å…±æ„é€ æ–¹æ³•ï¼Œéœ€è¦è°ƒç”¨ Pattern å¯¹è±¡çš„ matcher æ–¹æ³•æ¥è·å¾—ä¸€ä¸ª Matcher å¯¹è±¡

- PatternSyntaxExceptionï¼š

  PatternSyntaxException æ˜¯ä¸€ä¸ªéå¼ºåˆ¶å¼‚å¸¸ç±»ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ä¸­çš„è¯­æ³•é”™è¯¯ã€‚



***



#### å­—ç¬¦åŒ¹é…

##### æ™®é€šå­—ç¬¦

å­—æ¯ã€æ•°å­—ã€æ±‰å­—ã€ä¸‹åˆ’çº¿ã€ä»¥åŠæ²¡æœ‰ç‰¹æ®Šå®šä¹‰çš„æ ‡ç‚¹ç¬¦å·ï¼Œéƒ½æ˜¯â€œæ™®é€šå­—ç¬¦â€ã€‚è¡¨è¾¾å¼ä¸­çš„æ™®é€šå­—ç¬¦ï¼Œåœ¨åŒ¹é…ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ï¼ŒåŒ¹é…ä¸ä¹‹ç›¸åŒçš„ä¸€ä¸ªå­—ç¬¦ã€‚å…¶ä»–ç»Ÿç§°**å…ƒå­—ç¬¦**



##### ç‰¹æ®Šå­—ç¬¦

\r\n æ˜¯Windowsä¸­çš„æ–‡æœ¬è¡Œç»“æŸæ ‡ç­¾ï¼Œåœ¨Unix/Linuxåˆ™æ˜¯ \n

| å…ƒå­—ç¬¦ | è¯´æ˜                                                         |
| ------ | ------------------------------------------------------------ |
| \      | å°†ä¸‹ä¸€ä¸ªå­—ç¬¦æ ‡è®°ä¸ºä¸€ä¸ªç‰¹æ®Šå­—ç¬¦æˆ–åŸä¹‰å­—ç¬¦ï¼Œå‘Šè¯‰å®ƒæ˜¯ä¸€ä¸ªæ ¡éªŒç±»ï¼Œä¸æ˜¯æ™®é€šå­—ç¬¦ |
| \f     | æ¢é¡µç¬¦                                                       |
| \n     | æ¢è¡Œç¬¦                                                       |
| \r     | å›è½¦ç¬¦                                                       |
| \t     | åˆ¶è¡¨ç¬¦                                                       |
| \\     | ä»£è¡¨\æœ¬èº«                                                    |
| ()     | ä½¿ç”¨( )å®šä¹‰ä¸€ä¸ªå­è¡¨è¾¾å¼ã€‚å­è¡¨è¾¾å¼çš„å†…å®¹å¯ä»¥å½“æˆä¸€ä¸ªç‹¬ç«‹å…ƒç´   |



##### æ ‡å‡†å­—ç¬¦

æ ‡å‡†å­—ç¬¦é›†åˆ
èƒ½å¤Ÿä¸â€å¤šç§å­—ç¬¦â€œåŒ¹é…çš„è¡¨è¾¾å¼ã€‚æ³¨æ„åŒºåˆ†å¤§å°å†™ï¼Œå¤§å†™æ˜¯ç›¸åçš„æ„æ€ã€‚åªèƒ½æ ¡éªŒ**"å•"**ä¸ªå­—ç¬¦ã€‚

| å…ƒå­—ç¬¦ | è¯´æ˜                                                         |
| ------ | ------------------------------------------------------------ |
| .      | åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦(é™¤äº†æ¢è¡Œç¬¦)ï¼Œå¦‚æœè¦åŒ¹é…åŒ…æ‹¬â€œ\nâ€åœ¨å†…çš„æ‰€æœ‰å­—ç¬¦ï¼Œä¸€èˆ¬ç”¨[\s\S] |
| \d     | æ•°å­—å­—ç¬¦ï¼Œ0~9 ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œç­‰ä»·äº [0-9]                     |
| \D     | éæ•°å­—å­—ç¬¦ï¼Œç­‰ä»·äº  [ ^0-9]                                  |
| \w     | å¤§å°å†™å­—æ¯æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿ï¼Œç­‰ä»·äº[a-zA-Z_0-9_]                |
| \W     | å¯¹\wå–éï¼Œç­‰ä»·äº[ ^\w]                                       |
| \s     | ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ç©ºç™½å­—ç¬¦çš„å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼Œç­‰ä»·äº[\f\n\r\t\v] |
| \S     | å¯¹ \s å–é                                                   |

\x åŒ¹é…åå…­è¿›åˆ¶å­—ç¬¦ï¼Œ\0 åŒ¹é…å…«è¿›åˆ¶ï¼Œä¾‹å¦‚ \xA å¯¹åº”å€¼ä¸º 10 çš„ ASCII å­—ç¬¦ ï¼Œå³ \n



##### è‡ªå®šä¹‰ç¬¦

è‡ªå®šä¹‰ç¬¦å·é›†åˆï¼Œ[ ]æ–¹æ‹¬å·åŒ¹é…æ–¹å¼ï¼Œèƒ½å¤ŸåŒ¹é…æ–¹æ‹¬å·ä¸­**ä»»æ„ä¸€ä¸ª**å­—ç¬¦

| å…ƒå­—ç¬¦       | è¯´æ˜                                      |
| ------------ | ----------------------------------------- |
| [ab5@]       | åŒ¹é… "a" æˆ– "b" æˆ– "5" æˆ– "@"             |
| [^abc]       | åŒ¹é… "a","b","c" ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦       |
| [f-k]        | åŒ¹é… "f"~"k" ä¹‹é—´çš„ä»»æ„ä¸€ä¸ªå­—æ¯           |
| [^A-F0-3]    | åŒ¹é… "A","F","0"~"3" ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦   |
| [a-d[m-p]]   | åŒ¹é… a åˆ° d æˆ–è€… m åˆ° pï¼š[a-dm-p]ï¼ˆå¹¶é›†ï¼‰ |
| [a-z&&[m-p]] | åŒ¹é… a åˆ° z å¹¶ä¸” m åˆ° pï¼š[a-dm-p]ï¼ˆäº¤é›†ï¼‰ |
| [^]          | å–å                                      |

* æ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šç¬¦å·ï¼Œè¢«åŒ…å«åˆ°ä¸­æ‹¬å·ä¸­ï¼Œåˆ™å¤±å»ç‰¹æ®Šæ„ä¹‰ï¼Œé™¤äº†^,-ä¹‹å¤–ï¼Œéœ€è¦åœ¨å‰é¢åŠ  \

* æ ‡å‡†å­—ç¬¦é›†åˆï¼Œé™¤å°æ•°ç‚¹å¤–ï¼Œå¦‚æœè¢«åŒ…å«äºä¸­æ‹¬å·ï¼Œè‡ªå®šä¹‰å­—ç¬¦é›†åˆå°†åŒ…å«è¯¥é›†åˆã€‚
  æ¯”å¦‚ï¼š[\d. \ -+]å°†åŒ¹é…ï¼šæ•°å­—ã€å°æ•°ç‚¹ã€+ã€-



##### é‡è¯å­—ç¬¦

ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·ã€‚

* åŒ¹é…æ¬¡æ•°ä¸­çš„è´ªå©ªæ¨¡å¼(åŒ¹é…å­—ç¬¦è¶Šå¤šè¶Šå¥½ï¼Œé»˜è®¤ï¼)ï¼Œ\* å’Œ + éƒ½æ˜¯è´ªå©ªå‹å…ƒå­—ç¬¦ã€‚
* åŒ¹é…æ¬¡æ•°ä¸­çš„éè´ªå©ªæ¨¡å¼ï¼ˆåŒ¹é…å­—ç¬¦è¶Šå°‘è¶Šå¥½ï¼Œä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·åå†åŠ ä¸Šä¸€ä¸ª "?" å·ï¼‰

| å…ƒå­—ç¬¦ | è¯´æ˜                             |
| ------ | -------------------------------- |
| X?     | Xä¸€æ¬¡æˆ–ä¸€æ¬¡ä¹Ÿæ²¡ï¼Œæœ‰ç›¸å½“äº {0,1}  |
| X*     | Xä¸å‡ºç°æˆ–å‡ºç°ä»»æ„æ¬¡ï¼Œç›¸å½“äº {0,} |
| X+     | Xè‡³å°‘ä¸€æ¬¡ï¼Œç›¸å½“äº {1,}           |
| X{n}   | Xæ°å¥½ n æ¬¡                       |
| {n,}   | Xè‡³å°‘ n æ¬¡                       |
| {n,m}  | Xè‡³å°‘ n æ¬¡ï¼Œä½†æ˜¯ä¸è¶…è¿‡ m æ¬¡      |



***



#### ä½ç½®åŒ¹é…

##### å­—ç¬¦è¾¹ç•Œ

æœ¬ç»„æ ‡è®°åŒ¹é…çš„ä¸æ˜¯å­—ç¬¦è€Œæ˜¯ä½ç½®ï¼Œç¬¦åˆæŸç§æ¡ä»¶çš„ä½ç½®

| å…ƒå­—ç¬¦ | è¯´æ˜                                                         |
| ------ | ------------------------------------------------------------ |
| ^      | ä¸å­—ç¬¦ä¸²å¼€å§‹çš„åœ°æ–¹åŒ¹é…ï¼ˆåœ¨å­—ç¬¦é›†åˆä¸­ç”¨æ¥æ±‚éï¼Œåœ¨å­—ç¬¦é›†åˆå¤–ç”¨ä½œåŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ï¼‰ |
| $      | ä¸å­—ç¬¦ä¸²ç»“æŸçš„åœ°æ–¹åŒ¹é…                                       |
| \b     | åŒ¹é…ä¸€ä¸ªå•è¯è¾¹ç•Œ                                             |



##### æ•è·ç»„

æ•è·ç»„æ˜¯æŠŠå¤šä¸ªå­—ç¬¦å½“ä¸€ä¸ªå•ç‹¬å•å…ƒè¿›è¡Œå¤„ç†çš„æ–¹æ³•ï¼Œå®ƒé€šè¿‡å¯¹æ‹¬å·å†…çš„å­—ç¬¦åˆ†ç»„æ¥åˆ›å»ºã€‚

åœ¨è¡¨è¾¾å¼`((A)(B(C)))`ï¼Œæœ‰å››ä¸ªè¿™æ ·çš„ç»„ï¼š((A)(B(C)))ã€(A)ã€(B(C))ã€(C)ï¼ˆæŒ‰ç…§æ‹¬å·ä»å·¦åˆ°å³ä¾æ¬¡ä¸º group(1)...ï¼‰

* è°ƒç”¨ matcher å¯¹è±¡çš„ groupCount æ–¹æ³•è¿”å›ä¸€ä¸ª int å€¼ï¼Œè¡¨ç¤º matcher å¯¹è±¡å½“å‰æœ‰å¤šä¸ªæ•è·ç»„ã€‚
* ç‰¹æ®Šçš„ç»„group(0)ã€group()ï¼Œå®ƒä»£è¡¨æ•´ä¸ªè¡¨è¾¾å¼ï¼Œè¯¥ç»„ä¸åŒ…æ‹¬åœ¨ groupCount çš„è¿”å›å€¼ä¸­ã€‚ 

| è¡¨è¾¾å¼                    | è¯´æ˜                                                         |
| ------------------------- | ------------------------------------------------------------ |
| \|  (åˆ†æ”¯ç»“æ„)            | å·¦å³ä¸¤è¾¹è¡¨è¾¾å¼ä¹‹é—´ "æˆ–" å…³ç³»ï¼ŒåŒ¹é…å·¦è¾¹æˆ–è€…å³è¾¹               |
| ()  (æ•è·ç»„)              | (1) åœ¨è¢«ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼å¯ä»¥ä½œä¸ºæ•´ä½“è¢«ä¿®é¥°<br/>(2) å–åŒ¹é…ç»“æœçš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼åŒ¹é…åˆ°çš„å†…å®¹å¯ä»¥è¢«å•ç‹¬å¾—åˆ°<br/>(3) æ¯ä¸€å¯¹æ‹¬å·åˆ†é…ä¸€ä¸ªç¼–å·,()çš„æ•è·æ ¹æ®å·¦æ‹¬å·çš„é¡ºåºä»1å¼€å§‹è‡ªåŠ¨ç¼–å·ã€‚æ•è·å…ƒç´ ç¼–å·ä¸ºé›¶çš„ç¬¬ä¸€ä¸ªæ•è·æ˜¯ç”±æ•´ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…çš„æ–‡æœ¬ |
| (?:Expression)   éæ•è·ç»„ | ä¸€äº›è¡¨è¾¾å¼ä¸­ï¼Œä¸å¾—ä¸ä½¿ç”¨( )ï¼Œä½†åˆä¸éœ€è¦ä¿å­˜( )ä¸­å­è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹ï¼Œè¿™æ—¶å¯ä»¥ç”¨éæ•è·ç»„æ¥æŠµæ¶ˆä½¿ç”¨( )å¸¦æ¥çš„å‰¯ä½œç”¨ã€‚ |





##### åå‘å¼•ç”¨

åå‘å¼•ç”¨ï¼ˆ\numberï¼‰ï¼Œåˆå«å›æº¯å¼•ç”¨ï¼š

* æ¯ä¸€å¯¹()ä¼šåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œä½¿ç”¨ () çš„æ•è·æ ¹æ®å·¦æ‹¬å·çš„é¡ºåºä»1å¼€å§‹è‡ªåŠ¨ç¼–å·

* é€šè¿‡åå‘å¼•ç”¨ï¼Œå¯ä»¥å¯¹åˆ†ç»„å·²æ•è·çš„å­—ç¬¦ä¸²è¿›è¡Œå¼•ç”¨ï¼Œç»§ç»­åŒ¹é…

* **æŠŠåŒ¹é…åˆ°çš„å­—ç¬¦é‡å¤ä¸€éåœ¨è¿›è¡ŒåŒ¹é…**

* åº”ç”¨1ï¼š

  ```java
  String regex = "((\d)3)\1[0-9](\w)\2{2}";
  ```

  * é¦–å…ˆåŒ¹é…((\d)3)ï¼Œå…¶æ¬¡\1åŒ¹é…((\d)3)å·²ç»åŒ¹é…åˆ°çš„å†…å®¹ï¼Œ\2åŒ¹é…ï¼ˆ\dï¼‰ï¼Œ {2}æŒ‡çš„æ˜¯\2çš„å€¼å‡ºç°ä¸¤æ¬¡
  * å®ä¾‹ï¼š23238n22ï¼ˆåŒ¹é…åˆ°2æœªæ¥å°±ç»§ç»­åŒ¹é…2ï¼‰
  * å®ä¾‹ï¼š43438n44

* åº”ç”¨2ï¼šçˆ¬è™«

  ```java
  String regex = "<(h[1-6])>\w*?<\/\1>";
  ```

  åŒ¹é…ç»“æœ

  ```java
  <h1>x</h1>//åŒ¹é…
  <h2>x</h2>//åŒ¹é…
  <h3>x</h1>//ä¸åŒ¹é…
  ```

  



##### é›¶å®½æ–­è¨€

é¢„æœç´¢ï¼ˆé›¶å®½æ–­è¨€ï¼‰ï¼ˆç¯è§†ï¼‰

* åªè¿›è¡Œå­è¡¨è¾¾å¼çš„åŒ¹é…ï¼ŒåŒ¹é…å†…å®¹ä¸è®¡å…¥æœ€ç»ˆçš„åŒ¹é…ç»“æœï¼Œæ˜¯é›¶å®½åº¦

* åˆ¤æ–­å½“å‰ä½ç½®çš„å‰åå­—ç¬¦ï¼Œæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„æ¡ä»¶ï¼Œä½†ä¸åŒ¹é…å‰åçš„å­—ç¬¦ã€‚**æ˜¯å¯¹ä½ç½®çš„åŒ¹é…**ã€‚

* æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå­è¡¨è¾¾å¼åŒ¹é…åˆ°çš„æ˜¯å­—ç¬¦å†…å®¹ï¼Œè€Œéä½ç½®ï¼Œå¹¶è¢«ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯å æœ‰å­—ç¬¦çš„ï¼›å¦‚æœå­è¡¨è¾¾å¼åŒ¹é…çš„ä»…ä»…æ˜¯ä½ç½®ï¼Œæˆ–è€…åŒ¹é…çš„å†…å®¹å¹¶ä¸ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯**é›¶å®½åº¦**çš„ã€‚å æœ‰å­—ç¬¦è¿˜æ˜¯é›¶å®½åº¦ï¼Œæ˜¯é’ˆå¯¹åŒ¹é…çš„å†…å®¹æ˜¯å¦ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­è€Œè¨€çš„

  | è¡¨è¾¾å¼   | è¯´æ˜                                    |
  | -------- | --------------------------------------- |
  | (?=exp)  | æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„åé¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp |
  | (?<=exp) | æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„å‰é¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp |
  | (?!exp)  | æ–­è¨€æ­¤ä½ç½®çš„åé¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp       |
  | (?<!exp) | æ–­è¨€æ­¤ä½ç½®çš„å‰é¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp       |




***



#### åŒ¹é…æ¨¡å¼

æ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…æ¨¡å¼ï¼š

* IGNORECASE å¿½ç•¥å¤§å°å†™æ¨¡å¼
  * åŒ¹é…æ—¶å¿½ç•¥å¤§å°å†™ã€‚
  * é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ˜¯è¦åŒºåˆ†å¤§å°å†™çš„ã€‚
* SINGLELINE å•è¡Œæ¨¡å¼
  * æ•´ä¸ªæ–‡æœ¬çœ‹ä½œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåªæœ‰ä¸€ä¸ªå¼€å¤´ï¼Œä¸€ä¸ªç»“å°¾ã€‚
  * ä½¿å°æ•°ç‚¹ "." å¯ä»¥åŒ¹é…åŒ…å«æ¢è¡Œç¬¦ï¼ˆ\nï¼‰åœ¨å†…çš„ä»»æ„å­—ç¬¦ã€‚
* MULTILINE å¤šè¡Œæ¨¡å¼
  * æ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéƒ½æœ‰å¼€å¤´å’Œç»“å°¾ã€‚
  * åœ¨æŒ‡å®šäº† MULTILINE ä¹‹åï¼Œå¦‚æœéœ€è¦ä»…åŒ¹é…å­—ç¬¦ä¸²å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨ \A å’Œ \Z



***



#### åˆ†ç»„åŒ¹é…

Patternç±»ï¼š
	`static Pattern compile(String regex)` : å°†ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘ä¸ºæ¨¡å¼
	`Matcher matcher(CharSequence input)` : åˆ›å»ºä¸€ä¸ªåŒ¹é…å™¨ï¼ŒåŒ¹é…ç»™å®šçš„è¾“å…¥ä¸æ­¤æ¨¡å¼
	`static boolean matches(String regex, CharSequence input)` : ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶åŒ¹é…è¾“å…¥

Matcherç±»ï¼š
	`boolean find()` : æ‰«æè¾“å…¥çš„åºåˆ—ï¼ŒæŸ¥æ‰¾ä¸è¯¥æ¨¡å¼åŒ¹é…çš„ä¸‹ä¸€ä¸ªå­åºåˆ—
	`String group()` : è¿”å›ä¸ä¸Šä¸€ä¸ªåŒ¹é…çš„è¾“å…¥å­åºåˆ—ã€‚åŒgroup(0)ï¼ŒåŒ¹é…æ•´ä¸ªè¡¨è¾¾å¼çš„å­å­—ç¬¦ä¸²
	`String group(int group)` : è¿”å›åœ¨ä¸Šä¸€æ¬¡åŒ¹é…æ“ä½œæœŸé—´ç”±ç»™å®šç»„æ•è·çš„è¾“å…¥å­åºåˆ— 
    `int groupCount()` : è¿”å›æ­¤åŒ¹é…å™¨æ¨¡å¼ä¸­æ•è·ç»„çš„æ•°é‡

```java
public class Demo01{
	public static void main(String[] args) {
		//è¡¨è¾¾å¼å¯¹è±¡
		Pattern p = Pattern.compile("\\w+");
		//åˆ›å»ºMatcherå¯¹è±¡
		Matcher m = p.matcher("asfsdf2&&3323");
		//boolean b = m.matches();//å°è¯•å°†æ•´ä¸ªå­—ç¬¦åºåˆ—ä¸è¯¥æ¨¡å¼åŒ¹é…
		//System.out.println(b);//false
		//boolean b2 = m.find();//è¯¥æ–¹æ³•æ‰«æè¾“å…¥çš„åºåˆ—ï¼ŒæŸ¥æ‰¾ä¸è¯¥æ¨¡å¼åŒ¹é…çš„ä¸‹ä¸€ä¸ªå­åºåˆ—
		//System.out.println(b2);//true
		
		//System.out.println(m.find());
		//System.out.println(m.group());//asfsdf2
		//System.out.println(m.find());
		//System.out.println(m.group());//3323
		
		while(m.find()){
			System.out.println(m.group());	//group(),group(0)åŒ¹é…æ•´ä¸ªè¡¨è¾¾å¼çš„å­å­—ç¬¦ä¸²
			System.out.println(m.group(0));
		}
		
	}
}
```

```java
public class Demo02 {
	public static void main(String[] args) {
		//åœ¨è¿™ä¸ªå­—ç¬¦ä¸²ï¼šasfsdf23323ï¼Œæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼š\w+
		//è¡¨è¾¾å¼å¯¹è±¡
        Pattern p = Pattern.compile("(([a-z]+)([0-9]+))");//ä¸éœ€è¦åŠ å¤šä½™çš„æ‹¬å·
		//åˆ›å»ºMatcherå¯¹è±¡
		Matcher m = p.matcher("aa232**ssd445");
	
		while(m.find()){
			System.out.println(m.group());//aa232  ssd445
			System.out.println(m.group(1));//aa232  ssd445
			System.out.println(m.group(2));//aa     ssd
            System.out.println(m.group(3));//232    445 
		}
	}
}
```

* æ­£åˆ™è¡¨è¾¾å¼æ”¹ä¸º`"(([a-z]+)(?:[0-9]+))"`   æ²¡æœ‰group(3) å› ä¸ºæ˜¯éæ•è·ç»„
* æ­£åˆ™è¡¨è¾¾å¼æ”¹ä¸º`"([a-z]+)([0-9]+)"`  æ²¡æœ‰ group(3)    aa232  - aa  --232



***



#### åº”ç”¨

##### åŸºæœ¬éªŒè¯

```java
public static void main(String[] args){
	System.out.println("a".matches("[abc]"));//trueåˆ¤æ–­aæ˜¯å¦åœ¨abc
    System.out.println("a".matches("[^abc]"));//false åˆ¤æ–­aæ˜¯å¦åœ¨abcä¹‹å¤–çš„
    System.out.println("a".matches("\\d")); //false æ˜¯å¦aæ˜¯æ•´æ•°
    System.out.println("a".matches("\\w")); //true æ˜¯å¦æ˜¯å­—ç¬¦
    System.out.println("ä½ ".matches("\\w")); // false
    System.out.println("aa".matches("\\w"));//false åªèƒ½æ£€éªŒå•ä¸ªå­—ç¬¦
    
    // å¯†ç  å¿…é¡»æ˜¯æ•°å­— å­—æ¯ ä¸‹åˆ’çº¿ è‡³å°‘ 6ä½
	System.out.println("ssds3c".matches("\\w{6,}")); // true
    // éªŒè¯ã€‚å¿…é¡»æ˜¯æ•°å­—å’Œå­—ç¬¦  å¿…é¡»æ˜¯4ä½
    System.out.println("dsd22".matches("[a-zA-Z0-9]{4}")); // false
    System.out.println("A3dy".matches("[a-zA-Z0-9]{4}")); // true
}
```



##### éªŒè¯å·ç 

```java
//1å¼€å¤´ ç¬¬äºŒä½æ˜¯2-9çš„æ•°å­—
public static void checkPhone(String phone){
    if(phone.matches("1[3-9]\\d{9}")){
        System.out.println("æ‰‹æœºå·ç æ ¼å¼æ­£ç¡®ï¼");
    } else {.......}
}
//1111@qq.com  zhy@pic.com.cn
public static void checkEmail(String email){
    if(email.matches("\\w{1,}@\\w{1,}(\\.\\w{2,5}){1,2}")){
        System.out.println("é‚®ç®±æ ¼å¼æ­£ç¡®ï¼");
    }// .æ˜¯ä»»æ„å­—ç¬¦ \\.å°±æ˜¯ç‚¹
}
```



##### æŸ¥æ‰¾æ›¿æ¢

* `public String[] split(String regex)`ï¼šæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹è¿›è¡Œåˆ†å‰²å­—ç¬¦ä¸²ï¼Œåå›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„
* `public String replaceAll(String regex,String newStr)`ï¼šæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹è¿›è¡Œæ›¿æ¢

```java
//æ•°ç»„åˆ†å‰²
public static void main(String[] args) {
	// 1.splitçš„åŸºç¡€ç”¨æ³•
	String names = "è´¾ä¹ƒäº®,ç‹å®å¼º,é™ˆç¾½å‡¡";
	// ä»¥â€œï¼Œâ€åˆ†å‰²æˆå­—ç¬¦ä¸²æ•°ç»„
    String[] nameArrs = names.split(",");

    // 2.splité›†åˆæ­£åˆ™è¡¨è¾¾å¼åšåˆ†å‰²
    String names1 = "è´¾ä¹ƒäº®lv434fda324ç‹å®å¼º87632fad2342423é™ˆç¾½å‡¡";
    // ä»¥åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„å†…å®¹ä¸ºåˆ†å‰²ç‚¹åˆ†å‰²æˆå­—ç¬¦ä¸²æ•°ç»„
	String[] nameArrs1 = names1.split("\\w+");
    
	// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä½å‡ºå†…å®¹ï¼Œæ›¿æ¢æˆ/
	System.out.println(names1.replaceAll("\\w+","/"));//è´¾ä¹ƒäº®/ç‹å®å¼º/ç¾½å‡¡

	String names3 = "è´¾ä¹ƒäº®,ç‹å®å¼º,ç¾½å‡¡";
	System.out.println(names3.replaceAll(",","-"));//è´¾ä¹ƒäº®-ç‹å®å¼º-ç¾½å‡¡
}
```





##### é¢è¯•é—®é¢˜

æ‰¾å‡ºæ‰€æœ‰189å’Œ132å¼€å¤´çš„æ‰‹æœºå·

```java
public class RegexDemo {
    public static void main(String[] args) {
        String rs = "189asjk65as1891898777745gkkkk189745612318936457894";
        String regex = "(?=((189|132)\\d{8}))";
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(rs);
        while (matcher.find()) {
            System.out.println(matcher.group(1));
        }
    }
}
```





***



## é›†åˆ

### é›†åˆæ¦‚è¿°

é›†åˆæ˜¯ä¸€ä¸ªå¤§å°å¯å˜çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„æ¯ä¸ªæ•°æ®ç§°ä¸ºä¸€ä¸ªå…ƒç´ 

é›†åˆç‰¹ç‚¹ï¼šç±»å‹å¯ä»¥ä¸ç¡®å®šï¼Œå¤§å°ä¸å›ºå®šï¼›é›†åˆæœ‰å¾ˆå¤šï¼Œä¸åŒçš„é›†åˆç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯ä¸åŒ

æ•°ç»„ï¼šç±»å‹å’Œé•¿åº¦ä¸€æ—¦å®šä¹‰å‡ºæ¥å°±éƒ½å›ºå®š

ä½œç”¨ï¼š

* åœ¨å¼€å‘ä¸­ï¼Œå¾ˆå¤šæ—¶å€™å…ƒç´ çš„ä¸ªæ•°æ˜¯ä¸ç¡®å®šçš„
* è€Œä¸”ç»å¸¸è¦è¿›è¡Œå…ƒç´ çš„å¢åˆ è¯¥æŸ¥æ“ä½œï¼Œé›†åˆéƒ½æ˜¯éå¸¸åˆé€‚çš„ï¼Œå¼€å‘ä¸­é›†åˆç”¨çš„æ›´å¤š



***



### å­˜å‚¨ç»“æ„

æ•°æ®ç»“æ„æŒ‡çš„æ˜¯æ•°æ®ä»¥ä»€ä¹ˆæ–¹å¼ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä¸åŒçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æŸ¥çš„æ€§èƒ½æ˜¯ä¸ä¸€æ ·çš„

æ•°æ®å­˜å‚¨çš„å¸¸ç”¨ç»“æ„æœ‰ï¼šæ ˆã€é˜Ÿåˆ—ã€æ•°ç»„ã€é“¾è¡¨å’Œçº¢é»‘æ ‘

* é˜Ÿåˆ—ï¼ˆqueueï¼‰ï¼šå…ˆè¿›å…ˆå‡ºï¼Œåè¿›åå‡ºã€‚(FIFO first in first out)
  åœºæ™¯ï¼šå„ç§æ’é˜Ÿã€å«å·ç³»ç»Ÿï¼Œæœ‰å¾ˆå¤šé›†åˆå¯ä»¥å®ç°é˜Ÿåˆ—

* æ ˆï¼ˆstackï¼‰ï¼šåè¿›å…ˆå‡ºï¼Œå…ˆè¿›åå‡º ï¼ˆLIFOï¼‰
  å‹æ ˆ == å…¥æ ˆã€å¼¹æ ˆ == å‡ºæ ˆ
  åœºæ™¯ï¼šæ‰‹æªçš„å¼¹å¤¹ 

* æ•°ç»„ï¼šæ•°ç»„æ˜¯å†…å­˜ä¸­çš„è¿ç»­å­˜å‚¨åŒºåŸŸï¼Œåˆ†æˆè‹¥å¹²ç­‰åˆ†çš„å°åŒºåŸŸï¼ˆæ¯ä¸ªåŒºåŸŸå¤§å°æ˜¯ä¸€æ ·çš„ï¼‰ã€‚å…ƒç´ å­˜åœ¨ç´¢å¼•
  ç‰¹ç‚¹ï¼š**æŸ¥è¯¢å…ƒç´ å¿«**ï¼ˆæ ¹æ®ç´¢å¼•å¿«é€Ÿè®¡ç®—å‡ºå…ƒç´ çš„åœ°å€ï¼Œç„¶åç«‹å³å»å®šä½ï¼‰
              **å¢åˆ å…ƒç´ æ…¢**ï¼ˆåˆ›å»ºæ–°æ•°ç»„ï¼Œè¿ç§»å…ƒç´ ï¼‰

* é“¾è¡¨ï¼šå…ƒç´ ä¸æ˜¯å†…å­˜ä¸­çš„è¿ç»­åŒºåŸŸå­˜å‚¨ï¼Œå…ƒç´ æ˜¯æ¸¸ç¦»å­˜å‚¨çš„ï¼Œæ¯ä¸ªå…ƒç´ ä¼šè®°å½•ä¸‹ä¸ªå…ƒç´ çš„åœ°å€
  ç‰¹ç‚¹ï¼š**æŸ¥è¯¢å…ƒç´ æ…¢ï¼Œå¢åˆ å…ƒç´ å¿«**ï¼ˆé’ˆå¯¹äºé¦–å°¾å…ƒç´ ï¼Œé€Ÿåº¦æå¿«ï¼Œä¸€èˆ¬æ˜¯åŒé“¾è¡¨ï¼‰

* æ ‘

  * äºŒå‰æ ‘ï¼šbinary tree æ°¸è¿œåªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ˜¯æ¯ä¸ªç»“ç‚¹ä¸è¶…è¿‡2ä¸ªèŠ‚ç‚¹çš„æ ‘ï¼ˆtreeï¼‰ 
    ç‰¹ç‚¹ï¼šäºŒå‰æ’åºæ ‘ï¼šå°çš„å·¦è¾¹ï¼Œå¤§çš„å³è¾¹ï¼Œä½†æ˜¯å¯èƒ½æ ‘å¾ˆé«˜ï¼Œæ€§èƒ½å˜å·®
                ä¸ºäº†åšæ’åºå’Œæœç´¢ä¼šè¿›è¡Œå·¦æ—‹å’Œå³æ—‹å®ç°å¹³è¡¡æŸ¥æ‰¾äºŒå‰æ ‘ï¼Œè®©æ ‘çš„é«˜åº¦å·®ä¸å¤§äº1

  * çº¢é»‘æ ‘ï¼ˆåŸºäºçº¢é»‘è§„åˆ™å®ç°è‡ªå¹³è¡¡çš„æ’åºäºŒå‰æ ‘ï¼‰ï¼šæ ‘ä¿è¯åˆ°äº†å¾ˆçŸ®å°ï¼Œä½†æ˜¯åˆæ’å¥½åºï¼Œæ€§èƒ½æœ€é«˜çš„æ ‘

    ç‰¹ç‚¹ï¼š**çº¢é»‘æ ‘çš„å¢åˆ æŸ¥æ”¹æ€§èƒ½éƒ½å¥½**

å„æ•°æ®ç»“æ„æ—¶é—´å¤æ‚åº¦å¯¹æ¯”ï¼š

![](https://gitee.com/seazean/images/raw/master/Java/æ•°æ®ç»“æ„çš„å¤æ‚åº¦å¯¹æ¯”.png)



å›¾ç‰‡æ¥æºï¼šhttps://www.bigocheatsheet.com/



***



### Collection

#### æ¦‚è¿°

> Javaä¸­é›†åˆçš„ä»£è¡¨æ˜¯ï¼šCollection.
> Collectioné›†åˆæ˜¯Javaä¸­é›†åˆçš„ç¥–å®—ç±»ã€‚

Collectioné›†åˆåº•å±‚ä¸ºæ•°ç»„ï¼š`[value1, value2, ....]`

```java
Collectioné›†åˆçš„ä½“ç³»:
                      Collection<E>(æ¥å£)
                 /                         \
          Set<E>(æ¥å£)                    List<E>(æ¥å£)
      /               \                  /             \
 HashSet<E>(å®ç°ç±») TreeSet<>(å®ç°ç±»)  ArrayList<E>(å®ç°ç±»)  LinekdList<>(å®ç°ç±»)
 /
LinkedHashSet<>(å®ç°ç±»)
```

**é›†åˆçš„ç‰¹ç‚¹ï¼š**(éå¸¸é‡è¦)
		Setç³»åˆ—é›†åˆï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æ— åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„ã€‚
            -- HashSet: æ·»åŠ çš„å…ƒç´ æ˜¯æ— åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„ã€‚
            -- LinkedHashSet: æ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„ã€‚
            -- TreeSet: ä¸é‡å¤ï¼Œæ— ç´¢å¼•ï¼ŒæŒ‰ç…§å¤§å°é»˜è®¤å‡åºæ’åº!!
		Listç³»åˆ—é›†åˆï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚
            -- ArrayListï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚
            -- LinekdListï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚



***



#### API

Collectionæ˜¯é›†åˆçš„ç¥–å®—ç±»ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å…¨éƒ¨é›†åˆéƒ½å¯ä»¥ç»§æ‰¿ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¦å­¦ä¹ å®ƒã€‚

Collectionå­ç±»çš„æ„é€ å™¨éƒ½æœ‰å¯ä»¥åŒ…è£…å…¶ä»–å­ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ï¼š
	`public ArrayList(Collection<? extends E> c)` : æ„é€ æ–°é›†åˆï¼Œå…ƒç´ æŒ‰ç…§ç”±é›†åˆçš„è¿­ä»£å™¨è¿”å›çš„é¡ºåº
	`public HashSet(Collection<? extends E> c)` : æ„é€ ä¸€ä¸ªåŒ…å«æŒ‡å®šé›†åˆä¸­çš„å…ƒç´ çš„æ–°é›†åˆ

Collection APIå¦‚ä¸‹ï¼š
     `public boolean add(E e)` : æŠŠç»™å®šçš„å¯¹è±¡æ·»åŠ åˆ°å½“å‰é›†åˆä¸­ ã€‚
     `public void clear()` : æ¸…ç©ºé›†åˆä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚
     `public boolean remove(E e)` : æŠŠç»™å®šçš„å¯¹è±¡åœ¨å½“å‰é›†åˆä¸­åˆ é™¤ã€‚
     `public boolean contains(Object obj)` : åˆ¤æ–­å½“å‰é›†åˆä¸­æ˜¯å¦åŒ…å«ç»™å®šçš„å¯¹è±¡ã€‚
     `public boolean isEmpty()` : åˆ¤æ–­å½“å‰é›†åˆæ˜¯å¦ä¸ºç©ºã€‚
     `public int size()` : è¿”å›é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚
     `public Object[] toArray()` : æŠŠé›†åˆä¸­çš„å…ƒç´ ï¼Œå­˜å‚¨åˆ°æ•°ç»„ä¸­
	 `public boolean addAll(Collection<? extends E> c)` : å°†æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°æ­¤é›†åˆ

```java
public class CollectionDemo {
    public static void main(String[] args) {
        Collection<String> sets = new HashSet<>();
        sets.add("MyBatis");
        System.out.println(sets.add("Java"));//true
        System.out.println(sets.add("Java"));//false
        sets.add("Spring");
        sets.add("MySQL");
        System.out.println(sets)//[]æ— åºçš„;
        System.out.println(sets.contains("java"));//true å­˜åœ¨
        Object[] arrs = sets.toArray();
        System.out.println("æ•°ç»„ï¼š"+ Arrays.toString(arrs));
        
        Collection<String> c1 = new ArrayList<>();
        c1.add("java");
        Collection<String> c2 = new ArrayList<>();
        c2.add("ee");
        c1.addAll(c2);// c1:[java,ee]  c2:[ee];
    }
}
```



***



#### éå†

Collectioné›†åˆçš„éå†æ–¹å¼æœ‰ä¸‰ç§:

é›†åˆå¯ä»¥ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œå› ä¸ºåº•å±‚é‡å†™äº†toString()æ–¹æ³•ã€‚

1. è¿­ä»£å™¨
   `public Iterator iterator()` : è·å–é›†åˆå¯¹åº”çš„è¿­ä»£å™¨ï¼Œç”¨æ¥éå†é›†åˆä¸­çš„å…ƒç´ çš„
   `E next()` : è·å–ä¸‹ä¸€ä¸ªå…ƒç´ å€¼ï¼
   `boolean hasNext()` : åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæœ‰è¿”å›true ,åä¹‹
   `default void remove()` : ä»åº•å±‚é›†åˆä¸­åˆ é™¤æ­¤è¿­ä»£å™¨è¿”å›çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œè¿™ç§æ–¹æ³•åªèƒ½åœ¨æ¯æ¬¡è°ƒç”¨next() æ—¶è°ƒç”¨ä¸€æ¬¡

2. å¢å¼ºforå¾ªç¯
   å¢å¼ºforå¾ªç¯æ˜¯ä¸€ç§éå†å½¢å¼ï¼Œå¯ä»¥éå†é›†åˆæˆ–è€…æ•°ç»„ï¼Œéå†é›†åˆå®é™…ä¸Šæ˜¯è¿­ä»£å™¨éå†çš„ç®€åŒ–å†™æ³•
```java
   for(è¢«éå†é›†åˆæˆ–è€…æ•°ç»„ä¸­å…ƒç´ çš„ç±»å‹ å˜é‡åç§° : è¢«éå†é›†åˆæˆ–è€…æ•°ç»„){
   
   }
```

ç¼ºç‚¹ï¼šéå†æ— æ³•çŸ¥é“éå†åˆ°äº†å“ªä¸ªå…ƒç´ äº†ï¼Œå› ä¸ºæ²¡æœ‰ç´¢å¼•ã€‚

3. JDK 1.8å¼€å§‹ä¹‹åçš„æ–°æŠ€æœ¯Lambdaè¡¨è¾¾å¼

   ```java
   public class CollectionDemo {
       public static void main(String[] args) {
           Collection<String> lists = new ArrayList<>();
           lists.add("aa");
           lists.add("bb");
           lists.add("cc");
           System.out.println(lists); // lists = [aa, bb, cc]
   		//è¿­ä»£å™¨æµç¨‹
           // 1.å¾—åˆ°é›†åˆçš„è¿­ä»£å™¨å¯¹è±¡ã€‚
           Iterator<String> it = lists.iterator();
           // 2.ä½¿ç”¨whileå¾ªç¯éå†ã€‚
           while(it.hasNext()){
               String ele = it.next();
               System.out.println(ele);
           }
           
   		//å¢å¼ºfor
           for (String ele : lists) {
               System.out.println(ele);
           }
           //lambdaè¡¨è¾¾å¼
           lists.forEach(s -> {
               System.out.println(s);
           });
       }
   }
   ```

   



***



#### List

##### æ¦‚è¿°

Listé›†åˆç»§æ‰¿äº†Collectioné›†åˆå…¨éƒ¨çš„åŠŸèƒ½ã€‚

Listç³»åˆ—é›†åˆæœ‰ç´¢å¼•ï¼Œæ‰€ä»¥å¤šäº†å¾ˆå¤šæŒ‰ç…§ç´¢å¼•æ“ä½œå…ƒç´ çš„åŠŸèƒ½ï¼šforå¾ªç¯éå†ï¼ˆ4ç§éå†ï¼‰

Listç³»åˆ—é›†åˆï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚

* ArrayListï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚

* LinekdListï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•ã€‚

  

***



##### ArrayList

###### ä»‹ç»

ArrayList æ·»åŠ çš„å…ƒç´ ï¼Œæ˜¯æœ‰åºï¼Œå¯é‡å¤ï¼Œæœ‰ç´¢å¼•çš„ã€‚

`public boolean add(E e)` : å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤é›†åˆçš„æœ«å°¾
`public void add(int index, E element)` : å°†æŒ‡å®šçš„å…ƒç´ ï¼Œæ·»åŠ åˆ°è¯¥é›†åˆä¸­çš„æŒ‡å®šä½ç½®ä¸Šã€‚
`public E get(int index)` : è¿”å›é›†åˆä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚
`public E remove(int index)` : ç§»é™¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ , è¿”å›çš„æ˜¯è¢«ç§»é™¤çš„å…ƒç´ ã€‚
`public E set(int index, E element)` : ç”¨æŒ‡å®šå…ƒç´ æ›¿æ¢é›†åˆä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ,è¿”å›æ›´æ–°å‰çš„å…ƒç´ å€¼ã€‚
`int indexOf(Object o)` : è¿”å›åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœä¸åŒ…å«æ­¤å…ƒç´ ï¼Œåˆ™è¿”å›-1ã€‚

```java
public static void main(String[] args){
    List<String> lists = new ArrayList<>();//å¤šæ€
    lists.add("java1");
    lists.add("java1");//å¯ä»¥é‡å¤
    lists.add("java2");
    for(int i = 0 ; i < lists.size() ; i++ ) {
            String ele = lists.get(i);
            System.out.println(ele);
   }
}
```

![ArrayListæºç åˆ†æ](https://gitee.com/seazean/images/raw/master/Java/ArrayListæ·»åŠ å…ƒç´ æºç è§£æ.png)



###### æºç 

ArrayList å®ç°ç±»é›†åˆåº•å±‚**åŸºäºæ•°ç»„å­˜å‚¨æ•°æ®**çš„ï¼ŒæŸ¥è¯¢å¿«ï¼Œå¢åˆ æ…¢ï¼Œæ”¯æŒå¿«é€Ÿéšæœºè®¿é—®

```java
public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable{}
```

- `RandomAccess` æ˜¯ä¸€ä¸ªæ ‡å¿—æ¥å£ï¼Œè¡¨æ˜å®ç°è¿™ä¸ªè¿™ä¸ªæ¥å£çš„ List é›†åˆæ˜¯æ”¯æŒ**å¿«é€Ÿéšæœºè®¿é—®**çš„ã€‚åœ¨ `ArrayList` ä¸­ï¼Œæˆ‘ä»¬å³å¯ä»¥é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡ï¼Œè¿™å°±æ˜¯å¿«é€Ÿéšæœºè®¿é—®ã€‚
- `ArrayList` å®ç°äº† `Cloneable` æ¥å£ ï¼Œå³è¦†ç›–äº†å‡½æ•°`clone()`ï¼Œèƒ½è¢«å…‹éš†
- `ArrayList` å®ç°äº† `Serializable `æ¥å£ï¼Œè¿™æ„å‘³ç€`ArrayList`æ”¯æŒåºåˆ—åŒ–ï¼Œèƒ½é€šè¿‡åºåˆ—åŒ–å»ä¼ è¾“

æ ¸å¿ƒæ–¹æ³•ï¼š

* æ„é€ å‡½æ•°ï¼šä»¥æ— å‚æ•°æ„é€ æ–¹æ³•åˆ›å»º ArrayList æ—¶ï¼Œå®é™…ä¸Šåˆå§‹åŒ–èµ‹å€¼çš„æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚å½“çœŸæ­£å¯¹æ•°ç»„è¿›è¡Œæ·»åŠ å…ƒç´ æ“ä½œæ—¶ï¼Œæ‰çœŸæ­£åˆ†é…å®¹é‡ï¼Œå³å‘æ•°ç»„ä¸­æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œ**æ•°ç»„å®¹é‡æ‰©ä¸º 10**

* æ·»åŠ å…ƒç´ ï¼š

  ```java
  //e æ’å…¥çš„å…ƒç´   elementDataåº•å±‚æ•°ç»„   size æ’å…¥çš„ä½ç½®
  public boolean add(E e) {
      ensureCapacityInternal(size + 1);	// Increments modCount!!
      elementData[size++] = e;			// æ’å…¥sizeä½ç½®ï¼Œç„¶ååŠ ä¸€
      return true;
  }
  ```

  å½“add ç¬¬ 1 ä¸ªå…ƒç´ åˆ° ArrayListï¼Œsize æ˜¯ 0ï¼Œè¿›å…¥ ensureCapacityInternal æ–¹æ³•ï¼Œ

  ```java
  private void ensureCapacityInternal(int minCapacity) {
      ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
  }
  ```

  ```java
  private static int calculateCapacity(Object[] elementData, int minCapacity) {
      //åˆ¤æ–­elementDataæ˜¯ä¸æ˜¯ç©ºæ•°ç»„
      if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
          //è¿”å›é»˜è®¤å€¼å’Œæœ€å°éœ€æ±‚å®¹é‡æœ€å¤§çš„ä¸€ä¸ª
          return Math.max(DEFAULT_CAPACITY, minCapacity);
      }
      return minCapacity;
  }
  ```

  å¦‚æœéœ€è¦çš„å®¹é‡å¤§äºæ•°ç»„é•¿åº¦ï¼Œè¿›è¡Œæ‰©å®¹ï¼š

  ```java
  //åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹
  private void ensureExplicitCapacity(int minCapacity) {
      modCount++;
      //ç´¢å¼•è¶Šç•Œ
      if (minCapacity - elementData.length > 0)
          //è°ƒç”¨growæ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä»£è¡¨å·²ç»å¼€å§‹æ‰©å®¹äº†
          grow(minCapacity);
  }
  ```

  æŒ‡å®šç´¢å¼•æ’å…¥ï¼Œåœ¨æ—§æ•°ç»„ä¸Šæ“ä½œï¼š

  ```java
  public void add(int index, E element) {
      rangeCheckForAdd(index);
      ensureCapacityInternal(size + 1);  // Increments modCount!!
      System.arraycopy(elementData, index, elementData, index + 1,
                       size - index);
      elementData[index] = element;
      size++;
  }
  ```

* æ‰©å®¹ï¼šæ–°å®¹é‡çš„å¤§å°ä¸º `oldCapacity + (oldCapacity >> 1)`ï¼Œ`oldCapacity >> 1` éœ€è¦å–æ•´ï¼Œæ‰€ä»¥æ–°å®¹é‡å¤§çº¦æ˜¯æ—§å®¹é‡çš„ 1.5 å€å·¦å³ï¼Œå³ oldCapacity+oldCapacity/2

  æ‰©å®¹æ“ä½œéœ€è¦è°ƒç”¨ `Arrays.copyOf()`ï¼ˆåº•å±‚ `System.arraycopy()`ï¼‰æŠŠåŸæ•°ç»„æ•´ä¸ªå¤åˆ¶åˆ°**æ–°æ•°ç»„**ä¸­ï¼Œè¿™ä¸ªæ“ä½œä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤æœ€å¥½åœ¨åˆ›å»º ArrayList å¯¹è±¡æ—¶å°±æŒ‡å®šå¤§æ¦‚çš„å®¹é‡å¤§å°ï¼Œå‡å°‘æ‰©å®¹æ“ä½œçš„æ¬¡æ•°

  ```java
  private void grow(int minCapacity) {
      int oldCapacity = elementData.length;
      int newCapacity = oldCapacity + (oldCapacity >> 1);
      //æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦å¤§äºæœ€å°éœ€è¦å®¹é‡ï¼Œè‹¥å°äºæœ€å°éœ€è¦å®¹é‡ï¼Œå°±æŠŠæœ€å°éœ€è¦å®¹é‡å½“ä½œæ•°ç»„çš„æ–°å®¹é‡
      if (newCapacity - minCapacity < 0)
  		newCapacity = minCapacity;//ä¸éœ€è¦æ‰©å®¹è®¡ç®—
      //æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦å¤§äºæœ€å¤§æ•°ç»„å®¹é‡
      if (newCapacity - MAX_ARRAY_SIZE > 0)
          //å¦‚æœminCapacityå¤§äºæœ€å¤§å®¹é‡ï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸º`Integer.MAX_VALUE`
          //å¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º MAX_ARRAY_SIZE å³ä¸º `Integer.MAX_VALUE - 8`
          newCapacity = hugeCapacity(minCapacity);
      elementData = Arrays.copyOf(elementData, newCapacity);
  }
  ```

  MAX_ARRAY_SIZEï¼šè¦åˆ†é…çš„æ•°ç»„çš„æœ€å¤§å¤§å°ï¼Œåˆ†é…æ›´å¤§çš„**å¯èƒ½**ä¼šå¯¼è‡´

  * OutOfMemoryError:Requested array size exceeds VM limitï¼ˆè¯·æ±‚çš„æ•°ç»„å¤§å°è¶…å‡ºVMé™åˆ¶ï¼‰
  * OutOfMemoryError: Java heap spaceï¼ˆå †åŒºå†…å­˜ä¸è¶³ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®JVMå‚æ•° -Xmx æ¥è°ƒèŠ‚ï¼‰

* åˆ é™¤å…ƒç´ ï¼šéœ€è¦è°ƒç”¨ System.arraycopy() å°† index+1 åé¢çš„å…ƒç´ éƒ½å¤åˆ¶åˆ° index ä½ç½®ä¸Šï¼Œåœ¨æ—§æ•°ç»„ä¸Šæ“ä½œï¼Œè¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¯ä»¥çœ‹åˆ° ArrayList åˆ é™¤å…ƒç´ çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ï¼Œ

  ```java
  private void fastRemove(Object[] es, int i) {
      modCount++;
      final int newSize;
      if ((newSize = size - 1) > i)
          System.arraycopy(es, i + 1, es, i, newSize - i);
      es[size = newSize] = null;
  }
  ```

* åºåˆ—åŒ–ï¼šArrayList åŸºäºæ•°ç»„å¹¶ä¸”å…·æœ‰åŠ¨æ€æ‰©å®¹ç‰¹æ€§ï¼Œå› æ­¤ä¿å­˜å…ƒç´ çš„æ•°ç»„ä¸ä¸€å®šéƒ½ä¼šè¢«ä½¿ç”¨ï¼Œå°±æ²¡å¿…è¦å…¨éƒ¨è¿›è¡Œåºåˆ—åŒ–ã€‚ä¿å­˜å…ƒç´ çš„æ•°ç»„ elementData ä½¿ç”¨ transient ä¿®é¥°ï¼Œè¯¥å…³é”®å­—å£°æ˜æ•°ç»„é»˜è®¤ä¸ä¼šè¢«åºåˆ—åŒ–

  ```java
   transient Object[] elementData;
  ```

* ensureCapacityï¼šå¢åŠ æ­¤å®ä¾‹çš„å®¹é‡ï¼Œä»¥ç¡®ä¿å®ƒè‡³å°‘å¯ä»¥å®¹çº³æœ€å°å®¹é‡å‚æ•°æŒ‡å®šçš„å…ƒç´ æ•°ï¼Œå‡å°‘å¢é‡é‡æ–°åˆ†é…çš„æ¬¡æ•°

  ```java
   public void ensureCapacity(int minCapacity) {
       if (minCapacity > elementData.length
           && !(elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
                && minCapacity <= DEFAULT_CAPACITY)) {
           modCount++;
           grow(minCapacity);
       }
   }
  ```

* **Fail-Fast**ï¼šå¿«é€Ÿå¤±è´¥ï¼ŒmodCount ç”¨æ¥è®°å½• ArrayList **ç»“æ„å‘ç”Ÿå˜åŒ–**çš„æ¬¡æ•°ï¼Œç»“æ„å‘ç”Ÿå˜åŒ–æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ‰€æœ‰æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…åªæ˜¯è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–

  åœ¨è¿›è¡Œåºåˆ—åŒ–æˆ–è€…è¿­ä»£ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒæ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†æŠ›å‡º ConcurrentModificationExceptionå¼‚å¸¸



***



##### Vector

åŒæ­¥ï¼šVectorçš„å®ç°ä¸ ArrayList ç±»ä¼¼ï¼Œä½†æ˜¯æ–¹æ³•ä¸Šä½¿ç”¨äº† synchronized è¿›è¡ŒåŒæ­¥

æ„é€ ï¼šé»˜è®¤é•¿åº¦ä¸º 10 çš„æ•°ç»„

æ‰©å®¹ï¼šVector çš„æ„é€ å‡½æ•°å¯ä»¥ä¼ å…¥ capacityIncrement å‚æ•°ï¼Œä½œç”¨æ˜¯åœ¨æ‰©å®¹æ—¶ä½¿å®¹é‡ capacity å¢é•¿ capacityIncrementï¼Œå¦‚æœè¿™ä¸ªå‚æ•°çš„å€¼å°äºç­‰äº 0ï¼ˆé»˜è®¤0ï¼‰ï¼Œæ‰©å®¹æ—¶æ¯æ¬¡éƒ½ä»¤ capacity ä¸ºåŸæ¥çš„ä¸¤å€

å¯¹æ¯” ArrayList

1. Vector æ˜¯åŒæ­¥çš„ï¼Œå¼€é”€æ¯” ArrayList è¦å¤§ï¼Œè®¿é—®é€Ÿåº¦æ›´æ…¢ã€‚æœ€å¥½ä½¿ç”¨ ArrayList è€Œä¸æ˜¯ Vectorï¼Œå› ä¸ºåŒæ­¥æ“ä½œå®Œå…¨å¯ä»¥ç”±ç¨‹åºæ¥æ§åˆ¶

2. Vector æ¯æ¬¡æ‰©å®¹è¯·æ±‚å…¶å¤§å°çš„ 2 å€ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®å¢é•¿çš„å®¹é‡ï¼‰ï¼Œè€Œ ArrayList æ˜¯ 1.5 å€

3. åº•å±‚éƒ½æ˜¯ `Object[]`æ•°ç»„å­˜å‚¨



****



##### LinkedList

###### ä»‹ç»

LinkedListä¹Ÿæ˜¯Listçš„å®ç°ç±»ï¼šåŸºäº**åŒå‘é“¾è¡¨**å®ç°ï¼Œä½¿ç”¨ Node å­˜å‚¨é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¢åˆ æ¯”è¾ƒå¿«ï¼ŒæŸ¥è¯¢æ…¢

LinkedListé™¤äº†æ‹¥æœ‰Listé›†åˆçš„å…¨éƒ¨åŠŸèƒ½è¿˜å¤šäº†å¾ˆå¤šæ“ä½œé¦–å°¾å…ƒç´ çš„ç‰¹æ®ŠåŠŸèƒ½ï¼š
	`public boolean add(E e)` : å°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ°æ­¤åˆ—è¡¨çš„ç»“å°¾
	`public E poll()` : æ£€ç´¢å¹¶åˆ é™¤æ­¤åˆ—è¡¨çš„å¤´ï¼ˆç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
	`public void addFirst(E e)` : å°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤åˆ—è¡¨çš„å¼€å¤´
    `public void addLast(E e)` : å°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ°æ­¤åˆ—è¡¨çš„ç»“å°¾
    `public E getFirst()` : è¿”å›æ­¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    `public E getLast()` : è¿”å›æ­¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ 
    `public E removeFirst()` : ç§»é™¤å¹¶è¿”å›æ­¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    `public E removeLast()` : ç§»é™¤å¹¶è¿”å›æ­¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ 
    `public E pop()` : ä»æ­¤åˆ—è¡¨æ‰€è¡¨ç¤ºçš„å †æ ˆå¤„å¼¹å‡ºä¸€ä¸ªå…ƒç´ 
    `public void push(E e)` : å°†å…ƒç´ æ¨å…¥æ­¤åˆ—è¡¨æ‰€è¡¨ç¤ºçš„å †æ ˆ
	`public int indexOf(Object o)` : è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœä¸åŒ…å«è¿”å›-1
	`public int lastIndexOf(Object o)` : ä»å°¾éå†æ‰¾
	` public boolean remove(Object o)` : ä¸€æ¬¡åªåˆ é™¤ä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡ï¼Œå¦‚æœåˆ é™¤äº†åŒ¹é…å¯¹è±¡è¿”å›true
	`public E remove(int index)` : åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ 

```java
public class ListDemo {
    public static void main(String[] args) {
        // 1.ç”¨LinkedListåšä¸€ä¸ªé˜Ÿåˆ—:å…ˆè¿›å…ˆå‡ºï¼Œåè¿›åå‡ºã€‚
        LinkedList<String> queue = new LinkedList<>();
        // å…¥é˜Ÿ
        queue.addLast("1å·");
        queue.addLast("2å·");
        queue.addLast("3å·");
        System.out.println(queue); // [1å·, 2å·, 3å·]
        // å‡ºé˜Ÿ
        System.out.println(queue.removeFirst());//1å·
        System.out.println(queue.removeFirst());//2å·
        System.out.println(queue);//[3å·]

        // åšä¸€ä¸ªæ ˆ å…ˆè¿›åå‡º
        LinkedList<String> stack = new LinkedList<>();
        // å‹æ ˆ
        stack.push("ç¬¬1é¢—å­å¼¹");//addFirst(e);
        stack.push("ç¬¬2é¢—å­å¼¹");
        stack.push("ç¬¬3é¢—å­å¼¹");
        System.out.println(stack); // [ ç¬¬3é¢—å­å¼¹, ç¬¬2é¢—å­å¼¹, ç¬¬1é¢—å­å¼¹]
        // å¼¹æ ˆ
        System.out.println(stack.pop());//removeFirst(); ç¬¬3é¢—å­å¼¹
        System.out.println(stack.pop());
        System.out.println(stack);// [ç¬¬1é¢—å­å¼¹]
    }
}
```

![](https://gitee.com/seazean/images/raw/master/Java/LinkedListæ·»åŠ å…ƒç´ æºç è§£æ.png)





###### æºç 

LinkedList æ˜¯ä¸€ä¸ªå®ç°äº† List æ¥å£çš„**åŒç«¯é“¾è¡¨**ï¼Œæ”¯æŒé«˜æ•ˆçš„æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œå¦å¤–ä¹Ÿå®ç°äº† Deque æ¥å£ï¼Œä½¿å¾—LinkedList ç±»ä¹Ÿå…·æœ‰é˜Ÿåˆ—çš„ç‰¹æ€§

![](https://gitee.com/seazean/images/raw/master/Java/LinkedListåº•å±‚ç»“æ„.png)

æ ¸å¿ƒæ–¹æ³•ï¼š

* ä½¿ LinkedList å˜æˆçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥è°ƒç”¨é™æ€ç±» Collections ç±»ä¸­çš„ synchronizedList æ–¹æ³•ï¼š

  ```java
  List list = Collections.synchronizedList(new LinkedList(...));
  ```

* ç§æœ‰å†…éƒ¨ç±» Nodeï¼šè¿™ä¸ªç±»ä»£è¡¨åŒç«¯é“¾è¡¨çš„èŠ‚ç‚¹ Node

  ```java
  private static class Node<E> {
      E item;
      Node<E> next;
      Node<E> prev;
  
      Node(Node<E> prev, E element, Node<E> next) {
          this.item = element;
          this.next = next;
          this.prev = prev;
      }
  }
  ```

* æ„é€ æ–¹æ³•ï¼šåªæœ‰æ— å‚æ„é€ å’Œç”¨å·²æœ‰çš„é›†åˆåˆ›å»ºé“¾è¡¨çš„æ„é€ æ–¹æ³•

* æ·»åŠ å…ƒç´ ï¼šé»˜è®¤åŠ åˆ°å°¾éƒ¨

  ```java
  public boolean add(E e) {
      linkLast(e);
      return true;
  }
  ```

* è·å–å…ƒç´ ï¼š`get(int index)` æ ¹æ®æŒ‡å®šç´¢å¼•è¿”å›æ•°æ®

  * è·å–å¤´èŠ‚ç‚¹ (index=0)ï¼šgetFirst()ã€element()ã€peek()ã€peekFirst() è¿™å››ä¸ªè·å–å¤´ç»“ç‚¹æ–¹æ³•çš„åŒºåˆ«åœ¨äºå¯¹é“¾è¡¨ä¸ºç©ºæ—¶çš„å¤„ç†ï¼Œæ˜¯æŠ›å‡ºå¼‚å¸¸è¿˜æ˜¯è¿”å›nullï¼Œå…¶ä¸­**getFirst() å’Œelement()** æ–¹æ³•å°†ä¼šåœ¨é“¾è¡¨ä¸ºç©ºæ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸
  * è·å–å°¾èŠ‚ç‚¹ (index=-1)ï¼šgetLast() æ–¹æ³•åœ¨é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œä¼šæŠ›å‡ºNoSuchElementExceptionï¼Œè€ŒpeekLast() åˆ™ä¸ä¼šï¼Œåªä¼šè¿”å› null

* åˆ é™¤å…ƒç´ ï¼š

  * remove()ã€removeFirst()ã€pop()ï¼šåˆ é™¤å¤´èŠ‚ç‚¹
  * removeLast()ã€pollLast()ï¼šåˆ é™¤å°¾èŠ‚ç‚¹ï¼ŒremoveLast()åœ¨é“¾è¡¨ä¸ºç©ºæ—¶æŠ›å‡ºNoSuchElementExceptionï¼Œè€ŒpollLast()æ–¹æ³•è¿”å›null

å¯¹æ¯” ArrayList

1. æ˜¯å¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼šArrayList å’Œ LinkedList éƒ½æ˜¯ä¸åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è¯çº¿ç¨‹å®‰å…¨
2. åº•å±‚æ•°æ®ç»“æ„ï¼š 
   * Arraylist åº•å±‚ä½¿ç”¨çš„æ˜¯ `Object` æ•°ç»„
   * LinkedList åº•å±‚ä½¿ç”¨çš„æ˜¯åŒå‘é“¾è¡¨æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ï¼‰
3. æ’å…¥å’Œåˆ é™¤æ˜¯å¦å—å…ƒç´ ä½ç½®çš„å½±å“ï¼š
   * ArrayList é‡‡ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤å…ƒç´ å—å…ƒç´ ä½ç½®çš„å½±å“
   * LinkedListé‡‡ ç”¨é“¾è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥å¯¹äº`add(E e)`æ–¹æ³•çš„æ’å…¥ï¼Œåˆ é™¤å…ƒç´ ä¸å—å…ƒç´ ä½ç½®çš„å½±å“
4. æ˜¯å¦æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼š
   * LinkedList ä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ï¼ŒArrayList æ”¯æŒ
   * å¿«é€Ÿéšæœºè®¿é—®å°±æ˜¯é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡(å¯¹åº”äº`get(int index)`æ–¹æ³•)ã€‚
5. å†…å­˜ç©ºé—´å ç”¨ï¼š
   * ArrayList çš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨ list åˆ—è¡¨çš„ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´
   * LinkedList çš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—æ¯” ArrayListæ›´å¤šçš„ç©ºé—´ï¼ˆå› ä¸ºè¦å­˜æ”¾ç›´æ¥åç»§å’Œç›´æ¥å‰é©±ä»¥åŠæ•°æ®ï¼‰



***



#### Set

##### æ¦‚è¿°

Setç³»åˆ—é›†åˆï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æ— åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„

* HashSetï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æ— åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„
*  LinkedHashSetï¼šæ·»åŠ çš„å…ƒç´ æ˜¯æœ‰åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•çš„
* TreeSetï¼šä¸é‡å¤ï¼Œæ— ç´¢å¼•ï¼ŒæŒ‰ç…§å¤§å°é»˜è®¤å‡åºæ’åº

**é¢è¯•é—®é¢˜**ï¼šæ²¡æœ‰ç´¢å¼•ï¼Œä¸èƒ½ä½¿ç”¨æ™®é€š for å¾ªç¯éå†



***



##### HashSet

å“ˆå¸Œå€¼ï¼š

- å“ˆå¸Œå€¼ï¼šJDK æ ¹æ®å¯¹è±¡çš„åœ°å€æˆ–è€…å­—ç¬¦ä¸²æˆ–è€…æ•°å­—è®¡ç®—å‡ºæ¥çš„æ•°å€¼

- è·å–å“ˆå¸Œå€¼ï¼šObject ç±»ä¸­çš„ public int hashCode()

- å“ˆå¸Œå€¼çš„ç‰¹ç‚¹

  - åŒä¸€ä¸ªå¯¹è±¡å¤šæ¬¡è°ƒç”¨ hashCode() æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼æ˜¯ç›¸åŒçš„
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼æ˜¯ä¸åŒçš„ã€‚è€Œé‡å†™ hashCode() æ–¹æ³•ï¼Œå¯ä»¥å®ç°è®©ä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼ç›¸åŒ

**HashSet åº•å±‚å°±æ˜¯åŸºäº HashMap å®ç°ï¼Œå€¼æ˜¯  PRESENT = new Object()**

Seté›†åˆæ·»åŠ çš„å…ƒç´ æ˜¯æ— åºï¼Œä¸é‡å¤çš„ã€‚

* æ˜¯å¦‚ä½•å»é‡å¤çš„ï¼Ÿ

  ```java
  1.å¯¹äºæœ‰å€¼ç‰¹æ€§çš„ï¼ŒSeté›†åˆå¯ä»¥ç›´æ¥åˆ¤æ–­è¿›è¡Œå»é‡å¤ã€‚
  2.å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹çš„ç±»å¯¹è±¡ï¼ŒSeté›†åˆæ˜¯æŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿›è¡Œæ˜¯å¦é‡å¤çš„åˆ¤æ–­ã€‚
      Seté›†åˆä¼šè®©ä¸¤ä¸¤å¯¹è±¡ï¼Œå…ˆè°ƒç”¨è‡ªå·±çš„hashCode()æ–¹æ³•å¾—åˆ°å½¼æ­¤çš„å“ˆå¸Œå€¼ï¼ˆæ‰€è°“çš„å†…å­˜åœ°å€ï¼‰
      ç„¶åæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å“ˆå¸Œå€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒåˆ™ç›´æ¥è®¤ä¸ºä¸¤ä¸ªå¯¹è±¡ä¸é‡å¤ã€‚
      å¦‚æœå“ˆå¸Œå€¼ç›¸åŒï¼Œä¼šç»§ç»­è®©ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œequalsæ¯”è¾ƒå†…å®¹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒè®¤ä¸ºçœŸçš„é‡å¤äº†
      å¦‚æœä¸ç›¸åŒè®¤ä¸ºä¸é‡å¤ã€‚
  
              Seté›†åˆä¼šå…ˆè®©å¯¹è±¡è°ƒç”¨hashCode()æ–¹æ³•è·å–ä¸¤ä¸ªå¯¹è±¡çš„å“ˆå¸Œå€¼æ¯”è¾ƒ
                 /                     \
              false                    true
              /                          \
          ä¸é‡å¤                        ç»§ç»­è®©ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œequalsæ¯”è¾ƒ
                                         /          \
                                       false        true
                                        /             \
                                      ä¸é‡å¤          é‡å¤äº†
  ```

* Setç³»åˆ—é›†åˆå…ƒç´ æ— åºçš„æ ¹æœ¬åŸå› 

  Setç³»åˆ—é›†åˆæ·»åŠ å…ƒç´ æ— åºçš„æ ¹æœ¬åŸå› æ˜¯å› ä¸º**åº•å±‚é‡‡ç”¨äº†å“ˆå¸Œè¡¨å­˜å‚¨å…ƒç´ **ã€‚
  		JDK 1.8 ä¹‹å‰ï¼šå“ˆå¸Œè¡¨ = æ•°ç»„ï¼ˆåˆå§‹å®¹é‡16) + é“¾è¡¨  + ï¼ˆå“ˆå¸Œç®—æ³•ï¼‰
  		JDK 1.8 ä¹‹åï¼šå“ˆå¸Œè¡¨ = æ•°ç»„ï¼ˆåˆå§‹å®¹é‡16) + é“¾è¡¨ + çº¢é»‘æ ‘  + ï¼ˆå“ˆå¸Œç®—æ³•ï¼‰
      	å½“é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼8ä¸”å½“å‰æ•°ç»„çš„é•¿åº¦ > 64æ—¶ï¼Œå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œå‡å°‘äº†æŸ¥æ‰¾æ—¶é—´
  		å½“é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼8ä¸”å½“å‰æ•°ç»„çš„é•¿åº¦ < 64æ—¶ï¼Œæ‰©å®¹

  ![](https://gitee.com/seazean/images/raw/master/Java/HashSetåº•å±‚ç»“æ„å“ˆå¸Œè¡¨.png)
  
  æ¯ä¸ªå…ƒç´ çš„ hashcode() çš„å€¼è¿›è¡Œå“åº”çš„ç®—æ³•è¿ç®—ï¼Œè®¡ç®—å‡ºçš„å€¼ç›¸åŒçš„å­˜å…¥ä¸€ä¸ªæ•°ç»„å—ä¸­ï¼Œä»¥é“¾è¡¨çš„å½¢å¼å­˜å‚¨ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡8å°±é‡‡å–çº¢é»‘æ ‘å­˜å‚¨ï¼Œæ‰€ä»¥è¾“å‡ºçš„å…ƒç´ æ˜¯æ— åºçš„ã€‚

* å¦‚ä½•è®¾ç½®åªè¦å¯¹è±¡å†…å®¹ä¸€æ ·ï¼Œå°±å¸Œæœ›é›†åˆè®¤ä¸ºå®ƒä»¬é‡å¤äº†ï¼š**é‡å†™ hashCode å’Œ equals æ–¹æ³•**



****



##### Linked

LinkedHashSet ä¸ºä»€ä¹ˆæ˜¯æœ‰åºçš„ï¼Ÿ

LinkedHashSet åº•å±‚ä¾ç„¶æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨å…ƒç´ çš„ï¼Œä½†æ˜¯æ¯ä¸ªå…ƒç´ éƒ½é¢å¤–å¸¦ä¸€ä¸ªé“¾æ¥ç»´æŠ¤æ·»åŠ é¡ºåºï¼Œä¸å…‰å¢åˆ æŸ¥å¿«ï¼Œè¿˜æœ‰é¡ºåºï¼Œç¼ºç‚¹æ˜¯å¤šäº†ä¸€ä¸ªå­˜å‚¨é¡ºåºçš„é“¾ä¼š**å å†…å­˜ç©ºé—´**ï¼Œè€Œä¸”ä¸å…è®¸é‡å¤ï¼Œæ— ç´¢å¼•



****



##### TreeSet

TreeSet é›†åˆè‡ªæ’åºçš„æ–¹å¼ï¼š

1. æœ‰å€¼ç‰¹æ€§çš„å…ƒç´ ç›´æ¥å¯ä»¥å‡åºæ’åºï¼ˆæµ®ç‚¹å‹ï¼Œæ•´å‹ï¼‰
2. å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ ä¼šæŒ‰ç…§é¦–å­—ç¬¦çš„ç¼–å·æ’åº
3. å¯¹äºè‡ªå®šä¹‰çš„å¼•ç”¨æ•°æ®ç±»å‹ï¼ŒTreeSet é»˜è®¤æ— æ³•æ’åºï¼Œæ‰§è¡Œçš„æ—¶å€™æŠ¥é”™ï¼Œå› ä¸ºä¸çŸ¥é“æ’åºè§„åˆ™

è‡ªå®šä¹‰çš„å¼•ç”¨æ•°æ®ç±»å‹ï¼ŒTreeSet é»˜è®¤æ— æ³•æ’åºï¼Œéœ€è¦å®šåˆ¶æ’åºçš„è§„åˆ™ï¼Œæ–¹æ¡ˆæœ‰2ç§ï¼š

   * ç›´æ¥ä¸º**å¯¹è±¡çš„ç±»**å®ç°æ¯”è¾ƒå™¨è§„åˆ™æ¥å£ Comparableï¼Œé‡å†™æ¯”è¾ƒæ–¹æ³•ï¼š
     
          æ–¹æ³•ï¼š`public int compareTo(Employee o): thisæ˜¯æ¯”è¾ƒè€…, oæ˜¯è¢«æ¯”è¾ƒè€…`
         
           * æ¯”è¾ƒè€…å¤§äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å›æ­£æ•°
           * æ¯”è¾ƒè€…å°äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å›è´Ÿæ•°
           * æ¯”è¾ƒè€…ç­‰äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å› 0
         
   * ç›´æ¥ä¸º**é›†åˆ**è®¾ç½®æ¯”è¾ƒå™¨ Comparator å¯¹è±¡ï¼Œé‡å†™æ¯”è¾ƒæ–¹æ³•ï¼š
     
     æ–¹æ³•ï¼š`public int compare(Employee o1, Employee o2): o1æ¯”è¾ƒè€…, o2è¢«æ¯”è¾ƒè€…`
     
     * æ¯”è¾ƒè€…å¤§äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å›æ­£æ•°
     * æ¯”è¾ƒè€…å°äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å›è´Ÿæ•°
     * æ¯”è¾ƒè€…ç­‰äºè¢«æ¯”è¾ƒè€…ï¼Œè¿”å› 0

æ³¨æ„ï¼šå¦‚æœç±»å’Œé›†åˆéƒ½å¸¦æœ‰æ¯”è¾ƒè§„åˆ™ï¼Œä¼˜å…ˆä½¿ç”¨é›†åˆè‡ªå¸¦çš„æ¯”è¾ƒè§„åˆ™

```java
public class TreeSetDemo{
    public static void main(String[] args){
        Set<Student> students = new TreeSet<>();
		Collections.add(students,s1,s2,s3);
        System.out.println(students);//æŒ‰ç…§å¹´é¾„æ¯”è¾ƒ å‡åº
        
        Set<Student> s = new TreeSet<>(new Comparator<Student>(){
            @Override
            public int compare(Student o1, Student o2) {
                // o1æ¯”è¾ƒè€…   o2è¢«æ¯”è¾ƒè€…
                return o2.getAge() - o1.getAge();//é™åº
            }
        });
    }
}

public class Student implements Comparable<Student>{
    private String name;
    private int age;
    // é‡å†™äº†æ¯”è¾ƒæ–¹æ³•ã€‚
    // e1.compareTo(o)
    // æ¯”è¾ƒè€…ï¼šthis
    // è¢«æ¯”è¾ƒè€…ï¼šo
    // éœ€æ±‚ï¼šæŒ‰ç…§å¹´é¾„æ¯”è¾ƒ å‡åºï¼Œå¹´é¾„ç›¸åŒæŒ‰ç…§å§“å
    @Override
    public int compareTo(Student o) {
        int result = this.age - o.age;
        return result == 0 ? this.getName().compareTo(o.getName):result;
    }
}
```

æ¯”è¾ƒå™¨åŸç†ï¼šåº•å±‚æ˜¯ä»¥ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºåŸºå‡†ï¼ŒåŠ ä¸€ä¸ªæ–°å…ƒç´ ï¼Œå°±ä¼šå’Œç¬¬ä¸€ä¸ªå…ƒç´ æ¯”ï¼Œå¦‚æœå¤§äºï¼Œå°±ç»§ç»­å’Œå¤§äºçš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°é‡åˆ°æ¯”æ–°å…ƒç´ å¤§çš„å…ƒç´ ä¸ºæ­¢ï¼Œæ”¾åœ¨è¯¥ä½ç½®çš„å·¦è¾¹ã€‚ï¼ˆæ ‘ï¼‰




***



#### Collections

java.utils.Collectionsï¼šé›†åˆ**å·¥å…·ç±»**ï¼ŒCollectionså¹¶ä¸å±äºé›†åˆï¼Œæ˜¯ç”¨æ¥æ“ä½œé›†åˆçš„å·¥å…·ç±»
Collectionsæœ‰å‡ ä¸ªå¸¸ç”¨çš„APIï¼š
`public static <T> boolean addAll(Collection<? super T> c, T... e)` : ç»™é›†åˆå¯¹è±¡æ‰¹é‡æ·»åŠ å…ƒç´ 
`public static void shuffle(List<?> list)` : æ‰“ä¹±é›†åˆé¡ºåºã€‚
`public static <T> void sort(List<T> list)` : å°†é›†åˆä¸­å…ƒç´ æŒ‰ç…§é»˜è®¤è§„åˆ™æ’åºã€‚
`public static <T> void sort(List<T> list,Comparator<? super T> )` : é›†åˆä¸­å…ƒç´ æŒ‰ç…§æŒ‡å®šè§„åˆ™æ’åº
`public static <T> List<T> synchronizedList(List<T> list)` : è¿”å›ç”±æŒ‡å®š list æ”¯æŒçš„çº¿ç¨‹å®‰å…¨ list

```java
public class CollectionsDemo {
    public static void main(String[] args) {
        Collection<String> names = new ArrayList<>();
        Collections.addAll(names,"å¼ ","ç‹","æ","èµµ");
        
        List<Double> scores = new ArrayList<>();
        Collections.addAll(scores, 98.5, 66.5 , 59.5 , 66.5 , 99.5 );
        Collections.shuffle(scores);
        Collections.sort(scores); // é»˜è®¤å‡åºæ’åºï¼
        System.out.println(scores);
        
        List<Student> students = new ArrayList<>();
        Collections.addAll(students,s1,s2,s3,s4);
        Collections.sort(students,new Comparator<Student>(){
            
        })
    }
}

public class Student{
    private String name;
    private int age;
}
```





***



### Map

#### æ¦‚è¿°

>Collectionæ˜¯å•å€¼é›†åˆä½“ç³»ã€‚
>Mapé›†åˆæ˜¯ä¸€ç§åŒåˆ—é›†åˆï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä¸¤ä¸ªå€¼ã€‚

Mapé›†åˆçš„æ¯ä¸ªå…ƒç´ çš„æ ¼å¼ï¼škey=valueï¼ˆé”®å€¼å¯¹å…ƒç´ ï¼‰ï¼ŒMapé›†åˆä¹Ÿè¢«ç§°ä¸ºâ€œé”®å€¼å¯¹é›†åˆâ€

Mapé›†åˆçš„å®Œæ•´æ ¼å¼ï¼š`{key1=value1 , key2=value2 , key3=value3 , ...}`

```
Mapé›†åˆçš„ä½“ç³»ï¼š
        Map<K , V>(æ¥å£,Mapé›†åˆçš„ç¥–å®—ç±»)
       /                      \
      TreeMap<K , V>           HashMap<K , V>(å®ç°ç±»,ç»å…¸çš„ï¼Œç”¨çš„æœ€å¤š)
                                 \
                                  LinkedHashMap<K, V>(å®ç°ç±»)
```

Mapé›†åˆçš„ç‰¹ç‚¹ï¼š

1. Mapé›†åˆçš„ç‰¹ç‚¹éƒ½æ˜¯ç”±é”®å†³å®šçš„ã€‚
2. Mapé›†åˆçš„é”®æ˜¯æ— åº,ä¸é‡å¤çš„,æ— ç´¢å¼•çš„ã€‚(Set)
3. Mapé›†åˆçš„å€¼æ— è¦æ±‚ã€‚(List)
4. Mapé›†åˆçš„é”®å€¼å¯¹éƒ½å¯ä»¥ä¸ºnullã€‚
5. Mapé›†åˆåé¢é‡å¤çš„é”®å¯¹åº”å…ƒç´ ä¼šè¦†ç›–å‰é¢çš„å…ƒç´ 

HashMapï¼šå…ƒç´ æŒ‰ç…§é”®æ˜¯æ— åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•ï¼Œå€¼ä¸åšè¦æ±‚ã€‚

LinkedHashMapï¼šå…ƒç´ æŒ‰ç…§é”®æ˜¯æœ‰åºï¼Œä¸é‡å¤ï¼Œæ— ç´¢å¼•ï¼Œå€¼ä¸åšè¦æ±‚ã€‚

```java
//ç»å…¸ä»£ç 
Map<String , Integer> maps = new HashMap<>();
maps.put("æ‰‹æœº",1);
System.out.println(maps);
```



***



#### å¸¸ç”¨API

Mapé›†åˆçš„å¸¸ç”¨API

* `public V put(K key, V value)`ï¼šæŠŠæŒ‡å®šçš„é”®ä¸å€¼æ·»åŠ åˆ° Map é›†åˆä¸­ï¼Œ**é‡å¤çš„é”®ä¼šè¦†ç›–å‰é¢çš„å€¼å…ƒç´ **
* `public V remove(Object key)`ï¼šæŠŠæŒ‡å®šçš„é”®å¯¹åº”çš„é”®å€¼å¯¹å…ƒç´ åœ¨é›†åˆä¸­åˆ é™¤ï¼Œè¿”å›è¢«åˆ é™¤å…ƒç´ çš„å€¼
* `public V get(Object key)`ï¼šæ ¹æ®æŒ‡å®šçš„é”®ï¼Œåœ¨ Map é›†åˆä¸­è·å–å¯¹åº”çš„å€¼
* `public Set<K> keySet()`ï¼šè·å– Map é›†åˆä¸­æ‰€æœ‰çš„é”®ï¼Œå­˜å‚¨åˆ° **Set é›†åˆ**ä¸­
* `public Collection<V> values()`ï¼šè·å–å…¨éƒ¨å€¼çš„é›†åˆï¼Œå­˜å‚¨åˆ° **Collection é›†åˆ**
* `public Set<Map.Entry<K,V>> entrySet()`ï¼šè·å–Mapé›†åˆä¸­æ‰€æœ‰çš„é”®å€¼å¯¹å¯¹è±¡çš„é›†åˆ
* `public boolean containsKey(Object key)`ï¼šåˆ¤æ–­è¯¥é›†åˆä¸­æ˜¯å¦æœ‰æ­¤é”®

```java
public class MapDemo {
    public static void main(String[] args) {
        Map<String , Integer> maps = new HashMap<>();
        maps.put(.....);
        System.out.println(maps.isEmpty());//false
        Integer value = maps.get("....");//è¿”å›é”®å€¼å¯¹è±¡
        Set<String> keys = maps.keySet();//è·å–Mapé›†åˆä¸­æ‰€æœ‰çš„é”®ï¼Œ
        //Mapé›†åˆçš„é”®æ˜¯æ— åºä¸é‡å¤çš„ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ä¸€ä¸ªSeté›†åˆ
        Collection<Integer> values = maps.values();
        //Mapé›†åˆçš„å€¼æ˜¯ä¸åšè¦æ±‚çš„ï¼Œå¯èƒ½é‡å¤ï¼Œæ‰€ä»¥å€¼è¦ç”¨Collectioné›†åˆæ¥æ”¶!
    }
}
```



***



#### éå†æ–¹å¼

Mapé›†åˆçš„éå†æ–¹å¼æœ‰ï¼š3ç§ã€‚

1. â€œé”®æ‰¾å€¼â€çš„æ–¹å¼éå†ï¼šå…ˆè·å– Map é›†åˆå…¨éƒ¨çš„é”®ï¼Œå†æ ¹æ®éå†é”®æ‰¾å€¼ã€‚
2. â€œé”®å€¼å¯¹â€çš„æ–¹å¼éå†ï¼šéš¾åº¦è¾ƒå¤§ï¼Œé‡‡ç”¨å¢å¼º for æˆ–è€…è¿­ä»£å™¨
3. JDK 1.8 å¼€å§‹ä¹‹åçš„æ–°æŠ€æœ¯ï¼šforeachï¼Œé‡‡ç”¨ Lambdaè¡¨ è¾¾å¼

é›†åˆå¯ä»¥ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œå› ä¸ºåº•å±‚é‡å†™äº† toString() æ–¹æ³•

```java
public static void main(String[] args){
    Map<String , Integer> maps = new HashMap<>();
	//(1)é”®æ‰¾å€¼
    Set<String> keys = maps.keySet();
    for(String key : keys) {
        System.out.println(key + "=" + maps.get(key));
    }
    //Iterator<String> iterator = hm.keySet().iterator();
    
    //(2)é”®å€¼å¯¹
    //(2.1)æ™®é€šæ–¹å¼
    Set<Map.Entry<String,Integer>> entries = maps.entrySet();
    for (Map.Entry<String, Integer> entry : entries) {
             System.out.println(entry.getKey() + "=>" + entry.getValue());
    }
    //(2.2)è¿­ä»£å™¨æ–¹å¼
    Iterator<Map.Entry<String, Integer>> iterator = maps.entrySet().iterator();
    while (iterator.hasNext()) {
        Map.Entry<String, Integer> entry = iterator.next();
        System.out.println(entry.getKey() + "=" + entry.getValue());

    }
    //(3) Lamda
    maps.forEach((k,v) -> {
        System.out.println(k + "==>" + v);
    })
}
```



***



#### HashMap

##### åŸºæœ¬ä»‹ç»

HashMap åŸºäºå“ˆå¸Œè¡¨çš„ Map æ¥å£å®ç°ï¼Œæ˜¯ä»¥ key-value å­˜å‚¨å½¢å¼å­˜åœ¨ï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾é”®å€¼å¯¹

ç‰¹ç‚¹ï¼š

* HashMapçš„å®ç°ä¸æ˜¯åŒæ­¥çš„ï¼Œè¿™æ„å‘³ç€å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
* keyæ˜¯å”¯ä¸€ä¸é‡å¤çš„ï¼Œåº•å±‚çš„å“ˆå¸Œè¡¨ç»“æ„ï¼Œä¾èµ– hashCode æ–¹æ³•å’Œ equals æ–¹æ³•ä¿è¯é”®çš„å”¯ä¸€
* keyã€value éƒ½å¯ä»¥ä¸ºnullï¼Œä½†æ˜¯ key ä½ç½®åªèƒ½æ˜¯ä¸€ä¸ªnull
* HashMapä¸­çš„æ˜ å°„ä¸æ˜¯æœ‰åºçš„ï¼Œå³å­˜å–æ˜¯æ— åºçš„
* **keyè¦å­˜å‚¨çš„æ˜¯è‡ªå®šä¹‰å¯¹è±¡ï¼Œéœ€è¦é‡å†™hashCodeå’Œequalsæ–¹æ³•ï¼Œé˜²æ­¢å‡ºç°åœ°å€ä¸åŒå†…å®¹ç›¸åŒçš„key**

JDK7 å¯¹æ¯” JDK8ï¼š

* 7 = æ•°ç»„ + é“¾è¡¨ï¼Œ8 = æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘
* 7 ä¸­æ˜¯å¤´æ’æ³•ï¼Œå¤šçº¿ç¨‹å®¹æ˜“é€ æˆç¯ï¼Œ8 ä¸­æ˜¯å°¾æ’æ³•
* 7 çš„æ‰©å®¹æ˜¯å…¨éƒ¨æ•°æ®é‡æ–°å®šä½ï¼Œ8 ä¸­æ˜¯ä½ç½®ä¸å˜æˆ–è€…å½“å‰ä½ç½® + æ—§ size å¤§å°æ¥å®ç°
* 7 æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦è¦æ‰©å®¹å†æ’å…¥ï¼Œ8 ä¸­æ˜¯å…ˆæ’å…¥å†çœ‹æ˜¯å¦è¦æ‰©å®¹

åº•å±‚æ•°æ®ç»“æ„ï¼š

* å“ˆå¸Œè¡¨ï¼ˆHash tableï¼Œä¹Ÿå«æ•£åˆ—è¡¨ï¼‰ï¼Œæ ¹æ®å…³é”®ç å€¼(Key value)è€Œç›´æ¥è®¿é—®çš„æ•°æ®ç»“æ„ã€‚é€šè¿‡æŠŠå…³é”®ç å€¼æ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œä»¥åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ï¼Œè¿™ä¸ªæ˜ å°„å‡½æ•°å«åšæ•£åˆ—å‡½æ•°ï¼Œå­˜æ”¾è®°å½•çš„æ•°ç»„å«åšæ•£åˆ—è¡¨

* JDK1.8 ä¹‹å‰ HashMap ç”± **æ•°ç»„+é“¾è¡¨** ç»„æˆ

  * æ•°ç»„æ˜¯ HashMap çš„ä¸»ä½“
  * é“¾è¡¨åˆ™æ˜¯ä¸ºäº†**è§£å†³å“ˆå¸Œå†²çª**è€Œå­˜åœ¨çš„ï¼ˆ**æ‹‰é“¾æ³•**è§£å†³å†²çªï¼‰ï¼Œæ‹‰é“¾æ³•å°±æ˜¯å¤´æ’æ³•
    ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨çš„hashCodeæ–¹æ³•è®¡ç®—çš„å“ˆå¸Œç å€¼ï¼ˆé”®çš„å“ˆå¸Œï¼‰ä¸€è‡´å¯¼è‡´è®¡ç®—çš„æ•°ç»„ç´¢å¼•å€¼ç›¸åŒ

* JDK1.8 ä»¥å HashMap ç”± **æ•°ç»„+é“¾è¡¨ +çº¢é»‘æ ‘**æ•°æ®ç»“æ„ç»„æˆ

  * è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–
  * **å½“é“¾è¡¨é•¿åº¦è¶…è¿‡ï¼ˆå¤§äºï¼‰é˜ˆå€¼ï¼ˆæˆ–è€…çº¢é»‘æ ‘çš„è¾¹ç•Œå€¼ï¼Œé»˜è®¤ä¸º 8ï¼‰å¹¶ä¸”å½“å‰æ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64æ—¶ï¼Œæ­¤ç´¢å¼•ä½ç½®ä¸Šçš„æ‰€æœ‰æ•°æ®æ”¹ä¸ºçº¢é»‘æ ‘å­˜å‚¨**
  * å³ä½¿å“ˆå¸Œå‡½æ•°å–å¾—å†å¥½ï¼Œä¹Ÿå¾ˆéš¾è¾¾åˆ°å…ƒç´ ç™¾åˆ†ç™¾å‡åŒ€åˆ†å¸ƒã€‚å½“ HashMap ä¸­æœ‰å¤§é‡çš„å…ƒç´ éƒ½å­˜æ”¾åˆ°åŒä¸€ä¸ªæ¡¶ä¸­æ—¶ï¼Œå°±ç›¸å½“äºä¸€ä¸ªé•¿çš„å•é“¾è¡¨ï¼Œå‡å¦‚å•é“¾è¡¨æœ‰ n ä¸ªå…ƒç´ ï¼Œéå†çš„**æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)**ï¼Œæ‰€ä»¥ JDK1.8 ä¸­å¼•å…¥äº† çº¢é»‘æ ‘ï¼ˆæŸ¥æ‰¾**æ—¶é—´å¤æ‚åº¦ä¸º O(logn)**ï¼‰æ¥ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œä½¿å¾—æŸ¥æ‰¾æ•ˆç‡æ›´é«˜
  
  ![](https://gitee.com/seazean/images/raw/master/Java/å“ˆå¸Œè¡¨.png)



***



##### ç»§æ‰¿å…³ç³»

HashMapç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://gitee.com/seazean/images/raw/master/Java/HashMapç»§æ‰¿å…³ç³».bmp)



è¯´æ˜ï¼š

* Cloneable ç©ºæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥å…‹éš†ï¼Œ åˆ›å»ºå¹¶è¿”å›HashMapå¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬ã€‚
* Serializable åºåˆ—åŒ–æ¥å£ï¼Œå±äºæ ‡è®°æ€§æ¥å£ï¼ŒHashMapå¯¹è±¡å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
* AbstractMap çˆ¶ç±»æä¾›äº†Mapå®ç°æ¥å£ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘å®ç°æ­¤æ¥å£æ‰€éœ€çš„å·¥ä½œ



***



##### æˆå‘˜å˜é‡

1. åºåˆ—åŒ–ç‰ˆæœ¬å·

   ```java
   private static final long serialVersionUID = 362498820763181265L;
   ```

2. é›†åˆçš„åˆå§‹åŒ–å®¹é‡( **å¿…é¡»æ˜¯äºŒçš„næ¬¡å¹‚** )

   ```java
   //é»˜è®¤çš„åˆå§‹å®¹é‡æ˜¯16 -- 1<<4ç›¸å½“äº1*2çš„4æ¬¡æ–¹---1*16
   static final int DEFAULT_INITIAL_CAPACITY = 1 << 4;   
   ```

   HashMapæ„é€ æ–¹æ³•æŒ‡å®šé›†åˆçš„åˆå§‹åŒ–å®¹é‡å¤§å°ï¼š

   ```java
   HashMap(int initialCapacity)//æ„é€ ä¸€ä¸ªå¸¦æŒ‡å®šåˆå§‹å®¹é‡å’Œé»˜è®¤åŠ è½½å› å­ (0.75) çš„ç©º HashMap
   ```

   * ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯2çš„næ¬¡å¹‚ï¼Ÿ

     å‘HashMapä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œéœ€è¦æ ¹æ®keyçš„hashå€¼ï¼Œç¡®å®šåœ¨æ•°ç»„ä¸­çš„å…·ä½“ä½ç½®ã€‚HashMapä¸ºäº†å­˜å–é«˜æ•ˆï¼Œè¦å°½é‡è¾ƒå°‘ç¢°æ’ï¼ŒæŠŠæ•°æ®å°½å¯èƒ½åˆ†é…å‡åŒ€ï¼Œæ¯ä¸ªé“¾è¡¨é•¿åº¦å¤§è‡´ç›¸åŒï¼Œå®ç°è¯¥æ–¹æ³•çš„ç®—æ³•å°±æ˜¯å–æ¨¡ï¼Œhash%lengthï¼Œè®¡ç®—æœºä¸­ç›´æ¥æ±‚ä½™æ•ˆç‡ä¸å¦‚ä½ç§»è¿ç®—ï¼Œæ‰€ä»¥æºç ä¸­ä½¿ç”¨ hash&(length-1)ï¼Œå®é™…ä¸Š**hash % length == hash & (length-1)çš„å‰ææ˜¯lengthæ˜¯2çš„næ¬¡å¹‚**

     æ•£åˆ—å¹³å‡åˆ†å¸ƒï¼š2çš„næ¬¡æ–¹æ˜¯1åé¢nä¸ª0ï¼Œ2çš„næ¬¡æ–¹-1 æ˜¯nä¸ª1ï¼Œå¯ä»¥**ä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§**ï¼Œå‡å°‘ç¢°æ’

     ```java
     ä¾‹å¦‚é•¿åº¦ä¸º8æ—¶å€™ï¼Œ3&(8-1)=3  2&(8-1)=2 ï¼Œä¸åŒä½ç½®ä¸Šï¼Œä¸ç¢°æ’ï¼›
     ä¾‹å¦‚é•¿åº¦ä¸º9æ—¶å€™ï¼Œ3&(9-1)=0  2&(9-1)=0 ï¼Œéƒ½åœ¨0ä¸Šï¼Œç¢°æ’äº†ï¼›
     ```
     
   * å¦‚æœè¾“å…¥å€¼ä¸æ˜¯2çš„å¹‚ä¼šæ€ä¹ˆæ ·ï¼Ÿ

     åˆ›å»ºHashMapå¯¹è±¡æ—¶ï¼ŒHashMapé€šè¿‡ä½ç§»è¿ç®—å’Œæˆ–è¿ç®—å¾—åˆ°çš„è‚¯å®šæ˜¯2çš„å¹‚æ¬¡æ•°ï¼Œå¹¶ä¸”æ˜¯å¤§äºé‚£ä¸ªæ•°çš„æœ€è¿‘çš„æ•°å­—ï¼Œåº•å±‚é‡‡ç”¨tableSizeFor()æ–¹æ³•

3. é»˜è®¤çš„è´Ÿè½½å› å­ï¼Œé»˜è®¤å€¼æ˜¯0.75 

    ```java
    static final float DEFAULT_LOAD_FACTOR = 0.75f;
    ```

4. é›†åˆæœ€å¤§å®¹é‡ 

    ```java
    //é›†åˆæœ€å¤§å®¹é‡çš„ä¸Šé™æ˜¯ï¼š2çš„30æ¬¡å¹‚
    static final int MAXIMUM_CAPACITY = 1 << 30;
    ```

    æœ€å¤§å®¹é‡ä¸ºä»€ä¹ˆæ˜¯2çš„30æ¬¡æ–¹åŸå› ï¼š

    * intç±»å‹æ˜¯32ä½æ•´å‹ï¼Œå 4ä¸ªå­—èŠ‚
    * Javaçš„åŸå§‹ç±»å‹é‡Œæ²¡æœ‰æ— ç¬¦å·ç±»å‹ï¼Œæ‰€ä»¥é¦–ä½æ˜¯ç¬¦å·ä½æ­£æ•°ä¸º0ï¼Œè´Ÿæ•°ä¸º1

5. å½“é“¾è¡¨çš„å€¼è¶…è¿‡8åˆ™ä¼šè½¬çº¢é»‘æ ‘ï¼ˆ1.8æ–°å¢**ï¼‰

    ```java
     //å½“æ¡¶(bucket)ä¸Šçš„ç»“ç‚¹æ•°å¤§äºè¿™ä¸ªå€¼æ—¶ä¼šè½¬æˆçº¢é»‘æ ‘
     static final int TREEIFY_THRESHOLD = 8;
    ```

    ä¸ºä»€ä¹ˆMapæ¡¶ä¸­èŠ‚ç‚¹ä¸ªæ•°å¤§äº8æ‰è½¬ä¸ºçº¢é»‘æ ‘ï¼Ÿ

    * åœ¨HashMapä¸­æœ‰ä¸€æ®µæ³¨é‡Šè¯´æ˜ï¼š**ç©ºé—´å’Œæ—¶é—´çš„æƒè¡¡**

      ```java
      TreeNodeså ç”¨ç©ºé—´å¤§çº¦æ˜¯æ™®é€šèŠ‚ç‚¹çš„ä¸¤å€ï¼Œæ‰€ä»¥æˆ‘ä»¬åªåœ¨ç®±å­åŒ…å«è¶³å¤Ÿçš„èŠ‚ç‚¹æ—¶æ‰ä½¿ç”¨æ ‘èŠ‚ç‚¹ã€‚å½“èŠ‚ç‚¹å˜å°‘(ç”±äºåˆ é™¤æˆ–è°ƒæ•´å¤§å°)æ—¶ï¼Œå°±ä¼šè¢«è½¬æ¢å›æ™®é€šçš„æ¡¶ã€‚åœ¨ä½¿ç”¨åˆ†å¸ƒè‰¯å¥½çš„ç”¨æˆ·hashcodeæ—¶ï¼Œå¾ˆå°‘ä½¿ç”¨æ ‘ç®±ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨éšæœºå“ˆå¸Œç ä¸‹ï¼Œç®±å­ä¸­èŠ‚ç‚¹çš„é¢‘ç‡æœä»"æ³Šæ¾åˆ†å¸ƒ"ï¼Œé»˜è®¤è°ƒæ•´é˜ˆå€¼ä¸º0.75ï¼Œå¹³å‡å‚æ•°çº¦ä¸º0.5ï¼Œå°½ç®¡ç”±äºè°ƒæ•´ç²’åº¦çš„å·®å¼‚å¾ˆå¤§ã€‚å¿½ç•¥æ–¹å·®ï¼Œåˆ—è¡¨å¤§å°kçš„é¢„æœŸå‡ºç°æ¬¡æ•°æ˜¯(exp(-0.5)*pow(0.5, k)/factorial(k))
      0:    0.60653066
      1:    0.30326533
      2:    0.07581633
      3:    0.01263606
      4:    0.00157952
      5:    0.00015795
      6:    0.00001316
      7:    0.00000094
      8:    0.00000006
      more: less than 1 in ten million
      ä¸€ä¸ªbinä¸­é“¾è¡¨é•¿åº¦è¾¾åˆ°8ä¸ªå…ƒç´ çš„æ¦‚ç‡ä¸º0.00000006ï¼Œå‡ ä¹æ˜¯ä¸å¯èƒ½äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©8è¿™ä¸ªæ•°å­—
      ```
      
    * å…¶ä»–è¯´æ³•
      çº¢é»‘æ ‘çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦æ˜¯log(n)ï¼Œå¦‚æœé•¿åº¦ä¸º8ï¼Œå¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸ºlog(8)=3ï¼Œé“¾è¡¨çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸ºn/2ï¼Œå½“é•¿åº¦ä¸º8æ—¶ï¼Œå¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸º8/2=4ï¼Œè¿™æ‰æœ‰è½¬æ¢æˆæ ‘çš„å¿…è¦ï¼›é“¾è¡¨é•¿åº¦å¦‚æœæ˜¯å°äºç­‰äº6ï¼Œ6/2=3ï¼Œè€Œlog(6)=2.6ï¼Œè™½ç„¶é€Ÿåº¦ä¹Ÿå¾ˆå¿«çš„ï¼Œä½†è½¬åŒ–ä¸ºæ ‘ç»“æ„å’Œç”Ÿæˆæ ‘çš„æ—¶é—´å¹¶ä¸çŸ­

    

6. å½“é“¾è¡¨çš„å€¼å°äº6åˆ™ä¼šä»çº¢é»‘æ ‘è½¬å›é“¾è¡¨

    ```java
    //å½“æ¡¶(bucket)ä¸Šçš„ç»“ç‚¹æ•°å°äºè¿™ä¸ªå€¼æ—¶æ ‘è½¬é“¾è¡¨
    static final int UNTREEIFY_THRESHOLD = 6;
    ```

7. å½“Mapé‡Œé¢çš„æ•°é‡**å¤§äºç­‰äº**è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œè¡¨ä¸­çš„æ¡¶æ‰èƒ½è¿›è¡Œæ ‘å½¢åŒ– ï¼Œå¦åˆ™æ¡¶å†…å…ƒç´ å¤ªå¤šæ—¶ä¼šæ‰©å®¹ï¼Œè€Œä¸æ˜¯æ ‘å½¢åŒ–ã€‚ä¸ºäº†é¿å…è¿›è¡Œæ‰©å®¹ã€æ ‘å½¢åŒ–é€‰æ‹©çš„å†²çªï¼Œè¿™ä¸ªå€¼ä¸èƒ½å°äº 4 * TREEIFY_THRESHOLD (8)

    ```java
    //æ¡¶ä¸­ç»“æ„è½¬åŒ–ä¸ºçº¢é»‘æ ‘å¯¹åº”çš„æ•°ç»„é•¿åº¦æœ€å°çš„å€¼ 
    static final int MIN_TREEIFY_CAPACITY = 64;
    ```

    åŸå› ï¼šæ•°ç»„æ¯”è¾ƒå°çš„æƒ…å†µä¸‹å˜ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼Œåè€Œä¼šé™ä½æ•ˆç‡ï¼Œçº¢é»‘æ ‘éœ€è¦è¿›è¡Œå·¦æ—‹ï¼Œå³æ—‹ï¼Œå˜è‰²è¿™äº›æ“ä½œæ¥ä¿æŒå¹³è¡¡ã€‚åŒæ—¶æ•°ç»„é•¿åº¦å°äº64æ—¶ï¼Œæœç´¢æ—¶é—´ç›¸å¯¹å¿«äº›ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘æœç´¢æ—¶é—´ï¼Œåº•å±‚åœ¨é˜ˆå€¼å¤§äº8å¹¶ä¸”æ•°ç»„é•¿åº¦å¤§äº64æ—¶ï¼Œé“¾è¡¨æ‰è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œæ•ˆç‡ä¹Ÿå˜çš„æ›´é«˜æ•ˆ

8. tableç”¨æ¥åˆå§‹åŒ–(å¿…é¡»æ˜¯äºŒçš„næ¬¡å¹‚)(é‡ç‚¹)

    ```java
    //å­˜å‚¨å…ƒç´ çš„æ•°ç»„ 
    transient Node<K,V>[] table;
    ```

    jdk8ä¹‹å‰æ•°ç»„ç±»å‹æ˜¯Entry<K,V>ç±»å‹ï¼Œä»jdk1.8ä¹‹åæ˜¯Node<K,V>ç±»å‹ã€‚åªæ˜¯æ¢äº†ä¸ªåå­—ï¼Œéƒ½å®ç°äº†ä¸€æ ·çš„æ¥å£ï¼šMap.Entry<K,V>ï¼Œè´Ÿè´£å­˜å‚¨é”®å€¼å¯¹æ•°æ®çš„

 9. HashMapä¸­å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°(**é‡ç‚¹**)

    ```java
    //å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°ï¼ŒHashMapä¸­K-Vçš„å®æ—¶æ•°é‡ï¼Œä¸æ˜¯tableæ•°ç»„çš„é•¿åº¦
    transient int size;
    ```

10. è®°å½•HashMapçš„ä¿®æ”¹æ¬¡æ•° 

    ```java
    //æ¯æ¬¡æ‰©å®¹å’Œæ›´æ”¹mapç»“æ„çš„è®¡æ•°å™¨
     transient int modCount;  
    ```

11. è°ƒæ•´å¤§å°ä¸‹ä¸€ä¸ªå®¹é‡çš„å€¼è®¡ç®—æ–¹å¼ä¸º(å®¹é‡*è´Ÿè½½å› å­) 

     ```java
     //ä¸´ç•Œå€¼ï¼Œå½“å®é™…å¤§å°(å®¹é‡*è´Ÿè½½å› å­)è¶…è¿‡ä¸´ç•Œå€¼æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹
     int threshold;
     ```

12. **å“ˆå¸Œè¡¨çš„åŠ è½½å› å­(é‡ç‚¹)**

    ```java
     final float loadFactor;
    ```
    
    * åŠ è½½å› å­çš„æ¦‚è¿°
    
      loadFactoråŠ è½½å› å­ï¼Œæ˜¯ç”¨æ¥è¡¡é‡ HashMap æ»¡çš„ç¨‹åº¦ï¼Œè¡¨ç¤º**HashMapçš„ç–å¯†ç¨‹åº¦**ï¼Œå½±å“hashæ“ä½œåˆ°åŒä¸€ä¸ªæ•°ç»„ä½ç½®çš„æ¦‚ç‡ï¼Œè®¡ç®—HashMapçš„å®æ—¶åŠ è½½å› å­çš„æ–¹æ³•ä¸ºï¼šsize/capacityï¼Œè€Œä¸æ˜¯å ç”¨æ¡¶çš„æ•°é‡å»é™¤ä»¥capacityï¼Œcapacity æ˜¯æ¡¶çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ table çš„é•¿åº¦lengthã€‚
    
      å½“HashMapé‡Œé¢å®¹çº³çš„å…ƒç´ å·²ç»è¾¾åˆ°HashMapæ•°ç»„é•¿åº¦çš„75%æ—¶ï¼Œè¡¨ç¤ºHashMapæ‹¥æŒ¤ï¼Œéœ€è¦æ‰©å®¹ï¼Œè€Œæ‰©å®¹è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ° rehashã€å¤åˆ¶æ•°æ®ç­‰æ“ä½œï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥å¼€å‘ä¸­å°½é‡å‡å°‘æ‰©å®¹çš„æ¬¡æ•°ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºHashMapé›†åˆå¯¹è±¡æ—¶æŒ‡å®šåˆå§‹å®¹é‡æ¥å°½é‡é¿å…ã€‚
    
      ```java
      HashMap(int initialCapacity, float loadFactor)//æ„é€ æŒ‡å®šåˆå§‹å®¹é‡å’ŒåŠ è½½å› å­çš„ç©ºHashMap
      ```
    
    * ä¸ºä»€ä¹ˆåŠ è½½å› å­è®¾ç½®ä¸º0.75ï¼Œåˆå§‹åŒ–ä¸´ç•Œå€¼æ˜¯12ï¼Ÿ
    
      loadFactorå¤ªå¤§å¯¼è‡´æŸ¥æ‰¾å…ƒç´ æ•ˆç‡ä½ï¼Œå­˜æ”¾çš„æ•°æ®æ‹¥æŒ¤ï¼Œå¤ªå°å¯¼è‡´æ•°ç»„çš„åˆ©ç”¨ç‡ä½ï¼Œå­˜æ”¾çš„æ•°æ®ä¼šå¾ˆåˆ†æ•£ã€‚loadFactorçš„é»˜è®¤å€¼ä¸º**0.75fæ˜¯å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¸´ç•Œå€¼**ã€‚
    
    * **threshold**è®¡ç®—å…¬å¼ï¼šcapacity(æ•°ç»„é•¿åº¦é»˜è®¤16) * loadFactor(è´Ÿè½½å› å­é»˜è®¤0.75)ã€‚è¿™ä¸ªå€¼æ˜¯å½“å‰å·²å ç”¨æ•°ç»„é•¿åº¦çš„æœ€å¤§å€¼ã€‚**å½“Size>=threshold**çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘å¯¹æ•°ç»„çš„resize(æ‰©å®¹)ï¼Œè¿™å°±æ˜¯ **è¡¡é‡æ•°ç»„æ˜¯å¦éœ€è¦æ‰©å¢çš„ä¸€ä¸ªæ ‡å‡†**ï¼Œ æ‰©å®¹åçš„ HashMap å®¹é‡æ˜¯ä¹‹å‰å®¹é‡çš„**ä¸¤å€**.



***



##### æ„é€ æ–¹æ³•

1. æ„é€ ä¸€ä¸ªç©ºçš„ HashMap ï¼Œ**é»˜è®¤åˆå§‹å®¹é‡ï¼ˆ16ï¼‰å’Œé»˜è®¤è´Ÿè½½å› å­ï¼ˆ0.75ï¼‰**

   ```java
   public HashMap() {
   	this.loadFactor = DEFAULT_LOAD_FACTOR; 
   	//å°†é»˜è®¤çš„åŠ è½½å› å­0.75èµ‹å€¼ç»™loadFactorï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ•°ç»„
   }
   ```

2. æ„é€ ä¸€ä¸ªå…·æœ‰æŒ‡å®šçš„åˆå§‹å®¹é‡å’Œé»˜è®¤è´Ÿè½½å› å­ï¼ˆ0.75ï¼‰HashMap

   ```java
   // æŒ‡å®šâ€œå®¹é‡å¤§å°â€çš„æ„é€ å‡½æ•°
   public HashMap(int initialCapacity) {
       this(initialCapacity, DEFAULT_LOAD_FACTOR);
   }
   ```

3. æ„é€ ä¸€ä¸ªå…·æœ‰æŒ‡å®šçš„åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­çš„HashMap

   ```java
   public HashMap(int initialCapacity, float loadFactor) {
       //è¿›è¡Œåˆ¤æ–­
       //å°†æŒ‡å®šçš„åŠ è½½å› å­èµ‹å€¼ç»™HashMapæˆå‘˜å˜é‡çš„è´Ÿè½½å› å­loadFactor
       this.loadFactor = loadFactor;
     	//æœ€åè°ƒç”¨äº†tableSizeFor
       this.threshold = tableSizeFor(initialCapacity);
   }
   ```

   * å¯¹äº`this.threshold = tableSizeFor(initialCapacity);` 

     æœ‰äº›äººä¼šè§‰å¾—è¿™é‡Œæ˜¯ä¸€ä¸ªbugåº”è¯¥è¿™æ ·ä¹¦å†™ï¼š
     `this.threshold = tableSizeFor(initialCapacity) * this.loadFactor;`
     è¿™æ ·æ‰ç¬¦åˆ threshold çš„æ¦‚å¿µï¼Œä½†æ˜¯åœ¨ jdk8 ä»¥åçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰å¯¹ table è¿™ä¸ªæˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œtable çš„åˆå§‹åŒ–è¢«æ¨è¿Ÿåˆ°äº† put æ–¹æ³•ä¸­ï¼Œåœ¨ put æ–¹æ³•ä¸­ä¼šå¯¹ threshold é‡æ–°è®¡ç®—
   
4. åŒ…å«å¦ä¸€ä¸ª`Map`çš„æ„é€ å‡½æ•° 

   ```java
   //æ„é€ ä¸€ä¸ªæ˜ å°„å…³ç³»ä¸æŒ‡å®š Map ç›¸åŒçš„æ–° HashMap
   public HashMap(Map<? extends K, ? extends V> m) {
       //è´Ÿè½½å› å­loadFactorå˜ä¸ºé»˜è®¤çš„è´Ÿè½½å› å­0.75
       this.loadFactor = DEFAULT_LOAD_FACTOR;
       putMapEntries(m, false);
   }
   ```

   putMapEntriesæºç åˆ†æï¼š

   ```java
   final void putMapEntries(Map<? extends K, ? extends V> m, boolean evict) {
       //è·å–å‚æ•°é›†åˆçš„é•¿åº¦
       int s = m.size();
       if (s > 0) {
           //åˆ¤æ–­å‚æ•°é›†åˆçš„é•¿åº¦æ˜¯å¦å¤§äº0
           if (table == null) {  // åˆ¤æ–­tableæ˜¯å¦å·²ç»åˆå§‹åŒ–
               // pre-size
               // æœªåˆå§‹åŒ–ï¼Œsä¸ºmçš„å®é™…å…ƒç´ ä¸ªæ•°
               float ft = ((float)s / loadFactor) + 1.0F;
               int t = ((ft < (float)MAXIMUM_CAPACITY) ?
                        (int)ft : MAXIMUM_CAPACITY);
               // è®¡ç®—å¾—åˆ°çš„tå¤§äºé˜ˆå€¼ï¼Œåˆ™åˆå§‹åŒ–é˜ˆå€¼
               if (t > threshold)
                   threshold = tableSizeFor(t);
           }
           // å·²åˆå§‹åŒ–ï¼Œå¹¶ä¸”må…ƒç´ ä¸ªæ•°å¤§äºé˜ˆå€¼ï¼Œè¿›è¡Œæ‰©å®¹å¤„ç†
           else if (s > threshold)
               resize();
           // å°†mä¸­çš„æ‰€æœ‰å…ƒç´ æ·»åŠ è‡³HashMapä¸­
           for (Map.Entry<? extends K, ? extends V> e : m.entrySet()) {
               K key = e.getKey();
               V value = e.getValue();
               putVal(hash(key), key, value, false, evict);
           }
       }
   }
   ```

   `float ft = ((float)s / loadFactor) + 1.0F;`è¿™ä¸€è¡Œä»£ç ä¸­ä¸ºä»€ä¹ˆè¦åŠ 1.0F ï¼Ÿ

   s / loadFactorçš„ç»“æœæ˜¯å°æ•°ï¼ŒåŠ 1.0Fç›¸å½“äºæ˜¯å¯¹å°æ•°åšä¸€ä¸ªå‘ä¸Šå–æ•´ä»¥å°½å¯èƒ½çš„ä¿è¯æ›´å¤§å®¹é‡ï¼Œæ›´å¤§çš„å®¹é‡èƒ½å¤Ÿå‡å°‘resizeçš„è°ƒç”¨æ¬¡æ•°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°ç»„çš„æ‰©å®¹



***



##### æˆå‘˜æ–¹æ³•

1. hash

   HashMapæ˜¯æ”¯æŒKeyä¸ºç©ºçš„ï¼›HashTableæ˜¯ç›´æ¥ç”¨Keyæ¥è·å–HashCodeï¼Œkeyä¸ºç©ºä¼šæŠ›å¼‚å¸¸

   * &ï¼ˆæŒ‰ä½ä¸è¿ç®—ï¼‰ï¼šç›¸åŒçš„äºŒè¿›åˆ¶æ•°ä½ä¸Šï¼Œéƒ½æ˜¯1çš„æ—¶å€™ï¼Œç»“æœä¸º1ï¼Œå¦åˆ™ä¸ºé›¶
   * ^ï¼ˆæŒ‰ä½å¼‚æˆ–è¿ç®—ï¼‰ï¼šç›¸åŒçš„äºŒè¿›åˆ¶æ•°ä½ä¸Šï¼Œæ•°å­—ç›¸åŒï¼Œç»“æœä¸º0ï¼Œä¸åŒä¸º1ï¼Œ**ä¸è¿›ä½åŠ æ³•**
   
   ```java
   static final int hash(Object key) {
       int h;
       // 1ï¼‰å¦‚æœkeyç­‰äºnullï¼šå¯ä»¥çœ‹åˆ°å½“keyç­‰äºnullçš„æ—¶å€™ä¹Ÿæ˜¯æœ‰å“ˆå¸Œå€¼çš„ï¼Œè¿”å›çš„æ˜¯0.
       // 2ï¼‰å¦‚æœkeyä¸ç­‰äºnullï¼šé¦–å…ˆè®¡ç®—å‡ºkeyçš„hashCodeèµ‹å€¼ç»™h,ç„¶åä¸hæ— ç¬¦å·å³ç§»16ä½åçš„äºŒè¿›åˆ¶è¿›è¡ŒæŒ‰ä½å¼‚æˆ–å¾—åˆ°æœ€åçš„hashå€¼
       return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
   }
   ```
   
   è®¡ç®— hash çš„æ–¹æ³•ï¼šå°†hashCodeæ— ç¬¦å·å³ç§»16ä½ï¼Œé«˜16bit å’Œä½16bit åšäº†ä¸€ä¸ªå¼‚æˆ–
   
   åŸå› ï¼šå½“æ•°ç»„é•¿åº¦å¾ˆå°ï¼Œå‡è®¾æ˜¯16ï¼Œé‚£ä¹ˆ n-1å³ä¸º 1111 ï¼Œè¿™æ ·çš„å€¼å’ŒhashCode()ç›´æ¥åšæŒ‰ä½ä¸æ“ä½œï¼Œå®é™…ä¸Šåªä½¿ç”¨äº†å“ˆå¸Œå€¼çš„å4ä½ã€‚å¦‚æœå½“å“ˆå¸Œå€¼çš„é«˜ä½å˜åŒ–å¾ˆå¤§ï¼Œä½ä½å˜åŒ–å¾ˆå°ï¼Œå°±å¾ˆå®¹æ˜“é€ æˆå“ˆå¸Œå†²çªäº†ï¼Œæ‰€ä»¥è¿™é‡Œ**æŠŠé«˜ä½ä½éƒ½åˆ©ç”¨èµ·æ¥ï¼Œè®©é«˜16ä½ä¹Ÿå‚ä¸è¿ç®—**ï¼Œä»è€Œè§£å†³äº†è¿™ä¸ªé—®é¢˜
   
   å“ˆå¸Œå†²çªçš„å¤„ç†æ–¹å¼ï¼š
   
   * å¼€æ”¾å®šå€æ³•ï¼šçº¿æ€§æ¢æŸ¥æ³•ï¼ˆThreadLocalMapéƒ¨åˆ†è¯¦è§£ï¼‰ï¼Œå¹³æ–¹æ¢æŸ¥æ³•ï¼ˆi + 1^2ã€i - 1^2ã€i + 2^2â€¦â€¦ï¼‰ã€åŒé‡æ•£åˆ—ï¼ˆå¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼‰
   * é“¾åœ°å€æ³•ï¼šæ‹‰é“¾æ³•
   
   
   
2. put

   jdk1.8 å‰æ˜¯å¤´æ’æ³• (æ‹‰é“¾æ³•)ï¼Œå¤šçº¿ç¨‹ä¸‹æ‰©å®¹å‡ºç°å¾ªç¯é“¾è¡¨ï¼Œjdk1.8 ä»¥åå¼•å…¥çº¢é»‘æ ‘ï¼Œæ’å…¥æ–¹æ³•å˜æˆå°¾æ’æ³•

   ç¬¬ä¸€æ¬¡è°ƒç”¨ put æ–¹æ³•æ—¶åˆ›å»ºæ•°ç»„ Node[] tableï¼Œå› ä¸ºæ•£åˆ—è¡¨è€—è´¹å†…å­˜ï¼Œä¸ºäº†é˜²æ­¢å†…å­˜æµªè´¹ï¼Œæ‰€ä»¥**å»¶è¿Ÿåˆå§‹åŒ–**

   å­˜å‚¨æ•°æ®æ­¥éª¤ï¼ˆå­˜å‚¨è¿‡ç¨‹ï¼‰ï¼š

   1. å…ˆé€šè¿‡hashå€¼è®¡ç®—å‡ºkeyæ˜ å°„åˆ°å“ªä¸ªæ¡¶

   2. å¦‚æœæ¡¶ä¸Šæ²¡æœ‰ç¢°æ’å†²çªï¼Œåˆ™ç›´æ¥æ’å…¥

   3. å¦‚æœå‡ºç°ç¢°æ’å†²çªï¼šå¦‚æœè¯¥æ¡¶ä½¿ç”¨çº¢é»‘æ ‘å¤„ç†å†²çªï¼Œåˆ™è°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•æ’å…¥æ•°æ®ï¼›å¦åˆ™é‡‡ç”¨ä¼ ç»Ÿçš„é“¾å¼æ–¹æ³•æ’å…¥ï¼Œå¦‚æœé“¾çš„é•¿åº¦è¾¾åˆ°ä¸´ç•Œå€¼ï¼Œåˆ™æŠŠé“¾è½¬å˜ä¸ºçº¢é»‘æ ‘

   4. å¦‚æœæ•°ç»„ä½ç½®ç›¸åŒï¼Œé€šè¿‡equalsæ¯”è¾ƒå†…å®¹æ˜¯å¦ç›¸åŒï¼šç›¸åŒåˆ™æ–°çš„valueè¦†ç›–ä¹‹å‰çš„valueï¼Œä¸ç›¸åŒåˆ™å°†æ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­
   5. å¦‚æœsizeå¤§äºé˜ˆå€¼thresholdï¼Œåˆ™è¿›è¡Œæ‰©å®¹

   ```java
   public V put(K key, V value) {
       return putVal(hash(key), key, value, false, true);
   }
   ```

   putVal()æ–¹æ³•ä¸­keyåœ¨è¿™é‡Œæ‰§è¡Œäº†ä¸€ä¸‹hash()ï¼Œåœ¨putValå‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†ä¸Šè¿°hashå‡½æ•°è®¡ç®—çš„å“ˆå¸Œå€¼ï¼š

   ```java
   final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) {
   	//ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
   	if ((p = tab[i = (n - 1) & hash]) == null){//è¿™é‡Œçš„nè¡¨ç¤ºæ•°ç»„é•¿åº¦16
   		//.....
       } else {
           if (e != null) { // existing mapping for key
               V oldValue = e.value;
               //onlyIfAbsenté»˜è®¤ä¸ºfalseï¼Œæ‰€ä»¥å¯ä»¥è¦†ç›–å·²ç»å­˜åœ¨çš„æ•°æ®ï¼Œå¦‚æœä¸ºtrueè¯´æ˜ä¸èƒ½è¦†ç›–
               if (!onlyIfAbsent || oldValue == null)
                   e.value = value;
               afterNodeAccess(e);
               return oldValue;
           }
       }
   }
   ```

   * `(n - 1) & hash`ï¼šè®¡ç®—ä¸‹æ ‡ä½ç½®

   <img src="https://gitee.com/seazean/images/raw/master/Java/HashMap-putValå“ˆå¸Œè¿ç®—.png" style="zoom: 67%;" />

   * ä½™æ•°æœ¬è´¨æ˜¯ä¸æ–­åšé™¤æ³•ï¼ŒæŠŠå‰©ä½™çš„æ•°å‡å»ï¼Œè¿ç®—æ•ˆç‡è¦æ¯”ä½è¿ç®—ä½

   

3. treeifyBin

   èŠ‚ç‚¹æ·»åŠ å®Œæˆä¹‹ååˆ¤æ–­æ­¤æ—¶èŠ‚ç‚¹ä¸ªæ•°æ˜¯å¦å¤§äºTREEIFY_THRESHOLDä¸´ç•Œå€¼8ï¼Œå¦‚æœå¤§äºåˆ™å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè½¬æ¢çº¢é»‘æ ‘çš„æ–¹æ³• treeifyBinï¼Œæ•´ä½“ä»£ç å¦‚ä¸‹ï¼š

   ```java
   if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
      //è½¬æ¢ä¸ºçº¢é»‘æ ‘ tabè¡¨ç¤ºæ•°ç»„å  hashè¡¨ç¤ºå“ˆå¸Œå€¼
      treeifyBin(tab, hash);
   ```

   1. å¦‚æœå½“å‰æ•°ç»„ä¸ºç©ºæˆ–è€…æ•°ç»„çš„é•¿åº¦å°äºè¿›è¡Œæ ‘å½¢åŒ–çš„é˜ˆå€¼(MIN_TREEIFY_CAPACITY = 64)å°±å»æ‰©å®¹ï¼Œè€Œä¸æ˜¯å°†èŠ‚ç‚¹å˜ä¸ºçº¢é»‘æ ‘
   2. å¦‚æœæ˜¯æ ‘å½¢åŒ–éå†æ¡¶ä¸­çš„å…ƒç´ ï¼Œåˆ›å»ºç›¸åŒä¸ªæ•°çš„æ ‘å½¢èŠ‚ç‚¹ï¼Œå¤åˆ¶å†…å®¹ï¼Œå»ºç«‹èµ·è”ç³»ï¼Œç±»ä¼¼å•å‘é“¾è¡¨è½¬æ¢ä¸ºåŒå‘é“¾è¡¨
   3. è®©æ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å³æ•°ç»„ä¸­çš„å…ƒç´ æŒ‡å‘æ–°å»ºçš„çº¢é»‘æ ‘çš„èŠ‚ç‚¹ï¼Œä»¥åè¿™ä¸ªæ¡¶é‡Œçš„å…ƒç´ å°±æ˜¯çº¢é»‘æ ‘è€Œä¸æ˜¯é“¾è¡¨æ•°æ®ç»“æ„äº†

   

4. tableSizeFor
   åˆ›å»º HashMap æŒ‡å®šå®¹é‡æ—¶ï¼ŒHashMap é€šè¿‡ä½ç§»è¿ç®—å’Œæˆ–è¿ç®—å¾—åˆ°æ¯”æŒ‡å®šåˆå§‹åŒ–å®¹é‡å¤§çš„æœ€å°çš„2çš„ n æ¬¡å¹‚

   ```java
   static final int tableSizeFor(int cap) {//int cap = 10
       int n = cap - 1;
       n |= n >>> 1;
       n |= n >>> 2;
       n |= n >>> 4;
       n |= n >>> 8;
       n |= n >>> 16;
       return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
   }
   ```

   åˆ†æç®—æ³•ï¼š

   1. `int n = cap - 1`ï¼šé˜²æ­¢ cap å·²ç»æ˜¯ 2 çš„å¹‚ã€‚å¦‚æœ cap å·²ç»æ˜¯ 2 çš„å¹‚ï¼Œ ä¸æ‰§è¡Œå‡ 1 æ“ä½œï¼Œåˆ™æ‰§è¡Œå®Œåé¢çš„æ— ç¬¦å·å³ç§»æ“ä½œä¹‹åï¼Œè¿”å›çš„ capacity å°†æ˜¯è¿™ä¸ª cap çš„ 2 å€
   2. n=0 ï¼ˆcap-1 ä¹‹åï¼‰ï¼Œåˆ™ç»è¿‡åé¢çš„å‡ æ¬¡æ— ç¬¦å·å³ç§»ä¾ç„¶æ˜¯ 0ï¼Œè¿”å›çš„ capacity æ˜¯ 1ï¼Œæœ€åæœ‰ n+1
   3. |ï¼ˆæŒ‰ä½æˆ–è¿ç®—ï¼‰ï¼šç›¸åŒçš„äºŒè¿›åˆ¶æ•°ä½ä¸Šï¼Œéƒ½æ˜¯ 0 çš„æ—¶å€™ï¼Œç»“æœä¸º 0ï¼Œå¦åˆ™ä¸º 1
   4. æ ¸å¿ƒæ€æƒ³ï¼šæŠŠæœ€é«˜ä½æ˜¯ 1 çš„ä½ä»¥åŠå³è¾¹çš„ä½å…¨éƒ¨ç½® 1ï¼Œç»“æœåŠ  1 åå°±æ˜¯æœ€å°çš„2çš„ n æ¬¡å¹‚

   ä¾‹å¦‚åˆå§‹åŒ–çš„å€¼ä¸º 10ï¼š

   * ç¬¬ä¸€æ¬¡å³ç§»

     ```java
     int n = cap - 1;//cap=10  n=9
     n |= n >>> 1;
     00000000 00000000 00000000 00001001 //9
     00000000 00000000 00000000 00000100 //9å³ç§»ä¹‹åå˜ä¸º4
     --------------------------------------------------
     00000000 00000000 00000000 00001101 //æŒ‰ä½æˆ–ä¹‹åæ˜¯13
     //ä½¿å¾—nçš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ä¸æœ€é«˜ä½çš„1ç´§é‚»çš„å³è¾¹ä¸€ä½ä¸º1
     ```

   * ç¬¬äºŒæ¬¡å³ç§»

     ```java
     n |= n >>> 2;//né€šè¿‡ç¬¬ä¸€æ¬¡å³ç§»å˜ä¸ºäº†ï¼šn=13
     00000000 00000000 00000000 00001101  // 13
     00000000 00000000 00000000 00000011  // 13å³ç§»ä¹‹åå˜ä¸º3
     -------------------------------------------------
     00000000 00000000 00000000 00001111	 //æŒ‰ä½æˆ–ä¹‹åæ˜¯15
     //æ— ç¬¦å·å³ç§»ä¸¤ä½ï¼Œä¼šå°†æœ€é«˜ä½ä¸¤ä¸ªè¿ç»­çš„1å³ç§»ä¸¤ä½ï¼Œç„¶åå†ä¸åŸæ¥çš„nåšæˆ–æ“ä½œï¼Œè¿™æ ·nçš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„é«˜ä½ä¸­ä¼šæœ‰4ä¸ªè¿ç»­çš„1
     ```

     æ³¨æ„ï¼šå®¹é‡æœ€å¤§æ˜¯ 32bit çš„æ­£æ•°ï¼Œå› æ­¤æœ€å `n |= n >>> 16`ï¼Œæœ€å¤šæ˜¯ 32 ä¸ª 1ï¼ˆä½†æ˜¯è¿™å·²ç»æ˜¯è´Ÿæ•°äº†ï¼‰ã€‚åœ¨æ‰§è¡Œ tableSizeFor ä¹‹å‰ï¼Œå¯¹ initialCapacity åšäº†åˆ¤æ–­ï¼Œå¦‚æœå¤§äº MAXIMUM_CAPACITY(2 ^ 30)ï¼Œåˆ™å– MAXIMUM_CAPACITYï¼›å¦‚æœå°äº MAXIMUM_CAPACITY(2 ^ 30)ï¼Œä¼šæ‰§è¡Œç§»ä½æ“ä½œï¼Œæ‰€ä»¥ç§»ä½æ“ä½œä¹‹åï¼Œæœ€å¤§ 30 ä¸ª 1ï¼ŒåŠ  1 ä¹‹åå¾— 2 ^ 30

   * å¾—åˆ°çš„ capacity è¢«èµ‹å€¼ç»™äº† threshold

     ```java
     this.threshold = tableSizeFor(initialCapacity);//initialCapacity=10
     ```

   * JDK 11

     ```java
     static final int tableSizeFor(int cap) {
         //æ— ç¬¦å·å³ç§»ï¼Œé«˜ä½è¡¥0
     	//-1è¡¥ç : 11111111 11111111 11111111 11111111
         int n = -1 >>> Integer.numberOfLeadingZeros(cap - 1);
         return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
     }
     //è¿”å›æœ€é«˜ä½ä¹‹å‰çš„0çš„ä½æ•°
     public static int numberOfLeadingZeros(int i) {
         if (i <= 0)
             return i == 0 ? 32 : 0;
         // å¦‚æœi>0ï¼Œé‚£ä¹ˆå°±è¡¨æ˜åœ¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸­å…¶è‡³å°‘æœ‰ä¸€ä½ä¸º1
         int n = 31;
         // içš„æœ€é«˜ä½1åœ¨é«˜16ä½ï¼ŒæŠŠiå³ç§»16ä½ï¼Œè®©æœ€é«˜ä½1è¿›å…¥ä½16ä½ç»§ç»­é€’è¿›åˆ¤æ–­
         if (i >= 1 << 16) { n -= 16; i >>>= 16; }
         if (i >= 1 <<  8) { n -=  8; i >>>=  8; }
         if (i >= 1 <<  4) { n -=  4; i >>>=  4; }
         if (i >= 1 <<  2) { n -=  2; i >>>=  2; }
         return n - (i >>> 1);
     }
     ```

     

5. resize

   å½“ HashMap ä¸­çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡`(æ•°ç»„é•¿åº¦)*loadFactor(è´Ÿè½½å› å­)`æˆ–è€…é“¾è¡¨è¿‡é•¿æ—¶ï¼Œå°±ä¼šè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œåˆ›å»ºæ–°çš„æ•°ç»„ï¼Œä¼´éšä¸€æ¬¡é‡æ–° hash åˆ†é…ï¼Œå¹¶ä¸”éå† hash è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ éå¸¸è€—æ—¶ï¼Œæ‰€ä»¥è¦å°½é‡é¿å… resize

   æ‰©å®¹æœºåˆ¶ä¸ºæ‰©å®¹ä¸ºåŸæ¥å®¹é‡çš„ 2 å€ï¼š

   ```java
   if (oldCap > 0) {
       if (oldCap >= MAXIMUM_CAPACITY) {
           threshold = Integer.MAX_VALUE;
           return oldTab;
       }
       else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&
                oldCap >= DEFAULT_INITIAL_CAPACITY)
           newThr = oldThr << 1; // double threshold
   }
   else if (oldThr > 0) // åˆå§‹åŒ–çš„thresholdèµ‹å€¼ç»™newCap
       newCap = oldThr;
   else {               // zero initial threshold signifies using defaults
       newCap = DEFAULT_INITIAL_CAPACITY;
       newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
   }
   ```
   
   HashMap åœ¨è¿›è¡Œæ‰©å®¹åï¼ŒèŠ‚ç‚¹**è¦ä¹ˆå°±åœ¨åŸæ¥çš„ä½ç½®ï¼Œè¦ä¹ˆå°±è¢«åˆ†é…åˆ°"åŸä½ç½®+æ—§å®¹é‡"çš„ä½ç½®**
   
   åˆ¤æ–­ï¼še.hash ä¸ oldCap å¯¹åº”çš„æœ‰æ•ˆé«˜ä½ä¸Šçš„å€¼æ˜¯ 1ï¼Œå³å½“å‰æ•°ç»„é•¿åº¦ n ä¸º 1 çš„ä½ä¸º  xï¼Œå¦‚æœ key çš„å“ˆå¸Œå€¼ x ä½ä¹Ÿä¸º 1ï¼Œåˆ™æ‰©å®¹åçš„ç´¢å¼•ä¸º now + n
   
   æ³¨æ„ï¼šè¿™é‡Œä¹Ÿè¦æ±‚**æ•°ç»„é•¿åº¦ 2 çš„å¹‚**
   
   ![](https://gitee.com/seazean/images/raw/master/Java/HashMap-resizeæ‰©å®¹.png)
   
   æ™®é€šèŠ‚ç‚¹ï¼š
   
   ```java
   //oldCapæ—§æ•°ç»„å¤§å°
   if ((e.hash & oldCap) == 0) {
       if (loTail == null)
           loHead = e;
       else
           loTail.next = e;
       loTail = e;
   }
   else {
       if (hiTail == null)
           hiHead = e;
       else
           hiTail.next = e;
       hiTail = e;
   }
   ```
   
   çº¢é»‘æ ‘èŠ‚ç‚¹ï¼šæ‰©å®¹æ—¶ split æ–¹æ³•ä¼šå°†æ ‘**æ‹†æˆé«˜ä½å’Œä½ä½ä¸¤ä¸ªé“¾è¡¨**ï¼Œåˆ¤æ–­é•¿åº¦æ˜¯å¦å°äºç­‰äº6
   
   ```java
   //å¦‚æœä½ä½é“¾è¡¨é¦–èŠ‚ç‚¹ä¸ä¸ºnullï¼Œè¯´æ˜æœ‰è¿™ä¸ªé“¾è¡¨å­˜åœ¨
   if (loHead != null) {
       //å¦‚æœé“¾è¡¨ä¸‹çš„å…ƒç´ å°äºç­‰äº6
       if (lc <= UNTREEIFY_THRESHOLD)
           //é‚£å°±ä»çº¢é»‘æ ‘è½¬é“¾è¡¨äº†ï¼Œä½ä½é“¾è¡¨ï¼Œè¿ç§»åˆ°æ–°æ•°ç»„ä¸­ä¸‹æ ‡ä¸å˜ï¼Œè¿˜æ˜¯ç­‰äºåŸæ•°ç»„åˆ°ä¸‹æ ‡
           tab[index] = loHead.untreeify(map);
       else {
           //ä½ä½é“¾è¡¨ï¼Œè¿ç§»åˆ°æ–°æ•°ç»„ä¸­ä¸‹æ ‡ä¸å˜ï¼ŒæŠŠä½ä½é“¾è¡¨æ•´ä¸ªèµ‹å€¼åˆ°è¿™ä¸ªä¸‹æ ‡ä¸‹
           tab[index] = loHead;
           //å¦‚æœé«˜ä½é¦–èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè¯´æ˜åŸæ¥çš„çº¢é»‘æ ‘å·²ç»è¢«æ‹†åˆ†æˆä¸¤ä¸ªé“¾è¡¨äº†
           if (hiHead != null)
               //éœ€è¦æ„å»ºæ–°çš„çº¢é»‘æ ‘äº†
               loHead.treeify(tab);
       }
   }
   ```

â€‹	

4. remove
   åˆ é™¤æ˜¯é¦–å…ˆå…ˆæ‰¾åˆ°å…ƒç´ çš„ä½ç½®ï¼Œå¦‚æœæ˜¯é“¾è¡¨å°±éå†é“¾è¡¨æ‰¾åˆ°å…ƒç´ ä¹‹ååˆ é™¤ã€‚å¦‚æœæ˜¯ç”¨çº¢é»‘æ ‘å°±éå†æ ‘ç„¶åæ‰¾åˆ°ä¹‹ååšåˆ é™¤ï¼Œæ ‘å°äº6çš„æ—¶å€™è¦è½¬é“¾è¡¨

   ```java
    final Node<K,V> removeNode(int hash, Object key, Object value,
                               boolean matchValue, boolean movable) {
        Node<K,V>[] tab; Node<K,V> p; int n, index;
        //èŠ‚ç‚¹æ•°ç»„tabä¸ä¸ºç©ºã€æ•°ç»„é•¿åº¦nå¤§äº0ã€æ ¹æ®hashå®šä½åˆ°çš„èŠ‚ç‚¹å¯¹è±¡pï¼Œè¯¥èŠ‚ç‚¹ä¸ºæ ‘çš„æ ¹èŠ‚ç‚¹æˆ–é“¾è¡¨çš„é¦–èŠ‚ç‚¹ï¼‰ä¸ä¸ºç©ºï¼Œä»è¯¥èŠ‚ç‚¹på‘ä¸‹éå†ï¼Œæ‰¾åˆ°é‚£ä¸ªå’ŒkeyåŒ¹é…çš„èŠ‚ç‚¹å¯¹è±¡
        if ((tab = table) != null && (n = tab.length) > 0 &&
            (p = tab[index = (n - 1) & hash]) != null) {
            Node<K,V> node = null, e; K k; V v;//ä¸´æ—¶å˜é‡ï¼Œå‚¨å­˜è¦è¿”å›çš„èŠ‚ç‚¹ä¿¡æ¯
            //keyå’Œvalueéƒ½ç›¸ç­‰ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹
            if (p.hash == hash &&
                ((k = p.key) == key || (key != null && key.equals(k))))
                node = p;
            
            else if ((e = p.next) != null) {
                //å¦‚æœæ˜¯æ ‘èŠ‚ç‚¹ï¼Œè°ƒç”¨getTreeNodeæ–¹æ³•ä»æ ‘ç»“æ„ä¸­æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹
                if (p instanceof TreeNode)
                    node = ((TreeNode<K,V>)p).getTreeNode(hash, key);
                //éå†é“¾è¡¨
                else {
                    do {
                        //eèŠ‚ç‚¹çš„é”®æ˜¯å¦å’Œkeyç›¸ç­‰ï¼ŒeèŠ‚ç‚¹å°±æ˜¯è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œèµ‹å€¼ç»™nodeå˜é‡
                        if (e.hash == hash &&
                            ((k = e.key) == key ||
                             (key != null && key.equals(k)))) {
                            node = e;
                            //è·³å‡ºå¾ªç¯
                            break;
                        }
                        p = e;//æŠŠå½“å‰èŠ‚ç‚¹pæŒ‡å‘e ç»§ç»­éå†
                    } while ((e = e.next) != null);
                }
            }
            //å¦‚æœnodeä¸ä¸ºç©ºï¼Œè¯´æ˜æ ¹æ®keyåŒ¹é…åˆ°äº†è¦åˆ é™¤çš„èŠ‚ç‚¹
            //å¦‚æœä¸éœ€è¦å¯¹æ¯”valueå€¼æˆ–è€…å¯¹æ¯”valueå€¼ä½†æ˜¯valueå€¼ä¹Ÿç›¸ç­‰ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤
            if (node != null && (!matchValue || (v = node.value) == value ||
                                 (value != null && value.equals(v)))) {
                if (node instanceof TreeNode)
                    ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);
                else if (node == p)//nodeæ˜¯é¦–èŠ‚ç‚¹
                    tab[index] = node.next;
                else	//nodeä¸æ˜¯é¦–èŠ‚ç‚¹
                    p.next = node.next;
                ++modCount;
                --size;
                //LinkedHashMap
                afterNodeRemoval(node);
                return node;
            }
        }
        return null;
    }
   ```
   
   
   
5. get

   1. é€šè¿‡hashå€¼è·å–è¯¥keyæ˜ å°„åˆ°çš„æ¡¶
   
   2. æ¡¶ä¸Šçš„keyå°±æ˜¯è¦æŸ¥æ‰¾çš„keyï¼Œåˆ™ç›´æ¥æ‰¾åˆ°å¹¶è¿”å›

   3. æ¡¶ä¸Šçš„keyä¸æ˜¯è¦æ‰¾çš„keyï¼Œåˆ™æŸ¥çœ‹åç»­çš„èŠ‚ç‚¹ï¼š

      * å¦‚æœåç»­èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œé€šè¿‡è°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•æ ¹æ®keyè·å–value

      * å¦‚æœåç»­èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡å¾ªç¯éå†é“¾è¡¨æ ¹æ®keyè·å–value 

   4. çº¢é»‘æ ‘èŠ‚ç‚¹è°ƒç”¨çš„æ˜¯getTreeNodeæ–¹æ³•é€šè¿‡æ ‘å½¢èŠ‚ç‚¹çš„findæ–¹æ³•è¿›è¡ŒæŸ¥
   
      * æŸ¥æ‰¾çº¢é»‘æ ‘ï¼Œä¹‹å‰æ·»åŠ æ—¶å·²ç»ä¿è¯è¿™ä¸ªæ ‘æ˜¯æœ‰åºçš„ï¼Œå› æ­¤æŸ¥æ‰¾æ—¶å°±æ˜¯æŠ˜åŠæŸ¥æ‰¾ï¼Œæ•ˆç‡æ›´é«˜ã€‚
      * è¿™é‡Œå’Œæ’å…¥æ—¶ä¸€æ ·ï¼Œå¦‚æœå¯¹æ¯”èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ç›¸ç­‰å¹¶ä¸”é€šè¿‡equalsåˆ¤æ–­å€¼ä¹Ÿç›¸ç­‰ï¼Œå°±ä¼šåˆ¤æ–­keyç›¸ç­‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸ç›¸ç­‰å°±ä»å­æ ‘ä¸­é€’å½’æŸ¥æ‰¾

   5. æ—¶é—´å¤æ‚åº¦ O(1)
      
      * è‹¥ä¸ºæ ‘ï¼Œåˆ™åœ¨æ ‘ä¸­é€šè¿‡key.equals(k)æŸ¥æ‰¾ï¼Œ**O(logn)** 
      
      * è‹¥ä¸ºé“¾è¡¨ï¼Œåˆ™åœ¨é“¾è¡¨ä¸­é€šè¿‡key.equals(k)æŸ¥æ‰¾ï¼Œ**O(n)**



***



#### LinkedMap

##### åŸç†åˆ†æ

LinkedHashMapæ˜¯ HashMap çš„å­ç±»

* ä¼˜ç‚¹ï¼šæ·»åŠ çš„å…ƒç´ æŒ‰ç…§é”®æœ‰åºä¸é‡å¤çš„ï¼Œæœ‰åºçš„åŸå› æ˜¯åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨

* ç¼ºç‚¹ï¼šä¼šå ç”¨ä¸€äº›å†…å­˜ç©ºé—´

å¯¹æ¯” Setï¼š

* HashSet é›†åˆç›¸å½“äºæ˜¯ HashMap é›†åˆçš„é”®ï¼Œä¸å¸¦å€¼
* LinkedHashSet é›†åˆç›¸å½“äºæ˜¯ LinkedHashMap é›†åˆçš„é”®ï¼Œä¸å¸¦å€¼
* åº•å±‚åŸç†å®Œå…¨ä¸€æ ·ï¼Œéƒ½æ˜¯åŸºäºå“ˆå¸Œè¡¨æŒ‰ç…§é”®å­˜å‚¨æ•°æ®çš„ï¼Œåªæ˜¯ Map å¤šäº†ä¸€ä¸ªé”®çš„å€¼

æºç è§£æï¼š

* å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”¨æ¥ç»´æŠ¤æ’å…¥é¡ºåºæˆ–è€… LRU é¡ºåº

  ```java
  transient LinkedHashMap.Entry<K,V> head;
  transient LinkedHashMap.Entry<K,V> tail;
  ```

* accessOrder å†³å®šäº†é¡ºåºï¼Œé»˜è®¤ä¸º false ç»´æŠ¤çš„æ˜¯æ’å…¥é¡ºåºï¼Œtrueä¸ºè®¿é—®é¡ºåºï¼ˆLRUé¡ºåºï¼‰

  ```java
  final boolean accessOrder;
  ```

* ç»´æŠ¤é¡ºåºçš„å‡½æ•°

  ```java
  void afterNodeAccess(Node<K,V> p) {}
  void afterNodeInsertion(boolean evict) {}
  ```

* put()

  ```java
  // è°ƒç”¨çˆ¶ç±»HashMapçš„putæ–¹æ³•
  public V put(K key, V value) {
      return putVal(hash(key), key, value, false, true);
  }
  final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict)
  â†’ afterNodeInsertion(evict);// evictä¸ºtrue
  ```

  afterNodeInsertionæ–¹æ³•ï¼Œå½“ removeEldestEntry() æ–¹æ³•è¿”å› true æ—¶ä¼šç§»é™¤æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨é¦–éƒ¨èŠ‚ç‚¹ first

  ```java
  void afterNodeInsertion(boolean evict) {
      LinkedHashMap.Entry<K,V> first;
      // evict åªæœ‰åœ¨æ„å»º Map çš„æ—¶å€™æ‰ä¸º falseï¼Œè¿™é‡Œä¸º true
      if (evict && (first = head) != null && removeEldestEntry(first)) {
          K key = first.key;
          removeNode(hash(key), key, null, false, true);//ç§»é™¤å¤´èŠ‚ç‚¹
      }
  }
  ```

  removeEldestEntry() é»˜è®¤ä¸º falseï¼Œå¦‚æœéœ€è¦è®©å®ƒä¸º trueï¼Œéœ€è¦ç»§æ‰¿ LinkedHashMap å¹¶ä¸”è¦†ç›–è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œåœ¨å®ç° LRU çš„ç¼“å­˜ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œé€šè¿‡ç§»é™¤æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç¼“å­˜ç©ºé—´è¶³å¤Ÿï¼Œå¹¶ä¸”ç¼“å­˜çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®

  ```java
  protected boolean removeEldestEntry(Map.Entry<K,V> eldest) {
      return false;
  }
  ```

* get()

  å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«è®¿é—®æ—¶ï¼Œå¦‚æœ accessOrder ä¸º trueï¼Œåˆ™ä¼šå°†è¯¥èŠ‚ç‚¹ç§»åˆ°é“¾è¡¨å°¾éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´æŒ‡å®šä¸º LRU é¡ºåºä¹‹åï¼Œåœ¨æ¯æ¬¡è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶ä¼šå°†è¿™ä¸ªèŠ‚ç‚¹ç§»åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œé‚£ä¹ˆé“¾è¡¨é¦–éƒ¨å°±æ˜¯æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹

  ```java
  public V get(Object key) {
      Node<K,V> e;
      if ((e = getNode(hash(key), key)) == null)
          return null;
      if (accessOrder)
          afterNodeAccess(e);
      return e.value;
  }
  ```

  ```java
  void afterNodeAccess(Node<K,V> e) {
      LinkedHashMap.Entry<K,V> last;
      if (accessOrder && (last = tail) != e) {
          // å‘ä¸‹è½¬å‹
          LinkedHashMap.Entry<K,V> p =
              (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;
          p.after = null;
          // åˆ¤æ–­ p æ˜¯å¦æ˜¯é¦–èŠ‚ç‚¹
          if (b == null)
              //æ˜¯å¤´èŠ‚ç‚¹ è®©påç»§èŠ‚ç‚¹æˆä¸ºå¤´èŠ‚ç‚¹
              head = a;
          else
              //ä¸æ˜¯å¤´èŠ‚ç‚¹ è®©pçš„å‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘pçš„åç»§èŠ‚ç‚¹ï¼Œç»´æŠ¤é“¾è¡¨çš„è¿æ¥
              b.after = a;
          // åˆ¤æ–­pæ˜¯å¦æ˜¯å°¾èŠ‚ç‚¹
          if (a != null)
              // ä¸æ˜¯å°¾èŠ‚ç‚¹ è®©påç»§èŠ‚ç‚¹æŒ‡å‘pçš„å‰é©±èŠ‚ç‚¹
              a.before = b;
          else
              // æ˜¯å°¾èŠ‚ç‚¹ è®©lastæŒ‡å‘pçš„å‰é©±èŠ‚ç‚¹
              last = b;
          // åˆ¤æ–­lastæ˜¯å¦æ˜¯ç©º
          if (last == null)
              // lastä¸ºç©ºè¯´æ˜pæ˜¯å°¾èŠ‚ç‚¹æˆ–è€…åªæœ‰pä¸€ä¸ªèŠ‚ç‚¹
              head = p;
          else {
              // lastå’Œpç›¸äº’è¿æ¥
              p.before = last;
              last.after = p;
          }
          tail = p;
          ++modCount;
      }
  }
  ```

* remove()
  
  ```java
  //è°ƒç”¨HashMapçš„removeæ–¹æ³•
  final Node<K,V> removeNode(int hash, Object key, Object value,boolean matchValue, boolean movable)
  â†’ afterNodeRemoval(node);
  ```
  
  å½“ HashMap åˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹æ—¶è°ƒç”¨ï¼Œä¼šæŠŠåœ¨ HashMap ä¸­åˆ é™¤çš„é‚£ä¸ªé”®å€¼å¯¹ä¸€å¹¶ä»é“¾è¡¨ä¸­åˆ é™¤
  
  ```java
  void afterNodeRemoval(Node<K,V> e) {
      LinkedHashMap.Entry<K,V> p =
          (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;
      // è®©pèŠ‚ç‚¹ä¸å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹æ–­å¼€é“¾æ¥
      p.before = p.after = null;
      // åˆ¤æ–­pæ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹
      if (b == null)
          // pæ˜¯å¤´èŠ‚ç‚¹ è®©headæŒ‡å‘pçš„åç»§èŠ‚ç‚¹
          head = a;
      else
          // pä¸æ˜¯å¤´èŠ‚ç‚¹ è®©pçš„å‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘pçš„åç»§èŠ‚ç‚¹ï¼Œç»´æŠ¤é“¾è¡¨çš„è¿æ¥
          b.after = a;
      // åˆ¤æ–­pæ˜¯å¦æ˜¯å°¾èŠ‚ç‚¹ï¼Œæ˜¯å°±è®©tailæŒ‡å‘pçš„å‰é©±èŠ‚ç‚¹ï¼Œä¸æ˜¯å°±è®©p.afteræŒ‡å‘å‰é©±èŠ‚ç‚¹ï¼ŒåŒå‘
      if (a == null)
          tail = b;
      else
          a.before = b;
  }
  ```



***



##### LRU

ä½¿ç”¨ LinkedHashMap å®ç°çš„ä¸€ä¸ª LRU ç¼“å­˜ï¼š

- è®¾å®šæœ€å¤§ç¼“å­˜ç©ºé—´ MAX_ENTRIES ä¸º 3
- ä½¿ç”¨ LinkedHashMap çš„æ„é€ å‡½æ•°å°† accessOrder è®¾ç½®ä¸º trueï¼Œå¼€å¯ LRU é¡ºåº
- è¦†ç›– removeEldestEntry() æ–¹æ³•å®ç°ï¼Œåœ¨èŠ‚ç‚¹å¤šäº MAX_ENTRIES å°±ä¼šå°†æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®ç§»é™¤

```java
public static void main(String[] args) {
    LRUCache<Integer, String> cache = new LRUCache<>();
    cache.put(1, "a");
    cache.put(2, "b");
    cache.put(3, "c");
    cache.get(1);//æŠŠ1æ”¾å…¥å°¾éƒ¨
    cache.put(4, "d");
    System.out.println(cache.keySet());//[3, 1, 4]åªèƒ½å­˜3ä¸ªï¼Œç§»é™¤2
}

class LRUCache<K, V> extends LinkedHashMap<K, V> {
    private static final int MAX_ENTRIES = 3;

    protected boolean removeEldestEntry(Map.Entry eldest) {
        return size() > MAX_ENTRIES;
    }

    LRUCache() {
        super(MAX_ENTRIES, 0.75f, true);
    }
}
```



***



#### TreeMap

TreeMap å®ç°äº† SotredMap æ¥å£ï¼Œæ˜¯æœ‰åºä¸å¯é‡å¤çš„é”®å€¼å¯¹é›†åˆï¼ŒåŸºäºçº¢é»‘æ ‘ï¼ˆRed-Black treeï¼‰å®ç°ï¼Œæ¯ä¸ª key-value éƒ½ä½œä¸ºä¸€ä¸ªçº¢é»‘æ ‘çš„èŠ‚ç‚¹ã€‚å¦‚æœæ„é€  TreeMap æ²¡æœ‰æŒ‡å®šæ¯”è¾ƒå™¨ï¼Œåˆ™æ ¹æ®keyæ‰§è¡Œè‡ªç„¶æ’åºï¼ˆé»˜è®¤å‡åºï¼‰ï¼Œå¦‚æœæŒ‡å®šäº†æ¯”è¾ƒå™¨åˆ™æŒ‰ç…§æ¯”è¾ƒå™¨æ¥è¿›è¡Œæ’åº

TreeSet é›†åˆçš„åº•å±‚æ˜¯åŸºäºTreeMapï¼Œåªæ˜¯é”®çš„é™„å±å€¼ä¸ºç©ºå¯¹è±¡è€Œå·²

TreeMapé›†åˆæŒ‡å®šå¤§å°è§„åˆ™æœ‰2ç§æ–¹å¼ï¼š

* ç›´æ¥ä¸ºå¯¹è±¡çš„ç±»å®ç°æ¯”è¾ƒå™¨è§„åˆ™æ¥å£Comparableï¼Œé‡å†™æ¯”è¾ƒæ–¹æ³•ï¼ˆæ‹“å±•æ–¹å¼ï¼‰
* ç›´æ¥ä¸ºé›†åˆè®¾ç½®æ¯”è¾ƒå™¨Comparatorå¯¹è±¡ï¼Œé‡å†™æ¯”è¾ƒæ–¹æ³•

æˆå‘˜å±æ€§ï¼š

* EntryèŠ‚ç‚¹

  ```java
   static final class Entry<K,V> implements Map.Entry<K,V> {
       K key;
       V value;
       Entry<K,V> left;		//å·¦å­©å­èŠ‚ç‚¹
       Entry<K,V> right;		//å³å­©å­èŠ‚ç‚¹
       Entry<K,V> parent;		//çˆ¶èŠ‚ç‚¹
       boolean color = BLACK;	//èŠ‚ç‚¹çš„é¢œè‰²ï¼Œåœ¨çº¢é»‘æ ‘ä¸­åªæœ‰ä¸¤ç§é¢œè‰²ï¼Œçº¢è‰²å’Œé»‘è‰²
   }
  ```

* compare()

  ```java
  //å¦‚æœcomparatorä¸ºnullï¼Œé‡‡ç”¨comparable.compartToè¿›è¡Œæ¯”è¾ƒï¼Œå¦åˆ™é‡‡ç”¨æŒ‡å®šæ¯”è¾ƒå™¨æ¯”è¾ƒå¤§å°
  final int compare(Object k1, Object k2) {
      return comparator==null ? ((Comparable<? super K>)k1).compareTo((K)k2)
          : comparator.compare((K)k1, (K)k2);
  }
  ```



å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/weixin_33991727/article/details/91518677



***



#### WeakMap

WeakHashMap æ˜¯åŸºäºå¼±å¼•ç”¨çš„

å†…éƒ¨çš„ Entry ç»§æ‰¿ WeakReferenceï¼Œè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶ä¼šè¢«å›æ”¶ï¼Œå¹¶ä¸”æ„é€ æ–¹æ³•ä¼ å…¥å¼•ç”¨é˜Ÿåˆ—ï¼Œç”¨æ¥åœ¨æ¸…ç†å¯¹è±¡å®Œæˆä»¥åæ¸…ç†å¼•ç”¨

```java
private static class Entry<K,V> extends WeakReference<Object> implements Map.Entry<K,V> {
    Entry(Object key, V value,
          ReferenceQueue<Object> queue,
          int hash, Entry<K,V> next) {
        super(key, queue);
        this.value = value;
        this.hash  = hash;
        this.next  = next;
    }
}
```

WeakHashMap ä¸»è¦ç”¨æ¥å®ç°ç¼“å­˜ï¼Œä½¿ç”¨ WeakHashMap æ¥å¼•ç”¨ç¼“å­˜å¯¹è±¡ï¼Œç”± JVM å¯¹è¿™éƒ¨åˆ†ç¼“å­˜è¿›è¡Œå›æ”¶

Tomcat ä¸­çš„ ConcurrentCache ä½¿ç”¨äº† WeakHashMap æ¥å®ç°ç¼“å­˜åŠŸèƒ½ï¼ŒConcurrentCache é‡‡å–åˆ†ä»£ç¼“å­˜ï¼š

* ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡æ”¾å…¥ eden ä¸­ï¼Œeden ä½¿ç”¨ ConcurrentHashMap å®ç°ï¼Œä¸ç”¨æ‹…å¿ƒä¼šè¢«å›æ”¶ï¼ˆä¼Šç”¸å›­ï¼‰

* ä¸å¸¸ç”¨çš„å¯¹è±¡æ”¾å…¥ longtermï¼Œlongterm ä½¿ç”¨ WeakHashMap å®ç°ï¼Œè¿™äº›è€å¯¹è±¡ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶

* å½“è°ƒç”¨ get() æ–¹æ³•æ—¶ï¼Œä¼šå…ˆä» eden åŒºè·å–ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯å†åˆ° longterm è·å–ï¼Œå½“ä» longterm è·å–åˆ°å°±æŠŠå¯¹è±¡æ”¾å…¥ eden ä¸­ï¼Œä»è€Œä¿è¯ç»å¸¸è¢«è®¿é—®çš„èŠ‚ç‚¹ä¸å®¹æ˜“è¢«å›æ”¶

* å½“è°ƒç”¨ put() æ–¹æ³•æ—¶ï¼Œå¦‚æœ eden çš„å¤§å°è¶…è¿‡äº† sizeï¼Œé‚£ä¹ˆå°±å°† eden ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ”¾å…¥ longterm ä¸­ï¼Œåˆ©ç”¨è™šæ‹Ÿæœºå›æ”¶æ‰ä¸€éƒ¨åˆ†ä¸ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡

  ```java
  public final class ConcurrentCache<K, V> {
      private final int size;
      private final Map<K, V> eden;
      private final Map<K, V> longterm;
  
      public ConcurrentCache(int size) {
          this.size = size;
          this.eden = new ConcurrentHashMap<>(size);
          this.longterm = new WeakHashMap<>(size);
      }
  
      public V get(K k) {
          V v = this.eden.get(k);
          if (v == null) {
              v = this.longterm.get(k);
              if (v != null)
                  this.eden.put(k, v);
          }
          return v;
      }
  
      public void put(K k, V v) {
          if (this.eden.size() >= size) {
              this.longterm.putAll(this.eden);
              this.eden.clear();
          }
          this.eden.put(k, v);
      }
  }





***



#### é¢è¯•é¢˜

è¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æ¯ä¸ªå­—ç¬¦å‡ºç°çš„æ¬¡æ•°ã€‚

```java
/*
    ï¼ˆ1ï¼‰é”®ç›˜å½•å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚aabbccddaa123ã€‚
    ï¼ˆ2ï¼‰å®šä¹‰ä¸€ä¸ªMapé›†åˆï¼Œé”®æ˜¯æ¯ä¸ªå­—ç¬¦ï¼Œå€¼æ˜¯å…¶å‡ºç°çš„æ¬¡æ•°ã€‚ {a=4 , b=2 ,...}
    ï¼ˆ3ï¼‰éå†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ã€‚
    ï¼ˆ4ï¼‰æ‹¿ç€è¿™ä¸ªå­—ç¬¦å»Mapé›†åˆä¸­çœ‹æ˜¯å¦æœ‰è¿™ä¸ªå­—ç¬¦é”®ï¼Œæœ‰è¯´æ˜ä¹‹å‰ç»Ÿè®¡è¿‡ï¼Œå…¶å€¼+1
         æ²¡æœ‰è¿™ä¸ªå­—ç¬¦é”®ï¼Œè¯´æ˜è¯¥å­—ç¬¦æ˜¯ç¬¬ä¸€æ¬¡ç»Ÿè®¡ï¼Œç›´æ¥å­˜å…¥â€œè¯¥å­—ç¬¦=1â€
*/
public class MapDemo{
    public static void main(String[] args){
        String s = "aabbccddaa123";
        Map<Character, Integer> infos = new HashMap<>();
        for (int i = 0; i < s.length(); i++){
            char ch = datas.charAt(i);
            if(infos.containsKey(ch)){
                infos.put(ch,infos.get(ch) + 1);
            } else {
                infos.put(ch,1);
            }
        }
        System.out.println("ç»“æœï¼š"+infos);
    }
}
```



***



### æ³›å‹

#### æ¦‚è¿°

æ³›å‹ï¼ˆGenericï¼‰ï¼š

* æ³›å‹å°±æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼š<æ•°æ®ç±»å‹>
* æ³›å‹å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µçº¦æŸåªèƒ½æ“ä½œæŸç§æ•°æ®ç±»å‹ã€‚

æ³¨æ„ï¼š

* JDK 1.7 å¼€å§‹ä¹‹åï¼Œæ³›å‹åé¢çš„ç”³æ˜å¯ä»¥çœç•¥ä¸å†™
* **æ³›å‹å’Œé›†åˆéƒ½åªèƒ½æ”¯æŒå¼•ç”¨æ•°æ®ç±»å‹ï¼Œä¸æ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹ã€‚**

```java
{
    ArrayList<Object> lists = new ArrayList<>(); 
    lists.add(99.9);
    lists.add('a');
    lists.add("Java");
    ArrayList<Integer> list = new ArrayList<>();
    lists1.add(10);
    lists1.add(20);
}
```

ä¼˜ç‚¹ï¼šæ³›å‹åœ¨ç¼–è¯‘é˜¶æ®µçº¦æŸäº†æ“ä½œçš„æ•°æ®ç±»å‹ï¼Œä»è€Œä¸ä¼šå‡ºç°ç±»å‹è½¬æ¢å¼‚å¸¸
			ä½“ç°çš„æ˜¯ Java çš„ä¸¥è°¨æ€§å’Œè§„èŒƒæ€§ï¼Œæ•°æ®ç±»å‹ï¼Œç»å¸¸éœ€è¦è¿›è¡Œç»Ÿä¸€



****



#### è‡ªå®šä¹‰

##### æ³›å‹ç±»

æ³›å‹ç±»ï¼šä½¿ç”¨äº†æ³›å‹å®šä¹‰çš„ç±»å°±æ˜¯æ³›å‹ç±»ã€‚

æ³›å‹ç±»æ ¼å¼ï¼š

```java
ä¿®é¥°ç¬¦ class ç±»å<æ³›å‹å˜é‡>{

}
æ³›å‹å˜é‡å»ºè®®ä½¿ç”¨ E , T , K , V
```

```java
public class GenericDemo {
    public static void main(String[] args) {
        MyArrayList<String> list = new MyArrayList<String>();
        MyArrayList<Integer> list1 = new MyArrayList<Integer>();
        list.add("è‡ªå®šä¹‰æ³›å‹ç±»");
    }
}
class MyArrayList<E>{
	public void add(E e){}
    public void remove(E e){}
}
```



****



##### æ³›å‹æ–¹æ³•

æ³›å‹æ–¹æ³•ï¼šå®šä¹‰äº†æ³›å‹çš„æ–¹æ³•å°±æ˜¯æ³›å‹æ–¹æ³•

æ³›å‹æ–¹æ³•çš„å®šä¹‰æ ¼å¼ï¼š

```java
ä¿®é¥°ç¬¦ <æ³›å‹å˜é‡> è¿”å›å€¼ç±»å‹ æ–¹æ³•åç§°(å½¢å‚åˆ—è¡¨){

}
```

æ–¹æ³•å®šä¹‰äº†æ˜¯ä»€ä¹ˆæ³›å‹å˜é‡ï¼Œåé¢å°±åªèƒ½ç”¨ä»€ä¹ˆæ³›å‹å˜é‡ã€‚

æ³›å‹ç±»çš„æ ¸å¿ƒæ€æƒ³ï¼šæŠŠå‡ºç°æ³›å‹å˜é‡çš„åœ°æ–¹å…¨éƒ¨æ›¿æ¢æˆä¼ è¾“çš„çœŸå®æ•°æ®ç±»å‹

```java
public class GenericDemo {
    public static void main(String[] args) {
        Integer[] num = {10 , 20 , 30 , 40 , 50};
        String s1 = arrToString(nums);
     
        String[] name = {"è´¾ä¹ƒäº®","ç‹å®ç»¿","é™ˆç¾½å‡¡"};
        String s2 = arrToString(names);
    }

    public static <T> String arrToString(T[] arr){
        --------------
    }
}
```



è‡ªå®šä¹‰æ³›å‹æ¥å£

æ³›å‹æ¥å£ï¼šä½¿ç”¨äº†æ³›å‹å®šä¹‰çš„æ¥å£å°±æ˜¯æ³›å‹æ¥å£ã€‚
æ³›å‹æ¥å£çš„æ ¼å¼ï¼š

```java
ä¿®é¥°ç¬¦ interface æ¥å£åç§°<æ³›å‹å˜é‡>{

}
```

```java
public class GenericDemo {
    public static void main(String[] args) {
        Data d = new StudentData();
        d.add(new Student());
        ................
    }
}

public interface Data<E>{
    void add(E e);
    void delete(E e);
    void update(E e);
    E query(int index);
}
class Student{}
class StudentData implements Data<Student>{é‡å†™æ‰€æœ‰æ–¹æ³•}
```



****



#### é€šé…ç¬¦

é€šé…ç¬¦ï¼šï¼Ÿ

* ? å¯ä»¥ç”¨åœ¨ä½¿ç”¨æ³›å‹çš„æ—¶å€™ä»£è¡¨ä¸€åˆ‡ç±»å‹
* Eã€Tã€Kã€V æ˜¯åœ¨å®šä¹‰æ³›å‹çš„æ—¶å€™ä½¿ç”¨ä»£è¡¨ä¸€åˆ‡ç±»å‹

æ³›å‹çš„ä¸Šä¸‹é™ï¼š

* ? extends Carï¼šé‚£ä¹ˆ ? å¿…é¡»æ˜¯ Car æˆ–è€…å…¶å­ç±»ï¼ˆæ³›å‹çš„ä¸Šé™ï¼‰
* ? super  Carï¼šé‚£ä¹ˆ ? å¿…é¡»æ˜¯ Car æˆ–è€…å…¶çˆ¶ç±»ï¼ˆæ³›å‹çš„ä¸‹é™ï¼Œä¸æ˜¯å¾ˆå¸¸è§ï¼‰

```java
//éœ€æ±‚ï¼šå¼€å‘ä¸€ä¸ªæå“é£è½¦çš„æ¸¸æˆï¼Œæ‰€æœ‰çš„æ±½è½¦éƒ½èƒ½ä¸€èµ·å‚ä¸æ¯”èµ›ã€‚
public class GenericDemo {
    public static void main(String[] args) {
        ArrayList<BMW> bmws = new ArrayList<>();
        ArrayList<AD> ads = new ArrayList<>();
        ArrayList<Dog> dogs = new ArrayList<>();
        run(bmws);
        //run(dogs);
    }
    //public static void run(ArrayList<?> car){}//è¿™æ · douå¯¹è±¡ä¹Ÿèƒ½è¿›å…¥
    public static void run(ArrayList<? extends Car> car){}
}

class Car{}
class BMW extends Car{}
class AD extends Car{}
class Dog{}
```





***



### ä¸å¯å˜

åœ¨ Listã€Setã€Map æ¥å£ä¸­éƒ½å­˜åœ¨ of æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸å¯å˜çš„é›†åˆ
+ è¿™ä¸ªé›†åˆä¸èƒ½æ·»åŠ ï¼Œä¸èƒ½åˆ é™¤ï¼Œä¸èƒ½ä¿®æ”¹
+ ä½†æ˜¯å¯ä»¥ç»“åˆé›†åˆçš„å¸¦å‚æ„é€ ï¼Œå®ç°é›†åˆçš„æ‰¹é‡æ·»åŠ 

åœ¨Mapæ¥å£ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªofEntriesæ–¹æ³•å¯ä»¥æé«˜ä»£ç çš„é˜…è¯»æ€§
+ é¦–å…ˆä¼šæŠŠé”®å€¼å¯¹å°è£…æˆä¸€ä¸ªEntryå¯¹è±¡ï¼Œå†æŠŠè¿™ä¸ªEntryå¯¹è±¡æ·»åŠ åˆ°é›†åˆå½“ä¸­

````java
public class MyVariableParameter4 {
    public static void main(String[] args) {
        // static <E>  List<E>  of(Eâ€¦elements)  åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šå…ƒç´ çš„Listé›†åˆå¯¹è±¡
        //static <E>  Set<E>  of(Eâ€¦elements)    åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šå…ƒç´ çš„Seté›†åˆå¯¹è±¡
        //static <K , V>   Map<Kï¼ŒV>  of(Eâ€¦elements) åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šå…ƒç´ çš„Mapé›†åˆå¯¹è±¡

        //method1();
        //method2();
        //method3();
        //method4();

    }

    private static void method4() {
        Map<String, String> map = Map.ofEntries(
                Map.entry("zhangsan", "æ±Ÿè‹"),
                Map.entry("lisi", "åŒ—äº¬"));
        System.out.println(map);
    }

    private static void method3() {
        Map<String, String> map = Map.of("zhangsan", "æ±Ÿè‹", "lisi", "åŒ—äº¬");
        System.out.println(map);
    }

    private static void method2() {
        //ä¼ é€’çš„å‚æ•°å½“ä¸­ï¼Œä¸èƒ½å­˜åœ¨é‡å¤çš„å…ƒç´ ã€‚
        Set<String> set = Set.of("a", "b", "c", "d","a");
        System.out.println(set);
    }

    private static void method1() {
        List<String> list = List.of("a", "b", "c", "d");
        System.out.println(list);

        //é›†åˆçš„æ‰¹é‡æ·»åŠ ã€‚
        //é¦–å…ˆæ˜¯é€šè¿‡è°ƒç”¨List.ofæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªä¸å¯å˜çš„é›†åˆï¼Œofæ–¹æ³•çš„å½¢å‚å°±æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ã€‚
        //å†åˆ›å»ºä¸€ä¸ªArrayListé›†åˆï¼Œå¹¶æŠŠè¿™ä¸ªä¸å¯å˜çš„é›†åˆä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œéƒ½æ·»åŠ åˆ°ArrayListä¸­ã€‚
        ArrayList<String> list3 = new ArrayList<>(List.of("a", "b", "c", "d"));
        System.out.println(list3);
    }
}
````





***



## å¼‚å¸¸

### åŸºæœ¬ä»‹ç»

å¼‚å¸¸ï¼šç¨‹åºåœ¨"ç¼–è¯‘"æˆ–è€…"æ‰§è¡Œ"çš„è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼ŒJavaä¸ºå¸¸è§çš„ä»£ç å¼‚å¸¸éƒ½è®¾è®¡ä¸€ä¸ªç±»æ¥ä»£è¡¨ã€‚

é”™è¯¯ï¼šError ï¼Œç¨‹åºå‘˜æ— æ³•å¤„ç†çš„é”™è¯¯ï¼Œåªèƒ½é‡å¯ç³»ç»Ÿï¼Œæ¯”å¦‚å†…å­˜å¥”æºƒï¼ŒJVMæœ¬èº«çš„å¥”æºƒ

Javaä¸­å¼‚å¸¸ç»§æ‰¿çš„æ ¹ç±»æ˜¯ï¼šThrowable

```
å¼‚å¸¸çš„ä½“ç³»:
         Throwable(æ ¹ç±»ï¼Œä¸æ˜¯å¼‚å¸¸ç±»)
      /              \
    Error           Exceptionï¼ˆå¼‚å¸¸ï¼Œéœ€è¦ç ”ç©¶å’Œå¤„ç†ï¼‰
                    /            \
                   ç¼–è¯‘æ—¶å¼‚å¸¸     RuntimeException(è¿è¡Œæ—¶å¼‚å¸¸)
                   
```

Exception å¼‚å¸¸çš„åˆ†ç±»:

* ç¼–è¯‘æ—¶å¼‚å¸¸ï¼šç»§æ‰¿è‡ªExceptionçš„å¼‚å¸¸æˆ–è€…å…¶å­ç±»ï¼Œç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥é”™
* è¿è¡Œæ—¶å¼‚å¸¸: ç»§æ‰¿è‡ªRuntimeExceptionçš„å¼‚å¸¸æˆ–è€…å…¶å­ç±»ï¼Œç¼–è¯‘é˜¶æ®µæ˜¯ä¸ä¼šå‡ºé”™çš„ï¼Œåœ¨è¿è¡Œæ—¶é˜¶æ®µå¯èƒ½å‡ºç°ï¼Œç¼–è¯‘é˜¶æ®µæ˜¯ä¸ä¼šå‡ºé”™çš„ï¼Œä½†æ˜¯è¿è¡Œé˜¶æ®µå¯èƒ½å‡ºç°ï¼Œå»ºè®®æå‰å¤„ç†



***



### å¤„ç†è¿‡ç¨‹

å¼‚å¸¸çš„äº§ç”Ÿé»˜è®¤çš„å¤„ç†è¿‡ç¨‹è§£æï¼šï¼ˆè‡ªåŠ¨å¤„ç†çš„è¿‡ç¨‹ï¼‰

1. é»˜è®¤ä¼šåœ¨å‡ºç°å¼‚å¸¸çš„ä»£ç é‚£é‡Œè‡ªåŠ¨çš„åˆ›å»ºä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼šArithmeticExceptionï¼ˆç®—æœ¯å¼‚å¸¸ï¼‰
2. å¼‚å¸¸ä¼šä»æ–¹æ³•ä¸­å‡ºç°çš„ç‚¹è¿™é‡ŒæŠ›å‡ºç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…æœ€ç»ˆæŠ›å‡ºç»™JVMè™šæ‹Ÿæœº
3. è™šæ‹Ÿæœºæ¥æ”¶åˆ°å¼‚å¸¸å¯¹è±¡åï¼Œå…ˆåœ¨æ§åˆ¶å°ç›´æ¥è¾“å‡º**å¼‚å¸¸æ ˆ**ä¿¡æ¯æ•°æ®
4. ç›´æ¥ä»å½“å‰æ‰§è¡Œçš„å¼‚å¸¸ç‚¹å¹²æ‰å½“å‰ç¨‹åº
5. åç»­ä»£ç æ²¡æœ‰æœºä¼šæ‰§è¡Œäº†ï¼Œå› ä¸ºç¨‹åºå·²ç»æ­»äº¡

```java
public class ExceptionDemo {
    public static void main(String[] args) {
        System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
        chu( 10 ,0 );
        System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");//ä¸æ‰§è¡Œ
    }
    public static void chu(int a , int b){
        int c = a / b ;// å‡ºç°äº†è¿è¡Œæ—¶å¼‚å¸¸,è‡ªåŠ¨åˆ›å»ºå¼‚å¸¸å¯¹è±¡ï¼šArithmeticException
        System.out.println("ç»“æœæ˜¯ï¼š"+c);
    }
}
```



***



### ç¼–è¯‘å¼‚å¸¸

#### åŸºæœ¬ä»‹ç»

ç¼–è¯‘æ—¶å¼‚å¸¸ï¼šç»§æ‰¿è‡ªExceptionçš„å¼‚å¸¸æˆ–è€…å…¶å­ç±»ï¼Œæ²¡æœ‰ç»§æ‰¿ RuntimeExceptionï¼Œç¼–è¯‘æ—¶å¼‚å¸¸æ˜¯ç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥é”™ï¼Œå¿…é¡»ç¨‹åºå‘˜ç¼–è¯‘é˜¶æ®µå°±å¤„ç†çš„ã€‚å¦åˆ™ä»£ç ç¼–è¯‘å°±æŠ¥é”™

ç¼–è¯‘æ—¶å¼‚å¸¸çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼š

* æ˜¯æ‹…å¿ƒç¨‹åºå‘˜çš„æŠ€æœ¯ä¸è¡Œï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±çˆ†å‡ºä¸€ä¸ªé”™è¯¯, ç›®çš„åœ¨äºæé†’
* æé†’ç¨‹åºå‘˜è¿™é‡Œå¾ˆå¯èƒ½å‡ºé”™ï¼Œè¯·æ£€æŸ¥å¹¶æ³¨æ„ä¸è¦å‡ºbug

```java
public static void main(String[] args) throws ParseException {
	String date = "2015-01-12 10:23:21";
	SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
	Date d = sdf.parse(date);
	System.out.println(d);
}
```



****



#### å¤„ç†æœºåˆ¶

##### throws

åœ¨å‡ºç°ç¼–è¯‘æ—¶å¼‚å¸¸çš„åœ°æ–¹å±‚å±‚æŠŠå¼‚å¸¸æŠ›å‡ºå»ç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…æœ€ç»ˆæŠ›å‡ºç»™JVMè™šæ‹Ÿæœºï¼ŒJVM è™šæ‹Ÿæœºè¾“å‡ºå¼‚å¸¸ä¿¡æ¯ï¼Œç›´æ¥å¹²æ‰ç¨‹åºï¼Œè¿™ç§æ–¹å¼ä¸é»˜è®¤æ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚

* ä¼˜ç‚¹ï¼šå¯ä»¥è§£å†³ä»£ç ç¼–è¯‘æ—¶çš„é”™è¯¯
* è¿è¡Œæ—¶å‡ºç°å¼‚å¸¸ï¼Œç¨‹åºè¿˜æ˜¯ä¼šç«‹å³æ­»äº¡ï¼

**Exceptionæ˜¯å¼‚å¸¸æœ€é«˜ç±»å‹å¯ä»¥æŠ›å‡ºä¸€åˆ‡å¼‚å¸¸ï¼**

```java
public static void main(String[] args) throws Exception {
    System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚");
    String s = "2013-03-23 10:19:23";
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    Date date = sdf.parse(s);
    System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚ã€‚");
}
```



***



##### try/catch

å¯ä»¥å¤„ç†å¼‚å¸¸ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸åä»£ç ä¹Ÿä¸ä¼šæ­»äº¡ã€‚

* è‡ªå·±æ•è·å¼‚å¸¸å’Œå¤„ç†å¼‚å¸¸çš„æ ¼å¼ï¼š**æ•è·å¤„ç†**

  ```java
  try{
    // ç›‘è§†å¯èƒ½å‡ºç°å¼‚å¸¸çš„ä»£ç ï¼
  }catch(å¼‚å¸¸ç±»å‹1 å˜é‡){
    // å¤„ç†å¼‚å¸¸
  }catch(å¼‚å¸¸ç±»å‹2 å˜é‡){
    // å¤„ç†å¼‚å¸¸
  }...finall{
  //èµ„æºé‡Šæ”¾
  }
  ```

* ç›‘è§†æ•è·å¤„ç†å¼‚å¸¸ä¼ä¸šçº§å†™æ³•ï¼š
  Exceptionå¯ä»¥æ•è·å¤„ç†ä¸€åˆ‡å¼‚å¸¸ç±»å‹ï¼

  ```java
  try{
      // å¯èƒ½å‡ºç°å¼‚å¸¸çš„ä»£ç ï¼
  }catch (Exception e){
      e.printStackTrace(); // **ç›´æ¥æ‰“å°å¼‚å¸¸æ ˆä¿¡æ¯**
  }
  ```

**Throwableæˆå‘˜æ–¹æ³•:**
	`public String getMessage()` : è¿”å›æ­¤ throwable çš„è¯¦ç»†æ¶ˆæ¯å­—ç¬¦ä¸²
	`public String toString()` : è¿”å›æ­¤å¯æŠ›å‡ºçš„ç®€çŸ­æè¿°
	`public void printStackTrace()` : æŠŠå¼‚å¸¸çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºåœ¨æ§åˆ¶å°

```java
public static void main(String[] args) {
    System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚");
    try {
        String s = "2013-03-23 10:19:23";
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Date date = sdf.parse(s);
        InputStream is = new FileInputStream("D:/meinv.png");
    } catch (Exception e) {
        e.printStackTrace();
    }
    System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚ã€‚");
}
```



***



##### è§„èŒƒåšæ³•

åœ¨å‡ºç°å¼‚å¸¸çš„åœ°æ–¹æŠŠå¼‚å¸¸ä¸€å±‚ä¸€å±‚çš„æŠ›å‡ºç»™æœ€å¤–å±‚è°ƒç”¨è€…ï¼Œæœ€å¤–å±‚è°ƒç”¨è€…é›†ä¸­æ•è·å¤„ç†ï¼ï¼ˆ**è§„èŒƒåšæ³•**ï¼‰
è¿™ç§æ–¹æ¡ˆæœ€å¤–å±‚è°ƒç”¨è€…å¯ä»¥çŸ¥é“åº•å±‚æ‰§è¡Œçš„æƒ…å†µï¼ŒåŒæ—¶ç¨‹åºåœ¨å‡ºç°å¼‚å¸¸åä¹Ÿä¸ä¼šç«‹å³æ­»äº¡ï¼ˆæœ€å¥½çš„æ–¹æ¡ˆï¼‰

```java
public class ExceptionDemo{
	public static void main(String[] args){
        System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚");
        try {
            parseDate("2013-03-23 10:19:23");
        }catch (Exception e){
            e.printStackTrace();
        }
        System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚");
    }
    public static void parseDate(String time) throws Exception{...}
}
```



***



### è¿è¡Œå¼‚å¸¸

#### åŸºæœ¬ä»‹ç»

ç»§æ‰¿è‡ªRuntimeExceptionçš„å¼‚å¸¸æˆ–è€…å…¶å­ç±»ï¼Œç¼–è¯‘é˜¶æ®µæ˜¯ä¸ä¼šå‡ºé”™çš„ï¼Œå®ƒæ˜¯åœ¨è¿è¡Œæ—¶é˜¶æ®µå¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œè¿è¡Œæ—¶å¼‚å¸¸ç¼–è¯‘é˜¶æ®µå¯ä»¥å¤„ç†ä¹Ÿå¯ä»¥ä¸å¤„ç†,ä»£ç ç¼–è¯‘éƒ½èƒ½é€šè¿‡ï¼ï¼

**å¸¸è§çš„è¿è¡Œæ—¶å¼‚å¸¸**ï¼š

1. æ•°ç»„ç´¢å¼•è¶Šç•Œå¼‚å¸¸: ArrayIndexOutOfBoundsException
2. ç©ºæŒ‡é’ˆå¼‚å¸¸ : NullPointerExceptionï¼Œç›´æ¥è¾“å‡ºæ²¡é—®é¢˜ï¼Œè°ƒç”¨ç©ºæŒ‡é’ˆçš„å˜é‡çš„åŠŸèƒ½å°±ä¼šæŠ¥é”™ï¼
3. ç±»å‹è½¬æ¢å¼‚å¸¸ï¼šClassCastException
4. è¿­ä»£å™¨éå†æ²¡æœ‰æ­¤å…ƒç´ å¼‚å¸¸ï¼šNoSuchElementException
5. ç®—æœ¯å¼‚å¸¸ï¼ˆæ•°å­¦æ“ä½œå¼‚å¸¸ï¼‰ï¼šArithmeticException
6. æ•°å­—è½¬æ¢å¼‚å¸¸ï¼š NumberFormatException

```java
public class ExceptionDemo {
    public static void main(String[] args) {
        System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
        // 1.æ•°ç»„ç´¢å¼•è¶Šç•Œå¼‚å¸¸: ArrayIndexOutOfBoundsExceptionã€‚
        int[] arrs = {10 ,20 ,30};
        System.out.println(arrs[3]); //å‡ºç°äº†æ•°ç»„ç´¢å¼•è¶Šç•Œå¼‚å¸¸ã€‚ä»£ç åœ¨æ­¤å¤„ç›´æ¥æ‰§è¡Œæ­»äº¡ï¼

        // 2.ç©ºæŒ‡é’ˆå¼‚å¸¸ : NullPointerExceptionã€‚
        String name = null ;
        System.out.println(name); // ç›´æ¥è¾“å‡ºæ²¡æœ‰é—®é¢˜
        System.out.println(name.length());//å‡ºç°äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ä»£ç ç›´æ¥æ‰§è¡Œæ­»äº¡ï¼

        /** 3.ç±»å‹è½¬æ¢å¼‚å¸¸ï¼šClassCastExceptionã€‚ */
        Object o = "é½å¤©å¤§åœ£";
        Integer s = (Integer) o;  // æ­¤å¤„å‡ºç°äº†ç±»å‹è½¬æ¢å¼‚å¸¸ã€‚ä»£ç åœ¨æ­¤å¤„ç›´æ¥æ‰§è¡Œæ­»äº¡ï¼

        /** 5.æ•°å­¦æ“ä½œå¼‚å¸¸ï¼šArithmeticExceptionã€‚ */
        int c = 10 / 0 ; // æ­¤å¤„å‡ºç°äº†æ•°å­¦æ“ä½œå¼‚å¸¸ã€‚ä»£ç åœ¨æ­¤å¤„ç›´æ¥æ‰§è¡Œæ­»äº¡ï¼

        /** 6.æ•°å­—è½¬æ¢å¼‚å¸¸ï¼š NumberFormatExceptionã€‚ */
        String num = "23aa";
        Integer it = Integer.valueOf(num); //å‡ºç°äº†æ•°å­—è½¬æ¢å¼‚å¸¸ã€‚ä»£ç åœ¨æ­¤å¤„æ‰§è¡Œæ­»äº¡ï¼

        System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
    }
}
```



****



#### å¤„ç†æœºåˆ¶

è¿è¡Œæ—¶å¼‚å¸¸åœ¨ç¼–è¯‘é˜¶æ®µæ˜¯ä¸ä¼šæŠ¥é”™ï¼Œåœ¨è¿è¡Œé˜¶æ®µæ‰ä¼šå‡ºé”™ï¼Œè¿è¡Œæ—¶å‡ºé”™äº†ç¨‹åºè¿˜æ˜¯ä¼šåœæ­¢ï¼Œè¿è¡Œæ—¶å¼‚å¸¸ä¹Ÿå»ºè®®è¦å¤„ç†ï¼Œè¿è¡Œæ—¶å¼‚å¸¸æ˜¯è‡ªåŠ¨å¾€å¤–æŠ›å‡ºçš„ï¼Œä¸éœ€è¦æ‰‹å·¥æŠ›å‡º

**è¿è¡Œæ—¶å¼‚å¸¸çš„å¤„ç†è§„èŒƒ**ï¼šç›´æ¥åœ¨æœ€å¤–å±‚æ•è·å¤„ç†å³å¯ï¼Œåº•å±‚ä¼šè‡ªåŠ¨æŠ›å‡ºï¼ï¼

```java
public class ExceptionDemo{
    public static void main(String[] args){
        System.out.println("ç¨‹åºå¼€å§‹ã€‚ã€‚ã€‚ã€‚");
        try{
            chu(10 / 0);//ArithmeticException: / by zero
            System.out.println("æ“ä½œæˆåŠŸï¼");//æ²¡è¾“å‡º
        }catch (Exception e){
            e.printStackTrace();
            System.out.println("æ“ä½œå¤±è´¥ï¼");//è¾“å‡ºäº†
        }
        System.out.println("ç¨‹åºç»“æŸã€‚ã€‚ã€‚ã€‚");//è¾“å‡ºäº†
    }
    
    public static void chu(int a , int b)  { System.out.println( a / b );}
}
```



***



### Finally

ç”¨åœ¨æ•è·å¤„ç†çš„å¼‚å¸¸æ ¼å¼ä¸­çš„ï¼Œæ”¾åœ¨æœ€åé¢ã€‚

```java
try{
    // å¯èƒ½å‡ºç°å¼‚å¸¸çš„ä»£ç ï¼
}catch(Exception e){
    e.printStackTrace();
}finally{
    // æ— è®ºä»£ç æ˜¯å‡ºç°å¼‚å¸¸è¿˜æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œæœ€ç»ˆä¸€å®šè¦æ‰§è¡Œè¿™é‡Œçš„ä»£ç ï¼ï¼
}
try: 1æ¬¡ã€‚
catchï¼š0-Næ¬¡  (å¦‚æœæœ‰finallyé‚£ä¹ˆcatchå¯ä»¥æ²¡æœ‰!!)
finally: 0-1æ¬¡
```



**finallyçš„ä½œç”¨**ï¼šå¯ä»¥åœ¨ä»£ç æ‰§è¡Œå®Œæ¯•ä»¥åè¿›è¡Œèµ„æºçš„é‡Šæ”¾æ“ä½œ

èµ„æºï¼šèµ„æºéƒ½æ˜¯å®ç°äº† Closeable æ¥å£çš„ï¼Œéƒ½è‡ªå¸¦ close() å…³é—­æ–¹æ³•ï¼

æ³¨æ„ï¼šå¦‚æœåœ¨ finally ä¸­å‡ºç°äº† returnï¼Œä¼šåæ‰å¼‚å¸¸

```java
public class FinallyDemo {
    public static void main(String[] args) {
        System.out.println(chu());//ä¸€å®šä¼šè¾“å‡º finally,ä¼˜å…ˆçº§æ¯”returné«˜
    }

    public static int chu(){
        try{
            int a = 10 / 2 ;
            return a ;
        }catch (Exception e){
            e.printStackTrace();
            return -1;
        }finally {
            System.out.println("=====finallyè¢«æ‰§è¡Œ");
            //return 111; // ä¸å»ºè®®åœ¨finallyä¸­å†™returnï¼Œä¼šè¦†ç›–å‰é¢æ‰€æœ‰çš„returnå€¼!
        }
    }
    public static void test(){
        InputStream is = null;
        try{
            is = new FileInputStream("D:/cang.png");
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            System.out.println("==finallyè¢«æ‰§è¡Œ===");
            // å›æ”¶èµ„æºã€‚ç”¨äºåœ¨ä»£ç æ‰§è¡Œå®Œæ¯•ä»¥åè¿›è¡Œèµ„æºçš„å›æ”¶æ“ä½œï¼
            try {
                if(is!=null)is.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```



***



### è‡ªå®šä¹‰

è‡ªå®šä¹‰å¼‚å¸¸:

* è‡ªå®šä¹‰ç¼–è¯‘æ—¶å¼‚å¸¸ï¼šå®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±»ç»§æ‰¿ Exceptionï¼Œé‡å†™æ„é€ å™¨ï¼Œåœ¨å‡ºç°å¼‚å¸¸çš„åœ°æ–¹ç”¨throw new è‡ªå®šä¹‰å¯¹è±¡æŠ›å‡º
* è‡ªå®šä¹‰è¿è¡Œæ—¶å¼‚å¸¸ï¼šå®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±»ç»§æ‰¿ RuntimeExceptionï¼Œé‡å†™æ„é€ å™¨ï¼Œåœ¨å‡ºç°å¼‚å¸¸çš„åœ°æ–¹ç”¨ throw new  è‡ªå®šä¹‰å¯¹è±¡æŠ›å‡º!

**throws: ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œç”¨äºæŠ›å‡ºæ–¹æ³•ä¸­çš„å¼‚å¸¸**

**throw:  ç”¨åœ¨å‡ºç°å¼‚å¸¸çš„åœ°æ–¹ï¼Œåˆ›å»ºå¼‚å¸¸å¯¹è±¡ä¸”ç«‹å³ä»æ­¤å¤„æŠ›å‡º**

```java
//éœ€æ±‚ï¼šè®¤ä¸ºå¹´é¾„å°äº0å²ï¼Œå¤§äº200å²å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸ã€‚
public class ExceptionDemo {
    public static void main(String[] args) {
        try {
            checkAge(101);
        } catch (AgeIllegalException e) {
            e.printStackTrace();
        }
    }

    public static void checkAge(int age) throws ItheimaAgeIllegalException {
        if(age < 0 || age > 200){//å¹´é¾„åœ¨0-200ä¹‹é—´
            throw new AgeIllegalException("/ age is illegal!");
            //throw new AgeIllegalRuntimeException("/ age is illegal!");
        }else{
            System.out.println("å¹´é¾„æ˜¯ï¼š" + age);
        }
    }
}

public class AgeIllegalException extends Exception{
    Alt + Insert->Constructor 
}//ç¼–è¯‘æ—¶å¼‚å¸¸
public class AgeIllegalRuntimeException extends RuntimeException{
	public AgeIllegalRuntimeException() {
    }

    public AgeIllegalRuntimeException(String message) {
        super(message);
    }
}//è¿è¡Œæ—¶å¼‚å¸¸
```



***



### å¼‚å¸¸è§„èŒƒ

å¼‚å¸¸çš„è¯­æ³•æ³¨æ„ï¼š

1. è¿è¡Œæ—¶å¼‚å¸¸è¢«æŠ›å‡ºå¯ä»¥ä¸å¤„ç†ï¼Œå¯ä»¥è‡ªåŠ¨æŠ›å‡ºï¼›**ç¼–è¯‘æ—¶å¼‚å¸¸å¿…é¡»å¤„ç†**ï¼›æŒ‰ç…§è§„èŒƒéƒ½åº”è¯¥å¤„ç†
2. **é‡å†™æ–¹æ³•ç”³æ˜æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå­ç±»æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹å¿…é¡»æ˜¯çˆ¶ç±»æŠ›å‡ºå¼‚å¸¸ç±»å‹æˆ–ä¸ºå…¶å­ç±»å‹**
3. æ–¹æ³•é»˜è®¤éƒ½å¯ä»¥è‡ªåŠ¨æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œ throws RuntimeException å¯ä»¥çœç•¥ä¸å†™
4. å½“å¤šå¼‚å¸¸å¤„ç†æ—¶ï¼Œæ•è·å¤„ç†ï¼Œå‰é¢çš„å¼‚å¸¸ç±»ä¸èƒ½æ˜¯åé¢å¼‚å¸¸ç±»çš„çˆ¶ç±»ã€‚
5. åœ¨ try/catch åå¯ä»¥è¿½åŠ  finally ä»£ç å—ï¼Œå…¶ä¸­çš„ä»£ç ä¸€å®šä¼šè¢«æ‰§è¡Œï¼Œé€šå¸¸ç”¨äºèµ„æºå›æ”¶æ“ä½œ

å¼‚å¸¸çš„ä½œç”¨ï¼š

1. å¯ä»¥å¤„ç†ä»£ç é—®é¢˜ï¼Œé˜²æ­¢ç¨‹åºå‡ºç°å¼‚å¸¸åçš„æ­»äº¡

2. æé«˜äº†ç¨‹åºçš„å¥å£®æ€§å’Œå®‰å…¨æ€§

```java
public class Demo{
    public static void main(String[] args){
        //è¯·è¾“å…¥ä¸€ä¸ªåˆæ³•çš„å¹´é¾„
        while(true){
            try{
                Scanner sc = new Scanner(System.in);
                System.out.println("è¯·æ‚¨è¾“å…¥æ‚¨çš„å¹´å¹´é¾„ï¼š");
                int age = sc.nextInt();
                System.out.println("å¹´é¾„ï¼š"+age);
                break;
            }catch(Exception e){
                System.err.println("æ‚¨çš„å¹´é¾„æ˜¯çè¾“å…¥çš„ï¼");
            }
        }
    }
}
```





***



## Î»

### lambda

#### åŸºæœ¬ä»‹ç»

Lambdaè¡¨è¾¾å¼æ˜¯JDK1.8å¼€å§‹ä¹‹åçš„æ–°æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§ä»£ç çš„æ–°è¯­æ³•ï¼Œä¸€ç§ç‰¹æ®Šå†™æ³•

ä½œç”¨ï¼šä¸ºäº†ç®€åŒ–åŒ¿åå†…éƒ¨ç±»çš„ä»£ç å†™æ³•

Lambdaè¡¨è¾¾å¼çš„æ ¼å¼:

```java
(åŒ¿åå†…éƒ¨ç±»è¢«é‡å†™æ–¹æ³•çš„å½¢å‚åˆ—è¡¨) -> {
	//è¢«é‡å†™æ–¹æ³•çš„æ–¹æ³•ä½“ä»£ç ã€‚
}
```

Lambdaè¡¨è¾¾å¼å¹¶ä¸èƒ½ç®€åŒ–æ‰€æœ‰åŒ¿åå†…éƒ¨ç±»çš„å†™æ³•ï¼Œåªèƒ½ç®€åŒ–**å‡½æ•°å¼æ¥å£çš„åŒ¿åå†…éƒ¨ç±»**

ç®€åŒ–æ¡ä»¶ï¼šé¦–å…ˆå¿…é¡»æ˜¯æ¥å£ï¼Œæ¥å£ä¸­åªèƒ½æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•

@FunctionalInterfaceå‡½æ•°å¼æ¥å£æ³¨è§£ï¼šä¸€æ—¦æŸä¸ªæ¥å£åŠ ä¸Šäº†è¿™ä¸ªæ³¨è§£ï¼Œè¿™ä¸ªæ¥å£åªèƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•



***



#### ç®€åŒ–æ–¹æ³•

Lambdaè¡¨è¾¾å¼çš„çœç•¥å†™æ³•ï¼ˆè¿›ä¸€æ­¥åœ¨Lambdaè¡¨è¾¾å¼çš„åŸºç¡€ä¸Šç»§ç»­ç®€åŒ–ï¼‰

* å¦‚æœLambdaè¡¨è¾¾å¼çš„æ–¹æ³•ä½“ä»£ç åªæœ‰ä¸€è¡Œä»£ç ï¼Œå¯ä»¥çœç•¥å¤§æ‹¬å·ä¸å†™ï¼ŒåŒæ—¶è¦çœç•¥åˆ†å·ï¼›å¦‚æœè¿™è¡Œä»£ç æ˜¯returnè¯­å¥ï¼Œå¿…é¡»çœç•¥returnä¸å†™
* å‚æ•°ç±»å‹å¯ä»¥çœç•¥ä¸å†™
* å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°ç±»å‹å¯ä»¥çœç•¥ï¼ŒåŒæ—¶()ä¹Ÿå¯ä»¥çœç•¥

```java
List<String> names = new ArrayList<>();
names.add("èƒ¡");
names.add("ç”˜");
names.add("æ´ª");

names.forEach(new Consumer<String>() {
    @Override
    public void accept(String s) {
        System.out.println(s);
    }
});

names.forEach((String s) -> {
        System.out.println(s);
});

names.forEach((s) -> {
    System.out.println(s);
});

names.forEach(s -> {
    System.out.println(s);
});

names.forEach(s -> System.out.println(s) );
```



***



#### å¸¸ç”¨ç®€åŒ–

##### Runnable

```java
//1.
Thread t = new Thread(new Runnable() {
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName()+":æ‰§è¡Œ~~~");
    }
});
t.start();

//2.
Thread t1 = new Thread(() -> {
    System.out.println(Thread.currentThread().getName()+":æ‰§è¡Œ~~~");
});
t1.start();
//3.
new Thread(() -> {
    System.out.println(Thread.currentThread().getName()+":æ‰§è¡Œ~~~");
}).start();

//4.ä¸€è¡Œä»£ç 
new Thread(() -> System.out.println(Thread.currentThread().getName()+":æ‰§è¡Œ~~~")).start();
```



##### Comparator

```java
public class CollectionsDemo {
    public static void main(String[] args) {
        List<Student> lists = new ArrayList<>();//...s1 s2 s3
        Collections.addAll(lists , s1 , s2 , s3);
        Collections.sort(lists, new Comparator<Student>() {
            @Override
            public int compare(Student s1, Student s2) {
                return s1.getAge() - s2.getAge();
            }
        });
        
        // ç®€åŒ–å†™æ³•
        Collections.sort(lists ,(Student t1, Student t2) -> {
                return t1.getAge() - t2.getAge();
        });
        // å‚æ•°ç±»å‹å¯ä»¥çœç•¥,æœ€ç®€å•çš„
        Collections.sort(lists ,(t1,t2) -> t1.getAge()-t2.getAge());
    }
}
```





***



### æ–¹æ³•å¼•ç”¨

#### åŸºæœ¬ä»‹ç»

æ–¹æ³•å¼•ç”¨ï¼šæ–¹æ³•å¼•ç”¨æ˜¯ä¸ºäº†è¿›ä¸€æ­¥ç®€åŒ–Lambdaè¡¨è¾¾å¼çš„å†™æ³•

æ–¹æ³•å¼•ç”¨çš„æ ¼å¼ï¼šç±»å‹æˆ–è€…å¯¹è±¡::å¼•ç”¨çš„æ–¹æ³•

å…³é”®è¯­æ³•æ˜¯ï¼š`::`

```java
lists.forEach( s -> System.out.println(s));
// æ–¹æ³•å¼•ç”¨ï¼
lists.forEach(System.out::println);
```



***



#### é™æ€æ–¹æ³•

å¼•ç”¨æ ¼å¼ï¼š`ç±»å::é™æ€æ–¹æ³•`

ç®€åŒ–æ­¥éª¤ï¼šå®šä¹‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼ŒæŠŠéœ€è¦ç®€åŒ–çš„ä»£ç æ”¾åˆ°ä¸€ä¸ªé™æ€æ–¹æ³•ä¸­å»

é™æ€æ–¹æ³•å¼•ç”¨çš„æ³¨æ„äº‹é¡¹ï¼šè¢«å¼•ç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨è¦å’Œå‡½æ•°å¼æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸€è‡´,æ‰èƒ½å¼•ç”¨ç®€åŒ–

```java
//å®šä¹‰é›†åˆåŠ å…¥å‡ ä¸ªStudentå…ƒç´ 
// ä½¿ç”¨é™æ€æ–¹æ³•è¿›è¡Œç®€åŒ–ï¼
Collections.sort(lists, (o1, o2) -> Student.compareByAge(o1 , o2));
// å¦‚æœå‰åå‚æ•°æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œæ—¢å¯ä»¥ä½¿ç”¨é™æ€æ–¹æ³•å¼•ç”¨
Collections.sort(lists, Student::compareByAge);

public class Student {
    private String name ;
    private int age ;

    public static int compareByAge(Student o1 , Student o2){
        return  o1.getAge() - o2.getAge();
    }
}
```



***



#### å®ä¾‹æ–¹æ³•

å¼•ç”¨æ ¼å¼ï¼š`å¯¹è±¡::å®ä¾‹æ–¹æ³•`

ç®€åŒ–æ­¥éª¤ï¼šå®šä¹‰ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼ŒæŠŠéœ€è¦çš„ä»£ç æ”¾åˆ°å®ä¾‹æ–¹æ³•ä¸­å»

å®ä¾‹æ–¹æ³•å¼•ç”¨çš„æ³¨æ„äº‹é¡¹ï¼šè¢«å¼•ç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨è¦å’Œå‡½æ•°å¼æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸€è‡´ã€‚

```java
public class MethodDemo {
    public static void main(String[] args) {
        List<String> lists = new ArrayList<>();
        lists.add("java1");
        lists.add("java2");
        lists.add("java3");
        // å¯¹è±¡æ˜¯ System.out = new PrintStream();
        // å®ä¾‹æ–¹æ³•ï¼šprintln()
        // å‰åå‚æ•°æ­£å¥½éƒ½æ˜¯ä¸€ä¸ª
        lists.forEach(s -> System.out.println(s));
        lists.forEach(System.out::println);
    }
}
```



***



#### ç‰¹å®šç±»å‹

ç‰¹å®šç±»å‹ï¼šStringï¼Œä»»ä½•ç±»å‹

å¼•ç”¨æ ¼å¼ï¼š`ç‰¹å®šç±»å‹::æ–¹æ³•`

æ³¨æ„äº‹é¡¹ï¼šå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°åˆ—è¡¨ä¸­çš„å½¢å‚ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºäº†åé¢çš„æ–¹æ³•çš„è°ƒç”¨è€…ï¼Œå¹¶ä¸”å…¶ä½™å‚æ•°ä½œä¸ºåé¢æ–¹æ³•çš„å½¢å‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ç‰¹å®šç±»å‹æ–¹æ³•å¼•ç”¨äº†

```java
public class MethodDemo{
    public static void main(String[] args) {
        String[] strs = new String[]{"James", "AA", "John",
                "Patricia","Dlei" , "Robert","Boom", "Cao" ,"black" ,
                "Michael", "Linda","cao","after","sBBB"};

        // public static <T> void sort(T[] a, Comparator<? super T> c)
        // éœ€æ±‚ï¼šæŒ‰ç…§å…ƒç´ çš„é¦–å­—ç¬¦(å¿½ç•¥å¤§å°å†™)å‡åºæ’åºï¼ï¼ï¼
        Arrays.sort(strs, new Comparator<String>() {
            @Override
            public int compare(String s1, String s2) {
                return s1.compareToIgnoreCase(s2);//æŒ‰ç…§å…ƒç´ çš„é¦–å­—ç¬¦(å¿½ç•¥å¤§å°å†™)
            }
        });

        Arrays.sort(strs, ( s1,  s2 ) ->  s1.compareToIgnoreCase(s2));

        // ç‰¹å®šç±»å‹çš„æ–¹æ³•å¼•ç”¨ï¼š
        Arrays.sort(strs,  String::compareToIgnoreCase);
        System.out.println(Arrays.toString(strs));
    }
}
```



***



#### æ„é€ å™¨

æ ¼å¼ï¼š`ç±»å::new`

æ³¨æ„äº‹é¡¹ï¼šå‰åå‚æ•°ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œåˆåœ¨åˆ›å»ºå¯¹è±¡ï¼Œå°±å¯ä»¥ä½¿ç”¨æ„é€ å™¨å¼•ç”¨

```java
public class ConstructorDemo {
    public static void main(String[] args) {
        List<String> lists = new ArrayList<>();
        lists.add("java1");
        lists.add("java2");
        lists.add("java3");

        // é›†åˆé»˜è®¤åªèƒ½è½¬æˆObjectç±»å‹çš„æ•°ç»„ã€‚
        Object[] objs = lists.toArray();

        // æˆ‘ä»¬æƒ³æŒ‡å®šè½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹çš„æ•°ç»„ï¼æœ€æ–°çš„å†™æ³•å¯ä»¥ç»“åˆæ„é€ å™¨å¼•ç”¨å®ç° 
        String[] strs = lists.toArray(new IntFunction<String[]>() {
            @Override
            public String[] apply(int value) {
                return new String[value];
            }
        });
        String[] strs1 = lists.toArray(s -> new String[s]);
        String[] strs2 = lists.toArray(String[]::new);

        System.out.println("Stringç±»å‹çš„æ•°ç»„ï¼š"+ Arrays.toString(strs2));
    }
}
```





***



## I/O

### Stream

#### æ¦‚è¿°

Stream æµå…¶å®å°±æ˜¯ä¸€æ ¹ä¼ é€å¸¦ï¼Œå…ƒç´ åœ¨ä¸Šé¢å¯ä»¥è¢« Stream æµæ“ä½œ

ä½œç”¨ï¼š

* å¯ä»¥è§£å†³å·²æœ‰é›†åˆç±»åº“æˆ–è€…æ•°ç»„APIçš„å¼Šç«¯ã€‚
* Stream æµç®€åŒ–é›†åˆå’Œæ•°ç»„çš„æ“ä½œ
* é“¾å¼ç¼–ç¨‹

```java
list.stream().filter(new Predicate<String>() {
            @Override
            public boolean test(String s) {
                return s.startsWith("å¼ ");
            }
        });

list.stream().filter(s -> s.startsWith("å¼ "));
```



***



#### è·å–æµ

é›†åˆè·å– Stream æµç”¨ï¼šdefault Stream<E> stream()

æ•°ç»„ï¼šArrays.stream(æ•°ç»„)   /  Stream.of(æ•°ç»„);

```java
// Collectioné›†åˆè·å–Streamæµã€‚
Collection<String> c = new ArrayList<>();
Stream<String> listStream = c.stream();

//Mapé›†åˆè·å–æµ
// å…ˆè·å–é”®çš„Streamæµã€‚
Stream<String> keysStream = map.keySet().stream();
// åœ¨è·å–å€¼çš„Streamæµ
Stream<Integer> valuesStream = map.values().stream();
// è·å–é”®å€¼å¯¹çš„Streamæµï¼ˆkey=valueï¼š Map.Entry<String,Integer>ï¼‰
Stream<Map.Entry<String,Integer>> keyAndValues = map.entrySet().stream();

//æ•°ç»„è·å–æµ
String[] arr = new String[]{"Java", "JavaEE" ,"Spring Boot"};
Stream<String> arrStream1 = Arrays.stream(arr);
Stream<String> arrStream2 = Stream.of(arr);
```



****



#### å¸¸ç”¨API

| æ–¹æ³•å                                                    | è¯´æ˜                                                     |
| --------------------------------------------------------- | -------------------------------------------------------- |
| void forEach(Consumer<? super T> action)                  | é€ä¸€å¤„ç†(éå†)                                           |
| long count                                                | è¿”å›æµä¸­çš„å…ƒç´ æ•°                                         |
| Stream<T> filterPredicate<? super T> predicate)           | ç”¨äºå¯¹æµä¸­çš„æ•°æ®è¿›è¡Œè¿‡æ»¤                                 |
| Stream<T> limit(long maxSize)                             | è¿”å›æ­¤æµä¸­çš„å…ƒç´ ç»„æˆçš„æµï¼Œæˆªå–å‰æŒ‡å®šå‚æ•°ä¸ªæ•°çš„æ•°æ®       |
| Stream<T> skip(long n)                                    | è·³è¿‡æŒ‡å®šå‚æ•°ä¸ªæ•°çš„æ•°æ®ï¼Œè¿”å›ç”±è¯¥æµçš„å‰©ä½™å…ƒç´ ç»„æˆçš„æµ     |
| <R> Stream<R> map(Function<? super T,? extends R> mapper) | åŠ å·¥æ–¹æ³•ï¼Œå°†å½“å‰æµä¸­çš„Tç±»å‹æ•°æ®è½¬æ¢ä¸ºå¦ä¸€ç§Rç±»å‹çš„æµ     |
| static <T> Stream<T> concat(Stream a, Stream b)           | åˆå¹¶aå’Œbä¸¤ä¸ªæµä¸ºä¸€ä¸ª.  è°ƒç”¨: `Stream.concat(s1,s2);`     |
| Stream<T> distinct()                                      | è¿”å›ç”±è¯¥æµçš„ä¸åŒå…ƒç´ (æ ¹æ®Object.equals(Object) )ç»„æˆçš„æµ |

```java
public class StreamDemo {
    public static void main(String[] args) {
        List<String> list = new ArrayList<>();
        list.add("å¼ æ— å¿Œ"); list.add("å‘¨èŠ·è‹¥"); list.add("èµµæ•");
        list.add("å¼ å¼º"); list.add("å¼ ä¸‰ä¸°"); list.add("å¼ ä¸‰ä¸°");
        //å–ä»¥å¼ å¼€å¤´å¹¶ä¸”åå­—æ˜¯ä¸‰ä½æ•°çš„
        list.stream().filter(s -> s.startsWith("å¼ ")
                .filter(s -> s.length == 3).forEach(System.out::println);
        //ç»Ÿè®¡æ•°é‡
		long count = list.stream().filter(s -> s.startsWith("å¼ ")
                .filter(s -> s.length == 3).count();
		//å–å‰ä¸¤ä¸ª
		list.stream().filter(s -> s.length == 3).limit(2).forEach(...);
		//è·³è¿‡å‰ä¸¤ä¸ª
		list.stream().filter(s -> s.length == 3).skip(2).forEach(...);

		// éœ€æ±‚ï¼šæŠŠåç§°éƒ½åŠ ä¸Šâ€œå¼ ä¸‰çš„:+xxxâ€
		list.stream().map(s -> "å¼ ä¸‰çš„"+s).forEach(System.out::println);
		// éœ€æ±‚ï¼šæŠŠåç§°éƒ½åŠ å·¥å‚å­¦ç”Ÿå¯¹è±¡æ”¾ä¸Šå»!!
		// list.stream().map(name -> new Student(name));
		list.stream.map(Student::new).forEach(System.out::println);
                                          	
		//æ•°ç»„æµ
		Stream<Integer> s1 = Stream.of(10,20,30,40,50);
		//é›†åˆæµ
		Stream<String> s2 = list.stream();
		//åˆå¹¶æµ
		Stream<Object> s3 = Stream.concat(s1,s2);
		s3.forEach(System.out::println);
    }
}
class Student{
    private String name;
    //......
}                                          
```



***



#### ç»ˆç»“æ–¹æ³•

ç»ˆç»“æ–¹æ³•ï¼šStream è°ƒç”¨äº†ç»ˆç»“æ–¹æ³•ï¼Œæµçš„æ“ä½œå°±å…¨éƒ¨ç»ˆç»“ï¼Œä¸èƒ½ç»§ç»­ä½¿ç”¨ï¼Œå¦‚ foreachï¼Œcount æ–¹æ³•ç­‰

éç»ˆç»“æ–¹æ³•ï¼šæ¯æ¬¡è°ƒç”¨å®Œæˆä»¥åè¿”å›ä¸€ä¸ªæ–°çš„æµå¯¹è±¡ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œæ”¯æŒ**é“¾å¼ç¼–ç¨‹**ï¼

```java
// foreachç»ˆç»“æ–¹æ³•
list.stream().filter(s -> s.startsWith("å¼ "))
    .filter(s -> s.length() == 3).forEach(System.out::println);
```



***



#### æ”¶é›†æµ

æ”¶é›† Streamï¼šæŠŠ Stream æµçš„æ•°æ®è½¬å›åˆ°é›†åˆä¸­å»

* Streamæµï¼šå·¥å…·
* é›†åˆï¼šç›®çš„

| æ–¹æ³•å                                                       | è¯´æ˜                   |
| ------------------------------------------------------------ | ---------------------- |
| R collect(Collector collector)                               | æŠŠç»“æœæ”¶é›†åˆ°é›†åˆä¸­     |
| public static <T> Collector toList()                         | æŠŠå…ƒç´ æ”¶é›†åˆ°Listé›†åˆä¸­ |
| public static <T> Collector toSet()                          | æŠŠå…ƒç´ æ”¶é›†åˆ°Seté›†åˆä¸­  |
| public static  Collector toMap(Function keyMapper,Function valueMapper) | æŠŠå…ƒç´ æ”¶é›†åˆ°Mapé›†åˆä¸­  |
| Object[] toArray()                                           | æŠŠå…ƒç´ æ”¶é›†æ•°ç»„ä¸­       |

```java
public static void main(String[] args) {
	List<String> list = new ArrayList<>();
	Stream<String> stream=list.stream().filter(s -> s.startsWith("å¼ "));    
    //æŠŠstreamæµè½¬æ¢æˆSeté›†åˆã€‚
    Set<String> set = stream.collect(Collectors.toSet());
    
    //æŠŠstreamæµè½¬æ¢æˆListé›†åˆã€‚
    //é‡æ–°å®šä¹‰ï¼Œå› ä¸ºèµ„æºå·²ç»è¢«å…³é—­äº†
    Stream<String> stream1=list.stream().filter(s -> s.startsWith("å¼ "));
    List<String> list = stream.collect(Collectors.toList());
    
    //æŠŠstreamæµè½¬æ¢æˆæ•°ç»„ã€‚
    Stream<String> stream2 =list.stream().filter(s -> s.startsWith("å¼ "));
    Object[] arr = stream2.toArray();
    // å¯ä»¥å€Ÿç”¨æ„é€ å™¨å¼•ç”¨ç”³æ˜è½¬æ¢æˆçš„æ•°ç»„ç±»å‹ï¼ï¼ï¼
    String[] arr1 = stream2.toArray(String[]::new);
}
```



***



### File

#### æ–‡ä»¶ç±»

File ç±»ï¼šä»£è¡¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å¯¹è±¡ï¼Œæ˜¯ç”¨æ¥æ“ä½œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å¯¹è±¡çš„ï¼Œåˆ é™¤æ–‡ä»¶ï¼Œè·å–æ–‡ä»¶ä¿¡æ¯ï¼Œåˆ›å»ºæ–‡ä»¶ï¼ˆæ–‡ä»¶å¤¹ï¼‰ï¼Œå¹¿ä¹‰æ¥è¯´æ“ä½œç³»ç»Ÿè®¤ä¸ºæ–‡ä»¶åŒ…å«ï¼ˆæ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼‰

File ç±»æ„é€ å™¨ï¼š
	`public File(String pathname)`ï¼šæ ¹æ®è·¯å¾„è·å–æ–‡ä»¶å¯¹è±¡
	`public File(String parent , String child)`ï¼šæ ¹æ®çˆ¶è·¯å¾„å’Œæ–‡ä»¶åç§°è·å–æ–‡ä»¶å¯¹è±¡ï¼
	`public File(File parent , String child)`

File ç±»åˆ›å»ºæ–‡ä»¶å¯¹è±¡çš„æ ¼å¼:

* `File f = new File("ç»å¯¹è·¯å¾„/ç›¸å¯¹è·¯å¾„");`
  * ç»å¯¹è·¯å¾„ï¼šä»ç£ç›˜çš„çš„ç›˜ç¬¦ä¸€è·¯èµ°åˆ°ç›®çš„ä½ç½®çš„è·¯å¾„ã€‚
    * ç»å¯¹è·¯å¾„ä¾èµ–å…·ä½“çš„ç¯å¢ƒï¼Œä¸€æ—¦è„±ç¦»ç¯å¢ƒï¼Œä»£ç å¯èƒ½å‡ºé”™
    * ä¸€èˆ¬æ˜¯å®šä½æŸä¸ªæ“ä½œç³»ç»Ÿä¸­çš„æŸä¸ªæ–‡ä»¶å¯¹è±¡
  * **ç›¸å¯¹è·¯å¾„**ï¼šä¸å¸¦ç›˜ç¬¦çš„ï¼ˆé‡ç‚¹ï¼‰
    * é»˜è®¤æ˜¯ç›´æ¥ç›¸å¯¹åˆ°å·¥ç¨‹ç›®å½•ä¸‹å¯»æ‰¾æ–‡ä»¶çš„ã€‚
    * ç›¸å¯¹è·¯å¾„åªèƒ½ç”¨äºå¯»æ‰¾å·¥ç¨‹ä¸‹çš„æ–‡ä»¶ï¼Œå¯ä»¥è·¨å¹³å°

* `File f = new File("æ–‡ä»¶å¯¹è±¡/æ–‡ä»¶å¤¹å¯¹è±¡")` å¹¿ä¹‰æ¥è¯´ï¼šæ–‡ä»¶æ˜¯åŒ…å«æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„

```java
public class FileDemo{
    public static void main(String[] args) {
        // 1.åˆ›å»ºæ–‡ä»¶å¯¹è±¡ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„
        // æ–‡ä»¶è·¯å¾„åˆ†éš”ç¬¦ï¼š
        //      -- a.ä½¿ç”¨æ­£æ–œæ ï¼š /
        //      -- b.ä½¿ç”¨åæ–œæ ï¼š \\
        //      -- c.ä½¿ç”¨åˆ†éš”ç¬¦API:File.separator
        //File f1 = new File("D:"+File.separator+"it"+File.separator
		//+"å›¾ç‰‡èµ„æº"+File.separator+"beautiful.jpg");
        File f1 = new File("D:\\seazean\\å›¾ç‰‡èµ„æº\\beautiful.jpg");
        System.out.println(f1.length()); // è·å–æ–‡ä»¶çš„å¤§å°ï¼Œå­—èŠ‚å¤§å°

        // 2.åˆ›å»ºæ–‡ä»¶å¯¹è±¡ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
        File f2 = new File("Day09Demo/src/dlei.txt");
        System.out.println(f2.length());

        // 3.åˆ›å»ºæ–‡ä»¶å¯¹è±¡ï¼šä»£è¡¨æ–‡ä»¶å¤¹ã€‚
        File f3 = new File("D:\\it\\å›¾ç‰‡èµ„æº");
        System.out.println(f3.exists());// åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼ï¼
    }
}
```



***



#### å¸¸ç”¨API

##### å¸¸ç”¨æ–¹æ³•

`public String getAbsolutePath()` : è¿”å›æ­¤Fileçš„ç»å¯¹è·¯å¾„åå­—ç¬¦ä¸²ã€‚
`public String getPath()` : è·å–åˆ›å»ºæ–‡ä»¶å¯¹è±¡çš„æ—¶å€™ç”¨çš„è·¯å¾„
`public String getName()` : è¿”å›ç”±æ­¤Fileè¡¨ç¤ºçš„æ–‡ä»¶æˆ–ç›®å½•çš„åç§°ã€‚
`public long length()` : è¿”å›ç”±æ­¤Fileè¡¨ç¤ºçš„æ–‡ä»¶çš„é•¿åº¦ï¼ˆå¤§å°ï¼‰ã€‚
`public long length(FileFilter filter)` : æ–‡ä»¶è¿‡æ»¤å™¨ã€‚

```java
public class FileDemo {
    public static void main(String[] args) {
        // 1.ç»å¯¹è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¯¹è±¡
        File f1 = new File("E:/å›¾ç‰‡/meinv.jpg");
        // a.è·å–å®ƒçš„ç»å¯¹è·¯å¾„ã€‚
        System.out.println(f1.getAbsolutePath());
        // b.è·å–æ–‡ä»¶å®šä¹‰çš„æ—¶å€™ä½¿ç”¨çš„è·¯å¾„ã€‚
        System.out.println(f1.getPath());
        // c.è·å–æ–‡ä»¶çš„åç§°ï¼šå¸¦åç¼€ã€‚
        System.out.println(f1.getName());
        // d.è·å–æ–‡ä»¶çš„å¤§å°ï¼šå­—èŠ‚ä¸ªæ•°ã€‚
        System.out.println(f1.length());
        System.out.println("------------------------");

        // 2.ç›¸å¯¹è·¯å¾„
        File f2 = new File("Day09Demo/src/dlei01.txt");
        // a.è·å–å®ƒçš„ç»å¯¹è·¯å¾„ã€‚
        System.out.println(f2.getAbsolutePath());
        // b.è·å–æ–‡ä»¶å®šä¹‰çš„æ—¶å€™ä½¿ç”¨çš„è·¯å¾„ã€‚
        System.out.println(f2.getPath());
        // c.è·å–æ–‡ä»¶çš„åç§°ï¼šå¸¦åç¼€ã€‚
        System.out.println(f2.getName());
        // d.è·å–æ–‡ä»¶çš„å¤§å°ï¼šå­—èŠ‚ä¸ªæ•°ã€‚
        System.out.println(f2.length());
    }
}

```



##### åˆ¤æ–­æ–¹æ³•

`public boolean exists()` : æ­¤Fileè¡¨ç¤ºçš„æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦å®é™…å­˜åœ¨ã€‚
`public boolean isDirectory()` : æ­¤Fileè¡¨ç¤ºçš„æ˜¯å¦ä¸ºç›®å½•ã€‚
`public boolean isFile()` : æ­¤Fileè¡¨ç¤ºçš„æ˜¯å¦ä¸ºæ–‡ä»¶

```java
File f = new File("Day09Demo/src/dlei01.txt");
// a.åˆ¤æ–­æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨
System.out.println(f.exists()); // true
// b.åˆ¤æ–­æ–‡ä»¶å¯¹è±¡æ˜¯å¦æ˜¯æ–‡ä»¶,æ˜¯æ–‡ä»¶è¿”å›true ,åä¹‹
System.out.println(f.isFile()); // true
// c.åˆ¤æ–­æ–‡ä»¶å¯¹è±¡æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹,æ˜¯æ–‡ä»¶å¤¹è¿”å›true ,åä¹‹
System.out.println(f.isDirectory()); // false
```



##### åˆ›å»ºåˆ é™¤

`public boolean createNewFile()` : å½“ä¸”ä»…å½“å…·æœ‰è¯¥åç§°çš„æ–‡ä»¶å°šä¸å­˜åœ¨æ—¶ï¼Œ åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ–‡ä»¶ã€‚
`public boolean delete()` : åˆ é™¤ç”±æ­¤Fileè¡¨ç¤ºçš„æ–‡ä»¶æˆ–ç›®å½•ã€‚ ï¼ˆåªèƒ½åˆ é™¤ç©ºç›®å½•ï¼‰
`public boolean mkdir()` : åˆ›å»ºç”±æ­¤Fileè¡¨ç¤ºçš„ç›®å½•ã€‚ï¼ˆåªèƒ½åˆ›å»ºä¸€çº§ç›®å½•ï¼‰
`public boolean mkdirs()` : å¯ä»¥åˆ›å»ºå¤šçº§ç›®å½•ï¼ˆå»ºè®®ä½¿ç”¨çš„ï¼‰

```java
public class FileDemo {
    public static void main(String[] args) throws IOException {
        File f = new File("Day09Demo/src/dlei02.txt");
        // a.åˆ›å»ºæ–°æ–‡ä»¶ï¼Œåˆ›å»ºæˆåŠŸè¿”å›true ,åä¹‹
        System.out.println(f.createNewFile());

        // b.åˆ é™¤æ–‡ä»¶æˆ–è€…ç©ºæ–‡ä»¶å¤¹
        System.out.println(f.delete());
        // ä¸èƒ½åˆ é™¤éç©ºæ–‡ä»¶å¤¹ï¼Œåªèƒ½åˆ é™¤ç©ºæ–‡ä»¶å¤¹
        File f1 = new File("E:/it/aaaaa");
        System.out.println(f1.delete());

        // c.åˆ›å»ºä¸€çº§ç›®å½•
        File f2 = new File("E:/bbbb");
        System.out.println(f2.mkdir());

        // d.åˆ›å»ºå¤šçº§ç›®å½•
        File f3 = new File("D:/it/e/a/d/ds/fas/fas/fas/fas/fas/fas");
        System.out.println(f3.mkdirs());
    }
}
```



***



#### éå†ç›®å½•

- `public String[] list()`ï¼š
        è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„"ä¸€çº§æ–‡ä»¶åç§°"åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ä¸­å»è¿”å›ã€‚
- `public File[] listFiles()(å¸¸ç”¨)`ï¼š
        è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„"ä¸€çº§æ–‡ä»¶å¯¹è±¡"åˆ°ä¸€ä¸ª**æ–‡ä»¶å¯¹è±¡æ•°ç»„**ä¸­å»è¿”å›ï¼ˆ**é‡ç‚¹**ï¼‰
- `public long lastModified` :
       è¿”å›æ­¤æŠ½è±¡è·¯å¾„åè¡¨ç¤ºçš„æ–‡ä»¶ä¸Šæ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚ 

```java
public class FileDemo {
    public static void main(String[] args) {
        File dir = new File("D:\\seazean");
        // a.è·å–å½“å‰ç›®å½•å¯¹è±¡ä¸‹çš„å…¨éƒ¨ä¸€çº§æ–‡ä»¶åç§°åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„è¿”å›ã€‚
        String[] names = dir.list();
        for (String name : names) {
            System.out.println(name);
        }
        // b.è·å–å½“å‰ç›®å½•å¯¹è±¡ä¸‹çš„å…¨éƒ¨ä¸€çº§æ–‡ä»¶å¯¹è±¡åˆ°ä¸€ä¸ªFileç±»å‹çš„æ•°ç»„è¿”å›ã€‚
        File[] files = dir.listFiles();
        for (File file : files) {
            System.out.println(file.getAbsolutePath());
        }

        // c
        File f1 = new File("D:\\it\\å›¾ç‰‡èµ„æº\\beautiful.jpg");
        long time = f1.lastModified(); // æœ€åä¿®æ”¹æ—¶é—´ï¼
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        System.out.println(sdf.format(time));
    }
}
```



***



#### æ–‡ä»¶æœç´¢

é€’å½’å®ç°æ–‡ä»¶æœç´¢(éè§„å¾‹é€’å½’)
	ï¼ˆ1ï¼‰å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨äºåšæœç´¢ã€‚
	ï¼ˆ2ï¼‰è¿›å…¥æ–¹æ³•ä¸­è¿›è¡Œä¸šåŠ¡æœç´¢åˆ†æã€‚

```java
/**
 * å»æŸä¸ªç›®å½•ä¸‹æœç´¢æŸä¸ªæ–‡ä»¶
 * @param dir æœç´¢æ–‡ä»¶çš„ç›®å½•ã€‚
 * @param fileName æœç´¢æ–‡ä»¶çš„åç§°ã€‚
 */
public static void searchFiles(File dir , String fileName){
    // 1.åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¯¥è·¯å¾„ï¼Œæ˜¯å¦æ˜¯æ–‡ä»¶å¤¹
    if(dir.exists() && dir.isDirectory()){
        // 2.æå–å½“å‰ç›®å½•ä¸‹çš„å…¨éƒ¨ä¸€çº§æ–‡ä»¶å¯¹è±¡
        File files = dir.listFiles();// å¯èƒ½æ˜¯null/ä¹Ÿå¯èƒ½æ˜¯ç©ºé›†åˆ[]
        // 3.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸€çº§æ–‡ä»¶å¯¹è±¡,åˆ¤æ–­æ˜¯å¦ä¸ä¸ºç©ºç›®å½•
        if(files != null && files.length > 0){
            // 4.åˆ¤æ–­ä¸€çº§æ–‡ä»¶å¯¹è±¡
            for(File file : files){
                // 5.åˆ¤æ–­fileæ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
                if(file.isFile()){
                    // 6.åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦ä¸ºæˆ‘è¦æ‰¾çš„æ–‡ä»¶å¯¹è±¡
                    if(f.getName().contains(fileName)){//æ¨¡ç³ŠæŸ¥æ‰¾
                        sout(f.getAbsolutePath());
                        try {
                            // å¯åŠ¨å®ƒï¼ˆæ‹“å±•ï¼‰
                            Runtime r = Runtime.getRuntime();
                            r.exec(f.getAbsolutePath());
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                    }
                } else {
                    // 7.è¯¥æ–‡ä»¶æ˜¯æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹è¦é€’å½’è¿›å…¥ç»§ç»­å¯»æ‰¾
                    searchFiles(file,fileName)
                }
            }
        }
    }
}
```



***



### Character

å­—ç¬¦é›†ï¼šä¸ºå­—ç¬¦ç¼–åˆ¶çš„ä¸€å¥—ç¼–å·è§„åˆ™

è®¡ç®—æœºçš„åº•å±‚æ˜¯ä¸èƒ½ç›´æ¥å­˜å‚¨å­—ç¬¦çš„ï¼Œåªèƒ½å­˜å‚¨äºŒè¿›åˆ¶ï¼Œ010101

ASCII ç¼–ç ï¼š8 ä¸ªå¼€å…³ä¸€ç»„å°±å¯ä»¥ç¼–ç å­—ç¬¦ï¼Œ1 ä¸ªå­—èŠ‚ 2^8 = 256ï¼Œ ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ä¸€ä¸ªå­—ç¬¦å®Œå…¨å¤Ÿç”¨ï¼Œè‹±æ–‡å’Œæ•°å­—åœ¨åº•å±‚å­˜å‚¨éƒ½æ˜¯é‡‡ç”¨ 1 ä¸ªå­—èŠ‚å­˜å‚¨çš„

```
a  97
b  98

A  65
B  66

0  48
1  49
```

ä¸­å›½äººï¼šä¸­å›½äººæœ‰ 9 ä¸‡å·¦å³å­—ç¬¦ï¼Œ2 ä¸ªå­—èŠ‚ç¼–ç ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ï¼Œ1 ä¸ªå­—èŠ‚ç¼–ç ä¸€ä¸ªè‹±æ–‡å­—ç¬¦ï¼Œè¿™å¥—ç¼–ç å«ï¼šGBK ç¼–ç ï¼Œå…¼å®¹ ASCII ç¼–ç è¡¨

ç¾å›½äººï¼šæ”¶é›†å…¨çƒæ‰€æœ‰çš„å­—ç¬¦ï¼Œç»Ÿä¸€ç¼–å·ï¼Œè¿™å¥—ç¼–ç å« Unicodeç¼–ç ï¼ˆä¸‡å›½ç ï¼‰ï¼Œä¸€ä¸ªè‹±æ–‡ç­‰äºä¸¤ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªä¸­æ–‡ï¼ˆå«ç¹ä½“ï¼‰ç­‰äºä¸¤ä¸ªå­—èŠ‚ï¼Œä¸­æ–‡æ ‡ç‚¹å ä¸¤ä¸ªå­—èŠ‚ï¼Œè‹±æ–‡æ ‡ç‚¹å ä¸¤ä¸ªå­—èŠ‚

* UTF-8 æ˜¯å˜ç§å½¢å¼ï¼Œä¹Ÿå¿…é¡»å…¼å®¹ASCIIç¼–ç è¡¨
* UTF-8ä¸€ä¸ªä¸­æ–‡ä¸€èˆ¬å  3 ä¸ªå­—èŠ‚ï¼Œä¸­æ–‡æ ‡ç‚¹å  3 ä¸ªï¼Œè‹±æ–‡å­—æ¯å’Œæ•°å­— 1 ä¸ªå­—èŠ‚

ç¼–ç å‰ä¸ç¼–ç åçš„ç¼–ç é›†å¿…é¡»ä¸€è‡´æ‰ä¸ä¼šä¹±ç 



***



### IOStream

#### æ¦‚è¿°

IO è¾“å…¥è¾“å‡ºæµï¼šè¾“å…¥/è¾“å‡ºæµ

* Inputï¼šè¾“å…¥
* Outputï¼šè¾“å‡º

å¼•å…¥ï¼šFileç±»åªèƒ½æ“ä½œæ–‡ä»¶å¯¹è±¡æœ¬èº«ï¼Œä¸èƒ½è¯»å†™æ–‡ä»¶å¯¹è±¡çš„å†…å®¹ï¼Œè¯»å†™æ•°æ®å†…å®¹ï¼Œåº”è¯¥ä½¿ç”¨IOæµ

IO æµæ˜¯ä¸€ä¸ªæ°´æµæ¨¡å‹ï¼šIO ç†è§£æˆæ°´ç®¡ï¼ŒæŠŠæ•°æ®ç†è§£æˆæ°´æµ

IO æµçš„åˆ†ç±»ï¼š

* æŒ‰ç…§æµçš„æ–¹å‘åˆ†ä¸ºï¼šè¾“å…¥æµï¼Œè¾“å‡ºæµã€‚
  * è¾“å‡ºæµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®å†™å‡ºåˆ°ç£ç›˜æ–‡ä»¶æˆ–è€…ç½‘ç»œä»‹è´¨ä¸­å»çš„æµç§°ä¸ºè¾“å‡ºæµ
    è¾“å‡ºæµçš„ä½œç”¨ï¼šå†™æ•°æ®åˆ°æ–‡ä»¶ï¼Œæˆ–è€…å†™æ•°æ®å‘é€ç»™åˆ«äºº
  * è¾“å…¥æµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®æˆ–è€…ç½‘ç»œä¸­çš„æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­çš„æµç§°ä¸ºè¾“å…¥æµ
    è¾“å…¥æµçš„ä½œç”¨ï¼šè¯»å–æ•°æ®åˆ°å†…å­˜
* æŒ‰ç…§æµçš„å†…å®¹åˆ†ä¸ºï¼šå­—èŠ‚æµï¼Œå­—ç¬¦æµ
  * å­—èŠ‚æµï¼šæµä¸­çš„æ•°æ®çš„æœ€å°å•ä½æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„å­—èŠ‚ï¼Œè¿™ä¸ªæµå°±æ˜¯å­—èŠ‚æµ
  * å­—ç¬¦æµï¼šæµä¸­çš„æ•°æ®çš„æœ€å°å•ä½æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„å­—ç¬¦ï¼Œè¿™ä¸ªæµå°±æ˜¯å­—ç¬¦æµï¼ˆ**é’ˆå¯¹äºæ–‡æœ¬å†…å®¹**ï¼‰

æµå¤§ä½“åˆ†ä¸ºå››å¤§ç±»ï¼š

* å­—èŠ‚è¾“å…¥æµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®æˆ–è€…ç½‘ç»œä¸­çš„æ•°æ®ä»¥ä¸€ä¸ªä¸€ä¸ªçš„å­—èŠ‚çš„å½¢å¼è¯»å…¥åˆ°å†…å­˜ä¸­å»çš„æµç§°ä¸ºå­—èŠ‚è¾“å…¥æµ
* å­—èŠ‚è¾“å‡ºæµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®ä»¥ä¸€ä¸ªä¸€ä¸ªçš„å­—èŠ‚å†™å‡ºåˆ°ç£ç›˜æ–‡ä»¶æˆ–è€…ç½‘ç»œä»‹è´¨ä¸­å»çš„æµç§°ä¸ºå­—èŠ‚è¾“å‡ºæµ
* å­—ç¬¦è¾“å…¥æµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®æˆ–è€…ç½‘ç»œä¸­çš„æ•°æ®ä»¥ä¸€ä¸ªä¸€ä¸ªçš„å­—ç¬¦çš„å½¢å¼è¯»å…¥åˆ°å†…å­˜ä¸­å»çš„æµç§°ä¸ºå­—ç¬¦è¾“å…¥æµ
* å­—ç¬¦è¾“å‡ºæµï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®ä»¥ä¸€ä¸ªä¸€ä¸ªçš„å­—ç¬¦å†™å‡ºåˆ°ç£ç›˜æ–‡ä»¶æˆ–è€…ç½‘ç»œä»‹è´¨ä¸­å»çš„æµç§°ä¸ºå­—ç¬¦è¾“å‡ºæµ

```java
IOæµçš„ä½“ç³»ï¼š
        å­—èŠ‚æµ                                   å­—ç¬¦æµ
  å­—èŠ‚è¾“å…¥æµ              å­—èŠ‚è¾“å‡ºæµ            å­—ç¬¦è¾“å…¥æµ         å­—ç¬¦è¾“å‡ºæµ
InputStream           OutputStream          Reader            Writer   (æŠ½è±¡ç±»)
FileInputStream       FileOutputStream      FileReader        FileWriter(å®ç°ç±»)
BufferedInputStream  BufferedOutputStream  BufferedReader   BufferedWriter(å®ç°ç±»ç¼“å†²æµ)
                                           InputStreamReader OutputStreamWriter
ObjectInputStream     ObjectOutputStream
```



****



#### å­—èŠ‚æµ

##### å­—èŠ‚è¾“å…¥

FileInputStream æ–‡ä»¶å­—èŠ‚è¾“å…¥æµï¼š

* ä½œç”¨ï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®æŒ‰ç…§å­—èŠ‚çš„å½¢å¼è¯»å…¥åˆ°å†…å­˜ä¸­çš„æµ

* æ„é€ å™¨ï¼š
  `public FileInputStream(File path)` : åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶å¯¹è±¡æ¥é€š
  `public FileInputStream(String pathName)` : åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æ–‡ä»¶è·¯å¾„å¯¹æ¥ï¼Œåº•å±‚å®è´¨ä¸Šåˆ›å»ºäº†Fileå¯¹è±¡ 
  
* æ–¹æ³•ï¼š
  `public int read()` : æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚è¿”å›ï¼Œè¯»å–å®Œæ¯•ä¼šè¿”å›-1
  `public int read(byte[] buffer)` : ä»å­—èŠ‚è¾“å…¥æµä¸­è¯»å–å­—èŠ‚åˆ°å­—èŠ‚æ•°ç»„ä¸­å»ï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°é‡ï¼Œæ²¡æœ‰å­—èŠ‚å¯è¯»è¿”å›-1ï¼Œ**byteä¸­æ–°è¯»å–çš„æ•°æ®é»˜è®¤æ˜¯è¦†ç›–åŸæ•°æ®**ï¼Œæ„é€ Stringéœ€è¦è®¾å®šé•¿åº¦
  `public String(byte[] bytes,int offset,int length)` : æ„é€ æ–°çš„String
  `public long transferTo(OutputStream out) ` : ä»è¾“å…¥æµä¸­è¯»å–æ‰€æœ‰å­—èŠ‚ï¼Œå¹¶æŒ‰è¯»å–çš„é¡ºåºï¼Œå°†å­—èŠ‚å†™å…¥ç»™å®šçš„è¾“å‡ºæµ`is.transferTo(os)`

```java
public class FileInputStreamDemo01 {
    public static void main(String[] args) throws Exception {
        // 1.åˆ›å»ºæ–‡ä»¶å¯¹è±¡å®šä½dlei01.txt
        File file = new File("Day09Demo/src/dlei01.txt");
        // 2.åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶æ¥é€š
        InputStream is = new FileInputStream(file);
        // 3.è¯»å–ä¸€ä¸ªå­—èŠ‚çš„ç¼–å·è¿”å›ï¼Œè¯»å–å®Œæ¯•è¿”å›-1
		//int code1 = is.read(); // è¯»å–ä¸€æ»´æ°´ï¼Œä¸€ä¸ªå­—èŠ‚
		//System.out.println((char)code1);

        // 4.ä½¿ç”¨whileè¯»å–å­—èŠ‚æ•°
        // å®šä¹‰ä¸€ä¸ªæ•´æ•°å˜é‡å­˜å‚¨å­—èŠ‚
        int ch = 0 ;
        while((ch = is.read())!= -1){
            System.out.print((char) ch);
        }
    }
}
```

ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚è¯»å–è‹±æ–‡å’Œæ•°å­—æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯ä¸€æ—¦è¯»å–ä¸­æ–‡è¾“å‡ºæ— æ³•é¿å…ä¹±ç ï¼Œå› ä¸ºä¼šæˆªæ–­ä¸­æ–‡çš„å­—èŠ‚ã€‚ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„è¯»å–æ•°æ®ï¼Œæ€§èƒ½ä¹Ÿè¾ƒå·®ï¼Œæ‰€ä»¥**ç¦æ­¢ä½¿ç”¨ä¸Šé¢çš„æ–¹æ¡ˆ**

é‡‡å–ä¸‹é¢çš„æ–¹æ¡ˆï¼š

```java
public static void main(String[] args) throws Exception {
    //ç®€åŒ–å†™æ³•ï¼Œåº•å±‚å®è´¨ä¸Šåˆ›å»ºäº†Fileå¯¹è±¡
    InputStream is = new FileInputStream("Day09Demo/src/dlei01.txt");
    byte[] buffer = new byte[3];//å¼€å‘ä¸­ä½¿ç”¨byte[1024]
    int len;
    while((len = is.read(buffer)) !=-1){
        // è¯»å–äº†å¤šå°‘å°±å€’å‡ºå¤šå°‘ï¼
        String rs = new String(buffer, 0, len);
        System.out.print(rs);
    }
}
```

```java
//å®šä¹‰ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä¸æ–‡ä»¶çš„å¤§å°åˆšåˆšä¸€æ ·å¤§ï¼Œç„¶åä¸€æ¡¶æ°´è¯»å–å…¨éƒ¨å­—èŠ‚æ•°æ®å†è¾“å‡ºï¼
//å¯ä»¥é¿å…ä¸­æ–‡è¯»å–è¾“å‡ºä¹±ç ï¼Œä½†æ˜¯å¦‚æœè¯»å–çš„æ–‡ä»¶è¿‡å¤§ï¼Œä¼šå‡ºç°å†…å­˜æº¢å‡ºï¼ï¼
//å­—èŠ‚æµå¹¶ä¸é€‚åˆè¯»å–æ–‡æœ¬æ–‡ä»¶å†…å®¹è¾“å‡ºï¼Œè¯»å†™æ–‡ä»¶å†…å®¹å»ºè®®ä½¿ç”¨å­—ç¬¦æµã€‚
/*
	byte[] buffer = new byte[(int) f.length()];
	int len = is.read(buffer);
	String rs = new String(buffer);
*/

File f = new File("Day09Demo/src/dlei03.txt");
InputStream is = new FileInputStream(f);
byte[] buffer = is.readAllBytes();
String rs = new String(buffer);
System.out.println(rs);
```



##### å­—èŠ‚è¾“å‡º

FileOutputStream æ–‡ä»¶å­—èŠ‚è¾“å‡ºæµï¼š

* ä½œç”¨ï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®ï¼ŒæŒ‰ç…§å­—èŠ‚çš„å½¢å¼å†™å‡ºåˆ°ç£ç›˜æ–‡ä»¶ä¸­å»

* æ„é€ å™¨ï¼š
  `public FileOutputStream(File file)` : åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶å¯¹è±¡
  `public FileOutputStream(String file) ` : åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶è·¯å¾„
  `public FileOutputStream(File file , boolean append)` : è¿½åŠ æ•°æ®çš„å­—èŠ‚è¾“å‡ºæµç®¡é“åˆ°ç›®æ ‡æ–‡ä»¶å¯¹è±¡
  `public FileOutputStream(String file , boolean append)` : åˆ›å»ºä¸€ä¸ªè¿½åŠ æ•°æ®çš„å­—èŠ‚è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶è·¯å¾„
* APIï¼š
  `public void write(int a)` : å†™ä¸€ä¸ªå­—èŠ‚å‡ºå» 
  `public void write(byte[] buffer)` :å†™ä¸€ä¸ªå­—èŠ‚æ•°ç»„å‡ºå»
  `public void write(byte[] buffer , int pos , int len)` : å†™ä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„ä¸€éƒ¨åˆ†å‡ºå»
                      å‚æ•°ä¸€ï¼Œå­—èŠ‚æ•°ç»„ï¼›å‚æ•°äºŒï¼šèµ·å§‹å­—èŠ‚ç´¢å¼•ä½ç½®ï¼Œå‚æ•°ä¸‰ï¼šå†™å¤šå°‘ä¸ªå­—èŠ‚æ•°å‡ºå»ã€‚

* FileOutputStreamå­—èŠ‚è¾“å‡ºæµæ¯æ¬¡å¯åŠ¨å†™æ•°æ®çš„æ—¶å€™éƒ½ä¼šå…ˆæ¸…ç©ºä¹‹å‰çš„å…¨éƒ¨æ•°æ®ï¼Œé‡æ–°å†™å…¥ï¼š
  `OutputStream os = new FileOutputStream("Day09Demo/out05")` : è¦†ç›–æ•°æ®ç®¡é“
  `OutputStream os = new FileOutputStream("Day09Demo/out05" , true)` : è¿½åŠ æ•°æ®çš„ç®¡é“ 

è¯´æ˜ï¼š

* å­—èŠ‚è¾“å‡ºæµåªèƒ½å†™å­—èŠ‚å‡ºå»ï¼Œå­—èŠ‚è¾“å‡ºæµé»˜è®¤æ˜¯**è¦†ç›–**æ•°æ®ç®¡é“ã€‚
* æ¢è¡Œç”¨ï¼š **os.write("\r\n".getBytes());**
* å…³é—­å’Œåˆ·æ–°ï¼šåˆ·æ–°æµå¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œå…³é—­åŒ…å«åˆ·æ–°æ•°æ®ä½†æ˜¯æµå°±ä¸èƒ½ä½¿ç”¨äº†ï¼

```java
OutputStream os = new FileOutputStream("Day09Demo/out05");
os.write(97);//a
os.write('b');
os.write("\r\n".getBytes());
os.write("æˆ‘çˆ±Java".getBytes());
os.close();
```



##### æ–‡ä»¶å¤åˆ¶

æ€æƒ³ï¼šå­—èŠ‚æ˜¯è®¡ç®—æœºä¸­ä¸€åˆ‡æ–‡ä»¶çš„ç»„æˆï¼Œæ‰€ä»¥å­—èŠ‚æµé€‚åˆåšä¸€åˆ‡æ–‡ä»¶çš„å¤åˆ¶

åˆ†ææ­¥éª¤ï¼š
    ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶æ¥é€šã€‚
    ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµä¸ç›®æ ‡æ–‡ä»¶æ¥é€šã€‚
    ï¼ˆ3ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºæ¡¶
    ï¼ˆ4ï¼‰ä»å­—èŠ‚è¾“å…¥æµç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œå†™å‡ºåˆ°å­—èŠ‚è¾“å‡ºæµç®¡é“å³å¯ã€‚
    ï¼ˆ5ï¼‰å…³é—­èµ„æºï¼

```java
public class CopyDemo01 {
    public static void main(String[] args) {
        InputStream is = null ;
        OutputStream os = null ;
        try{
            //ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶æ¥é€šã€‚
            is = new FileInputStream("D:\\seazean\\å›¾ç‰‡èµ„æº\\meinv.jpg");
            //ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµä¸ç›®æ ‡æ–‡ä»¶æ¥é€šã€‚
            os = new FileOutputStream("D:\\seazean\\meimei.jpg");
            //ï¼ˆ3ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºæ¡¶
            byte buffer = new byte[1024];
            //ï¼ˆ4ï¼‰ä»å­—èŠ‚è¾“å…¥æµç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œå†™å‡ºåˆ°å­—èŠ‚è¾“å‡ºæµç®¡é“å³å¯
            int len = 0;
            while((len = is.read(buffer)) != -1){
                os.write(buffer,0,len);
            }
            System.out.println("å¤åˆ¶å®Œæˆï¼");
        }catch (Exception e){
            e.printStackTrace();
        } finally {
            /**ï¼ˆ5ï¼‰å…³é—­èµ„æºï¼ */
            try{
                if(os!=null)os.close();
                if(is!=null)is.close();
            }catch (Exception e){
                e.printStackTrace();
            }
        }
    }
}
```



***



#### å­—ç¬¦æµ

##### å­—ç¬¦è¾“å…¥

FileReaderï¼šæ–‡ä»¶å­—ç¬¦è¾“å…¥æµ

   * ä½œç”¨ï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠç£ç›˜æ–‡ä»¶çš„æ•°æ®ä»¥å­—ç¬¦çš„å½¢å¼è¯»å…¥åˆ°å†…å­˜ï¼Œè¯»å–æ–‡æœ¬æ–‡ä»¶å†…å®¹åˆ°å†…å­˜ä¸­å»ã€‚
   * æ„é€ å™¨ï¼š
            `public FileReader(File file)` : åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å…¥æµä¸æºæ–‡ä»¶å¯¹è±¡æ¥é€šã€‚
            `public FileReader(String filePath)` : åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å…¥æµä¸æºæ–‡ä»¶è·¯å¾„æ¥é€šã€‚
   * æ–¹æ³•ï¼š
            `public int read()` : è¯»å–ä¸€ä¸ªå­—ç¬¦çš„ç¼–å·è¿”å›ï¼ è¯»å–å®Œæ¯•è¿”å›-1
            `public int read(char[] buffer)` : è¯»å–ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œè¯»å–å¤šå°‘ä¸ªå°±è¿”å›å¤šå°‘ä¸ªï¼Œè¯»å–å®Œæ¯•è¿”å›-1
   * ç»“è®ºï¼š
     å­—ç¬¦æµä¸€ä¸ªä¸€ä¸ªå­—ç¬¦çš„è¯»å–æ–‡æœ¬å†…å®¹è¾“å‡ºï¼Œå¯ä»¥è§£å†³ä¸­æ–‡è¯»å–è¾“å‡ºä¹±ç çš„é—®é¢˜ï¼Œé€‚åˆæ“ä½œæ–‡æœ¬æ–‡ä»¶ã€‚
     ä½†æ˜¯ï¼šä¸€ä¸ªä¸€ä¸ªå­—ç¬¦çš„è¯»å–æ–‡æœ¬å†…å®¹æ€§èƒ½è¾ƒå·®ï¼ï¼
     å­—ç¬¦æµæŒ‰ç…§**å­—ç¬¦æ•°ç»„å¾ªç¯è¯»å–æ•°æ®**ï¼Œå¯ä»¥è§£å†³ä¸­æ–‡è¯»å–è¾“å‡ºä¹±ç çš„é—®é¢˜ï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿè¾ƒå¥½ï¼ï¼
   * **å­—ç¬¦æµä¸èƒ½å¤åˆ¶å›¾ç‰‡ï¼Œè§†é¢‘ç­‰ç±»å‹çš„æ–‡ä»¶**ã€‚å­—ç¬¦æµåœ¨è¯»å–å®Œäº†å­—èŠ‚æ•°æ®åå¹¶æ²¡æœ‰ç›´æ¥å¾€ç›®çš„åœ°å†™ï¼Œè€Œæ˜¯å…ˆæŸ¥ç¼–ç è¡¨ï¼ŒæŸ¥åˆ°å¯¹åº”çš„æ•°æ®å°±å°†è¯¥æ•°æ®å†™å…¥ç›®çš„åœ°ã€‚å¦‚æœæŸ¥ä¸åˆ°ï¼Œåˆ™ç è¡¨ä¼šå°†ä¸€äº›æœªçŸ¥åŒºåŸŸä¸­çš„æ•°æ®å»mapè¿™äº›å­—èŠ‚æ•°æ®ï¼Œç„¶åå†™åˆ°ç›®çš„åœ°ï¼Œè¿™æ ·çš„è¯å°±é€ æˆäº†æºæ•°æ®å’Œç›®çš„æ•°æ®çš„ä¸ä¸€è‡´ã€‚

```java
public class FileReaderDemo01{//å­—ç¬¦
    public static void main(String[] args) throws Exception {
        // 1.åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¯¹è±¡å®šä½æºæ–‡ä»¶
        // File f = new File("Day10Demo/src/dlei01.txt");
        // 2.åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶æ¥é€š
        // Reader fr = new FileReader(f);
        // 3.ç®€åŒ–å†™æ³•ï¼šåˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶è·¯å¾„æ¥é€š
        Reader fr = new FileReader("Day10Demo/src/dlei01.txt");
        //int code1 = fr.read();
		//System.out.print((char)code1);
        int ch;
        while((ch = fr.read()) != -1){
            System.out.print((char)ch);
        }
    }
}
public class FileReaderDemo02 {//å­—ç¬¦æ•°ç»„
    public static void main(String[] args) throws Exception {
        Reader fr = new FileReader("Day10Demo/src/dlei01.txt");
        
        //char[] buffer = new char[3];
		//int len = fr.read(buffer);
		//System.out.println("å­—ç¬¦æ•°ï¼š"+len);
		//String rs = new String(buffer,0,len);
		//System.out.println(rs);
        char[] buffer = new char[1024];
        int len;
        while((len = fr.read(buffer)) != -1) {
            System.out.print(new String(buffer, 0 , len));
        }
    }
}
```



##### å­—ç¬¦è¾“å‡º

FileWriterï¼šæ–‡ä»¶å­—ç¬¦è¾“å‡ºæµ

* ä½œç”¨ï¼šä»¥å†…å­˜ä¸ºåŸºå‡†ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®æŒ‰ç…§å­—ç¬¦çš„å½¢å¼å†™å‡ºåˆ°ç£ç›˜æ–‡ä»¶ä¸­å»
* æ„é€ å™¨ï¼š
     `public FileWriter(File file)` : åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶å¯¹è±¡ã€‚
    `public FileWriter(String filePath)` : åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶è·¯å¾„ã€‚
    `public FileWriter(File file,boolean append)` : åˆ›å»ºä¸€ä¸ªè¿½åŠ æ•°æ®çš„å­—ç¬¦è¾“å‡ºæµç®¡é“é€šå‘æ–‡ä»¶å¯¹è±¡
    `public FileWriter(String filePath,boolean append)` : åˆ›å»ºä¸€ä¸ªè¿½åŠ æ•°æ®çš„å­—ç¬¦è¾“å‡ºæµç®¡é“é€šå‘ç›®æ ‡æ–‡ä»¶è·¯å¾„ã€‚
* æ–¹æ³•ï¼š
  `public void write(int c)` : å†™ä¸€ä¸ªå­—ç¬¦å‡ºå»
  `public void write(String c)` : å†™ä¸€ä¸ªå­—ç¬¦ä¸²å‡ºå»
  `public void write(char[] buffer)` : å†™ä¸€ä¸ªå­—ç¬¦æ•°ç»„å‡ºå»
  `public void write(String c ,int pos ,int len)` : å†™å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å‡ºå»
  `public void write(char[] buffer ,int pos ,int len)` : å†™å­—ç¬¦æ•°ç»„çš„ä¸€éƒ¨åˆ†å‡ºå»
* è¯´æ˜ï¼š
      è¦†ç›–æ•°æ®ç®¡é“ï¼š`Writer fw = new FileWriter("Day10Demo/src/dlei03.txt"); `
      è¿½åŠ æ•°æ®ç®¡é“ï¼š`Writer fw = new FileWriter("Day10Demo/src/dlei03.txt",true);`
      æ¢è¡Œï¼šfw.write("\r\n"); // æ¢è¡Œ
      è¯»å†™å­—ç¬¦æ–‡ä»¶æ•°æ®å»ºè®®ä½¿ç”¨å­—ç¬¦æµã€‚

```java
Writer fw = new FileWriter("Day10Demo/src/dlei03.txt");
fw.write(97);   // å­—ç¬¦a
fw.write('b');  // å­—ç¬¦b
fw.write("Javaæ˜¯æœ€ä¼˜ç¾çš„è¯­è¨€ï¼");
fw.write("\r\n");
fw.close;
```



****



#### ç¼“å†²æµ

##### åŸºæœ¬ä»‹ç»

ä½œç”¨ï¼šç¼“å†²æµå¯ä»¥æé«˜å­—èŠ‚æµå’Œå­—ç¬¦æµçš„è¯»å†™æ•°æ®çš„æ€§èƒ½ã€‚

ç¼“å†²æµåˆ†ä¸ºå››ç±»ï¼š
    ï¼ˆ1ï¼‰BufferedInputStreamï¼šå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼Œå¯ä»¥æé«˜å­—èŠ‚è¾“å…¥æµè¯»æ•°æ®çš„æ€§èƒ½ã€‚
    ï¼ˆ2ï¼‰BufferedOutStreamï¼š  å­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼Œå¯ä»¥æé«˜å­—èŠ‚è¾“å‡ºæµå†™æ•°æ®çš„æ€§èƒ½ã€‚
    ï¼ˆ3ï¼‰BufferedReaderï¼š  å­—ç¬¦ç¼“å†²è¾“å…¥æµï¼Œå¯ä»¥æé«˜å­—ç¬¦è¾“å…¥æµè¯»æ•°æ®çš„æ€§èƒ½ã€‚
    ï¼ˆ4ï¼‰BufferedWriterï¼š  å­—ç¬¦ç¼“å†²è¾“å‡ºæµï¼Œå¯ä»¥æé«˜å­—ç¬¦è¾“å‡ºæµå†™æ•°æ®çš„æ€§èƒ½ã€‚



##### å­—èŠ‚ç¼“å†²è¾“å…¥æµ

å­—èŠ‚ç¼“å†²è¾“å…¥æµï¼šBufferedInputStream

ä½œç”¨ï¼šå¯ä»¥æŠŠä½çº§çš„å­—èŠ‚è¾“å…¥æµåŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—èŠ‚è¾“å…¥æµç®¡é“, æé«˜å­—èŠ‚è¾“å…¥æµè¯»æ•°æ®çš„æ€§èƒ½

æ„é€ å™¨ï¼š`public BufferedInputStream(InputStream in)`

åŸç†ï¼šç¼“å†²å­—èŠ‚è¾“å…¥æµç®¡é“è‡ªå¸¦äº†ä¸€ä¸ª 8KB çš„ç¼“å†²æ± ï¼Œæ¯æ¬¡å¯ä»¥ç›´æ¥å€Ÿç”¨æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½æœ€å¤šæå– 8KB çš„æ•°æ®åˆ°ç¼“å†²æ± ä¸­å»ï¼Œä»¥åæˆ‘ä»¬ç›´æ¥ä»ç¼“å†²æ± è¯»å–æ•°æ®ï¼Œæ‰€ä»¥æ€§èƒ½è¾ƒå¥½

```java
public class BufferedInputStreamDemo01 {
    public static void main(String[] args) throws Exception {
        // 1.å®šä¹‰ä¸€ä¸ªä½çº§çš„å­—èŠ‚è¾“å…¥æµä¸æºæ–‡ä»¶æ¥é€š
        InputStream is = new FileInputStream("Day10Demo/src/dlei04.txt");
        // 2.æŠŠä½çº§çš„å­—èŠ‚è¾“å…¥æµåŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—èŠ‚è¾“å…¥æµã€‚
        BufferInputStream bis = new BufferInputStream(is);
        // 3.å®šä¹‰ä¸€ä¸ªå­—èŠ‚æ•°ç»„æŒ‰ç…§å¾ªç¯è¯»å–ã€‚
        byte[] buffer = new byte[1024];
        int len;
        while((len = bis.read(buffer)) != -1){
            String rs = new String(buffer, 0 , len);
            System.out.print(rs);
        }
    }
}
```



##### å­—èŠ‚ç¼“å†²è¾“å‡ºæµ

å­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼šBufferedOutputStream

ä½œç”¨ï¼šå¯ä»¥æŠŠä½çº§çš„å­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—èŠ‚è¾“å‡ºæµï¼Œä»è€Œæé«˜å†™æ•°æ®çš„æ€§èƒ½

æ„é€ å™¨ï¼š`public BufferedOutputStream(OutputStream os)`

åŸç†ï¼šç¼“å†²å­—èŠ‚è¾“å‡ºæµè‡ªå¸¦äº†8KBç¼“å†²æ± ,æ•°æ®å°±ç›´æ¥å†™å…¥åˆ°ç¼“å†²æ± ä¸­å»ï¼Œæ€§èƒ½æé«˜äº†

```java
public class BufferedOutputStreamDemo02 {
    public static void main(String[] args) throws Exception {
        // 1.å†™ä¸€ä¸ªåŸå§‹çš„å­—èŠ‚è¾“å‡ºæµ
        OutputStream os = new FileOutputStream("Day10Demo/src/dlei05.txt");
        // 2.æŠŠä½çº§çš„å­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—èŠ‚è¾“å‡ºæµ
        BufferedOutputStream bos =  new BufferedOutputStream(os);
        // 3.å†™æ•°æ®å‡ºå»
        bos.write('a');
        bos.write(100);
        bos.write("æˆ‘çˆ±ä¸­å›½".getBytes());
        bos.close();
    }
}

```



##### å­—èŠ‚æµçš„æ€§èƒ½åˆ†æ

åˆ©ç”¨å­—èŠ‚æµçš„å¤åˆ¶ç»Ÿè®¡å„ç§å†™æ³•å½¢å¼ä¸‹ç¼“å†²æµçš„æ€§èƒ½æ‰§è¡Œæƒ…å†µã€‚

å¤åˆ¶æµï¼š
    ï¼ˆ1ï¼‰ä½¿ç”¨ä½çº§çš„å­—èŠ‚æµæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„å½¢å¼å¤åˆ¶æ–‡ä»¶ã€‚
    ï¼ˆ2ï¼‰ä½¿ç”¨ä½çº§çš„å­—èŠ‚æµæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„å½¢å¼å¤åˆ¶æ–‡ä»¶ã€‚
    ï¼ˆ3ï¼‰ä½¿ç”¨é«˜çº§çš„ç¼“å†²å­—èŠ‚æµæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„å½¢å¼å¤åˆ¶æ–‡ä»¶ã€‚
    ï¼ˆ4ï¼‰ä½¿ç”¨é«˜çº§çš„ç¼“å†²å­—èŠ‚æµæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„å½¢å¼å¤åˆ¶æ–‡ä»¶ã€‚

é«˜çº§çš„ç¼“å†²å­—èŠ‚æµæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„å½¢å¼å¤åˆ¶æ–‡ä»¶ï¼Œæ€§èƒ½æœ€é«˜ï¼Œå»ºè®®ä½¿ç”¨



****



##### å­—ç¬¦ç¼“å†²è¾“å…¥æµ

å­—ç¬¦ç¼“å†²è¾“å…¥æµï¼šBufferedReader

ä½œç”¨ï¼šå­—ç¬¦ç¼“å†²è¾“å…¥æµæŠŠå­—ç¬¦è¾“å…¥æµåŒ…è£…æˆé«˜çº§çš„ç¼“å†²å­—ç¬¦è¾“å…¥æµï¼Œå¯ä»¥æé«˜å­—ç¬¦è¾“å…¥æµè¯»æ•°æ®çš„æ€§èƒ½ã€‚

æ„é€ å™¨ï¼š`public BufferedReader(Reader reader)`

åŸç†ï¼šç¼“å†²å­—ç¬¦è¾“å…¥æµé»˜è®¤ä¼šæœ‰ä¸€ä¸ª8Kçš„å­—ç¬¦ç¼“å†²æ± ,å¯ä»¥æé«˜è¯»å­—ç¬¦çš„æ€§èƒ½

æŒ‰ç…§è¡Œè¯»å–æ•°æ®çš„åŠŸèƒ½ï¼š`public String readLine()`  è¯»å–ä¸€è¡Œæ•°æ®è¿”å›ï¼Œè¯»å–å®Œæ¯•è¿”å›null

```java
public static void main(String[] args) throws Exception {
    // 1.å®šä¹‰ä¸€ä¸ªåŸå§‹çš„å­—ç¬¦è¾“å…¥æµè¯»å–æºæ–‡ä»¶
    Reader fr = new FileReader("Day10Demo/src/dlei06.txt");
    // 2.æŠŠä½çº§çš„å­—ç¬¦è¾“å…¥æµç®¡é“åŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—ç¬¦è¾“å…¥æµç®¡é“
    BufferedReader br = new BufferedReader(fr);
    // å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡å­˜å‚¨æ¯è¡Œæ•°æ®
    String line;
    while((line = br.readLine()) != null){
        System.out.println(line);
    }
    br.close();
    //æ·˜æ±°æ•°ç»„å¾ªç¯è¯»å–
    //char[] buffer = new char[1024];
    //int len;
    //while((len = br.read(buffer)) != -1){
    //System.out.println(new String(buffer , 0 , len));
}
```



##### å­—ç¬¦ç¼“å†²è¾“å‡ºæµ

ç¬¦ç¼“å†²è¾“å‡ºæµï¼šBufferedWriter

ä½œç”¨ï¼šæŠŠä½çº§çš„å­—ç¬¦è¾“å‡ºæµåŒ…è£…æˆä¸€ä¸ªé«˜çº§çš„ç¼“å†²å­—ç¬¦è¾“å‡ºæµï¼Œæé«˜å†™å­—ç¬¦æ•°æ®çš„æ€§èƒ½ã€‚

æ„é€ å™¨ï¼š`public BufferedWriter(Writer writer)`

 åŸç†ï¼šé«˜çº§çš„å­—ç¬¦ç¼“å†²è¾“å‡ºæµå¤šäº†ä¸€ä¸ª8kçš„å­—ç¬¦ç¼“å†²æ± ï¼Œå†™æ•°æ®æ€§èƒ½æå¤§æé«˜äº†

å­—ç¬¦ç¼“å†²è¾“å‡ºæµå¤šäº†ä¸€ä¸ªæ¢è¡Œçš„ç‰¹æœ‰åŠŸèƒ½ï¼š`public void newLine()`  **æ–°å»ºä¸€è¡Œ**

```java
public static void main(String[] args) throws Exception {
    Writer fw = new FileWriter("Day10Demo/src/dlei07.txt",true);//è¿½åŠ 
    BufferedWriter bw = new BufferedWriter(fw);
    
    bw.write("æˆ‘çˆ±å­¦ä¹ Java");
    bw.newLine();//æ¢è¡Œ
    bw.close();
}
```



***



##### é«˜æ•ˆåŸå› 

å­—ç¬¦å‹ç¼“å†²æµé«˜æ•ˆçš„åŸå› ï¼š

* BufferedReaderï¼šæ¯æ¬¡è°ƒç”¨readæ–¹æ³•ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ä»ç£ç›˜ä¸­è¯»å–äº†8192ï¼ˆ**8k**ï¼‰ä¸ªå­—ç¬¦ï¼Œå­˜å‚¨åˆ°è¯¥ç±»å‹å¯¹è±¡çš„ç¼“å†²åŒºæ•°ç»„ä¸­ï¼Œå°†å…¶ä¸­ä¸€ä¸ªè¿”å›ç»™è°ƒç”¨è€…ï¼Œå†æ¬¡è°ƒç”¨readæ–¹æ³•æ—¶ï¼Œå°±ä¸éœ€è¦è®¿é—®ç£ç›˜ï¼Œç›´æ¥ä»ç¼“å†²åŒºä¸­æ‹¿å‡ºä¸€ä¸ªæ•°æ®å³å¯ï¼Œæå‡äº†æ•ˆç‡
* BufferedWriterï¼šæ¯æ¬¡è°ƒç”¨writeæ–¹æ³•ï¼Œä¸ä¼šç›´æ¥å°†å­—ç¬¦åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åˆ°å­—ç¬¦æ•°ç»„ä¸­ï¼Œç­‰å­—ç¬¦æ•°ç»„å†™æ»¡äº†ï¼Œæ‰ä¸€æ¬¡æ€§åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ï¼Œå‡å°‘äº†å’Œç£ç›˜äº¤äº’çš„æ¬¡æ•°ï¼Œæå‡äº†æ•ˆç‡

å­—èŠ‚å‹ç¼“å†²æµé«˜æ•ˆçš„åŸå› ï¼š

* BufferedInputStreamï¼šåœ¨è¯¥ç±»å‹ä¸­å‡†å¤‡äº†ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨å­—èŠ‚ä¿¡æ¯ï¼Œå½“å¤–ç•Œè°ƒç”¨read()æ–¹æ³•æƒ³è·å–ä¸€ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œè¯¥å¯¹è±¡ä»æ–‡ä»¶ä¸­ä¸€æ¬¡æ€§è¯»å–äº†8192ä¸ªå­—èŠ‚åˆ°æ•°ç»„ä¸­ï¼Œåªè¿”å›äº†ç¬¬ä¸€ä¸ªå­—èŠ‚ç»™è°ƒç”¨è€…ã€‚å°†æ¥è°ƒç”¨è€…å†æ¬¡è°ƒç”¨readæ–¹æ³•æ—¶ï¼Œå½“å‰å¯¹è±¡å°±ä¸éœ€è¦å†æ¬¡è®¿é—®ç£ç›˜ï¼Œåªéœ€è¦ä»æ•°ç»„ä¸­å–å‡ºä¸€ä¸ªå­—èŠ‚è¿”å›ç»™è°ƒç”¨è€…å³å¯ï¼Œç”±äºè¯»å–çš„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ã€‚å½“8192ä¸ªå­—èŠ‚å…¨éƒ½è¯»å–å®Œæˆä¹‹åï¼Œå†éœ€è¦è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¾—è®©è¯¥å¯¹è±¡åˆ°æ–‡ä»¶ä¸­è¯»å–ä¸‹ä¸€ä¸ª8192ä¸ªå­—èŠ‚
* BufferedOutputStreamï¼šåœ¨è¯¥ç±»å‹ä¸­å‡†å¤‡äº†ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨å­—èŠ‚ä¿¡æ¯ï¼Œå½“å¤–ç•Œè°ƒç”¨writeæ–¹æ³•æƒ³å†™å‡ºä¸€ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œè¯¥å¯¹è±¡ç›´æ¥å°†è¿™ä¸ªå­—èŠ‚å­˜å‚¨åˆ°äº†è‡ªå·±çš„æ•°ç»„ä¸­ï¼Œè€Œä¸åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ã€‚ä¸€ç›´åˆ°è¯¥æ•°ç»„æ‰€æœ‰8192ä¸ªä½ç½®å…¨éƒ½å æ»¡ï¼Œè¯¥å¯¹è±¡æ‰æŠŠè¿™ä¸ªæ•°ç»„ä¸­çš„æ‰€æœ‰æ•°æ®ä¸€æ¬¡æ€§å†™å‡ºåˆ°ç›®æ ‡æ–‡ä»¶ä¸­ã€‚å¦‚æœæœ€åä¸€æ¬¡å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å°†æ•°ç»„å†™æ»¡ï¼Œæœ€ç»ˆåœ¨å…³é—­æµå¯¹è±¡çš„æ—¶å€™ï¼Œä¹Ÿä¼šå°†è¯¥æ•°ç»„ä¸­çš„æ•°æ®åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ã€‚ 



æ³¨æ„ï¼š**å­—èŠ‚æµå’Œå­—ç¬¦æµï¼Œéƒ½æ˜¯è£…æ»¡æ—¶è‡ªåŠ¨å†™å‡ºï¼Œæˆ–è€…æ²¡æ»¡æ—¶æ‰‹åŠ¨flushå†™å‡ºï¼Œæˆ–closeæ—¶åˆ·æ–°å†™å‡º**



***



#### è½¬æ¢æµ

##### ä¹±ç é—®é¢˜

å­—ç¬¦æµè¯»å–ï¼š

```
ä»£ç ç¼–ç             æ–‡ä»¶ç¼–ç          ä¸­æ–‡æƒ…å†µã€‚
UTF-8              UTF-8           ä¸ä¹±ç !
GBK                GBK             ä¸ä¹±ç !
UTF-8              GBK             ä¹±ç !
```

å¦‚æœä»£ç ç¼–ç å’Œè¯»å–çš„æ–‡ä»¶ç¼–ç ä¸€è‡´ã€‚å­—ç¬¦æµè¯»å–çš„æ—¶å€™ä¸ä¼šä¹±ç ã€‚
å¦‚æœä»£ç ç¼–ç å’Œè¯»å–çš„æ–‡ä»¶ç¼–ç ä¸ä¸€è‡´ã€‚å­—ç¬¦æµè¯»å–çš„æ—¶å€™ä¼šä¹±ç ã€‚



***



##### å­—ç¬¦è¾“å…¥è½¬æ¢æµ

å­—ç¬¦è¾“å…¥è½¬æ¢æµï¼šInputStreamReader

ä½œç”¨ï¼šè§£å†³å­—ç¬¦æµè¯»å–ä¸åŒç¼–ç çš„ä¹±ç é—®é¢˜ï¼ŒæŠŠåŸå§‹çš„**å­—èŠ‚æµ**æŒ‰ç…§é»˜è®¤çš„ç¼–ç æˆ–æŒ‡å®šçš„ç¼–ç **è½¬æ¢æˆå­—ç¬¦è¾“å…¥æµ**

æ„é€ å™¨ï¼š

* `public InputStreamReader(InputStream is)` : ä½¿ç”¨å½“å‰ä»£ç é»˜è®¤ç¼–ç  UTF-8 è½¬æ¢æˆå­—ç¬¦æµ
* `public InputStreamReader(InputStream is,String charset)` : æŒ‡å®šç¼–ç æŠŠå­—èŠ‚æµè½¬æ¢æˆå­—ç¬¦æµ

```java
public class InputStreamReaderDemo{
    public static void main(String[] args) throws Exception {
        // 1.æå–GBKæ–‡ä»¶çš„åŸå§‹å­—èŠ‚æµ
        InputStream is = new FileInputStream("D:\\seazean\\Netty.txt");
        // 2.æŠŠåŸå§‹å­—èŠ‚è¾“å…¥æµé€šè¿‡è½¬æ¢æµï¼Œè½¬æ¢æˆ å­—ç¬¦è¾“å…¥è½¬æ¢æµInputStreamReader
        InputStreamReader isr = new InputStreamReader(is,"GBK"); 
        // 3.åŒ…è£…æˆç¼“å†²æµ
        BufferedReader br = new BufferedReader(isr);
        //å¾ªç¯è¯»å–
        String line;
        while((line = br.readLine()) != null){
            System.out.println(line);
        }
    }
}
```



##### å­—ç¬¦è¾“å‡ºè½¬æ¢æµ

å­—ç¬¦è¾“å‡ºè½¬æ¢æµï¼šOutputStreamWriter

ä½œç”¨ï¼šå¯ä»¥æŒ‡å®šç¼–ç **æŠŠå­—èŠ‚è¾“å‡ºæµè½¬æ¢æˆå­—ç¬¦è¾“å‡ºæµ**ï¼Œå¯ä»¥æŒ‡å®šå†™å‡ºå»çš„å­—ç¬¦çš„ç¼–ç 

æ„é€ å™¨ï¼š

* `public OutputStreamWriter(OutputStream os)` : ç”¨é»˜è®¤ç¼–ç  UTF-8 æŠŠå­—èŠ‚è¾“å‡ºæµè½¬æ¢æˆå­—ç¬¦è¾“å‡ºæµ
* `public OutputStreamWriter(OutputStream os ,String charset)` : æŒ‡å®šç¼–ç æŠŠå­—èŠ‚è¾“å‡ºæµè½¬æ¢æˆ

```Java
OutputStream os = new FileOutputStream("Day10Demo/src/dlei07.txt");
OutputStreamWriter osw = new OutputStreamWriter(os,"GBK");
osw.write("æˆ‘åœ¨å­¦ä¹ Java");   
osw.close();
```



****



#### åºåˆ—åŒ–

##### åŸºæœ¬ä»‹ç»

å¯¹è±¡åºåˆ—åŒ–ï¼šæŠŠJavaå¯¹è±¡è½¬æ¢æˆå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ï¼Œå°†å¯¹è±¡å†™å…¥åˆ°IOæµä¸­ã€‚     å¯¹è±¡ => æ–‡ä»¶ä¸­

å¯¹è±¡ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸ºJavaå¯¹è±¡çš„è¿‡ç¨‹ï¼Œä»IOæµä¸­æ¢å¤å¯¹è±¡ã€‚     æ–‡ä»¶ä¸­ => å¯¹è±¡

transient å…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡ï¼Œå°†ä¸å‚ä¸åºåˆ—åŒ–ï¼



***



##### åºåˆ—åŒ–

å¯¹è±¡åºåˆ—åŒ–æµï¼ˆå¯¹è±¡å­—èŠ‚è¾“å‡ºæµï¼‰ï¼šObjectOutputStream

ä½œç”¨ï¼šæŠŠå†…å­˜ä¸­çš„Javaå¯¹è±¡æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­å»

æ„é€ å™¨ï¼š`public ObjectOutputStream(OutputStream out)`

åºåˆ—åŒ–æ–¹æ³•ï¼š`public final void writeObject(Object obj)`

æ³¨æ„ï¼šå¯¹è±¡å¦‚æœæƒ³å‚ä¸åºåˆ—åŒ–ï¼Œå¯¹è±¡å¿…é¡»å®ç°åºåˆ—åŒ–æ¥å£ **implements Serializable** ï¼Œå¦åˆ™åºåˆ—åŒ–å¤±è´¥ï¼

```java
public class SerializeDemo01 {
    public static void main(String[] args) throws Exception {
        // 1.åˆ›å»ºUserç”¨æˆ·å¯¹è±¡
        User user = new User("seazean","980823","ä¸ƒåä¸€");
        // 2.åˆ›å»ºä½çº§çš„å­—èŠ‚è¾“å‡ºæµé€šå‘ç›®æ ‡æ–‡ä»¶
        OutputStream os = new FileOutputStream("Day10Demo/src/obj.dat");
        // 3.æŠŠä½çº§çš„å­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆé«˜çº§çš„å¯¹è±¡å­—èŠ‚è¾“å‡ºæµObjectOutputStream
        ObjectOutputStream oos = new ObjectOutputStream(os);
        // 4.é€šè¿‡å¯¹è±¡å­—èŠ‚è¾“å‡ºæµåºåˆ—åŒ–å¯¹è±¡ï¼š
        oos.writeObject(user);
        // 5.é‡Šæ”¾èµ„æº
        oos.close();
        System.out.println("åºåˆ—åŒ–å¯¹è±¡æˆåŠŸ~~~~");
    }
}

class User implements Serializable {
    // åŠ å…¥åºåˆ—ç‰ˆæœ¬å·
    private static final long serialVersionUID = 1L;

    private String loginName;
    private transient String passWord;
    private String userName;
    ///get+set
}
```



****



##### ååºåˆ—

å¯¹è±¡ååºåˆ—åŒ–ï¼ˆå¯¹è±¡å­—èŠ‚è¾“å…¥æµï¼‰ï¼šObjectInputStream

ä½œç”¨ï¼šè¯»å–åºåˆ—åŒ–çš„å¯¹è±¡æ–‡ä»¶æ¢å¤åˆ°Javaå¯¹è±¡ä¸­

æ„é€ å™¨ï¼š`public ObjectInputStream(InputStream is)`

æ–¹æ³•ï¼š`public final Object readObject()`

åºåˆ—åŒ–ç‰ˆæœ¬å·ï¼š`private static final long serialVersionUID = 2L`
è¯´æ˜ï¼šåºåˆ—åŒ–ä½¿ç”¨çš„ç‰ˆæœ¬å·å’Œååºåˆ—åŒ–ä½¿ç”¨çš„ç‰ˆæœ¬å·ä¸€è‡´æ‰å¯ä»¥æ­£å¸¸ååºåˆ—åŒ–ï¼Œå¦åˆ™æŠ¥é”™

```java
public class SerializeDemo02 {
    public static void main(String[] args) throws Exception {
        InputStream is = new FileInputStream("Day10Demo/src/obj.dat");
        ObjectInputStream ois = new ObjectInputStream(is);
        User user = (User)ois.readObject();//ååºåˆ—åŒ–
        System.out.println(user);
        System.out.println("ååºåˆ—åŒ–å®Œæˆï¼");
    }
}
class User implements Serializable {
    // åŠ å…¥åºåˆ—ç‰ˆæœ¬å·
    private static final long serialVersionUID = 1L;
    //........
}
```



****



#### æ‰“å°æµ

æ‰“å°æµ PrintStream / PrintWriter

æ‰“å°æµçš„ä½œç”¨ï¼š

* å¯ä»¥æ–¹ä¾¿ï¼Œå¿«é€Ÿçš„å†™æ•°æ®å‡ºå»ï¼Œå¯ä»¥å®ç°æ‰“å°ä»€ä¹ˆç±»å‹ï¼Œå°±æ˜¯ä»€ä¹ˆç±»å‹
* PrintStream/PrintWriter ä¸å…‰å¯ä»¥æ‰“å°æ•°æ®ï¼Œè¿˜å¯ä»¥å†™å­—èŠ‚æ•°æ®å’Œå­—ç¬¦æ•°æ®å‡ºå»
* **System.out.print() åº•å±‚åŸºäºæ‰“å°æµå®ç°çš„** 

æ„é€ å™¨ï¼š

* `public PrintStream(OutputStream os)`
* `public PrintStream(String filepath)`

Systemç±»ï¼š

* `public static void setOut(PrintStream out)`ï¼šè®©ç³»ç»Ÿçš„è¾“å‡ºæµå‘æ‰“å°æµ

```java
public class PrintStreamDemo01 {
    public static void main(String[] args) throws Exception {
        PrintStream ps = new  PrintStream("Day10Demo/src/dlei.txt");
        //PrintWriter pw = new  PrintWriter("Day10Demo/src/dlei08.txt");
        ps.println(ä»»ä½•ç±»å‹çš„æ•°æ®);
        ps.print(ä¸æ¢è¡Œ);
        ps.write("æˆ‘çˆ±ä½ ".getBytes());
        ps.close();
    }
}
public class PrintStreamDemo02 {
    public static void main(String[] args) throws Exception {
        System.out.println("==seazean0==");
        PrintStream ps = new PrintStream("Day10Demo/src/log.txt");
        System.setOut(ps); // è®©ç³»ç»Ÿçš„è¾“å‡ºæµå‘æ‰“å°æµ
		//ä¸è¾“å‡ºåœ¨æ§åˆ¶å°ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶é‡Œ
        System.out.println("==seazean1==");
        System.out.println("==seazean2==");
    }
}
```



***



### Close

try-with-resourcesï¼š

```java
try(
    // è¿™é‡Œåªèƒ½æ”¾ç½®èµ„æºå¯¹è±¡ï¼Œç”¨å®Œä¼šè‡ªåŠ¨è°ƒç”¨close()å…³é—­
){

}catch(Exception e){
 	e.printStackTrace();
}
```

èµ„æºç±»ä¸€å®šæ˜¯å®ç°äº† Closeable æ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£çš„ç±»å°±æ˜¯èµ„æº

æœ‰ close() æ–¹æ³•ï¼Œtry-with-resources ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒçš„ close() å…³é—­èµ„æº

```java
try(
	/** ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµç®¡é“ä¸æºæ–‡ä»¶æ¥é€šã€‚ */
	InputStream is  = new FileInputStream("D:\\seazean\\å›¾ç‰‡èµ„æº\\meinv.jpg");
	/** ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµä¸ç›®æ ‡æ–‡ä»¶æ¥é€šã€‚*/
	OutputStream os = new FileOutputStream("D:\\seazean\\meimei.jpg");
	/** ï¼ˆ5ï¼‰å…³é—­èµ„æºï¼æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ */
){
	byte[] buffer = new byte[1024];
	int len = 0;
	while((len = is.read(buffer)) != -1){
		os.write(buffer, 0 , len);
	}
	System.out.println("å¤åˆ¶å®Œæˆï¼");
}catch (Exception e){
	e.printStackTrace();
}
```



***



### Properties

Propertiesï¼šå±æ€§é›†å¯¹è±¡ã€‚å°±æ˜¯ä¸€ä¸ªMapé›†åˆï¼Œä¸€ä¸ªé”®å€¼å¯¹é›†åˆ

æ ¸å¿ƒä½œç”¨ï¼šPropertiesä»£è¡¨çš„æ˜¯ä¸€ä¸ªå±æ€§æ–‡ä»¶ï¼Œå¯ä»¥æŠŠé”®å€¼å¯¹æ•°æ®å­˜å…¥åˆ°ä¸€ä¸ªå±æ€§æ–‡ä»¶

å±æ€§æ–‡ä»¶ï¼šåç¼€æ˜¯.propertiesç»“å°¾çš„æ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹éƒ½æ˜¯ key=value

Propertiesæ–¹æ³•ï¼š

| æ–¹æ³•å                                              | è¯´æ˜                                        |
| --------------------------------------------------- | ------------------------------------------- |
| public Object setProperty(String key, String value) | è®¾ç½®é›†åˆçš„é”®å’Œå€¼ï¼Œåº•å±‚è°ƒç”¨Hashtableæ–¹æ³• put |
| public String getProperty(String key)               | ä½¿ç”¨æ­¤å±æ€§åˆ—è¡¨ä¸­æŒ‡å®šçš„é”®æœç´¢å±æ€§            |
| public Set<String>   stringPropertyNames()          | æ‰€æœ‰é”®çš„åç§°çš„é›†åˆ                          |
| public synchronized void load(Reader r)             | ä»è¾“å…¥å­—ç¬¦æµè¯»å–å±æ€§åˆ—è¡¨ï¼ˆé”®å’Œå…ƒç´ å¯¹ï¼‰      |
| public synchronized void load(InputStream inStream) | åŠ è½½å±æ€§æ–‡ä»¶çš„æ•°æ®åˆ°å±æ€§é›†å¯¹è±¡ä¸­å»          |
| public void store(Writer w, String comments)        | å°†æ­¤å±æ€§åˆ—è¡¨(é”®å’Œå…ƒç´ å¯¹)å†™å…¥ Propertiesè¡¨   |
| public void store(OutputStream os, String comments) | ä¿å­˜æ•°æ®åˆ°å±æ€§æ–‡ä»¶ä¸­å»                      |

````java
public class PropertiesDemo01 {
    public static void main(String[] args) throws Exception {
        // a.åˆ›å»ºä¸€ä¸ªå±æ€§é›†å¯¹è±¡ï¼šPropertiesçš„å¯¹è±¡ã€‚
        Properties properties = new Properties();//{}
        properties.setProperty("admin" , "123456");
        // b.æŠŠå±æ€§é›†å¯¹è±¡çš„æ•°æ®å­˜å…¥åˆ°å±æ€§æ–‡ä»¶ä¸­å»ï¼ˆé‡ç‚¹ï¼‰
        OutputStream os = new FileOutputStream("Day10Demo/src/users.properties");
        properties.store(os,"i am very happy!!æˆ‘ä¿å­˜äº†ç”¨æˆ·æ•°æ®!");
        //å‚æ•°ä¸€ï¼šè¢«ä¿å­˜æ•°æ®çš„è¾“å‡ºç®¡é“
        //å‚æ•°äºŒï¼šä¿å­˜å¿ƒå¾—ã€‚å°±æ˜¯å¯¹è±¡ä¿å­˜çš„æ•°æ®è¿›è¡Œè§£é‡Šè¯´æ˜ï¼
    }
}
````

````java
public class PropertiesDemo02 {
    public static void main(String[] args) throws Exception {
        Properties properties = new Properties();//åº•å±‚åŸºäºmapé›†åˆ
        properties.load(new FileInputStream("Day10Demo/src/users.properties"));
        System.out.println(properties);
        System.out.println(properties.getProperty("admin"));
        
		Set<String> set = properties.stringPropertyNames();
        for (String s : set) {
            String value = properties.getProperty(s);
            System.out.println(s + value);
        }
    }
}
````



***



### RandomIO

RandomAccessFile ç±»ï¼šè¯¥ç±»çš„å®ä¾‹æ”¯æŒè¯»å–å’Œå†™å…¥éšæœºè®¿é—®æ–‡ä»¶

æ„é€ å™¨ï¼š
RandomAccessFile(File file, String mode)ï¼šåˆ›å»ºéšæœºè®¿é—®æ–‡ä»¶æµï¼Œä»Fileå‚æ•°æŒ‡å®šçš„æ–‡ä»¶è¯»å–ï¼Œå¯é€‰æ‹©å†™å…¥
RandomAccessFile(String name, String mode)ï¼šåˆ›å»ºéšæœºè®¿é—®æ–‡ä»¶æµï¼Œä»æŒ‡å®šåç§°æ–‡ä»¶è¯»å–ï¼Œå¯é€‰æ‹©å†™å…¥æ–‡ä»¶

å¸¸ç”¨æ–¹æ³•ï¼š
`public void seek(long pos)` : è®¾ç½®æ–‡ä»¶æŒ‡é’ˆåç§»ï¼Œä»è¯¥æ–‡ä»¶å¼€å¤´æµ‹é‡ï¼Œå‘ç”Ÿä¸‹ä¸€æ¬¡è¯»å–æˆ–å†™å…¥(æ’å…¥+è¦†ç›–)
`public void write(byte[] b)` : ä»æŒ‡å®šçš„å­—èŠ‚æ•°ç»„å†™å…¥ b.lengthä¸ªå­—èŠ‚åˆ°è¯¥æ–‡ä»¶
`public int read(byte[] b)` : ä»è¯¥æ–‡ä»¶è¯»å–æœ€å¤šb.lengthä¸ªå­—èŠ‚çš„æ•°æ®åˆ°å­—èŠ‚æ•°ç»„

```java
public static void main(String[] args) throws Exception {
    RandomAccessFile rf = new RandomAccessFile(new File(),"rw");
    rf.write("hello world".getBytes());
    rf.seek(5);//helloxxxxld
    rf.write("xxxx".getBytes());
    rf.close();
}
```



***



### Commons

commons-io æ˜¯apacheå¼€æºåŸºé‡‘ç»„ç»‡æä¾›çš„ä¸€ç»„æœ‰å…³IOæ“ä½œçš„ç±»åº“ï¼Œå¯ä»¥æŒºæé«˜IOåŠŸèƒ½å¼€å‘çš„æ•ˆç‡ã€‚

commons-io å·¥å…·åŒ…æä¾›äº†å¾ˆå¤šæœ‰å…³ IO æ“ä½œçš„ç±»ï¼š

| åŒ…                                  | åŠŸèƒ½æè¿°                                     |
| ----------------------------------- | :------------------------------------------- |
| org.apache.commons.io               | æœ‰å…³Streamsã€Readersã€Writersã€Filesçš„å·¥å…·ç±» |
| org.apache.commons.io.input         | è¾“å…¥æµç›¸å…³çš„å®ç°ç±»ï¼ŒåŒ…å«Readerå’ŒInputStream  |
| org.apache.commons.io.output        | è¾“å‡ºæµç›¸å…³çš„å®ç°ç±»ï¼ŒåŒ…å«Writerå’ŒOutputStream |
| org.apache.commons.io.serialization | åºåˆ—åŒ–ç›¸å…³çš„ç±»                               |

IOUtils å’Œ FileUtils å¯ä»¥æ–¹ä¾¿çš„å¤åˆ¶æ–‡ä»¶å’Œæ–‡ä»¶å¤¹

```java
public class CommonsIODemo01 {
    public static void main(String[] args) throws Exception {
        // 1.å®Œæˆæ–‡ä»¶å¤åˆ¶ï¼
        IOUtils.copy(new FileInputStream("Day13Demo/src/books.xml"), 
                     new FileOutputStream("Day13Demo/new.xml"));
        // 2.å®Œæˆæ–‡ä»¶å¤åˆ¶åˆ°æŸä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼
        FileUtils.copyFileToDirectory(new File("Day13Demo/src/books.xml"),
                                      new File("D:/it"));
        // 3.å®Œæˆæ–‡ä»¶å¤¹å¤åˆ¶åˆ°æŸä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼
        FileUtils.copyDirectoryToDirectory(new File("D:\\it\\å›¾ç‰‡æœåŠ¡å™¨") ,
                                           new File("D:\\"));

        //  Javaä»1.7å¼€å§‹æä¾›äº†ä¸€äº›nio, è‡ªå·±ä¹Ÿæœ‰ä¸€è¡Œä»£ç å®Œæˆå¤åˆ¶çš„æŠ€æœ¯ã€‚
        Files.copy(Paths.get("Day13Demo/src/books.xml")
                , new FileOutputStream("Day13Demo/new11.txt"));
    }
}
```





***



## åå°„

### æµ‹è¯•æ¡†æ¶

> å•å…ƒæµ‹è¯•æ˜¯æŒ‡ç¨‹åºå‘˜å†™çš„æµ‹è¯•ä»£ç ç»™è‡ªå·±çš„ç±»ä¸­çš„æ–¹æ³•è¿›è¡Œé¢„æœŸæ­£ç¡®æ€§çš„éªŒè¯ã€‚
> å•å…ƒæµ‹è¯•ä¸€æ—¦å†™å¥½äº†è¿™äº›æµ‹è¯•ä»£ç ï¼Œå°±å¯ä»¥ä¸€ç›´ä½¿ç”¨ï¼Œå¯ä»¥å®ç°ä¸€å®šç¨‹åº¦ä¸Šçš„è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

å•å…ƒæµ‹è¯•çš„ç»å…¸æ¡†æ¶ï¼šJunit

* Junit : æ˜¯Javaè¯­è¨€ç¼–å†™çš„ç¬¬ä¸‰æ–¹å•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿å¿«é€Ÿçš„æµ‹è¯•æˆ‘ä»¬ä»£ç çš„æ­£ç¡®æ€§ã€‚
* å•å…ƒæµ‹è¯•ï¼š
  * å•å…ƒï¼šåœ¨Javaä¸­ï¼Œä¸€ä¸ªç±»å°±æ˜¯ä¸€ä¸ªå•å…ƒ
  *  å•å…ƒæµ‹è¯•ï¼šJunitç¼–å†™çš„ä¸€å°æ®µä»£ç ï¼Œç”¨æ¥å¯¹æŸä¸ªç±»ä¸­çš„æŸä¸ªæ–¹æ³•è¿›è¡ŒåŠŸèƒ½æµ‹è¯•æˆ–ä¸šåŠ¡é€»è¾‘æµ‹è¯•	

Junitå•å…ƒæµ‹è¯•æ¡†æ¶çš„ä½œç”¨ï¼š

* ç”¨æ¥å¯¹ç±»ä¸­çš„æ–¹æ³•åŠŸèƒ½è¿›è¡Œæœ‰ç›®çš„çš„æµ‹è¯•ï¼Œä»¥ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§
* èƒ½å¤Ÿ**ç‹¬ç«‹çš„**æµ‹è¯•æŸä¸ªæ–¹æ³•æˆ–è€…æ‰€æœ‰æ–¹æ³•çš„é¢„æœŸæ­£ç¡®æ€§

æµ‹è¯•æ–¹æ³•æ³¨æ„äº‹é¡¹ï¼š**å¿…é¡»æ˜¯publicä¿®é¥°çš„ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰å‚æ•°ï¼Œä½¿ç”¨æ³¨è§£@Testä¿®é¥°**

Junitå¸¸ç”¨æ³¨è§£(Junit 4.xxxxç‰ˆæœ¬)ï¼Œ@Test æµ‹è¯•æ–¹æ³•ï¼š

* @Beforeï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œä¸€æ¬¡
* @Afterï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œä¸€æ¬¡
* @BeforeClassï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹å‰**åª**æ‰§è¡Œä¸€æ¬¡
* @AfterClassï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹å**åª**æ‰§è¡Œä¸€æ¬¡

Junitå¸¸ç”¨æ³¨è§£(Junit5.xxxxç‰ˆæœ¬)ï¼Œ@Test æµ‹è¯•æ–¹æ³•ï¼š

* @BeforeEachï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œä¸€æ¬¡
* @AfterEachï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œä¸€æ¬¡
* @BeforeAllï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡
* @AfterAllï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹ååªæ‰§è¡Œä¸€æ¬¡

ä½œç”¨ï¼š

* å¼€å§‹æ‰§è¡Œçš„æ–¹æ³•ï¼šåˆå§‹åŒ–èµ„æº
* æ‰§è¡Œå®Œä¹‹åçš„æ–¹æ³•ï¼šé‡Šæ”¾èµ„æº

```java
public class UserService {
    public String login(String loginName , String passWord){
        if("admin".equals(loginName)&&"123456".equals(passWord)){
            return "success";
        }
        return "ç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ï¼";
    }
    public void chu(int a , int b){
        System.out.println(a / b);
    }
}
```

```java
//æµ‹è¯•æ–¹æ³•çš„è¦æ±‚ï¼š1.å¿…é¡»publicä¿®é¥° 2.æ²¡æœ‰è¿”å›å€¼æ²¡æœ‰å‚æ•° 3. å¿…é¡»ä½¿æ³¨è§£@Testä¿®é¥°
public class UserServiceTest {
     // @Beforeï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œä¸€æ¬¡ã€‚
    @Before
    public void before(){
        System.out.println("===before===");
    }
    // @Afterï¼šç”¨æ¥ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚
    @After
    public void after(){
        System.out.println("===after===");
    }
    // @BeforeClassï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡ã€‚
    @BeforeClass
    public static void beforeClass(){
        System.out.println("===beforeClass===");
    }
    // @AfterClassï¼šç”¨æ¥é™æ€ä¿®é¥°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹ååªæ‰§è¡Œä¸€æ¬¡ã€‚
    @AfterClass
    public static void afterClass(){
        System.out.println("===afterClass===");
    }
    @Test
    public void testLogin(){
        UserService userService = new UserService();
        String rs = userService.login("admin","123456");
        /**æ–­è¨€é¢„æœŸç»“æœçš„æ­£ç¡®æ€§ã€‚
         * å‚æ•°ä¸€ï¼šæµ‹è¯•å¤±è´¥çš„æç¤ºä¿¡æ¯ã€‚
         * å‚æ•°äºŒï¼šæœŸæœ›å€¼ã€‚
         * å‚æ•°ä¸‰ï¼šå®é™…å€¼
         */
        Assert.assertEquals("ç™»å½•ä¸šåŠ¡åŠŸèƒ½æ–¹æ³•æœ‰é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼","success",rs);
    }
    @Test
    public void testChu(){
        UserService userService = new UserService();
        userService.chu(10 , 0);
    }
}
```





****



### ä»‹ç»åå°„

åå°„æ˜¯æŒ‡å¯¹äºä»»ä½•ä¸€ä¸ªç±»ï¼Œåœ¨"è¿è¡Œçš„æ—¶å€™"éƒ½å¯ä»¥ç›´æ¥å¾—åˆ°è¿™ä¸ªç±»å…¨éƒ¨æˆåˆ†

* æ„é€ å™¨å¯¹è±¡ï¼šConstructor
* æˆå‘˜å˜é‡å¯¹è±¡ï¼šField

* æˆå‘˜æ–¹æ³•å¯¹è±¡ï¼šMethod

æ ¸å¿ƒæ€æƒ³ï¼šåœ¨è¿è¡Œæ—¶è·å–ç±»ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶å¯¹è±¡ï¼Œç„¶åè§£æç±»ä¸­çš„å…¨éƒ¨æˆåˆ†

åå°„æä¾›äº†ä¸€ä¸ªClassç±»å‹ï¼šHelloWorld.java â†’ javac â†’ HelloWorld.class

* `Class c = HelloWorld.class;` 

æ³¨æ„ï¼šåå°„æ˜¯å·¥ä½œåœ¨**è¿è¡Œæ—¶**çš„æŠ€æœ¯ï¼Œåªæœ‰è¿è¡Œä¹‹åæ‰ä¼šæœ‰ class ç±»å¯¹è±¡

ä½œç”¨ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶å¾—åˆ°ä¸€ä¸ªç±»çš„å…¨éƒ¨æˆåˆ†ç„¶åæ“ä½œï¼Œç ´åå°è£…æ€§ï¼Œä¹Ÿå¯ä»¥ç ´åæ³›å‹çš„çº¦æŸæ€§ã€‚

**åå°„çš„ä¼˜ç‚¹ï¼š**

- å¯æ‰©å±•æ€§ï¼šåº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨å…¨é™å®šååˆ›å»ºå¯æ‰©å±•å¯¹è±¡çš„å®ä¾‹ï¼Œæ¥ä½¿ç”¨æ¥è‡ªå¤–éƒ¨çš„ç”¨æˆ·è‡ªå®šä¹‰ç±»
- ç±»æµè§ˆå™¨å’Œå¯è§†åŒ–å¼€å‘ç¯å¢ƒï¼šä¸€ä¸ªç±»æµè§ˆå™¨éœ€è¦å¯ä»¥æšä¸¾ç±»çš„æˆå‘˜ï¼Œå¯è§†åŒ–å¼€å‘ç¯å¢ƒï¼ˆå¦‚ IDEï¼‰å¯ä»¥ä»åˆ©ç”¨åå°„ä¸­å¯ç”¨çš„ç±»å‹ä¿¡æ¯ä¸­å—ç›Šï¼Œä»¥å¸®åŠ©ç¨‹åºå‘˜ç¼–å†™æ­£ç¡®çš„ä»£ç 
- è°ƒè¯•å™¨å’Œæµ‹è¯•å·¥å…·ï¼š è°ƒè¯•å™¨éœ€è¦èƒ½å¤Ÿæ£€æŸ¥ä¸€ä¸ªç±»é‡Œçš„ç§æœ‰æˆå‘˜ã€‚æµ‹è¯•å·¥å…·å¯ä»¥åˆ©ç”¨åå°„æ¥è‡ªåŠ¨åœ°è°ƒç”¨ç±»é‡Œå®šä¹‰çš„å¯è¢«å‘ç°çš„ API å®šä¹‰ï¼Œä»¥ç¡®ä¿ä¸€ç»„æµ‹è¯•ä¸­æœ‰è¾ƒé«˜çš„ä»£ç è¦†ç›–ç‡

**åå°„çš„ç¼ºç‚¹ï¼š**

- æ€§èƒ½å¼€é”€ï¼šåå°„æ¶‰åŠäº†åŠ¨æ€ç±»å‹çš„è§£æï¼Œæ‰€ä»¥ JVM æ— æ³•å¯¹è¿™äº›ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œåå°„æ“ä½œçš„æ•ˆç‡è¦æ¯”é‚£äº›éå°„æ“ä½œä½å¾—å¤šï¼Œåº”è¯¥é¿å…åœ¨ç»å¸¸è¢«æ‰§è¡Œçš„ä»£ç æˆ–å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„ç¨‹åºä¸­ä½¿ç”¨åå°„ã€‚
- å®‰å…¨é™åˆ¶ï¼šä½¿ç”¨åå°„æŠ€æœ¯è¦æ±‚ç¨‹åºå¿…é¡»åœ¨ä¸€ä¸ªæ²¡æœ‰å®‰å…¨é™åˆ¶çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œå¦‚æœä¸€ä¸ªç¨‹åºå¿…é¡»åœ¨æœ‰å®‰å…¨é™åˆ¶çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œå¦‚ Appletï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸ªé—®é¢˜äº†
- å†…éƒ¨æš´éœ²ï¼šç”±äºåå°„å…è®¸ä»£ç æ‰§è¡Œä¸€äº›åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸è¢«å…è®¸çš„æ“ä½œï¼ˆæ¯”å¦‚è®¿é—®ç§æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨åå°„å¯èƒ½ä¼šå¯¼è‡´æ„æ–™ä¹‹å¤–çš„å‰¯ä½œç”¨ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»£ç åŠŸèƒ½å¤±è°ƒå¹¶ç ´åå¯ç§»æ¤æ€§ã€‚åå°„ä»£ç ç ´åäº†æŠ½è±¡æ€§ï¼Œå› æ­¤å½“å¹³å°å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä»£ç çš„è¡Œä¸ºå°±æœ‰å¯èƒ½ä¹Ÿéšç€å˜åŒ–



***



### è·å–å…ƒç´ 

#### è·å–ç±»

åå°„æŠ€æœ¯çš„ç¬¬ä¸€æ­¥æ˜¯å…ˆå¾—åˆ°Classç±»å¯¹è±¡ï¼Œæœ‰ä¸‰ç§æ–¹å¼è·å–ï¼š

* ç±»å.class
* é€šè¿‡ç±»çš„å¯¹è±¡.getClass()æ–¹æ³•
* Class.forName("ç±»çš„å…¨é™å")ï¼š`public static Class<?> forName(String className) `

Classç±»ä¸‹çš„æ–¹æ³•ï¼š

| æ–¹æ³•                   | ä½œç”¨                                                         |
| ---------------------- | ------------------------------------------------------------ |
| String getSimpleName() | è·å¾—ç±»åå­—ç¬¦ä¸²ï¼šç±»å                                         |
| String getName()       | è·å¾—ç±»å…¨åï¼šåŒ…å+ç±»å                                        |
| T newInstance()        | åˆ›å»ºClasså¯¹è±¡å…³è”ç±»çš„å¯¹è±¡ï¼Œåº•å±‚æ˜¯è°ƒç”¨æ— å‚æ•°æ„é€ å™¨ï¼Œå·²ç»è¢«æ·˜æ±° |

```java
public class ReflectDemo{
    public static void main(String[] args) throws Exception {
        // åå°„çš„ç¬¬ä¸€æ­¥æ°¸è¿œæ˜¯å…ˆå¾—åˆ°ç±»çš„Classæ–‡ä»¶å¯¹è±¡: å­—èŠ‚ç æ–‡ä»¶ã€‚
        // 1.ç±»å.class
        Class c1 = Student.class;
        System.out.println(c1);//class _03åå°„_è·å–Classç±»å¯¹è±¡.Student

        // 2.å¯¹è±¡.getClass()
        Student swk = new Student();
        Class c2 = swk.getClass();
        System.out.println(c2);

        // 3.Class.forName("ç±»çš„å…¨é™å")
        // ç›´æ¥å»åŠ è½½è¯¥ç±»çš„classæ–‡ä»¶ã€‚
        Class c3 = Class.forName("_03åå°„_è·å–Classç±»å¯¹è±¡.Student");
        System.out.println(c3);

        System.out.println(c1.getSimpleName()); // è·å–ç±»åæœ¬èº«ï¼ˆç®€åï¼‰Student
        System.out.println(c1.getName()); //è·å–ç±»çš„å…¨é™å_03åå°„_è·å–Classç±»å¯¹è±¡.Student
    }
}
class Student{}
```



***



#### è·å–æ„é€ 

è·å–æ„é€ å™¨çš„APIï¼š

* Constructor getConstructor(Class... parameterTypes)ï¼šæ ¹æ®å‚æ•°åŒ¹é…è·å–æŸä¸ªæ„é€ å™¨ï¼Œåªèƒ½æ‹¿publicä¿®é¥°çš„æ„é€ å™¨ï¼Œå‡ ä¹ä¸ç”¨ï¼
* **Constructor getDeclaredConstructor(Class... parameterTypes)**ï¼šæ ¹æ®å‚æ•°åŒ¹é…è·å–æŸä¸ªæ„é€ å™¨ï¼Œåªè¦ç”³æ˜å°±å¯ä»¥å®šä½ï¼Œä¸å…³å¿ƒæƒé™ä¿®é¥°ç¬¦
* Constructor[] getConstructors()ï¼šè·å–æ‰€æœ‰çš„æ„é€ å™¨ï¼Œåªèƒ½æ‹¿publicä¿®é¥°çš„æ„é€ å™¨ï¼Œå‡ ä¹ä¸ç”¨ï¼
* **Constructor[] getDeclaredConstructors()**ï¼šè·å–æ‰€æœ‰æ„é€ å™¨ï¼Œåªè¦ç”³æ˜å°±å¯ä»¥å®šä½ï¼Œä¸å…³å¿ƒæƒé™ä¿®é¥°ç¬¦ã€‚

Constructorçš„å¸¸ç”¨APIï¼š

| æ–¹æ³•                              | ä½œç”¨                                   |
| --------------------------------- | -------------------------------------- |
| T newInstance(Object... initargs) | åˆ›å»ºå¯¹è±¡ï¼Œæ³¨å…¥æ„é€ å™¨éœ€è¦çš„æ•°æ®         |
| void setAccessible(true)          | ä¿®æ”¹è®¿é—®æƒé™ï¼Œtrueæ”»ç ´æƒé™ï¼ˆæš´åŠ›åå°„ï¼‰ |
| String getName()                  | ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›æ­¤æ„é€ å‡½æ•°çš„åç§°       |
| int getParameterCount()           | è¿”å›å‚æ•°æ•°é‡                           |
| Class<?>[] getParameterTypes      | è¿”å›å‚æ•°ç±»å‹æ•°ç»„                       |

```java
public class TestStudent01 {
    @Test
    public void getDeclaredConstructors(){
        // a.åå°„ç¬¬ä¸€æ­¥å…ˆå¾—åˆ°Classç±»å¯¹è±¡
        Class c = Student.class ;
        // b.å®šä½å…¨éƒ¨æ„é€ å™¨ï¼Œåªè¦ç”³æ˜äº†å°±å¯ä»¥æ‹¿åˆ°
        Constructor[] cons = c.getDeclaredConstructors();
        // c.éå†è¿™äº›æ„é€ å™¨
        for (Constructor con : cons) {
            System.out.println(con.getName()+"->"+con.getParameterCount());
        }
    }
    @Test
    public void getDeclaredConstructor() throws Exception {
        // a.åå°„ç¬¬ä¸€æ­¥å…ˆå¾—åˆ°Classç±»å¯¹è±¡
        Class c = Student.class ;
        // b.å®šä½æŸä¸ªæ„é€ å™¨ï¼Œæ ¹æ®å‚æ•°åŒ¹é…ï¼Œåªè¦ç”³æ˜äº†å°±å¯ä»¥è·å–
        //Constructor con = c.getDeclaredConstructor(); // å¯ä»¥æ‹¿åˆ°ï¼å®šä½æ— å‚æ•°æ„é€ å™¨ï¼
        Constructor con = c.getDeclaredConstructor(String.class, int.class); //æœ‰å‚æ•°çš„ï¼!
        // c.æ„é€ å™¨åç§°å’Œå‚æ•°
        System.out.println(con.getName()+"->"+con.getParameterCount());
    }
}
```

```java
public class Student {
    private String name ;
    private int age ;
    private Student(){
        System.out.println("æ— å‚æ•°æ„é€ å™¨è¢«æ‰§è¡Œ~~~~");
    }
    public Student(String name, int age) {
        System.out.println("æœ‰å‚æ•°æ„é€ å™¨è¢«æ‰§è¡Œ~~~~");
        this.name = name;
        this.age = age;
    }
}
```

```java
//æµ‹è¯•æ–¹æ³•
public class TestStudent02 {
    // 1.è°ƒç”¨æ— å‚æ•°æ„é€ å™¨å¾—åˆ°ä¸€ä¸ªç±»çš„å¯¹è±¡è¿”å›ã€‚
    @Test
    public void createObj01() throws Exception {
        // a.åå°„ç¬¬ä¸€æ­¥æ˜¯å…ˆå¾—åˆ°Classç±»å¯¹è±¡
        Class c = Student.class ;
        // b.å®šä½æ— å‚æ•°æ„é€ å™¨å¯¹è±¡
        Constructor constructor = c.getDeclaredConstructor();
        // c.æš´åŠ›æ‰“å¼€ç§æœ‰æ„é€ å™¨çš„è®¿é—®æƒé™
        constructor.setAccessible(true);
        // d.é€šè¿‡æ— å‚æ•°æ„é€ å™¨åˆå§‹åŒ–å¯¹è±¡è¿”å›
        Student swk = (Student) constructor.newInstance(); // æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨æ— å‚æ•°æ„é€ å™¨çš„ï¼
        System.out.println(swk);//Student{name='null', age=0}
    }

    // 2.è°ƒç”¨æœ‰å‚æ•°æ„é€ å™¨å¾—åˆ°ä¸€ä¸ªç±»çš„å¯¹è±¡è¿”å›ã€‚
    @Test
    public void createObj02() throws Exception {
        // a.åå°„ç¬¬ä¸€æ­¥æ˜¯å…ˆå¾—åˆ°Classç±»å¯¹è±¡
        Class c = Student.class ;
        // b.å®šä½æœ‰å‚æ•°æ„é€ å™¨å¯¹è±¡
        Constructor constructor = c.getDeclaredConstructor(String.class , int.class);
        // c.é€šè¿‡æ— å‚æ•°æ„é€ å™¨åˆå§‹åŒ–å¯¹è±¡è¿”å›
        Student swk = (Student) constructor.newInstance("å­™æ‚Ÿç©º",500); // æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨æœ‰å‚æ•°æ„é€ å™¨çš„ï¼
        System.out.println(swk);//Student{name='å­™æ‚Ÿç©º', age=500}
    }
}


```



***



#### è·å–å˜é‡

è·å–Fieldæˆå‘˜å˜é‡APIï¼š

* Field getField(String name) : æ ¹æ®æˆå‘˜å˜é‡åè·å¾—å¯¹åº”Fieldå¯¹è±¡ï¼Œåªèƒ½è·å¾—publicä¿®é¥°
* Field getDeclaredField(String name) : æ ¹æ®æˆå‘˜å˜é‡åè·å¾—å¯¹åº”Fieldå¯¹è±¡ï¼Œæ‰€æœ‰ç”³æ˜çš„å˜é‡
* Field[] getFields() : è·å¾—æ‰€æœ‰çš„æˆå‘˜å˜é‡å¯¹åº”çš„Fieldå¯¹è±¡ï¼Œåªèƒ½è·å¾—publicçš„
* Field[] getDeclaredFields() : è·å¾—æ‰€æœ‰çš„æˆå‘˜å˜é‡å¯¹åº”çš„Fieldå¯¹è±¡ï¼Œåªè¦ç”³æ˜äº†å°±å¯ä»¥å¾—åˆ° 

Fieldçš„æ–¹æ³•ï¼šç»™æˆå‘˜å˜é‡èµ‹å€¼å’Œå–å€¼

| æ–¹æ³•                               | ä½œç”¨                                                      |
| ---------------------------------- | --------------------------------------------------------- |
| void set(Object obj, Object value) | ç»™å¯¹è±¡æ³¨å…¥æŸä¸ªæˆå‘˜å˜é‡æ•°æ®ï¼Œ**objæ˜¯å¯¹è±¡**ï¼Œvalueæ˜¯å€¼      |
| Object get(Object obj)             | è·å–æŒ‡å®šå¯¹è±¡çš„æˆå‘˜å˜é‡çš„å€¼ï¼Œ**objæ˜¯å¯¹è±¡**ï¼Œæ²¡æœ‰å¯¹è±¡ä¸ºnull |
| void setAccessible(true)           | æš´åŠ›åå°„ï¼Œè®¾ç½®ä¸ºå¯ä»¥ç›´æ¥è®¿é—®ç§æœ‰ç±»å‹çš„å±æ€§                |
| Class getType()                    | è·å–å±æ€§çš„ç±»å‹ï¼Œè¿”å›Classå¯¹è±¡                             |
| String getName()                   | è·å–å±æ€§çš„åç§°                                            |

```Java
public class FieldDemo {
    //è·å–å…¨éƒ¨æˆå‘˜å˜é‡
    @Test
    public void getDeclaredFields(){
        // a.å…ˆè·å–classç±»å¯¹è±¡
        Class c = Dog.class;
        // b.è·å–å…¨éƒ¨ç”³æ˜çš„æˆå‘˜å˜é‡å¯¹è±¡
        Field[] fields = c.getDeclaredFields();
        for (Field field : fields) {
            System.out.println(field.getName()+"->"+field.getType());
        }
    }
    //è·å–æŸä¸ªæˆå‘˜å˜é‡
    @Test
    public void getDeclaredField() throws Exception {
        // a.å…ˆè·å–classç±»å¯¹è±¡
        Class c = Dog.class;
        // b.å®šä½æŸä¸ªæˆå‘˜å˜é‡å¯¹è±¡ :æ ¹æ®åç§°å®šä½ï¼ï¼
        Field ageF = c.getDeclaredField("age");
        System.out.println(ageF.getName()+"->"+ageF.getType());
    }
}
```

```java
public class Dog {
    private String name;
    private int age ;
    private String color ;
    public static String school;
    public static final String SCHOOL_1 = "å® ç‰©å­¦æ ¡";

    public Dog() {
    }

    public Dog(String name, int age, String color) {
        this.name = name;
        this.age = age;
        this.color = color;
    }
}
```

```java
//æµ‹è¯•æ–¹æ³•
public class FieldDemo02 {
    @Test
    public void setField() throws Exception {
        // a.åå°„çš„ç¬¬ä¸€æ­¥è·å–Classç±»å¯¹è±¡
        Class c = Dog.class ;
        // b.å®šä½nameæˆå‘˜å˜é‡
        Field name = c.getDeclaredField("name");
        // c.ä¸ºè¿™ä¸ªæˆå‘˜å˜é‡èµ‹å€¼ï¼
        Dog d = new Dog();
        name.setAccessible(true);
        name.set(d,"æ³°è¿ª");
        System.out.println(d);//Dog{name='æ³°è¿ª', age=0, color='null'}
        // d.è·å–æˆå‘˜å˜é‡çš„å€¼
        String value = name.get(d)+"";
        System.out.println(value);//æ³°è¿ª
    }
}
```



#### è·å–æ–¹æ³•

è·å–Methodæ–¹æ³•APIï¼š

* Method getMethod(String name,Class...args)ï¼šæ ¹æ®æ–¹æ³•åå’Œå‚æ•°ç±»å‹è·å¾—æ–¹æ³•å¯¹è±¡ï¼Œpublicä¿®é¥°
* Method getDeclaredMethod(String name,Class...args)ï¼šæ ¹æ®æ–¹æ³•åå’Œå‚æ•°ç±»å‹è·å¾—æ–¹æ³•å¯¹è±¡ï¼ŒåŒ…æ‹¬private
* Method[] getMethods()ï¼šè·å¾—ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•å¯¹è±¡è¿”å›æ•°ç»„ï¼Œåªèƒ½è·å¾—publicä¿®é¥°ä¸”åŒ…å«çˆ¶ç±»çš„
* Method[] getDeclaredMethods()ï¼šè·å¾—ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•å¯¹è±¡ï¼Œè¿”å›æ•°ç»„ï¼Œåªè·å¾—æœ¬ç±»ç”³æ˜çš„æ–¹æ³•

Methodå¸¸ç”¨APIï¼š
`public Object invoke(Object obj, Object... args) `ï¼šä½¿ç”¨æŒ‡å®šçš„å‚æ•°è°ƒç”¨ç”±æ­¤æ–¹æ³•å¯¹è±¡ï¼Œobjå¯¹è±¡å

```java
public class MethodDemo{
    //è·å¾—ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•å¯¹è±¡
    @Test
    public void getDeclaredMethods(){
        // a.å…ˆè·å–classç±»å¯¹è±¡
        Class c = Dog.class ;
        // b.è·å–å…¨éƒ¨ç”³æ˜çš„æ–¹æ³•!
        Method[] methods = c.getDeclaredMethods();
        // c.éå†è¿™äº›æ–¹æ³•
        for (Method method : methods) {
            System.out.println(method.getName()+"->"
                    + method.getParameterCount()+"->" + method.getReturnType());
        }
    }
    @Test
    public void getDeclardMethod() throws Exception {
        Class c = Dog.class;
        Method run = c.getDeclaredMethod("run");
        // c.è§¦å‘æ–¹æ³•æ‰§è¡Œ!
        Dog d = new Dog();
        Object o = run.invoke(d);
        System.out.println(o);// å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œç»“æœæ˜¯null
        
		//å‚æ•°ä¸€ï¼šæ–¹æ³•åç§°   å‚æ•°äºŒï¼šæ–¹æ³•çš„å‚æ•°ä¸ªæ•°å’Œç±»å‹(å¯å˜å‚æ•°ï¼)
        Method eat = c.getDeclaredMethod("eat",String.class);
        eat.setAccessible(true); // æš´åŠ›åå°„ï¼
        
       	//å‚æ•°ä¸€ï¼šè¢«è§¦å‘æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡  å‚æ•°äºŒï¼šæ–¹æ³•éœ€è¦çš„å…¥å‚å€¼
        Object o1 = eat.invoke(d,"è‚‰");
        System.out.println(o1);// å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œç»“æœæ˜¯null
    }
}

public class Dog {
    private String name ;
    public Dog(){
    }
    public void run(){System.out.println("ç‹—è·‘çš„è´¼å¿«~~");}
	private void eat(){System.out.println("ç‹—åƒéª¨å¤´");}
	private void eat(String name){System.out.println("ç‹—åƒ"+name);}
	public static void inAddr(){System.out.println("åœ¨å‰å±±åŒºæœ‰ä¸€åªå•èº«ç‹—ï¼");}
}
```



***



### æš´åŠ›æ”»å‡»

æ³›å‹åªèƒ½å·¥ä½œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œè¿è¡Œé˜¶æ®µæ³›å‹å°±æ¶ˆå¤±äº†ï¼Œåå°„å·¥ä½œåœ¨è¿è¡Œæ—¶é˜¶æ®µ

1. åå°„å¯ä»¥ç ´åé¢å‘å¯¹è±¡çš„å°è£…æ€§ï¼ˆæš´åŠ›åå°„ï¼‰
2. åŒæ—¶å¯ä»¥ç ´åæ³›å‹çš„çº¦æŸæ€§

```java
public class ReflectDemo {
    public static void main(String[] args) throws Exception {
        List<Double> scores = new ArrayList<>();
        scores.add(99.3);
        scores.add(199.3);
        scores.add(89.5);
        // æ‹“å±•ï¼šé€šè¿‡åå°„æš´åŠ›çš„æ³¨å…¥ä¸€ä¸ªå…¶ä»–ç±»å‹çš„æ•°æ®è¿›å»ã€‚
        // a.å…ˆå¾—åˆ°é›†åˆå¯¹è±¡çš„Classæ–‡ä»¶å¯¹è±¡
        Class c = scores.getClass();
        // b.ä»ArrayListçš„Classå¯¹è±¡ä¸­å®šä½addæ–¹æ³•
        Method add = c.getDeclaredMethod("add", Object.class);
        // c.è§¦å‘scoresé›†åˆå¯¹è±¡ä¸­çš„addæ‰§è¡Œï¼ˆè¿è¡Œé˜¶æ®µï¼Œæ³›å‹ä¸èƒ½çº¦æŸäº†ï¼‰
        add.invoke(scores,"æ³¢ä»”");
        System.out.println(scores);
    }
}
```

 



***





## æ³¨è§£

### æ¦‚å¿µ

æ³¨è§£ï¼šç±»çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥ç»™ç±»æºå¸¦ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œæä¾›ä¸€ç§å®‰å…¨çš„ç±»ä¼¼æ³¨é‡Šæ ‡è®°çš„æœºåˆ¶ï¼Œç”¨æ¥å°†ä»»ä½•ä¿¡æ¯æˆ–å…ƒæ•°æ®ï¼ˆmetadataï¼‰ä¸ç¨‹åºå…ƒç´ ï¼ˆç±»ã€æ–¹æ³•ã€æˆå‘˜å˜é‡ç­‰ï¼‰è¿›è¡Œå…³è”

* æ³¨è§£æ˜¯ JDK1.5 çš„æ–°ç‰¹æ€§
* æ³¨è§£æ˜¯ç»™ç¼–è¯‘å™¨æˆ– JVM çœ‹çš„ï¼Œç¼–è¯‘å™¨æˆ– JVM å¯ä»¥æ ¹æ®æ³¨è§£æ¥å®Œæˆå¯¹åº”çš„åŠŸèƒ½
* æ³¨è§£ç±»ä¼¼ä¿®é¥°ç¬¦ï¼Œåº”ç”¨äºåŒ…ã€ç±»å‹ã€æ„é€ æ–¹æ³•ã€æ–¹æ³•ã€æˆå‘˜å˜é‡ã€å‚æ•°åŠæœ¬åœ°å˜é‡çš„å£°æ˜è¯­å¥ä¸­

æ³¨è§£ä½œç”¨ï¼š

* æ ‡è®°
* æ¡†æ¶æŠ€æœ¯å¤šåŠéƒ½æ˜¯åœ¨ä½¿ç”¨æ³¨è§£å’Œåå°„ï¼Œéƒ½æ˜¯å±äºæ¡†æ¶çš„åº•å±‚åŸºç¡€æŠ€æœ¯
* åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ ¼å¼æ£€æŸ¥ï¼Œæ¯”å¦‚æ–¹æ³•é‡å†™çº¦æŸ @Overrideã€å‡½æ•°å¼æ¥å£çº¦æŸ @FunctionalInterface.



***



### æ³¨è§£æ ¼å¼

å®šä¹‰æ ¼å¼ï¼šè‡ªå®šä¹‰æ³¨è§£ç”¨@interfaceå…³é”®å­—ï¼Œæ³¨è§£é»˜è®¤å¯ä»¥æ ‡è®°å¾ˆå¤šåœ°æ–¹

```java
ä¿®é¥°ç¬¦ @interface æ³¨è§£å{
     // æ³¨è§£å±æ€§
}
```

ä½¿ç”¨æ³¨è§£çš„æ ¼å¼ï¼š@æ³¨è§£å

```java
@Book
@MyTest
public class MyBook {
    //æ–¹æ³•å˜é‡éƒ½å¯ä»¥æ³¨è§£
}

@interface Book{
}
@interface MyTest{
}
```



***



### æ³¨è§£å±æ€§

#### æ™®é€šå±æ€§

æ³¨è§£å¯ä»¥æœ‰å±æ€§ï¼Œ**å±æ€§åå¿…é¡»å¸¦()**ï¼Œåœ¨ç”¨æ³¨è§£çš„æ—¶å€™ï¼Œå±æ€§å¿…é¡»èµ‹å€¼ï¼Œé™¤éå±æ€§æœ‰é»˜è®¤å€¼

å±æ€§çš„æ ¼å¼ï¼š

* æ ¼å¼1ï¼šæ•°æ®ç±»å‹ å±æ€§å();
* æ ¼å¼2ï¼šæ•°æ®ç±»å‹ å±æ€§å() default é»˜è®¤å€¼;

å±æ€§é€‚ç”¨çš„æ•°æ®ç±»å‹:

* å…«ç§æ•°æ®æ•°æ®ç±»å‹(intï¼Œshortï¼Œlongï¼Œdoubleï¼Œbyteï¼Œcharï¼Œbooleanï¼Œfloat) å’Œ Stringã€Class
* ä»¥ä¸Šç±»å‹çš„æ•°ç»„å½¢å¼éƒ½æ”¯æŒ

```java
@MyBook(name="ã€Šç²¾é€šJavaåŸºç¡€ã€‹",authors = {"æ’­ä»”","Dlei","æ’­å¦"} , price = 99.9 )
public class AnnotationDemo01 {
    @MyBook(name="ã€Šç²¾é€šMySQLæ•°æ®åº“å…¥é—¨åˆ°åˆ åº“è·‘è·¯ã€‹",authors = {"å°ç™½","å°é»‘"} ,
     					price = 19.9 , address = "åŒ—äº¬")
    public static void main(String[] args) {
    }
}
// è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£
@interface MyBook{
    String name();
    String[] authors(); // æ•°ç»„
    double price();
    String address() default "æ­¦æ±‰";
}

```



#### ç‰¹æ®Šå±æ€§

æ³¨è§£çš„ç‰¹æ®Šå±æ€§åç§°ï¼švalue

* å¦‚æœåªæœ‰ä¸€ä¸ªvalueå±æ€§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨valueå±æ€§çš„æ—¶å€™å¯ä»¥çœç•¥valueåç§°ä¸å†™
* å¦‚æœæœ‰å¤šä¸ªå±æ€§ï¼Œä¸”å¤šä¸ªå±æ€§æ²¡æœ‰é»˜è®¤å€¼ï¼Œé‚£ä¹ˆvalueæ˜¯ä¸èƒ½çœç•¥çš„

```java
//@Book("/deleteBook.action")
@Book(value = "/deleteBook.action" , age = 12)
public class AnnotationDemo01{
}

@interface Book{
    String value();
    int age() default 10;
}
```



***



### å…ƒæ³¨è§£

å…ƒæ³¨è§£æ˜¯sunå…¬å¸æä¾›çš„ï¼Œç”¨æ¥æ³¨è§£è‡ªå®šä¹‰æ³¨è§£

å…ƒæ³¨è§£æœ‰å››ä¸ªï¼š

* @Targetï¼šçº¦æŸè‡ªå®šä¹‰æ³¨è§£å¯ä»¥æ ‡è®°çš„èŒƒå›´ï¼Œé»˜è®¤å€¼ä¸ºä»»ä½•å…ƒç´ ï¼Œè¡¨ç¤ºè¯¥æ³¨è§£ç”¨äºä»€ä¹ˆåœ°æ–¹

  å¯ä½¿ç”¨çš„å€¼å®šä¹‰åœ¨ElementTypeæšä¸¾ç±»ä¸­ï¼š

  - `ElementType.CONSTRUCTOR`ï¼šç”¨äºæè¿°æ„é€ å™¨
  - `ElementType.FIELD`ï¼šæˆå‘˜å˜é‡ã€å¯¹è±¡ã€å±æ€§ï¼ˆåŒ…æ‹¬enumå®ä¾‹ï¼‰
  - `ElementType.LOCAL_VARIABLE`ï¼šç”¨äºæè¿°å±€éƒ¨å˜é‡
  - `ElementType.METHOD`ï¼šç”¨äºæè¿°æ–¹æ³•
  - `ElementType.PACKAGE`ï¼šç”¨äºæè¿°åŒ…
  - `ElementType.PARAMETER`ï¼šç”¨äºæè¿°å‚æ•°
  - `ElementType.TYPE`ï¼šç”¨äºæè¿°ç±»ã€æ¥å£(åŒ…æ‹¬æ³¨è§£ç±»å‹) æˆ–enumå£°æ˜

* @Retentionï¼šå®šä¹‰è¯¥æ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸï¼Œç”³æ˜æ³¨è§£çš„ä½œç”¨èŒƒå›´ï¼šç¼–è¯‘æ—¶ï¼Œè¿è¡Œæ—¶

  å¯ä½¿ç”¨çš„å€¼å®šä¹‰åœ¨RetentionPolicyæšä¸¾ç±»ä¸­ï¼š

  - `RetentionPolicy.SOURCE`ï¼šåœ¨ç¼–è¯‘é˜¶æ®µä¸¢å¼ƒï¼Œè¿™äº›æ³¨è§£åœ¨ç¼–è¯‘ç»“æŸä¹‹åå°±ä¸å†æœ‰ä»»ä½•æ„ä¹‰ï¼Œåªä½œç”¨åœ¨æºç é˜¶æ®µï¼Œç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­ä¸å­˜åœ¨ã€‚`@Override`, `@SuppressWarnings`éƒ½å±äºè¿™ç±»æ³¨è§£
  - `RetentionPolicy.CLASS`ï¼šåœ¨ç±»åŠ è½½æ—¶ä¸¢å¼ƒï¼Œåœ¨å­—èŠ‚ç æ–‡ä»¶çš„å¤„ç†ä¸­æœ‰ç”¨ï¼Œè¿è¡Œé˜¶æ®µä¸å­˜åœ¨ï¼Œé»˜è®¤å€¼
  - `RetentionPolicy.RUNTIME` : å§‹ç»ˆä¸ä¼šä¸¢å¼ƒï¼Œè¿è¡ŒæœŸä¹Ÿä¿ç•™è¯¥æ³¨è§£ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨åå°„æœºåˆ¶è¯»å–è¯¥æ³¨è§£çš„ä¿¡æ¯ï¼Œè‡ªå®šä¹‰çš„æ³¨è§£é€šå¸¸ä½¿ç”¨è¿™ç§æ–¹å¼

* @Inheritedï¼šè¡¨ç¤ºä¿®é¥°çš„è‡ªå®šä¹‰æ³¨è§£å¯ä»¥è¢«å­ç±»ç»§æ‰¿

* @Documentedï¼šè¡¨ç¤ºæ˜¯å¦å°†è‡ªå®šä¹‰çš„æ³¨è§£ä¿¡æ¯æ·»åŠ åœ¨ java æ–‡æ¡£ä¸­

```java
public class AnnotationDemo01{
    // @MyTest // åªèƒ½æ³¨è§£æ–¹æ³•
    private String name;

    @MyTest
    public static void main( String[] args) {
    }
}
@Target(ElementType.METHOD) // ç”³æ˜åªèƒ½æ³¨è§£æ–¹æ³•
@Retention(RetentionPolicy.RUNTIME) // ç”³æ˜æ³¨è§£ä»å†™ä»£ç ä¸€ç›´åˆ°è¿è¡Œè¿˜åœ¨ï¼Œæ°¸è¿œå­˜æ´»ï¼ï¼
@interface MyTest{
}
```



***



### æ³¨è§£è§£æ

å¼€å‘ä¸­ç»å¸¸è¦çŸ¥é“ä¸€ä¸ªç±»çš„æˆåˆ†ä¸Šé¢åˆ°åº•æœ‰å“ªäº›æ³¨è§£ï¼Œæ³¨è§£æœ‰å“ªäº›å±æ€§æ•°æ®ï¼Œè¿™éƒ½éœ€è¦è¿›è¡Œæ³¨è§£çš„è§£æ

æ³¨è§£è§£æç›¸å…³çš„æ¥å£ï¼š

* Annotationï¼šæ³¨è§£ç±»å‹ï¼Œè¯¥ç±»æ˜¯æ‰€æœ‰æ³¨è§£çš„çˆ¶ç±»ï¼Œæ³¨è§£éƒ½æ˜¯ä¸€ä¸ª Annotation çš„å¯¹è±¡
* AnnotatedElementï¼šè¯¥æ¥å£å®šä¹‰äº†ä¸æ³¨è§£è§£æç›¸å…³çš„æ–¹æ³•
* Classã€Methodã€Fieldã€Constructor ç±»æˆåˆ†ï¼šå®ç° AnnotatedElement æ¥å£ï¼Œæ‹¥æœ‰è§£ææ³¨è§£çš„èƒ½åŠ›

API ï¼š

* `Annotation[] getDeclaredAnnotations()` : è·å¾—å½“å‰å¯¹è±¡ä¸Šä½¿ç”¨çš„æ‰€æœ‰æ³¨è§£ï¼Œè¿”å›æ³¨è§£æ•°ç»„
* `T getDeclaredAnnotation(Class<T> annotationClass)` : æ ¹æ®æ³¨è§£ç±»å‹è·å¾—å¯¹åº”æ³¨è§£å¯¹è±¡
* `T getAnnotation(Class<T> annotationClass)` : æ ¹æ®æ³¨è§£ç±»å‹è·å¾—å¯¹åº”æ³¨è§£å¯¹è±¡
* `boolean isAnnotationPresent(Class<Annotation> class)` : åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä½¿ç”¨äº†æŒ‡å®šçš„æ³¨è§£

æ³¨è§£åŸç†ï¼šæ³¨è§£æœ¬è´¨æ˜¯ä¸€ä¸ªç»§æ‰¿äº†`Annotation` çš„ç‰¹æ®Šæ¥å£ï¼Œå…¶å…·ä½“å®ç°ç±»æ˜¯ Java è¿è¡Œæ—¶ç”Ÿæˆçš„**åŠ¨æ€ä»£ç†ç±»**ï¼Œé€šè¿‡åå°„è·å–æ³¨è§£æ—¶ï¼Œè¿”å›çš„æ˜¯ Java è¿è¡Œæ—¶ç”Ÿæˆçš„åŠ¨æ€ä»£ç†å¯¹è±¡ `$Proxy1`ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨è‡ªå®šä¹‰æ³¨è§£ï¼ˆæ¥å£ï¼‰çš„æ–¹æ³•ï¼Œä¼šæœ€ç»ˆè°ƒç”¨ `AnnotationInvocationHandler` çš„ `invoke` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä» `memberValues`  è¿™ä¸ªMap ä¸­æ‰¾å‡ºå¯¹åº”çš„å€¼ï¼Œè€Œ `memberValues` çš„æ¥æºæ˜¯ Java å¸¸é‡æ± 

è§£ææ³¨è§£æ•°æ®çš„åŸç†ï¼šæ³¨è§£åœ¨å“ªä¸ªæˆåˆ†ä¸Šï¼Œå°±å…ˆæ‹¿å“ªä¸ªæˆåˆ†å¯¹è±¡ï¼Œæ¯”å¦‚æ³¨è§£ä½œç”¨åœ¨ç±»ä¸Šï¼Œåˆ™è¦è¯¥ç±»çš„Classå¯¹è±¡ï¼Œå†æ¥æ‹¿ä¸Šé¢çš„æ³¨è§£

```java
public class AnnotationDemo{
    @Test
    public void parseClass() {
        // 1.å®šä½Classç±»å¯¹è±¡
        Class c = BookStore.class;
        // 2.åˆ¤æ–­è¿™ä¸ªç±»ä¸Šæ˜¯å¦ä½¿ç”¨äº†æŸä¸ªæ³¨è§£
        if(c.isAnnotationPresent(Book.class)){
            // 3.è·å–è¿™ä¸ªæ³¨è§£å¯¹è±¡
            Book b = (Book)c.getDeclarAnnotation(Book.class);
            System.out.println(book.value());
            System.out.println(book.price());
            System.out.println(Arrays.toString(book.authors()));
        }
    }
    @Test
    public void parseMethod() throws Exception {
        Class c = BookStore.class;
        Method run = c.getDeclaredMethod("run");
        if(run.isAnnotationPresent(Book.class)){
            Book b = (Book)run.getDeclaredAnnotation(Book.class);
           	sout(ä¸Šé¢çš„ä¸‰ä¸ª);
        }
    }
}

@Book(value = "ã€ŠJavaåŸºç¡€åˆ°ç²¾é€šã€‹", price = 99.5, authors = {"æ³¢ä»”","æ³¢å¦"})
class BookStore{
    @Book(value = "ã€ŠMybatisæŒä¹…å±‚æ¡†æ¶ã€‹", price = 199.5, authors = {"dlei","æ’­å®¢"})
    public void run(){
    }
}
@Target({ElementType.TYPE,ElementType.METHOD}) // ç±»å’Œæˆå‘˜æ–¹æ³•ä¸Šä½¿ç”¨
@Retention(RetentionPolicy.RUNTIME) // æ³¨è§£æ°¸ä¹…å­˜æ´»
@interface Book{
    String value();
    double price() default 100;
    String[] authors();
}
```



***



### æ³¨è§£æ¨¡æ‹Ÿ

æ³¨è§£æ¨¡æ‹Ÿå†™ä¸€ä¸ª Junit æ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨

1. å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ MyTestï¼Œåªèƒ½æ³¨è§£æ–¹æ³•ï¼Œå­˜æ´»èŒƒå›´ä¸€ç›´éƒ½åœ¨ã€‚
2. å®šä¹‰è‹¥å¹²ä¸ªæ–¹æ³•ï¼Œåªè¦æœ‰ @MyTest æ³¨è§£çš„æ–¹æ³•å°±èƒ½è¢«è§¦å‘æ‰§è¡Œï¼Œæ²¡æœ‰è¿™ä¸ªæ³¨è§£çš„æ–¹æ³•ä¸èƒ½æ‰§è¡Œï¼ï¼

```java
public class TestDemo{
    @MyTest
    public void test01(){System.out.println("===test01===");}
    public void test02(){System.out.println("===test02===");}
    @MyTest
    public void test03(){System.out.println("===test03===");}
    @MyTest
    public void test04(){System.out.println("===test04===");}
    
    public static void main(String[] args) throws Exception {
        TestDemo t = new TestDemo();
        Class c = TestDemo.class;
        Method[] methods = c.getDeclaredMethods();
        for (Method method : methods) {
            if(method.isAnnotationPresent(MyTest.class)){
                method.invoke(t);
            }
        }
    }
}

@Target(ElementType.METHOD) // åªèƒ½æ³¨è§£æ–¹æ³•ï¼
@Retention(RetentionPolicy.RUNTIME) // ä¸€ç›´éƒ½æ´»ç€
@interface MyTest{
}
```



****



## XML

### æ¦‚è¿°

XMLä»‹ç»ï¼š

- XML æŒ‡å¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼ˆEXtensibleÂ MarkupÂ Languageï¼‰
- XML æ˜¯ä¸€ç§**æ ‡è®°è¯­è¨€**ï¼Œå¾ˆç±»ä¼¼ HTMLï¼ŒHTMLæ–‡ä»¶ä¹Ÿæ˜¯XMLæ–‡æ¡£
- XML çš„è®¾è®¡å®—æ—¨æ˜¯**ä¼ è¾“æ•°æ®**ï¼Œè€Œéæ˜¾ç¤ºæ•°æ®
- XML æ ‡ç­¾æ²¡æœ‰è¢«é¢„å®šä¹‰ï¼Œéœ€è¦è‡ªè¡Œå®šä¹‰æ ‡ç­¾
- XML è¢«è®¾è®¡ä¸ºå…·æœ‰è‡ªæˆ‘æè¿°æ€§ï¼Œæ˜“äºé˜…è¯»
- XML æ˜¯Â W3C çš„æ¨èæ ‡å‡†

**xmlä¸htmlçš„åŒºåˆ«**ï¼š

â€‹	XML ä¸æ˜¯ HTML çš„æ›¿ä»£ï¼ŒXML å’Œ HTML ä¸ºä¸åŒçš„ç›®çš„è€Œè®¾è®¡ã€‚
â€‹	XML è¢«è®¾è®¡ä¸ºä¼ è¾“å’Œå­˜å‚¨æ•°æ®ï¼Œå…¶ç„¦ç‚¹æ˜¯æ•°æ®çš„å†…å®¹ï¼›XMlæ ‡ç­¾å¯è‡ªå®šä¹‰ï¼Œä¾¿äºé˜…è¯»ã€‚
â€‹	HTML è¢«è®¾è®¡ç”¨æ¥æ˜¾ç¤ºæ•°æ®ï¼Œå…¶ç„¦ç‚¹æ˜¯æ•°æ®çš„å¤–è§‚ï¼›HTMLæ ‡ç­¾è¢«é¢„è®¾å¥½ï¼Œä¾¿äºæµè§ˆå™¨è¯†åˆ«ã€‚
â€‹	HTML æ—¨åœ¨æ˜¾ç¤ºä¿¡æ¯ï¼Œè€Œ XML æ—¨åœ¨ä¼ è¾“ä¿¡æ¯ã€‚



****



### åˆ›å»º

person.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<person id="110">
	<age>18</age>		<!--å¹´é¾„-->
	<name>å¼ ä¸‰</name>	  <!--å§“å-->
	<sex/>				<!--æ€§åˆ«-->
</person>
```



***



### ç»„æˆ

XMLæ–‡ä»¶ä¸­å¸¸è§çš„ç»„æˆå…ƒç´ æœ‰:æ–‡æ¡£å£°æ˜ã€å…ƒç´ ã€å±æ€§ã€æ³¨é‡Šã€è½¬ä¹‰å­—ç¬¦ã€å­—ç¬¦åŒºã€‚æ–‡ä»¶åç¼€åä¸ºxml

* **æ–‡æ¡£å£°æ˜** 
  ``<?xml version="1.0" encoding="utf-8" standalone="yes" ?>``
  æ–‡æ¡£å£°æ˜å¿…é¡»åœ¨ç¬¬ä¸€è¡Œï¼Œä»¥<?xmlå¼€å¤´ï¼Œä»¥ï¼Ÿ>ç»“æŸï¼Œ
  	versionï¼šæŒ‡å®šXMLæ–‡æ¡£ç‰ˆæœ¬ã€‚å¿…é¡»å±æ€§ï¼Œè¿™é‡Œä¸€èˆ¬é€‰æ‹©1.0ï¼›
  	encondingï¼šæŒ‡å®šå½“å‰æ–‡æ¡£çš„ç¼–ç ï¼Œå¯é€‰å±æ€§ï¼Œé»˜è®¤å€¼æ˜¯utf-8ï¼›
    standalone: è¯¥å±æ€§ä¸æ˜¯å¿…é¡»çš„ï¼Œæè¿°XMLæ–‡ä»¶æ˜¯å¦ä¾èµ–å…¶ä»–çš„xmlæ–‡ä»¶ï¼Œå–å€¼ä¸ºyes/no
  
* **å…ƒç´ **        
  
  * æ ¼å¼1:`<person></person> ` 
    æ ¼å¼2:`<person/>`
    æ™®é€šå…ƒç´ çš„ç»“æ„ç”±å¼€å§‹æ ‡ç­¾ã€å…ƒç´ ä½“ã€ç»“æŸæ ‡ç­¾ç»„æˆ;
    æ ‡ç­¾ç”±ä¸€å¯¹å°–æ‹¬å·å’Œåˆæ³•æ ‡è¯†ç¬¦ç»„æˆï¼Œæ ‡ç­¾å¿…é¡»æˆå¯¹å‡ºç°ã€‚ç‰¹æ®Šçš„æ ‡ç­¾å¯ä»¥ä¸æˆå¯¹,å¿…é¡»æœ‰ç»“æŸæ ‡è®°</>;
  
* å…ƒç´ ä½“ï¼šå¯ä»¥æ˜¯å…ƒç´ ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼š``<person><name>å¼ ä¸‰</name></person>``
  * ç©ºå…ƒç´ ï¼šç©ºå…ƒç´ åªæœ‰æ ‡ç­¾ï¼Œè€Œæ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼Œä½†**å…ƒç´ å¿…é¡»è‡ªå·±é—­åˆ**ï¼Œä¾‹å¦‚ï¼š``<sex/>``
  * å…ƒç´ å‘½åï¼šåŒºåˆ†å¤§å°å†™ã€ä¸èƒ½ä½¿ç”¨ç©ºæ ¼å†’å·ã€ä¸å»ºè®®ç”¨XML xml Xmlç­‰å¼€å¤´
  * å¿…é¡»å­˜åœ¨ä¸€ä¸ªæ ¹æ ‡ç­¾ï¼Œæœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ª
  
* **å±æ€§**
  `<name id="1" desc="é«˜å¯Œå¸…">`
  å±æ€§æ˜¯å…ƒç´ çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¿…é¡»å‡ºç°åœ¨å…ƒç´ çš„å¼€å§‹æ ‡ç­¾ä¸­
  å±æ€§çš„å®šä¹‰æ ¼å¼ï¼š`å±æ€§å=â€œå±æ€§å€¼â€`ï¼Œå…¶ä¸­å±æ€§å€¼å¿…é¡»ä½¿ç”¨å•å¼•æˆ–åŒå¼•å·æ‹¬èµ·æ¥
  ä¸€ä¸ªå…ƒç´ å¯ä»¥æœ‰0~Nä¸ªå±æ€§ï¼Œä½†ä¸€ä¸ªå…ƒç´ ä¸­ä¸èƒ½å‡ºç°åŒåå±æ€§
  å±æ€§åä¸èƒ½ä½¿ç”¨ç©ºæ ¼ , ä¸è¦ä½¿ç”¨å†’å·ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œä¸”å¿…é¡»ä»¥å­—æ¯å¼€å¤´

* **æ³¨é‡Š**
  <!--æ³¨é‡Šå†…å®¹-->
  XMLçš„æ³¨é‡Šä¸HTMLç›¸åŒï¼Œæ—¢ä»¥``<!--``å¼€å§‹ï¼Œ``-->``ç»“æŸã€‚

* **è½¬ä¹‰å­—ç¬¦**
  XMLä¸­çš„è½¬ä¹‰å­—ç¬¦ä¸HTMLä¸€æ ·ã€‚å› ä¸ºå¾ˆå¤šç¬¦å·å·²ç»è¢«æ–‡æ¡£ç»“æ„æ‰€ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨å…ƒç´ ä½“æˆ–å±æ€§å€¼ä¸­æƒ³ä½¿ç”¨è¿™äº›ç¬¦å·å°±å¿…é¡»ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ï¼ˆä¹Ÿå«å®ä½“å­—ç¬¦ï¼‰ï¼Œä¾‹å¦‚ï¼š">"ã€"<"ã€"'"ã€"""ã€"&"ã€‚
  XML ä¸­ä»…æœ‰å­—ç¬¦ "<"å’Œ"&" æ˜¯éæ³•çš„ã€‚çœç•¥å·ã€å¼•å·å’Œå¤§äºå·æ˜¯åˆæ³•çš„ï¼ŒæŠŠå®ƒä»¬æ›¿æ¢ä¸ºå®ä½“å¼•ç”¨

  | å­—ç¬¦ | é¢„å®šä¹‰çš„è½¬ä¹‰å­—ç¬¦ |  è¯´æ˜  |
  | :--: | :--------------: | :----: |
  |  <   |     ``&lt;``     |  å°äº  |
  |  >   |    `` &gt;``     |  å¤§äº  |
  |  "   |   `` &quot;``    | åŒå¼•å· |
  |  '   |   `` &apos;``    | å•å¼•å· |
  |  &   |    `` &amp;``    |  å’Œå·  |

* **å­—ç¬¦åŒº**

  ```xml
  <![CDATA[
  	æ–‡æœ¬æ•°æ®
  ]]>
  ```
  
  * CDATA æŒ‡çš„æ˜¯ä¸åº”ç”± XML è§£æå™¨è¿›è¡Œè§£æçš„æ–‡æœ¬æ•°æ®ï¼ˆUnparsed Character Dataï¼‰
* CDATA éƒ¨åˆ†ç”± "<![CDATA[" å¼€å§‹ï¼Œç”± "]]>" ç»“æŸï¼›
  * å¤§é‡çš„è½¬ä¹‰å­—ç¬¦åœ¨xmlæ–‡æ¡£ä¸­æ—¶ï¼Œä¼šä½¿XMLæ–‡æ¡£çš„å¯è¯»æ€§å¤§å¹…åº¦é™ä½ã€‚è¿™æ—¶ä½¿ç”¨CDATAæ®µå°±ä¼šå¥½ä¸€äº›
  
  * è§„åˆ™
         CDATA éƒ¨åˆ†ä¸èƒ½åŒ…å«å­—ç¬¦ä¸² "]]>"ã€‚ä¹Ÿä¸å…è®¸åµŒå¥—çš„ CDATA éƒ¨åˆ†ã€‚
         æ ‡è®° CDATA éƒ¨åˆ†ç»“å°¾çš„ "]]>" ä¸èƒ½åŒ…å«ç©ºæ ¼æˆ–æŠ˜è¡Œã€‚
  
  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <?xml-stylesheet type="text/css" href="../css/xml.css" ?>
  <!-- 7.å¤„ç†æŒ‡ä»¤ï¼šå¯¼å…¥å¤–éƒ¨çš„cssæ ·å¼æ§åˆ¶xmlçš„ç•Œé¢æ•ˆæœï¼Œæ²¡æœ‰å•¥ç”¨ï¼Œxmlä¸æ˜¯ä¸ºäº†å±•ç¤ºå¥½çœ‹çš„ï¼-->
  <!-- 1.ç”³æ˜ æŠ¬å¤´ å¿…é¡»åœ¨ç¬¬ä¸€è¡Œ-->
  <!-- 2.æ³¨é‡Šï¼Œæœ¬å¤„å°±æ˜¯æ³¨é‡Šï¼Œå¿…é¡»ç”¨å‰åå°–æ‹¬å·å›´èµ·æ¥ -->
  <!-- 3.æ ‡ç­¾ï¼ˆå…ƒç´ ï¼‰ï¼Œæ³¨æ„ä¸€ä¸ªXMLæ–‡ä»¶åªèƒ½æœ‰ä¸€ä¸ªæ ¹æ ‡ç­¾-->
  <student>
      <!-- 4.å±æ€§ä¿¡æ¯ï¼šid , desc-->
      <name id="1" desc="é«˜å¯Œå¸…">è¥¿é—¨åº†</name>
      <age>32</age>
      <!-- 5.å®ä½“å­—ç¬¦ï¼šåœ¨xmlæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å†™å°äºå·ï¼Œç­‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦
          ä¼šä¸xmlæ–‡ä»¶æœ¬èº«çš„å†…å®¹å†²çªæŠ¥é”™ï¼Œæ­¤æ—¶å¿…é¡»ç”¨è½¬ä¹‰çš„å®ä½“å­—ç¬¦ã€‚
      -->
      <sql>
         <!-- select * from student where age < 18 && age > 10; -->
          select * from student where age &lt; 18 &amp;&amp; age &gt; 10;
      </sql>
      <!-- 6.å­—ç¬¦æ•°æ®åŒºï¼šåœ¨xmlæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å†™å°äºå·ï¼Œç­‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦
          ä¼šä¸xmlæ–‡ä»¶æœ¬èº«çš„å†…å®¹å†²çªæŠ¥é”™ï¼Œæ­¤æ—¶å¿…é¡»ç”¨è½¬ä¹‰çš„å®ä½“å­—ç¬¦
          æˆ–è€…ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨å­—ç¬¦æ•°æ®åŒºï¼Œé‡Œé¢çš„å†…å®¹å¯ä»¥éšä¾¿äº†ï¼
          -->
      <sql2>
          <![CDATA[
               select * from student where age < 18 && age > 10;
          ]]>
      </sql2>
  </student>
  ```
  
  

****



### çº¦æŸ

#### DTD

##### DTDå®šä¹‰

DTD æ˜¯æ–‡æ¡£ç±»å‹å®šä¹‰ï¼ˆDocument Type Definitionï¼‰ã€‚DTD å¯ä»¥å®šä¹‰åœ¨ XML æ–‡æ¡£ä¸­å‡ºç°çš„å…ƒç´ ã€è¿™äº›å…ƒç´ å‡ºç°çš„æ¬¡åºã€å®ƒä»¬å¦‚ä½•ç›¸äº’åµŒå¥—ä»¥åŠXMLæ–‡æ¡£ç»“æ„çš„å…¶å®ƒè¯¦ç»†ä¿¡æ¯ã€‚

##### DTDè§„åˆ™

* çº¦æŸå…ƒç´ çš„åµŒå¥—å±‚çº§

  ```dtd
  <!ELEMENT çˆ¶æ ‡ç­¾ ï¼ˆå­æ ‡ç­¾1ï¼Œå­æ ‡ç­¾2ï¼Œâ€¦ï¼‰>
  ```

* çº¦æŸå…ƒç´ ä½“é‡Œé¢çš„æ•°æ®
  
* è¯­æ³•
  
     ```dtd
     <!ELEMENT æ ‡ç­¾åå­— æ ‡ç­¾ç±»å‹>
  ```
  
* åˆ¤æ–­å…ƒç´ 
           ç®€å•å…ƒç´ ï¼šæ²¡æœ‰å­å…ƒç´ ã€‚
           å¤æ‚å…ƒç´ ï¼šæœ‰å­å…ƒç´ çš„å…ƒç´ ï¼›
   
   * æ ‡ç­¾ç±»å‹
   
  | æ ‡ç­¾ç±»å‹ | ä»£ç å†™æ³•  | è¯´æ˜                 |
  | -------- | --------- | -------------------- |
  | PCDATA   | (#PCDATA) | è¢«è§£é‡Šçš„å­—ç¬¦ä¸²æ•°æ®   |
  | EMPTY    | EMPTY     | å³ç©ºå…ƒç´ ï¼Œä¾‹å¦‚\<hr/> |
  | ANY      | ANY       | å³ä»»æ„ç±»å‹           |
  
   * ä»£ç 
  
     ```dtd
  <!ELEMENT persons (person+)>   	<!--çº¦æŸäººä»¬è‡³å°‘ä¸€ä¸ªäºº-->
     <!ELEMENT person (name,age)>	<!--çº¦æŸå…ƒç´ äººçš„å­å…ƒç´ å¿…é¡»ä¸ºå§“åã€å¹´é¾„ï¼Œå¹¶ä¸”æŒ‰é¡ºåº-->
     <!ELEMENT name (#PCDATA)>		<!--"å§“å"å…ƒç´ ä½“ä¸ºå­—ç¬¦ä¸²æ•°æ®-->
     <!ELEMENT age ANY>       		<!--"å¹´é¾„"å…ƒç´ ä½“ä¸ºä»»æ„ç±»å‹-->
     ```
  
   * æ•°é‡è¯
  
     | æ•°é‡è¯ç¬¦å· | å«ä¹‰                         |
     | ---------- | ---------------------------- |
     | ç©º         | è¡¨ç¤ºå…ƒç´ å‡ºç°ä¸€æ¬¡             |
     | *          | è¡¨ç¤ºå…ƒç´ å¯ä»¥å‡ºç°0åˆ°å¤šä¸ª      |
     | +          | è¡¨ç¤ºå…ƒç´ å¯ä»¥å‡ºç°è‡³å°‘1ä¸ª      |
     | ?          | è¡¨ç¤ºå…ƒç´ å¯ä»¥æ˜¯0æˆ–1ä¸ª         |
     | ,          | è¡¨ç¤ºå…ƒç´ éœ€è¦æŒ‰ç…§é¡ºåºæ˜¾ç¤º     |
     | \|         | è¡¨ç¤ºå…ƒç´ éœ€è¦é€‰æ‹©å…¶ä¸­çš„æŸä¸€ä¸ª |
  
     
  
* å±æ€§å£°æ˜

   * è¯­æ³•

     ```dtd
     <!ATTLIST æ ‡ç­¾åç§° 
     		å±æ€§åç§°1 å±æ€§ç±»å‹1 å±æ€§è¯´æ˜1
     		å±æ€§åç§°2 å±æ€§ç±»å‹2 å±æ€§è¯´æ˜2
     		â€¦
     >
     ```

   * å±æ€§ç±»å‹

     | å±æ€§ç±»å‹   | å«ä¹‰                                                         |
     | ---------- | ------------------------------------------------------------ |
     | CDATA      | ä»£è¡¨å±æ€§æ˜¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œ eg:<!ATTLIST å±æ€§å CDATA å±æ€§è¯´æ˜>   |
     | ID         | ä»£ç è¯¥å±æ€§å€¼å”¯ä¸€ï¼Œä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œ eg:<!ATTLIST å±æ€§å ID å±æ€§è¯´æ˜> |
     | ENUMERATED | ä»£è¡¨å±æ€§å€¼åœ¨æŒ‡å®šèŒƒå›´å†…è¿›è¡Œæšä¸¾ Eg:<!ATTLISTå±æ€§å (ç¤¾ç§‘ç±»\|å·¥ç¨‹ç±»\|æ•™è‚²ç±») "ç¤¾ç§‘ç±»"> "ç¤¾ç§‘ç±»"æ˜¯é»˜è®¤å€¼ï¼Œå±æ€§å¦‚æœä¸è®¾ç½®é»˜è®¤å€¼å°±æ˜¯"ç¤¾ç§‘ç±»" |

   * å±æ€§è¯´æ˜

     | å±æ€§è¯´æ˜  | å«ä¹‰                                                        |
     | --------- | ----------------------------------------------------------- |
     | #REQUIRED | ä»£è¡¨å±æ€§æ˜¯å¿…é¡»æœ‰çš„                                          |
     | #IMPLIED  | ä»£è¡¨å±æ€§å¯æœ‰å¯æ—                                             |
     | #FIXED    | ä»£è¡¨å±æ€§ä¸ºå›ºå®šå€¼ï¼Œå®ç°æ–¹å¼ï¼šbook_info CDATA #FIXED "å›ºå®šå€¼" |

   * ä»£ç 

     ```dtd
     <!ATTLIST ä¹¦									<!--è®¾ç½®"ä¹¦"å…ƒç´ çš„çš„å±æ€§åˆ—è¡¨-->
     	id ID #REQUIRED						 <!--"id"å±æ€§å€¼ä¸ºå¿…é¡»æœ‰-->
     	ç¼–å· CDATA #IMPLIED				    <!--"ç¼–å·"å±æ€§å¯æœ‰å¯æ— -->
     	å‡ºç‰ˆç¤¾ (æ¸…å|åŒ—å¤§|ä¼ æ™ºæ’­å®¢) "ä¼ æ™ºæ’­å®¢" <!--"å‡ºç‰ˆç¤¾"å±æ€§å€¼æ˜¯æšä¸¾å€¼ï¼Œé»˜è®¤ä¸ºâ€œä¼ æ™ºæ’­å®¢â€-->
     	type CDATA #FIXED "IT"            <!--"type"å±æ€§ä¸ºæ–‡æœ¬å­—ç¬¦ä¸²å¹¶ä¸”å›ºå®šå€¼ä¸º"IT"-->
     >
     <!ATTLIST person id CDATA #REQUIRED>  <!--idæ˜¯æ–‡æœ¬å­—ç¬¦ä¸²å¿…é¡»æœ‰-->
     ```
   
     



##### DTDå¼•å…¥

* å¼•å…¥æœ¬åœ°dtd

  ```dtd
  <!DOCTYPE æ ¹å…ƒç´ åç§° SYSTEM â€˜DTDæ–‡ä»¶çš„è·¯å¾„'>
  ```

* åœ¨xmlæ–‡ä»¶å†…éƒ¨å¼•å…¥

  ```dtd
  <!DOCTYPE æ ¹å…ƒç´ åç§° [ dtdæ–‡ä»¶å†…å®¹ ]>
  ```

* å¼•å…¥ç½‘ç»œdtd

  ```dtd
  <!DOCTYPE æ ¹å…ƒç´ çš„åç§° PUBLIC "DTDæ–‡ä»¶åç§°" "DTDæ–‡æ¡£çš„URL">
  ```

```dtd
<!--è¿™æ˜¯persondtd.dtdæ–‡ä»¶ä¸­çš„å†…å®¹,å·²ç»æå‰å†™å¥½-->
<!ELEMENT persons (person)>
<!ELEMENT person (name,age)>
<!ELEMENT name (#PCDATA)>
<!ELEMENT age (#PCDATA)>
```

```xml
<!--å¼•å…¥æœ¬åœ°DTD-->
<!DOCTYPE persons SYSTEM 'persondtd.dtd'>
<persons>
    <person>
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>

</persons>
```

```xml-dtd
<!--å†…éƒ¨å¼•å…¥DTD-->
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE persons [
        <!ELEMENT persons (person)>
        <!ELEMENT person (name,age)>
        <!ELEMENT name (#PCDATA)>
        <!ELEMENT age (#PCDATA)>
        ]>

<persons>
    <person>
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>
</persons>
```

```dtd
<!--å¼•å…¥ç½‘ç»œDTD--><?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE persons PUBLIC "dtdæ–‡ä»¶çš„åç§°" "dtdæ–‡æ¡£çš„URL">

<persons>
    <person>
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>
</persons>
```



##### DTDå®ç°

persondtd.dtdæ–‡ä»¶

```dtd
<!ELEMENT persons (person+)>   	<!--çº¦æŸäººä»¬è‡³å°‘ä¸€ä¸ªäºº-->
<!ELEMENT person (name,age)>	<!--çº¦æŸå…ƒç´ äººçš„å­å…ƒç´ å¿…é¡»ä¸ºå§“åã€å¹´é¾„ï¼Œå¹¶ä¸”æŒ‰é¡ºåº-->
<!ELEMENT name (#PCDATA)>		<!--"å§“å"å…ƒç´ ä½“ä¸ºå­—ç¬¦ä¸²æ•°æ®-->
<!ELEMENT age ANY>       		<!--"å¹´é¾„"å…ƒç´ ä½“ä¸ºä»»æ„ç±»å‹-->
<!ATTLIST person id CDATA #REQUIRED>  <!--idæ˜¯æ–‡æœ¬å­—ç¬¦ä¸²å¿…é¡»æœ‰-->
```

```xml-dtd
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE persons SYSTEM 'persondtd.dtd'>

<persons>
    <person id="001">
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>

    <person id = "002">
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>
</persons>
```



***



#### Schema

##### XSDå®šä¹‰

1.Schema è¯­è¨€ä¹Ÿå¯ä½œä¸º XSDï¼ˆXML Schema Definitionï¼‰
2.schema çº¦æŸæ–‡ä»¶æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª xml æ–‡ä»¶ï¼Œç¬¦åˆ xml çš„è¯­æ³•ï¼Œè¿™ä¸ªæ–‡ä»¶çš„åç¼€å.xsd
3.ä¸€ä¸ª xml ä¸­å¯ä»¥å¼•ç”¨å¤šä¸ª schema çº¦æŸæ–‡ä»¶ï¼Œå¤šä¸ª schema ä½¿ç”¨åç§°ç©ºé—´åŒºåˆ†ï¼ˆåç§°ç©ºé—´ç±»ä¼¼äºjavaåŒ…åï¼‰
4.dtd é‡Œé¢å…ƒç´ ç±»å‹çš„å–å€¼æ¯”è¾ƒå•ä¸€å¸¸è§çš„æ˜¯ PCDATA ç±»å‹ï¼Œä½†æ˜¯åœ¨ schema é‡Œé¢å¯ä»¥æ”¯æŒå¾ˆå¤šä¸ªæ•°æ®ç±»å‹
**5.Schema æ–‡ä»¶çº¦æŸ xml æ–‡ä»¶çš„åŒæ—¶ä¹Ÿè¢«åˆ«çš„æ–‡ä»¶çº¦æŸç€**



##### XSDè§„åˆ™

1ã€åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„åç¼€åä¸º.xsdã€‚
2ã€å®šä¹‰æ–‡æ¡£å£°æ˜
3ã€schemaæ–‡ä»¶çš„æ ¹æ ‡ç­¾ä¸ºï¼š <schema>
4ã€åœ¨<schema>ä¸­å®šä¹‰å±æ€§ï¼š
	  xmlns=http://www.w3.org/2001/XMLSchema
	  ä»£è¡¨å½“å‰æ–‡ä»¶æ—¶çº¦æŸåˆ«äººçš„ï¼ŒåŒæ—¶è¿™ä¸ªæ–‡ä»¶ä¹Ÿå¯¹è¯¥Schemaè¿›è¡Œçº¦æŸ
5ã€åœ¨<schema>ä¸­å®šä¹‰å±æ€§ ï¼š
	  targetNamespace = å”¯ä¸€çš„urlåœ°å€ï¼ŒæŒ‡å®šå½“å‰è¿™ä¸ªschemaæ–‡ä»¶çš„åç§°ç©ºé—´ã€‚
	  **åç§°ç©ºé—´**ï¼šå½“å…¶ä»–xmlä½¿ç”¨è¯¥schemaæ–‡ä»¶ï¼Œéœ€è¦å¼•å…¥æ­¤ç©ºé—´
6ã€åœ¨<schema>ä¸­å®šä¹‰å±æ€§ ï¼š
	  elementFormDefault="qualifiedâ€œï¼Œè¡¨ç¤ºå½“å‰schemaæ–‡ä»¶æ˜¯ä¸€ä¸ªè´¨é‡è‰¯å¥½çš„æ–‡ä»¶ã€‚
7ã€é€šè¿‡elementå®šä¹‰å…ƒç´ 
8ã€**åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯ç®€å•å…ƒç´ è¿˜æ˜¯å¤æ‚å…ƒç´ **

person.xsd

```scheme
<?xml version="1.0" encoding="UTF-8" ?>
<schema
    xmlns="http://www.w3.org/2001/XMLSchema"     <!--æœ¬æ–‡ä»¶æ˜¯çº¦æŸåˆ«äººçš„ï¼Œä¹Ÿè¢«çº¦æŸ-->
    targetNamespace="http://www.seazean.cn/javase"<!--è‡ªå·±çš„åç§°ç©ºé—´-->
    elementFormDefault="qualified"				  <!--æœ¬æ–‡ä»¶æ˜¯è´¨é‡å¥½çš„-->
>

    <element name="persons">    		  <!--å®šä¹‰personså¤æ‚å…ƒç´ -->
        <complexType>           		  <!--å¤æ‚çš„å…ƒç´ -->
            <sequence>					  <!--é‡Œé¢çš„å…ƒç´ å¿…é¡»æŒ‰ç…§é¡ºåºå®šä¹‰-->
                <element name = "person"> <!--å®šä¹‰personå¤æ‚å…ƒç´ -->
                    <complexType>
                        <sequence>
                            <!--å®šä¹‰nameå’Œageç®€å•å…ƒç´ -->
                            <element name = "name" type = "string"></element>
                            <element name = "age" type = "string"></element>
                        </sequence>
                    </complexType>
                </element>
            </sequence>
        </complexType>
    </element>
    
</schema>
```



##### XSDå¼•å…¥

1ã€åœ¨æ ¹æ ‡ç­¾ä¸Šå®šä¹‰å±æ€§xmlns="http://www.w3.org/2001/XMLSchema-instance"
2ã€**é€šè¿‡xmlnså¼•å…¥çº¦æŸæ–‡ä»¶çš„åç§°ç©ºé—´**
3ã€ç»™æŸä¸€ä¸ªxmlnså±æ€§æ·»åŠ ä¸€ä¸ªæ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åç§°ç©ºé—´
	  æ ¼å¼ä¸º: xmlns:æ ‡è¯†=â€œåç§°ç©ºé—´urlâ€ ,æ ‡è¯†å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œä½†æ˜¯ä¸€èˆ¬å–å€¼éƒ½æ˜¯xsi
4ã€é€šè¿‡xsi:schemaLocationæŒ‡å®šåç§°ç©ºé—´æ‰€å¯¹åº”çš„çº¦æŸæ–‡ä»¶è·¯å¾„
	  æ ¼å¼ä¸º: xsi:schemaLocation = "åç§°ç©ºé—´url æ–‡ä»¶è·¯å¾„â€œ

```scheme
<?xml version="1.0" encoding="UTF-8" ?>
<persons
	xmlms:xis="http://www.w3.org/2001/XMLSchema-instance" <!--è¢«åˆ«äººçº¦æŸ-->
    xmlns="http://www.seazean.cn/javase"                  <!--çº¦æŸæ–‡ä»¶çš„åç§°ç©ºé—´-->
    xsi:schemaLocation="http://www.seazean.cn/javase person.xsd"
>

 <person>
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>

</persons>
```



##### XSDå±æ€§

```scheme
<?xml version="1.0" encoding="UTF-8" ?>
<schema
    xmlns="http://www.w3.org/2001/XMLSchema"
    targetNamespace="http://www.seazean.cn/javase"
    elementFormDefault="qualified"
>

    <!--å®šä¹‰personså¤æ‚å…ƒç´ -->
    <element name="persons">
        <complexType>
            <sequence>
                <!--å®šä¹‰personå¤æ‚å…ƒç´ -->
                <element name = "person">
                    <complexType>
                        <sequence>
                            <!--å®šä¹‰nameå’Œageç®€å•å…ƒç´ -->
                            <element name = "name" type = "string"></element>
                            <element name = "age" type = "string"></element>
                        </sequence>
                        <!--å®šä¹‰çš„ä½ç½®æ˜¯sequenceçš„å¤–é¢ï¼ŒcomplexTypeçš„é‡Œé¢-->
                        <!--å®šä¹‰å±æ€§ï¼Œrequired( å¿…é¡»çš„)/optional( å¯é€‰çš„)-->
                        <attribute name="id" type="string" use="required">		
						</attribute>
                    </complexType>
                    
                </element>
            </sequence>
        </complexType>
    </element>
    
</schema>

<?xml version="1.0" encoding="UTF-8" ?>
<persons
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.seazean.cn/javase"
    xsi:schemaLocation="http://www.seazean.cn/javase person.xsd"
>
    <person id="001">
        <name>å¼ ä¸‰</name>
        <age>23</age>
    </person>

</persons>
```



***



### Dom4J

#### è§£æ

xml è§£æå°±æ˜¯ä» xml ä¸­è·å–åˆ°æ•°æ®ï¼ŒDOM æ˜¯è§£ææ€æƒ³

DOM(Document Object Model)ï¼šæ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ŒæŠŠæ–‡æ¡£çš„å„ä¸ªç»„æˆéƒ¨åˆ†çœ‹åšæˆå¯¹åº”çš„å¯¹è±¡ï¼ŒæŠŠ xml æ–‡ä»¶å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ï¼Œåœ¨å†…å­˜ä¸­å½¢æˆä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œå†è·å–å¯¹åº”çš„å€¼

dom4j å®ç°
* dom4j è§£æå™¨æ„é€ æ–¹æ³•ï¼š`SAXReader saxReader = new SAXReader();`

* SAXReader å¸¸ç”¨APIï¼š

  `public Document read(File file)` : Reads a Document from the given File
  `public Document read(InputStream in)` : Reads a Document from the given stream using SAX

* Java Class ç±»APIï¼š
  
  `public InputStream getResourceAsStream(String path)`ï¼šåŠ è½½æ–‡ä»¶æˆä¸ºä¸€ä¸ªå­—èŠ‚è¾“å…¥æµè¿”å›



****



#### æ ¹å…ƒç´ 

Document æ–¹æ³•ï¼šElement getRootElement() è·å–æ ¹å…ƒç´ ã€‚

```java
// éœ€æ±‚ï¼šè§£æbooks.xmlæ–‡ä»¶æˆä¸ºä¸€ä¸ªDocumentæ–‡æ¡£æ ‘å¯¹è±¡ï¼Œå¾—åˆ°æ ¹å…ƒç´ å¯¹è±¡ã€‚
public class Dom4JDemo {
    public static void main(String[] args) throws Exception {
        // 1.åˆ›å»ºä¸€ä¸ªdom4jçš„è§£æå™¨å¯¹è±¡ï¼šä»£è¡¨æ•´ä¸ªdom4jæ¡†æ¶ã€‚
        SAXReader saxReader = new SAXReader();
        // 2.ç¬¬ä¸€ç§æ–¹å¼ï¼ˆç®€å•ï¼‰ï¼šé€šè¿‡è§£æå™¨å¯¹è±¡å»åŠ è½½xmlæ–‡ä»¶æ•°æ®ï¼Œæˆä¸ºä¸€ä¸ªDocumentæ–‡æ¡£æ ‘å¯¹è±¡ã€‚
        //Document document = saxReader.read(new File("Day13Demo/src/books.xml"));
        
        // 3.ç¬¬äºŒç§æ–¹å¼ï¼ˆä»£ç å¤šç‚¹ï¼‰å…ˆæŠŠxmlæ–‡ä»¶è¯»æˆä¸€ä¸ªå­—èŠ‚è¾“å…¥æµ
        // è¿™é‡Œçš„â€œ/â€æ˜¯ç›´æ¥å»srcç±»è·¯å¾„ä¸‹å¯»æ‰¾æ–‡ä»¶ã€‚
        InputStream is = Dom4JDemo01.class.getResourceAsStream("/books.xml");
        Document document = saxReader.read(is);
        System.out.println(document);
		//org.dom4j.tree.DefaultDocument@27a5f880 [Document: name null]
		// 4.ä»documentæ–‡æ¡£æ ‘å¯¹è±¡ä¸­æå–æ ¹å…ƒç´ å¯¹è±¡
        Element root = document.getRootElement();
        System.out.println(root.getName());//books
    }
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<books>
    <book id="0001" desc="ç¬¬ä¸€æœ¬ä¹¦">
        <name>  JavaWebå¼€å‘æ•™ç¨‹</name>
        <author>    å¼ å­ç¥¥</author>
        <sale>100.00å…ƒ   </sale>
    </book>
    <book id="0002">
        <name>ä¸‰å›½æ¼”ä¹‰</name>
        <author>ç½—è´¯ä¸­</author>
        <sale>100.00å…ƒ</sale>
    </book>
    <user>
    </user>
</books>

```



#### å­å…ƒç´ 

Element å…ƒç´ çš„ API:

* String getName()ï¼šå–å…ƒç´ çš„åç§°ã€‚
* List<Element> elements()ï¼šè·å–å½“å‰å…ƒç´ ä¸‹çš„å…¨éƒ¨å­å…ƒç´ ï¼ˆä¸€çº§ï¼‰
* List<Element> elements(String name)ï¼šè·å–å½“å‰å…ƒç´ ä¸‹çš„æŒ‡å®šåç§°çš„å…¨éƒ¨å­å…ƒç´ ï¼ˆä¸€çº§ï¼‰
* Element element(String name)ï¼šè·å–å½“å‰å…ƒç´ ä¸‹çš„æŒ‡å®šåç§°çš„æŸä¸ªå­å…ƒç´ ï¼Œé»˜è®¤å–ç¬¬ä¸€ä¸ªï¼ˆä¸€çº§ï¼‰

```java
public class Dom4JDemo {
    public static void main(String[] args) throws Exception {
        SAXReader saxReader = new SAXReader();
        Document document = saxReader.read(new File("Day13Demo/src/books.xml"));
        // 3.è·å–æ ¹å…ƒç´ å¯¹è±¡
        Element root = document.getRootElement();
        System.out.println(root.getName());

        // 4.è·å–æ ¹å…ƒç´ ä¸‹çš„å…¨éƒ¨å­å…ƒç´ 
        List<Element> sonElements = root.elements();
        for (Element sonElement : sonElements) {
            System.out.println(sonElement.getName());
        }
        // 5.è·å–æ ¹æºä¸‹çš„å…¨éƒ¨bookå­å…ƒç´ 
        List<Element> sonElements1 = root.elements("book");
        for (Element sonElement : sonElements1) {
            System.out.println(sonElement.getName());
        }
        
        // 6.è·å–æ ¹æºä¸‹çš„æŒ‡å®šçš„æŸä¸ªå…ƒç´ 
        Element son = root.element("user");
        System.out.println(son.getName());
        // é»˜è®¤ä¼šæå–ç¬¬ä¸€ä¸ªåç§°ä¸€æ ·çš„å­å…ƒç´ å¯¹è±¡è¿”å›ï¼
        Element son1 = root.element("book");
        System.out.println(son1.attributeValue("id"));
    }
}

```



***



#### å±æ€§

Element å…ƒç´ çš„ APIï¼š

* List<Attribute> attributes()ï¼šè·å–å…ƒç´ çš„å…¨éƒ¨å±æ€§å¯¹è±¡ã€‚
* Attribute attribute(String name)ï¼šæ ¹æ®åç§°è·å–æŸä¸ªå…ƒç´ çš„å±æ€§å¯¹è±¡ã€‚
* String attributeValue(String var)ï¼šç›´æ¥è·å–æŸä¸ªå…ƒç´ çš„æŸä¸ªå±æ€§åç§°çš„å€¼ã€‚

Attribute å¯¹è±¡çš„APIï¼š

* String getName()ï¼šè·å–å±æ€§åç§°ã€‚
* String getValue()ï¼šè·å–å±æ€§å€¼ã€‚

```java
public class Dom4JDemo {
    public static void main(String[] args) throws Exception {
        SAXReader saxReader = new SAXReader();
        Document document = saxReader.read(new File("Day13Demo/src/books.xml"));
        Element root = document.getRootElement();
        // 4.è·å–bookå­å…ƒç´ 
        Element bookEle = root.element("book");

        // 5.è·å–bookå…ƒç´ çš„å…¨éƒ¨å±æ€§å¯¹è±¡
        List<Attribute> attributes = bookEle.attributes();
        for (Attribute attribute : attributes) {
            System.out.println(attribute.getName()+"->"+attribute.getValue());
        }

        // 6.è·å–Bookå…ƒç´ çš„æŸä¸ªå±æ€§å¯¹è±¡
        Attribute descAttr = bookEle.attribute("desc");
        System.out.println(descAttr.getName()+"->"+descAttr.getValue());

        // 7.å¯ä»¥ç›´æ¥è·å–å…ƒç´ çš„å±æ€§å€¼
        System.out.println(bookEle.attributeValue("id"));
        System.out.println(bookEle.attributeValue("desc"));
    }
}
```



***



#### æ–‡æœ¬

Elementï¼š

* String elementText(String name)ï¼šå¯ä»¥ç›´æ¥è·å–å½“å‰å…ƒç´ çš„å­å…ƒç´ çš„æ–‡æœ¬å†…å®¹
* String elementTextTrim(String name)ï¼šå»å‰åç©ºæ ¼,ç›´æ¥è·å–å½“å‰å…ƒç´ çš„å­å…ƒç´ çš„æ–‡æœ¬å†…å®¹
* String getText()ï¼šç›´æ¥è·å–å½“å‰å…ƒç´ çš„æ–‡æœ¬å†…å®¹ã€‚
* String getTextTrim()ï¼šå»å‰åç©ºæ ¼,ç›´æ¥è·å–å½“å‰å…ƒç´ çš„æ–‡æœ¬å†…å®¹ã€‚

```java
public class Dom4JDemo {
    public static void main(String[] args) throws Exception {
        SAXReader saxReader = new SAXReader();
        Document document = saxReader.read(new File("Day13Demo/src/books.xml"));
        Element root = document.getRootElement();
        // 4.å¾—åˆ°ç¬¬ä¸€ä¸ªå­å…ƒç´ book
        Element bookEle = root.element("book");

        // 5.ç›´æ¥æ‹¿åˆ°å½“å‰bookå…ƒç´ ä¸‹çš„å­å…ƒç´ æ–‡æœ¬å€¼
        System.out.println(bookEle.elementText("name"));
        System.out.println(bookEle.elementTextTrim("name")); // å»å‰åç©ºæ ¼
        System.out.println(bookEle.elementText("author"));
        System.out.println(bookEle.elementTextTrim("author")); // å»å‰åç©ºæ ¼
        System.out.println(bookEle.elementText("sale"));
        System.out.println(bookEle.elementTextTrim("sale")); // å»å‰åç©ºæ ¼

        // 6.å…ˆè·å–åˆ°å­å…ƒç´ å¯¹è±¡ï¼Œå†è·å–è¯¥æ–‡æœ¬å€¼
        Element bookNameEle = bookEle.element("name");
        System.out.println(bookNameEle.getText());
        System.out.println(bookNameEle.getTextTrim());// å»å‰åç©ºæ ¼
    }
}
```





****



### XPath

Dom4J å¯ä»¥ç”¨äºè§£ææ•´ä¸ª XML çš„æ•°æ®ï¼Œä½†æ˜¯å¦‚æœè¦æ£€ç´¢ XML ä¸­çš„æŸäº›ä¿¡æ¯ï¼Œå»ºè®®ä½¿ç”¨ XPath

XPathå¸¸ç”¨APIï¼š

* List<Node> selectNodes(String var1) : æ£€ç´¢å‡ºä¸€æ‰¹èŠ‚ç‚¹é›†åˆ
* Node selectSingleNode(String var1) : æ£€ç´¢å‡ºä¸€ä¸ªèŠ‚ç‚¹è¿”å›

XPathæä¾›çš„å››ç§æ£€ç´¢æ•°æ®çš„å†™æ³•ï¼š

1. ç»å¯¹è·¯å¾„ï¼š/æ ¹å…ƒç´ /å­å…ƒç´ /å­å…ƒç´ ã€‚
2. ç›¸å¯¹è·¯å¾„ï¼š./å­å…ƒç´ /å­å…ƒç´ ã€‚ (.ä»£è¡¨äº†å½“å‰å…ƒç´ )
3. å…¨æ–‡æœç´¢ï¼š
   * //å…ƒç´   åœ¨å…¨æ–‡æ‰¾è¿™ä¸ªå…ƒç´ 
   * //å…ƒç´ 1/å…ƒç´ 2  åœ¨å…¨æ–‡æ‰¾å…ƒç´ 1ä¸‹é¢çš„ä¸€çº§å…ƒç´ 2
   *  //å…ƒç´ 1//å…ƒç´ 2  åœ¨å…¨æ–‡æ‰¾å…ƒç´ 1ä¸‹é¢çš„å…¨éƒ¨å…ƒç´ 2
4. å±æ€§æŸ¥æ‰¾ã€‚
   * //@å±æ€§åç§°  åœ¨å…¨æ–‡æ£€ç´¢å±æ€§å¯¹è±¡ã€‚
   * //å…ƒç´ [@å±æ€§åç§°]  åœ¨å…¨æ–‡æ£€ç´¢åŒ…å«è¯¥å±æ€§çš„å…ƒç´ å¯¹è±¡ã€‚
   * //å…ƒç´ [@å±æ€§åç§°=å€¼]  åœ¨å…¨æ–‡æ£€ç´¢åŒ…å«è¯¥å±æ€§çš„å…ƒç´ ä¸”å±æ€§å€¼ä¸ºè¯¥å€¼çš„å…ƒç´ å¯¹è±¡ã€‚

```java
public class XPathDemo {
    public static void main(String[] args) throws Exception {
        SAXReader saxReader = new SAXReader();
        InputStream is = XPathDemo.class.getResourceAsStream("/Contact.xml");
        Document document = saxReader.read(is);
        //1.ä½¿ç”¨ç»å¯¹è·¯å¾„å®šä½å…¨éƒ¨çš„nameåç§°
        List<Node> nameNodes1 = document.selectNodes("/contactList/contact/name");
        for (Node nameNode : nameNodes) {
            System.out.println(nameNode.getText());
        }
        
        //2.ç›¸å¯¹è·¯å¾„ã€‚ä»æ ¹å…ƒç´ å¼€å§‹æ£€ç´¢ï¼Œ.ä»£è¡¨å¾ˆæ ¹å…ƒç´ 
        List<Node> nameNodes2 = root.selectNodes("./contact/name");
        
        //3.1 åœ¨å…¨æ–‡ä¸­æ£€ç´¢nameèŠ‚ç‚¹
        List<Node> nameNodes3 = root.selectNodes("//name");//å…¨éƒ¨çš„
        //3.2 åœ¨å…¨æ–‡ä¸­æ£€ç´¢æ‰€æœ‰contactä¸‹çš„æ‰€æœ‰nameèŠ‚ç‚¹  //åŒ…æ‹¬sqlï¼Œä¸å¤–é¢çš„
        List<Node> nameNodes3 = root.selectNodes("//contact//name");
        //3.3 åœ¨å…¨æ–‡ä¸­æ£€ç´¢æ‰€æœ‰contactä¸‹çš„ç›´æ¥nameèŠ‚ç‚¹
        List<Node> nameNodes3 = root.selectNodes("//contact/name");//ä¸åŒ…æ‹¬sqlå’Œå¤–é¢
        
        //4.1 æ£€ç´¢å…¨éƒ¨å±æ€§å¯¹è±¡
        List<Node> attributes1 = root.selectNodes("//@id");//åŒ…æ‹¬sql4
        //4.2 åœ¨å…¨æ–‡æ£€ç´¢åŒ…å«è¯¥å±æ€§çš„å…ƒç´ å¯¹è±¡
        List<Node> attributes1 = root.selectNodes("//contact[@id]");
        //4.3 åœ¨å…¨æ–‡æ£€ç´¢åŒ…å«è¯¥å±æ€§çš„å…ƒç´ ä¸”å±æ€§å€¼ä¸ºè¯¥å€¼çš„å…ƒç´ å¯¹è±¡
        Node nodeEle = document.selectSingleNode("//contact[@id=2]");
        Element ele = (Element)nodeEle;
        System.out.println(ele.elementTextTrim("name"));//xi
    }
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<contactList>
<contact id="1">
    <name>å°ç™½</name>
    <gender>å¥³</gender>
    <email>bai@seazean.cn</email>
</contact>
<contact id="2">
    <name>å°é»‘</name>
    <gender>ç”·</gender>
    <email>hei@seazean.cn</email>
    <sql id="sql4">
        <name>sqlè¯­å¥</name>
    </sql>
</contact>
<contact id="3">
    <name>å°è™</name>
    <gender>ç”·</gender>
    <email>hu@seazean.cn</email>
</contact>
<contact></contact>
<name>å¤–é¢çš„åç§°</name>
</contactList>
```







***





# JVM

## JVMæ¦‚è¿°

### åŸºæœ¬ä»‹ç»

JVMï¼šå…¨ç§° Java Virtual Machineï¼Œå³ Java è™šæ‹Ÿæœºï¼Œä¸€ç§è§„èŒƒï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªè™šæ‹Ÿè®¡ç®—æœºï¼Œç›´æ¥å’Œæ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œä¸ç¡¬ä»¶ä¸ç›´æ¥äº¤äº’ï¼Œè€Œæ“ä½œç³»ç»Ÿå¯ä»¥å¸®æˆ‘ä»¬å®Œæˆå’Œç¡¬ä»¶è¿›è¡Œäº¤äº’çš„å·¥ä½œ

ç‰¹ç‚¹ï¼š

* Java è™šæ‹ŸæœºåŸºäº**äºŒè¿›åˆ¶å­—èŠ‚ç **æ‰§è¡Œï¼Œç”±ä¸€å¥—å­—èŠ‚ç æŒ‡ä»¤é›†ã€ä¸€ç»„å¯„å­˜å™¨ã€ä¸€ä¸ªæ ˆã€ä¸€ä¸ªåƒåœ¾å›æ”¶å †ã€ä¸€ä¸ªæ–¹æ³•åŒºç­‰ç»„æˆ
* JVM å±è”½äº†ä¸æ“ä½œç³»ç»Ÿå¹³å°ç›¸å…³çš„ä¿¡æ¯ï¼Œä»è€Œèƒ½å¤Ÿè®© Java ç¨‹åºåªéœ€è¦ç”Ÿæˆèƒ½å¤Ÿåœ¨ JVM ä¸Šè¿è¡Œçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶å®ç°çš„**è·¨å¹³å°æ€§**

Java ä»£ç æ‰§è¡Œæµç¨‹ï¼šjavaç¨‹åº --ï¼ˆç¼–è¯‘ï¼‰--> å­—èŠ‚ç æ–‡ä»¶ --ï¼ˆè§£é‡Šæ‰§è¡Œï¼‰--> æ“ä½œç³»ç»Ÿï¼ˆWinï¼ŒLinuxï¼‰

JVM ç»“æ„ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æ¦‚è¿°å›¾.png" style="zoom: 80%;" />

JVMã€JREã€JDKå¯¹æ¯”ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-JREå…³ç³».png" style="zoom: 80%;" />



å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1PJ411n7xZ

å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1yE411Z7AP



***



### æ¶æ„æ¨¡å‹

Java ç¼–è¯‘å™¨è¾“å…¥çš„æŒ‡ä»¤æµæ˜¯ä¸€ç§åŸºäºæ ˆçš„æŒ‡ä»¤é›†æ¶æ„ã€‚å› ä¸ºè·¨å¹³å°çš„è®¾è®¡ï¼Œjava çš„æŒ‡ä»¤éƒ½æ˜¯æ ¹æ®æ ˆæ¥è®¾è®¡çš„ï¼Œä¸åŒå¹³å° CPU æ¶æ„ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½è®¾è®¡ä¸ºåŸºäºå¯„å­˜å™¨æ¶æ„

* åŸºäºæ ˆå¼æ¶æ„çš„ç‰¹ç‚¹ï¼š
  * è®¾è®¡å’Œå®ç°ç®€å•ï¼Œé€‚ç”¨äºèµ„æºå—é™çš„ç³»ç»Ÿ
  * ä½¿ç”¨é›¶åœ°å€æŒ‡ä»¤æ–¹å¼åˆ†é…ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¾èµ–æ“ä½œæ ˆï¼ŒæŒ‡ä»¤é›†æ›´å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°
    * é›¶åœ°å€æŒ‡ä»¤ï¼šæœºå™¨æŒ‡ä»¤çš„ä¸€ç§ï¼Œæ˜¯æŒ‡ä»¤ç³»ç»Ÿä¸­çš„ä¸€ç§ä¸è®¾åœ°å€å­—æ®µçš„æŒ‡ä»¤ï¼Œåªæœ‰æ“ä½œç è€Œæ²¡æœ‰åœ°å€ç ã€‚è¿™ç§æŒ‡ä»¤æœ‰ä¸¤ç§æƒ…å†µï¼šä¸€æ˜¯æ— éœ€æ“ä½œæ•°ï¼Œå¦ä¸€ç§æ˜¯æ“ä½œæ•°ä¸ºé»˜è®¤çš„ï¼ˆéšå«çš„ï¼‰ï¼Œé»˜è®¤ä¸ºæ“ä½œæ•°åœ¨å¯„å­˜å™¨ï¼ˆACCï¼‰ä¸­ï¼ŒæŒ‡ä»¤å¯ç›´æ¥è®¿é—®å¯„å­˜å™¨
    * ä¸€åœ°å€æŒ‡ä»¤ï¼šä¸€ä¸ªæ“ä½œç å¯¹åº”ä¸€ä¸ªåœ°å€ç ï¼Œé€šè¿‡åœ°å€ç å¯»æ‰¾æ“ä½œæ•°
  * ä¸éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œå¯ç§»æ¤æ€§æ›´å¥½ï¼Œæ›´å¥½å®ç°è·¨å¹³å°
* åŸºäºå¯„å­˜å™¨æ¶æ„çš„ç‰¹ç‚¹ï¼š
  * éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œå¯ç§»æ¤æ€§å·®
  * æ€§èƒ½æ›´å¥½ï¼Œæ‰§è¡Œæ›´é«˜æ•ˆï¼Œå¯„å­˜å™¨æ¯”å†…å­˜å¿«
  * ä»¥ä¸€åœ°å€æŒ‡ä»¤ã€äºŒåœ°å€æŒ‡ä»¤ã€ä¸‰åœ°å€æŒ‡ä»¤ä¸ºä¸»



***



### ç”Ÿå‘½å‘¨æœŸ

JVMçš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼šå¯åŠ¨ã€è¿è¡Œã€æ­»äº¡ã€‚

- **å¯åŠ¨**ï¼šå½“å¯åŠ¨ä¸€ä¸ª Java ç¨‹åºæ—¶ï¼Œé€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆbootstrap class loaderï¼‰åˆ›å»ºä¸€ä¸ªåˆå§‹ç±»ï¼ˆinitial classï¼‰ï¼Œå¯¹äºæ‹¥æœ‰ main å‡½æ•°çš„ç±»å°±æ˜¯ JVM å®ä¾‹è¿è¡Œçš„èµ·ç‚¹
- **è¿è¡Œ**ï¼š
  - main() æ–¹æ³•æ˜¯ä¸€ä¸ªç¨‹åºçš„åˆå§‹èµ·ç‚¹ï¼Œä»»ä½•çº¿ç¨‹å‡å¯ç”±åœ¨æ­¤å¤„å¯åŠ¨
  - åœ¨ JVM å†…éƒ¨æœ‰ä¸¤ç§çº¿ç¨‹ç±»å‹ï¼Œåˆ†åˆ«ä¸ºï¼šç”¨æˆ·çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ï¼Œ**JVM ä½¿ç”¨çš„æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œmain() å’Œå…¶ä»–çº¿ç¨‹ä½¿ç”¨çš„æ˜¯ç”¨æˆ·çº¿ç¨‹**ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šéšç€ç”¨æˆ·çº¿ç¨‹çš„ç»“æŸè€Œç»“æŸ
  - æ‰§è¡Œä¸€ä¸ª Java ç¨‹åºæ—¶ï¼ŒçœŸçœŸæ­£æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Java è™šæ‹Ÿæœºçš„è¿›ç¨‹
  - JVM æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ Server ä¸ Clientï¼Œä¸¤ç§æ¨¡å¼çš„åŒºåˆ«åœ¨äºï¼šClient æ¨¡å¼å¯åŠ¨é€Ÿåº¦è¾ƒå¿«ï¼ŒServer æ¨¡å¼å¯åŠ¨è¾ƒæ…¢ï¼›ä½†æ˜¯å¯åŠ¨è¿›å…¥ç¨³å®šæœŸé•¿æœŸè¿è¡Œä¹‹å Server æ¨¡å¼çš„ç¨‹åºè¿è¡Œé€Ÿåº¦æ¯” Client è¦å¿«å¾ˆå¤š
  
    Server æ¨¡å¼å¯åŠ¨çš„ JVM é‡‡ç”¨çš„æ˜¯é‡é‡çº§çš„è™šæ‹Ÿæœºï¼Œå¯¹ç¨‹åºé‡‡ç”¨äº†æ›´å¤šçš„ä¼˜åŒ–ï¼Œè€Œ Client æ¨¡å¼å¯åŠ¨çš„ JVM é‡‡ç”¨çš„æ˜¯è½»é‡çº§çš„è™šæ‹Ÿæœº
- **æ­»äº¡**ï¼š
  
  - å½“ç¨‹åºä¸­çš„ç”¨æˆ·çº¿ç¨‹éƒ½ä¸­æ­¢ï¼ŒJVM æ‰ä¼šé€€å‡º
  - ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸã€ç¨‹åºå¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢ã€æ“ä½œç³»ç»Ÿé”™è¯¯å¯¼è‡´ç»ˆæ­¢
  - çº¿ç¨‹è°ƒç”¨ Runtime ç±» halt æ–¹æ³•æˆ– System ç±» exit æ–¹æ³•ï¼Œå¹¶ä¸” java å®‰å…¨ç®¡ç†å™¨å…è®¸è¿™æ¬¡ exit æˆ– halt æ“ä½œ





***





## å†…å­˜ç»“æ„

### å†…å­˜æ¦‚è¿°

å†…å­˜ç»“æ„æ˜¯JVMä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’Œ CPU çš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡Œï¼Œåˆå«è¿è¡Œæ—¶æ•°æ®åŒº

JVM å†…å­˜ç»“æ„è§„å®šäº† Java åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº† JVM çš„é«˜æ•ˆç¨³å®šè¿è¡Œ

* Java1.8 ä»¥å‰çš„å†…å­˜ç»“æ„å›¾ï¼š
  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-Java7å†…å­˜ç»“æ„å›¾.png)

* Java1.8 ä¹‹åçš„å†…å­˜ç»“æœå›¾ï¼š

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-Java8å†…å­˜ç»“æ„å›¾.png)

çº¿ç¨‹è¿è¡Œè¯Šæ–­ï¼š

* å®šä½ï¼šjpså®šä½è¿›ç¨‹id
* jstack è¿›ç¨‹idï¼šç”¨äºæ‰“å°å‡ºç»™å®šçš„ java è¿›ç¨‹ ID æˆ– core file æˆ–è¿œç¨‹è°ƒè¯•æœåŠ¡çš„ Java å †æ ˆä¿¡æ¯

å¸¸è§OOMé”™è¯¯ï¼š

* java.lang.StackOverflowError
* java.lang.OutOfMemoryErrorï¼šjava heap space
* java.lang.OutOfMemoryErrorï¼šGC overhead limit exceeded
* java.lang.OutOfMemoryErrorï¼šDirect buffer memory
* java.lang.OutOfMemoryErrorï¼šunable to create new native thread
* java.lang.OutOfMemoryErrorï¼šMetaspace



***



### JVMå†…å­˜

#### è™šæ‹Ÿæœºæ ˆ

##### Javaæ ˆ

Java è™šæ‹Ÿæœºæ ˆï¼šJava Virtual Machine Stacksï¼Œ**æ¯ä¸ªçº¿ç¨‹**è¿è¡Œæ—¶æ‰€éœ€è¦çš„å†…å­˜

* æ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œéƒ½ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºä¸€ä¸ªæ ˆå¸§ stack frameï¼ˆ**ä¸€ä¸ªæ–¹æ³•ä¸€ä¸ªæ ˆå¸§**ï¼‰

* javaè™šæ‹Ÿæœºè§„èŒƒå…è®¸ **Java æ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…æ˜¯å›ºå®šä¸å˜çš„**

* è™šæ‹Ÿæœºæ ˆæ˜¯**æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„**ï¼Œæ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”æ–¹æ³•è°ƒç”¨åˆ°æ‰§è¡Œå®Œæˆçš„æ•´ä¸ªè¿‡ç¨‹

* æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜ï¼Œæ¯ä¸ªæ ˆå¸§ä¸­å­˜å‚¨ç€ï¼š

  * å±€éƒ¨å˜é‡è¡¨ï¼šå­˜å‚¨æ–¹æ³•é‡Œçš„javaåŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠå¯¹è±¡çš„å¼•ç”¨
  * åŠ¨æ€é“¾æ¥ï¼šä¹Ÿå«æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨
  * æ–¹æ³•è¿”å›åœ°å€ï¼šæ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºçš„å®šä¹‰
  * æ“ä½œæ•°æ ˆæˆ–è¡¨è¾¾å¼æ ˆå’Œå…¶ä»–ä¸€äº›é™„åŠ ä¿¡æ¯
  
  <img src="https://gitee.com/seazean/images/raw/master/Java/JVM-è™šæ‹Ÿæœºæ ˆ.png" style="zoom:50%;" />

è®¾ç½®æ ˆå†…å­˜å¤§å°ï¼š`-Xss size`   `-Xss 1024k`

* åœ¨ JDK 1.4 ä¸­é»˜è®¤ä¸º 256Kï¼Œè€Œåœ¨ JDK 1.5+ é»˜è®¤ä¸º 1M

è™šæ‹Ÿæœºæ ˆç‰¹ç‚¹ï¼š

* æ ˆå†…å­˜**ä¸éœ€è¦è¿›è¡ŒGC**ï¼Œæ–¹æ³•å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šè¿›æ ˆï¼Œæ–¹æ³•è°ƒç”¨åè‡ªåŠ¨å¼¹æ ˆï¼Œç›¸å½“äºæ¸…ç©ºäº†æ•°æ®

* æ ˆå†…å­˜åˆ†é…è¶Šå¤§è¶Šå¤§ï¼Œå¯ç”¨çš„çº¿ç¨‹æ•°è¶Šå°‘ï¼ˆå†…å­˜è¶Šå¤§ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰çš„å†…å­˜è¶Šå¤§ï¼‰

* æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡æ˜¯å¦**çº¿ç¨‹å®‰å…¨**ï¼š
  * å¦‚æœæ–¹æ³•å†…å±€éƒ¨å˜é‡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
  * å¦‚æœæ˜¯å±€éƒ¨å˜é‡å¼•ç”¨äº†å¯¹è±¡ï¼Œå¹¶é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

å¼‚å¸¸ï¼š

* æ ˆå¸§è¿‡å¤šå¯¼è‡´æ ˆå†…å­˜æº¢å‡º ï¼ˆè¶…è¿‡äº†æ ˆçš„å®¹é‡ï¼‰ï¼Œä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸
* å½“çº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦è¶…è¿‡æœ€å¤§å€¼ï¼Œä¼šæŠ›å‡º StackOverflowError å¼‚å¸¸



***



##### å±€éƒ¨å˜é‡

å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨ï¼Œæœ¬è´¨ä¸Šå®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡

* è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜
* è¡¨çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šçš„ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„ Code å±æ€§çš„ maximum local variables æ•°æ®é¡¹ä¸­
* è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆï¼Œæ–¹æ³•ç»“æŸæ ˆå¸§é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯
* è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«è¡¨ä¸­æ•°æ®ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶

å±€éƒ¨å˜é‡è¡¨æœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯ **slot(å˜é‡æ§½)**ï¼š

* å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„ index0 å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦ -1 çš„ç´¢å¼•ç»“æŸï¼ŒJVM ä¸ºæ¯ä¸€ä¸ª slot éƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•å³å¯è®¿é—®åˆ°æ§½ä¸­çš„æ•°æ®
* å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddress ç±»å‹çš„å˜é‡
* 32 ä½ä»¥å†…çš„ç±»å‹åªå ä¸€ä¸ª slotï¼ˆåŒ…æ‹¬returnAddressç±»å‹ï¼‰ï¼Œ64 ä½çš„ç±»å‹ï¼ˆlong å’Œ doubleï¼‰å ä¸¤ä¸ª slot
* å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥**é‡å¤åˆ©ç”¨**çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„



***



##### æ“ä½œæ•°æ ˆ

æ ˆï¼šå¯ä»¥ä½¿ç”¨æ•°ç»„æˆ–è€…é“¾è¡¨æ¥å®ç°

æ“ä½œæ•°æ ˆï¼šåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰æˆ–å‡ºæ ˆï¼ˆpopï¼‰

* ä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ï¼Œæ˜¯æ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒº

* Java è™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆ
* å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­

æ ˆé¡¶ç¼“å­˜æŠ€æœ¯ ToSï¼ˆTop-of-Stack Cashingï¼‰ï¼šå°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ CPU çš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œçš„æ•ˆç‡

åŸºäºæ ˆå¼æ¶æ„çš„è™šæ‹Ÿæœºä½¿ç”¨çš„é›¶åœ°å€æŒ‡ä»¤æ›´åŠ ç´§å‡‘ï¼Œå®Œæˆä¸€é¡¹æ“ä½œéœ€è¦ä½¿ç”¨å¾ˆå¤šå…¥æ ˆå’Œå‡ºæ ˆæŒ‡ä»¤ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾ï¼ˆinstruction dispatchï¼‰æ¬¡æ•°å’Œå†…å­˜è¯»/å†™æ¬¡æ•°ï¼Œç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œå¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥éœ€è¦æ ˆé¡¶ç¼“å­˜æŠ€æœ¯



***



##### åŠ¨æ€é“¾æ¥

åŠ¨æ€é“¾æ¥æ˜¯æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼Œæ¶‰åŠåˆ°æ ˆæ“ä½œå·²ç»æ˜¯ç±»åŠ è½½å®Œæˆï¼Œè¿™ä¸ªé˜¶æ®µçš„è§£ææ˜¯åŠ¨æ€ç»‘å®š

* ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ï¼Œæ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± æˆ–è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-åŠ¨æ€é“¾æ¥ç¬¦å·å¼•ç”¨.png)

* åœ¨ Java æºæ–‡ä»¶è¢«ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ä¿å­˜åœ¨ class çš„å¸¸é‡æ± ä¸­
  å¸¸é‡æ± çš„ä½œç”¨ï¼šæä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-åŠ¨æ€é“¾æ¥è¿è¡Œæ—¶å¸¸é‡æ± .png)



***



##### è¿”å›åœ°å€

Return Addressï¼šå­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„PCå¯„å­˜å™¨çš„å€¼

æ–¹æ³•çš„ç»“æŸæœ‰ä¸¤ç§æ–¹å¼ï¼šæ­£å¸¸æ‰§è¡Œå®Œæˆã€å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®

* æ­£å¸¸ï¼šè°ƒç”¨è€…çš„ pc è®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„**ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€**
* å¼‚å¸¸ï¼šè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®š

æ­£å¸¸å®Œæˆå‡ºå£ï¼šæ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼ˆreturnï¼‰ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…

å¼‚å¸¸å®Œæˆå‡ºå£ï¼šæ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œæœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´ åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå¯¼è‡´æ–¹æ³•é€€å‡º

ä¸¤è€…åŒºåˆ«ï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼



##### é™„åŠ ä¿¡æ¯

æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸ Java è™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œä¾‹å¦‚å¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯



***



#### æœ¬åœ°æ–¹æ³•æ ˆ

æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºè™šæ‹Ÿæœº**æ‰§è¡Œæœ¬åœ°æ–¹æ³•æ—¶æä¾›æœåŠ¡çš„**

JNIï¼šJava Native Interfaceï¼Œé€šè¿‡ä½¿ç”¨ Java æœ¬åœ°æ¥å£ä¹¦å†™ç¨‹åºï¼Œå¯ä»¥ç¡®ä¿ä»£ç åœ¨ä¸åŒçš„å¹³å°ä¸Šæ–¹ä¾¿ç§»æ¤

* ä¸éœ€è¦è¿›è¡ŒGCï¼Œä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæœ‰ StackOverFlowError å’Œ OutOfMemoryError å¼‚å¸¸

* è™šæ‹Ÿæœºæ ˆæ‰§è¡Œçš„æ˜¯ Java æ–¹æ³•ï¼Œåœ¨ HotSpot JVM ä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€

* æœ¬åœ°æ–¹æ³•ä¸€èˆ¬æ˜¯ç”±å…¶ä»–è¯­è¨€ç¼–å†™ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘ä¸ºåŸºäºæœ¬æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„ç¨‹åº

* å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå°±è¿›å…¥äº†ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œï¼Œå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™

  * æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥**è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒº**
  * ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜
  * å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨
  
  <img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æœ¬åœ°æ–¹æ³•æ ˆ.png" style="zoom:67%;" />



***



#### ç¨‹åºè®¡æ•°å™¨

Program Counter Register ç¨‹åºè®¡æ•°å™¨ï¼ˆå¯„å­˜å™¨ï¼‰

ä½œç”¨ï¼šå†…éƒ¨ä¿å­˜å­—èŠ‚ç çš„è¡Œå·ï¼Œç”¨äºè®°å½•æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼ˆå¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•åˆ™ä¸ºç©ºï¼‰

åŸç†ï¼š

* JVM å¯¹äºå¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶ä¸”åˆ†é…çº¿ç¨‹æ‰§è¡Œæ—¶é—´ï¼Œä¸€ä¸ªå¤„ç†å™¨åªä¼šå¤„ç†æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹
* åˆ‡æ¢çº¿ç¨‹éœ€è¦ä»ç¨‹åºè®¡æ•°å™¨ä¸­æ¥å›å»åˆ°å½“å‰çš„çº¿ç¨‹ä¸Šä¸€æ¬¡æ‰§è¡Œçš„è¡Œå·

ç‰¹ç‚¹ï¼š

* **æ˜¯çº¿ç¨‹ç§æœ‰çš„**
* ä¸ä¼šå­˜åœ¨å†…å­˜æº¢å‡ºï¼Œæ˜¯ JVM è§„èŒƒä¸­å”¯ä¸€ä¸€ä¸ªä¸å‡ºç° OOM çš„åŒºåŸŸï¼Œæ‰€ä»¥è¿™ä¸ªç©ºé—´ä¸ä¼šè¿›è¡Œ GC

Java**åç¼–è¯‘**æŒ‡ä»¤ï¼š`javap -v Test.class`

#20ï¼šå»Constant poolæŸ¥çœ‹è¯¥åœ°å€çš„æŒ‡ä»¤

```java
0: getstatic #20 		// PrintStream out = System.out;
3: astore_1 			// --
4: aload_1 				// out.println(1);
5: iconst_1 			// --
6: invokevirtual #26 	// --
9: aload_1 				// out.println(2);
10: iconst_2 			// --
11: invokevirtual #26 	// --
```



****



#### å †

Heap å †ï¼šæ˜¯JVMå†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œç”±æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œç”±åƒåœ¾å›æ”¶å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼ˆ"GC å †"ï¼‰ï¼Œå †ä¸­å¯¹è±¡éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜

å­˜æ”¾å“ªäº›èµ„æºï¼š

* å¯¹è±¡å®ä¾‹ï¼šç±»åˆå§‹åŒ–ç”Ÿæˆçš„å¯¹è±¡ï¼Œ**åŸºæœ¬æ•°æ®ç±»å‹çš„æ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡å®ä¾‹**ï¼Œnew åˆ›å»ºå¯¹è±¡éƒ½ä½¿ç”¨å †å†…å­˜
* å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š
  * å­—ç¬¦ä¸²å¸¸é‡æ± åŸæœ¬å­˜æ”¾äºæ–¹æ³•åŒºï¼Œjdk7å¼€å§‹æ”¾ç½®äºå †ä¸­
  * å­—ç¬¦ä¸²å¸¸é‡æ± **å­˜å‚¨çš„æ˜¯ string å¯¹è±¡çš„ç›´æ¥å¼•ç”¨æˆ–è€…å¯¹è±¡**ï¼Œæ˜¯ä¸€å¼  string table
* é™æ€å˜é‡ï¼šé™æ€å˜é‡æ˜¯æœ‰ static ä¿®é¥°çš„å˜é‡ï¼Œjdk7 æ—¶ä»æ–¹æ³•åŒºè¿ç§»è‡³å †ä¸­
* çº¿ç¨‹åˆ†é…ç¼“å†²åŒº Thread Local Allocation Bufferï¼šçº¿ç¨‹ç§æœ‰ä½†ä¸å½±å“å †çš„å…±æ€§ï¼Œå¯ä»¥æå‡å¯¹è±¡åˆ†é…çš„æ•ˆç‡

è®¾ç½®å †å†…å­˜æŒ‡ä»¤ï¼š`-Xmx Size`

å†…å­˜æº¢å‡ºï¼šnew å‡ºå¯¹è±¡ï¼Œå¾ªç¯æ·»åŠ å­—ç¬¦æ•°æ®ï¼Œå½“å †ä¸­æ²¡æœ‰å†…å­˜ç©ºé—´å¯åˆ†é…ç»™å®ä¾‹ï¼Œä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œå°±ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸

å †å†…å­˜è¯Šæ–­å·¥å…·ï¼šï¼ˆæ§åˆ¶å°å‘½ä»¤ï¼‰

1. jpsï¼šæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº› java è¿›ç¨‹
2. jmapï¼šæŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µ `jhsdb jmap --heap --pid è¿›ç¨‹id`
3. jconsoleï¼šå›¾å½¢ç•Œé¢çš„ï¼Œå¤šåŠŸèƒ½çš„ç›‘æµ‹å·¥å…·ï¼Œå¯ä»¥è¿ç»­ç›‘æµ‹

åœ¨ Java7 ä¸­å †å†…ä¼šå­˜åœ¨**å¹´è½»ä»£ã€è€å¹´ä»£å’Œæ–¹æ³•åŒº(æ°¸ä¹…ä»£)**ï¼š

* Young åŒºè¢«åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼ŒEden åŒºå’Œä¸¤ä¸ªå¤§å°ä¸¥æ ¼ç›¸åŒçš„ Survivor åŒºã€‚Survivo råŒºé—´ï¼ŒæŸä¸€æ—¶åˆ»åªæœ‰å…¶ä¸­ä¸€ä¸ªæ˜¯è¢«ä½¿ç”¨çš„ï¼Œå¦å¤–ä¸€ä¸ªç•™åšåƒåœ¾å›æ”¶æ—¶å¤åˆ¶å¯¹è±¡ã€‚åœ¨ Eden åŒºå˜æ»¡çš„æ—¶å€™ï¼Œ GC å°±ä¼šå°†å­˜æ´»çš„å¯¹è±¡ç§»åˆ°ç©ºé—²çš„ Survivor åŒºé—´ä¸­ï¼Œæ ¹æ®JVMçš„ç­–ç•¥ï¼Œåœ¨ç»è¿‡å‡ æ¬¡åƒåœ¾å›æ”¶åï¼Œä»ç„¶å­˜æ´»äº Survivor çš„å¯¹è±¡å°†è¢«ç§»åŠ¨åˆ° Tenured åŒºé—´
* Tenured åŒºä¸»è¦ä¿å­˜ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ä¸€äº›è€çš„å¯¹è±¡ï¼Œå½“ä¸€äº›å¯¹è±¡åœ¨ Young å¤åˆ¶è½¬ç§»ä¸€å®šçš„æ¬¡æ•°ä»¥åï¼Œå¯¹è±¡å°±ä¼šè¢«è½¬ç§»åˆ° Tenured åŒº
* Perm ä»£ä¸»è¦ä¿å­˜**Classã€ClassLoaderã€é™æ€å˜é‡ã€å¸¸é‡ã€ç¼–è¯‘åçš„ä»£ç **ï¼Œåœ¨ java7 ä¸­å †å†…æ–¹æ³•åŒºä¼šå—åˆ° GC çš„ç®¡ç†

åˆ†ä»£åŸå› ï¼šä¸åŒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒï¼Œ70%-99% çš„å¯¹è±¡éƒ½æ˜¯ä¸´æ—¶å¯¹è±¡ï¼Œä¼˜åŒ– GC æ€§èƒ½

```java
public static void main(String[] args) {
    //è¿”å›Javaè™šæ‹Ÿæœºä¸­çš„å †å†…å­˜æ€»é‡
    long initialMemory = Runtime.getRuntime().totalMemory() / 1024 / 1024;
    //è¿”å›Javaè™šæ‹Ÿæœºä½¿ç”¨çš„æœ€å¤§å †å†…å­˜é‡
    long maxMemory = Runtime.getRuntime().maxMemory() / 1024 / 1024;
    
    System.out.println("-Xms : " + initialMemory + "M");//-Xms : 245M
    System.out.println("-Xmx : " + maxMemory + "M");//-Xmx : 3641M
}
```



***



#### æ–¹æ³•åŒº

æ–¹æ³•åŒºï¼šæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ï¼Œè™½ç„¶ Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯ä¹Ÿå« Non-Heapï¼ˆéå †ï¼‰

æ–¹æ³•åŒºæ˜¯ä¸€ä¸ª JVM è§„èŒƒï¼Œ**æ°¸ä¹…ä»£ä¸å…ƒç©ºé—´éƒ½æ˜¯å…¶ä¸€ç§å®ç°æ–¹å¼**

æ–¹æ³•åŒºçš„å¤§å°ä¸å¿…æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥åŠ¨æ€æ‰©å±•ï¼ŒåŠ è½½çš„ç±»å¤ªå¤šï¼Œå¯èƒ½å¯¼è‡´æ°¸ä¹…ä»£å†…å­˜æº¢å‡º (OutOfMemoryError)

æ–¹æ³•åŒºçš„ GCï¼šé’ˆå¯¹å¸¸é‡æ± çš„å›æ”¶åŠå¯¹ç±»å‹çš„å¸è½½ï¼Œæ¯”è¾ƒéš¾å®ç°

ä¸ºäº†**é¿å…æ–¹æ³•åŒºå‡ºç°OOM**ï¼Œåœ¨JDK8ä¸­å°†å †å†…çš„æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰ç§»åŠ¨åˆ°äº†æœ¬åœ°å†…å­˜ä¸Šï¼Œé‡æ–°å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œå«åšå…ƒç©ºé—´ï¼Œå…ƒç©ºé—´å­˜å‚¨ç±»çš„å…ƒä¿¡æ¯ï¼Œé™æ€å˜é‡å’Œå­—ç¬¦ä¸²å¸¸é‡æ± ç­‰æ”¾å…¥å †ä¸­

ç±»å…ƒä¿¡æ¯ï¼šåœ¨ç±»ç¼–è¯‘æœŸé—´æ”¾å…¥æ–¹æ³•åŒºï¼Œå­˜æ”¾äº†ç±»çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„æ–¹æ³•ã€å‚æ•°ã€æ¥å£ä»¥åŠå¸¸é‡æ± è¡¨

å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰æ˜¯Classæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œå­˜å‚¨äº†ç±»åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆçš„**å­—é¢é‡ã€ç¬¦å·å¼•ç”¨**ï¼ŒJVMä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± 

- å­—é¢é‡ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å­—ç¬¦ä¸²ç±»å‹å¸¸é‡ã€å£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰
- ç¬¦å·å¼•ç”¨ï¼šç±»ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰çš„ç¬¦å·å¼•ç”¨

**è¿è¡Œæ—¶å¸¸é‡æ± **æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†

* å¸¸é‡æ± ï¼ˆç¼–è¯‘å™¨ç”Ÿæˆçš„å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼‰ä¸­çš„æ•°æ®ä¼šåœ¨ç±»åŠ è½½çš„åŠ è½½é˜¶æ®µæ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± 
* ç±»åœ¨è§£æé˜¶æ®µå°†ç¬¦å·å¼•ç”¨æ›¿æ¢æˆç›´æ¥å¼•ç”¨
* é™¤äº†åœ¨ç¼–è¯‘æœŸç”Ÿæˆçš„å¸¸é‡ï¼Œè¿˜å…è®¸åŠ¨æ€ç”Ÿæˆï¼Œä¾‹å¦‚ String ç±»çš„ intern()



***



### æœ¬åœ°å†…å­˜

#### åŸºæœ¬ä»‹ç»

è™šæ‹Ÿæœºå†…å­˜ï¼šJava è™šæ‹Ÿæœºåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šæŠŠç®¡ç†çš„å†…å­˜åˆ†é…æˆä¸åŒçš„åŒºåŸŸï¼Œå—è™šæ‹Ÿæœºå†…å­˜å¤§å°çš„å‚æ•°æ§åˆ¶ï¼Œå½“å¤§å°è¶…è¿‡å‚æ•°è®¾ç½®çš„å¤§å°æ—¶å°±ä¼šæŠ¥ OOM

æœ¬åœ°å†…å­˜ï¼šåˆå«åš**å †å¤–å†…å­˜**ï¼Œçº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œæœ¬åœ°å†…å­˜è¿™å—åŒºåŸŸæ˜¯ä¸ä¼šå—åˆ° JVM çš„æ§åˆ¶çš„ï¼Œä¸ä¼šå‘ç”Ÿ GCï¼›å› æ­¤å¯¹äºæ•´ä¸ª java çš„æ‰§è¡Œæ•ˆç‡æ˜¯æå‡éå¸¸å¤§ï¼Œä½†æ˜¯å¦‚æœå†…å­˜çš„å ç”¨è¶…å‡ºç‰©ç†å†…å­˜çš„å¤§å°ï¼ŒåŒæ ·ä¹Ÿä¼šæŠ¥ OOM

æœ¬åœ°å†…å­˜æ¦‚è¿°å›¾ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-å†…å­˜å›¾å¯¹æ¯”.png" style="zoom: 67%;" />



***



#### å…ƒç©ºé—´

PermGen è¢«å…ƒç©ºé—´ä»£æ›¿ï¼Œæ°¸ä¹…ä»£çš„**ç±»ä¿¡æ¯ã€æ–¹æ³•ã€å¸¸é‡æ± **ç­‰éƒ½ç§»åŠ¨åˆ°å…ƒç©ºé—´åŒº

å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£åŒºåˆ«ï¼šå…ƒç©ºé—´ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œä½¿ç”¨çš„æœ¬åœ°å†…å­˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶

æ–¹æ³•åŒºå†…å­˜æº¢å‡ºï¼š

* JDK1.8ä»¥å‰ä¼šå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºï¼šjava.lang.OutOfMemoryError: PerGen space

  ```sh
   -XX:MaxPermSize=8m		#å‚æ•°è®¾ç½®
  ```
  
* JDK1.8ä»¥åä¼šå¯¼è‡´å…ƒç©ºé—´å†…å­˜æº¢å‡ºï¼šjava.lang.OutOfMemoryError: Metaspace

  ```sh
  -XX:MaxMetaspaceSize=8m	#å‚æ•°è®¾ç½®	
  ```

å…ƒç©ºé—´å†…å­˜æº¢å‡ºæ¼”ç¤ºï¼š

```java
public class Demo1_8 extends ClassLoader { // å¯ä»¥ç”¨æ¥åŠ è½½ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚ç 
    public static void main(String[] args) {
        int j = 0;
        try {
            Demo1_8 test = new Demo1_8();
            for (int i = 0; i < 10000; i++, j++) {
                // ClassWriter ä½œç”¨æ˜¯ç”Ÿæˆç±»çš„äºŒè¿›åˆ¶å­—èŠ‚ç 
                ClassWriter cw = new ClassWriter(0);
                // ç‰ˆæœ¬å·ï¼Œ publicï¼Œ ç±»å, åŒ…å, çˆ¶ç±»ï¼Œ æ¥å£
                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, "Class" + i, null, "java/lang/Object", null);
                // è¿”å› byte[]
                byte[] code = cw.toByteArray();
                // æ‰§è¡Œäº†ç±»çš„åŠ è½½
                test.defineClass("Class" + i, code, 0, code.length); // Class å¯¹è±¡
            }
        } finally {
            System.out.println(j);
        }
    }
}
```



***



#### ç›´æ¥å†…å­˜

ç›´æ¥å†…å­˜æ˜¯ Java å †å¤–çš„ã€ç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ï¼Œä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸ



ç›´æ¥å†…å­˜è¯¦è§£å‚è€ƒï¼šNET â†’ NIO â†’ ç›´æ¥å†…å­˜



***



### å˜é‡ä½ç½®

**å˜é‡çš„ä½ç½®ä¸å–å†³äºå®ƒæ˜¯åŸºæœ¬æ•°æ®ç±»å‹è¿˜æ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œå–å†³äºå®ƒçš„å£°æ˜ä½ç½®**

é™æ€å†…éƒ¨ç±»å’Œå…¶ä»–å†…éƒ¨ç±»ï¼š

* **ä¸€ä¸ª class æ–‡ä»¶åªèƒ½å¯¹åº”ä¸€ä¸ª public ç±»å‹çš„ç±»**ï¼Œè¿™ä¸ªç±»å¯ä»¥æœ‰å†…éƒ¨ç±»ï¼Œä½†ä¸ä¼šç”Ÿæˆæ–°çš„ class æ–‡ä»¶

* é™æ€å†…éƒ¨ç±»å±äºç±»æœ¬èº«ï¼ŒåŠ è½½åˆ°æ–¹æ³•åŒºï¼Œå…¶ä»–å†…éƒ¨ç±»å±äºå†…éƒ¨ç±»çš„å±æ€§ï¼ŒåŠ è½½åˆ°æ ˆï¼ˆå¾…è€ƒè¯ï¼‰

ç±»å˜é‡ï¼š

* ç±»å˜é‡æ˜¯ç”¨ static ä¿®é¥°ç¬¦ä¿®é¥°ï¼Œå®šä¹‰åœ¨æ–¹æ³•å¤–çš„å˜é‡ï¼Œéšç€ java è¿›ç¨‹äº§ç”Ÿå’Œé”€æ¯
* åœ¨ java8 ä¹‹å‰æŠŠé™æ€å˜é‡å­˜æ”¾äºæ–¹æ³•åŒºï¼Œåœ¨ java8 æ—¶å­˜æ”¾åœ¨**å †ä¸­çš„é™æ€å˜é‡åŒº**


å®ä¾‹å˜é‡ï¼š

* å®ä¾‹ï¼ˆæˆå‘˜ï¼‰å˜é‡æ˜¯å®šä¹‰åœ¨ç±»ä¸­ï¼Œæ²¡æœ‰staticä¿®é¥°çš„å˜é‡ï¼Œéšç€ç±»çš„å®ä¾‹äº§ç”Ÿå’Œé”€æ¯ï¼Œæ˜¯ç±»å®ä¾‹çš„ä¸€éƒ¨åˆ†
* åœ¨ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä»è¿è¡Œæ—¶å¸¸é‡æ± å–å‡ºç›´æ¥å¼•ç”¨æˆ–è€…å€¼ï¼Œ**ä¸åˆå§‹åŒ–çš„å¯¹è±¡ä¸€èµ·æ”¾å…¥å †ä¸­**

å±€éƒ¨å˜é‡ï¼š

* å±€éƒ¨å˜é‡æ˜¯å®šä¹‰åœ¨ç±»çš„æ–¹æ³•ä¸­çš„å˜é‡
* åœ¨æ‰€åœ¨æ–¹æ³•è¢«è°ƒç”¨æ—¶**æ”¾å…¥è™šæ‹Ÿæœºæ ˆçš„æ ˆå¸§**ä¸­ï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸåä»è™šæ‹Ÿæœºæ ˆä¸­å¼¹å‡ºï¼Œ

ç±»å¸¸é‡æ± ã€è¿è¡Œæ—¶å¸¸é‡æ± ã€å­—ç¬¦ä¸²å¸¸é‡æ± æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

* ç±»å¸¸é‡æ± ä¸è¿è¡Œæ—¶å¸¸é‡æ± éƒ½å­˜å‚¨åœ¨æ–¹æ³•åŒºï¼Œè€Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨ jdk7 æ—¶å°±å·²ç»ä»æ–¹æ³•åŒºè¿ç§»åˆ°äº† java å †ä¸­
* åœ¨ç±»ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠç±»å…ƒä¿¡æ¯æ”¾åˆ°æ–¹æ³•åŒºï¼Œç±»å…ƒä¿¡æ¯çš„å…¶ä¸­ä¸€éƒ¨åˆ†ä¾¿æ˜¯ç±»å¸¸é‡æ± ï¼Œä¸»è¦å­˜æ”¾å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè€Œå­—é¢é‡çš„ä¸€éƒ¨åˆ†ä¾¿æ˜¯æ–‡æœ¬å­—ç¬¦
* åœ¨ç±»åŠ è½½æ—¶å°†å­—é¢é‡å’Œç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨å­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± 
* å¯¹äºæ–‡æœ¬å­—ç¬¦æ¥è¯´ï¼Œä¼šåœ¨è§£ææ—¶æŸ¥æ‰¾å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ŒæŸ¥å‡ºè¿™ä¸ªæ–‡æœ¬å­—ç¬¦å¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡çš„ç›´æ¥å¼•ç”¨ï¼Œå°†ç›´æ¥å¼•ç”¨å­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± 

ä»€ä¹ˆæ˜¯å­—é¢é‡ï¼Ÿä»€ä¹ˆæ˜¯ç¬¦å·å¼•ç”¨ï¼Ÿ

* å­—é¢é‡ï¼šjavaä»£ç åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ˜¯æ— æ³•æ„å»ºå¼•ç”¨çš„ï¼Œå­—é¢é‡å°±æ˜¯åœ¨ç¼–è¯‘æ—¶å¯¹äºæ•°æ®çš„ä¸€ç§è¡¨ç¤º

  ```java
  int a=1;//è¿™ä¸ª1ä¾¿æ˜¯å­—é¢é‡
  String b="iloveu";//iloveuä¾¿æ˜¯å­—é¢é‡
  ```

* ç¬¦å·å¼•ç”¨ï¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å¹¶ä¸çŸ¥é“æ¯ä¸ªç±»çš„åœ°å€ï¼Œå› ä¸ºå¯èƒ½è¿™ä¸ªç±»è¿˜æ²¡æœ‰åŠ è½½ï¼Œå¦‚æœåœ¨ä¸€ä¸ªç±»ä¸­å¼•ç”¨äº†å¦ä¸€ä¸ªç±»ï¼Œæ— æ³•çŸ¥é“å®ƒçš„å†…å­˜åœ°å€ï¼Œåªèƒ½ç”¨ä»–çš„ç±»åä½œä¸ºç¬¦å·å¼•ç”¨ï¼Œåœ¨ç±»åŠ è½½å®Œåç”¨è¿™ä¸ªç¬¦å·å¼•ç”¨å»è·å–å†…å­˜åœ°å€

  ä¾‹å¦‚ï¼šåœ¨ com.demo.Solution ç±»ä¸­å¼•ç”¨äº† com.test.Questï¼ŒæŠŠ `com.test.Quest` ä½œä¸ºç¬¦å·å¼•ç”¨å­˜è¿›ç±»å¸¸é‡æ± ï¼Œåœ¨ç±»åŠ è½½å®Œåï¼Œç”¨è¿™ä¸ªç¬¦å·å¼•ç”¨å»æ–¹æ³•åŒºæ‰¾è¿™ä¸ªç±»çš„å†…å­˜åœ°å€





***





## å†…å­˜ç®¡ç†

### å†…å­˜åˆ†é…

#### ä¸¤ç§æ–¹å¼

ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šé¦–å…ˆè®¡ç®—å¯¹è±¡å ç”¨ç©ºé—´å¤§å°ï¼Œæ¥ç€åœ¨å †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜ç»™æ–°å¯¹è±¡

* å¦‚æœå†…å­˜è§„æ•´ï¼Œä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼ˆBumpThePointerï¼‰
  æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜åœ¨å¦å¤–ä¸€è¾¹ï¼Œä¸­é—´æœ‰ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠæŒ‡é’ˆå‘ç©ºé—²é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»
* å¦‚æœå†…å­˜ä¸è§„æ•´ï¼Œè™šæ‹Ÿæœºéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰åˆ†é…
  å·²ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œè™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•ä¸Šå“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œå†åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„å†…å®¹



***



#### åˆ†ä»£æ€æƒ³

##### åˆ†ä»£ä»‹ç»

Java8 æ—¶ï¼Œå †è¢«åˆ†ä¸ºäº†ä¸¤ä»½ï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼ˆ1ï¼š2ï¼‰ï¼Œåœ¨java7æ—¶ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªæ°¸ä¹…ä»£

- æ–°ç”Ÿä»£ä½¿ç”¨ï¼šå¤åˆ¶ç®—æ³•
- è€å¹´ä»£ä½¿ç”¨ï¼šæ ‡è®° - æ¸…é™¤ æˆ–è€… æ ‡è®° - æ•´ç† ç®—æ³•

**Minor GC å’Œ Full GC**ï¼š

- Minor GCï¼šå›æ”¶æ–°ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£å¯¹è±¡å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œæ‰€ä»¥ Minor GC ä¼šé¢‘ç¹æ‰§è¡Œï¼Œæ‰§è¡Œçš„é€Ÿåº¦æ¯”è¾ƒå¿«
- Full GCï¼šå›æ”¶è€å¹´ä»£å’Œæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£å¯¹è±¡å…¶å­˜æ´»æ—¶é—´é•¿ï¼Œæ‰€ä»¥ Full GC å¾ˆå°‘æ‰§è¡Œï¼Œæ‰§è¡Œé€Ÿåº¦ä¼šæ¯” Minor GC æ…¢å¾ˆå¤š

 Eden å’Œ Survivor å¤§å°æ¯”ä¾‹é»˜è®¤ä¸º 8:1:1

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-åˆ†ä»£æ”¶é›†ç®—æ³•.png" style="zoom: 67%;" />





***



##### åˆ†ä»£åˆ†é…

å·¥ä½œæœºåˆ¶ï¼š

* **å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…**ï¼šå½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå¯¹è±¡ä¼šè¢«åˆ†é…åœ¨æ–°ç”Ÿä»£çš„ Eden åŒºï¼Œå½“Eden åŒºè¦æ»¡äº†æ—¶å€™ï¼Œè§¦å‘ YoungGC
* å½“è¿›è¡Œ YoungGC åï¼Œæ­¤æ—¶åœ¨ Eden åŒºå­˜æ´»çš„å¯¹è±¡è¢«ç§»åŠ¨åˆ° to åŒºï¼Œå¹¶ä¸”**å½“å‰å¯¹è±¡çš„å¹´é¾„ä¼šåŠ 1**ï¼Œæ¸…ç©º Eden åŒº
* å½“å†ä¸€æ¬¡è§¦å‘ YoungGC çš„æ—¶å€™ï¼Œä¼šæŠŠ Eden åŒºä¸­å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å’Œ to ä¸­çš„å¯¹è±¡ï¼Œç§»åŠ¨åˆ° from åŒºä¸­ï¼Œè¿™äº›å¯¹è±¡çš„å¹´é¾„ä¼šåŠ  1ï¼Œæ¸…ç©º Eden åŒºå’Œ to åŒº
* To åŒºæ°¸è¿œæ˜¯ç©º Survivor åŒºï¼ŒFrom åŒºæ˜¯æœ‰æ•°æ®çš„ï¼Œæ¯æ¬¡ MinorGC åä¸¤ä¸ªåŒºåŸŸäº’æ¢
* From åŒºå’Œ To åŒº ä¹Ÿå¯ä»¥å«åš S0 åŒºå’Œ S1 åŒº

æ™‹å‡åˆ°è€å¹´ä»£ï¼š

* **é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£**ï¼šä¸ºå¯¹è±¡å®šä¹‰å¹´é¾„è®¡æ•°å™¨ï¼Œå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ Minor GC ä¾ç„¶å­˜æ´»ï¼Œå°†ç§»åŠ¨åˆ° Survivor ä¸­ï¼Œå¹´é¾„å°±å¢åŠ  1 å²ï¼Œå¢åŠ åˆ°ä¸€å®šå¹´é¾„åˆ™ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­
  `-XX:MaxTenuringThreshold`ï¼šå®šä¹‰å¹´é¾„çš„é˜ˆå€¼ï¼Œå¯¹è±¡å¤´ä¸­ç”¨4ä¸ªbitå­˜å‚¨ï¼Œæ‰€ä»¥æœ€å¤§å€¼æ˜¯15ï¼Œé»˜è®¤ä¹Ÿæ˜¯15
* **å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£**ï¼šéœ€è¦è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼Œæœ€å…¸å‹çš„å¤§å¯¹è±¡æ˜¯å¾ˆé•¿çš„å­—ç¬¦ä¸²ä»¥åŠæ•°ç»„ï¼›é¿å…åœ¨ Eden å’Œ Survivor ä¹‹é—´çš„å¤§é‡å¤åˆ¶ï¼›ç»å¸¸å‡ºç°å¤§å¯¹è±¡ä¼šæå‰è§¦å‘GCä»¥è·å–è¶³å¤Ÿçš„è¿ç»­ç©ºé—´åˆ†é…ç»™å¤§å¯¹è±¡
  `-XX:PretenureSizeThreshold`ï¼šå¤§äºæ­¤å€¼çš„å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…
* **åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š**ï¼šå¦‚æœåœ¨SurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„å¯¹è±¡çš„æ‰€æœ‰å¤§å°ä¹‹å’Œè¶…è¿‡Survivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£

ç©ºé—´åˆ†é…æ‹…ä¿ï¼š

* åœ¨å‘ç”Ÿ Minor GC ä¹‹å‰ï¼Œè™šæ‹Ÿæœºå…ˆæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œå¦‚æœæ¡ä»¶æˆç«‹çš„è¯ï¼Œé‚£ä¹ˆ Minor GC å¯ä»¥ç¡®è®¤æ˜¯å®‰å…¨çš„
* å¦‚æœä¸æˆç«‹ï¼Œè™šæ‹Ÿæœºä¼šæŸ¥çœ‹ HandlePromotionFailure çš„å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ï¼Œå¦‚æœå…è®¸é‚£ä¹ˆå°±ä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœå¤§äºå°†å°è¯•ç€è¿›è¡Œä¸€æ¬¡ Minor GCï¼›å¦‚æœå°äºæˆ–è€… HandlePromotionFailure çš„å€¼ä¸å…è®¸å†’é™©ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œä¸€æ¬¡ Full GCã€‚



***



#### TLAB

è™šæ‹Ÿæœºé‡‡ç”¨äº†ä¸¤ç§æ–¹å¼åœ¨åˆ›å»ºå¯¹è±¡æ—¶è§£å†³å¹¶å‘é—®é¢˜ï¼šCASã€TLAB

TLABï¼šThread Local Allocation Bufferï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨å †å†…å•ç‹¬åˆ†é…äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¤šçº¿ç¨‹åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLAB å¯ä»¥é¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œè¿™ç§å†…å­˜åˆ†é…æ–¹å¼å«åš**å¿«é€Ÿåˆ†é…ç­–ç•¥**

- æ ˆä¸Šåˆ†é…ä½¿ç”¨çš„æ˜¯æ ˆæ¥è¿›è¡Œå¯¹è±¡å†…å­˜çš„åˆ†é…
- TLAB åˆ†é…ä½¿ç”¨çš„æ˜¯ Eden åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œå±äºå †å†…å­˜

èƒŒæ™¯ï¼šå †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®ï¼Œç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨JVMä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦

é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ ä¸ä¸€å®šï¼Œå› ä¸ºè¿˜æœ‰TLABï¼Œåœ¨å †ä¸­åˆ’åˆ†å‡ºä¸€å—åŒºåŸŸï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹æ‰€ç‹¬å 

![](https://gitee.com/seazean/images/raw/master/Java/JVM-TLABå†…å­˜åˆ†é…ç­–ç•¥.jpg)

JVM æ˜¯å°† TLAB ä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨ TLAB ä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVM å°±ä¼šé€šè¿‡**ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§**ï¼Œä»è€Œç›´æ¥åœ¨ Eden ç©ºé—´ä¸­åˆ†é…å†…å­˜

æ ˆä¸Šåˆ†é…ä¼˜å…ˆäº TLAB åˆ†é…è¿›è¡Œï¼Œé€ƒé€¸åˆ†æä¸­è‹¥å¯è¿›è¡Œæ ˆä¸Šåˆ†é…ä¼˜åŒ–ï¼Œä¼šä¼˜å…ˆè¿›è¡Œå¯¹è±¡æ ˆä¸Šç›´æ¥åˆ†é…å†…å­˜

å‚æ•°è®¾ç½®ï¼š

* `-XX:UseTLAB`ï¼šè®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´

* `-XX:TLABWasteTargetPercent`ï¼šè®¾ç½®TLABç©ºé—´æ‰€å ç”¨Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1ï¼Œå³1%
* `-XX:TLABRefillWasteFraction`ï¼šæŒ‡å½“ TLAB ç©ºé—´ä¸è¶³ï¼Œè¯·æ±‚åˆ†é…çš„å¯¹è±¡å†…å­˜å¤§å°è¶…è¿‡æ­¤é˜ˆå€¼æ—¶ä¸ä¼šè¿›è¡Œ TLAB åˆ†é…ï¼Œç›´æ¥è¿›è¡Œå †å†…å­˜åˆ†é…ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šä¼˜å…ˆè¿›è¡Œ TLAB åˆ†é…

![](https://gitee.com/seazean/images/raw/master/Java/JVM-TLABå†…å­˜åˆ†é…è¿‡ç¨‹.jpg)



***



#### é€ƒé€¸åˆ†æ

å³æ—¶ç¼–è¯‘ï¼ˆJust-in-time Compilationï¼ŒJITï¼‰æ˜¯ä¸€ç§é€šè¿‡åœ¨è¿è¡Œæ—¶å°†å­—èŠ‚ç ç¿»è¯‘ä¸ºæœºå™¨ç ï¼Œä»è€Œæ”¹å–„å­—èŠ‚ç ç¼–è¯‘è¯­è¨€æ€§èƒ½çš„æŠ€æœ¯ï¼Œåœ¨HotSpotå®ç°ä¸­æœ‰å¤šç§é€‰æ‹©ï¼šC1ã€C2 å’Œ C1+C2ï¼Œåˆ†åˆ«å¯¹åº” clientã€server å’Œåˆ†å±‚ç¼–è¯‘

* C1ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œä¼˜åŒ–æ–¹å¼æ¯”è¾ƒä¿å®ˆï¼›C2ç¼–è¯‘é€Ÿåº¦æ…¢ï¼Œä¼˜åŒ–æ–¹å¼æ¯”è¾ƒæ¿€è¿›
* C1+C2åœ¨å¼€å§‹é˜¶æ®µé‡‡ç”¨C1ç¼–è¯‘ï¼Œå½“ä»£ç è¿è¡Œåˆ°ä¸€å®šçƒ­åº¦ä¹‹åé‡‡ç”¨G2é‡æ–°ç¼–è¯‘

**é€ƒé€¸åˆ†æ**ï¼šå¹¶ä¸æ˜¯ç›´æ¥çš„ä¼˜åŒ–æ‰‹æ®µï¼Œè€Œæ˜¯ä¸€ä¸ªä»£ç åˆ†æï¼Œé€šè¿‡åŠ¨æ€åˆ†æå¯¹è±¡çš„ä½œç”¨åŸŸï¼Œä¸ºå…¶å®ƒä¼˜åŒ–æ‰‹æ®µå¦‚æ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢å’ŒåŒæ­¥æ¶ˆé™¤ç­‰æä¾›ä¾æ®ï¼Œå‘ç”Ÿé€ƒé€¸è¡Œä¸ºçš„æƒ…å†µæœ‰ä¸¤ç§ï¼šæ–¹æ³•é€ƒé€¸å’Œçº¿ç¨‹é€ƒé€¸

* æ–¹æ³•é€ƒé€¸ï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­å®šä¹‰ä¹‹åï¼Œè¢«å¤–éƒ¨æ–¹æ³•å¼•ç”¨
  * å…¨å±€é€ƒé€¸ï¼šä¸€ä¸ªå¯¹è±¡çš„ä½œç”¨èŒƒå›´é€ƒå‡ºäº†å½“å‰æ–¹æ³•æˆ–è€…å½“å‰çº¿ç¨‹ï¼Œæ¯”å¦‚å¯¹è±¡æ˜¯ä¸€ä¸ªé™æ€å˜é‡ã€å…¨å±€å˜é‡èµ‹å€¼ã€å·²ç»å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ã€ä½œä¸ºå½“å‰æ–¹æ³•çš„è¿”å›å€¼
  * å‚æ•°é€ƒé€¸ï¼šä¸€ä¸ªå¯¹è±¡è¢«ä½œä¸ºæ–¹æ³•å‚æ•°ä¼ é€’æˆ–è€…è¢«å‚æ•°å¼•ç”¨
* çº¿ç¨‹é€ƒé€¸ï¼šå¦‚ç±»å˜é‡æˆ–å®ä¾‹å˜é‡ï¼Œå¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°

å¦‚æœä¸å­˜åœ¨é€ƒé€¸è¡Œä¸ºï¼Œåˆ™å¯ä»¥å¯¹è¯¥å¯¹è±¡è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–ï¼šåŒæ­¥æ¶ˆé™¤ã€æ ‡é‡æ›¿æ¢å’Œæ ˆä¸Šåˆ†é…

* **åŒæ­¥æ¶ˆé™¤**

  çº¿ç¨‹åŒæ­¥æœ¬èº«æ¯”è¾ƒè€—æ—¶ï¼Œå¦‚æœç¡®å®šä¸€ä¸ªå¯¹è±¡ä¸ä¼šé€ƒé€¸å‡ºçº¿ç¨‹ï¼Œä¸è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å¯¹è±¡çš„è¯»å†™å°±ä¸ä¼šå­˜åœ¨ç«äº‰ï¼Œåˆ™å¯ä»¥æ¶ˆé™¤å¯¹è¯¥å¯¹è±¡çš„**åŒæ­¥é”**ï¼Œé€šè¿‡`-XX:+EliminateLocks`å¯ä»¥å¼€å¯åŒæ­¥æ¶ˆé™¤ ( - å·å…³é—­)

* **æ ‡é‡æ›¿æ¢**

  * æ ‡é‡æ›¿æ¢ï¼šå¦‚æœæŠŠä¸€ä¸ªå¯¹è±¡æ‹†æ•£ï¼Œå°†å…¶æˆå‘˜å˜é‡æ¢å¤åˆ°åŸºæœ¬ç±»å‹æ¥è®¿é—®
  * æ ‡é‡ (scalar) ï¼šä¸å¯åˆ†å‰²çš„é‡ï¼Œå¦‚åŸºæœ¬æ•°æ®ç±»å‹å’Œreferenceç±»å‹
    èšåˆé‡ (Aggregate)ï¼šä¸€ä¸ªæ•°æ®å¯ä»¥ç»§ç»­åˆ†è§£ï¼Œå¯¹è±¡ä¸€èˆ¬æ˜¯èšåˆé‡
  * å¦‚æœé€ƒé€¸åˆ†æå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡å¯ä»¥è¢«æ‹†æ•£ï¼Œé‚£ä¹ˆç»è¿‡ä¼˜åŒ–ä¹‹åï¼Œå¹¶ä¸ç›´æ¥ç”Ÿæˆè¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†è¯¥å¯¹è±¡æˆå‘˜å˜é‡åˆ†è§£è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æˆå‘˜å˜é‡æ‰€ä»£æ›¿
  * å‚æ•°è®¾ç½®ï¼š
    `-XX:+EliminateAllocations`ï¼šå¼€å¯æ ‡é‡æ›¿æ¢
    `-XX:+PrintEliminateAllocations`ï¼šæŸ¥çœ‹æ ‡é‡æ›¿æ¢æƒ…å†µ

* **æ ˆä¸Šåˆ†é…**

  JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ï¼Œè¿™æ ·å°±æ— éœ€GC

  Userå¯¹è±¡çš„ä½œç”¨åŸŸå±€é™åœ¨æ–¹æ³•fnä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ ‡é‡æ›¿æ¢çš„ä¼˜åŒ–æ‰‹æ®µåœ¨æ ˆä¸Šåˆ†é…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œè¿™æ ·å°±ä¸ä¼šç”ŸæˆUserå¯¹è±¡ï¼Œå¤§å¤§å‡è½»GCçš„å‹åŠ›

  ```java
  public class JVM {
      public static void main(String[] args) throws Exception {
          int sum = 0;
          int count = 1000000;
          //warm up
          for (int i = 0; i < count ; i++) {
              sum += fn(i);
          }
          System.out.println(sum);
          System.in.read();
      }
      private static int fn(int age) {
          User user = new User(age);
          int i = user.getAge();
          return i;
      }
  }
  
  class User {
      private final int age;
  
      public User(int age) {
          this.age = age;
      }
  
      public int getAge() {
          return age;
      }
  }
  ```

  

***



### å›æ”¶ç­–ç•¥

#### è§¦å‘æ¡ä»¶

å†…å­˜åƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦é›†ä¸­çš„åŒºåŸŸå°±æ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼š**å †å’Œæ–¹æ³•åŒº**

Minor GC è§¦å‘æ¡ä»¶éå¸¸ç®€å•ï¼Œå½“ Eden ç©ºé—´æ»¡æ—¶ï¼Œå°±å°†è§¦å‘ä¸€æ¬¡ Minor GC

FullGC åŒæ—¶å›æ”¶æ–°ç”Ÿä»£ã€è€å¹´ä»£å’Œæ–¹æ³•åŒºï¼Œåªä¼šå­˜åœ¨ä¸€ä¸ªFullGCçš„çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œå…¶ä»–çš„çº¿ç¨‹å…¨éƒ¨ä¼šè¢«**æŒ‚èµ·**ï¼Œæœ‰ä»¥ä¸‹è§¦å‘æ¡ä»¶ï¼š

* è°ƒç”¨ System.gc()ï¼š

  * åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡ System.gc() æˆ– Runtime.getRuntime().gc() çš„è°ƒç”¨ï¼Œä¼šæ˜¾å¼è§¦å‘ FullGCï¼ŒåŒæ—¶å¯¹è€å¹´ä»£å’Œæ–°ç”Ÿä»£è¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯è™šæ‹Ÿæœºä¸ä¸€å®šçœŸæ­£å»æ‰§è¡Œï¼Œæ— æ³•ä¿è¯å¯¹åƒåœ¾æ”¶é›†å™¨çš„è°ƒç”¨ (é©¬ä¸Šè§¦å‘GC)
  * ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œåº”è¯¥è®©è™šæ‹Ÿæœºç®¡ç†å†…å­˜ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œæ— é¡»æ‰‹åŠ¨è§¦å‘ï¼›åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ€§èƒ½åŸºå‡†ï¼Œå¯ä»¥åœ¨è¿è¡Œä¹‹é—´è°ƒç”¨ System.gc() 

* è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼š

  * ä¸ºäº†é¿å…å¼•èµ·çš„ Full GCï¼Œåº”å½“å°½é‡ä¸è¦åˆ›å»ºè¿‡å¤§çš„å¯¹è±¡ä»¥åŠæ•°ç»„
  * é€šè¿‡ -Xmn è™šæ‹Ÿæœºå‚æ•°è°ƒå¤§æ–°ç”Ÿä»£çš„å¤§å°ï¼Œè®©å¯¹è±¡å°½é‡åœ¨æ–°ç”Ÿä»£è¢«å›æ”¶æ‰ï¼Œä¸è¿›å…¥è€å¹´ä»£ã€‚è¿˜å¯ä»¥é€šè¿‡ -XX:MaxTenuringThreshold è°ƒå¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„å¹´é¾„ï¼Œè®©å¯¹è±¡åœ¨æ–°ç”Ÿä»£å¤šå­˜æ´»ä¸€æ®µæ—¶é—´

* ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥

* JDK 1.7 åŠä»¥å‰çš„æ°¸ä¹…ä»£ï¼ˆæ–¹æ³•åŒºï¼‰ç©ºé—´ä¸è¶³

* Concurrent Mode Failureï¼š

  æ‰§è¡Œ CMS GC çš„è¿‡ç¨‹ä¸­åŒæ—¶æœ‰å¯¹è±¡è¦æ”¾å…¥è€å¹´ä»£ï¼Œè€Œæ­¤æ—¶è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼ˆå¯èƒ½æ˜¯ GC è¿‡ç¨‹ä¸­æµ®åŠ¨åƒåœ¾è¿‡å¤šå¯¼è‡´æš‚æ—¶æ€§çš„ç©ºé—´ä¸è¶³ï¼‰ï¼Œä¾¿ä¼šæŠ¥ Concurrent Mode Failure é”™è¯¯ï¼Œå¹¶è§¦å‘ Full GC

æ‰‹åŠ¨ GC æµ‹è¯•ï¼ŒVMå‚æ•°ï¼š`-XX:+PrintGcDetails`

```java
public void localvarGC1() {
    byte[] buffer = new byte[10 * 1024 * 1024];//10MB
    System.gc();	//è¾“å‡º: ä¸ä¼šè¢«å›æ”¶, FullGCæ—¶è¢«æ”¾å…¥è€å¹´ä»£
}

public void localvarGC2() {
    byte[] buffer = new byte[10 * 1024 * 1024];
    buffer = null;
    System.gc();	//è¾“å‡º: æ­£å¸¸è¢«å›æ”¶
}
 public void localvarGC3() {
     {
         byte[] buffer = new byte[10 * 1024 * 1024];
     }
     System.gc();	//è¾“å‡º: ä¸ä¼šè¢«å›æ”¶, FullGCæ—¶è¢«æ”¾å…¥è€å¹´ä»£
 }

public void localvarGC4() {
    {
        byte[] buffer = new byte[10 * 1024 * 1024];
    }
    int value = 10;
    System.gc();	//è¾“å‡º: æ­£å¸¸è¢«å›æ”¶ï¼Œslotå¤ç”¨ï¼Œå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸ bufferç½®ç©º
}
```



***



#### å®‰å…¨åŒºåŸŸ

å®‰å…¨ç‚¹ (Safepoint)ï¼šç¨‹åºæ‰§è¡Œæ—¶å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹ GCï¼Œåªæœ‰åœ¨å®‰å…¨ç‚¹æ‰èƒ½åœä¸‹

- Safe Point çš„é€‰æ‹©å¾ˆé‡è¦ï¼Œå¦‚æœå¤ªå°‘å¯èƒ½å¯¼è‡´ GC ç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå¤ªå¤šå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜
- å¤§éƒ¨åˆ†æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´éƒ½éå¸¸çŸ­ï¼Œé€šå¸¸ä¼šæ ¹æ®æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾ä¸ºæ ‡å‡†ï¼Œé€‰æ‹©äº›æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½œä¸º Safe Pointï¼Œ å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬å’Œå¼‚å¸¸è·³è½¬ç­‰

åœ¨ GC å‘ç”Ÿæ—¶ï¼Œè®©æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ä¸‹æ¥çš„æ–¹æ³•ï¼š

- æŠ¢å…ˆå¼ä¸­æ–­ï¼šæ²¡æœ‰è™šæ‹Ÿæœºé‡‡ç”¨ï¼Œé¦–å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼Œå¦‚æœæœ‰çº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±æ¢å¤çº¿ç¨‹è®©çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹
- ä¸»åŠ¨å¼ä¸­æ–­ï¼šè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œåˆ°å„ä¸ª Safe Point æ—¶å°±è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±è¿›è¡Œä¸­æ–­æŒ‚èµ·

é—®é¢˜ï¼šSafepoint ä¿è¯ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥ GC çš„ Safepointï¼Œä½†æ˜¯å½“çº¿ç¨‹å¤„äº Waiting çŠ¶æ€æˆ– Blocked çŠ¶æ€ï¼Œçº¿ç¨‹æ— æ³•å“åº” JVM çš„ä¸­æ–­è¯·æ±‚ï¼Œè¿è¡Œåˆ°å®‰å…¨ç‚¹å»ä¸­æ–­æŒ‚èµ·ï¼ŒJVM ä¹Ÿä¸å¯èƒ½ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œéœ€è¦å®‰å…¨åŒºåŸŸæ¥è§£å†³

å®‰å…¨åŒºåŸŸ (Safe Region)ï¼šæŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹ GC éƒ½æ˜¯å®‰å…¨çš„

è¿è¡Œæµç¨‹ï¼š

- å½“çº¿ç¨‹è¿è¡Œåˆ° Safe Region çš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº† Safe Regionï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”ŸGCï¼ŒJVM ä¼šå¿½ç•¥æ ‡è¯†ä¸º Safe Region çŠ¶æ€çš„çº¿ç¨‹

- å½“çº¿ç¨‹å³å°†ç¦»å¼€ Safe Region æ—¶ï¼Œä¼šæ£€æŸ¥ JVM æ˜¯å¦å·²ç»å®Œæˆ GCï¼Œå¦‚æœå®Œæˆäº†åˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…GC å®Œæˆï¼Œæ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€ SafeRegion çš„ä¿¡å·



***



### åƒåœ¾åˆ¤æ–­

#### åƒåœ¾ä»‹ç»

åƒåœ¾ï¼š**å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼•ç”¨æŒ‡å‘å®ƒäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ç°åœ¨å°±æ˜¯åƒåœ¾**

ä½œç”¨ï¼šé‡Šæ”¾æ²¡ç”¨çš„å¯¹è±¡ï¼Œæ¸…é™¤å†…å­˜é‡Œçš„è®°å½•ç¢ç‰‡ï¼Œç¢ç‰‡æ•´ç†å°†æ‰€å ç”¨çš„å †å†…å­˜ç§»åˆ°å †çš„ä¸€ç«¯ï¼Œä»¥ä¾¿JVM å°†æ•´ç†å‡ºçš„å†…å­˜åˆ†é…ç»™æ–°çš„å¯¹è±¡

åƒåœ¾æ”¶é›†ä¸»è¦æ˜¯é’ˆå¯¹å †å’Œæ–¹æ³•åŒºè¿›è¡Œï¼Œç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆè¿™ä¸‰ä¸ªåŒºåŸŸå±äºçº¿ç¨‹ç§æœ‰çš„ï¼Œåªå­˜åœ¨äºçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçº¿ç¨‹ç»“æŸä¹‹åå°±ä¼šæ¶ˆå¤±ï¼Œå› æ­¤ä¸éœ€è¦å¯¹è¿™ä¸‰ä¸ªåŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶

åœ¨å †é‡Œå­˜æ”¾ç€å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡å®ä¾‹ï¼Œåœ¨GCæ‰§è¡Œåƒåœ¾å›æ”¶ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦åŒºåˆ†å‡ºå†…å­˜ä¸­å“ªäº›æ˜¯å­˜æ´»å¯¹è±¡ï¼Œå“ªäº›æ˜¯å·²ç»æ­»äº¡çš„å¯¹è±¡ã€‚åªæœ‰è¢«æ ‡è®°ä¸ºå·±ç»æ­»äº¡çš„å¯¹è±¡ï¼ŒGCæ‰ä¼šåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œé‡Šæ”¾æ‰å…¶æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç§°ä¸ºåƒåœ¾æ ‡è®°é˜¶æ®µï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š**å¼•ç”¨è®¡æ•°ç®—æ³•**å’Œ**å¯è¾¾æ€§åˆ†æç®—æ³•**



***



#### å¼•ç”¨è®¡æ•°æ³•

å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰ï¼šå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ï¼Œç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚å¯¹äºä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„å¼•ç”¨è®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡1ï¼›å½“å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ï¼ˆJavaæ²¡æœ‰é‡‡ç”¨ï¼‰

ä¼˜ç‚¹ï¼š

- å›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ï¼Œæ— éœ€ç­‰åˆ°å†…å­˜ä¸å¤Ÿçš„æ—¶å€™æ‰å¼€å§‹å›æ”¶ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡è®¡æ•°å™¨æ˜¯å¦ä¸º0ï¼Œå¯ä»¥ç›´æ¥å›æ”¶
- åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æ— éœ€æŒ‚èµ·ï¼›å¦‚æœç”³è¯·å†…å­˜æ—¶ï¼Œå†…å­˜ä¸è¶³ï¼Œåˆ™ç«‹åˆ»æŠ¥OOMé”™è¯¯ã€‚
- åŒºåŸŸæ€§ï¼Œæ›´æ–°å¯¹è±¡çš„è®¡æ•°å™¨æ—¶ï¼Œåªæ˜¯å½±å“åˆ°è¯¥å¯¹è±¡ï¼Œä¸ä¼šæ‰«æå…¨éƒ¨å¯¹è±¡

ç¼ºç‚¹ï¼š

- æ¯æ¬¡å¯¹è±¡è¢«å¼•ç”¨æ—¶ï¼Œéƒ½éœ€è¦å»æ›´æ–°è®¡æ•°å™¨ï¼Œæœ‰ä¸€ç‚¹æ—¶é—´å¼€é”€ã€‚ 

- æµªè´¹CPUèµ„æºï¼Œå³ä½¿å†…å­˜å¤Ÿç”¨ï¼Œä»ç„¶åœ¨è¿è¡Œæ—¶è¿›è¡Œè®¡æ•°å™¨çš„ç»Ÿè®¡ã€‚

- **æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œä¼šå¼•å‘å†…å­˜æ³„éœ²**ï¼ˆæœ€å¤§çš„ç¼ºç‚¹ï¼‰

  å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰ï¼šæ˜¯æŒ‡ç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœ

  ```java
  public class Test {
      public Object instance = null;
      public static void main(String[] args) {
          Test a = new Test();// a = 1
          Test b = new Test();// b = 1
          a.instance = b;		// b = 2
          b.instance = a;		// a = 2
          a = null;			// a = 1
          b = null;			// b = 1
      }
  }
  ```

![](https://gitee.com/seazean/images/raw/master/Java/JVM-å¾ªç¯å¼•ç”¨.png)



***



#### å¯è¾¾æ€§åˆ†æ

##### GC Roots

å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šä¹Ÿå¯ä»¥ç§°ä¸ºæ ¹æœç´¢ç®—æ³•ã€è¿½è¸ªæ€§åƒåœ¾æ”¶é›†

**GC Rootså¯¹è±¡**ï¼š

- è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼šå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰
- æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
- å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆstring Tableï¼‰é‡Œçš„å¼•ç”¨
- åŒæ­¥é” synchronized æŒæœ‰çš„å¯¹è±¡

GC Rootsè¯´æ˜ï¼š

* **GC Rootsæ˜¯ä¸€ç»„æ´»è·ƒçš„å¼•ç”¨ï¼Œä¸æ˜¯å¯¹è±¡**ï¼Œæ”¾åœ¨ GC Roots Set é›†åˆ
* å¦‚æœä¸€ä¸ªæŒ‡é’ˆä¿å­˜äº†å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œä½†è‡ªå·±ä¸åœ¨å †å†…å­˜ä¸­ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªRoot



***



##### å·¥ä½œåŸç†

å¯è¾¾æ€§åˆ†æç®—æ³•ä»¥**æ ¹å¯¹è±¡é›†åˆï¼ˆGCRootsï¼‰**ä¸ºèµ·å§‹ç‚¹ï¼Œä»ä¸Šè‡³ä¸‹çš„æ–¹å¼æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡

åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ä¿éšœ**ä¸€è‡´æ€§çš„å¿«ç…§**ä¸­è¿›è¡Œï¼Œå¦åˆ™ç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯ï¼Œè¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´ GC è¿›è¡Œæ—¶å¿…é¡» Stop The World çš„ä¸€ä¸ªé‡è¦åŸå› 

åŸºæœ¬åŸç†ï¼š

- å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾

- å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·±ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°ä¸ºåƒåœ¾å¯¹è±¡

- åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡

  <img src="https://gitee.com/seazean/images/raw/master/Java/JVM-å¯è¾¾æ€§åˆ†æç®—æ³•.png" style="zoom: 50%;" />



***



##### ä¸‰è‰²æ ‡è®°

###### æ ‡è®°ç®—æ³•

ä¸‰è‰²æ ‡è®°æ³•æŠŠéå†å¯¹è±¡å›¾è¿‡ç¨‹ä¸­é‡åˆ°çš„å¯¹è±¡ï¼ŒæŒ‰â€œæ˜¯å¦è®¿é—®è¿‡â€è¿™ä¸ªæ¡ä»¶æ ‡è®°æˆä»¥ä¸‹ä¸‰ç§é¢œè‰²ï¼š

- ç™½è‰²ï¼šå°šæœªè®¿é—®è¿‡
- ç°è‰²ï¼šæœ¬å¯¹è±¡å·²è®¿é—®è¿‡ï¼Œä½†æ˜¯æœ¬å¯¹è±¡å¼•ç”¨åˆ°çš„å…¶ä»–å¯¹è±¡å°šæœªå…¨éƒ¨è®¿é—®
- é»‘è‰²ï¼šæœ¬å¯¹è±¡å·²è®¿é—®è¿‡ï¼Œè€Œä¸”æœ¬å¯¹è±¡å¼•ç”¨åˆ°çš„å…¶ä»–å¯¹è±¡ä¹Ÿå…¨éƒ¨è®¿é—®å®Œæˆ

å½“ Stop The World (STW) æ—¶ï¼Œå¯¹è±¡é—´çš„å¼•ç”¨æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œå¯ä»¥è½»æ¾å®Œæˆæ ‡è®°ï¼Œéå†è®¿é—®è¿‡ç¨‹ä¸ºï¼š

1. åˆå§‹æ—¶ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½åœ¨ç™½è‰²é›†åˆ
2. å°† GC Roots ç›´æ¥å¼•ç”¨åˆ°çš„å¯¹è±¡æŒªåˆ°ç°è‰²é›†åˆ
3. ä»ç°è‰²é›†åˆä¸­è·å–å¯¹è±¡ï¼š
   * å°†æœ¬å¯¹è±¡å¼•ç”¨åˆ°çš„å…¶ä»–å¯¹è±¡å…¨éƒ¨æŒªåˆ°ç°è‰²é›†åˆä¸­
   * å°†æœ¬å¯¹è±¡æŒªåˆ°é»‘è‰²é›†åˆé‡Œé¢
4. é‡å¤æ­¥éª¤3ï¼Œç›´è‡³ç°è‰²é›†åˆä¸ºç©ºæ—¶ç»“æŸ
5. ç»“æŸåï¼Œä»åœ¨ç™½è‰²é›†åˆçš„å¯¹è±¡å³ä¸º GC Roots ä¸å¯è¾¾ï¼Œå¯ä»¥è¿›è¡Œå›æ”¶

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-ä¸‰è‰²æ ‡è®°æ³•è¿‡ç¨‹.gif" style="zoom: 67%;" />



å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/12544c0ad5c1



****



###### å¹¶å‘æ ‡è®°

å¹¶å‘æ ‡è®°æ—¶ï¼Œå¯¹è±¡é—´çš„å¼•ç”¨å¯èƒ½å‘ç”Ÿå˜åŒ–**ï¼Œ**å¤šæ ‡å’Œæ¼æ ‡çš„æƒ…å†µå°±æœ‰å¯èƒ½å‘ç”Ÿ

**å¤šæ ‡æƒ…å†µï¼š**å½“Eå˜ä¸ºç°è‰²æˆ–é»‘è‰²æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ–­å¼€çš„ D å¯¹ E çš„å¼•ç”¨ï¼Œå¯¼è‡´è¿™éƒ¨åˆ†å¯¹è±¡ä»ä¼šè¢«æ ‡è®°ä¸ºå­˜æ´»ï¼Œæœ¬è½® GC ä¸ä¼šå›æ”¶è¿™éƒ¨åˆ†å†…å­˜ï¼Œè¿™éƒ¨åˆ†æœ¬åº”è¯¥å›æ”¶ä½†æ˜¯æ²¡æœ‰å›æ”¶åˆ°çš„å†…å­˜ï¼Œè¢«ç§°ä¹‹ä¸º**æµ®åŠ¨åƒåœ¾**

* é’ˆå¯¹å¹¶å‘æ ‡è®°å¼€å§‹åçš„**æ–°å¯¹è±¡**ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ç›´æ¥å…¨éƒ¨å½“æˆé»‘è‰²ï¼Œä¹Ÿç®—æµ®åŠ¨åƒåœ¾
* æµ®åŠ¨åƒåœ¾å¹¶ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œåªæ˜¯éœ€è¦ç­‰åˆ°ä¸‹ä¸€è½®åƒåœ¾å›æ”¶ä¸­æ‰è¢«æ¸…é™¤

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-ä¸‰è‰²æ ‡è®°æ³•å¤šæ ‡æƒ…å†µ.png" style="zoom: 50%;" />

**æ¼æ ‡æƒ…å†µï¼š**

* æ¡ä»¶ä¸€ï¼šç°è‰²å¯¹è±¡æ–­å¼€äº†å¯¹ä¸€ä¸ªç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼ˆç›´æ¥æˆ–é—´æ¥ï¼‰ï¼Œå³ç°è‰²å¯¹è±¡åŸæˆå‘˜å˜é‡çš„å¼•ç”¨å‘ç”Ÿäº†å˜åŒ–
* æ¡ä»¶äºŒï¼šå…¶ä»–çº¿ç¨‹ä¸­ä¿®æ”¹äº†é»‘è‰²å¯¹è±¡ï¼Œæ’å…¥äº†ä¸€æ¡æˆ–å¤šæ¡å¯¹è¯¥ç™½è‰²å¯¹è±¡çš„æ–°å¼•ç”¨
* ç»“æœï¼šå¯¼è‡´è¯¥ç™½è‰²å¯¹è±¡å½“ä½œåƒåœ¾è¢«GCï¼Œå½±å“åˆ°äº†åº”ç”¨ç¨‹åºçš„æ­£ç¡®æ€§

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-ä¸‰è‰²æ ‡è®°æ³•æ¼æ ‡æƒ…å†µ.png" style="zoom:50%;" />

ä»£ç è§’åº¦è§£é‡Šæ¼æ ‡ï¼š

```java
Object G = objE.fieldG; // è¯»
objE.fieldG = null;  	// å†™
objD.fieldG = G;     	// å†™
```

ä¸ºäº†è§£å†³é—®é¢˜ï¼Œå¯ä»¥æ“ä½œä¸Šé¢ä¸‰æ­¥ï¼Œ**å°†å¯¹è±¡Gè®°å½•èµ·æ¥ï¼Œç„¶åä½œä¸ºç°è‰²å¯¹è±¡å†è¿›è¡Œéå†**ï¼Œæ¯”å¦‚æ”¾åˆ°ä¸€ä¸ªç‰¹å®šçš„é›†åˆï¼Œç­‰åˆå§‹çš„ GC Rootséå†å®Œï¼ˆå¹¶å‘æ ‡è®°ï¼‰ï¼Œå†éå†è¯¥é›†åˆï¼ˆé‡æ–°æ ‡è®°ï¼‰

> æ‰€ä»¥é‡æ–°æ ‡è®°éœ€è¦STWï¼Œåº”ç”¨ç¨‹åºä¸€ç›´åœ¨è¿è¡Œï¼Œè¯¥é›†åˆå¯èƒ½ä¼šä¸€ç›´å¢åŠ æ–°çš„å¯¹è±¡ï¼Œå¯¼è‡´æ°¸è¿œéƒ½è¿è¡Œä¸å®Œ

è§£å†³æ–¹æ³•ï¼šæ·»åŠ è¯»å†™å±éšœï¼Œè¯»å±éšœæ‹¦æˆªç¬¬ä¸€æ­¥ï¼Œå†™å±éšœæ‹¦æˆªç¬¬äºŒä¸‰æ­¥ï¼Œåœ¨è¯»å†™å‰åè¿›è¡Œä¸€äº›åç½®å¤„ç†ï¼š

* **å†™å±éšœ + å¢é‡æ›´æ–°**ï¼šé»‘è‰²å¯¹è±¡æ–°å¢å¼•ç”¨ï¼Œä¼šå°†é»‘è‰²å¯¹è±¡å˜æˆç°è‰²å¯¹è±¡ï¼Œæœ€åå¯¹è¯¥èŠ‚èŠ‚ç‚¹é‡æ–°æ‰«æ

  å¢é‡æ›´æ–° (Incremental Update) ç ´åäº†æ¡ä»¶äºŒï¼Œä»è€Œä¿è¯äº†ä¸ä¼šæ¼æ ‡

  ç¼ºç‚¹ï¼šå¯¹é»‘è‰²å˜ç°çš„å¯¹è±¡é‡æ–°æ‰«ææ‰€æœ‰å¼•ç”¨ï¼Œæ¯”è¾ƒè€—è´¹æ—¶é—´

* **å†™å±éšœ (Store Barrier) + SATB**ï¼šå½“åŸæ¥æˆå‘˜å˜é‡çš„å¼•ç”¨å‘ç”Ÿå˜åŒ–ä¹‹å‰ï¼Œè®°å½•ä¸‹åŸæ¥çš„å¼•ç”¨å¯¹è±¡

  ä¿ç•™ GC å¼€å§‹æ—¶çš„å¯¹è±¡å›¾ï¼Œå³åŸå§‹å¿«ç…§ SATBï¼Œå½“ GC Roots ç¡®å®šåï¼Œå¯¹è±¡å›¾å°±å·²ç»ç¡®å®šï¼Œé‚£åç»­çš„æ ‡è®°ä¹Ÿåº”è¯¥æ˜¯æŒ‰ç…§è¿™ä¸ªæ—¶åˆ»çš„å¯¹è±¡å›¾èµ°ï¼Œå¦‚æœæœŸé—´å¯¹ç™½è‰²å¯¹è±¡æœ‰äº†æ–°çš„å¼•ç”¨ä¼šè®°å½•ä¸‹æ¥ï¼Œå¹¶ä¸”å°†ç™½è‰²å¯¹è±¡å˜ç°ï¼Œé‡æ–°æ‰«æè¯¥å¯¹è±¡

  SATB (Snapshot At The Beginning) ç ´åäº†æ¡ä»¶ä¸€ï¼Œä»è€Œä¿è¯äº†ä¸ä¼šæ¼æ ‡

* **è¯»å±éšœ (Load Barrier)**ï¼šç ´åæ¡ä»¶äºŒï¼Œé»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡çš„å‰ææ˜¯è·å–åˆ°è¯¥å¯¹è±¡ï¼Œæ­¤æ—¶è¯»å±éšœå‘æŒ¥ä½œç”¨

ä»¥ Java HotSpot VM ä¸ºä¾‹ï¼Œå…¶å¹¶å‘æ ‡è®°æ—¶å¯¹æ¼æ ‡çš„å¤„ç†æ–¹æ¡ˆå¦‚ä¸‹ï¼š

- CMSï¼šå†™å±éšœ + å¢é‡æ›´æ–°
- G1ï¼šå†™å±éšœ + SATB
- ZGCï¼šè¯»å±éšœ



***



#### finalization

Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘

åƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œfinalize() æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œåç½®å¤„ç†ï¼Œé€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†ï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰

ç”Ÿå­˜ORæ­»äº¡ï¼šå¦‚æœä»æ‰€æœ‰çš„æ ¹èŠ‚ç‚¹éƒ½æ— æ³•è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œè¯´æ˜å¯¹è±¡å·±ç»ä¸å†ä½¿ç”¨ï¼Œæ­¤å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚ä½†äº‹å®ä¸Šè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€ç¼“åˆ‘â€œé˜¶æ®µã€‚**ä¸€ä¸ªæ— æ³•è§¦åŠçš„å¯¹è±¡æœ‰å¯èƒ½åœ¨æŸä¸€ä¸ªæ¡ä»¶ä¸‹â€œå¤æ´»â€è‡ªå·±**ï¼Œå¦‚æœè¿™æ ·å¯¹å®ƒçš„å›æ”¶å°±æ˜¯ä¸åˆç†çš„ï¼Œæ‰€ä»¥è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡å¯èƒ½çš„ä¸‰ç§çŠ¶æ€ï¼š

- å¯è§¦åŠçš„ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯ä»¥åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ã€‚
- å¯å¤æ´»çš„ï¼šå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¯èƒ½åœ¨finalize() ä¸­å¤æ´»
- ä¸å¯è§¦åŠçš„ï¼šå¯¹è±¡çš„ finalize() è¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰å¤æ´»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€ï¼Œä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½è¢«å¤æ´»ã€‚å› ä¸º**finalize()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡**ï¼Œç­‰åˆ°è¿™ä¸ªå¯¹è±¡å†è¢«æ ‡è®°ä¸ºå¯å›æ”¶æ—¶å°±å¿…é¡»å›æ”¶

æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œåº”è¯¥äº¤ç»™åƒåœ¾å›æ”¶æœºåˆ¶è°ƒç”¨ï¼ŒåŸå› ï¼š

* finalize() æ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»
* finalize() æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®Œå…¨ç”±GCçº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”ŸGCï¼Œåˆ™finalize()æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šï¼Œå› ä¸ºä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œå³ä½¿ä¸»åŠ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå› æ­¤å°±ç›´æ¥è¿›è¡Œå›æ”¶
* ä¸€ä¸ªç³Ÿç³•çš„finalize() ä¼šä¸¥é‡å½±å“GCçš„æ€§èƒ½



***



#### å¼•ç”¨åˆ†æ

æ— è®ºæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†æç®—æ³•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è¾¾ï¼Œåˆ¤å®šå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶éƒ½ä¸å¼•ç”¨æœ‰å…³ï¼ŒJava æä¾›äº†å››ç§å¼ºåº¦ä¸åŒçš„å¼•ç”¨ç±»å‹

1. å¼ºå¼•ç”¨ï¼šè¢«å¼ºå¼•ç”¨å…³è”çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ï¼Œåªæœ‰æ‰€æœ‰GCRootséƒ½ä¸é€šè¿‡å¼ºå¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡ï¼Œæ‰èƒ½è¢«åƒåœ¾å›æ”¶

   * å¼ºå¼•ç”¨å¯ä»¥ç›´æ¥è®¿é—®ç›®æ ‡å¯¹è±¡
   * è™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOOMå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå›æ”¶å¼ºå¼•ç”¨æ‰€æŒ‡å‘å¯¹è±¡
   * å¼ºå¼•ç”¨å¯èƒ½å¯¼è‡´**å†…å­˜æ³„æ¼**

   ```java
   Object obj = new Object();//ä½¿ç”¨ new ä¸€ä¸ªæ–°å¯¹è±¡çš„æ–¹å¼æ¥åˆ›å»ºå¼ºå¼•ç”¨
   ```

2. è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šè¢«è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åªæœ‰åœ¨å†…å­˜ä¸å¤Ÿçš„æƒ…å†µä¸‹æ‰ä¼šè¢«å›æ”¶

   * **ä»…ï¼ˆå¯èƒ½æœ‰å¼ºå¼•ç”¨ï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«å¤šä¸ªå¼•ç”¨ï¼‰**æœ‰è½¯å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶åï¼Œå†…å­˜ä»ä¸è¶³æ—¶ä¼šå†æ¬¡å‡ºå‘åƒåœ¾å›æ”¶ï¼Œå›æ”¶è½¯å¼•ç”¨å¯¹è±¡
   * é…åˆ**å¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾è½¯å¼•ç”¨è‡ªèº«**ï¼Œåœ¨æ„é€ è½¯å¼•ç”¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œå½“è½¯å¼•ç”¨å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œå°±ä¼šåŠ å…¥æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œé€šè¿‡è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å›æ”¶æƒ…å†µ
   * è½¯å¼•ç”¨é€šå¸¸ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼›å¦‚æœè¿˜æœ‰ç©ºé—²å†…å­˜ï¼Œå°±å¯ä»¥æš‚æ—¶ä¿ç•™ç¼“å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶æ¸…ç†æ‰ï¼Œè¿™æ ·å°±ä¿è¯äº†ä½¿ç”¨ç¼“å­˜çš„åŒæ—¶ä¸ä¼šè€—å°½å†…å­˜

   ```java
   Object obj = new Object();
   SoftReference<Object> sf = new SoftReference<Object>(obj);
   obj = null;  // ä½¿å¯¹è±¡åªè¢«è½¯å¼•ç”¨å…³è”
   ```

3. å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ä¸€å®šä¼šè¢«å›æ”¶ï¼Œåªèƒ½å­˜æ´»åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶å‘ç”Ÿä¹‹å‰

   * ä»…æœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶å¼±å¼•ç”¨å¯¹è±¡
   * é…åˆå¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾å¼±å¼•ç”¨è‡ªèº«
   * WeakHashMapç”¨æ¥å­˜å‚¨å›¾ç‰‡ä¿¡æ¯ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸è¶³çš„æ—¶å€™åŠæ—¶å›æ”¶ï¼Œé¿å…äº†OOM

   ```java
   Object obj = new Object();
   WeakReference<Object> wf = new WeakReference<Object>(obj);
   obj = null;
   ```

4. è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€æˆ–è€…â€œå¹»å½±å¼•ç”¨â€ï¼Œæ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹ä¸­æœ€å¼±çš„ä¸€ä¸ª

   * ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´é€ æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨å¾—åˆ°ä¸€ä¸ªå¯¹è±¡
   * ä¸ºå¯¹è±¡è®¾ç½®è™šå¼•ç”¨çš„å”¯ä¸€ç›®çš„æ˜¯åœ¨äºè·Ÿè¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼Œèƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥
   * å¿…é¡»é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ï¼Œä¸»è¦é…åˆ ByteBuffer ä½¿ç”¨ï¼Œè¢«å¼•ç”¨å¯¹è±¡å›æ”¶æ—¶ä¼šå°†è™šå¼•ç”¨å…¥é˜Ÿï¼Œç”± Reference Handler çº¿ç¨‹è°ƒç”¨è™šå¼•ç”¨ç›¸å…³æ–¹æ³•é‡Šæ”¾ç›´æ¥å†…å­˜

   ```java
   Object obj = new Object();
   PhantomReference<Object> pf = new PhantomReference<Object>(obj, null);
   obj = null;
   ```

5. ç»ˆç»“å™¨å¼•ç”¨ï¼ˆfinalizationï¼‰

 å¼•ç”¨çš„å››ç§çŠ¶æ€ï¼š

* Activeï¼šæ¿€æ´»ï¼Œåˆ›å»º ref å¯¹è±¡æ—¶å°±æ˜¯æ¿€æ´»çŠ¶æ€
* Pendingï¼šç­‰å¾…å…¥é˜Ÿï¼Œæ‰€å¯¹åº”çš„å¼ºå¼•ç”¨è¢«GCï¼Œå°±è¦è¿›å…¥å¼•ç”¨é˜Ÿåˆ—
* Enqueuedï¼šå…¥é˜Ÿäº†
  * å¦‚æœæŒ‡å®šäº† refQueueï¼Œpending ç§»åŠ¨åˆ° enqueued çŠ¶æ€ï¼ŒrefQueue.poll æ—¶è¿›å…¥å¤±æ•ˆçŠ¶æ€
  * å¦‚æœæ²¡æœ‰æŒ‡å®š refQueueï¼Œç›´æ¥åˆ°å¤±æ•ˆçŠ¶æ€
* Inactiveï¼šå¤±æ•ˆ



***



#### æ— ç”¨ç±»

æ–¹æ³•åŒºä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»

åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯æ— ç”¨çš„ç±»ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ 3 ä¸ªæ¡ä»¶ ï¼š

- è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹
- åŠ è½½è¯¥ç±»çš„`ClassLoader`å·²ç»è¢«å›æ”¶
- è¯¥ç±»å¯¹åº”çš„`java.lang.Class`å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•

è™šæ‹Ÿæœºå¯ä»¥å¯¹æ»¡è¶³ä¸Šè¿° 3 ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ä¸ä½¿ç”¨äº†å°±ä¼šå¿…ç„¶è¢«å›æ”¶



***



### å›æ”¶ç®—æ³•

#### æ ‡è®°æ¸…é™¤

å½“æˆåŠŸåŒºåˆ†å‡ºå†…å­˜ä¸­å­˜æ´»å¯¹è±¡å’Œæ­»äº¡å¯¹è±¡åï¼ŒGCæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œé‡Šæ”¾æ‰æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚ç›®å‰åœ¨JVMä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‰ç§åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯

- æ ‡è®°æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰
- å¤åˆ¶ç®—æ³•ï¼ˆcopyingï¼‰
- æ ‡è®°å‹ç¼©ç®—æ³•ï¼ˆMark-Compactï¼‰

æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œæ˜¯å°†åƒåœ¾å›æ”¶åˆ†ä¸º2ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯**æ ‡è®°å’Œæ¸…é™¤**

- **æ ‡è®°**ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œ**æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡**ï¼Œä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ï¼Œ**æ ‡è®°çš„æ˜¯å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸æ˜¯åƒåœ¾**
- **æ¸…é™¤**ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶ï¼ŒæŠŠåˆ†å—è¿æ¥åˆ° â€œ**ç©ºé—²åˆ—è¡¨**â€ çš„å•å‘é“¾è¡¨ï¼Œåˆ¤æ–­å›æ”¶åçš„åˆ†å—ä¸å‰ä¸€ä¸ªç©ºé—²åˆ†å—æ˜¯å¦è¿ç»­ï¼Œè‹¥è¿ç»­ä¼šåˆå¹¶è¿™ä¸¤ä¸ªåˆ†å—ï¼Œä¹‹åè¿›è¡Œåˆ†é…æ—¶åªéœ€è¦éå†è¿™ä¸ªç©ºé—²åˆ—è¡¨ï¼Œå°±å¯ä»¥æ‰¾åˆ°åˆ†å—

- **åˆ†é…é˜¶æ®µ**ï¼šç¨‹åºä¼šæœç´¢ç©ºé—²é“¾è¡¨å¯»æ‰¾ç©ºé—´å¤§äºç­‰äºæ–°å¯¹è±¡å¤§å° size çš„å— blockï¼Œå¦‚æœæ‰¾åˆ°çš„å—ç­‰äº sizeï¼Œä¼šç›´æ¥è¿”å›è¿™ä¸ªåˆ†å—ï¼›å¦‚æœæ‰¾åˆ°çš„å—å¤§äº sizeï¼Œä¼šå°†å—åˆ†å‰²æˆå¤§å°ä¸º size ä¸ (block - size) çš„ä¸¤éƒ¨åˆ†ï¼Œè¿”å›å¤§å°ä¸º size çš„åˆ†å—ï¼Œå¹¶æŠŠå¤§å°ä¸º (block - size) çš„å—è¿”å›ç»™ç©ºé—²åˆ—è¡¨

ç®—æ³•ç¼ºç‚¹ï¼š

- æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹æ•ˆç‡éƒ½ä¸é«˜
- ä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´æ— æ³•ç»™å¤§å¯¹è±¡åˆ†é…å†…å­˜ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²é“¾è¡¨

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æ ‡è®°æ¸…é™¤ç®—æ³•.png" style="zoom: 67%;" />



***



#### å¤åˆ¶ç®—æ³•

å¤åˆ¶ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯ï¼Œ**å°†åŸæœ‰çš„å†…å­˜ç©ºé—´ä¸€åˆ†ä¸ºäºŒï¼Œæ¯æ¬¡åªç”¨å…¶ä¸­çš„ä¸€å—**ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œå°†æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜ç©ºé—´ä¸­ï¼Œç„¶åå°†è¯¥å†…å­˜ç©ºé—´æ¸…ç†ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œå®Œæˆåƒåœ¾çš„å›æ”¶

åº”ç”¨åœºæ™¯ï¼šå¦‚æœå†…å­˜ä¸­çš„åƒåœ¾å¯¹è±¡è¾ƒå¤šï¼Œéœ€è¦å¤åˆ¶çš„å¯¹è±¡å°±è¾ƒå°‘ï¼Œè¿™ç§æƒ…å†µä¸‹é€‚åˆä½¿ç”¨è¯¥æ–¹å¼å¹¶ä¸”æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œåä¹‹ï¼Œåˆ™ä¸é€‚åˆ

![](https://gitee.com/seazean/images/raw/master/Java/JVM-å¤åˆ¶ç®—æ³•.png)

ç®—æ³•ä¼˜ç‚¹ï¼š

- æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆ
- å¤åˆ¶è¿‡å»ä»¥åä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°â€œç¢ç‰‡â€é—®é¢˜ã€‚

ç®—æ³•ç¼ºç‚¹ï¼š

- ä¸»è¦ä¸è¶³æ˜¯**åªä½¿ç”¨äº†å†…å­˜çš„ä¸€åŠ**
- å¯¹äºG1è¿™ç§åˆ†æ‹†æˆä¸ºå¤§é‡regionçš„GCï¼Œå¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€GCéœ€è¦ç»´æŠ¤regionä¹‹é—´å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œä¸ç®¡æ˜¯å†…å­˜å ç”¨æˆ–è€…æ—¶é—´å¼€é”€éƒ½ä¸å°

ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½é‡‡ç”¨è¿™ç§æ”¶é›†ç®—æ³•å›æ”¶æ–°ç”Ÿä»£ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œè€Œæ˜¯ä¸€å—è¾ƒå¤§çš„ Eden ç©ºé—´å’Œä¸¤å—è¾ƒå°çš„ Survivor ç©ºé—´



***



#### æ ‡è®°æ•´ç†

æ ‡è®°æ•´ç†ï¼ˆå‹ç¼©ï¼‰ç®—æ³•æ˜¯åœ¨æ ‡è®°æ¸…é™¤ç®—æ³•çš„åŸºç¡€ä¹‹ä¸Šï¼Œåšäº†ä¼˜åŒ–æ”¹è¿›çš„ç®—æ³•

æ ‡è®°é˜¶æ®µå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯¹å¯¹è±¡çš„å¼•ç”¨è¿›è¡Œæ ‡è®°ï¼Œåœ¨æ¸…ç†é˜¶æ®µï¼Œå¹¶ä¸æ˜¯ç®€å•çš„ç›´æ¥æ¸…ç†å¯å›æ”¶å¯¹è±¡ï¼Œè€Œæ˜¯å°†å­˜æ´»å¯¹è±¡éƒ½å‘å†…å­˜å¦ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åæ¸…ç†è¾¹ç•Œä»¥å¤–çš„åƒåœ¾ï¼Œä»è€Œ**è§£å†³äº†ç¢ç‰‡åŒ–**çš„é—®é¢˜

ä¼˜ç‚¹ï¼šä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡

ç¼ºç‚¹ï¼šéœ€è¦ç§»åŠ¨å¤§é‡å¯¹è±¡ï¼Œå¤„ç†æ•ˆç‡æ¯”è¾ƒä½

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æ ‡è®°æ•´ç†ç®—æ³•.png" style="zoom:67%;" />

|          | Mark-Sweep       | Mark-Compact   | Copying                             |
| -------- | ---------------- | -------------- | ----------------------------------- |
| é€Ÿåº¦     | ä¸­ç­‰             | æœ€æ…¢           | æœ€å¿«                                |
| ç©ºé—´å¼€é”€ | å°‘(ä½†ä¼šå †ç§¯ç¢ç‰‡) | å°‘(ä¸å †ç§¯ç¢ç‰‡) | é€šå¸¸éœ€è¦æ´»å¯¹è±¡çš„2å€å¤§å°(ä¸å †ç§¯ç¢ç‰‡) |
| ç§»åŠ¨å¯¹è±¡ | å¦               | æ˜¯             | æ˜¯                                  |

- æ•ˆç‡ä¸Šæ¥è¯´ï¼Œå¤åˆ¶ç®—æ³•æ˜¯å½“ä¹‹æ— æ„§çš„è€å¤§ï¼Œä½†æ˜¯å´æµªè´¹äº†å¤ªå¤šå†…å­˜ã€‚
- ä¸ºäº†å°½é‡å…¼é¡¾ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæ ‡è®°ä¸€æ•´ç†ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¹³æ»‘ä¸€äº›



***



#### å¢é‡æ”¶é›†

å¢é‡æ”¶é›†ç®—æ³•ï¼šé€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œï¼ŒåŸºç¡€ä»æ˜¯æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ï¼Œç”¨äºå¤šçº¿ç¨‹å¹¶å‘ç¯å¢ƒ

å·¥ä½œåŸç†ï¼šå¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œå½±å“ç³»ç»Ÿçš„äº¤äº’æ€§ï¼Œæ‰€ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†çº¿ç¨‹åªæ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œä¾æ¬¡åå¤ç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆ

ç¼ºç‚¹ï¼šçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡è½¬æ¢æ¶ˆè€—èµ„æºï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™





***



### åƒåœ¾å›æ”¶å™¨

#### æ¦‚è¿°

åƒåœ¾æ”¶é›†å™¨åˆ†ç±»ï¼š

* æŒ‰çº¿ç¨‹æ•°åˆ†ï¼ˆåƒåœ¾å›æ”¶çº¿ç¨‹æ•°ï¼‰ï¼Œå¯ä»¥åˆ†ä¸ºä¸²è¡Œåƒåœ¾å›æ”¶å™¨å’Œå¹¶è¡Œåƒåœ¾å›æ”¶å™¨
  * é™¤äº† CMS å’Œ G1 ä¹‹å¤–ï¼Œå…¶å®ƒåƒåœ¾æ”¶é›†å™¨éƒ½æ˜¯ä»¥ä¸²è¡Œçš„æ–¹å¼æ‰§è¡Œ
* æŒ‰ç…§å·¥ä½œæ¨¡å¼åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºå¹¶å‘å¼åƒåœ¾å›æ”¶å™¨å’Œç‹¬å å¼åƒåœ¾å›æ”¶å™¨
  * å¹¶å‘å¼åƒåœ¾å›æ”¶å™¨ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿å·¥ä½œï¼Œä»¥å°½å¯èƒ½å‡å°‘åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´
  * ç‹¬å å¼åƒåœ¾å›æ”¶å™¨ï¼ˆStop the worldï¼‰ä¸€æ—¦è¿è¡Œï¼Œå°±åœæ­¢åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾å›æ”¶è¿‡ç¨‹å®Œå…¨ç»“æŸ
* æŒ‰ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†ï¼Œå¯åˆ†ä¸ºå‹ç¼©å¼åƒåœ¾å›æ”¶å™¨å’Œéå‹ç¼©å¼åƒåœ¾å›æ”¶å™¨
  * å‹ç¼©å¼åƒåœ¾å›æ”¶å™¨åœ¨å›æ”¶å®Œæˆåè¿›è¡Œå‹ç¼©æ•´ç†ï¼Œæ¶ˆé™¤å›æ”¶åçš„ç¢ç‰‡ï¼Œå†åˆ†é…å¯¹è±¡ç©ºé—´ä½¿ç”¨æŒ‡é’ˆç¢°æ’
  * éå‹ç¼©å¼çš„åƒåœ¾å›æ”¶å™¨ä¸è¿›è¡Œè¿™æ­¥æ“ä½œï¼Œå†åˆ†é…å¯¹è±¡ç©ºé—´ä½¿ç”¨ç©ºé—²åˆ—è¡¨
* æŒ‰å·¥ä½œçš„å†…å­˜åŒºé—´åˆ†ï¼Œåˆå¯åˆ†ä¸ºå¹´è½»ä»£åƒåœ¾å›æ”¶å™¨å’Œè€å¹´ä»£åƒåœ¾å›æ”¶å™¨

GCæ€§èƒ½æŒ‡æ ‡ï¼š

- **ååé‡**ï¼šç¨‹åºçš„è¿è¡Œæ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ï¼ˆæ€»è¿è¡Œæ—¶é—´ = ç¨‹åºçš„è¿è¡Œæ—¶é—´ + å†…å­˜å›æ”¶çš„æ—¶é—´ï¼‰
- åƒåœ¾æ”¶é›†å¼€é”€ï¼šååé‡çš„è¡¥æ•°ï¼Œåƒåœ¾æ”¶é›†æ‰€ç”¨æ—¶é—´ä¸æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹
- **æš‚åœæ—¶é—´**ï¼šæ‰§è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹è¢«æš‚åœçš„æ—¶é—´
- **æ”¶é›†é¢‘ç‡**ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œæ”¶é›†æ“ä½œå‘ç”Ÿçš„é¢‘ç‡
- **å†…å­˜å ç”¨**ï¼šJava å †åŒºæ‰€å çš„å†…å­˜å¤§å°
- å¿«é€Ÿï¼šä¸€ä¸ªå¯¹è±¡ä»è¯ç”Ÿåˆ°è¢«å›æ”¶æ‰€ç»å†çš„æ—¶é—´

**åƒåœ¾æ”¶é›†å™¨çš„ç»„åˆå…³ç³»**ï¼š

![](https://gitee.com/seazean/images/raw/master/Java/JVM-åƒåœ¾å›æ”¶å™¨å…³ç³»å›¾.png)

æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼šSerialã€ParNewã€Paralle1 Scavengeï¼›

è€å¹´ä»£æ”¶é›†å™¨ï¼šSerial oldã€Parallel oldã€CMSï¼›

æ•´å †æ”¶é›†å™¨ï¼šG1

* çº¢è‰²è™šçº¿åœ¨JDK9ç§»é™¤ã€ç»¿è‰²è™šçº¿åœ¨JDK14å¼ƒç”¨è¯¥ç»„åˆã€é’è‰²è™šçº¿åœ¨JDK14åˆ é™¤CMSåƒåœ¾å›æ”¶å™¨

æŸ¥çœ‹é»˜è®¤çš„åƒåœ¾æ”¶å›æ”¶å™¨ï¼š

* `-XX:+PrintcommandLineFlags`ï¼šæŸ¥çœ‹å‘½ä»¤è¡Œç›¸å…³å‚æ•°ï¼ˆåŒ…å«ä½¿ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼‰

* ä½¿ç”¨å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼šjinfo -flag  ç›¸å…³åƒåœ¾å›æ”¶å™¨å‚æ•°  è¿›ç¨‹ID



***



#### Serial

**Serial**ï¼šä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œä½œç”¨äºæ–°ç”Ÿä»£ï¼Œæ˜¯æŒ‡ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œé‡‡ç”¨**å¤åˆ¶ç®—æ³•**

**STWï¼ˆStop-The-Worldï¼‰**ï¼šåƒåœ¾å›æ”¶æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œå¹¶ä¸”javaåº”ç”¨ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½è¦æš‚åœï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆ

**Serial old**ï¼šæ‰§è¡Œè€å¹´ä»£åƒåœ¾å›æ”¶çš„ä¸²è¡Œæ”¶é›†å™¨ï¼Œå†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯**æ ‡è®°-æ•´ç†ç®—æ³•**ï¼ŒåŒæ ·ä¹Ÿé‡‡ç”¨äº†ä¸²è¡Œå›æ”¶å’Œ"Stop the World"æœºåˆ¶ï¼Œ

- Serial old æ˜¯è¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨
- Serial old åœ¨ Server æ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼š
  - åœ¨ JDK 1.5 ä»¥åŠä¹‹å‰ç‰ˆæœ¬ï¼ˆParallel Old è¯ç”Ÿä»¥å‰ï¼‰ä¸­ä¸ Parallel Scavenge æ”¶é›†å™¨æ­é…ä½¿ç”¨
  - ä½œä¸ºè€å¹´ä»£ CMS æ”¶é›†å™¨çš„**åå¤‡åƒåœ¾å›æ”¶æ–¹æ¡ˆ**ï¼Œåœ¨å¹¶å‘æ”¶é›†å‘ç”Ÿ Concurrent Mode Failure æ—¶ä½¿ç”¨

å¼€å¯å‚æ•°ï¼š`-XX:+UseSerialGC` ç­‰ä»·äºæ–°ç”Ÿä»£ç”¨ Serial GC ä¸”è€å¹´ä»£ç”¨ Serial old GC

![](https://gitee.com/seazean/images/raw/master/Java/JVM-Serialæ”¶é›†å™¨.png)

ä¼˜ç‚¹ï¼šç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹æ¯”ï¼‰ï¼Œå¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œå¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡

ç¼ºç‚¹ï¼šå¯¹äºäº¤äº’æ€§è¾ƒå¼ºçš„åº”ç”¨è€Œè¨€ï¼Œè¿™ç§åƒåœ¾æ”¶é›†å™¨æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ï¼Œæ¯”å¦‚Javawebåº”ç”¨



****



#### Parallel

Parallel Scavenge æ”¶é›†å™¨æ˜¯åº”ç”¨äºæ–°ç”Ÿä»£çš„å¹¶è¡Œåƒåœ¾å›æ”¶å™¨ï¼Œ**é‡‡ç”¨å¤åˆ¶ç®—æ³•**ã€å¹¶è¡Œå›æ”¶å’Œ"Stop the World"æœºåˆ¶

Parallel Old æ”¶é›†å™¨ï¼šæ˜¯ä¸€ä¸ªåº”ç”¨äºè€å¹´ä»£çš„å¹¶è¡Œåƒåœ¾å›æ”¶å™¨ï¼Œ**é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•**

å¯¹æ¯”å…¶ä»–å›æ”¶å™¨ï¼š

* å…¶å®ƒæ”¶é›†å™¨ç›®æ ‡æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´
* Parallel ç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œè¢«ç§°ä¸º**ååé‡ä¼˜å…ˆ**æ”¶é›†å™¨
* Parallel Scavenge å¯¹æ¯” ParNew æ‹¥æœ‰**è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥**ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªå¼€å…³å‚æ•°æ‰“å¼€ GC Ergonomics

åº”ç”¨åœºæ™¯ï¼š

* åœé¡¿æ—¶é—´è¶ŠçŸ­å°±è¶Šé€‚åˆéœ€è¦ä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒ
* é«˜ååé‡å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨ CPU æ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œé€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’

åœé¡¿æ—¶é—´å’Œååé‡çš„å…³ç³»ï¼šæ–°ç”Ÿä»£ç©ºé—´å˜å° â†’ ç¼©çŸ­åœé¡¿æ—¶é—´ â†’ åƒåœ¾å›æ”¶å˜å¾—é¢‘ç¹ â†’ å¯¼è‡´ååé‡ä¸‹é™

åœ¨æ³¨é‡ååé‡åŠ CPU èµ„æºæ•æ„Ÿçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge+Parallel Old æ”¶é›†å™¨ï¼Œåœ¨ Server æ¨¡å¼ä¸‹çš„å†…å­˜å›æ”¶æ€§èƒ½å¾ˆå¥½ï¼Œ**Java8é»˜è®¤æ˜¯æ­¤åƒåœ¾æ”¶é›†å™¨ç»„åˆ**

![](https://gitee.com/seazean/images/raw/master/Java/JVM-ParallelScavengeæ”¶é›†å™¨.png)

å‚æ•°é…ç½®ï¼š

* `-XXï¼š+UseParallelGC`ï¼šæ‰‹åŠ¨æŒ‡å®šå¹´è½»ä»£ä½¿ç”¨Paralleå¹¶è¡Œæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡
* `-XXï¼š+UseParalleloldcc`ï¼šæ‰‹åŠ¨æŒ‡å®šè€å¹´ä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡
  * ä¸Šé¢ä¸¤ä¸ªå‚æ•°ï¼Œé»˜è®¤å¼€å¯ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šè¢«å¼€å¯ï¼ˆäº’ç›¸æ¿€æ´»ï¼‰ï¼Œé»˜è®¤jdk8æ˜¯å¼€å¯çš„
* `-XX:+UseAdaptivesizepplicy`ï¼šè®¾ç½® Parallel scavenge æ”¶é›†å™¨å…·æœ‰**è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥**ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¹´è½»ä»£çš„å¤§å°ã€Eden å’Œ Survivor çš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ï¼Œ**è™šæ‹Ÿæœºä¼šæ ¹æ®å½“å‰ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°ä»¥æä¾›æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–è€…æœ€å¤§çš„ååé‡**
* `-XX:ParallelGcrhreads`ï¼šè®¾ç½®å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ã€‚ä¸€èˆ¬æœ€å¥½ä¸ CPU æ•°é‡ç›¸ç­‰ï¼Œä»¥é¿å…è¿‡å¤šçš„çº¿ç¨‹æ•°å½±å“åƒåœ¾æ”¶é›†æ€§èƒ½
  * åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ CPU æ•°é‡å°äº8ä¸ªï¼ŒParallelGcThreads çš„å€¼ç­‰äº CPU æ•°é‡
  * å½“ CPU æ•°é‡å¤§äº 8 ä¸ªï¼ŒParallelGCThreads çš„å€¼ç­‰äº 3+[5*CPU Count]/8]
* `-XX:MaxGCPauseMillis`ï¼šè®¾ç½®åƒåœ¾æ”¶é›†å™¨æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆå³ STW çš„æ—¶é—´ï¼‰ï¼Œå•ä½æ˜¯æ¯«ç§’
  * å¯¹äºç”¨æˆ·æ¥è®²ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ä½“éªŒè¶Šå¥½ï¼›åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ³¨é‡é«˜å¹¶å‘ï¼Œæ•´ä½“çš„ååé‡
  * ä¸ºäº†æŠŠåœé¡¿æ—¶é—´æ§åˆ¶åœ¨ MaxGCPauseMillis ä»¥å†…ï¼Œæ”¶é›†å™¨åœ¨å·¥ä½œæ—¶ä¼šè°ƒæ•´ Java å †å¤§å°æˆ–å…¶ä»–ä¸€äº›å‚æ•°
* `-XX:GCTimeRatio`ï¼šåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ =1/(N+1)ï¼Œç”¨äºè¡¡é‡ååé‡çš„å¤§å°
  * å–å€¼èŒƒå›´ï¼ˆ0ï¼Œ100ï¼‰ã€‚é»˜è®¤å€¼ 99ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾å›æ”¶æ—¶é—´ä¸è¶…è¿‡1
  * ä¸`-xx:MaxGCPauseMillis`å‚æ•°æœ‰ä¸€å®šçŸ›ç›¾æ€§ï¼Œæš‚åœæ—¶é—´è¶Šé•¿ï¼ŒRadioå‚æ•°å°±å®¹æ˜“è¶…è¿‡è®¾å®šçš„æ¯”ä¾‹



***



#### ParNew

Par æ˜¯ Parallel å¹¶è¡Œçš„ç¼©å†™ï¼ŒNewï¼šåªèƒ½å¤„ç†çš„æ˜¯æ–°ç”Ÿä»£

**å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨**åœ¨ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨çš„åŸºç¡€ä¹‹ä¸Šåšäº†æ”¹è¿›ï¼Œ**é‡‡ç”¨å¤åˆ¶ç®—æ³•**ï¼Œå°†å•çº¿ç¨‹æ”¹ä¸ºäº†å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¿™æ ·å¯ä»¥ç¼©çŸ­åƒåœ¾å›æ”¶çš„æ—¶é—´

å¯¹äºå…¶ä»–çš„è¡Œä¸ºï¼ˆæ”¶é›†ç®—æ³•ã€stop the worldã€å¯¹è±¡åˆ†é…è§„åˆ™ã€å›æ”¶ç­–ç•¥ç­‰ï¼‰åŒSerialæ”¶é›†å™¨ä¸€æ ·ï¼Œåº”ç”¨åœ¨å¹´è½»ä»£ï¼Œé™¤Serialå¤–ï¼Œåªæœ‰**ParNew GCèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œ**

ç›¸å…³å‚æ•°ï¼š

* `-XXï¼š+UseParNewGC`ï¼Œè¡¨ç¤ºå¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨ï¼Œä¸å½±å“è€å¹´ä»£

* `-XX:ParallelGCThreads`ï¼Œé»˜è®¤å¼€å¯å’Œ CPU æ•°é‡ç›¸åŒçš„çº¿ç¨‹æ•°

![](https://gitee.com/seazean/images/raw/master/Java/JVM-ParNewæ”¶é›†å™¨.png)

ParNew æ˜¯å¾ˆå¤š JVM è¿è¡Œåœ¨ Server æ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨

- å¯¹äºæ–°ç”Ÿä»£ï¼Œå›æ”¶æ¬¡æ•°é¢‘ç¹ï¼Œä½¿ç”¨å¹¶è¡Œæ–¹å¼é«˜æ•ˆ
- å¯¹äºè€å¹´ä»£ï¼Œå›æ”¶æ¬¡æ•°å°‘ï¼Œä½¿ç”¨ä¸²è¡Œæ–¹å¼èŠ‚çœèµ„æºï¼ˆCPUå¹¶è¡Œéœ€è¦åˆ‡æ¢çº¿ç¨‹ï¼Œä¸²è¡Œå¯ä»¥çœå»åˆ‡æ¢çº¿ç¨‹çš„èµ„æºï¼‰



****



#### CMS

CMSå…¨ç§° Concurrent Mark Sweepï¼Œæ˜¯ä¸€æ¬¾**å¹¶å‘çš„ã€ä½¿ç”¨æ ‡è®°-æ¸…é™¤**ç®—æ³•ã€é’ˆå¯¹è€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨ï¼Œå…¶æœ€å¤§ç‰¹ç‚¹æ˜¯**è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œ**

CMSæ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ï¼ˆ**ä½å»¶è¿Ÿ**ï¼‰è¶Šé€‚åˆä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒ

åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæµç¨‹ï¼š

- åˆå§‹æ ‡è®°ï¼šä½¿ç”¨STWå‡ºç°çŸ­æš‚åœé¡¿ï¼Œä»…æ ‡è®°ä¸€ä¸‹ GC Roots èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«
- å¹¶å‘æ ‡è®°ï¼šè¿›è¡Œ GC Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾ï¼Œåœ¨æ•´ä¸ªå›æ”¶è¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿ï¼Œä¸éœ€è¦STWï¼Œå¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œ
- é‡æ–°æ ‡è®°ï¼šä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œæ¯”åˆå§‹æ ‡è®°æ—¶é—´é•¿ä½†è¿œæ¯”å¹¶å‘æ ‡è®°æ—¶é—´çŸ­ï¼Œéœ€è¦ STW
- å¹¶å‘æ¸…é™¤ï¼šæ¸…é™¤æ ‡è®°ä¸ºå¯ä»¥å›æ”¶å¯¹è±¡ï¼Œä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µå¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„

Mark Sweep ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œè¿˜ä¸æŠŠç®—æ³•æ¢æˆ Mark Compact çš„åŸå› ï¼š

* Mark Compact ç®—æ³•ä¼šæ•´ç†å†…å­˜ï¼Œå¯¼è‡´ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨çš„å¯¹è±¡çš„åœ°å€æ”¹å˜ï¼Œå½±å“ç”¨æˆ·çº¿ç¨‹ç»§ç»­æ‰§è¡Œ

* Mark Compact æ›´é€‚åˆ Stop The World åœºæ™¯

åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œæ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦è¿›è¡Œåœé¡¿

![](https://gitee.com/seazean/images/raw/master/Java/JVM-CMSæ”¶é›†å™¨.png)

ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ã€ä½å»¶è¿Ÿ

ç¼ºç‚¹ï¼š

- ååé‡é™ä½ï¼šåœ¨å¹¶å‘é˜¶æ®µè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼ŒCPU åˆ©ç”¨ç‡ä¸å¤Ÿé«˜
- CMSæ”¶é›†å™¨æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼Œå¯èƒ½å‡ºç° Concurrent Mode Failureå¯¼è‡´å¦ä¸€æ¬¡Full GCçš„äº§ç”Ÿ
  æµ®åŠ¨åƒåœ¾æ˜¯æŒ‡å¹¶å‘æ¸…é™¤é˜¶æ®µç”±äºç”¨æˆ·çº¿ç¨‹ç»§ç»­è¿è¡Œè€Œäº§ç”Ÿçš„åƒåœ¾ï¼Œè¿™éƒ¨åˆ†åƒåœ¾åªèƒ½åˆ°ä¸‹ä¸€æ¬¡ GC æ—¶æ‰èƒ½è¿›è¡Œå›æ”¶ã€‚ç”±äºæµ®åŠ¨åƒåœ¾çš„å­˜åœ¨ï¼ŒCMS æ”¶é›†éœ€è¦é¢„ç•™å‡ºä¸€éƒ¨åˆ†å†…å­˜ï¼Œä¸èƒ½ç­‰å¾…è€å¹´ä»£å¿«æ»¡çš„æ—¶å€™å†å›æ”¶ã€‚å¦‚æœé¢„ç•™çš„å†…å­˜ä¸å¤Ÿå­˜æ”¾æµ®åŠ¨åƒåœ¾ï¼Œå°±ä¼šå‡ºç° Concurrent Mode Failureï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†ä¸´æ—¶å¯ç”¨ Serial Old æ¥æ›¿ä»£ CMSï¼Œå¯¼è‡´å¾ˆé•¿çš„åœé¡¿æ—¶é—´
- æ ‡è®° - æ¸…é™¤ç®—æ³•å¯¼è‡´çš„ç©ºé—´ç¢ç‰‡ï¼Œå¾€å¾€å‡ºç°è€å¹´ä»£ç©ºé—´æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§è¿ç»­ç©ºé—´æ¥åˆ†é…å½“å‰å¯¹è±¡ï¼Œä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡ Full GCï¼›ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå°†æ— æ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰æŠ€æœ¯ï¼Œè€Œåªèƒ½å¤Ÿé€‰æ‹©ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰æ‰§è¡Œå†…å­˜åˆ†é…

å‚æ•°è®¾ç½®ï¼š

* `-XXï¼š+UseConcMarkSweepGC`ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡

  å¼€å¯è¯¥å‚æ•°åä¼šè‡ªåŠ¨å°†`-XX:+UseParNewGC`æ‰“å¼€ï¼Œå³ï¼šParNew+CMS+Serial oldçš„ç»„åˆ

* `-XX:CMSInitiatingoccupanyFraction`ï¼šè®¾ç½®å †å†…å­˜ä½¿ç”¨ç‡çš„é˜ˆå€¼ï¼Œä¸€æ—¦è¾¾åˆ°è¯¥é˜ˆå€¼ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶

  * JDK5 åŠä»¥å‰ç‰ˆæœ¬çš„é»˜è®¤å€¼ä¸º 68ï¼Œå³å½“è€å¹´ä»£çš„ç©ºé—´ä½¿ç”¨ç‡è¾¾åˆ° 68% æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡CMSå›æ”¶
  * JDK6 åŠä»¥ä¸Šç‰ˆæœ¬é»˜è®¤å€¼ä¸º 92%

* `-XX:+UseCMSCompactAtFullCollection`ï¼šç”¨äºæŒ‡å®šåœ¨æ‰§è¡Œå®Œ Full GC åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œä»¥æ­¤é¿å…å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿï¼Œç”±äºå†…å­˜å‹ç¼©æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘æ‰§è¡Œï¼Œæ‰€å¸¦æ¥çš„é—®é¢˜å°±æ˜¯åœé¡¿æ—¶é—´å˜å¾—æ›´é•¿

* `-XX:CMSFullGCsBeforecompaction`ï¼šè®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡ Full GC åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†

* `-XX:ParallelCMSThreads`ï¼š**è®¾ç½®CMSçš„çº¿ç¨‹æ•°é‡**

  * CMS é»˜è®¤å¯åŠ¨çš„çº¿ç¨‹æ•°æ˜¯(ParallelGCThreads+3)/4ï¼ŒParallelGCThreads æ˜¯å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°
  * æ”¶é›†çº¿ç¨‹å ç”¨çš„ CPU èµ„æºå¤šäº25%ï¼Œå¯¹ç”¨æˆ·ç¨‹åºå½±å“å¯èƒ½è¾ƒå¤§ï¼›å½“ CPU èµ„æºæ¯”è¾ƒç´§å¼ æ—¶ï¼Œå—åˆ° CMS æ”¶é›†å™¨çº¿ç¨‹çš„å½±å“ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½åœ¨åƒåœ¾å›æ”¶é˜¶æ®µå¯èƒ½ä¼šéå¸¸ç³Ÿç³•



***



#### G1

##### G1ç‰¹ç‚¹

G1ï¼ˆGarbage-Firstï¼‰æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œ**åº”ç”¨äºæ–°ç”Ÿä»£å’Œè€å¹´ä»£**ã€é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€è½¯å®æ—¶ã€ä½å»¶è¿Ÿã€å¯è®¾å®šç›®æ ‡(æœ€å¤§STWåœé¡¿æ—¶é—´)çš„åƒåœ¾å›æ”¶å™¨ï¼Œç”¨äºä»£æ›¿CMSï¼Œé€‚ç”¨äºè¾ƒå¤§çš„å †(>4~6G)ï¼Œåœ¨JDK9ä¹‹åé»˜è®¤ä½¿ç”¨G1

G1 å¯¹æ¯”å…¶ä»–å¤„ç†å™¨çš„ä¼˜ç‚¹ï¼š

* **å¹¶å‘ä¸å¹¶è¡Œï¼š**
  * å¹¶è¡Œæ€§ï¼šG1åœ¨å›æ”¶æœŸé—´ï¼Œå¯ä»¥æœ‰å¤šä¸ª GC çº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›ï¼Œæ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ STW
  * å¹¶å‘æ€§ï¼šG1æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å·¥ä½œå¯ä»¥å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šåœ¨æ•´ä¸ªå›æ”¶é˜¶æ®µå‘ç”Ÿå®Œå…¨é˜»å¡åº”ç”¨ç¨‹åºçš„æƒ…å†µ
  * å…¶ä»–çš„åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨å†…ç½®çš„ JVM çº¿ç¨‹æ‰§è¡Œ GC çš„å¤šçº¿ç¨‹æ“ä½œï¼Œè€Œ G1 GC å¯ä»¥é‡‡ç”¨åº”ç”¨çº¿ç¨‹æ‰¿æ‹…åå°è¿è¡Œçš„ GC å·¥ä½œï¼ŒJVM çš„ GC çº¿ç¨‹å¤„ç†é€Ÿåº¦æ…¢æ—¶ï¼Œç³»ç»Ÿä¼š**è°ƒç”¨åº”ç”¨ç¨‹åºçº¿ç¨‹åŠ é€Ÿåƒåœ¾å›æ”¶**è¿‡ç¨‹

* **åˆ†åŒºç®—æ³•ï¼š**

  * ä»åˆ†ä»£ä¸Šçœ‹ï¼ŒG1  å±äºåˆ†ä»£å‹åƒåœ¾å›æ”¶å™¨ï¼ŒåŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ä¾ç„¶æœ‰ Eden åŒºå’Œ Survivor åŒº
    ä»å †ç»“æ„ä¸Šçœ‹ï¼Œ**æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†ç‰©ç†éš”ç¦»**ï¼Œä¸ç”¨æ‹…å¿ƒæ¯ä¸ªä»£å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œè¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡ GC
  * å°†æ•´ä¸ªå †åˆ’åˆ†æˆçº¦ 2048 ä¸ªå¤§å°ç›¸åŒçš„ç‹¬ç«‹ Region å—ï¼Œæ¯ä¸ª Region å—å¤§å°æ ¹æ®å †ç©ºé—´çš„å®é™…å¤§å°è€Œå®šï¼Œæ•´ä½“è¢«æ§åˆ¶åœ¨1MBåˆ°32MBä¹‹é—´ä¸”ä¸º2**çš„Næ¬¡å¹‚**ï¼Œæ‰€æœ‰ Region å¤§å°ç›¸åŒï¼Œåœ¨ JVM ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«æ”¹å˜ã€‚G1 æŠŠå †åˆ’åˆ†æˆå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼Œä½¿å¾—æ¯ä¸ªå°ç©ºé—´å¯ä»¥å•ç‹¬è¿›è¡Œåƒåœ¾å›æ”¶
  * **æ–°çš„åŒºåŸŸ Humongous**ï¼šæœ¬èº«å±äºè€å¹´ä»£åŒºï¼Œå½“å‡ºç°äº†ä¸€ä¸ªå·¨å¤§çš„å¯¹è±¡ï¼Œè¶…å‡ºäº†åˆ†åŒºå®¹é‡çš„ä¸€åŠï¼Œåˆ™è¿™ä¸ªå¯¹è±¡ä¼šè¿›å…¥åˆ°è¯¥åŒºåŸŸã€‚å¦‚æœä¸€ä¸ª H åŒºè£…ä¸ä¸‹ä¸€ä¸ªå·¨å‹å¯¹è±¡ï¼Œé‚£ä¹ˆ G1 ä¼šå¯»æ‰¾è¿ç»­çš„ H åˆ†åŒºæ¥å­˜å‚¨ï¼Œä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨ Full GC
  * G1 ä¸ä¼šå¯¹å·¨å‹å¯¹è±¡è¿›è¡Œæ‹·è´ï¼Œå›æ”¶æ—¶è¢«ä¼˜å…ˆè€ƒè™‘ï¼ŒG1 ä¼šè·Ÿè¸ªè€å¹´ä»£æ‰€æœ‰ incoming å¼•ç”¨ï¼Œè¿™æ ·è€å¹´ä»£incoming å¼•ç”¨ä¸º 0 çš„å·¨å‹å¯¹è±¡å°±å¯ä»¥åœ¨æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ—¶å¤„ç†æ‰
  
  * Regionç»“æ„å›¾ï¼š

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-G1-RegionåŒºåŸŸ.png)

- **ç©ºé—´æ•´åˆï¼š**

  - CMSï¼šâ€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ã€å†…å­˜ç¢ç‰‡ã€è‹¥å¹²æ¬¡ GC åè¿›è¡Œä¸€æ¬¡ç¢ç‰‡æ•´ç†
  - G1ï¼šæ•´ä½“æ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®° - æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼Œä»å±€éƒ¨ï¼ˆRegion ä¹‹é—´ï¼‰ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œå¤åˆ¶â€ç®—æ³•å®ç°çš„ï¼Œä¸¤ç§ç®—æ³•éƒ½å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡

- **å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼ˆè½¯å®æ—¶soft real-timeï¼‰ï¼š**

  - å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸º M æ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨ GC ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡ N æ¯«ç§’
  - ç”±äºåˆ†å—çš„åŸå› ï¼ŒG1 å¯ä»¥åªé€‰å–éƒ¨åˆ†åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™æ ·ç¼©å°äº†å›æ”¶çš„èŒƒå›´ï¼Œå¯¹äºå…¨å±€åœé¡¿æƒ…å†µä¹Ÿèƒ½å¾—åˆ°è¾ƒå¥½çš„æ§åˆ¶
  - G1 è·Ÿè¸ªå„ä¸ª Region é‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´ï¼Œé€šè¿‡è¿‡å»å›æ”¶çš„ç»éªŒè·å¾—ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ª**ä¼˜å…ˆåˆ—è¡¨**ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„ Regionï¼Œä¿è¯äº†G1æ”¶é›†å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡

  * ç›¸æ¯”äº CMS GCï¼ŒG1 æœªå¿…èƒ½åšåˆ° CMS åœ¨æœ€å¥½æƒ…å†µä¸‹çš„å»¶æ—¶åœé¡¿ï¼Œä½†æ˜¯æœ€å·®æƒ…å†µè¦å¥½å¾ˆå¤š

G1åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹ï¼š

* ç›¸è¾ƒäº CMSï¼ŒG1 è¿˜ä¸å…·å¤‡å…¨æ–¹ä½ã€å‹å€’æ€§ä¼˜åŠ¿ã€‚æ¯”å¦‚åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1 æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½éƒ½è¦æ¯” CMS è¦é«˜
* ä»ç»éªŒä¸Šæ¥è¯´ï¼Œåœ¨å°å†…å­˜åº”ç”¨ä¸ŠCMSçš„è¡¨ç°å¤§æ¦‚ç‡ä¼šä¼˜äºG1ï¼Œè€ŒG1åœ¨å¤§å†…å­˜åº”ç”¨ä¸Šåˆ™å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚å¹³è¡¡ç‚¹åœ¨6-8GBä¹‹é—´

åº”ç”¨åœºæ™¯ï¼š

* é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ã€å¤šå¤„ç†å™¨çš„æœºå™¨
* éœ€è¦ä½ GC å»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆ



***



##### è®°å¿†é›†

è®°å¿†é›† Remembered Set åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯ä¸ª Region éƒ½æœ‰ä¸€ä¸ª Remembered Setï¼Œç”¨æ¥è¢«å“ªäº›å…¶ä»– Region é‡Œçš„å¯¹è±¡å¼•ç”¨ï¼ˆè°å¼•ç”¨äº†æˆ‘å°±è®°å½•è°ï¼‰

<img src="https://gitee.com/seazean/images/raw/master/Java/JUC-G1è®°å¿†é›†.png" style="zoom:67%;" />

* ç¨‹åºå¯¹ Reference ç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œäº§ç”Ÿä¸€ä¸ª Write Barrier æš‚æ—¶ä¸­æ–­æ“ä½œï¼Œæ£€æŸ¥è¯¥å¯¹è±¡å’Œ Reference ç±»å‹æ•°æ®æ˜¯å¦åœ¨ä¸åŒçš„ Regionï¼ˆå…¶ä»–æ”¶é›†å™¨ï¼šæ£€æŸ¥è€å¹´ä»£å¯¹è±¡æ˜¯å¦å¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼‰ï¼Œä¸åŒä¾¿é€šè¿‡ CardTable æŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ° Reference ç±»å‹æ‰€å±çš„ Region çš„ Remembered Set ä¹‹ä¸­
* è¿›è¡Œå†…å­˜å›æ”¶æ—¶ï¼Œåœ¨ GC æ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´ä¸­åŠ å…¥ Remembered Set å³å¯ä¿è¯ä¸å¯¹å…¨å †æ‰«æä¹Ÿä¸ä¼šæœ‰é—æ¼

åƒåœ¾æ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£ä¸­å»ºç«‹äº†è®°å¿†é›†è¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“å®ç°è®°å¿†é›†çš„ä¸‰ç§æ–¹å¼ï¼š

* å­—é•¿ç²¾åº¦
* å¯¹è±¡ç²¾åº¦
* å¡ç²¾åº¦(å¡è¡¨)

å¡è¡¨ï¼ˆCard Tableï¼‰åœ¨è€å¹´ä»£ä¸­ï¼Œæ˜¯ä¸€ç§å¯¹è®°å¿†é›†çš„å…·ä½“å®ç°ï¼Œä¸»è¦å®šä¹‰äº†è®°å¿†é›†çš„è®°å½•ç²¾åº¦ã€ä¸å †å†…å­˜çš„æ˜ å°„å…³ç³»ç­‰ï¼Œå¡è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¯¹åº”ç€ä¸€å—ç‰¹å®šå¤§å°çš„å†…å­˜å—ã€‚è¿™ä¸ªå†…å­˜å—ç§°ä¹‹ä¸ºå¡é¡µï¼ˆcard pageï¼‰ï¼Œå½“å­˜åœ¨è·¨ä»£å¼•ç”¨æ—¶ï¼Œä¼šå°†å¡é¡µæ ‡è®°ä¸º dirtyï¼ŒJVM å¯¹äºå¡é¡µçš„ç»´æŠ¤ä¹Ÿæ˜¯é€šè¿‡å†™å±éšœçš„æ–¹å¼

æ”¶é›†é›†åˆ CSet ä»£è¡¨æ¯æ¬¡ GC æš‚åœæ—¶å›æ”¶çš„ä¸€ç³»åˆ—ç›®æ ‡åˆ†åŒºï¼Œåœ¨ä»»æ„ä¸€æ¬¡æ”¶é›†æš‚åœä¸­ï¼ŒCSet æ‰€æœ‰åˆ†åŒºéƒ½ä¼šè¢«é‡Šæ”¾ï¼Œå†…éƒ¨å­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«è½¬ç§»åˆ°åˆ†é…çš„ç©ºé—²åˆ†åŒºä¸­ã€‚å¹´è½»ä»£æ”¶é›† CSet åªå®¹çº³å¹´è½»ä»£åˆ†åŒºï¼Œè€Œæ··åˆæ”¶é›†ä¼šé€šè¿‡å¯å‘å¼ç®—æ³•ï¼Œåœ¨è€å¹´ä»£å€™é€‰å›æ”¶åˆ†åŒºä¸­ï¼Œç­›é€‰å‡ºå›æ”¶æ”¶ç›Šæœ€é«˜çš„åˆ†åŒºæ·»åŠ åˆ° CSet ä¸­

* CSet of Young Collection
* CSet of Mix Collection



***



##### å·¥ä½œåŸç†

G1ä¸­æä¾›äº†ä¸‰ç§åƒåœ¾å›æ”¶æ¨¡å¼ï¼šYoungGCã€Mixed GC å’Œ FullGCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘

* å½“å †å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸€å®šå€¼ï¼ˆé»˜è®¤45%ï¼‰æ—¶ï¼Œå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹
* æ ‡è®°å®Œæˆé©¬ä¸Šå¼€å§‹æ··åˆå›æ”¶è¿‡ç¨‹

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-G1å›æ”¶è¿‡ç¨‹.png" style="zoom: 50%;" />

é¡ºæ—¶é’ˆï¼šYoung GC â†’ Young GC + Concurrent Mark â†’ Mixed GC é¡ºåºï¼Œè¿›è¡Œåƒåœ¾å›æ”¶

* **Young GC**ï¼šå‘ç”Ÿåœ¨å¹´è½»ä»£çš„ GC ç®—æ³•ï¼Œä¸€èˆ¬å¯¹è±¡ï¼ˆé™¤äº†å·¨å‹å¯¹è±¡ï¼‰éƒ½æ˜¯åœ¨ eden region ä¸­åˆ†é…å†…å­˜ï¼Œå½“æ‰€æœ‰ eden region è¢«è€—å°½æ— æ³•ç”³è¯·å†…å­˜æ—¶ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ young gcï¼ŒG1 åœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œ STWï¼ŒæŠŠæ´»è·ƒå¯¹è±¡æ”¾å…¥è€å¹´ä»£ï¼Œåƒåœ¾å¯¹è±¡å›æ”¶

  **å›æ”¶è¿‡ç¨‹**ï¼š

  1. æ‰«ææ ¹ï¼šæ ¹å¼•ç”¨è¿åŒ RSet è®°å½•çš„å¤–éƒ¨å¼•ç”¨ä½œä¸ºæ‰«æå­˜æ´»å¯¹è±¡çš„å…¥å£
  2. æ›´æ–° RSetï¼šå¤„ç† dirty card queue æ›´æ–° RSï¼Œæ­¤å RSet å‡†ç¡®çš„åæ˜ å¯¹è±¡çš„å¼•ç”¨å…³ç³»
     * dirty card queueï¼šç±»ä¼¼ç¼“å­˜ï¼Œäº§ç”Ÿäº†å¼•ç”¨å…ˆè®°å½•åœ¨è¿™é‡Œï¼Œç„¶åæ›´æ–°åˆ° RSet
     * ä½œç”¨ï¼šäº§ç”Ÿå¼•ç”¨ç›´æ¥æ›´æ–° RSet éœ€è¦çº¿ç¨‹åŒæ­¥å¼€é”€å¾ˆå¤§ï¼Œä½¿ç”¨é˜Ÿåˆ—æ€§èƒ½å¥½
  3. å¤„ç† RSetï¼šè¯†åˆ«è¢«è€å¹´ä»£å¯¹è±¡æŒ‡å‘çš„ Eden ä¸­çš„å¯¹è±¡ï¼Œè¿™äº›è¢«æŒ‡å‘çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ï¼ŒæŠŠéœ€è¦å›æ”¶çš„æ”¾å…¥ YoungCSet ä¸­è¿›è¡Œå›æ”¶
  4. å¤åˆ¶å¯¹è±¡ï¼šEden åŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ° survivor åŒºï¼Œsurvivor åŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡å¦‚æœå¹´é¾„æœªè¾¾é˜ˆå€¼ï¼Œå¹´é¾„ä¼šåŠ 1ï¼Œè¾¾åˆ°é˜€å€¼ä¼šè¢«ä¼šè¢«å¤åˆ¶åˆ° old åŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µï¼Œå¦‚æœ survivor ç©ºé—´ä¸å¤Ÿï¼ŒEden ç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´
  5. å¤„ç†å¼•ç”¨ï¼šå¤„ç† Softï¼ŒWeakï¼ŒPhantomï¼ŒJNI Weak  ç­‰å¼•ç”¨ï¼Œæœ€ç»ˆ Eden ç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGC åœæ­¢å·¥ä½œ

* **å¹¶å‘æ ‡è®°è¿‡ç¨‹**ï¼š

  * åˆå§‹æ ‡è®°ï¼šæ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ï¼Œè¿™ä¸ªé˜¶æ®µæ˜¯ STW çš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘ä¸€æ¬¡å¹´è½»ä»£ GC
  * æ ¹åŒºåŸŸæ‰«æ (Root Region Scanning)ï¼šG1 æ‰«æ survivor åŒºç›´æ¥å¯è¾¾çš„è€å¹´ä»£åŒºåŸŸå¯¹è±¡ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¸€è¿‡ç¨‹å¿…é¡»åœ¨ Young GC ä¹‹å‰å®Œæˆ
  * å¹¶å‘æ ‡è®° (Concurrent Marking)ï¼šåœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼‰ï¼Œå¯èƒ½è¢« YoungGC ä¸­æ–­ã€‚ä¼šè®¡ç®—æ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§ï¼Œå³åŒºåŸŸä¸­å­˜æ´»å¯¹è±¡çš„æ¯”ä¾‹ï¼Œ**è‹¥åŒºåŸŸä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯åƒåœ¾ï¼Œåˆ™è¿™ä¸ªåŒºåŸŸä¼šè¢«ç«‹å³å›æ”¶ï¼ˆå®æ—¶å›æ”¶ï¼‰**ï¼Œç»™æµ®åŠ¨åƒåœ¾å‡†å¤‡å‡ºæ›´å¤šçš„ç©ºé—´ï¼ŒæŠŠéœ€è¦æ”¶é›†çš„ Region æ”¾å…¥ CSet å½“ä¸­
  * æœ€ç»ˆæ ‡è®°ï¼šä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†æ ‡è®°è®°å½•ï¼Œè™šæ‹Ÿæœºå°†è¿™æ®µæ—¶é—´å¯¹è±¡å˜åŒ–è®°å½•åœ¨çº¿ç¨‹çš„ Remembered Set Logs é‡Œé¢ï¼Œæœ€ç»ˆæ ‡è®°é˜¶æ®µéœ€è¦æŠŠ Remembered Set Logs çš„æ•°æ®åˆå¹¶åˆ° Remembered Set ä¸­ï¼Œè¿™é˜¶æ®µéœ€è¦åœé¡¿çº¿ç¨‹ï¼Œä½†æ˜¯å¯å¹¶è¡Œæ‰§è¡Œ
  * ç­›é€‰å›æ”¶ï¼šå¹¶å‘æ¸…ç†é˜¶æ®µï¼Œé¦–å…ˆå¯¹ CSet ä¸­å„ä¸ª Region ä¸­çš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œæ ¹æ®ç”¨æˆ·æ‰€æœŸæœ›çš„ GC åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚æ­¤é˜¶æ®µå…¶å®ä¹Ÿå¯ä»¥åšåˆ°ä¸ç”¨æˆ·ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Œä½†æ˜¯å› ä¸ºåªå›æ”¶ä¸€éƒ¨åˆ† Regionï¼Œæ—¶é—´æ˜¯ç”¨æˆ·å¯æ§åˆ¶çš„ï¼Œè€Œä¸”åœé¡¿ç”¨æˆ·çº¿ç¨‹å°†å¤§å¹…åº¦æé«˜æ”¶é›†æ•ˆç‡

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-G1æ”¶é›†å™¨.jpg)

* **Mixed GC**ï¼šå½“å¾ˆå¤šå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ old region æ—¶ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³ Mixed GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ª young regionï¼Œè¿˜ä¼š**å›æ”¶ä¸€éƒ¨åˆ†**çš„ old regionï¼Œè¿‡ç¨‹åŒ YGC

  æ³¨æ„ï¼š**æ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£**ï¼Œå¯ä»¥é€‰æ‹©å“ªäº› old region æ”¶é›†ï¼Œå¯¹åƒåœ¾å›æ”¶çš„æ—¶é—´è¿›è¡Œæ§åˆ¶

  åœ¨ G1 ä¸­ï¼ŒMixed GC å¯ä»¥é€šè¿‡ `-XX:InitiatingHeapOccupancyPercent` è®¾ç½®é˜ˆå€¼

* **Full GC**ï¼šå¯¹è±¡å†…å­˜åˆ†é…é€Ÿåº¦è¿‡å¿«ï¼ŒMixed GC æ¥ä¸åŠå›æ”¶ï¼Œå¯¼è‡´è€å¹´ä»£è¢«å¡«æ»¡ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ Full GCï¼ŒG1 çš„ Full GC ç®—æ³•å°±æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„åƒåœ¾å›æ”¶ï¼Œä¼šå¯¼è‡´å¼‚å¸¸é•¿æ—¶é—´çš„æš‚åœæ—¶é—´ï¼Œéœ€è¦è¿›è¡Œä¸æ–­çš„è°ƒä¼˜ï¼Œå°½å¯èƒ½çš„é¿å… Full GC

  äº§ç”Ÿ Full GC çš„åŸå› ï¼š

  * æ™‹å‡æ—¶æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾æ™‹å‡çš„å¯¹è±¡
  * å¹¶å‘å¤„ç†è¿‡ç¨‹å®Œæˆä¹‹å‰ç©ºé—´è€—å°½ï¼Œæµ®åŠ¨åƒåœ¾



***



##### ç›¸å…³å‚æ•°

- `-XX:+UseG1GC`ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡
- `-XX:G1HeapRegionSize`ï¼šè®¾ç½®æ¯ä¸ª Region çš„å¤§å°ã€‚å€¼æ˜¯ 2 çš„å¹‚ï¼ŒèŒƒå›´æ˜¯ 1MB åˆ° 32MB ä¹‹é—´ï¼Œç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„ Java å †å¤§å°åˆ’åˆ†å‡ºçº¦ 2048 ä¸ªåŒºåŸŸï¼Œé»˜è®¤æ˜¯å †å†…å­˜çš„ 1/2000
- `-XX:MaxGCPauseMillis`ï¼šè®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§ GC åœé¡¿æ—¶é—´æŒ‡æ ‡ï¼ŒJVMä¼šå°½åŠ›å®ç°ï¼Œä½†ä¸ä¿è¯è¾¾åˆ°ï¼Œé»˜è®¤å€¼æ˜¯ 200ms
- `-XX:+ParallelGcThread`ï¼šè®¾ç½® STW æ—¶ GC çº¿ç¨‹æ•°çš„å€¼ï¼Œæœ€å¤šè®¾ç½®ä¸º 8
- `-XX:ConcGCThreads`ï¼šè®¾ç½®å¹¶å‘æ ‡è®°çº¿ç¨‹æ•°ï¼Œè®¾ç½®ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹æ•° ParallelGcThreads çš„1/4å·¦å³
- `-XX:InitiatingHeapoccupancyPercent`ï¼šè®¾ç½®è§¦å‘å¹¶å‘ Mixed GC å‘¨æœŸçš„ Java å †å ç”¨ç‡é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼ï¼Œå°±è§¦å‘ GCï¼Œé»˜è®¤å€¼æ˜¯ 45
- `-XX:+ClassUnloadingWithConcurrentMark`ï¼šå¹¶å‘æ ‡è®°ç±»å¸è½½ï¼Œé»˜è®¤å¯ç”¨ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½ç»è¿‡å¹¶å‘æ ‡è®°åï¼Œå°±å¯ä»¥çŸ¥é“å“ªäº›ç±»ä¸å†è¢«ä½¿ç”¨ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨çš„æ‰€æœ‰ç±»éƒ½ä¸å†ä½¿ç”¨ï¼Œåˆ™å¸è½½å®ƒæ‰€åŠ è½½çš„æ‰€æœ‰ç±»
- `-XX:G1NewSizePercent`ï¼šæ–°ç”Ÿä»£å ç”¨æ•´ä¸ªå †å†…å­˜çš„æœ€å°ç™¾åˆ†æ¯”ï¼ˆé»˜è®¤5ï¼…ï¼‰ 
- `-XX:G1MaxNewSizePercent`ï¼šæ–°ç”Ÿä»£å ç”¨æ•´ä¸ªå †å†…å­˜çš„æœ€å¤§ç™¾åˆ†æ¯”ï¼ˆé»˜è®¤60ï¼…ï¼‰ 
- `-XX:G1ReservePercent=10`ï¼šä¿ç•™å†…å­˜åŒºåŸŸï¼Œé˜²æ­¢ to spaceï¼ˆSurvivorä¸­çš„ to åŒºï¼‰æº¢å‡º



***



##### è°ƒä¼˜

G1 çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€åŒ– JVM æ€§èƒ½è°ƒä¼˜ï¼Œåªéœ€è¦ç®€å•çš„ä¸‰æ­¥å³å¯å®Œæˆè°ƒä¼˜ï¼š

1. å¼€å¯ G1 åƒåœ¾æ”¶é›†å™¨
2. è®¾ç½®å †çš„æœ€å¤§å†…å­˜
3. è®¾ç½®æœ€å¤§çš„åœé¡¿æ—¶é—´ï¼ˆSTWï¼‰

**ä¸æ–­è°ƒä¼˜æš‚åœæ—¶é—´æŒ‡æ ‡**ï¼š

* `XX:MaxGCPauseMillis=x` å¯ä»¥è®¾ç½®å¯åŠ¨åº”ç”¨ç¨‹åºæš‚åœçš„æ—¶é—´ï¼ŒG1ä¼šæ ¹æ®è¿™ä¸ªå‚æ•°é€‰æ‹© CSet æ¥æ»¡è¶³å“åº”æ—¶é—´çš„è®¾ç½®
* è®¾ç½®åˆ° 100ms æˆ–è€… 200ms éƒ½å¯ä»¥ï¼ˆä¸åŒæƒ…å†µä¸‹ä¼šä¸ä¸€æ ·ï¼‰ï¼Œä½†è®¾ç½®æˆ50mså°±ä¸å¤ªåˆç†
* æš‚åœæ—¶é—´è®¾ç½®çš„å¤ªçŸ­ï¼Œå°±ä¼šå¯¼è‡´å‡ºç° G1 è·Ÿä¸ä¸Šåƒåœ¾äº§ç”Ÿçš„é€Ÿåº¦ï¼Œæœ€ç»ˆé€€åŒ–æˆ Full GC
* å¯¹è¿™ä¸ªå‚æ•°çš„è°ƒä¼˜æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œé€æ­¥è°ƒæ•´åˆ°æœ€ä½³çŠ¶æ€

**ä¸è¦è®¾ç½®æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„å¤§å°**ï¼š

- é¿å…ä½¿ç”¨ -Xmn æˆ– -XX:NewRatio ç­‰ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£å¤§å°ï¼ŒG1 æ”¶é›†å™¨åœ¨è¿è¡Œçš„æ—¶å€™ä¼šè°ƒæ•´æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„å¤§å°ï¼Œä»è€Œè¾¾åˆ°æˆ‘ä»¬ä¸ºæ”¶é›†å™¨è®¾ç½®çš„æš‚åœæ—¶é—´ç›®æ ‡
- è®¾ç½®äº†æ–°ç”Ÿä»£å¤§å°ç›¸å½“äºæ”¾å¼ƒäº† G1 ä¸ºæˆ‘ä»¬åšçš„è‡ªåŠ¨è°ƒä¼˜ï¼Œæˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯è®¾ç½®æ•´ä¸ªå †å†…å­˜çš„å¤§å°ï¼Œå‰©ä¸‹çš„äº¤ç»™ G1 è‡ªå·±å»åˆ†é…å„ä¸ªä»£çš„å¤§å°



***



#### ZGC

ZGC æ”¶é›†å™¨æ˜¯ä¸€ä¸ªå¯ä¼¸ç¼©çš„ã€ä½å»¶è¿Ÿçš„åƒåœ¾æ”¶é›†å™¨ï¼ŒåŸºäº Region å†…å­˜å¸ƒå±€çš„ï¼Œä¸è®¾åˆ†ä»£ï¼Œä½¿ç”¨äº†è¯»å±éšœã€æŸ“è‰²æŒ‡é’ˆå’Œå†…å­˜å¤šé‡æ˜ å°„ç­‰æŠ€æœ¯æ¥å®ç°**å¯å¹¶å‘çš„æ ‡è®°å‹ç¼©ç®—æ³•**

* åœ¨ CMS å’Œ G1 ä¸­éƒ½ç”¨åˆ°äº†å†™å±éšœï¼Œè€Œ ZGC ç”¨åˆ°äº†è¯»å±éšœ
* æŸ“è‰²æŒ‡é’ˆï¼šç›´æ¥å°†å°‘é‡é¢å¤–çš„ä¿¡æ¯å­˜å‚¨åœ¨æŒ‡é’ˆä¸Šçš„æŠ€æœ¯ï¼Œä» 64 ä½çš„æŒ‡é’ˆä¸­æ‹¿é«˜ 4 ä½æ¥æ ‡è¯†å¯¹è±¡æ­¤æ—¶çš„çŠ¶æ€
  * æŸ“è‰²æŒ‡é’ˆå¯ä»¥ä½¿æŸä¸ª Region çš„å­˜æ´»å¯¹è±¡è¢«ç§»èµ°ä¹‹åï¼Œè¿™ä¸ª Region ç«‹å³å°±èƒ½å¤Ÿè¢«é‡Šæ”¾å’Œé‡ç”¨
  * å¯ä»¥ç›´æ¥ä»æŒ‡é’ˆä¸­çœ‹åˆ°å¼•ç”¨å¯¹è±¡çš„ä¸‰è‰²æ ‡è®°çŠ¶æ€ï¼ˆMarked0ã€Marked1ï¼‰ã€æ˜¯å¦è¿›å…¥äº†é‡åˆ†é…é›†ã€æ˜¯å¦è¢«ç§»åŠ¨è¿‡ï¼ˆRemappedï¼‰ã€æ˜¯å¦åªèƒ½é€šè¿‡ finalize() æ–¹æ³•æ‰èƒ½è¢«è®¿é—®åˆ°ï¼ˆFinalizableï¼‰
  * å¯ä»¥å¤§å¹…å‡å°‘åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­å†…å­˜å±éšœçš„ä½¿ç”¨æ•°é‡ï¼Œå†™å±éšœçš„ç›®çš„é€šå¸¸æ˜¯ä¸ºäº†è®°å½•å¯¹è±¡å¼•ç”¨çš„å˜åŠ¨æƒ…å†µï¼Œå¦‚æœå°†è¿™äº›ä¿¡æ¯ç›´æ¥ç»´æŠ¤åœ¨æŒ‡é’ˆä¸­ï¼Œæ˜¾ç„¶å°±å¯ä»¥çœå»ä¸€äº›ä¸“é—¨çš„è®°å½•æ“ä½œ
  * å¯ä»¥ä½œä¸ºä¸€ç§å¯æ‰©å±•çš„å­˜å‚¨ç»“æ„ç”¨æ¥è®°å½•æ›´å¤šä¸å¯¹è±¡æ ‡è®°ã€é‡å®šä½è¿‡ç¨‹ç›¸å…³çš„æ•°æ®
* å†…å­˜å¤šé‡æ˜ å°„ï¼šå¤šä¸ªè™šæ‹Ÿåœ°å€æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€

å¯å¹¶å‘çš„æ ‡è®°å‹ç¼©ç®—æ³•ï¼šæŸ“è‰²æŒ‡é’ˆæ ‡è¯†å¯¹è±¡æ˜¯å¦è¢«æ ‡è®°æˆ–ç§»åŠ¨ï¼Œè¯»å±éšœä¿è¯åœ¨æ¯æ¬¡åº”ç”¨ç¨‹åºæˆ– GC ç¨‹åºè®¿é—®å¯¹è±¡æ—¶å…ˆæ ¹æ®æŸ“è‰²æŒ‡é’ˆçš„æ ‡è¯†åˆ¤æ–­æ˜¯å¦è¢«ç§»åŠ¨ï¼Œå¦‚æœè¢«ç§»åŠ¨å°±æ ¹æ®è½¬å‘è¡¨è®¿é—®æ–°çš„å¤åˆ¶å¯¹è±¡ï¼Œå¹¶æ›´æ–°å¼•ç”¨ï¼Œä¸ä¼šåƒ G1 ä¸€æ ·å¿…é¡»ç­‰å¾…åƒåœ¾å›æ”¶å®Œæˆæ‰èƒ½è®¿é—®

ZGC ç›®æ ‡ï¼š

- åœé¡¿æ—¶é—´ä¸ä¼šè¶…è¿‡ 10ms
- åœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¢å¤§è€Œå¢å¤§ï¼ˆä¸ç®¡å¤šå¤§çš„å †éƒ½èƒ½ä¿æŒåœ¨ 10ms ä»¥ä¸‹ï¼‰
- å¯æ”¯æŒå‡ ç™¾ Mï¼Œç”šè‡³å‡  T çš„å †å¤§å°ï¼ˆæœ€å¤§æ”¯æŒ4Tï¼‰

ZGC çš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸º 4 ä¸ªé˜¶æ®µï¼š

* å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ï¼š éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œä¹Ÿè¦ç»è¿‡ç±»ä¼¼äº G1çš„åˆå§‹æ ‡è®°ã€æœ€ç»ˆæ ‡è®°çš„çŸ­æš‚åœé¡¿
* å¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆ Concurrent Prepare for Relocateï¼‰ï¼š æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº› Regionï¼Œå°†è¿™äº› Region ç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰
* å¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰ï¼š é‡åˆ†é…æ˜¯ ZGC æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„**å­˜æ´»å¯¹è±¡**å¤åˆ¶åˆ°æ–°çš„ Region ä¸Šï¼Œå¹¶ä¸ºé‡åˆ†é…é›†ä¸­çš„æ¯ä¸ª Region ç»´æŠ¤ä¸€ä¸ªè½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§åœ°å€åˆ°æ–°åœ°å€çš„è½¬å‘å…³ç³»
* å¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰ï¼šä¿®æ­£æ•´ä¸ªå †ä¸­æŒ‡å‘é‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼ŒZGC çš„å¹¶å‘æ˜ å°„å¹¶ä¸æ˜¯ä¸€ä¸ªå¿…é¡»è¦ç«‹å³å®Œæˆçš„ä»»åŠ¡ï¼ŒZGC å¾ˆå·§å¦™åœ°æŠŠå¹¶å‘é‡æ˜ å°„é˜¶æ®µè¦åšçš„å·¥ä½œï¼Œåˆå¹¶åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å¾ªç¯ä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µé‡Œå»å®Œæˆï¼Œå› ä¸ºéƒ½æ˜¯è¦éå†æ‰€æœ‰å¯¹è±¡çš„ï¼Œè¿™æ ·åˆå¹¶èŠ‚çœäº†ä¸€æ¬¡éå†çš„å¼€é”€

ZGC å‡ ä¹åœ¨æ‰€æœ‰åœ°æ–¹å¹¶å‘æ‰§è¡Œçš„ï¼Œé™¤äº†åˆå§‹æ ‡è®°çš„æ˜¯ STW çš„ï¼Œä½†è¿™éƒ¨åˆ†çš„å®é™…æ—¶é—´æ˜¯éå¸¸å°‘çš„ï¼Œæ‰€ä»¥å“åº”é€Ÿåº¦å¿«ï¼Œåœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤§çš„å‰æä¸‹ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…çš„ä½å»¶è¿Ÿ

ä¼˜ç‚¹ï¼šé«˜ååé‡ã€ä½å»¶è¿Ÿ

ç¼ºç‚¹ï¼šæµ®åŠ¨åƒåœ¾ï¼Œå½“ ZGC å‡†å¤‡è¦å¯¹ä¸€ä¸ªå¾ˆå¤§çš„å †åšä¸€æ¬¡å®Œæ•´çš„å¹¶å‘æ”¶é›†ï¼Œå…¶å…¨è¿‡ç¨‹è¦æŒç»­ååˆ†é’Ÿä»¥ä¸Šï¼Œç”±äºåº”ç”¨çš„å¯¹è±¡åˆ†é…é€Ÿç‡å¾ˆé«˜ï¼Œå°†åˆ›é€ å¤§é‡çš„æ–°å¯¹è±¡äº§ç”Ÿæµ®åŠ¨åƒåœ¾



å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/jimoer/p/13170249.html



***



#### æ€»ç»“

Serial GCã€Parallel GCã€Concurrent Mark Sweep GC è¿™ä¸‰ä¸ª GC  ä¸åŒï¼š

- æœ€å°åŒ–åœ°ä½¿ç”¨å†…å­˜å’Œå¹¶è¡Œå¼€é”€ï¼Œé€‰ Serial GC
- æœ€å¤§åŒ–åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œé€‰ Parallel GC
- æœ€å°åŒ–GCçš„ä¸­æ–­æˆ–åœé¡¿æ—¶é—´ï¼Œé€‰CMS GC

![](https://gitee.com/seazean/images/raw/master/Java/JVM-åƒåœ¾å›æ”¶å™¨æ€»ç»“.png)





***



### å†…å­˜æ³„æ¼

#### æ³„éœ²æº¢å‡º

å†…å­˜æ³„éœ²ï¼ˆmemory leakï¼‰æŒ‡ç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœ

å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œæœ¬è´¨éƒ½æ˜¯åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦è¿˜è¢«å¼•ç”¨ã€‚ç”±äºä»£ç çš„å®ç°ä¸åŒå°±ä¼šå‡ºç°å¾ˆå¤šç§å†…å­˜æ³„æ¼é—®é¢˜ï¼Œè®© JVM è¯¯ä»¥ä¸ºæ­¤å¯¹è±¡è¿˜åœ¨å¼•ç”¨ä¸­ï¼Œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼

å†…å­˜æº¢å‡ºï¼ˆout of memoryï¼‰æŒ‡çš„æ˜¯ç”³è¯·å†…å­˜æ—¶ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ä»¥ä½¿ç”¨

å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„å…³ç³»ï¼šå†…å­˜æ³„æ¼çš„å¢å¤šï¼Œæœ€ç»ˆä¼šå¯¼è‡´å†…å­˜æº¢å‡º



***



#### å‡ ç§æƒ…å†µ

##### é™æ€é›†åˆ

é™æ€é›†åˆç±»çš„ç”Ÿå‘½å‘¨æœŸä¸JVMç¨‹åºä¸€è‡´ï¼Œåˆ™å®¹å™¨ä¸­çš„å¯¹è±¡åœ¨ç¨‹åºç»“æŸä¹‹å‰å°†ä¸èƒ½è¢«é‡Šæ”¾ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚åŸå› æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œå°½ç®¡çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ä¸å†ä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸ºé•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡æŒæœ‰å®ƒçš„å¼•ç”¨è€Œå¯¼è‡´ä¸èƒ½è¢«å›æ”¶

```java
public class MemoryLeak {
    static List list = new ArrayList();
    public void oomTests(){
        Object objï¼new Object();//å±€éƒ¨å˜é‡
        list.add(obj);
    }
}
```



***



##### å•ä¾‹æ¨¡å¼

å•ä¾‹æ¨¡å¼å’Œé™æ€é›†åˆå¯¼è‡´å†…å­˜æ³„éœ²çš„åŸå› ç±»ä¼¼ï¼Œå› ä¸ºå•ä¾‹çš„é™æ€ç‰¹æ€§ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œ JVM çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿ï¼Œæ‰€ä»¥å¦‚æœå•ä¾‹å¯¹è±¡æŒæœ‰å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆå†…å­˜æ³„æ¼



****



##### å†…éƒ¨ç±»

å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»çš„æƒ…å†µï¼Œå¦‚æœä¸€ä¸ªå¤–éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡è°ƒç”¨æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå†…éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå³ä½¿é‚£ä¸ªå¤–éƒ¨ç±»å®ä¾‹å¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œä½†ç”±äºå†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå¤–éƒ¨ç±»å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼



***



##### è¿æ¥ç›¸å…³

æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’ŒIOè¿æ¥ç­‰ï¼Œå½“ä¸å†ä½¿ç”¨æ—¶ï¼Œéœ€è¦æ˜¾å¼è°ƒç”¨ close æ–¹æ³•æ¥é‡Šæ”¾ä¸è¿æ¥ï¼Œåƒåœ¾å›æ”¶å™¨æ‰ä¼šå›æ”¶å¯¹åº”çš„å¯¹è±¡ï¼Œå¦åˆ™å°†ä¼šé€ æˆå¤§é‡çš„å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œä»è€Œå¼•èµ·å†…å­˜æ³„æ¼



****



##### ä¸åˆç†åŸŸ

å˜é‡ä¸åˆç†çš„ä½œç”¨åŸŸï¼Œä¸€ä¸ªå˜é‡çš„å®šä¹‰çš„ä½œç”¨èŒƒå›´å¤§äºå…¶ä½¿ç”¨èŒƒå›´ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼›å¦‚æœæ²¡æœ‰åŠæ—¶åœ°æŠŠå¯¹è±¡è®¾ç½®ä¸º nullï¼Œä¹Ÿæœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼çš„å‘ç”Ÿ

```java
public class UsingRandom {
    private String msg;
    public void receiveMsg(){
        msg = readFromNet();//ä»ç½‘ç»œä¸­æ¥å—æ•°æ®ä¿å­˜åˆ°msgä¸­
        saveDB(msg);//æŠŠmsgä¿å­˜åˆ°æ•°æ®åº“ä¸­
    }
}
```

é€šè¿‡ readFromNet æ–¹æ³•æŠŠæ¥æ”¶æ¶ˆæ¯ä¿å­˜åœ¨ msg ä¸­ï¼Œç„¶åè°ƒç”¨ saveDB æ–¹æ³•æŠŠå†…å®¹ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ­¤æ—¶ msg å·²ç»å¯ä»¥è¢«å›æ”¶ï¼Œä½†æ˜¯ msg çš„ç”Ÿå‘½å‘¨æœŸä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œé€ æˆ msg ä¸èƒ½å›æ”¶ï¼Œäº§ç”Ÿå†…å­˜æ³„æ¼

è§£å†³ï¼š

* msg å˜é‡å¯ä»¥æ”¾åœ¨ receiveMsg æ–¹æ³•å†…éƒ¨ï¼Œå½“æ–¹æ³•ä½¿ç”¨å®Œï¼Œmsg çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸï¼Œå°±å¯ä»¥è¢«å›æ”¶äº†
* åœ¨ä½¿ç”¨å®Œ msg åï¼ŒæŠŠ msg è®¾ç½®ä¸º nullï¼Œè¿™æ ·åƒåœ¾å›æ”¶å™¨ä¹Ÿä¼šå›æ”¶ msg çš„å†…å­˜ç©ºé—´ã€‚



****



##### æ”¹å˜å“ˆå¸Œ

å½“ä¸€ä¸ªå¯¹è±¡è¢«å­˜å‚¨è¿› HashSet é›†åˆä¸­ä»¥åï¼Œå°±ä¸èƒ½ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„é‚£äº›å‚ä¸è®¡ç®—å“ˆå¸Œå€¼çš„å­—æ®µï¼Œå¦åˆ™å¯¹è±¡ä¿®æ”¹åçš„å“ˆå¸Œå€¼ä¸æœ€åˆå­˜å‚¨è¿› HashSet é›†åˆä¸­æ—¶çš„å“ˆå¸Œå€¼ä¸åŒï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥å¯¹è±¡çš„å½“å‰å¼•ç”¨ä½œä¸ºçš„å‚æ•°å» HashSet é›†åˆä¸­æ£€ç´¢å¯¹è±¡è¿”å› falseï¼Œå¯¼è‡´æ— æ³•ä» HashSet é›†åˆä¸­å•ç‹¬åˆ é™¤å½“å‰å¯¹è±¡ï¼Œé€ æˆå†…å­˜æ³„æ¼



***



##### ç¼“å­˜æ³„éœ²

å†…å­˜æ³„æ¼çš„ä¸€ä¸ªå¸¸è§æ¥æºæ˜¯ç¼“å­˜ï¼Œä¸€æ—¦æŠŠå¯¹è±¡å¼•ç”¨æ”¾å…¥åˆ°ç¼“å­˜ä¸­ï¼Œå°±ä¼šå¾ˆå®¹æ˜“è¢«é—å¿˜

ä½¿ç”¨ WeakHashMap ä»£è¡¨ç¼“å­˜ï¼Œå½“é™¤äº†è‡ªèº«æœ‰å¯¹ key çš„å¼•ç”¨å¤–æ²¡æœ‰å…¶ä»–å¼•ç”¨ï¼Œmap ä¼šè‡ªåŠ¨ä¸¢å¼ƒæ­¤å€¼



***



##### ç›‘å¬å™¨

ç›‘å¬å™¨å’Œå…¶ä»–å›è°ƒæƒ…å†µï¼Œå‡å¦‚å®¢æˆ·ç«¯åœ¨å®ç°çš„ API ä¸­æ³¨å†Œå›è°ƒï¼Œå´æ²¡æœ‰æ˜¾å¼çš„å–æ¶ˆï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´ç§¯èšä¸‹å»ï¼Œæ‰€ä»¥ç¡®ä¿å›è°ƒç«‹å³è¢«å½“ä½œåƒåœ¾å›æ”¶çš„æœ€ä½³æ–¹æ³•æ˜¯åªä¿å­˜å®ƒçš„å¼±å¼•ç”¨ï¼Œæ¯”å¦‚ä¿å­˜ä¸º WeakHashMap ä¸­çš„é”®



***



#### æ¡ˆä¾‹åˆ†æ

```java
public class Stack {
    private Object[] elements;
    private int size = 0;
    private static final int DEFAULT_INITIAL_CAPACITY = 16;

    public Stack() {
        elements = new Object[DEFAULT_INITIAL_CAPACITY];
    }

    public void push(Object e) { //å…¥æ ˆ
        ensureCapacity();
        elements[size++] = e;
    }

    public Object pop() { //å‡ºæ ˆ
        if (size == 0)
            throw new EmptyStackException();
        return elements[--size];
    }

    private void ensureCapacity() {
        if (elements.length == size)
            elements = Arrays.copyOf(elements, 2 * size + 1);
    }
}
```

ç¨‹åºå¹¶æ²¡æœ‰æ˜æ˜¾é”™è¯¯ï¼Œä½† pop å‡½æ•°å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå› ä¸º pop å‡½æ•°åªæ˜¯æŠŠæ ˆé¡¶ç´¢å¼•ä¸‹ç§»ä¸€ä½ï¼Œå¹¶æ²¡æœ‰æŠŠä¸Šä¸€ä¸ªå‡ºæ ˆç´¢å¼•å¤„çš„å¼•ç”¨ç½®ç©ºï¼Œå¯¼è‡´æ ˆæ•°ç»„ä¸€ç›´å¼ºå¼•ç”¨ç€å·²ç»å‡ºæ ˆçš„å¯¹è±¡

è§£å†³æ–¹æ³•ï¼š

```java
public Object pop() {
    if (size == 0)
        throw new EmptyStackException();
    Object result = elements[--size];
    elements[size] = null;
    return result;
}
```





***





## ç±»åŠ è½½

### å¯¹è±¡ç»“æ„

#### å­˜å‚¨æ„é€ 

ä¸€ä¸ª Java å¯¹è±¡å†…å­˜ä¸­å­˜å‚¨ä¸ºä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å…… ï¼ˆPaddingï¼‰

å¯¹è±¡å¤´ï¼š

* æ™®é€šå¯¹è±¡ï¼šåˆ†ä¸ºä¸¤éƒ¨åˆ†

  * Mark Wordï¼šç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œ å¦‚å“ˆå¸Œç ï¼ˆHashCodeï¼‰ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ç­‰ç­‰

    ```ruby
    hash(25) + age(4) + lock(3) = 32bit					#32ä½ç³»ç»Ÿ
    unused(25+1) + hash(31) + age(4) + lock(3) = 64bit	#64ä½ç³»ç»Ÿ
    ```

  * Klass Wordï¼šç±»å‹æŒ‡é’ˆï¼Œå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»çš„å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ï¼›åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œå¼€å¯æŒ‡é’ˆå‹ç¼©ï¼ˆ-XX:+UseCompressedOopsï¼‰æˆ–è€… JVM å †çš„æœ€å¤§å€¼å°äº 32Gï¼Œè¿™ä¸ªæŒ‡é’ˆä¹Ÿæ˜¯ 4byteï¼Œå¦åˆ™æ˜¯ 8byteï¼ˆå°±æ˜¯ Java ä¸­çš„ä¸€ä¸ªå¼•ç”¨çš„å¤§å°ï¼‰

  ```ruby
  |-----------------------------------------------------|
  | 				  Object Header (64 bits) 			  |
  |---------------------------|-------------------------|
  | 	 Mark Word (32 bits)	|  Klass Word (32 bits)   |
  |---------------------------|-------------------------|
  ```

* æ•°ç»„å¯¹è±¡ï¼šå¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£åœ¨å¯¹è±¡å¤´ä¸­è¿˜æœ‰ä¸€å—æ•°æ®ç”¨äºè®°å½•æ•°ç»„é•¿åº¦

  ```ruby
  |-------------------------------------------------------------------------------|
  | 						  Object Header (96 bits) 							    |
  |-----------------------|-----------------------------|-------------------------|
  |  Mark Word(32bits)    | 	  Klass Word(32bits) 	  |   array length(32bits)  |
  |-----------------------|-----------------------------|-------------------------|
  ```

å®ä¾‹æ•°æ®ï¼šå®ä¾‹æ•°æ®éƒ¨åˆ†æ˜¯å¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯ï¼Œä¹Ÿæ˜¯åœ¨ç¨‹åºä»£ç ä¸­æ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹ï¼Œæ— è®ºæ˜¯ä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„ï¼Œè¿˜æ˜¯åœ¨å­ç±»ä¸­å®šä¹‰çš„ï¼Œéƒ½éœ€è¦è®°å½•èµ·æ¥

å¯¹é½å¡«å……ï¼šPadding èµ·å ä½ç¬¦çš„ä½œç”¨ã€‚64 ä½ç³»ç»Ÿï¼Œç”±äº HotSpot VM çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼Œå°±æ˜¯å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼Œè€Œå¯¹è±¡å¤´éƒ¨åˆ†æ­£å¥½æ˜¯ 8 å­—èŠ‚çš„å€æ•°ï¼ˆ1å€æˆ–è€…2å€ï¼‰ï¼Œå› æ­¤å½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½æ—¶ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨

32ä½ç³»ç»Ÿï¼š

* ä¸€ä¸ª int åœ¨ java ä¸­å æ® 4byteï¼Œæ‰€ä»¥ Integer çš„å¤§å°ä¸ºï¼š

  ```java
  private final int value;
  ```

  ```ruby
  # éœ€è¦è¡¥ä½4byte
  4(Mark Word) + 4(Klass Word) + 4(data) + 4(Padding) = 16byte
  ```

* `int[] arr = new int[10]`

  ```ruby
  # ç”±äºéœ€è¦8ä½å¯¹é½ï¼Œæ‰€ä»¥æœ€ç»ˆå¤§å°ä¸º`56byte`ã€‚
  4(Mark Word) + 4(Klass Word) + 4(length) + 4*10(10ä¸ªintå¤§å°) + 4(Padding) = 56sbyte 
  ```



***



#### å®é™…å¤§å°

æµ…å †ï¼ˆShallow Heapï¼‰ï¼šå¯¹è±¡æœ¬èº«å ç”¨çš„å†…å­˜ï¼Œä¸åŒ…æ‹¬å†…éƒ¨å¼•ç”¨å¯¹è±¡çš„å¤§å°ï¼Œ32 ä½ç³»ç»Ÿä¸­ä¸€ä¸ª**å¯¹è±¡å¼•ç”¨å  4 ä¸ªå­—èŠ‚**ï¼Œæ¯ä¸ªå¯¹è±¡å¤´å ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œæ ¹æ®å †å¿«ç…§æ ¼å¼ä¸åŒï¼Œå¯¹è±¡çš„å¤§å°ä¼šåŒ 8 å­—èŠ‚è¿›è¡Œå¯¹é½

JDK7 ä¸­çš„ Stringï¼š2ä¸ª int å€¼å…±å  8 å­—èŠ‚ï¼Œvalue å¯¹è±¡å¼•ç”¨å ç”¨ 4 å­—èŠ‚ï¼Œå¯¹è±¡å¤´ 8 å­—èŠ‚ï¼Œå¯¹é½åå  24 å­—èŠ‚ï¼Œä¸º String å¯¹è±¡çš„æµ…å †å¤§å°ï¼Œä¸ value å®é™…å–å€¼æ— å…³ï¼Œæ— è®ºå­—ç¬¦ä¸²é•¿åº¦å¦‚ä½•ï¼Œæµ…å †å¤§å°å§‹ç»ˆæ˜¯ 24 å­—èŠ‚

```java
private final char value[];
private int hash;
private int hash32;
```

ä¿ç•™é›†ï¼ˆRetained Setï¼‰ï¼šå¯¹è±¡ A çš„ä¿ç•™é›†æŒ‡å½“å¯¹è±¡ A è¢«åƒåœ¾å›æ”¶åï¼Œå¯ä»¥è¢«é‡Šæ”¾çš„æ‰€æœ‰çš„å¯¹è±¡é›†åˆï¼ˆåŒ…æ‹¬ A æœ¬èº«ï¼‰ï¼Œæ‰€ä»¥å¯¹è±¡ A çš„ä¿ç•™é›†å°±æ˜¯åªèƒ½é€šè¿‡å¯¹è±¡ A è¢«ç›´æ¥æˆ–é—´æ¥è®¿é—®åˆ°çš„æ‰€æœ‰å¯¹è±¡çš„é›†åˆï¼Œå°±æ˜¯ä»…è¢«å¯¹è±¡ A æ‰€æŒæœ‰çš„å¯¹è±¡çš„é›†åˆ

æ·±å †ï¼ˆRetained Heapï¼‰ï¼šæŒ‡å¯¹è±¡çš„ä¿ç•™é›†ä¸­æ‰€æœ‰çš„å¯¹è±¡çš„æµ…å †å¤§å°ä¹‹å’Œï¼Œä¸€ä¸ªå¯¹è±¡çš„æ·±å †æŒ‡åªèƒ½é€šè¿‡è¯¥å¯¹è±¡è®¿é—®åˆ°çš„ï¼ˆç›´æ¥æˆ–é—´æ¥ï¼‰æ‰€æœ‰å¯¹è±¡çš„æµ…å †ä¹‹å’Œï¼Œå³å¯¹è±¡è¢«å›æ”¶åï¼Œå¯ä»¥é‡Šæ”¾çš„çœŸå®ç©ºé—´

å¯¹è±¡çš„å®é™…å¤§å°ï¼šä¸€ä¸ªå¯¹è±¡æ‰€èƒ½è§¦åŠçš„æ‰€æœ‰å¯¹è±¡çš„æµ…å †å¤§å°ä¹‹å’Œï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ„ä¹‰ä¸Šæˆ‘ä»¬è¯´çš„å¯¹è±¡å¤§å°

ä¸‹å›¾æ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•çš„å¯¹è±¡å¼•ç”¨å…³ç³»å›¾ï¼Œå¯¹è±¡ A å¼•ç”¨äº† C å’Œ Dï¼Œå¯¹è±¡ B å¼•ç”¨äº† C å’Œ Eã€‚é‚£ä¹ˆå¯¹è±¡ A çš„æµ…å †å¤§å°åªæ˜¯ A æœ¬èº«ï¼ŒA çš„å®é™…å¤§å°ä¸º Aã€Cã€D ä¸‰è€…ä¹‹å’Œï¼ŒA çš„æ·±å †å¤§å°ä¸º A ä¸ D ä¹‹å’Œï¼Œç”±äºå¯¹è±¡ C è¿˜å¯ä»¥é€šè¿‡å¯¹è±¡ B è®¿é—®åˆ° Cï¼Œå› æ­¤ C ä¸åœ¨å¯¹è±¡ A çš„æ·±å †èŒƒå›´å†…

![](https://gitee.com/seazean/images/raw/master/Java/JVM-å¯¹è±¡çš„å®é™…å¤§å°.png)

å†…å­˜åˆ†æå·¥å…· MAT æä¾›äº†ä¸€ç§å«æ”¯é…æ ‘çš„å¯¹è±¡å›¾ï¼Œä½“ç°äº†å¯¹è±¡å®ä¾‹é—´çš„æ”¯é…å…³ç³»

åŸºæœ¬æ€§è´¨ï¼š

- å¯¹è±¡ A çš„å­æ ‘ï¼ˆæ‰€æœ‰è¢«å¯¹è±¡ A æ”¯é…çš„å¯¹è±¡é›†åˆï¼‰è¡¨ç¤ºå¯¹è±¡ A çš„ä¿ç•™é›†ï¼ˆretained setï¼‰ï¼Œå³æ·±å †

- å¦‚æœå¯¹è±¡ A æ”¯é…å¯¹è±¡ Bï¼Œé‚£ä¹ˆå¯¹è±¡ A çš„ç›´æ¥æ”¯é…è€…ä¹Ÿæ”¯é…å¯¹è±¡ B

- æ”¯é…æ ‘çš„è¾¹ä¸å¯¹è±¡å¼•ç”¨å›¾çš„è¾¹ä¸ç›´æ¥å¯¹åº”

å·¦å›¾è¡¨ç¤ºå¯¹è±¡å¼•ç”¨å›¾ï¼Œå³å›¾è¡¨ç¤ºå·¦å›¾æ‰€å¯¹åº”çš„æ”¯é…æ ‘ï¼š

![](https://gitee.com/seazean/images/raw/master/Java/JVM-æ”¯é…æ ‘.png)

æ¯”å¦‚ï¼šå¯¹è±¡ F ä¸å¯¹è±¡ D ç›¸äº’å¼•ç”¨ï¼Œå› ä¸ºåˆ°å¯¹è±¡ F çš„æ‰€æœ‰è·¯å¾„å¿…ç„¶ç»è¿‡å¯¹è±¡ Dï¼Œå› æ­¤å¯¹è±¡ D æ˜¯å¯¹è±¡ F çš„ç›´æ¥æ”¯é…è€…



***



#### èŠ‚çº¦å†…å­˜

* å°½é‡ä½¿ç”¨åŸºæœ¬ç±»å‹

* æ»¡è¶³å®¹é‡å‰æä¸‹ï¼Œå°½é‡ç”¨å°å­—æ®µ

* å°½é‡ç”¨æ•°ç»„ï¼Œå°‘ç”¨é›†åˆï¼Œæ•°ç»„ä¸­æ˜¯å¯ä»¥ä½¿ç”¨åŸºæœ¬ç±»å‹çš„ï¼Œä½†æ˜¯é›†åˆä¸­åªèƒ½æ”¾åŒ…è£…ç±»å‹ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨é›†åˆï¼Œæ¨èæ¯”è¾ƒèŠ‚çº¦å†…å­˜çš„é›†åˆå·¥å…·ï¼šfastutil

  ä¸€ä¸ª ArrayList é›†åˆï¼Œå¦‚æœé‡Œé¢æ”¾äº† 10 ä¸ªæ•°å­—ï¼Œå ç”¨å¤šå°‘å†…å­˜ï¼š

  ```java
  private transient Object[] elementData;
  private int size;
  ```

  Mark Word å  4byteï¼ŒKlass Word å  4byteï¼Œä¸€ä¸ª int å­—æ®µå  4byteï¼ŒelementData æ•°ç»„å  12(4+4+4)ï¼Œæ•°ç»„ä¸­ 10 ä¸ª Integer å¯¹è±¡å  10Ã—16ï¼Œæ‰€ä»¥æ•´ä¸ªé›†åˆç©ºé—´å¤§å°ä¸º 184byteï¼ˆæ·±å †ï¼‰

* æ—¶é—´ç”¨ long/int è¡¨ç¤ºï¼Œä¸ç”¨ Date æˆ–è€… String



***



#### å¯¹è±¡è®¿é—®

JVM æ˜¯é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹ï¼š

* å¥æŸ„è®¿é—®
  ä½¿ç”¨è¯¥æ–¹å¼ï¼ŒJava å †ä¸­ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œreference ä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®å’Œç±»å‹æ•°æ®å„è‡ªçš„å…·ä½“åœ°å€ä¿¡æ¯
  ä¼˜ç‚¹ï¼šreference ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†ï¼‰æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œ reference æœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚

  <img src="https://gitee.com/seazean/images/raw/master/Java/JVM-å¯¹è±¡è®¿é—®-å¥æŸ„è®¿é—®.png" style="zoom: 50%;" />

* ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰
  ä½¿ç”¨è¯¥æ–¹å¼ï¼ŒJava å †å¯¹è±¡çš„å¸ƒå±€å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œreferenceä¸­ç›´æ¥å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡åœ°å€
  ä¼˜ç‚¹ï¼šé€Ÿåº¦æ›´å¿«ï¼Œ**èŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€**

  <img src="https://gitee.com/seazean/images/raw/master/Java/JVM-å¯¹è±¡è®¿é—®-ç›´æ¥æŒ‡é’ˆ.png" style="zoom: 67%;" />





***



### å¯¹è±¡åˆ›å»º

#### ç”Ÿå‘½å‘¨æœŸ

åœ¨ Java ä¸­ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1.      åˆ›å»ºé˜¶æ®µ (Created)ï¼š
2.      åº”ç”¨é˜¶æ®µ (In Use)ï¼šå¯¹è±¡è‡³å°‘è¢«ä¸€ä¸ªå¼ºå¼•ç”¨æŒæœ‰ç€
3.      ä¸å¯è§é˜¶æ®µ (Invisible)ï¼šç¨‹åºçš„æ‰§è¡Œå·²ç»è¶…å‡ºäº†è¯¥å¯¹è±¡çš„ä½œç”¨åŸŸï¼Œä¸å†æŒæœ‰è¯¥å¯¹è±¡çš„ä»»ä½•å¼ºå¼•ç”¨
4.      ä¸å¯è¾¾é˜¶æ®µ (Unreachable)ï¼šè¯¥å¯¹è±¡ä¸å†è¢«ä»»ä½•å¼ºå¼•ç”¨æ‰€æŒæœ‰ï¼ŒåŒ…æ‹¬GC Rootçš„å¼ºå¼•ç”¨
5.      æ”¶é›†é˜¶æ®µ (Collected)ï¼šåƒåœ¾å›æ”¶å™¨å·²ç»å¯¹è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´é‡æ–°åˆ†é…åšå¥½å‡†å¤‡ï¼Œè¯¥å¯¹è±¡å¦‚æœé‡å†™äº†finalize()æ–¹æ³•ï¼Œåˆ™ä¼šå»æ‰§è¡Œè¯¥æ–¹æ³•
6.      ç»ˆç»“é˜¶æ®µ (Finalized)ï¼šç­‰å¾…åƒåœ¾å›æ”¶å™¨å¯¹è¯¥å¯¹è±¡ç©ºé—´è¿›è¡Œå›æ”¶ï¼Œå½“å¯¹è±¡æ‰§è¡Œå®Œfinalize()æ–¹æ³•åä»ç„¶å¤„äºä¸å¯è¾¾çŠ¶æ€æ—¶è¿›å…¥è¯¥é˜¶æ®µ
7.      å¯¹è±¡ç©ºé—´é‡åˆ†é…é˜¶æ®µ (De-allocated)ï¼šåƒåœ¾å›æ”¶å™¨å¯¹è¯¥å¯¹è±¡çš„æ‰€å ç”¨çš„å†…å­˜ç©ºé—´è¿›è¡Œå›æ”¶æˆ–è€…å†åˆ†é…



å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/sodino/article/details/38387049



***



#### åˆ›å»ºæ—¶æœº

ç±»åœ¨ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–åŠ è½½ä¸€æ¬¡ï¼Œåç»­å®ä¾‹åŒ–ä¸å†åŠ è½½ï¼Œå¼•ç”¨ç¬¬ä¸€æ¬¡åŠ è½½çš„ç±»

Javaå¯¹è±¡åˆ›å»ºæ—¶æœºï¼š

1. ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºå¯¹è±¡ï¼šç”±æ‰§è¡Œç±»å®ä¾‹åˆ›å»ºè¡¨è¾¾å¼è€Œå¼•èµ·çš„å¯¹è±¡åˆ›å»º

2. ä½¿ç”¨ Class ç±»çš„ newInstance æ–¹æ³• (åå°„æœºåˆ¶)

3. ä½¿ç”¨ Constructor ç±»çš„ newInstance æ–¹æ³•(åå°„æœºåˆ¶)

   ```java
   public class Student {
       private int id;
       public Student(Integer id) {
           this.id = id;
       }
       public static void main(String[] args) throws Exception {
           Constructor<Student> c = Student.class.getConstructor(Integer.class);
           Student stu = c.newInstance(123);
       }
   }
   ```

   ä½¿ç”¨ newInstance æ–¹æ³•çš„è¿™ä¸¤ç§æ–¹å¼åˆ›å»ºå¯¹è±¡ä½¿ç”¨çš„å°±æ˜¯ Java çš„åå°„æœºåˆ¶ï¼Œäº‹å®ä¸Š Class çš„ newInstance æ–¹æ³•å†…éƒ¨è°ƒç”¨çš„ä¹Ÿæ˜¯ Constructor çš„ newInstance æ–¹æ³•

4. ä½¿ç”¨ Clone æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼šç”¨ clone æ–¹æ³•åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šè°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°ï¼Œè¦æƒ³ä½¿ç”¨ clone æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¿…é¡»å…ˆå®ç° Cloneable æ¥å£å¹¶å®ç°å…¶å®šä¹‰çš„ clone æ–¹æ³•

5. ä½¿ç”¨ï¼ˆåï¼‰åºåˆ—åŒ–æœºåˆ¶åˆ›å»ºå¯¹è±¡ï¼šå½“ååºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒJVM ä¼šåˆ›å»ºä¸€ä¸ª**å•ç‹¬çš„å¯¹è±¡**ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼ŒJVM å¹¶ä¸ä¼šè°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°ï¼Œä¸ºäº†ååºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦è®©ç±»å®ç° Serializable æ¥å£

ä» Java è™šæ‹Ÿæœºå±‚é¢çœ‹ï¼Œé™¤äº†ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºå¯¹è±¡çš„æ–¹å¼å¤–ï¼Œå…¶ä»–æ–¹å¼å…¨éƒ¨éƒ½æ˜¯é€šè¿‡è½¬å˜ä¸º invokevirtual æŒ‡ä»¤ç›´æ¥åˆ›å»ºå¯¹è±¡çš„



***



#### åˆ›å»ºè¿‡ç¨‹

åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼š

1. åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–

2. ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šæŒ‡é’ˆç¢°æ’ã€ç©ºé—²é“¾è¡¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…å†…å­˜æ¥å­˜æ”¾å¯¹è±¡çš„å®ä¾‹å˜é‡åŠå…¶ä»çˆ¶ç±»ç»§æ‰¿è¿‡æ¥çš„å®ä¾‹å˜é‡ï¼Œå³ä½¿ä»**éšè—å˜é‡**ä¹Ÿä¼šè¢«åˆ†é…ç©ºé—´ï¼ˆç»§æ‰¿éƒ¨åˆ†è§£é‡Šäº†ä¸ºä»€ä¹ˆä¼šéšè—ï¼‰

3. å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜ï¼š

   * é‡‡ç”¨ CAS é…ä¸Šè‡ªæ—‹ä¿è¯æ›´æ–°çš„åŸå­æ€§
   * æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåˆ†é…ä¸€å— TLAB

4. åˆå§‹åŒ–åˆ†é…çš„ç©ºé—´ï¼šè™šæ‹Ÿæœºå°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µåœ¨ä¸èµ‹å€¼æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼

5. è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´ï¼šå°†å¯¹è±¡çš„æ‰€å±ç±»ï¼ˆç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€å¯¹è±¡çš„HashCodeã€å¯¹è±¡çš„GCä¿¡æ¯ã€é”ä¿¡æ¯ç­‰æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­

6. æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ï¼šå®ä¾‹å˜é‡åˆå§‹åŒ–ã€å®ä¾‹ä»£ç å—åˆå§‹åŒ– ã€æ„é€ å‡½æ•°åˆå§‹åŒ–

   * å®ä¾‹å˜é‡åˆå§‹åŒ–ä¸å®ä¾‹ä»£ç å—åˆå§‹åŒ–ï¼š

     å¯¹å®ä¾‹å˜é‡ç›´æ¥èµ‹å€¼æˆ–è€…ä½¿ç”¨å®ä¾‹ä»£ç å—èµ‹å€¼ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶ä¸­çš„ä»£ç æ”¾åˆ°ç±»çš„æ„é€ å‡½æ•°ä¸­å»ï¼Œå¹¶ä¸”è¿™äº›ä»£ç ä¼šè¢«æ”¾åœ¨å¯¹è¶…ç±»æ„é€ å‡½æ•°çš„è°ƒç”¨è¯­å¥ä¹‹å (**Javaè¦æ±‚æ„é€ å‡½æ•°çš„ç¬¬ä¸€æ¡è¯­å¥å¿…é¡»æ˜¯è¶…ç±»æ„é€ å‡½æ•°çš„è°ƒç”¨è¯­å¥**)ï¼Œæ„é€ å‡½æ•°æœ¬èº«çš„ä»£ç ä¹‹å‰

   * æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼š

     **Javaè¦æ±‚åœ¨å®ä¾‹åŒ–ç±»ä¹‹å‰ï¼Œå¿…é¡»å…ˆå®ä¾‹åŒ–å…¶è¶…ç±»ï¼Œä»¥ä¿è¯æ‰€åˆ›å»ºå®ä¾‹çš„å®Œæ•´æ€§**ï¼Œåœ¨å‡†å¤‡å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„å¯¹è±¡å‰ï¼Œé¦–å…ˆå‡†å¤‡å®ä¾‹åŒ–è¯¥ç±»çš„çˆ¶ç±»ï¼Œå¦‚æœè¯¥ç±»çš„çˆ¶ç±»è¿˜æœ‰çˆ¶ç±»ï¼Œé‚£ä¹ˆå‡†å¤‡å®ä¾‹åŒ–è¯¥ç±»çš„çˆ¶ç±»çš„çˆ¶ç±»ï¼Œä¾æ¬¡é€’å½’ç›´åˆ°é€’å½’åˆ°Objectç±»ã€‚ç„¶åä»Objectç±»ä¾æ¬¡å¯¹ä»¥ä¸‹å„ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–çˆ¶ç±»ä¸­çš„å˜é‡å’Œæ‰§è¡Œæ„é€ å‡½æ•°



***



#### æ‰¿ä¸Šå¯ä¸‹

1. ä¸€ä¸ªå®ä¾‹å˜é‡åœ¨å¯¹è±¡åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè¢«èµ‹å€¼å‡ æ¬¡ï¼Ÿ

   JVMåœ¨ä¸ºä¸€ä¸ªå¯¹è±¡åˆ†é…å®Œå†…å­˜ä¹‹åï¼Œä¼šç»™æ¯ä¸€ä¸ªå®ä¾‹å˜é‡èµ‹äºˆé»˜è®¤å€¼ï¼Œè¿™ä¸ªå®ä¾‹å˜é‡è¢«ç¬¬ä¸€æ¬¡èµ‹å€¼
   åœ¨å£°æ˜å®ä¾‹å˜é‡çš„åŒæ—¶å¯¹å…¶è¿›è¡Œäº†èµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å˜é‡å°±è¢«ç¬¬äºŒæ¬¡èµ‹å€¼
   åœ¨å®ä¾‹ä»£ç å—ä¸­åˆå¯¹å˜é‡åšäº†åˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å˜é‡å°±è¢«ç¬¬ä¸‰æ¬¡èµ‹å€¼
   åœ¨æ„é€ å‡½æ•°ä¸­ä¹Ÿå¯¹å˜é‡åšäº†åˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å˜é‡å°±è¢«ç¬¬å››æ¬¡èµ‹å€¼
   åœ¨Javaçš„å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå®ä¾‹å˜é‡æœ€å¤šå¯ä»¥è¢«åˆå§‹åŒ–4æ¬¡

2. ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹çš„å¼‚åŒï¼Ÿ

   ç±»çš„åˆå§‹åŒ–æ˜¯æŒ‡ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é˜¶æ®µå¯¹ç±»å˜é‡æŒ‰ç…§ä»£ç è¿›è¡Œèµ‹å€¼çš„è¿‡ç¨‹
   ç±»çš„å®ä¾‹åŒ–æ˜¯æŒ‡åœ¨ç±»å®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ååˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼ˆç±»çš„å®ä¾‹åŒ–è§¦å‘äº†ç±»çš„åˆå§‹åŒ–ï¼‰

3. å‡å¦‚ä¸€ä¸ªç±»è¿˜æœªåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹æ—¶ï¼Œå…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿï¼ˆ**ç»å…¸æ¡ˆä¾‹**ï¼‰

   ```java
   public class StaticTest {
       public static void main(String[] args) {
           staticFunction();//è°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§¦å‘åˆå§‹åŒ–
       }
   
       static StaticTest st = new StaticTest();
   
       static {   //é™æ€ä»£ç å—
           System.out.println("1");
       }
   
       {       // å®ä¾‹ä»£ç å—
           System.out.println("2");
       }
   
       StaticTest() {    // å®ä¾‹æ„é€ å™¨
           System.out.println("3");
           System.out.println("a=" + a + ",b=" + b);
       }
   
       public static void staticFunction() {   // é™æ€æ–¹æ³•
           System.out.println("4");
       }
   
       int a = 110;    // å®ä¾‹å˜é‡
       static int b = 112;     // é™æ€å˜é‡
   }/* Output: 
           2
           3
           a=110,b=0
           1
           4
    *///:~
   ```

   `static StaticTest st = new StaticTest();`ï¼š

   * å®ä¾‹åˆå§‹åŒ–ä¸ä¸€å®šè¦åœ¨ç±»åˆå§‹åŒ–ç»“æŸä¹‹åæ‰å¼€å§‹

   * åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹ï¼Œä¸€ä¸ªç±»å‹åªä¼šè¢«åˆå§‹åŒ–ä¸€æ¬¡ã€‚æ‰€ä»¥ä¸€æ—¦å¼€å§‹åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œæ— è®ºæ˜¯å¦å®Œæˆåç»­éƒ½ä¸ä¼šå†é‡æ–°è§¦å‘è¯¥ç±»å‹çš„åˆå§‹åŒ–é˜¶æ®µäº†ï¼ˆåªè€ƒè™‘åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹çš„æƒ…å½¢ã€‚å› æ­¤ï¼Œåœ¨å®ä¾‹åŒ–ä¸Šè¿°ç¨‹åºä¸­çš„stå˜é‡æ—¶ï¼Œ**å®é™…ä¸Šæ˜¯æŠŠå®ä¾‹åˆå§‹åŒ–åµŒå…¥åˆ°äº†é™æ€åˆå§‹åŒ–æµç¨‹ä¸­ï¼Œå¹¶ä¸”åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼ŒåµŒå…¥åˆ°äº†é™æ€åˆå§‹åŒ–çš„èµ·å§‹ä½ç½®**ï¼Œè¿™å°±å¯¼è‡´äº†å®ä¾‹åˆå§‹åŒ–å®Œå…¨å‘ç”Ÿåœ¨é™æ€åˆå§‹åŒ–ä¹‹å‰ï¼Œè¿™ä¹Ÿæ˜¯å¯¼è‡´aä¸º110 bä¸º0çš„åŸå› 

   ä»£ç ç­‰ä»·äºï¼š

   ```java
   public class StaticTest {
       <clinit>(){
           a = 110;    // å®ä¾‹å˜é‡
           System.out.println("2");        // å®ä¾‹ä»£ç å—
           System.out.println("3");     // å®ä¾‹æ„é€ å™¨ä¸­ä»£ç çš„æ‰§è¡Œ
           System.out.println("a=" + a + ",b=" + b);  // å®ä¾‹æ„é€ å™¨ä¸­ä»£ç çš„æ‰§è¡Œ
           ç±»å˜é‡stè¢«åˆå§‹åŒ–
           System.out.println("1");        //é™æ€ä»£ç å—
           ç±»å˜é‡bè¢«åˆå§‹åŒ–ä¸º112
       }
   }
   ```

   



***



### åŠ è½½è¿‡ç¨‹

#### ç”Ÿå‘½å‘¨æœŸ

ç±»æ˜¯åœ¨è¿è¡ŒæœŸé—´**ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶åŠ¨æ€åŠ è½½**çš„ï¼ˆä¸ä½¿ç”¨ä¸åŠ è½½ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç±»ï¼Œå› ä¸ºä¸€æ¬¡æ€§åŠ è½½ä¼šå ç”¨å¾ˆå¤šçš„å†…å­˜ï¼ŒåŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—æˆä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´

![](https://gitee.com/seazean/images/raw/master/Java/JVM-ç±»çš„ç”Ÿå‘½å‘¨æœŸ.png)

åŒ…æ‹¬ 7 ä¸ªé˜¶æ®µï¼š

* åŠ è½½ï¼ˆLoadingï¼‰
* é“¾æ¥ï¼šéªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰
* åˆå§‹åŒ–ï¼ˆInitializationï¼‰
* ä½¿ç”¨ï¼ˆUsingï¼‰
* å¸è½½ï¼ˆUnloadingï¼‰



***



#### åŠ è½½é˜¶æ®µ

åŠ è½½æ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ³¨æ„ä¸è¦æ··æ·†

åŠ è½½è¿‡ç¨‹å®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š

- é€šè¿‡ç±»çš„å®Œå…¨é™å®šåç§°è·å–å®šä¹‰è¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼ˆäºŒè¿›åˆ¶å­—èŠ‚ç ï¼‰
- å°†è¯¥å­—èŠ‚æµè¡¨ç¤ºçš„**é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å­˜å‚¨ç»“æ„**ï¼ˆJava ç±»æ¨¡å‹ï¼‰
- åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ Class å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºä¸­è¯¥ç±»å„ç§æ•°æ®çš„è®¿é—®å…¥å£

å…¶ä¸­äºŒè¿›åˆ¶å­—èŠ‚æµå¯ä»¥ä»ä»¥ä¸‹æ–¹å¼ä¸­è·å–ï¼š

- ä» ZIP åŒ…è¯»å–ï¼Œæˆä¸º JARã€EARã€WAR æ ¼å¼çš„åŸºç¡€
- ä»ç½‘ç»œä¸­è·å–ï¼Œæœ€å…¸å‹çš„åº”ç”¨æ˜¯ Applet
- ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œä¾‹å¦‚ç”± JSP æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ Class ç±»
- è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä¾‹å¦‚åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œåœ¨ java.lang.reflect.Proxy ä½¿ç”¨ ProxyGenerator.generateProxyClass 

å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½è‡³å…ƒç©ºé—´åï¼Œä¼š**åœ¨å †ä¸­**åˆ›å»ºä¸€ä¸ª java.lang.Class å¯¹è±¡ï¼Œç”¨æ¥å°è£…ç±»ä½äºæ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ï¼Œè¯¥ Class å¯¹è±¡æ˜¯åœ¨åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­åˆ›å»ºçš„ï¼Œæ¯ä¸ªç±»éƒ½å¯¹åº”æœ‰ä¸€ä¸ª Class ç±»å‹çš„å¯¹è±¡

æ–¹æ³•åŒºå†…éƒ¨é‡‡ç”¨ C++ çš„ instanceKlass æè¿° java ç±»çš„æ•°æ®ç»“æ„ï¼š

* `_java_mirror` å³ java çš„ç±»é•œåƒï¼Œä¾‹å¦‚å¯¹ String æ¥è¯´å°±æ˜¯ String.classï¼Œä½œç”¨æ˜¯æŠŠ class æš´éœ²ç»™ java ä½¿ç”¨
* `_super` å³çˆ¶ç±»ã€`_fields` å³æˆå‘˜å˜é‡ã€`_methods` å³æ–¹æ³•ã€`_constants` å³å¸¸é‡æ± ã€`_class_loader` å³ç±»åŠ è½½å™¨ã€`_vtable` **è™šæ–¹æ³•è¡¨**ã€`_itable` æ¥å£æ–¹æ³•è¡¨

åŠ è½½è¿‡ç¨‹ï¼š

* å¦‚æœè¿™ä¸ªç±»è¿˜æœ‰çˆ¶ç±»æ²¡æœ‰åŠ è½½ï¼Œå…ˆåŠ è½½çˆ¶ç±»
* åŠ è½½å’Œé“¾æ¥å¯èƒ½æ˜¯äº¤æ›¿è¿è¡Œçš„
* Class å¯¹è±¡å’Œ _java_mirror ç›¸äº’æŒæœ‰å¯¹æ–¹çš„åœ°å€ï¼Œå †ä¸­å¯¹è±¡é€šè¿‡ instanceKlass å’Œå…ƒç©ºé—´è¿›è¡Œäº¤äº’

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-ç±»çš„ç”Ÿå‘½å‘¨æœŸ-åŠ è½½.png" style="zoom:80%;" />

åˆ›å»ºæ•°ç»„ç±»æœ‰äº›ç‰¹æ®Šï¼Œå› ä¸ºæ•°ç»„ç±»æœ¬èº«å¹¶ä¸æ˜¯ç”±ç±»åŠ è½½å™¨è´Ÿè´£åˆ›å»ºï¼Œè€Œæ˜¯ç”± JVM åœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦è€Œç›´æ¥åˆ›å»ºçš„ï¼Œä½†æ•°ç»„çš„å…ƒç´ ç±»å‹ä»ç„¶éœ€è¦ä¾é ç±»åŠ è½½å™¨å»åˆ›å»ºï¼Œåˆ›å»ºæ•°ç»„ç±»çš„è¿‡ç¨‹ï¼š

- å¦‚æœæ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆéµå¾ªå®šä¹‰çš„åŠ è½½è¿‡ç¨‹é€’å½’åŠ è½½å’Œåˆ›å»ºæ•°ç»„çš„å…ƒç´ ç±»å‹
- JVM ä½¿ç”¨æŒ‡å®šçš„å…ƒç´ ç±»å‹å’Œæ•°ç»„ç»´åº¦æ¥åˆ›å»ºæ–°çš„æ•°ç»„ç±»
- åŸºæœ¬æ•°æ®ç±»å‹ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½



***



#### é“¾æ¥é˜¶æ®µ

##### éªŒè¯

ç¡®ä¿ Class æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯æ˜¯å¦ç¬¦åˆ JVM è§„èŒƒï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨

ä¸»è¦åŒ…æ‹¬**å››ç§éªŒè¯**ï¼š

* æ–‡ä»¶æ ¼å¼éªŒè¯

* è¯­ä¹‰æ£€æŸ¥ï¼Œä½†å‡¡åœ¨è¯­ä¹‰ä¸Šä¸ç¬¦åˆè§„èŒƒçš„ï¼Œè™šæ‹Ÿæœºä¸ä¼šç»™äºˆéªŒè¯é€šè¿‡

  * æ˜¯å¦æ‰€æœ‰çš„ç±»éƒ½æœ‰çˆ¶ç±»çš„å­˜åœ¨ï¼ˆé™¤äº† Object å¤–ï¼Œå…¶ä»–ç±»éƒ½åº”è¯¥æœ‰çˆ¶ç±»ï¼‰

  * æ˜¯å¦ä¸€äº›è¢«å®šä¹‰ä¸º final çš„æ–¹æ³•æˆ–è€…ç±»è¢«é‡å†™æˆ–ç»§æ‰¿äº†

  * éæŠ½è±¡ç±»æ˜¯å¦å®ç°äº†æ‰€æœ‰æŠ½è±¡æ–¹æ³•æˆ–è€…æ¥å£æ–¹æ³•

  * æ˜¯å¦å­˜åœ¨ä¸å…¼å®¹çš„æ–¹æ³•

* å­—èŠ‚ç éªŒè¯ï¼Œè¯•å›¾é€šè¿‡å¯¹å­—èŠ‚ç æµçš„åˆ†æï¼Œåˆ¤æ–­å­—èŠ‚ç æ˜¯å¦å¯ä»¥è¢«æ­£ç¡®åœ°æ‰§è¡Œ

  * åœ¨å­—èŠ‚ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦ä¼šè·³è½¬åˆ°ä¸€æ¡ä¸å­˜åœ¨çš„æŒ‡ä»¤
  * å‡½æ•°çš„è°ƒç”¨æ˜¯å¦ä¼ é€’äº†æ­£ç¡®ç±»å‹çš„å‚æ•°
  * å˜é‡çš„èµ‹å€¼æ˜¯ä¸æ˜¯ç»™äº†æ­£ç¡®çš„æ•°æ®ç±»å‹
  * æ ˆæ˜ å°„å¸§ï¼ˆStackMapTableï¼‰åœ¨è¿™ä¸ªé˜¶æ®µç”¨äºæ£€æµ‹åœ¨ç‰¹å®šçš„å­—èŠ‚ç å¤„ï¼Œå…¶å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆæ˜¯å¦æœ‰ç€æ­£ç¡®çš„æ•°æ®ç±»å‹

* ç¬¦å·å¼•ç”¨éªŒè¯ï¼ŒClass æ–‡ä»¶åœ¨å…¶å¸¸é‡æ± ä¼šé€šè¿‡å­—ç¬¦ä¸²è®°å½•å°†è¦ä½¿ç”¨çš„å…¶ä»–ç±»æˆ–è€…æ–¹æ³•



***



##### å‡†å¤‡

å‡†å¤‡é˜¶æ®µä¸º**é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼**ï¼Œä½¿ç”¨çš„æ˜¯æ–¹æ³•åŒºçš„å†…å­˜ï¼š

* ç±»å˜é‡ä¹Ÿå«é™æ€å˜é‡ï¼Œå°±æ˜¯æ˜¯è¢« static ä¿®é¥°çš„å˜é‡
* å®ä¾‹å˜é‡ä¹Ÿå«å¯¹è±¡å˜é‡ï¼Œå³æ²¡åŠ  static çš„å˜é‡

å®ä¾‹å˜é‡ä¸ä¼šåœ¨è¿™é˜¶æ®µåˆ†é…å†…å­˜ï¼Œå®ƒä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·è¢«åˆ†é…åœ¨å †ä¸­ã€‚ç±»åŠ è½½å‘ç”Ÿåœ¨æ‰€æœ‰å®ä¾‹åŒ–æ“ä½œä¹‹å‰ï¼Œå¹¶ä¸”ç±»åŠ è½½åªè¿›è¡Œä¸€æ¬¡ï¼Œå®ä¾‹åŒ–å¯ä»¥è¿›è¡Œå¤šæ¬¡

ç±»å˜é‡åˆå§‹åŒ–ï¼š

* static å˜é‡åœ¨ JDK 7 ä¹‹å‰å­˜å‚¨äº instanceKlass æœ«å°¾ï¼Œä» JDK 7 å¼€å§‹ï¼Œå­˜å‚¨äº _java_mirror æœ«å°¾
* static å˜é‡åˆ†é…ç©ºé—´å’Œèµ‹å€¼æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼š**åˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ**
* å¦‚æœ static å˜é‡æ˜¯ final çš„åŸºæœ¬ç±»å‹ä»¥åŠå­—ç¬¦ä¸²å¸¸é‡ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šäº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–
* å¦‚æœ static å˜é‡æ˜¯ final çš„ï¼Œä½†å±äºå¼•ç”¨ç±»å‹æˆ–è€…æ„é€ å™¨æ–¹æ³•çš„å­—ç¬¦ä¸²ï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

å®ä¾‹ï¼š

* åˆå§‹å€¼ä¸€èˆ¬ä¸º 0 å€¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç±»å˜é‡ value è¢«åˆå§‹åŒ–ä¸º 0 è€Œä¸æ˜¯ 123ï¼š

  ```java
  public static int value = 123;
  ```

* å¸¸é‡ value è¢«åˆå§‹åŒ–ä¸º 123 è€Œä¸æ˜¯ 0ï¼š

  ```java
  public static final int value = 123;
  ```

* Java å¹¶ä¸æ”¯æŒ boolean ç±»å‹ï¼Œå¯¹äº boolean ç±»å‹ï¼Œå†…éƒ¨å®ç°æ˜¯ intï¼Œç”±äº int çš„é»˜è®¤å€¼æ˜¯0ï¼Œæ•… boolean çš„é»˜è®¤å€¼å°±æ˜¯ false



***



##### è§£æ

å°†å¸¸é‡æ± ä¸­ç±»ã€æ¥å£ã€å­—æ®µã€æ–¹æ³•çš„**ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨**ï¼ˆå†…å­˜åœ°å€ï¼‰çš„è¿‡ç¨‹ï¼š

* ç¬¦å·å¼•ç”¨ï¼šä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ï¼Œå±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µå¦‚ï¼šåŒ…æ‹¬ç±»å’Œæ¥å£çš„å…¨é™åã€å­—æ®µçš„åç§°å’Œæè¿°ç¬¦ã€æ–¹æ³•çš„åç§°å’Œ**æ–¹æ³•æè¿°ç¬¦**
* ç›´æ¥å¼•ç”¨ï¼šç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ï¼Œå¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£è¯´æ˜å¼•ç”¨çš„ç›®æ ‡å¿…å®šå·²ç»å­˜åœ¨äºå†…å­˜ä¹‹ä¸­

è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰

* åœ¨ç±»åŠ è½½é˜¶æ®µè§£æçš„æ˜¯éè™šæ–¹æ³•ï¼Œé™æ€ç»‘å®š
* ä¹Ÿå¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹è§£æï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ Java çš„**åŠ¨æ€ç»‘å®š**
* é€šè¿‡è§£ææ“ä½œï¼Œç¬¦å·å¼•ç”¨å°±å¯ä»¥è½¬å˜ä¸ºç›®æ ‡æ–¹æ³•åœ¨ç±»ä¸­è™šæ–¹æ³•è¡¨ä¸­çš„ä½ç½®ï¼Œä»è€Œä½¿å¾—æ–¹æ³•è¢«æˆåŠŸè°ƒç”¨

```java
public class Load2 {
    public static void main(String[] args) throws Exception{
    ClassLoader classloader = Load2.class.getClassLoader();
    // cloadClass åŠ è½½ç±»æ–¹æ³•ä¸ä¼šå¯¼è‡´ç±»çš„è§£æå’Œåˆå§‹åŒ–ï¼Œä¹Ÿä¸ä¼šåŠ è½½D
    Class<?> c = classloader.loadClass("cn.jvm.t3.load.C");
        
    // new C();ä¼šå¯¼è‡´ç±»çš„è§£æå’Œåˆå§‹åŒ–ï¼Œä»è€Œè§£æåˆå§‹åŒ–D
    System.in.read();
    }
}
class C {
	D d = new D();
}
class D {
}
```



****



#### åˆå§‹åŒ–

##### ä»‹ç»

åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç ï¼Œåœ¨å‡†å¤‡é˜¶æ®µï¼Œç±»å˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼ï¼›åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œé€šè¿‡ç¨‹åºåˆ¶å®šçš„è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶å®ƒèµ„æºï¼Œæ‰§è¡Œ <clinit>

åœ¨ç¼–è¯‘ç”Ÿæˆ class æ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨ä¼šäº§ç”Ÿä¸¤ä¸ªæ–¹æ³•åŠ äº class æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªæ˜¯ç±»çš„åˆå§‹åŒ–æ–¹æ³• clinit, å¦ä¸€ä¸ªæ˜¯å®ä¾‹çš„åˆå§‹åŒ–æ–¹æ³• init

ç±»æ„é€ å™¨ <clinit>() ä¸å®ä¾‹æ„é€ å™¨ <init>() ä¸åŒï¼Œå®ƒä¸éœ€è¦ç¨‹åºå‘˜è¿›è¡Œæ˜¾å¼è°ƒç”¨ï¼Œåœ¨ä¸€ä¸ªç±»çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œç±»æ„é€ å™¨æœ€å¤šè¢«è™šæ‹Ÿæœº**è°ƒç”¨ä¸€æ¬¡**ï¼Œè€Œå®ä¾‹æ„é€ å™¨åˆ™ä¼šè¢«è™šæ‹Ÿæœºè°ƒç”¨å¤šæ¬¡ï¼Œåªè¦ç¨‹åºå‘˜åˆ›å»ºå¯¹è±¡

ç±»åœ¨ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–åŠ è½½ä¸€æ¬¡ï¼ŒæŠŠ class è¯»å…¥å†…å­˜ï¼Œåç»­å®ä¾‹åŒ–ä¸å†åŠ è½½ï¼Œå¼•ç”¨ç¬¬ä¸€æ¬¡åŠ è½½çš„ç±»



***



##### clinit

<clinit>()ï¼šç±»æ„é€ å™¨ï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„

ä½œç”¨ï¼šæ˜¯åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é˜¶æ®µè¿›è¡Œé™æ€å˜é‡åˆå§‹åŒ–å’Œæ‰§è¡Œé™æ€ä»£ç å—

* å¦‚æœç±»ä¸­æ²¡æœ‰é™æ€å˜é‡æˆ–é™æ€ä»£ç å—ï¼Œé‚£ä¹ˆ clinit æ–¹æ³•å°†ä¸ä¼šè¢«ç”Ÿæˆ
* clinit æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨æ‰§è¡Œ clinit æ–¹æ³•æ—¶ï¼Œå¿…é¡»å…ˆæ‰§è¡Œçˆ¶ç±»çš„clinitæ–¹æ³•
* static å˜é‡çš„èµ‹å€¼æ“ä½œå’Œé™æ€ä»£ç å—çš„åˆå¹¶é¡ºåºç”±æºæ–‡ä»¶ä¸­**å‡ºç°çš„é¡ºåº**å†³å®š
* static ä¸åŠ  final çš„å˜é‡éƒ½åœ¨åˆå§‹åŒ–ç¯èŠ‚èµ‹å€¼

**çº¿ç¨‹å®‰å…¨**é—®é¢˜ï¼š

* è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„ <clinit>() æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¢«æ­£ç¡®çš„åŠ é”å’ŒåŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸ªç±»çš„ <clinit>() æ–¹æ³•ï¼Œå…¶å®ƒçº¿ç¨‹éƒ½é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ <clinit>() æ–¹æ³•å®Œæ¯•
* å¦‚æœåœ¨ä¸€ä¸ªç±»çš„ <clinit>() æ–¹æ³•ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œå°±å¯èƒ½é€ æˆå¤šä¸ªçº¿ç¨‹é˜»å¡ï¼Œåœ¨å®é™…è¿‡ç¨‹ä¸­æ­¤ç§é˜»å¡å¾ˆéšè”½

ç‰¹åˆ«æ³¨æ„ï¼šé™æ€è¯­å¥å—åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨å®ƒä¹‹å‰çš„ç±»å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„ç±»å˜é‡åªèƒ½èµ‹å€¼ï¼Œä¸èƒ½è®¿é—®

```java
public class Test {
    static {
        //i = 0;                // ç»™å˜é‡èµ‹å€¼å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡
        System.out.print(i);  // è¿™å¥ç¼–è¯‘å™¨ä¼šæç¤ºâ€œéæ³•å‘å‰å¼•ç”¨â€
    }
    static int i = 1;
}
```

è¡¥å……ï¼š

æ¥å£ä¸­ä¸å¯ä»¥ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†ä»ç„¶æœ‰ç±»å˜é‡åˆå§‹åŒ–çš„èµ‹å€¼æ“ä½œï¼Œå› æ­¤æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ <clinit>() æ–¹æ³•ã€‚ä½†ä¸¤è€…ä¸åŒçš„æ˜¯ï¼Œ

* åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¹¶ä¸ä¼šå…ˆåˆå§‹åŒ–å®ƒçš„çˆ¶æ¥å£ï¼Œæ‰€ä»¥æ‰§è¡Œæ¥å£çš„ <clinit>() æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œçˆ¶æ¥å£çš„ <clinit>() æ–¹æ³•
* åœ¨åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–æ‰€å®ç°çš„æ¥å£ï¼Œæ‰€ä»¥æ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¸ä¼šæ‰§è¡Œæ¥å£çš„ <clinit>() æ–¹æ³•
* åªæœ‰å½“çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šåˆå§‹åŒ–



****



##### æ—¶æœº

ç±»çš„åˆå§‹åŒ–æ˜¯æ‡’æƒ°çš„ï¼Œåªæœ‰åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šè¢«è£…è½½ï¼ŒJVM ä¸ä¼šæ— æ¡ä»¶åœ°è£…è½½ Class ç±»å‹ï¼ŒJava è™šæ‹Ÿæœºè§„å®šï¼Œä¸€ä¸ªç±»æˆ–æ¥å£åœ¨åˆæ¬¡ä½¿ç”¨å‰ï¼Œå¿…é¡»è¦è¿›è¡Œåˆå§‹åŒ–

**ä¸»åŠ¨å¼•ç”¨**ï¼šè™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶æ²¡æœ‰å¼ºåˆ¶çº¦æŸä½•æ—¶è¿›è¡ŒåŠ è½½ï¼Œä½†æ˜¯è§„èŒƒä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰ä¸‹åˆ—æƒ…å†µå¿…é¡»å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡éƒ½ä¼šéšä¹‹å‘ç”Ÿï¼‰ï¼š

* å½“åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹æ—¶ï¼Œä½¿ç”¨ new å…³é”®å­—ï¼Œæˆ–è€…é€šè¿‡åå°„ã€å…‹éš†ã€ååºåˆ—åŒ–
* å½“è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•æˆ–è®¿é—®é™æ€å­—æ®µæ—¶ï¼Œé‡åˆ° getstaticã€putstaticã€invokestatic è¿™ä¸‰æ¡å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™å¿…é¡»å…ˆè§¦å‘å…¶åˆå§‹åŒ–
  * getstaticï¼šç¨‹åºè®¿é—®ç±»çš„é™æ€å˜é‡ï¼ˆä¸æ˜¯é™æ€å¸¸é‡ï¼Œå¸¸é‡ä¼šè¢«åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ï¼‰
  * putstaticï¼šç¨‹åºç»™ç±»çš„é™æ€å˜é‡èµ‹å€¼
  * invokestatic ï¼šè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•
* ä½¿ç”¨ java.lang.reflect åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–
* å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ï¼Œä½†è¿™æ¡è§„åˆ™å¹¶**ä¸é€‚ç”¨äºæ¥å£**
* å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å« main() æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»
* MethodHandle å’Œ VarHandle å¯ä»¥çœ‹ä½œæ˜¯è½»é‡çº§çš„åå°„è°ƒç”¨æœºåˆ¶ï¼Œè€Œè¦æƒ³ä½¿ç”¨è¿™ä¸¤ä¸ªè°ƒç”¨ï¼Œ å°±å¿…é¡»å…ˆä½¿ç”¨ findStaticVarHandle æ¥åˆå§‹åŒ–è¦è°ƒç”¨çš„ç±»
* è¡¥å……ï¼šå½“ä¸€ä¸ªæ¥å£ä¸­å®šä¹‰äº† JDK8 æ–°åŠ å…¥çš„é»˜è®¤æ–¹æ³•ï¼ˆè¢«defaultå…³é”®å­—ä¿®é¥°çš„æ¥å£æ–¹æ³•ï¼‰æ—¶ï¼Œå¦‚æœæœ‰è¿™ä¸ªæ¥å£çš„å®ç°ç±»å‘ç”Ÿäº†åˆå§‹åŒ–ï¼Œé‚£è¯¥æ¥å£è¦åœ¨å…¶ä¹‹å‰è¢«åˆå§‹åŒ–

**è¢«åŠ¨å¼•ç”¨**ï¼šæ‰€æœ‰å¼•ç”¨ç±»çš„æ–¹å¼éƒ½ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•ç”¨

* é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ–ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–
* é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–ã€‚è¯¥è¿‡ç¨‹ä¼šå¯¹æ•°ç»„ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œæ•°ç»„ç±»æ˜¯ä¸€ä¸ªç”±è™šæ‹Ÿæœºè‡ªåŠ¨ç”Ÿæˆçš„ã€ç›´æ¥ç»§æ‰¿è‡ª Object çš„å­ç±»ï¼Œå…¶ä¸­åŒ…å«äº†æ•°ç»„çš„å±æ€§å’Œæ–¹æ³•
* å¸¸é‡ï¼ˆfinalä¿®é¥°ï¼‰åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–
* è°ƒç”¨ ClassLoader ç±»çš„ loadClass() æ–¹æ³•åŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸æ˜¯å¯¹ç±»çš„ä¸»åŠ¨ä½¿ç”¨ï¼Œä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–



***



##### init

init æŒ‡çš„æ˜¯å®ä¾‹æ„é€ å™¨ï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨ç±»å®ä¾‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰§è¡Œå†…å®¹åŒ…æ‹¬æˆå‘˜å˜é‡åˆå§‹åŒ–å’Œä»£ç å—çš„æ‰§è¡Œ

å®ä¾‹åŒ–å³è°ƒç”¨ <init>()V ï¼Œè™šæ‹Ÿæœºä¼šä¿è¯è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼Œå…ˆä¸ºå®ä¾‹å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå†æ‰§è¡Œèµ‹é»˜è®¤å€¼ï¼Œç„¶åæ ¹æ®æºç ä¸­çš„é¡ºåºæ‰§è¡Œèµ‹åˆå€¼æˆ–ä»£ç å—ï¼Œæ²¡æœ‰æˆå‘˜å˜é‡åˆå§‹åŒ–å’Œä»£ç å—åˆ™ä¸ä¼šæ‰§è¡Œ

ç±»å®ä¾‹åŒ–è¿‡ç¨‹ï¼š**çˆ¶ç±»çš„ç±»æ„é€ å™¨<clinit>() -> å­ç±»çš„ç±»æ„é€ å™¨<clinit>() -> çˆ¶ç±»çš„æˆå‘˜å˜é‡å’Œå®ä¾‹ä»£ç å— -> çˆ¶ç±»çš„æ„é€ å‡½æ•° -> å­ç±»çš„æˆå‘˜å˜é‡å’Œå®ä¾‹ä»£ç å— -> å­ç±»çš„æ„é€ å‡½æ•°**



***



#### å¸è½½é˜¶æ®µ

æ—¶æœºï¼šæ‰§è¡Œäº† System.exit() æ–¹æ³•ï¼Œç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸï¼Œç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢ï¼Œç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢

å¸è½½ç±»å³è¯¥ç±»çš„ **Class å¯¹è±¡è¢« GC**ï¼Œå¸è½½ç±»éœ€è¦æ»¡è¶³3ä¸ªè¦æ±‚:

1. è¯¥ç±»çš„æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡éƒ½å·²è¢« GCï¼Œä¹Ÿå°±æ˜¯è¯´å †ä¸å­˜åœ¨è¯¥ç±»çš„å®ä¾‹å¯¹è±¡
2. è¯¥ç±»æ²¡æœ‰åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨
3. è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„å®ä¾‹å·²è¢« GCï¼Œä¸€èˆ¬æ˜¯å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚ OSGiã€JSP çš„é‡åŠ è½½ç­‰ï¼Œå¾ˆéš¾è¾¾æˆ

åœ¨ JVM ç”Ÿå‘½å‘¨æœŸç±»ï¼Œç”± JVM è‡ªå¸¦çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯ä¸ä¼šè¢«å¸è½½çš„ï¼Œè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¯èƒ½è¢«å¸è½½ã€‚å› ä¸º JVM ä¼šå§‹ç»ˆå¼•ç”¨å¯åŠ¨ã€æ‰©å±•ã€ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨å§‹ç»ˆå¼•ç”¨å®ƒä»¬æ‰€åŠ è½½çš„ç±»ï¼Œè¿™äº›ç±»å§‹ç»ˆæ˜¯å¯åŠçš„



****



### ç±»åŠ è½½å™¨

#### ç±»åŠ è½½

ç±»åŠ è½½æ–¹å¼ï¼š

* éšå¼åŠ è½½ï¼šä¸ç›´æ¥åœ¨ä»£ç ä¸­è°ƒç”¨ ClassLoader çš„æ–¹æ³•åŠ è½½ç±»å¯¹è±¡
  * åˆ›å»ºç±»å¯¹è±¡ã€ä½¿ç”¨ç±»çš„é™æ€åŸŸã€åˆ›å»ºå­ç±»å¯¹è±¡ã€ä½¿ç”¨å­ç±»çš„é™æ€åŸŸ
  * åœ¨ JVM å¯åŠ¨æ—¶ï¼Œé€šè¿‡ä¸‰å¤§ç±»åŠ è½½å™¨åŠ è½½ class
* æ˜¾å¼åŠ è½½ï¼š
  * ClassLoader.loadClass(className)ï¼ŒåªåŠ è½½å’Œè¿æ¥ï¼Œ**ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–**
  * Class.forName(String name, boolean initialize,ClassLoader loader)ï¼Œä½¿ç”¨ loader è¿›è¡ŒåŠ è½½å’Œè¿æ¥ï¼Œæ ¹æ®å‚æ•° initialize å†³å®šæ˜¯å¦åˆå§‹åŒ–

ç±»çš„å”¯ä¸€æ€§ï¼š

* åœ¨ JVM ä¸­è¡¨ç¤ºä¸¤ä¸ª class å¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š
  - ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…å
  - åŠ è½½è¿™ä¸ªç±»çš„ ClassLoaderï¼ˆæŒ‡ ClassLoader å®ä¾‹å¯¹è±¡ï¼‰å¿…é¡»ç›¸åŒ
* è¿™é‡Œçš„ç›¸ç­‰ï¼ŒåŒ…æ‹¬ç±»çš„ Class å¯¹è±¡çš„ equals() æ–¹æ³•ã€isAssignableFrom() æ–¹æ³•ã€isInstance() æ–¹æ³•çš„è¿”å›ç»“æœä¸º trueï¼Œä¹ŸåŒ…æ‹¬ä½¿ç”¨ instanceof å…³é”®å­—åšå¯¹è±¡æ‰€å±å…³ç³»åˆ¤å®šç»“æœä¸º true

å‘½åç©ºé—´ï¼š

- æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”±è¯¥åŠ è½½å™¨åŠæ‰€æœ‰çš„çˆ¶åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ç»„æˆ
- åœ¨åŒä¸€å‘½åç©ºé—´ä¸­ï¼Œä¸ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»

åŸºæœ¬ç‰¹å¾ï¼š

* å¯è§æ€§ï¼Œå­ç±»åŠ è½½å™¨å¯ä»¥è®¿é—®çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»å‹ï¼Œä½†æ˜¯åè¿‡æ¥æ˜¯ä¸å…è®¸çš„
* å•ä¸€æ€§ï¼Œç”±äºçˆ¶åŠ è½½å™¨çš„ç±»å‹å¯¹äºå­åŠ è½½å™¨æ˜¯å¯è§çš„ï¼Œæ‰€ä»¥çˆ¶åŠ è½½å™¨ä¸­åŠ è½½è¿‡çš„ç±»å‹ï¼Œä¸ä¼šåœ¨å­åŠ è½½å™¨ä¸­é‡å¤åŠ è½½



***



#### åŠ è½½å™¨

ç±»åŠ è½½å™¨æ˜¯ Java çš„æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºåŠ è½½å­—èŠ‚ç åˆ° JVM å†…å­˜ï¼Œå¾—åˆ° Class ç±»çš„å¯¹è±¡

ä» Java è™šæ‹Ÿæœºè§„èŒƒæ¥è®²ï¼Œåªå­˜åœ¨ä»¥ä¸‹ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š

- å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šä½¿ç”¨ C++ å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†
- è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆUser-Defined ClassLoaderï¼‰ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒ**å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±» ClassLoader çš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨**ï¼Œä½¿ç”¨ Java è¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœº

ä» Java å¼€å‘äººå‘˜çš„è§’åº¦çœ‹ï¼š

* å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼š
  * å¤„äºå®‰å…¨è€ƒè™‘ï¼ŒBootstrap å¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º javaã€javaxã€sun ç­‰å¼€å¤´çš„ç±»
  * ç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½åœ¨ `JAVA_HOME/jre/lib  `æˆ– `sun.boot.class.path` ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« -Xbootclasspath å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ç±»ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­
  * ä»…æŒ‰ç…§æ–‡ä»¶åè¯†åˆ«ï¼Œå¦‚ rt.jar åå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨ lib ç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½
  * å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢« Java ç¨‹åºç›´æ¥å¼•ç”¨ï¼Œåœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œç›´æ¥ä½¿ç”¨ null ä»£æ›¿
* æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼š
  * ç”± ExtClassLoader (sun.misc.Launcher$ExtClassLoader)  å®ç°ï¼Œä¸Šçº§ä¸º Bootstrapï¼Œæ˜¾ç¤ºä¸º null
  * å°† `JAVA_HOME/jre/lib/ext `æˆ–è€…è¢« `java.ext.dir` ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šè·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“åŠ è½½åˆ°å†…å­˜ä¸­
  * å¼€å‘è€…å¯ä»¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ï¼Œåˆ›å»ºçš„ JAR æ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¼šç”±æ‰©å±•ç±»åŠ è½½å™¨è‡ªåŠ¨åŠ è½½
* åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ï¼š
  * ç”± AppClassLoader(sun.misc.Launcher$AppClassLoader) å®ç°ï¼Œä¸Šçº§ä¸º Extension
  * è´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡ classpath æˆ–ç³»ç»Ÿå±æ€§ `java.class.path` æŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“
  * è¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ ClassLoader ä¸­çš„ getSystemClassLoader() æ–¹æ³•çš„è¿”å›å€¼ï¼Œå› æ­¤ç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨
  * å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨
* è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä¸Šçº§æ˜¯ Application

```java
public static void main(String[] args) {
    //è·å–ç³»ç»Ÿç±»åŠ è½½å™¨
    ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();
    System.out.println(systemClassLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2

    //è·å–å…¶ä¸Šå±‚  æ‰©å±•ç±»åŠ è½½å™¨
    ClassLoader extClassLoader = systemClassLoader.getParent();
    System.out.println(extClassLoader);//sun.misc.Launcher$ExtClassLoader@610455d6

    //è·å–å…¶ä¸Šå±‚ è·å–ä¸åˆ°å¼•å¯¼ç±»åŠ è½½å™¨
    ClassLoader bootStrapClassLoader = extClassLoader.getParent();
    System.out.println(bootStrapClassLoader);//null

    //å¯¹äºç”¨æˆ·è‡ªå®šä¹‰ç±»æ¥è¯´ï¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
    ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();
    System.out.println(classLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2

    //String ç±»ä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ --> javaæ ¸å¿ƒç±»åº“éƒ½æ˜¯ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„
    ClassLoader classLoader1 = String.class.getClassLoader();
    System.out.println(classLoader1);//null

}
```

è¡¥å……ä¸¤ä¸ªç±»åŠ è½½å™¨ï¼š

* SecureClassLoader æ‰©å±•äº† ClassLoaderï¼Œæ–°å¢äº†å‡ ä¸ªä¸ä½¿ç”¨ç›¸å…³çš„ä»£ç æºå’Œæƒé™å®šä¹‰ç±»éªŒè¯ï¼ˆå¯¹ class æºç çš„è®¿é—®æƒé™ï¼‰çš„æ–¹æ³•ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥è·Ÿè¿™ä¸ªç±»æ‰“äº¤é“ï¼Œæ›´å¤šæ˜¯ä¸å®ƒçš„å­ç±» URLClassLoader æœ‰æ‰€å…³è”
* ClassLoader æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¾ˆå¤šæ–¹æ³•æ˜¯ç©ºçš„æ²¡æœ‰å®ç°ï¼Œè€Œ URLClassLoader è¿™ä¸ªå®ç°ç±»ä¸ºè¿™äº›æ–¹æ³•æä¾›äº†å…·ä½“çš„å®ç°ï¼Œå¹¶æ–°å¢äº† URLClassPath ç±»ååŠ©å–å¾— Class å­—èŠ‚æµç­‰åŠŸèƒ½ã€‚åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿ URLClassLoader ç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å»ç¼–å†™ findClass() æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´



***



#### å¸¸ç”¨API

ClassLoader ç±»ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ª ClassLoaderï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰

è·å– ClassLoader çš„é€”å¾„ï¼š

* è·å–å½“å‰ç±»çš„ ClassLoaderï¼š`clazz.getClassLoader()`
* è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ ClassLoaderï¼š`Thread.currentThread.getContextClassLoader()`
* è·å–ç³»ç»Ÿçš„ ClassLoaderï¼š`ClassLoader.getSystemClassLoader()`
* è·å–è°ƒç”¨è€…çš„ ClassLoaderï¼š`DriverManager.getCallerClassLoader()`

ClassLoader ç±»å¸¸ç”¨æ–¹æ³•ï¼š

* `getParent()`ï¼šè¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨  
* `loadclass(String name)`ï¼šåŠ è½½åä¸º name çš„ç±»ï¼Œè¿”å›ç»“æœä¸º Class ç±»çš„å®ä¾‹ï¼Œè¯¥æ–¹æ³•å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼
* `findclass(String name)`ï¼šæŸ¥æ‰¾äºŒè¿›åˆ¶åç§°ä¸º name çš„ç±»ï¼Œè¿”å›ç»“æœä¸º Class ç±»çš„å®ä¾‹ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ£€æŸ¥å®Œçˆ¶ç±»åŠ è½½å™¨ä¹‹åè¢« loadClass() æ–¹æ³•è°ƒç”¨
* `findLoadedClass(String name)`ï¼šæŸ¥æ‰¾åç§°ä¸º name çš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œfinal ä¿®é¥°æ— æ³•é‡å†™
* `defineClass(String name,byte[] b,int off,int len)`ï¼šå°†å­—èŠ‚æµè§£ææˆ JVM èƒ½å¤Ÿè¯†åˆ«çš„ç±»å¯¹è±¡
* `resolveclass(Class<?> c)`ï¼šé“¾æ¥æŒ‡å®šçš„ Java ç±»ï¼Œå¯ä»¥ä½¿ç±»çš„ Class å¯¹è±¡åˆ›å»ºå®Œæˆçš„åŒæ—¶ä¹Ÿè¢«è§£æ
* `InputStream getResourceAsStream(String name)`ï¼šæŒ‡å®šèµ„æºåç§°è·å–è¾“å…¥æµ



***



#### åŠ è½½æ¨¡å‹

##### åŠ è½½æœºåˆ¶

åœ¨ JVM ä¸­ï¼Œå¯¹äºç±»åŠ è½½æ¨¡å‹æä¾›äº†ä¸‰ç§ï¼Œåˆ†åˆ«ä¸ºå…¨ç›˜åŠ è½½ã€åŒäº²å§”æ´¾ã€ç¼“å­˜æœºåˆ¶

- **å…¨ç›˜åŠ è½½ï¼š**å½“ä¸€ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½æŸä¸ª Class æ—¶ï¼Œè¯¥ Class æ‰€ä¾èµ–å’Œå¼•ç”¨çš„å…¶ä»– Class ä¹Ÿå°†ç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£è½½å…¥ï¼Œé™¤éæ˜¾ç¤ºæŒ‡å®šä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨æ¥è½½å…¥

- **åŒäº²å§”æ´¾ï¼š**å…ˆè®©çˆ¶ç±»åŠ è½½å™¨åŠ è½½è¯¥ Classï¼Œåœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­åŠ è½½è¯¥ç±»ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼ŒæŸä¸ªç‰¹å®šçš„ç±»åŠ è½½å™¨åœ¨æ¥åˆ°åŠ è½½ç±»çš„è¯·æ±‚æ—¶ï¼Œé¦–å…ˆå°†åŠ è½½ä»»åŠ¡å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨ï¼Œ**ä¾æ¬¡é€’å½’**ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼›åªæœ‰å½“çˆ¶åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰è‡ªå·±å»åŠ è½½

- **ç¼“å­˜æœºåˆ¶ï¼š**ä¼šä¿è¯æ‰€æœ‰åŠ è½½è¿‡çš„ Class éƒ½ä¼šè¢«ç¼“å­˜ï¼Œå½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ª Class æ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºä¸­æœå¯»è¯¥ Classï¼Œåªæœ‰å½“ç¼“å­˜åŒºä¸­ä¸å­˜åœ¨è¯¥ Class å¯¹è±¡æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ Class å¯¹è±¡å­˜å…¥ç¼“å†²åŒºä¸­
  - è¿™å°±æ˜¯ä¿®æ”¹äº† Class åï¼Œå¿…é¡»é‡æ–°å¯åŠ¨ JVMï¼Œç¨‹åºæ‰€åšçš„ä¿®æ”¹æ‰ä¼šç”Ÿæ•ˆçš„åŸå› 





***



##### åŒäº²å§”æ´¾

åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰ï¼šè¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶å®ƒç±»åŠ è½½å™¨éƒ½è¦æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œè¿™é‡Œçš„çˆ¶å­å…³ç³»ä¸€èˆ¬é€šè¿‡ç»„åˆå…³ç³»ï¼ˆCompositionï¼‰æ¥å®ç°ï¼Œè€Œä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼ˆInheritanceï¼‰

å·¥ä½œè¿‡ç¨‹ï¼šä¸€ä¸ªç±»åŠ è½½å™¨é¦–å…ˆå°†ç±»åŠ è½½è¯·æ±‚è½¬å‘åˆ°çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ—¶æ‰å°è¯•è‡ªå·±åŠ è½½

åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜ç‚¹ï¼š

* å¯ä»¥é¿å…æŸä¸€ä¸ªç±»è¢«é‡å¤åŠ è½½ï¼Œå½“çˆ¶ç±»å·²ç»åŠ è½½ååˆ™æ— éœ€é‡å¤åŠ è½½ï¼Œä¿è¯å…¨å±€å”¯ä¸€æ€§

* Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·æœ‰ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œä»è€Œä½¿å¾—åŸºç¡€ç±»å¾—åˆ°ç»Ÿä¸€

* ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢ç±»åº“çš„æ ¸å¿ƒ API è¢«éšæ„ç¯¡æ”¹

  ä¾‹å¦‚ï¼šåœ¨å·¥ç¨‹ä¸­æ–°å»º java.lang åŒ…ï¼Œæ¥ç€åœ¨è¯¥åŒ…ä¸‹æ–°å»º String ç±»ï¼Œå¹¶å®šä¹‰ main å‡½æ•°

  ```java
  public class String {
      public static void main(String[] args) {
          System.out.println("demo info");
      }
  }
  ```
  
  æ­¤æ—¶æ‰§è¡Œmainå‡½æ•°ï¼Œä¼šå‡ºç°å¼‚å¸¸ï¼Œåœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•ï¼Œé˜²æ­¢æ¶æ„ç¯¡æ”¹æ ¸å¿ƒ API åº“
  å‡ºç°è¯¥ä¿¡æ¯æ˜¯å› ä¸ºåŒäº²å§”æ´¾çš„æœºåˆ¶ï¼Œjava.lang.String çš„åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrapï¼‰å¾—åˆ°åŠ è½½ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨ä¼˜å…ˆçº§æ›´é«˜ï¼Œåœ¨æ ¸å¿ƒ jre åº“ä¸­æœ‰å…¶ç›¸åŒåå­—çš„ç±»æ–‡ä»¶ï¼Œä½†è¯¥ç±»ä¸­å¹¶æ²¡æœ‰ main æ–¹æ³•

åŒäº²å§”æ´¾æœºåˆ¶çš„ç¼ºç‚¹ï¼šæ£€æŸ¥ç±»æ˜¯å¦åŠ è½½çš„å§”æ‰˜è¿‡ç¨‹æ˜¯å•å‘çš„ï¼Œè¿™ä¸ªæ–¹å¼è™½ç„¶ä»ç»“æ„ä¸Šçœ‹æ¯”è¾ƒæ¸…æ™°ï¼Œä½¿å„ä¸ª ClassLoader çš„èŒè´£éå¸¸æ˜ç¡®ï¼Œä½†é¡¶å±‚çš„ ClassLoader æ— æ³•è®¿é—®åº•å±‚çš„ ClassLoader æ‰€åŠ è½½çš„ç±»

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-åŒäº²å§”æ´¾æ¨¡å‹.png" style="zoom: 50%;" />



***



##### æºç åˆ†æ

```java
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException {
    synchronized (getClassLoadingLock(name)) {
       //è°ƒç”¨å½“å‰ç±»åŠ è½½å™¨çš„findLoadedClass(name)ï¼Œæ£€æŸ¥å½“å‰ç±»åŠ è½½å™¨æ˜¯å¦å·²åŠ è½½è¿‡æŒ‡å®šnameçš„ç±»
        Class c = findLoadedClass(name);
        
        //å½“å‰ç±»åŠ è½½å™¨å¦‚æœæ²¡æœ‰åŠ è½½è¿‡
        if (c == null) {
            long t0 = System.nanoTime();
            try {
                //åˆ¤æ–­å½“å‰ç±»åŠ è½½å™¨æ˜¯å¦æœ‰çˆ¶ç±»åŠ è½½å™¨
                if (parent != null) {
                    //å¦‚æœå½“å‰ç±»åŠ è½½å™¨æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨çš„loadClass(name,false)
Â Â Â Â Â Â Â Â Â 			//çˆ¶ç±»åŠ è½½å™¨çš„loadClassæ–¹æ³•ï¼Œåˆä¼šæ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡
                    c = parent.loadClass(name, false);
                } else {
                    //å½“å‰ç±»åŠ è½½å™¨æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œè¯´æ˜å½“å‰ç±»åŠ è½½å™¨æ˜¯BootStrapClassLoader
Â Â Â Â Â Â Â Â Â Â 			//åˆ™è°ƒç”¨BootStrap ClassLoaderçš„æ–¹æ³•åŠ è½½ç±»
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // ClassNotFoundException thrown if class not found
                // from the non-null parent class loader
            }

            if (c == null) {
                // å¦‚æœè°ƒç”¨çˆ¶ç±»çš„ç±»åŠ è½½å™¨æ— æ³•å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œåˆ™ç”¨è‡ªå·±çš„findClass()æ–¹æ³•è¿›è¡ŒåŠ è½½
                // kè‡ªå®šä¹‰findClass()æ–¹æ³•
                long t1 = System.nanoTime();
                c = findClass(name);

                // this is the defining class loader; record the stats
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            resolveClass(c);
        }
        return c;
    }
}
```



****



##### ç ´åå§”æ´¾

åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ä¸ªå…·æœ‰å¼ºåˆ¶æ€§çº¦æŸçš„æ¨¡å‹ï¼Œè€Œæ˜¯ Java è®¾è®¡è€…æ¨èç»™å¼€å‘è€…çš„ç±»åŠ è½½å™¨å®ç°æ–¹å¼

ç ´ååŒäº²å§”æ´¾æ¨¡å‹çš„æ–¹å¼ï¼š

* è‡ªå®šä¹‰ ClassLoader

  * å¦‚æœä¸æƒ³ç ´ååŒäº²å§”æ´¾æ¨¡å‹ï¼Œåªéœ€è¦é‡å†™ findClass æ–¹æ³•
  * å¦‚æœæƒ³è¦å»ç ´ååŒäº²å§”æ´¾æ¨¡å‹ï¼Œéœ€è¦å»**é‡å†™ loadClass **æ–¹æ³•

* å¼•å…¥çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

  Java æä¾›äº†å¾ˆå¤šæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºè¿™äº›æ¥å£æä¾›å®ç°ã€‚å¸¸è§çš„ SPI æœ‰ JDBCã€JCEã€JNDI ç­‰ã€‚è¿™äº› SPI æ¥å£ç”± Java æ ¸å¿ƒåº“æ¥æä¾›ï¼Œè€Œ SPI çš„å®ç°ä»£ç åˆ™æ˜¯ä½œä¸º Java åº”ç”¨æ‰€ä¾èµ–çš„ jar åŒ…è¢«åŒ…å«è¿›ç±»è·¯å¾„ classpath é‡Œï¼ŒSPI æ¥å£ä¸­çš„ä»£ç éœ€è¦åŠ è½½å…·ä½“çš„å®ç°ç±»ï¼š

  * SPI çš„æ¥å£æ˜¯ Java æ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ç”±å¼•å¯¼ç±»åŠ è½½å™¨æ¥åŠ è½½çš„
  * SPI çš„å®ç°ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨æ¥åŠ è½½çš„ï¼Œå¼•å¯¼ç±»åŠ è½½å™¨æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºä¾ç…§åŒäº²å§”æ´¾æ¨¡å‹ï¼ŒBootstrapClassloader æ— æ³•å§”æ´¾ AppClassLoader æ¥åŠ è½½ç±»

  JDK å¼€å‘äººå‘˜å¼•å…¥äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰ï¼Œè¿™ç§ç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡ Thread  ç±»çš„ setContextClassLoader æ–¹æ³•è¿›è¡Œè®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œåœ¨æ‰§è¡Œçº¿ç¨‹ä¸­æŠ›å¼ƒåŒäº²å§”æ´¾åŠ è½½æ¨¡å¼ï¼Œä½¿ç¨‹åºå¯ä»¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œä½¿ Bootstrap åŠ è½½å™¨æ‹¿åˆ°äº† Application åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œç ´åäº†åŒäº²å§”æ´¾æ¨¡å‹
  
* å®ç°ç¨‹åºçš„åŠ¨æ€æ€§ï¼Œå¦‚ä»£ç çƒ­æ›¿æ¢ï¼ˆHot Swapï¼‰ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰

  IBM å…¬å¸ä¸»å¯¼çš„ JSRä¸€291ï¼ˆOSGiR4.2ï¼‰å®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ï¼Œæ¯ä¸€ä¸ªç¨‹åºæ¨¡å—ï¼ˆOSGi ä¸­ç§°ä¸º Bundleï¼‰éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“æ›´æ¢ä¸€ä¸ª Bundle æ—¶ï¼Œå°±æŠŠ Bundle è¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ï¼Œåœ¨ OSGi ç¯å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†åŒäº²å§”æ´¾æ¨¡å‹æ¨èçš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„ç½‘çŠ¶ç»“æ„

  å½“æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGiå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢:

  1. å°†ä»¥ java.* å¼€å¤´çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½
  2. å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½
  3. å¦åˆ™ï¼Œå°† Import åˆ—è¡¨ä¸­çš„ç±»ï¼Œå§”æ´¾ç»™ Export è¿™ä¸ªç±»çš„ Bundle çš„ç±»åŠ è½½å™¨åŠ è½½
  4. å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰ Bundle çš„ ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½
  5. å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„ Fragment Bundle ä¸­ï¼Œå¦‚æœåœ¨å°±å§”æ´¾ç»™ Fragment Bundle ç±»åŠ è½½å™¨åŠ è½½
  6. å¦åˆ™ï¼ŒæŸ¥æ‰¾ Dynamic Import åˆ—è¡¨çš„ Bundleï¼Œå§”æ´¾ç»™å¯¹åº” Bundle çš„ç±»åŠ è½½å™¨åŠ è½½
  7. å¦åˆ™ï¼Œç±»æŸ¥æ‰¾å¤±è´¥



****



##### çƒ­æ›¿æ¢

çƒ­æ›¿æ¢æ˜¯æŒ‡åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸åœæ­¢æœåŠ¡ï¼Œåªé€šè¿‡æ›¿æ¢ç¨‹åºæ–‡ä»¶æ¥ä¿®æ”¹ç¨‹åºçš„è¡Œä¸ºï¼Œ**çƒ­æ›¿æ¢çš„å…³é”®éœ€æ±‚åœ¨äºæœåŠ¡ä¸èƒ½ä¸­æ–­**ï¼Œä¿®æ”¹å¿…é¡»ç«‹å³è¡¨ç°æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿä¹‹ä¸­

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-çƒ­æ›¿æ¢.png" style="zoom: 33%;" />



***



#### æ²™ç®±æœºåˆ¶

æ²™ç®±æœºåˆ¶ï¼ˆSandboxï¼‰ï¼šå°† Java ä»£ç é™å®šåœ¨è™šæ‹Ÿæœºç‰¹å®šçš„è¿è¡ŒèŒƒå›´ä¸­ï¼Œå¹¶ä¸”ä¸¥æ ¼é™åˆ¶ä»£ç å¯¹æœ¬åœ°ç³»ç»Ÿèµ„æºè®¿é—®ï¼Œæ¥ä¿è¯å¯¹ä»£ç çš„æœ‰æ•ˆéš”ç¦»ï¼Œé˜²æ­¢å¯¹æœ¬åœ°ç³»ç»Ÿé€ æˆç ´å

æ²™ç®±**é™åˆ¶ç³»ç»Ÿèµ„æºè®¿é—®**ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œï¼Œä¸åŒçº§åˆ«çš„æ²™ç®±å¯¹èµ„æºè®¿é—®çš„é™åˆ¶ä¹Ÿä¸ä¸€æ ·

* JDK1.0ï¼šJava ä¸­å°†æ‰§è¡Œç¨‹åºåˆ†æˆæœ¬åœ°ä»£ç å’Œè¿œç¨‹ä»£ç ä¸¤ç§ï¼Œæœ¬åœ°ä»£ç é»˜è®¤è§†ä¸ºå¯ä¿¡ä»»çš„ï¼Œè€Œè¿œç¨‹ä»£ç è¢«çœ‹ä½œæ˜¯ä¸å—ä¿¡çš„ã€‚å¯¹äºæˆä¿¡çš„æœ¬åœ°ä»£ç ï¼Œå¯ä»¥è®¿é—®ä¸€åˆ‡æœ¬åœ°èµ„æºï¼Œè€Œå¯¹äºéæˆä¿¡çš„è¿œç¨‹ä»£ç ä¸å¯ä»¥è®¿é—®æœ¬åœ°èµ„æºï¼Œå…¶å®ä¾èµ–äºæ²™ç®±æœºåˆ¶ã€‚å¦‚æ­¤ä¸¥æ ¼çš„å®‰å…¨æœºåˆ¶ä¹Ÿç»™ç¨‹åºçš„åŠŸèƒ½æ‰©å±•å¸¦æ¥éšœç¢ï¼Œæ¯”å¦‚å½“ç”¨æˆ·å¸Œæœ›è¿œç¨‹ä»£ç è®¿é—®æœ¬åœ°ç³»ç»Ÿçš„æ–‡ä»¶æ—¶å€™ï¼Œå°±æ— æ³•å®ç°
* JDK1.1ï¼šé’ˆå¯¹å®‰å…¨æœºåˆ¶åšäº†æ”¹è¿›ï¼Œå¢åŠ äº†å®‰å…¨ç­–ç•¥ã€‚å…è®¸ç”¨æˆ·æŒ‡å®šä»£ç å¯¹æœ¬åœ°èµ„æºçš„è®¿é—®æƒé™
* JDK1.2ï¼šæ”¹è¿›äº†å®‰å…¨æœºåˆ¶ï¼Œå¢åŠ äº†ä»£ç ç­¾åï¼Œä¸è®ºæœ¬åœ°ä»£ç æˆ–æ˜¯è¿œç¨‹ä»£ç éƒ½ä¼šæŒ‰ç…§ç”¨æˆ·çš„å®‰å…¨ç­–ç•¥è®¾å®šï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­æƒé™ä¸åŒçš„è¿è¡Œç©ºé—´ï¼Œæ¥å®ç°å·®å¼‚åŒ–çš„ä»£ç æ‰§è¡Œæƒé™æ§åˆ¶
* JDK1.6ï¼šå½“å‰æœ€æ–°çš„å®‰å…¨æœºåˆ¶ï¼Œå¼•å…¥äº†åŸŸï¼ˆDomainï¼‰çš„æ¦‚å¿µã€‚è™šæ‹Ÿæœºä¼šæŠŠæ‰€æœ‰ä»£ç åŠ è½½åˆ°ä¸åŒçš„ç³»ç»ŸåŸŸå’Œåº”ç”¨åŸŸï¼Œä¸åŒçš„ä¿æŠ¤åŸŸå¯¹åº”ä¸ä¸€æ ·çš„æƒé™ã€‚ç³»ç»ŸåŸŸéƒ¨åˆ†ä¸“é—¨è´Ÿè´£ä¸å…³é”®èµ„æºè¿›è¡Œäº¤äº’ï¼Œè€Œå„ä¸ªåº”ç”¨åŸŸéƒ¨åˆ†åˆ™é€šè¿‡ç³»ç»ŸåŸŸçš„éƒ¨åˆ†ä»£ç†æ¥å¯¹å„ç§éœ€è¦çš„èµ„æºè¿›è¡Œè®¿é—®

![](https://gitee.com/seazean/images/raw/master/Java/JVM-æ²™ç®±æœºåˆ¶.png)



***



#### è‡ªå®šä¹‰

å¯¹äºè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°ï¼Œåªéœ€è¦ç»§æ‰¿ ClassLoader ç±»ï¼Œè¦†å†™ findClass æ–¹æ³•å³å¯

ä½œç”¨ï¼šéš”ç¦»åŠ è½½ç±»ã€ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼ã€æ‹“å±•åŠ è½½æºã€é˜²æ­¢æºç æ³„æ¼

```java
//è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè¯»å–æŒ‡å®šçš„ç±»è·¯å¾„classPathä¸‹çš„classæ–‡ä»¶
public class MyClassLoader extends ClassLoader{
    private String classPath;

    public MyClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
     public MyClassLoader(ClassLoader parent, String byteCodePath) {
        super(parent);
        this.classPath = classPath;
    }

    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
       BufferedInputStream bis = null;
        ByteArrayOutputStream baos = null;
        try {
            //è·å–å­—èŠ‚ç æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
            String fileName = byteCodePath + className + ".class";
            //è·å–ä¸€ä¸ªè¾“å…¥æµ
            bis = new BufferedInputStream(new FileInputStream(fileName));
            //è·å–ä¸€ä¸ªè¾“å‡ºæµ
            baos = new ByteArrayOutputStream();
            //å…·ä½“è¯»å…¥æ•°æ®å¹¶å†™å‡ºçš„è¿‡ç¨‹
            int len;
            byte[] data = new byte[1024];
            while ((len = bis.read(data)) != -1) {
                baos.write(data, 0, len);
            }
            //è·å–å†…å­˜ä¸­çš„å®Œæ•´çš„å­—èŠ‚æ•°ç»„çš„æ•°æ®
            byte[] byteCodes = baos.toByteArray();
            //è°ƒç”¨defineClass()ï¼Œå°†å­—èŠ‚æ•°ç»„çš„æ•°æ®è½¬æ¢ä¸ºClassçš„å®ä¾‹ã€‚
            Class clazz = defineClass(null, byteCodes, 0, byteCodes.length);
            return clazz;
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (baos != null)
                    baos.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
            try {
                if (bis != null)
                    bis.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return null;
    }
}
```

```java
public static void main(String[] args) {
    MyClassLoader loader = new MyClassLoader("D:\Workspace\Project/JVM_study/src/java1/");

    try {
        Class clazz = loader.loadClass("Demo1");
        System.out.println("åŠ è½½æ­¤ç±»çš„ç±»çš„åŠ è½½å™¨ä¸ºï¼š" + clazz.getClassLoader().getClass().getName());//MyClassLoader

        System.out.println("åŠ è½½å½“å‰ç±»çš„ç±»çš„åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ä¸ºï¼š" + clazz.getClassLoader().getParent().getClass().getName());//sun.misc.Launcher$AppClassLoader
    } catch (ClassNotFoundException e) {
        e.printStackTrace();
    }
}
```



****



#### JDK9

ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼ŒJDK9 æ²¡æœ‰æ”¹å˜ä¸‰å±‚ç±»åŠ è½½å™¨æ¶æ„å’ŒåŒäº²å§”æ´¾æ¨¡å‹ï¼Œä½†ä¸ºäº†æ¨¡å—åŒ–ç³»ç»Ÿçš„é¡ºåˆ©è¿è¡Œåšäº†ä¸€äº›å˜åŠ¨ï¼š

* æ‰©å±•æœºåˆ¶è¢«ç§»é™¤ï¼Œæ‰©å±•ç±»åŠ è½½å™¨ç”±äºå‘åå…¼å®¹æ€§çš„åŸå› è¢«ä¿ç•™ï¼Œä¸è¿‡è¢«é‡å‘½åä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼ˆplatform classloaderï¼‰ï¼Œå¯ä»¥é€šè¿‡ ClassLoader çš„æ–°æ–¹æ³• getPlatformClassLoader() æ¥è·å–

* JDK9 åŸºäºæ¨¡å—åŒ–è¿›è¡Œæ„å»ºï¼ˆåŸæ¥çš„ rt.jar å’Œ tools.jar è¢«æ‹†åˆ†æˆæ•°åä¸ªJMODæ–‡ä»¶ï¼‰ï¼Œå…¶ä¸­çš„ Java ç±»åº“å°±æ»¡è¶³äº†å¯æ‰©å±•çš„éœ€æ±‚ï¼Œé‚£å°±æ— é¡»å†ä¿ç•™ `<JAVA_HOME>\lib\ext` ç›®å½•ï¼Œæ­¤å‰ä½¿ç”¨è¿™ä¸ªç›®å½•æˆ–è€… `java.ext.dirs` ç³»ç»Ÿå˜é‡æ¥æ‰©å±• JDK åŠŸèƒ½çš„æœºåˆ¶å°±ä¸éœ€è¦ç»§ç»­å­˜åœ¨

* å¯åŠ¨ç±»åŠ è½½å™¨ã€å¹³å°ç±»åŠ è½½å™¨ã€åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å…¨éƒ½ç»§æ‰¿äº `jdk.internal.loader.BuiltinClassLoader`

  



***





## è¿è¡Œæœºåˆ¶

### æ‰§è¡Œè¿‡ç¨‹

 Javaæ–‡ä»¶ç¼–è¯‘æ‰§è¡Œçš„è¿‡ç¨‹ï¼š

![](https://gitee.com/seazean/images/raw/master/Java/JVM-Javaæ–‡ä»¶ç¼–è¯‘æ‰§è¡Œçš„è¿‡ç¨‹.png)

- ç±»åŠ è½½å™¨ï¼šç”¨äºè£…è½½å­—èŠ‚ç æ–‡ä»¶(.classæ–‡ä»¶)
- è¿è¡Œæ—¶æ•°æ®åŒºï¼šç”¨äºåˆ†é…å­˜å‚¨ç©ºé—´
- æ‰§è¡Œå¼•æ“ï¼šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶æˆ–æœ¬åœ°æ–¹æ³•
- åƒåœ¾å›æ”¶å™¨ï¼šç”¨äºå¯¹ JVM ä¸­çš„åƒåœ¾å†…å®¹è¿›è¡Œå›æ”¶



****



### å­—èŠ‚ç 

#### è·¨å¹³å°æ€§

Java è¯­è¨€ï¼šè·¨å¹³å°çš„è¯­è¨€ï¼ˆwrite once ï¼Œrun anywhereï¼‰

* å½“ Java æºä»£ç æˆåŠŸç¼–è¯‘æˆå­—èŠ‚ç åï¼Œåœ¨ä¸åŒçš„å¹³å°ä¸Šé¢è¿è¡Œæ— é¡»å†æ¬¡ç¼–è¯‘
* è®©ä¸€ä¸ª Java ç¨‹åºæ­£ç¡®åœ°è¿è¡Œåœ¨ JVM ä¸­ï¼ŒJava æºç å°±å¿…é¡»è¦è¢«ç¼–è¯‘ä¸ºç¬¦åˆ JVM è§„èŒƒçš„å­—èŠ‚ç 

ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ç¼–è¯‘å™¨ï¼š

* å‰ç«¯ç¼–è¯‘å™¨ï¼š Sun çš„å…¨é‡å¼ç¼–è¯‘å™¨ javacã€ Eclipse çš„å¢é‡å¼ç¼–è¯‘å™¨ ECJï¼ŒæŠŠæºä»£ç ç¼–è¯‘ä¸ºå­—èŠ‚ç æ–‡ä»¶.class

  * IntelliJ IDEA ä½¿ç”¨ javac ç¼–è¯‘å™¨
  * Eclipse ä¸­ï¼Œå½“å¼€å‘äººå‘˜ç¼–å†™å®Œä»£ç åä¿å­˜æ—¶ï¼ŒECJ ç¼–è¯‘å™¨å°±ä¼šæŠŠæœªç¼–è¯‘éƒ¨åˆ†çš„æºç é€è¡Œè¿›è¡Œç¼–è¯‘ï¼Œè€Œéæ¯æ¬¡éƒ½å…¨é‡ç¼–è¯‘ï¼Œå› æ­¤ ECJ çš„ç¼–è¯‘æ•ˆç‡ä¼šæ¯” javac æ›´åŠ è¿…é€Ÿå’Œé«˜æ•ˆ
  * å‰ç«¯ç¼–è¯‘å™¨å¹¶ä¸ä¼šç›´æ¥æ¶‰åŠç¼–è¯‘ä¼˜åŒ–ç­‰æ–¹é¢çš„æŠ€æœ¯ï¼Œå…·ä½“ä¼˜åŒ–ç»†èŠ‚ç§»äº¤ç»™ HotSpot çš„ JIT ç¼–è¯‘å™¨è´Ÿè´£

* åç«¯è¿è¡ŒæœŸç¼–è¯‘å™¨ï¼šHotSpot VM çš„ C1ã€C2 ç¼–è¯‘å™¨ï¼Œä¹Ÿå°±æ˜¯ JIT ç¼–è¯‘å™¨ï¼ŒGraal ç¼–è¯‘å™¨

  * JITç¼–è¯‘å™¨ï¼šæ‰§è¡Œå¼•æ“éƒ¨åˆ†è¯¦è§£
  * Graal ç¼–è¯‘å™¨ï¼šJDK10 HotSpot åŠ å…¥çš„ä¸€ä¸ªå…¨æ–°çš„å³æ—¶ç¼–è¯‘å™¨ï¼Œç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½å¹³äº† C2

* é™æ€æå‰ç¼–è¯‘å™¨ï¼šAOT  (Ahead Of Time Compiler)ç¼–è¯‘å™¨ï¼Œç›´æ¥æŠŠæºä»£ç ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ä»£ç ï¼Œ

  * JDK 9 å¼•å…¥ï¼Œæ˜¯ä¸å³æ—¶ç¼–è¯‘ç›¸å¯¹ç«‹çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå³æ—¶ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç ï¼ŒAOT æ˜¯ç¨‹åºè¿è¡Œä¹‹å‰ä¾¿å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç 

  * ä¼˜ç‚¹ï¼šJava è™šæ‹ŸæœºåŠ è½½å·²ç»é¢„ç¼–è¯‘æˆäºŒè¿›åˆ¶åº“ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨çš„é¢„çƒ­ï¼Œå‡å°‘ Java åº”ç”¨ç¬¬ä¸€æ¬¡è¿è¡Œæ…¢çš„ç°è±¡
  * ç¼ºç‚¹ï¼š
    * ç ´åäº† Java "ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªä¸åŒç¡¬ä»¶ç¼–è¯‘å¯¹åº”çš„å‘è¡ŒåŒ…
    * é™ä½äº† Java é“¾æ¥è¿‡ç¨‹çš„åŠ¨æ€æ€§ï¼ŒåŠ è½½çš„ä»£ç åœ¨ç¼–è¯‘æœŸå°±å¿…é¡»å…¨éƒ¨å·²çŸ¥





***



#### è¯­è¨€å‘å±•

æœºå™¨ç ï¼šå„ç§ç”¨äºŒè¿›åˆ¶ç¼–ç æ–¹å¼è¡¨ç¤ºçš„æŒ‡ä»¤ï¼Œä¸CPUç´§å¯†ç›¸å…³ï¼Œæ‰€ä»¥ä¸åŒç§ç±»çš„CPUå¯¹åº”çš„æœºå™¨æŒ‡ä»¤ä¸åŒ

æŒ‡ä»¤ï¼šæŒ‡ä»¤å°±æ˜¯æŠŠæœºå™¨ç ä¸­ç‰¹å®šçš„0å’Œ1åºåˆ—ï¼Œç®€åŒ–æˆå¯¹åº”çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚movï¼Œincç­‰ï¼Œå¯è¯»æ€§ç¨å¥½ï¼Œä½†æ˜¯ä¸åŒçš„ç¡¬ä»¶å¹³å°çš„åŒä¸€ç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚movï¼‰ï¼Œå¯¹åº”çš„æœºå™¨ç ä¹Ÿå¯èƒ½ä¸åŒ

æŒ‡ä»¤é›†ï¼šä¸åŒçš„ç¡¬ä»¶å¹³å°æ”¯æŒçš„æŒ‡ä»¤æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ¯ä¸ªå¹³å°æ‰€æ”¯æŒçš„æŒ‡ä»¤ï¼Œç§°ä¹‹ä¸ºå¯¹åº”å¹³å°çš„æŒ‡ä»¤é›†

- x86 æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ x86 æ¶æ„çš„å¹³å°
- ARM æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ ARM æ¶æ„çš„å¹³å°

æ±‡ç¼–è¯­è¨€ï¼šç”¨åŠ©è®°ç¬¦ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„æ“ä½œç ï¼Œç”¨åœ°å€ç¬¦å·æˆ–æ ‡å·ä»£æ›¿æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€

* åœ¨ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ±‡ç¼–è¯­è¨€å¯¹åº”ç€ä¸åŒçš„æœºå™¨è¯­è¨€æŒ‡ä»¤é›†ï¼Œé€šè¿‡æ±‡ç¼–è¿‡ç¨‹è½¬æ¢æˆæœºå™¨æŒ‡ä»¤
* è®¡ç®—æœºåªè®¤è¯†æŒ‡ä»¤ç ï¼Œæ±‡ç¼–è¯­è¨€ç¼–å†™çš„ç¨‹åºä¹Ÿå¿…é¡»ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ç ï¼Œè®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œ

é«˜çº§è¯­è¨€ï¼šä¸ºäº†ä½¿è®¡ç®—æœºç”¨æˆ·ç¼–ç¨‹åºæ›´å®¹æ˜“äº›ï¼Œåæ¥å°±å‡ºç°äº†å„ç§é«˜çº§è®¡ç®—æœºè¯­è¨€

å­—èŠ‚ç ï¼šæ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼ˆä¸­é—´ç ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ï¼Œæ¯”æœºå™¨ç æ›´æŠ½è±¡ï¼Œéœ€è¦ç›´è¯‘å™¨è½¬è¯‘åæ‰èƒ½æˆä¸ºæœºå™¨ç 

* å­—èŠ‚ç ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒï¼Œä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³
* é€šè¿‡ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå™¨å®ç°ï¼Œç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œè™šæ‹Ÿæœºå™¨å°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-é«˜çº§è¯­è¨€æ‰§è¡Œè¿‡ç¨‹.png" style="zoom:50%;" />



***





#### ç±»ç»“æ„

##### æ–‡ä»¶ç»“æ„

å­—èŠ‚ç æ˜¯ä¸€ç§äºŒè¿›åˆ¶çš„ç±»æ–‡ä»¶ï¼Œæ˜¯ç¼–è¯‘ä¹‹åä¾›è™šæ‹Ÿæœºè§£é‡Šæ‰§è¡Œçš„äºŒè¿›åˆ¶å­—èŠ‚ç æ–‡ä»¶ï¼Œ**ä¸€ä¸ª class æ–‡ä»¶å¯¹åº”ä¸€ä¸ª public ç±»å‹çš„ç±»æˆ–æ¥å£**

å­—èŠ‚ç å†…å®¹æ˜¯ JVM çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸æ˜¯æœºå™¨ç ï¼ŒCã€C++ ç»ç”±ç¼–è¯‘å™¨ç›´æ¥ç”Ÿæˆæœºå™¨ç ï¼Œæ‰€ä»¥ C æ‰§è¡Œæ•ˆç‡æ¯” Java é«˜

JVM å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/index.html

æ ¹æ® JVM è§„èŒƒï¼Œç±»æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

```java
ClassFile {
	u4 				magic;						
    u2 				minor_version;						
    u2 				major_version;						
    u2 				constant_pool_count;
    cp_info			constant_pool[constant_pool_count-1];
    u2	 			access_flags;
    u2 				this_class;
    u2 				super_class;
    u2 				interfaces_count;
    u2 				interfaces[interfaces_count];
    u2 				fields_count;
    field_info 		fields[fields_count];
    u2 				methods_count;
    method_info 	methods[methods_count];
    u2 				attributes_count;
    attribute_info 	attributes[attributes_count];
}
```

| ç±»å‹           | åç§°                | è¯´æ˜                 | é•¿åº¦    | æ•°é‡                  |
| -------------- | ------------------- | -------------------- | ------- | --------------------- |
| u4             | magic               | é­”æ•°ï¼Œè¯†åˆ«ç±»æ–‡ä»¶æ ¼å¼ | 4ä¸ªå­—èŠ‚ | 1                     |
| u2             | minor_version       | å‰¯ç‰ˆæœ¬å·(å°ç‰ˆæœ¬)     | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | major_version       | ä¸»ç‰ˆæœ¬å·(å¤§ç‰ˆæœ¬)     | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | constant_pool_count | å¸¸é‡æ± è®¡æ•°å™¨         | 2ä¸ªå­—èŠ‚ | 1                     |
| cp_info        | constant_pool       | å¸¸é‡æ± è¡¨             | nä¸ªå­—èŠ‚ | constant_pool_count-1 |
| u2             | access_flags        | è®¿é—®æ ‡è¯†             | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | this_class          | ç±»ç´¢å¼•               | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | super_class         | çˆ¶ç±»ç´¢å¼•             | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | interfaces_count    | æ¥å£è®¡æ•°             | 2ä¸ªå­—èŠ‚ | 1                     |
| u2             | interfaces          | æ¥å£ç´¢å¼•é›†åˆ         | 2ä¸ªå­—èŠ‚ | interfaces_count      |
| u2             | fields_count        | å­—æ®µè®¡æ•°å™¨           | 2ä¸ªå­—èŠ‚ | 1                     |
| field_info     | fields              | å­—æ®µè¡¨               | nä¸ªå­—èŠ‚ | fields_count          |
| u2             | methods_count       | æ–¹æ³•è®¡æ•°å™¨           | 2ä¸ªå­—èŠ‚ | 1                     |
| method_info    | methods             | æ–¹æ³•è¡¨               | nä¸ªå­—èŠ‚ | methods_count         |
| u2             | attributes_count    | å±æ€§è®¡æ•°å™¨           | 2ä¸ªå­—èŠ‚ | 1                     |
| attribute_info | attributes          | å±æ€§è¡¨               | nä¸ªå­—èŠ‚ | attributes_count      |

Class æ–‡ä»¶æ ¼å¼é‡‡ç”¨ä¸€ç§ç±»ä¼¼äº C è¯­è¨€ç»“æ„ä½“çš„æ–¹å¼è¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œè¿™ç§ç»“æ„ä¸­åªæœ‰ä¸¤ç§æ•°æ®ç±»å‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨

* æ— ç¬¦å·æ•°å±äºåŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä»¥ u1ã€u2ã€u4ã€u8 æ¥åˆ†åˆ«ä»£è¡¨1ä¸ªå­—èŠ‚ã€2ä¸ªå­—èŠ‚ã€4ä¸ªå­—èŠ‚å’Œ8ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•°ï¼Œæ— ç¬¦å·æ•°å¯ä»¥ç”¨æ¥æè¿°æ•°å­—ã€ç´¢å¼•å¼•ç”¨ã€æ•°é‡å€¼æˆ–è€…æŒ‰ç…§ UTF-8 ç¼–ç æ„æˆå­—ç¬¦ä¸²
* è¡¨æ˜¯ç”±å¤šä¸ªæ— ç¬¦å·æ•°æˆ–è€…å…¶ä»–è¡¨ä½œä¸ºæ•°æ®é¡¹æ„æˆçš„å¤åˆæ•°æ®ç±»å‹ï¼Œè¡¨éƒ½ä»¥ `_info` ç»“å°¾ï¼Œç”¨äºæè¿°æœ‰å±‚æ¬¡å…³ç³»çš„æ•°æ®ï¼Œæ•´ä¸ª Class æ–‡ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ä¸€å¼ è¡¨ï¼Œç”±äºè¡¨æ²¡æœ‰å›ºå®šé•¿åº¦ï¼Œæ‰€ä»¥é€šå¸¸ä¼šåœ¨å…¶å‰é¢åŠ ä¸Šä¸ªæ•°è¯´æ˜

è·å–æ–¹å¼ï¼š

* HelloWorld.java æ‰§è¡Œ `javac -parameters -d . HellowWorld.java`æŒ‡ä»¤
* å†™å…¥æ–‡ä»¶æŒ‡ä»¤ `javap -v xxx.class >xxx.txt`
* IDEA æ’ä»¶ jclasslib 



***



##### é­”æ•°ç‰ˆæœ¬

é­”æ•°ï¼šæ¯ä¸ª Class æ–‡ä»¶å¼€å¤´çš„ 4 ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ç§°ä¸ºé­”æ•°ï¼ˆMagic Numberï¼‰ï¼Œæ˜¯ Class æ–‡ä»¶çš„æ ‡è¯†ç¬¦ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªèƒ½è¢«è™šæ‹Ÿæœºæ¥å—çš„æœ‰æ•ˆåˆæ³•çš„ Class æ–‡ä»¶ï¼Œ

* é­”æ•°å€¼å›ºå®šä¸º 0xCAFEBABEï¼Œä¸ç¬¦åˆåˆ™ä¼šæŠ›å‡ºé”™è¯¯

* ä½¿ç”¨é­”æ•°è€Œä¸æ˜¯æ‰©å±•åæ¥è¿›è¡Œè¯†åˆ«ä¸»è¦æ˜¯åŸºäºå®‰å…¨æ–¹é¢çš„è€ƒè™‘ï¼Œå› ä¸ºæ–‡ä»¶æ‰©å±•åå¯ä»¥éšæ„åœ°æ”¹åŠ¨

ç‰ˆæœ¬ï¼š4 ä¸ª å­—èŠ‚ï¼Œ5 6ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨çš„æ˜¯ç¼–è¯‘çš„å‰¯ç‰ˆæœ¬å· minor_versionï¼Œè€Œ 7 8 ä¸¤ä¸ªå­—èŠ‚æ˜¯ç¼–è¯‘çš„ä¸»ç‰ˆæœ¬å· major_version

* ä¸åŒç‰ˆæœ¬çš„ Java ç¼–è¯‘å™¨ç¼–è¯‘çš„ Class æ–‡ä»¶å¯¹åº”çš„ç‰ˆæœ¬æ˜¯ä¸ä¸€æ ·çš„ï¼Œé«˜ç‰ˆæœ¬çš„ Java è™šæ‹Ÿæœºå¯ä»¥æ‰§è¡Œç”±ä½ç‰ˆæœ¬ç¼–è¯‘å™¨ç”Ÿæˆçš„ Class æ–‡ä»¶ï¼Œåä¹‹ JVM ä¼šæŠ›å‡ºå¼‚å¸¸ `java.lang.UnsupportedClassVersionError`

| ä¸»ç‰ˆæœ¬ï¼ˆåè¿›åˆ¶ï¼‰ | å‰¯ç‰ˆæœ¬ï¼ˆåè¿›åˆ¶ï¼‰ | ç¼–è¯‘å™¨ç‰ˆæœ¬ |
| ---------------- | ---------------- | ---------- |
| 45               | 3                | 1.1        |
| 46               | 0                | 1.2        |
| 47               | 0                | 1.3        |
| 48               | 0                | 1.4        |
| 49               | 0                | 1.5        |
| 50               | 0                | 1.6        |
| 51               | 0                | 1.7        |
| 52               | 0                | 1.8        |
| 53               | 0                | 1.9        |
| 54               | 0                | 1.10       |
| 55               | 0                | 1.11       |

![](https://gitee.com/seazean/images/raw/master/Java/JVM-ç±»ç»“æ„.png)



å›¾ç‰‡æ¥æºï¼šhttps://www.bilibili.com/video/BV1PJ411n7xZ



***



##### å¸¸é‡æ± 

å¸¸é‡æ± ä¸­å¸¸é‡çš„æ•°é‡æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å¸¸é‡æ± çš„å…¥å£éœ€è¦æ”¾ç½®ä¸€é¡¹ u2 ç±»å‹çš„æ— ç¬¦å·æ•°ï¼Œä»£è¡¨å¸¸é‡æ± è®¡æ•°å™¨ï¼ˆconstant_pool_countï¼‰ï¼Œè¿™ä¸ªå®¹é‡è®¡æ•°æ˜¯ä» 1 è€Œä¸æ˜¯ 0 å¼€å§‹ï¼Œæ˜¯ä¸ºäº†æ»¡è¶³åé¢æŸäº›æŒ‡å‘å¸¸é‡æ± çš„ç´¢å¼•å€¼çš„æ•°æ®åœ¨ç‰¹å®šæƒ…å†µä¸‹éœ€è¦è¡¨è¾¾ä¸å¼•ç”¨ä»»ä½•ä¸€ä¸ªå¸¸é‡æ± é¡¹ç›®ï¼Œè¿™ç§æƒ…å†µå¯ç”¨ç´¢å¼•å€¼ 0 æ¥è¡¨ç¤º

constant_pool æ˜¯ä¸€ç§è¡¨ç»“æ„ï¼Œä»¥1 ~ constant_pool_count - 1ä¸ºç´¢å¼•ï¼Œè¡¨æ˜æœ‰å¤šå°‘ä¸ªå¸¸é‡æ± è¡¨é¡¹ã€‚è¡¨é¡¹ä¸­å­˜æ”¾ç¼–è¯‘æ—¶æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± 

* å­—é¢é‡ï¼ˆLiteralï¼‰ ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å­—ç¬¦ä¸²ç±»å‹å¸¸é‡ã€å£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰

* ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰ï¼šç±»å’Œæ¥å£çš„å…¨é™å®šåã€å­—æ®µçš„åç§°å’Œæè¿°ç¬¦ã€æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦

  * å…¨é™å®šåï¼šcom/test/Demo è¿™ä¸ªå°±æ˜¯ç±»çš„å…¨é™å®šåï¼Œä»…ä»…æ˜¯æŠŠåŒ…åçš„ `.` æ›¿æ¢æˆ `/`ï¼Œä¸ºäº†ä½¿è¿ç»­çš„å¤šä¸ªå…¨é™å®šåä¹‹é—´ä¸äº§ç”Ÿæ··æ·†ï¼Œåœ¨ä½¿ç”¨æ—¶æœ€åä¸€èˆ¬ä¼šåŠ å…¥ä¸€ä¸ª `;` è¡¨ç¤ºå…¨é™å®šåç»“æŸ

  * ç®€å•åç§°ï¼šæŒ‡æ²¡æœ‰ç±»å‹å’Œå‚æ•°ä¿®é¥°çš„æ–¹æ³•æˆ–è€…å­—æ®µåç§°ï¼Œæ¯”å¦‚å­—æ®µ x çš„ç®€å•åç§°å°±æ˜¯ x

  * æè¿°ç¬¦ï¼šç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ã€æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ï¼ˆåŒ…æ‹¬æ•°é‡ã€ç±»å‹ä»¥åŠé¡ºåºï¼‰å’Œè¿”å›å€¼

    | æ ‡å¿—ç¬¦ | å«ä¹‰                                                      |
    | ------ | --------------------------------------------------------- |
    | B      | åŸºæœ¬æ•°æ®ç±»å‹ byte                                         |
    | C      | åŸºæœ¬æ•°æ®ç±»å‹ char                                         |
    | D      | åŸºæœ¬æ•°æ®ç±»å‹ double                                       |
    | F      | åŸºæœ¬æ•°æ®ç±»å‹ float                                        |
    | I      | åŸºæœ¬æ•°æ®ç±»å‹ int                                          |
    | J      | åŸºæœ¬æ•°æ®ç±»å‹ long                                         |
    | S      | åŸºæœ¬æ•°æ®ç±»å‹ short                                        |
    | Z      | åŸºæœ¬æ•°æ®ç±»å‹ boolean                                      |
    | V      | ä»£è¡¨ void ç±»å‹                                            |
    | L      | å¯¹è±¡ç±»å‹ï¼Œæ¯”å¦‚ï¼š`Ljava/lang/Object;`ï¼Œä¸åŒæ–¹æ³•é—´ç”¨`;`éš”å¼€ |
    | [      | æ•°ç»„ç±»å‹ï¼Œä»£è¡¨ä¸€ç»´æ•°ç»„ã€‚æ¯”å¦‚ï¼š`double[][][] is [[[D`      |

å¸¸é‡ç±»å‹å’Œç»“æ„ï¼š

| ç±»å‹                             | æ ‡å¿—(æˆ–æ ‡è¯†) | æè¿°                   |
| -------------------------------- | ------------ | ---------------------- |
| CONSTANT_utf8_info               | 1            | UTF-8ç¼–ç çš„å­—ç¬¦ä¸²      |
| CONSTANT_Integer_info            | 3            | æ•´å‹å­—é¢é‡             |
| CONSTANT_Float_info              | 4            | æµ®ç‚¹å‹å­—é¢é‡           |
| CONSTANT_Long_info               | 5            | é•¿æ•´å‹å­—é¢é‡           |
| CONSTANT_Double_info             | 6            | åŒç²¾åº¦æµ®ç‚¹å‹å­—é¢é‡     |
| CONSTANT_Class_info              | 7            | ç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨     |
| CONSTANT_String_info             | 8            | å­—ç¬¦ä¸²ç±»å‹å­—é¢é‡       |
| CONSTANT_Fieldref_info           | 9            | å­—æ®µçš„ç¬¦å·å¼•ç”¨         |
| CONSTANT_Methodref_info          | 10           | ç±»ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨     |
| CONSTANT_InterfaceMethodref_info | 11           | æ¥å£ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨   |
| CONSTANT_NameAndType_info        | 12           | å­—æ®µæˆ–æ–¹æ³•çš„ç¬¦å·å¼•ç”¨   |
| CONSTANT_MethodHandle_info       | 15           | è¡¨ç¤ºæ–¹æ³•å¥æŸ„           |
| CONSTANT_MethodType_info         | 16           | æ ‡å¿—æ–¹æ³•ç±»å‹           |
| CONSTANT_InvokeDynamic_info      | 18           | è¡¨ç¤ºä¸€ä¸ªåŠ¨æ€æ–¹æ³•è°ƒç”¨ç‚¹ |

18 ç§å¸¸é‡æ²¡æœ‰å‡ºç° byteã€shortã€charï¼Œboolean çš„åŸå› ï¼šç¼–è¯‘ä¹‹åéƒ½å¯ä»¥ç†è§£ä¸º Integer



****



##### è®¿é—®æ ‡è¯†

è®¿é—®æ ‡è¯†ï¼ˆaccess_flagï¼‰ï¼Œåˆå«è®¿é—®æ ‡å¿—ã€è®¿é—®æ ‡è®°ï¼Œè¯¥æ ‡è¯†ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œç”¨äºè¯†åˆ«ä¸€äº›ç±»æˆ–è€…æ¥å£å±‚æ¬¡çš„è®¿é—®ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿™ä¸ª Class æ˜¯ç±»è¿˜æ˜¯æ¥å£ï¼Œæ˜¯å¦å®šä¹‰ä¸º publicç±»å‹ï¼Œæ˜¯å¦å®šä¹‰ä¸º abstractç±»å‹ç­‰

* ç±»çš„è®¿é—®æƒé™é€šå¸¸ä¸º ACC_ å¼€å¤´çš„å¸¸é‡
* æ¯ä¸€ç§ç±»å‹çš„è¡¨ç¤ºéƒ½æ˜¯é€šè¿‡è®¾ç½®è®¿é—®æ ‡è®°çš„ 32 ä½ä¸­çš„ç‰¹å®šä½æ¥å®ç°çš„ï¼Œæ¯”å¦‚è‹¥æ˜¯ public final çš„ç±»ï¼Œåˆ™è¯¥æ ‡è®°ä¸º `ACC_PUBLIC | ACC_FINAL`
* ä½¿ç”¨ `ACC_SUPER` å¯ä»¥è®©ç±»æ›´å‡†ç¡®åœ°å®šä½åˆ°çˆ¶ç±»çš„æ–¹æ³•ï¼Œç¡®å®šç±»æˆ–æ¥å£é‡Œé¢çš„ invokespecial æŒ‡ä»¤ä½¿ç”¨çš„æ˜¯å“ªä¸€ç§æ‰§è¡Œè¯­ä¹‰ï¼Œç°ä»£ç¼–è¯‘å™¨éƒ½ä¼šè®¾ç½®å¹¶ä¸”ä½¿ç”¨è¿™ä¸ªæ ‡è®°

| æ ‡å¿—åç§°       | æ ‡å¿—å€¼ | å«ä¹‰                                                         |
| -------------- | ------ | ------------------------------------------------------------ |
| ACC_PUBLIC     | 0x0001 | æ ‡å¿—ä¸º public ç±»å‹                                           |
| ACC_FINAL      | 0x0010 | æ ‡å¿—è¢«å£°æ˜ä¸º finalï¼Œåªæœ‰ç±»å¯ä»¥è®¾ç½®                           |
| ACC_SUPER      | 0x0020 | æ ‡å¿—å…è®¸ä½¿ç”¨ invokespecial å­—èŠ‚ç æŒ‡ä»¤çš„æ–°è¯­ä¹‰ï¼ŒJDK1.0.2ä¹‹åç¼–è¯‘å‡ºæ¥çš„ç±»çš„è¿™ä¸ªæ ‡å¿—é»˜è®¤ä¸ºçœŸï¼Œä½¿ç”¨å¢å¼ºçš„æ–¹æ³•è°ƒç”¨çˆ¶ç±»æ–¹æ³• |
| ACC_INTERFACE  | 0x0200 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæ¥å£                                             |
| ACC_ABSTRACT   | 0x0400 | æ˜¯å¦ä¸º abstract ç±»å‹ï¼Œå¯¹äºæ¥å£æˆ–è€…æŠ½è±¡ç±»æ¥è¯´ï¼Œæ¬¡æ ‡å¿—å€¼ä¸ºçœŸï¼Œå…¶ä»–ç±»å‹ä¸ºå‡ |
| ACC_SYNTHETIC  | 0x1000 | æ ‡å¿—æ­¤ç±»å¹¶éç”±ç”¨æˆ·ä»£ç äº§ç”Ÿï¼ˆç”±ç¼–è¯‘å™¨äº§ç”Ÿçš„ç±»ï¼Œæ²¡æœ‰æºç å¯¹åº”ï¼‰ |
| ACC_ANNOTATION | 0x2000 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæ³¨è§£                                             |
| ACC_ENUM       | 0x4000 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæšä¸¾                                             |



***



##### ç´¢å¼•é›†åˆ

ç±»ç´¢å¼•ã€çˆ¶ç±»ç´¢å¼•ã€æ¥å£ç´¢å¼•é›†åˆ

* ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„å…¨é™å®šå

* çˆ¶ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„çˆ¶ç±»çš„å…¨é™å®šåï¼ŒJava è¯­è¨€ä¸å…è®¸å¤šé‡ç»§æ‰¿ï¼Œæ‰€ä»¥çˆ¶ç±»ç´¢å¼•åªæœ‰ä¸€ä¸ªï¼Œé™¤äº†Object ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ Java ç±»éƒ½æœ‰çˆ¶ç±»ï¼Œå› æ­¤é™¤äº† java.lang.Object å¤–ï¼Œæ‰€æœ‰ Java ç±»çš„çˆ¶ç±»ç´¢å¼•éƒ½ä¸ä¸º0

* æ¥å£ç´¢å¼•é›†åˆå°±ç”¨æ¥æè¿°è¿™ä¸ªç±»å®ç°äº†å“ªäº›æ¥å£
  * interfaces_count é¡¹çš„å€¼è¡¨ç¤ºå½“å‰ç±»æˆ–æ¥å£çš„ç›´æ¥è¶…æ¥å£æ•°é‡
  * interfaces[] æ¥å£ç´¢å¼•é›†åˆï¼Œè¢«å®ç°çš„æ¥å£å°†æŒ‰ implements è¯­å¥åçš„æ¥å£é¡ºåºä»å·¦åˆ°å³æ’åˆ—åœ¨æ¥å£ç´¢å¼•é›†åˆä¸­

| é•¿åº¦ | å«ä¹‰                         |
| ---- | ---------------------------- |
| u2   | this_class                   |
| u2   | super_class                  |
| u2   | interfaces_count             |
| u2   | interfaces[interfaces_count] |



***



##### å­—æ®µè¡¨

å­—æ®µ fields ç”¨äºæè¿°æ¥å£æˆ–ç±»ä¸­å£°æ˜çš„å˜é‡ï¼ŒåŒ…æ‹¬ç±»å˜é‡ä»¥åŠå®ä¾‹å˜é‡ï¼Œä½†ä¸åŒ…æ‹¬æ–¹æ³•å†…éƒ¨ã€ä»£ç å—å†…éƒ¨å£°æ˜çš„å±€éƒ¨å˜é‡ä»¥åŠä»çˆ¶ç±»æˆ–çˆ¶æ¥å£ç»§æ‰¿ã€‚å­—æ®µå«ä»€ä¹ˆåå­—ã€è¢«å®šä¹‰ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œéƒ½æ˜¯æ— æ³•å›ºå®šçš„ï¼Œåªèƒ½å¼•ç”¨å¸¸é‡æ± ä¸­çš„å¸¸é‡æ¥æè¿°

fields_countï¼ˆå­—æ®µè®¡æ•°å™¨ï¼‰ï¼Œè¡¨ç¤ºå½“å‰ class æ–‡ä»¶ fields è¡¨çš„æˆå‘˜ä¸ªæ•°ï¼Œç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤º

fields[]ï¼ˆå­—æ®µè¡¨ï¼‰ï¼š

* è¡¨ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ª fields_info ç»“æ„çš„æ•°æ®é¡¹ï¼Œç”¨äºè¡¨ç¤ºå½“å‰ç±»æˆ–æ¥å£ä¸­æŸä¸ªå­—æ®µçš„å®Œæ•´æè¿°

* å­—æ®µè®¿é—®æ ‡è¯†ï¼š

  | æ ‡å¿—åç§°      | æ ‡å¿—å€¼ | å«ä¹‰                       |
  | ------------- | ------ | -------------------------- |
  | ACC_PUBLIC    | 0x0001 | å­—æ®µæ˜¯å¦ä¸ºpublic           |
  | ACC_PRIVATE   | 0x0002 | å­—æ®µæ˜¯å¦ä¸ºprivate          |
  | ACC_PROTECTED | 0x0004 | å­—æ®µæ˜¯å¦ä¸ºprotected        |
  | ACC_STATIC    | 0x0008 | å­—æ®µæ˜¯å¦ä¸ºstatic           |
  | ACC_FINAL     | 0x0010 | å­—æ®µæ˜¯å¦ä¸ºfinal            |
  | ACC_VOLATILE  | 0x0040 | å­—æ®µæ˜¯å¦ä¸ºvolatile         |
  | ACC_TRANSTENT | 0x0080 | å­—æ®µæ˜¯å¦ä¸ºtransient        |
  | ACC_SYNCHETIC | 0x1000 | å­—æ®µæ˜¯å¦ä¸ºç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ |
  | ACC_ENUM      | 0x4000 | å­—æ®µæ˜¯å¦ä¸ºenum             |

* å­—æ®µåç´¢å¼•ï¼šæ ¹æ®è¯¥å€¼æŸ¥è¯¢å¸¸é‡æ± ä¸­çš„æŒ‡å®šç´¢å¼•é¡¹å³å¯

* æè¿°ç¬¦ç´¢å¼•ï¼šç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ã€æ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼

  | å­—ç¬¦        | ç±»å‹      | å«ä¹‰                    |
  | ----------- | --------- | ----------------------- |
  | B           | byte      | æœ‰ç¬¦å·å­—èŠ‚å‹æ ‘          |
  | C           | char      | Unicodeå­—ç¬¦ï¼ŒUTF-16ç¼–ç  |
  | D           | double    | åŒç²¾åº¦æµ®ç‚¹æ•°            |
  | F           | float     | å•ç²¾åº¦æµ®ç‚¹æ•°            |
  | I           | int       | æ•´å‹æ•°                  |
  | J           | long      | é•¿æ•´æ•°                  |
  | S           | short     | æœ‰ç¬¦å·çŸ­æ•´æ•°            |
  | Z           | boolean   | å¸ƒå°”å€¼true/false        |
  | V           | void      | ä»£è¡¨voidç±»å‹            |
  | L Classname | reference | ä¸€ä¸ªåä¸ºClassnameçš„å®ä¾‹ |
  | [           | reference | ä¸€ä¸ªä¸€ç»´æ•°ç»„            |

* å±æ€§è¡¨é›†åˆï¼šå±æ€§ä¸ªæ•°å­˜æ”¾åœ¨ attribute_count ä¸­ï¼Œå±æ€§å…·ä½“å†…å®¹å­˜æ”¾åœ¨ attribute æ•°ç»„ä¸­ï¼Œä¸€ä¸ªå­—æ®µè¿˜å¯èƒ½æ‹¥æœ‰ä¸€äº›å±æ€§ï¼Œç”¨äºå­˜å‚¨æ›´å¤šçš„é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚åˆå§‹åŒ–å€¼ã€ä¸€äº›æ³¨é‡Šä¿¡æ¯ç­‰

  ```java
  ConstantValue_attribute{
      u2 attribute_name_index;
      u4 attribute_length;
      u2 constantvalue_index;
  }
  ```

  å¯¹äºå¸¸é‡å±æ€§è€Œè¨€ï¼Œattribute_length å€¼æ’ä¸º2



***



##### æ–¹æ³•è¡¨

æ–¹æ³•è¡¨æ˜¯ methods æŒ‡å‘å¸¸é‡æ± ç´¢å¼•é›†åˆï¼Œå…¶ä¸­æ¯ä¸€ä¸ª method_info é¡¹éƒ½å¯¹åº”ç€ä¸€ä¸ªç±»æˆ–è€…æ¥å£ä¸­çš„æ–¹æ³•ä¿¡æ¯ï¼Œå®Œæ•´æè¿°äº†æ¯ä¸ªæ–¹æ³•çš„ç­¾å

* å¦‚æœè¿™ä¸ªæ–¹æ³•ä¸æ˜¯æŠ½è±¡çš„æˆ–è€…ä¸æ˜¯ native çš„ï¼Œå­—èŠ‚ç ä¸­å°±ä¼šä½“ç°å‡ºæ¥
* methods è¡¨åªæè¿°å½“å‰ç±»æˆ–æ¥å£ä¸­å£°æ˜çš„æ–¹æ³•ï¼Œä¸åŒ…æ‹¬ä»çˆ¶ç±»æˆ–çˆ¶æ¥å£ç»§æ‰¿çš„æ–¹æ³•
* methods è¡¨å¯èƒ½ä¼šå‡ºç°ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ çš„æ–¹æ³•ï¼Œæ¯”å¦‚åˆå§‹åŒ–æ–¹æ³• <cinit> å’Œå®ä¾‹åŒ–æ–¹æ³• <init>

**é‡è½½ï¼ˆOverloadï¼‰**ä¸€ä¸ªæ–¹æ³•ï¼Œé™¤äº†è¦ä¸åŸæ–¹æ³•å…·æœ‰ç›¸åŒçš„ç®€å•åç§°ä¹‹å¤–ï¼Œè¿˜è¦æ±‚å¿…é¡»æ‹¥æœ‰ä¸€ä¸ªä¸åŸæ–¹æ³•ä¸åŒçš„ç‰¹å¾ç­¾åï¼Œç‰¹å¾ç­¾åå°±æ˜¯ä¸€ä¸ªæ–¹æ³•ä¸­å„ä¸ªå‚æ•°åœ¨å¸¸é‡æ± ä¸­çš„å­—æ®µç¬¦å·å¼•ç”¨çš„é›†åˆï¼Œå› ä¸ºè¿”å›å€¼ä¸ä¼šåŒ…å«åœ¨ç‰¹å¾ç­¾åä¹‹ä¸­ï¼Œå› æ­¤ Java è¯­è¨€é‡Œæ— æ³•ä»…ä»…ä¾é è¿”å›å€¼çš„ä¸åŒæ¥å¯¹ä¸€ä¸ªå·²æœ‰æ–¹æ³•è¿›è¡Œé‡è½½ã€‚ä½†åœ¨ Class æ–‡ä»¶æ ¼å¼ä¸­ï¼Œç‰¹å¾ç­¾åçš„èŒƒå›´æ›´å¤§ä¸€äº›ï¼Œåªè¦æè¿°ç¬¦ä¸æ˜¯å®Œå…¨ä¸€è‡´çš„ä¸¤ä¸ªæ–¹æ³•å°±å¯ä»¥å…±å­˜

methods_countï¼ˆæ–¹æ³•è®¡æ•°å™¨ï¼‰ï¼šè¡¨ç¤º class æ–‡ä»¶ methods è¡¨çš„æˆå‘˜ä¸ªæ•°ï¼Œä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤º

methods[]ï¼ˆæ–¹æ³•è¡¨ï¼‰ï¼šæ¯ä¸ªè¡¨é¡¹éƒ½æ˜¯ä¸€ä¸ª method_info ç»“æ„ï¼Œè¡¨ç¤ºå½“å‰ç±»æˆ–æ¥å£ä¸­æŸä¸ªæ–¹æ³•çš„å®Œæ•´æè¿°

* æ–¹æ³•è¡¨ç»“æ„å¦‚ä¸‹ï¼š

  | ç±»å‹           | åç§°             | å«ä¹‰       | æ•°é‡             |
  | -------------- | ---------------- | ---------- | ---------------- |
  | u2             | access_flags     | è®¿é—®æ ‡å¿—   | 1                |
  | u2             | name_index       | å­—æ®µåç´¢å¼• | 1                |
  | u2             | descriptor_index | æè¿°ç¬¦ç´¢å¼• | 1                |
  | u2             | attrubutes_count | å±æ€§è®¡æ•°å™¨ | 1                |
  | attribute_info | attributes       | å±æ€§é›†åˆ   | attributes_count |

* æ–¹æ³•è¡¨è®¿é—®æ ‡å¿—ï¼š

  | æ ‡å¿—åç§°      | æ ‡å¿—å€¼ | å«ä¹‰                       |
  | ------------- | ------ | -------------------------- |
  | ACC_PUBLIC    | 0x0001 | å­—æ®µæ˜¯å¦ä¸º public          |
  | ACC_PRIVATE   | 0x0002 | å­—æ®µæ˜¯å¦ä¸º private         |
  | ACC_PROTECTED | 0x0004 | å­—æ®µæ˜¯å¦ä¸º protected       |
  | ACC_STATIC    | 0x0008 | å­—æ®µæ˜¯å¦ä¸º static          |
  | ACC_FINAL     | 0x0010 | å­—æ®µæ˜¯å¦ä¸º final           |
  | ACC_VOLATILE  | 0x0040 | å­—æ®µæ˜¯å¦ä¸º volatile        |
  | ACC_TRANSTENT | 0x0080 | å­—æ®µæ˜¯å¦ä¸º transient       |
  | ACC_SYNCHETIC | 0x1000 | å­—æ®µæ˜¯å¦ä¸ºç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ |
  | ACC_ENUM      | 0x4000 | å­—æ®µæ˜¯å¦ä¸º enum            |



***



##### å±æ€§è¡¨

å±æ€§è¡¨é›†åˆï¼ŒæŒ‡çš„æ˜¯ Class æ–‡ä»¶æ‰€æºå¸¦çš„è¾…åŠ©ä¿¡æ¯ï¼Œæ¯”å¦‚è¯¥ Class æ–‡ä»¶çš„æºæ–‡ä»¶çš„åç§°ï¼Œä»¥åŠä»»ä½•å¸¦æœ‰ `RetentionPolicy.CLASS` æˆ–è€… `RetentionPolicy.RUNTIME` çš„æ³¨è§£ï¼Œè¿™ç±»ä¿¡æ¯é€šå¸¸è¢«ç”¨äº Java è™šæ‹Ÿæœºçš„éªŒè¯å’Œè¿è¡Œï¼Œä»¥åŠ Java ç¨‹åºçš„è°ƒè¯•ã€‚å­—æ®µè¡¨ã€æ–¹æ³•è¡¨éƒ½å¯ä»¥æœ‰è‡ªå·±çš„å±æ€§è¡¨ï¼Œç”¨äºæè¿°æŸäº›åœºæ™¯ä¸“æœ‰çš„ä¿¡æ¯

attributes_ countï¼ˆå±æ€§è®¡æ•°å™¨ï¼‰ï¼šè¡¨ç¤ºå½“å‰æ–‡ä»¶å±æ€§è¡¨çš„æˆå‘˜ä¸ªæ•°

attributes[]ï¼ˆå±æ€§è¡¨ï¼‰ï¼šå±æ€§è¡¨çš„æ¯ä¸ªé¡¹çš„å€¼å¿…é¡»æ˜¯ attribute_info ç»“æ„

* å±æ€§çš„é€šç”¨æ ¼å¼ï¼š

  ```java
  ConstantValue_attribute{
      u2 attribute_name_index;	//å±æ€§åç´¢å¼•
      u4 attribute_length;		//å±æ€§é•¿åº¦
      u2 attribute_info;			//å±æ€§è¡¨
  }
  ```

* å±æ€§ç±»å‹ï¼š

  | å±æ€§åç§°                              | ä½¿ç”¨ä½ç½®           | å«ä¹‰                                                         |
  | ------------------------------------- | ------------------ | ------------------------------------------------------------ |
  | Code                                  | æ–¹æ³•è¡¨             | Java ä»£ç ç¼–è¯‘æˆçš„å­—èŠ‚ç æŒ‡ä»¤                                  |
  | ConstantValue                         | å­—æ®µè¡¨             | final å…³é”®å­—å®šä¹‰çš„å¸¸é‡æ±                                      |
  | Deprecated                            | ç±»ã€æ–¹æ³•ã€å­—æ®µè¡¨   | è¢«å£°æ˜ä¸º deprecated çš„æ–¹æ³•å’Œå­—æ®µ                             |
  | Exceptions                            | æ–¹æ³•è¡¨             | æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸                                               |
  | EnclosingMethod                       | ç±»æ–‡ä»¶             | ä»…å½“ä¸€ä¸ªç±»ä¸ºå±€éƒ¨ç±»æˆ–è€…åŒ¿åç±»æ˜¯æ‰èƒ½æ‹¥æœ‰è¿™ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§ç”¨äºæ ‡è¯†è¿™ä¸ªç±»æ‰€åœ¨çš„å¤–å›´æ–¹æ³• |
  | InnerClass                            | ç±»æ–‡ä»¶             | å†…éƒ¨ç±»åˆ—è¡¨                                                   |
  | LineNumberTable                       | Codeå±æ€§           | Java æºç çš„è¡Œå·ä¸å­—èŠ‚ç æŒ‡ä»¤çš„å¯¹åº”å…³ç³»                        |
  | LocalVariableTable                    | Codeå±æ€§           | æ–¹æ³•çš„å±€éƒ¨å˜é‡æè¿°                                           |
  | StackMapTable                         | Codeå±æ€§           | JDK1.6ä¸­æ–°å¢çš„å±æ€§ï¼Œä¾›æ–°çš„ç±»å‹æ£€æŸ¥æ£€éªŒå™¨æ£€æŸ¥å’Œå¤„ç†ç›®æ ‡æ–¹æ³•çš„å±€éƒ¨å˜é‡å’Œæ“ä½œæ•°æœ‰æ‰€éœ€è¦çš„ç±»æ˜¯å¦åŒ¹é… |
  | Signature                             | ç±»ï¼Œæ–¹æ³•è¡¨ï¼Œå­—æ®µè¡¨ | ç”¨äºæ”¯æŒæ³›å‹æƒ…å†µä¸‹çš„æ–¹æ³•ç­¾å                                 |
  | SourceFile                            | ç±»æ–‡ä»¶             | è®°å½•æºæ–‡ä»¶åç§°                                               |
  | SourceDebugExtension                  | ç±»æ–‡ä»¶             | ç”¨äºå­˜å‚¨é¢å¤–çš„è°ƒè¯•ä¿¡æ¯                                       |
  | Syothetic                             | ç±»ï¼Œæ–¹æ³•è¡¨ï¼Œå­—æ®µè¡¨ | æ ‡å¿—æ–¹æ³•æˆ–å­—æ®µä¸ºç¼–æ³½å™¨è‡ªåŠ¨ç”Ÿæˆçš„                             |
  | LocalVariableTypeTable                | ç±»                 | ä½¿ç”¨ç‰¹å¾ç­¾åä»£æ›¿æè¿°ç¬¦ï¼Œæ˜¯ä¸ºäº†å¼•å…¥æ³›å‹è¯­æ³•ä¹‹åèƒ½æè¿°æ³›å‹å‚æ•°åŒ–ç±»å‹è€Œæ·»åŠ  |
  | RuntimeVisibleAnnotations             | ç±»ï¼Œæ–¹æ³•è¡¨ï¼Œå­—æ®µè¡¨ | ä¸ºåŠ¨æ€æ³¨è§£æä¾›æ”¯æŒ                                           |
  | RuntimelnvisibleAnnotations           | ç±»ï¼Œæ–¹æ³•è¡¨ï¼Œå­—æ®µè¡¨ | ç”¨äºæŒ‡æ˜å“ªäº›æ³¨è§£æ˜¯è¿è¡Œæ—¶ä¸å¯è§çš„                             |
  | RuntimeVisibleParameterAnnotation     | æ–¹æ³•è¡¨             | ä½œç”¨ä¸ RuntimeVisibleAnnotations å±æ€§ç±»ä¼¼ï¼Œåªä¸è¿‡ä½œç”¨å¯¹è±¡ä¸ºæ–¹æ³• |
  | RuntirmelnvisibleParameterAnniotation | æ–¹æ³•è¡¨             | ä½œç”¨ä¸ RuntimelnvisibleAnnotations å±æ€§ç±»ä¼¼ï¼Œä½œç”¨å¯¹è±¡å“ªä¸ªä¸ºæ–¹æ³•å‚æ•° |
  | AnnotationDefauit                     | æ–¹æ³•è¡¨             | ç”¨äºè®°å½•æ³¨è§£ç±»å…ƒç´ çš„é»˜è®¤å€¼                                   |
  | BootstrapMethods                      | ç±»æ–‡ä»¶             | ç”¨äºä¿å­˜ invokeddynanic æŒ‡ä»¤å¼•ç”¨çš„å¼•å¯¼æ–¹å¼é™å®šç¬¦             |





****



#### ç¼–è¯‘æŒ‡ä»¤

##### javac

javacï¼šç¼–è¯‘å‘½ä»¤ï¼Œå°† java æºæ–‡ä»¶ç¼–è¯‘æˆ class å­—èŠ‚ç æ–‡ä»¶

`javac xx.java` ä¸ä¼šåœ¨ç”Ÿæˆå¯¹åº”çš„å±€éƒ¨å˜é‡è¡¨ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨ `javac -g xx.java` å¯ä»¥ç”Ÿæˆæ‰€æœ‰ç›¸å…³ä¿¡æ¯



****



##### javap

javap åç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œæ ¹æ® class å­—èŠ‚ç æ–‡ä»¶ï¼Œåè§£æå‡ºå½“å‰ç±»å¯¹åº”çš„ code åŒº ï¼ˆå­—èŠ‚ç æŒ‡ä»¤ï¼‰ã€å±€éƒ¨å˜é‡è¡¨ã€å¼‚å¸¸è¡¨å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ã€å¸¸é‡æ± ç­‰ä¿¡æ¯

ç”¨æ³•ï¼šjavap <options> <classes>

```sh
-help  --help  -?        è¾“å‡ºæ­¤ç”¨æ³•æ¶ˆæ¯
-version                 ç‰ˆæœ¬ä¿¡æ¯
-public                  ä»…æ˜¾ç¤ºå…¬å…±ç±»å’Œæˆå‘˜
-protected               æ˜¾ç¤ºå—ä¿æŠ¤çš„/å…¬å…±ç±»å’Œæˆå‘˜
-package                 æ˜¾ç¤ºç¨‹åºåŒ…/å—ä¿æŠ¤çš„/å…¬å…±ç±»å’Œæˆå‘˜ (é»˜è®¤)
-p  -private             æ˜¾ç¤ºæ‰€æœ‰ç±»å’Œæˆå‘˜
						 #å¸¸ç”¨çš„ä»¥ä¸‹ä¸‰ä¸ª
-v  -verbose             è¾“å‡ºé™„åŠ ä¿¡æ¯
-l                       è¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨
-c                       å¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–	#åç¼–è¯‘

-s                       è¾“å‡ºå†…éƒ¨ç±»å‹ç­¾å
-sysinfo                 æ˜¾ç¤ºæ­£åœ¨å¤„ç†çš„ç±»çš„ç³»ç»Ÿä¿¡æ¯ (è·¯å¾„, å¤§å°, æ—¥æœŸ, MD5 æ•£åˆ—)
-constants               æ˜¾ç¤ºæœ€ç»ˆå¸¸é‡
-classpath <path>        æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®
-cp <path>               æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®
-bootclasspath <path>    è¦†ç›–å¼•å¯¼ç±»æ–‡ä»¶çš„ä½ç½®
```



***



#### æŒ‡ä»¤é›†  

##### æ‰§è¡ŒæŒ‡ä»¤

Java å­—èŠ‚ç å±äº JVM åŸºæœ¬æ‰§è¡ŒæŒ‡ä»¤ã€‚ç”±ä¸€ä¸ªå­—èŠ‚é•¿åº¦çš„ä»£è¡¨æŸç§æ“ä½œçš„æ“ä½œç ï¼ˆopcodeï¼‰ä»¥åŠé›¶è‡³å¤šä¸ªä»£è¡¨æ­¤æ“ä½œæ‰€éœ€å‚æ•°çš„æ“ä½œæ•°ï¼ˆoperandï¼‰æ‰€æ„æˆï¼Œè™šæ‹Ÿæœºä¸­è®¸å¤šæŒ‡ä»¤å¹¶ä¸åŒ…å«æ“ä½œæ•°ï¼Œåªæœ‰ä¸€ä¸ªæ“ä½œç ï¼ˆé›¶åœ°å€æŒ‡ä»¤ï¼‰

ç”±äºé™åˆ¶äº† Java è™šæ‹Ÿæœºæ“ä½œç çš„é•¿åº¦ä¸ºä¸€ä¸ªå­—èŠ‚ï¼ˆ0~255ï¼‰ï¼Œæ‰€ä»¥æŒ‡ä»¤é›†çš„æ“ä½œç æ€»æ•°ä¸å¯èƒ½è¶…è¿‡ 256 æ¡

åœ¨ JVM çš„æŒ‡ä»¤é›†ä¸­ï¼Œå¤§å¤šæ•°çš„æŒ‡ä»¤éƒ½åŒ…å«äº†å…¶æ“ä½œæ‰€å¯¹åº”çš„æ•°æ®ç±»å‹ä¿¡æ¯ã€‚ä¾‹å¦‚ iload æŒ‡ä»¤ç”¨äºä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ int å‹çš„æ•°æ®åˆ°æ“ä½œæ•°æ ˆä¸­ï¼Œè€Œ fload æŒ‡ä»¤åŠ è½½çš„åˆ™æ˜¯ float ç±»å‹çš„æ•°æ®

* i ä»£è¡¨å¯¹ int ç±»å‹çš„æ•°æ®æ“ä½œ
* l ä»£è¡¨ long 
* s ä»£è¡¨ short
* b ä»£è¡¨ byte
* c ä»£è¡¨ char
* f ä»£è¡¨ float
* d ä»£è¡¨ double

å¤§éƒ¨åˆ†çš„æŒ‡ä»¤éƒ½æ²¡æœ‰æ”¯æŒ byteã€charã€shortã€boolean ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸæˆ–è¿è¡ŒæœŸå°† byte å’Œ short ç±»å‹çš„æ•°æ®å¸¦ç¬¦å·æ‰©å±•ï¼ˆSign-Extend-ï¼‰ä¸ºç›¸åº”çš„ int ç±»å‹æ•°æ®ï¼Œå°† boolean å’Œ char ç±»å‹æ•°æ®é›¶ä½æ‰©å±•ï¼ˆZero-Extend-ï¼‰ä¸ºç›¸åº”çš„ int ç±»å‹æ•°æ®

åœ¨åšå€¼ç›¸å…³æ“ä½œæ—¶:

- ä¸€ä¸ªæŒ‡ä»¤ï¼Œå¯ä»¥ä»å±€éƒ¨å˜é‡è¡¨ã€å¸¸é‡æ± ã€å †ä¸­å¯¹è±¡ã€æ–¹æ³•è°ƒç”¨ã€ç³»ç»Ÿè°ƒç”¨ä¸­ç­‰å–å¾—æ•°æ®ï¼Œè¿™äº›æ•°æ®ï¼ˆå¯èƒ½æ˜¯å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼‰è¢«å‹å…¥æ“ä½œæ•°æ ˆ
- ä¸€ä¸ªæŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥ä»æ“ä½œæ•°æ ˆä¸­å–å‡ºä¸€åˆ°å¤šä¸ªå€¼ï¼ˆpop å¤šæ¬¡ï¼‰ï¼Œå®Œæˆèµ‹å€¼ã€åŠ å‡ä¹˜é™¤ã€æ–¹æ³•ä¼ å‚ã€ç³»ç»Ÿè°ƒç”¨ç­‰ç­‰æ“ä½œ



***



##### åŠ è½½å­˜å‚¨

åŠ è½½å’Œå­˜å‚¨æŒ‡ä»¤ç”¨äºå°†æ•°æ®ä»æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆä¹‹é—´æ¥å›ä¼ é€’

å±€éƒ¨å˜é‡å‹æ ˆæŒ‡ä»¤ï¼šå°†ç»™å®šçš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ•°æ®å‹å…¥æ“ä½œæ•°æ ˆ

* xloadã€xload_nï¼Œx è¡¨ç¤ºå–å€¼æ•°æ®ç±»å‹ï¼Œä¸º iã€lã€fã€dã€aï¼Œ n ä¸º 0 åˆ° 3
* æŒ‡ä»¤ xload_n è¡¨ç¤ºå°†ç¬¬ n ä¸ªå±€éƒ¨å˜é‡å‹å…¥æ“ä½œæ•°æ ˆï¼Œaload_n è¡¨ç¤ºå°†ä¸€ä¸ªå¯¹è±¡å¼•ç”¨å‹æ ˆ
* æŒ‡ä»¤ xload n é€šè¿‡æŒ‡å®šå‚æ•°çš„å½¢å¼ï¼ŒæŠŠå±€éƒ¨å˜é‡å‹å…¥æ“ä½œæ•°æ ˆï¼Œå±€éƒ¨å˜é‡æ•°é‡è¶…è¿‡ 4 ä¸ªæ—¶ä½¿ç”¨è¿™ä¸ªå‘½ä»¤

å¸¸é‡å…¥æ ˆæŒ‡ä»¤ï¼šå°†å¸¸æ•°å‹å…¥æ“ä½œæ•°æ ˆï¼Œæ ¹æ®æ•°æ®ç±»å‹å’Œå…¥æ ˆå†…å®¹çš„ä¸åŒï¼Œåˆåˆ†ä¸º constã€pushã€ldcæŒ‡ä»¤

* pushï¼šåŒ…æ‹¬ bipush å’Œ sipushï¼ŒåŒºåˆ«åœ¨äºæ¥æ”¶æ•°æ®ç±»å‹çš„ä¸åŒï¼Œbipush æ¥æ”¶ 8 ä½æ•´æ•°ä½œä¸ºå‚æ•°ï¼Œsipush æ¥æ”¶ 16 ä½æ•´æ•°
* ldcï¼šå¦‚æœä»¥ä¸ŠæŒ‡ä»¤ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ ldc æŒ‡ä»¤ï¼Œæ¥æ”¶ä¸€ä¸ª 8 ä½çš„å‚æ•°ï¼Œè¯¥å‚æ•°æŒ‡å‘å¸¸é‡æ± ä¸­çš„ intã€ float æˆ–è€… String çš„ç´¢å¼•ï¼Œå°†æŒ‡å®šçš„å†…å®¹å‹å…¥å †æ ˆã€‚ldc_w æ¥æ”¶ä¸¤ä¸ª 8 ä½å‚æ•°ï¼Œèƒ½æ”¯æŒçš„ç´¢å¼•èŒƒå›´æ›´å¤§ï¼Œå¦‚æœè¦å‹å…¥çš„å…ƒç´ æ˜¯ long æˆ– double ç±»å‹çš„ï¼Œåˆ™ä½¿ç”¨ ldc2_w æŒ‡ä»¤
* aconst_null å°† null å¯¹è±¡å¼•ç”¨å‹å…¥æ ˆï¼Œiconst_m1 å°† int ç±»å‹å¸¸é‡ -1 å‹å…¥æ ˆï¼Œiconst_0 å°† int ç±»å‹å¸¸é‡ 0 å‹å…¥æ ˆ

å‡ºæ ˆè£…å…¥å±€éƒ¨å˜é‡è¡¨æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°æ ˆä¸­æ ˆé¡¶å…ƒç´ å¼¹å‡ºåï¼Œè£…å…¥å±€éƒ¨å˜é‡è¡¨çš„æŒ‡å®šä½ç½®ï¼Œç”¨äºç»™å±€éƒ¨å˜é‡èµ‹å€¼

* xstoreã€xstore_nï¼Œx è¡¨ç¤ºå–å€¼ç±»å‹ä¸º iã€lã€fã€dã€aï¼Œ n ä¸º 0 åˆ° 3
* xastore è¡¨ç¤ºå­˜å…¥æ•°ç»„ï¼Œx å–å€¼ä¸º iã€lã€fã€dã€aã€bã€cã€s

æ‰©å……å±€éƒ¨å˜é‡è¡¨çš„è®¿é—®ç´¢å¼•çš„æŒ‡ä»¤ï¼šwide



****



##### ç®—æœ¯æŒ‡ä»¤

ç®—æœ¯æŒ‡ä»¤ç”¨äºå¯¹ä¸¤ä¸ªæ“ä½œæ•°æ ˆä¸Šçš„å€¼è¿›è¡ŒæŸç§ç‰¹å®šè¿ç®—ï¼Œå¹¶æŠŠè®¡ç®—ç»“æœé‡æ–°å‹å…¥æ“ä½œæ•°æ ˆ

æ²¡æœ‰ç›´æ¥æ”¯æŒ byteã€ shortã€ char å’Œ booleanç±»å‹çš„ç®—æœ¯æŒ‡ä»¤ï¼Œå¯¹äºè¿™äº›æ•°æ®çš„è¿ç®—ï¼Œéƒ½ä½¿ç”¨ int ç±»å‹çš„æŒ‡ä»¤æ¥å¤„ç†ï¼Œæ•°ç»„ç±»å‹ä¹Ÿæ˜¯è½¬æ¢æˆ int æ•°ç»„

* åŠ æ³•æŒ‡ä»¤ï¼šiaddã€laddã€faddã€dadd
* å‡æ³•æŒ‡ä»¤ï¼šisubã€lsubã€fsubã€dsub
* ä¹˜æ³•æŒ‡ä»¤ï¼šimuã€lmuã€fmulã€dmul
* é™¤æ³•æŒ‡ä»¤ï¼šidivã€ldivã€fdivã€ddiv
* æ±‚ä½™æŒ‡ä»¤ï¼širemã€lremã€fremã€dremï¼ˆremainder ä½™æ•°ï¼‰
* å–åæŒ‡ä»¤ï¼šinegã€lnegã€fnegã€dneg ï¼ˆnegation å–åï¼‰
* è‡ªå¢æŒ‡ä»¤ï¼šiincï¼ˆç›´æ¥**åœ¨å±€éƒ¨å˜é‡ slot ä¸Šè¿›è¡Œè¿ç®—**ï¼Œä¸ç”¨æ”¾å…¥æ“ä½œæ•°æ ˆï¼‰
* ä½è¿ç®—æŒ‡ä»¤ï¼Œåˆå¯åˆ†ä¸ºï¼š
  - ä½ç§»æŒ‡ä»¤ï¼šishlã€ishrã€ iushrã€lshlã€lshrã€ lushr
  - æŒ‰ä½æˆ–æŒ‡ä»¤ï¼šiorã€lor
  - æŒ‰ä½ä¸æŒ‡ä»¤ï¼šiandã€land
  - æŒ‰ä½å¼‚æˆ–æŒ‡ä»¤ï¼šixorã€lxor

* æ¯”è¾ƒæŒ‡ä»¤ï¼šdcmpgã€dcmplã€ fcmpgã€fcmplã€lcmp

è¿ç®—æ¨¡å¼ï¼š

* å‘æœ€æ¥è¿‘æ•°èˆå…¥æ¨¡å¼ï¼ŒJVM åœ¨è¿›è¡Œæµ®ç‚¹æ•°è®¡ç®—æ—¶ï¼Œæ‰€æœ‰çš„è¿ç®—ç»“æœéƒ½å¿…é¡»èˆå…¥åˆ°é€‚å½“çš„ç²¾åº¦ï¼Œéç²¾ç¡®ç»“æœå¿…é¡»èˆå…¥ä¸ºå¯è¢«è¡¨ç¤ºçš„æœ€æ¥è¿‘çš„ç²¾ç¡®å€¼ï¼Œå¦‚æœæœ‰ä¸¤ç§å¯è¡¨ç¤ºå½¢å¼ä¸è¯¥å€¼ä¸€æ ·æ¥è¿‘ï¼Œå°†ä¼˜å…ˆé€‰æ‹©æœ€ä½æœ‰æ•ˆä½ä¸ºé›¶çš„
* å‘é›¶èˆå…¥æ¨¡å¼ï¼šå°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°æ—¶ï¼Œè¯¥æ¨¡å¼å°†åœ¨ç›®æ ‡æ•°å€¼ç±»å‹ä¸­é€‰æ‹©ä¸€ä¸ªæœ€æ¥è¿‘ä½†æ˜¯ä¸å¤§äºåŸå€¼çš„æ•°å­—ä½œä¸ºæœ€ç²¾ç¡®çš„èˆå…¥ç»“æœ

NaN å€¼ï¼šå½“ä¸€ä¸ªæ“ä½œäº§ç”Ÿæº¢å‡ºæ—¶ï¼Œå°†ä¼šä½¿ç”¨æœ‰ç¬¦å·çš„æ— ç©·å¤§è¡¨ç¤ºï¼Œå¦‚æœæŸä¸ªæ“ä½œç»“æœæ²¡æœ‰æ˜ç¡®çš„æ•°å­¦å®šä¹‰ï¼Œå°†ä½¿ç”¨ NaN å€¼æ¥è¡¨ç¤º

```java
double j = i / 0.0;
System.out.println(j);//æ— ç©·å¤§ï¼ŒNaN: not a number
```

åˆ†æ i++ï¼šä»å­—èŠ‚ç è§’åº¦åˆ†æï¼ša++ å’Œ ++a çš„åŒºåˆ«æ˜¯å…ˆæ‰§è¡Œ iload è¿˜æ˜¯ å…ˆæ‰§è¡Œ iinc

```java
 4 iload_1		//å­˜å…¥æ“ä½œæ•°æ ˆ
 5 iinc 1 by 1	//è‡ªå¢i++
 8 istore_3		//æŠŠæ“ä½œæ•°æ ˆæ²¡æœ‰è‡ªå¢çš„æ•°æ®çš„å­˜å…¥å±€éƒ¨å˜é‡è¡¨
 9 iinc 2 by 1	//++i
12 iload_2		//åŠ è½½åˆ°æ“ä½œæ•°æ ˆ
13 istore 4		//å­˜å…¥å±€éƒ¨å˜é‡è¡¨ï¼Œè¿™ä¸ªå­˜å…¥æ²¡æœ‰ _ ç¬¦å·ï¼Œ_åªèƒ½åˆ°3
```

```java
public class Demo {
    public static void main(String[] args) {
        int a = 10;
        int b = a++ + ++a + a--;
        System.out.println(a);	//11
        System.out.println(b);	//34
    }
}
```

åˆ¤æ–­ç»“æœï¼š

```java
public class Demo {
    public static void main(String[] args) {
        int i = 0;
        int x = 0;
        while (i < 10) {
            x = x++;
            i++;
        }
        System.out.println(x); // ç»“æœæ˜¯ 0
    }
}
```



***



##### ç±»å‹è½¬æ¢

ç±»å‹è½¬æ¢æŒ‡ä»¤å¯ä»¥å°†ä¸¤ç§ä¸åŒçš„æ•°å€¼ç±»å‹è¿›è¡Œç›¸äº’è½¬æ¢ï¼Œé™¤äº† boolean ä¹‹å¤–çš„ä¸ƒç§ç±»å‹

å®½åŒ–ç±»å‹è½¬æ¢ï¼š

* JVM æ”¯æŒä»¥ä¸‹æ•°å€¼çš„å®½åŒ–ç±»å‹è½¬æ¢ï¼ˆwidening numeric conversionï¼‰ï¼Œå°èŒƒå›´ç±»å‹åˆ°å¤§èŒƒå›´ç±»å‹çš„å®‰å…¨è½¬æ¢
  * ä» int ç±»å‹åˆ° longã€float æˆ–è€… double ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤ä¸º i2lã€i2fã€i2d
  * ä» long ç±»å‹åˆ° floatã€ double ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤ä¸º l2fã€l2d
  * ä» float ç±»å‹åˆ° double ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤ä¸º f2d

* ç²¾åº¦æŸå¤±é—®é¢˜
  * å®½åŒ–ç±»å‹è½¬æ¢æ˜¯ä¸ä¼šå› ä¸ºè¶…è¿‡ç›®æ ‡ç±»å‹æœ€å¤§å€¼è€Œä¸¢å¤±ä¿¡æ¯
  * ä» int è½¬æ¢åˆ° float æˆ–è€… long ç±»å‹è½¬æ¢åˆ° double æ—¶ï¼Œå°†å¯èƒ½å‘ç”Ÿç²¾åº¦ä¸¢å¤±

* ä» byteã€char å’Œ short ç±»å‹åˆ° int ç±»å‹çš„å®½åŒ–ç±»å‹è½¬æ¢å®é™…ä¸Šæ˜¯ä¸å­˜åœ¨çš„ï¼ŒJVM æŠŠå®ƒä»¬å½“ä½œ int å¤„ç†

çª„åŒ–ç±»å‹è½¬æ¢ï¼š

* Java è™šæ‹Ÿæœºç›´æ¥æ”¯æŒä»¥ä¸‹çª„åŒ–ç±»å‹è½¬æ¢ï¼š
  * ä» int ç±»å‹è‡³ byteã€ short æˆ–è€… char ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤æœ‰ i2bã€i2cã€i2s
  * ä» long ç±»å‹åˆ° int ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤æœ‰ l2i
  * ä» float ç±»å‹åˆ° int æˆ–è€… long ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤æœ‰:f2iã€f2l
  * ä» double ç±»å‹åˆ° intã€long æˆ– float è€…ç±»å‹ï¼Œå¯¹åº”çš„æŒ‡ä»¤æœ‰ d2iã€d2ã€d2f

* ç²¾åº¦æŸå¤±é—®é¢˜ï¼š
  * çª„åŒ–ç±»å‹è½¬æ¢å¯èƒ½ä¼šå¯¼è‡´è½¬æ¢ç»“æœå…·å¤‡ä¸åŒçš„æ­£è´Ÿå·ã€ä¸åŒçš„æ•°é‡çº§ï¼Œè½¬æ¢è¿‡ç¨‹å¯èƒ½ä¼šå¯¼è‡´æ•°å€¼ä¸¢å¤±ç²¾åº¦
  * å°†ä¸€ä¸ªæµ®ç‚¹å€¼çª„åŒ–è½¬æ¢ä¸ºæ•´æ•°ç±»å‹ Tï¼ˆT é™äº int æˆ– long ç±»å‹ä¹‹ä¸€ï¼‰æ—¶ï¼Œå°†éµå¾ªä»¥ä¸‹è½¬æ¢è§„åˆ™ï¼š
    - å¦‚æœæµ®ç‚¹å€¼æ˜¯ NaNï¼Œé‚£è½¬æ¢ç»“æœå°±æ˜¯ int æˆ– long ç±»å‹çš„ 0
    - å¦‚æœæµ®ç‚¹å€¼ä¸æ˜¯æ— ç©·å¤§çš„è¯ï¼Œæµ®ç‚¹å€¼ä½¿ç”¨ IEEE 754 çš„å‘é›¶èˆå…¥æ¨¡å¼å–æ•´ï¼Œè·å¾—æ•´æ•°å€¼ vï¼Œå¦‚æœ v åœ¨ç›®æ ‡ç±»å‹ T çš„è¡¨ç¤ºèŒƒå›´ä¹‹å†…ï¼Œé‚£è½¬æ¢ç»“æœå°±æ˜¯ vï¼Œå¦åˆ™å°†æ ¹æ® v çš„ç¬¦å·ï¼Œè½¬æ¢ä¸º T æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§æˆ–è€…æœ€å°æ­£æ•°



***



##### åˆ›å»ºè®¿é—®

åˆ›å»ºæŒ‡ä»¤ï¼š

* åˆ›å»ºç±»å®ä¾‹æŒ‡ä»¤ï¼šnewï¼Œæ¥æ”¶ä¸€ä¸ªæ“ä½œæ•°æŒ‡å‘å¸¸é‡æ± çš„ç´¢å¼•ï¼Œè¡¨ç¤ºè¦åˆ›å»ºçš„ç±»å‹ï¼Œæ‰§è¡Œå®Œæˆåå°†å¯¹è±¡çš„å¼•ç”¨å‹å…¥æ ˆ

  ```java
  0:  new             #2 // class com/jvm/bytecode/Demo
  3:  dup
  4:  invokespecial   #3 // Method "<init>":()V
  ```

  dup æ˜¯å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œéœ€è¦ä¸¤ä»½å¼•ç”¨åŸå› ï¼š

  - ä¸€ä¸ªè¦é…åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• <init>:()V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰
  - ä¸€ä¸ªè¦é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡

* åˆ›å»ºæ•°ç»„çš„æŒ‡ä»¤ï¼šnewarrayã€anewarrayã€multianewarray

  * newarrayï¼šåˆ›å»ºåŸºæœ¬ç±»å‹æ•°ç»„
  * anewarrayï¼šåˆ›å»ºå¼•ç”¨ç±»å‹æ•°ç»„
  * multianewarrayï¼šåˆ›å»ºå¤šç»´æ•°ç»„

å­—æ®µè®¿é—®æŒ‡ä»¤ï¼šå¯¹è±¡åˆ›å»ºåå¯ä»¥é€šè¿‡å¯¹è±¡è®¿é—®æŒ‡ä»¤è·å–å¯¹è±¡å®ä¾‹æˆ–æ•°ç»„å®ä¾‹ä¸­çš„å­—æ®µæˆ–è€…æ•°ç»„å…ƒç´ 

* è®¿é—®ç±»å­—æ®µï¼ˆstaticå­—æ®µï¼Œæˆ–è€…ç§°ä¸ºç±»å˜é‡ï¼‰çš„æŒ‡ä»¤ï¼šgetstaticã€putstatic
* è®¿é—®ç±»å®ä¾‹å­—æ®µï¼ˆéstaticå­—æ®µï¼Œæˆ–è€…ç§°ä¸ºå®ä¾‹å˜é‡ï¼‰çš„æŒ‡ä»¤ï¼šgetfieldã€ putfield

ç±»å‹æ£€æŸ¥æŒ‡ä»¤ï¼šæ£€æŸ¥ç±»å®ä¾‹æˆ–æ•°ç»„ç±»å‹çš„æŒ‡ä»¤

* checkcastï¼šç”¨äºæ£€æŸ¥ç±»å‹å¼ºåˆ¶è½¬æ¢æ˜¯å¦å¯ä»¥è¿›è¡Œï¼Œå¦‚æœå¯ä»¥è¿›è¡Œ checkcast æŒ‡ä»¤ä¸ä¼šæ”¹å˜æ“ä½œæ•°æ ˆï¼Œå¦åˆ™å®ƒä¼šæŠ›å‡º ClassCastException å¼‚å¸¸

* instanceofï¼šåˆ¤æ–­ç»™å®šå¯¹è±¡æ˜¯å¦æ˜¯æŸä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œä¼šå°†åˆ¤æ–­ç»“æœå‹å…¥æ“ä½œæ•°æ ˆ




****



##### æ–¹æ³•æŒ‡ä»¤

æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ï¼šinvokevirtualã€ invokeinterfaceã€invokespecialã€invokestaticã€invokedynamic

**æ–¹æ³•è°ƒç”¨ç« èŠ‚è¯¦è§£**



***



##### æ“ä½œæ•°æ ˆ

JVM æä¾›çš„æ“ä½œæ•°æ ˆç®¡ç†æŒ‡ä»¤ï¼Œå¯ä»¥ç”¨äºç›´æ¥æ“ä½œæ“ä½œæ•°æ ˆçš„æŒ‡ä»¤

* popã€pop2ï¼šå°†ä¸€ä¸ªæˆ–ä¸¤ä¸ªå…ƒç´ ä»æ ˆé¡¶å¼¹å‡ºï¼Œå¹¶ä¸”ç›´æ¥åºŸå¼ƒ
* dupã€dup2ï¼Œdup_x1ã€dup2_x1ï¼Œdup_x2ã€dup2_x2ï¼šå¤åˆ¶æ ˆé¡¶ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ•°å€¼å¹¶é‡æ–°å‹å…¥æ ˆé¡¶

* swapï¼šå°†æ ˆæœ€é¡¶ç«¯çš„ä¸¤ä¸ª slot æ•°å€¼ä½ç½®äº¤æ¢ï¼ŒJVM æ²¡æœ‰æä¾›äº¤æ¢ä¸¤ä¸ª 64 ä½æ•°æ®ç±»å‹æ•°å€¼çš„æŒ‡ä»¤

* nopï¼šä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå­—èŠ‚ç ä¸º 0x00ï¼Œå’Œæ±‡ç¼–è¯­è¨€ä¸­çš„ nop ä¸€æ ·ï¼Œè¡¨ç¤ºä»€ä¹ˆéƒ½ä¸åšï¼Œä¸€èˆ¬å¯ç”¨äºè°ƒè¯•ã€å ä½ç­‰



***



##### æ§åˆ¶è½¬ç§»


æ¯”è¾ƒæŒ‡ä»¤ï¼šæ¯”è¾ƒæ ˆé¡¶ä¸¤ä¸ªå…ƒç´ çš„å¤§å°ï¼Œå¹¶å°†æ¯”è¾ƒç»“æœå…¥æ ˆ

* lcmpï¼šæ¯”è¾ƒä¸¤ä¸ª long ç±»å‹å€¼
* fcmplï¼šæ¯”è¾ƒä¸¤ä¸ª float ç±»å‹å€¼ï¼ˆå½“é‡åˆ°NaNæ—¶ï¼Œè¿”å›-1ï¼‰
* fcmpgï¼šæ¯”è¾ƒä¸¤ä¸ª float ç±»å‹å€¼ï¼ˆå½“é‡åˆ°NaNæ—¶ï¼Œè¿”å›1ï¼‰
* dcmplï¼šæ¯”è¾ƒä¸¤ä¸ª double ç±»å‹å€¼ï¼ˆå½“é‡åˆ°NaNæ—¶ï¼Œè¿”å›-1ï¼‰
* dcmpgï¼šæ¯”è¾ƒä¸¤ä¸ª double ç±»å‹å€¼ï¼ˆå½“é‡åˆ°NaNæ—¶ï¼Œè¿”å›1ï¼‰

æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼š

| æŒ‡ä»¤      | è¯´æ˜                                               |
| --------- | -------------------------------------------------- |
| ifeq      | equalsï¼Œå½“æ ˆé¡¶intç±»å‹æ•°å€¼ç­‰äº0æ—¶è·³è½¬               |
| ifne      | not equalsï¼Œå½“æ ˆé¡¶inç±»å‹æ•°å€¼ä¸ç­‰äº0æ—¶è·³è½¬          |
| iflt      | lower thanï¼Œå½“æ ˆé¡¶inç±»å‹æ•°å€¼å°äº0æ—¶è·³è½¬            |
| ifle      | lower or equalsï¼Œå½“æ ˆé¡¶inç±»å‹æ•°å€¼å°äºç­‰äº0æ—¶è·³è½¬   |
| ifgt      | greater thanï¼Œå½“æ ˆé¡¶intç±»å‹æ•°ç»„å¤§äº0æ—¶è·³è½¬         |
| ifge      | greater or equalsï¼Œå½“æ ˆé¡¶inç±»å‹æ•°å€¼å¤§äºç­‰äº0æ—¶è·³è½¬ |
| ifnull    | ä¸º null æ—¶è·³è½¬                                     |
| ifnonnull | ä¸ä¸º null æ—¶è·³è½¬                                   |

æ¯”è¾ƒæ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼š

| æŒ‡ä»¤      | è¯´æ˜                                                      |
| --------- | --------------------------------------------------------- |
| if_icmpeq | æ¯”è¾ƒæ ˆé¡¶ä¸¤ int ç±»å‹æ•°å€¼å¤§å°ï¼ˆä¸‹åŒï¼‰ï¼Œå½“å‰è€…ç­‰äºåè€…æ—¶è·³è½¬ |
| if_icmpne | å½“å‰è€…ä¸ç­‰äºåè€…æ—¶è·³è½¬                                    |
| if_icmplt | å½“å‰è€…å°äºåè€…æ—¶è·³è½¬                                      |
| if_icmple | å½“å‰è€…å°äºç­‰äºåè€…æ—¶è·³è½¬                                  |
| if_icmpgt | å½“å‰è€…å¤§äºåè€…æ—¶è·³è½¬                                      |
| if_icmpge | å½“å‰è€…å¤§äºç­‰äºåè€…æ—¶è·³è½¬                                  |
| if_acmpeq | å½“ç»“æœç›¸ç­‰æ—¶è·³è½¬                                          |
| if_acmpne | å½“ç»“æœä¸ç›¸ç­‰æ—¶è·³è½¬                                        |

å¤šæ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤ï¼š

* tableswitchï¼šç”¨äº switch æ¡ä»¶è·³è½¬ï¼Œcase å€¼è¿ç»­
* lookupswitchï¼šç”¨äº switch æ¡ä»¶è·³è½¬ï¼Œcase å€¼ä¸è¿ç»­

æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼š

* gotoï¼šç”¨æ¥è¿›è¡Œè·³è½¬åˆ°æŒ‡å®šè¡Œå·çš„å­—èŠ‚ç 

* goto_wï¼šæ— æ¡ä»¶è·³è½¬ï¼ˆå®½ç´¢å¼•ï¼‰





***



##### å¼‚å¸¸å¤„ç†

###### å¤„ç†æœºåˆ¶

æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤ï¼šathrow æŒ‡ä»¤

JVM å¤„ç†å¼‚å¸¸ï¼ˆcatch è¯­å¥ï¼‰ä¸æ˜¯ç”±å­—èŠ‚ç æŒ‡ä»¤æ¥å®ç°çš„ï¼Œè€Œæ˜¯**é‡‡ç”¨å¼‚å¸¸è¡¨æ¥å®Œæˆ**çš„

* ä»£ç ï¼š

  ```java
  public static void main(String[] args) {    
      int i = 0;    
      try {    	
          i = 10;    
      } catch (Exception e) {   
          i = 20;   
      } finally {
          i = 30;
      }
  }
  ```
  
* å­—èŠ‚ç ï¼š

  * å¤šå‡ºä¸€ä¸ª **Exception table** çš„ç»“æ„ï¼Œ[from, to) æ˜¯**å‰é—­åå¼€**çš„æ£€æµ‹èŒƒå›´ï¼Œä¸€æ—¦è¿™ä¸ªèŒƒå›´å†…çš„å­—èŠ‚ç æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œåˆ™é€šè¿‡ type åŒ¹é…å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœä¸€è‡´ï¼Œè¿›å…¥ target æ‰€æŒ‡ç¤ºè¡Œå·
  * 8 è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ astore_2 æ˜¯å°†å¼‚å¸¸å¯¹è±¡å¼•ç”¨å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2 ä½ç½®ï¼Œå› ä¸ºå¼‚å¸¸å‡ºç°æ—¶ï¼Œåªèƒ½è¿›å…¥ Exception table ä¸­ä¸€ä¸ªåˆ†æ”¯ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡è¡¨ slot 2 ä½ç½®è¢«å…±ç”¨

  ```java
      0: 	iconst_0
      1: 	istore_1 	// 0 -> i	->èµ‹å€¼
      2: 	bipush 10 	// try 10 æ”¾å…¥æ“ä½œæ•°æ ˆé¡¶
      4: 	istore_1 	// 10 -> i å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot1
      5: 	bipush 30 	// finally 
      7: 	istore_1 	// 30 -> i 
      8: 	goto 27 	// return -----------------------------------
      11: astore_2 	// catch Exceptin -> e ----------------------
      12: bipush 20 	// 
      14: istore_1 	// 20 -> i 
      15: bipush 30 	// finally 
      17: istore_1 	// 30 -> i 
      18: goto 27 	// return -----------------------------------
      21: astore_3 	// catch any -> slot 3 ----------------------
      22: bipush 30 	// finally 
      24: istore_1 	// 30 -> i 
      25: aload_3 	// å°†å±€éƒ¨å˜é‡è¡¨çš„slot 3æ•°æ®å¼¹å‡ºï¼Œæ”¾å…¥æ“ä½œæ•°æ ˆæ ˆé¡¶
      26: athrow 		// throw æŠ›å‡ºå¼‚å¸¸
      27: return
  Exception table:
  	from   to 	target 	type
  		2	5 		11 	Class java/lang/Exception
  		2 	5 		21 	any // å‰©ä½™çš„å¼‚å¸¸ç±»å‹ï¼Œæ¯”å¦‚ Error
  		11 15 		21 	any // å‰©ä½™çš„å¼‚å¸¸ç±»å‹ï¼Œæ¯”å¦‚ Error
  LineNumberTable: ...
  LocalVariableTable:
  	Start Length Slot Name Signature
  	12 		3 		2 	e 	Ljava/lang/Exception;
  	0 		28 		0 args 	[Ljava/lang/String;
  	2 		26 		1 	i 	I
  ```



***



###### finally

finally ä¸­çš„ä»£ç è¢«**å¤åˆ¶äº† 3 ä»½**ï¼Œåˆ†åˆ«æ”¾å…¥ try æµç¨‹ï¼Œcatch æµç¨‹ä»¥åŠ catch å‰©ä½™çš„å¼‚å¸¸ç±»å‹æµç¨‹ï¼ˆä¸ŠèŠ‚æ¡ˆä¾‹ï¼‰

* ä»£ç ï¼š

  ```java
  public static int test() {
      try {
      	return 10;
      } finally {
      	return 20;
      }
  }
  ```

* å­—èŠ‚ç ï¼š

  ```java
      0: bipush 10 	// 10 æ”¾å…¥æ ˆé¡¶
      2: istore_0 	// 10 -> slot 0 (ä»æ ˆé¡¶ç§»é™¤äº†)
      3: bipush 20 	// 20 æ”¾å…¥æ ˆé¡¶
      5: ireturn 		// è¿”å›æ ˆé¡¶ int(20)
      6: astore_1 	// catch any -> slot 1 å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot1
      7: bipush 20 	// 20 æ”¾å…¥æ ˆé¡¶
      9: ireturn 		// è¿”å›æ ˆé¡¶ int(20)
  Exception table:
  	from   to 	target 	type
  		0	3		6 	any      
  ```



***



###### return

* åå¼‚å¸¸

  ```java
  public static int test() {
      try {
      	return 10;
      } finally {
      	return 20;
      }
  }
  ```

  ```java
      0: bipush 10 	// 10 æ”¾å…¥æ ˆé¡¶
      2: istore_0 	// 10 -> slot 0 (ä»æ ˆé¡¶ç§»é™¤äº†)
      3: bipush 20 	// 20 æ”¾å…¥æ ˆé¡¶
      5: ireturn 		// è¿”å›æ ˆé¡¶ int(20)
      6: astore_1 	// catch any -> slot 1 å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot1
      7: bipush 20 	// 20 æ”¾å…¥æ ˆé¡¶
      9: ireturn 		// è¿”å›æ ˆé¡¶ int(20)
  Exception table:
  	from   to 	target 	type
  		0	3		6 	any      
  ```

  * ç”±äº finally ä¸­çš„ ireturn è¢«æ’å…¥äº†æ‰€æœ‰å¯èƒ½çš„æµç¨‹ï¼Œå› æ­¤è¿”å›ç»“æœè‚¯ finally çš„ä¸ºå‡†
  * å­—èŠ‚ç ä¸­æ²¡æœ‰ **athrow** ï¼Œè¡¨æ˜å¦‚æœåœ¨ finally ä¸­å‡ºç°äº† returnï¼Œä¼š**åæ‰å¼‚å¸¸**

* ä¸åå¼‚å¸¸

  ```java
  public class Demo {
      public static void main(String[] args) {
      	int result = test();
      	System.out.println(result);//10
  	}
  	public static int test() {
          int i = 10;
          try {
              return i;//è¿”å›10
          } finally {
              i = 20;
          }
     	}
  }
  ```
  
  ```java
      0: 	bipush 10 	// 10 æ”¾å…¥æ ˆé¡¶
      2: 	istore_0 	// 10 -> iï¼Œèµ‹å€¼ç»™iï¼Œæ”¾å…¥slot 0
      3: 	iload_0 	// i(10)åŠ è½½è‡³æ“ä½œæ•°æ ˆ
      4: 	istore_1 	// 10 -> slot 1ï¼Œæš‚å­˜è‡³ slot 1ï¼Œç›®çš„æ˜¯ä¸ºäº†å›ºå®šè¿”å›å€¼
      5: 	bipush 20 	// 20 æ”¾å…¥æ ˆé¡¶
      7: 	istore_0 	// 20 -> i
      8: 	iload_1 	// slot 1(10) è½½å…¥ slot 1 æš‚å­˜çš„å€¼
      9: 	ireturn 	// è¿”å›æ ˆé¡¶çš„ int(10)
      10: astore_2	// catch any -> slot 2 å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot2
      11: bipush 20
      13: istore_0
      14: aload_2
      15: athrow		// ä¸ä¼šåæ‰å¼‚å¸¸
  Exception table:
  	from   to 	target 	type
  	  3	   5		10 	any  
  ```



***



##### åŒæ­¥æ§åˆ¶

æ–¹æ³•çº§çš„åŒæ­¥ï¼šæ˜¯éšå¼çš„ï¼Œæ— é¡»é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤æ¥æ§åˆ¶ï¼Œå®ƒå®ç°åœ¨æ–¹æ³•è°ƒç”¨å’Œè¿”å›æ“ä½œä¹‹ä¸­ï¼Œè™šæ‹Ÿæœºå¯ä»¥ä»æ–¹æ³•å¸¸é‡æ± çš„æ–¹æ³•è¡¨ç»“æ„ä¸­çš„ ACC_SYNCHRONIZED è®¿é—®æ ‡å¿—å¾—çŸ¥ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•

æ–¹æ³•å†…æŒ‡å®šæŒ‡ä»¤åºåˆ—çš„åŒæ­¥ï¼šæœ‰ monitorenter å’Œ monitorexit ä¸¤æ¡æŒ‡ä»¤æ¥æ”¯æŒ synchronized å…³é”®å­—çš„è¯­ä¹‰

* montiorenterï¼šè¿›å…¥å¹¶è·å–å¯¹è±¡ç›‘è§†å™¨ï¼Œå³ä¸ºæ ˆé¡¶å¯¹è±¡åŠ é”
* monitorexitï¼šé‡Šæ”¾å¹¶é€€å‡ºå¯¹è±¡ç›‘è§†å™¨ï¼Œå³ä¸ºæ ˆé¡¶å¯¹è±¡è§£é”

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æŒ‡ä»¤åŒæ­¥æ§åˆ¶.png" style="zoom: 33%;" />





***



#### æ‰§è¡Œæµç¨‹

åŸå§‹ Java ä»£ç ï¼š

```java
public class Demo {	
    public static void main(String[] args) {        
        int a = 10;        
        int b = Short.MAX_VALUE + 1;        
        int c = a + b;        
        System.out.println(c);	
    }
}
```

javap -v Demo.classï¼šçœç•¥

* å¸¸é‡æ± è½½å…¥è¿è¡Œæ—¶å¸¸é‡æ± 

* æ–¹æ³•åŒºå­—èŠ‚ç è½½å…¥æ–¹æ³•åŒº

* main çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œåˆ†é…æ ˆå¸§å†…å­˜ï¼šï¼ˆæ“ä½œæ•°æ ˆstack=2ï¼Œå±€éƒ¨å˜é‡è¡¨locals=4ï¼‰

* **æ‰§è¡Œå¼•æ“**å¼€å§‹æ‰§è¡Œå­—èŠ‚ç 

  `bipush 10`ï¼šå°†ä¸€ä¸ª byte å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰ï¼Œç±»ä¼¼çš„æŒ‡ä»¤

  * sipush å°†ä¸€ä¸ª short å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰
  * ldc å°†ä¸€ä¸ª int å‹å…¥æ“ä½œæ•°æ ˆ
  * ldc2_w å°†ä¸€ä¸ª long å‹å…¥æ“ä½œæ•°æ ˆï¼ˆåˆ†ä¸¤æ¬¡å‹å…¥ï¼Œå› ä¸º long æ˜¯ 8 ä¸ªå­—èŠ‚ï¼‰
  * è¿™é‡Œå°çš„æ•°å­—éƒ½æ˜¯å’Œå­—èŠ‚ç æŒ‡ä»¤å­˜åœ¨ä¸€èµ·ï¼Œè¶…è¿‡ short èŒƒå›´çš„æ•°å­—å­˜å…¥äº†å¸¸é‡æ± 

  `istore_1`ï¼šå°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹1.png)

  `ldc #3`ï¼šä»å¸¸é‡æ± åŠ è½½ #3 æ•°æ®åˆ°æ“ä½œæ•°æ ˆ
  Short.MAX_VALUE æ˜¯ 32767ï¼Œæ‰€ä»¥ 32768 = Short.MAX_VALUE + 1 å®é™…æ˜¯åœ¨ç¼–è¯‘æœŸé—´è®¡ç®—å®Œæˆ

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹2.png)

  `istore_2`ï¼šå°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2

  `iload_1`ï¼šå°†å±€éƒ¨å˜é‡è¡¨çš„ slot 1æ•°æ®å¼¹å‡ºï¼Œæ”¾å…¥æ“ä½œæ•°æ ˆæ ˆé¡¶

  `iload_2`ï¼šå°†å±€éƒ¨å˜é‡è¡¨çš„ slot 2æ•°æ®å¼¹å‡ºï¼Œæ”¾å…¥æ“ä½œæ•°æ ˆæ ˆé¡¶

  `iadd`ï¼šæ‰§è¡Œç›¸åŠ æ“ä½œ

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹3.png)

  `istore_3`ï¼šå°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 3

  `getstatic #4`ï¼šè·å–é™æ€å­—æ®µ

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹4.png)

  `iload_3`ï¼š

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹5.png)

  `invokevirtual #5`ï¼š

  * æ‰¾åˆ°å¸¸é‡æ±  #5 é¡¹
  * å®šä½åˆ°æ–¹æ³•åŒº java/io/PrintStream.println:(I)V æ–¹æ³•
  * **ç”Ÿæˆæ–°çš„æ ˆå¸§**ï¼ˆåˆ†é… localsã€stackç­‰ï¼‰
  * ä¼ é€’å‚æ•°ï¼Œæ‰§è¡Œæ–°æ ˆå¸§ä¸­çš„å­—èŠ‚ç 
  * æ‰§è¡Œå®Œæ¯•ï¼Œå¼¹å‡ºæ ˆå¸§
  * æ¸…é™¤ main æ“ä½œæ•°æ ˆå†…å®¹

  ![](https://gitee.com/seazean/images/raw/master/Java/JVM-å­—èŠ‚ç æ‰§è¡Œæµç¨‹6.png)

  returnï¼šå®Œæˆ main æ–¹æ³•è°ƒç”¨ï¼Œå¼¹å‡º main æ ˆå¸§ï¼Œç¨‹åºç»“æŸ

  



***



### æ‰§è¡Œå¼•æ“

#### åŸºæœ¬ä»‹ç»

æ‰§è¡Œå¼•æ“ï¼šJavaè™šæ‹Ÿæœºçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ä¹‹ä¸€ï¼ŒJVMçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œéœ€è¦æ‰§è¡Œå¼•æ“å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Š/ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤

è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç›¸å¯¹äºç‰©ç†æœºçš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼š

* ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¼“å­˜ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Š
* è™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦åœ°å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»

Java æ˜¯**åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€**ï¼Œå°†è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œï¼š

* è§£é‡Šå™¨ï¼šæ ¹æ®é¢„å®šä¹‰çš„è§„èŒƒå¯¹å­—èŠ‚ç é‡‡ç”¨é€è¡Œè§£é‡Šçš„æ–¹å¼æ‰§è¡Œï¼Œå°†æ¯æ¡å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œ
* å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT : Just In Time Compilerï¼‰ï¼šè™šæ‹Ÿæœºè¿è¡Œæ—¶å°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆ**å’Œæœ¬åœ°æœºå™¨å¹³å°ç›¸å…³çš„æœºå™¨ç **åå†æ‰§è¡Œï¼Œå¹¶å­˜å…¥ Code Cacheï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ç›´æ¥æ‰§è¡Œï¼Œæ•ˆç‡é«˜



***



#### æ‰§è¡Œæ–¹å¼

HotSpot VM é‡‡ç”¨**è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„**ï¼Œè§£é‡Šå™¨å’Œå³æ—¶ç¼–è¯‘å™¨èƒ½å¤Ÿç›¸äº’åä½œï¼Œå»é€‰æ‹©æœ€åˆé€‚çš„æ–¹å¼æ¥æƒè¡¡ç¼–è¯‘æœ¬åœ°ä»£ç å’Œç›´æ¥è§£é‡Šæ‰§è¡Œä»£ç çš„æ—¶é—´

HostSpot JVMçš„é»˜è®¤æ‰§è¡Œæ–¹å¼ï¼š

* å½“ç¨‹åºå¯åŠ¨åï¼Œè§£é‡Šå™¨å¯ä»¥é©¬ä¸Šå‘æŒ¥ä½œç”¨ç«‹å³æ‰§è¡Œï¼Œçœå»ç¼–è¯‘å™¨ç¼–è¯‘çš„æ—¶é—´ï¼ˆè§£é‡Šå™¨å­˜åœ¨çš„**å¿…è¦æ€§**ï¼‰
* éšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„æ¨ç§»ï¼Œå³æ—¶ç¼–è¯‘å™¨é€æ¸å‘æŒ¥ä½œç”¨ï¼Œæ ¹æ®çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ï¼Œå°†æœ‰ä»·å€¼çš„å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ¢å–æ›´é«˜çš„ç¨‹åºæ‰§è¡Œæ•ˆç‡

HotSpot VM å¯ä»¥é€šè¿‡ VM å‚æ•°è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹å¼ï¼š

- -Xintï¼šå®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åº
- -Xcompï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚å¦‚æœå³æ—¶ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œ
- -Xmixedï¼šé‡‡ç”¨è§£é‡Šå™¨ + å³æ—¶ç¼–è¯‘å™¨çš„æ··åˆæ¨¡å¼å…±åŒæ‰§è¡Œç¨‹åº

![](https://gitee.com/seazean/images/raw/master/Java/JVM-æ‰§è¡Œå¼•æ“å·¥ä½œæµç¨‹.png)



***



#### çƒ­ç‚¹æ¢æµ‹

çƒ­ç‚¹ä»£ç ï¼šè¢« JIT ç¼–è¯‘å™¨ç¼–è¯‘çš„å­—èŠ‚ç ï¼Œæ ¹æ®ä»£ç è¢«è°ƒç”¨æ‰§è¡Œçš„é¢‘ç‡è€Œå®š

* ä¸€ä¸ªè¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•æˆ–è€…ä¸€ä¸ªå¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¹‹ä¸ºçƒ­ç‚¹ä»£ç 
* è¿™ç§ç¼–è¯‘æ–¹å¼å‘ç”Ÿåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¹Ÿç§°ä¸ºæ ˆä¸Šæ›¿æ¢ï¼Œç®€ç§° **OSR (On StackReplacement) ç¼–è¯‘**

OSR æ›¿æ¢å¾ªç¯ä»£ç ä½“çš„å…¥å£ï¼ŒC1ã€C2 æ›¿æ¢çš„æ˜¯æ–¹æ³•è°ƒç”¨çš„å…¥å£ï¼ŒOSR ç¼–è¯‘åä¼šå‡ºç°æ–¹æ³•çš„æ•´æ®µä»£ç è¢«ç¼–è¯‘äº†ï¼Œä½†æ˜¯åªæœ‰å¾ªç¯ä½“éƒ¨åˆ†æ‰æ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç ï¼Œå…¶ä»–éƒ¨åˆ†ä»æ˜¯è§£é‡Šæ‰§è¡Œ

çƒ­ç‚¹æ¢æµ‹ï¼šJIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ä¼šé’ˆçƒ­ç‚¹ä»£ç åšå‡ºæ·±åº¦ä¼˜åŒ–ï¼Œå°†å…¶ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤è¿›è¡Œç¼“å­˜ï¼Œä»¥æå‡ Java ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½

CodeCache ç”¨äºç¼“å­˜ç¼–è¯‘åçš„æœºå™¨ç ã€åŠ¨æ€ç”Ÿæˆçš„ä»£ç å’Œæœ¬åœ°æ–¹æ³•ä»£ç  JNIï¼Œå¦‚æœ CodeCache åŒºåŸŸè¢«å æ»¡ï¼Œç¼–è¯‘å™¨è¢«åœç”¨ï¼Œå­—èŠ‚ç å°†ä¸ä¼šç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œåº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œï¼Œä½†è¿è¡Œé€Ÿåº¦ä¼šé™ä½ä¸€ä¸ªæ•°é‡çº§ï¼Œä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½

HotSpot VM é‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼Œä¸ºæ¯ä¸€ä¸ªæ–¹æ³•éƒ½å»ºç«‹ 2 ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼šæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰å’Œå›è¾¹è®¡æ•°å™¨ï¼ˆBackEdge Counterï¼‰

* æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼šç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œé»˜è®¤é˜ˆå€¼åœ¨ Client æ¨¡å¼ ä¸‹æ˜¯ 1500 æ¬¡ï¼Œåœ¨ Server æ¨¡å¼ä¸‹æ˜¯10000 æ¬¡ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘ JIT ç¼–è¯‘ï¼Œé˜ˆå€¼å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•° `-XX:CompileThreshold` è®¾ç½®

  å·¥ä½œæµç¨‹ï¼šå½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œ ä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢« JIT ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œå­˜åœ¨åˆ™ä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ¥æ‰§è¡Œï¼›å¦‚æœä¸å­˜åœ¨åˆ™å°†æ­¤æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å€¼åŠ  1ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ä¸å›è¾¹è®¡æ•°å™¨å€¼ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜ˆå€¼ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼ä¼šå‘å³æ—¶ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚

* å›è¾¹è®¡æ•°å™¨ï¼šç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸ºå›è¾¹



***



#### åˆ†å±‚ç¼–è¯‘

HotSpot VM å†…åµŒä¸¤ä¸ª JIT ç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸º Client Compiler å’Œ Server Compilerï¼Œç®€ç§° C1 ç¼–è¯‘å™¨å’Œ C2 ç¼–è¯‘å™¨

C1 ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ï¼Œä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ï¼ŒC1 ç¼–è¯‘å™¨çš„ä¼˜åŒ–æ–¹æ³•ï¼š

* æ–¹æ³•å†…è”ï¼š**å°†å¼•ç”¨çš„å‡½æ•°ä»£ç ç¼–è¯‘åˆ°å¼•ç”¨ç‚¹å¤„**ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ ˆå¸§çš„ç”Ÿæˆï¼Œå‡å°‘å‚æ•°ä¼ é€’ä»¥åŠè·³è½¬è¿‡ç¨‹

  æ–¹æ³•å†…è”èƒ½å¤Ÿæ¶ˆé™¤æ–¹æ³•è°ƒç”¨çš„å›ºå®šå¼€é”€ï¼Œä»»ä½•æ–¹æ³•é™¤éè¢«å†…è”ï¼Œå¦åˆ™è°ƒç”¨éƒ½ä¼šæœ‰å›ºå®šå¼€é”€ï¼Œæ¥æºäºä¿å­˜ç¨‹åºåœ¨è¯¥æ–¹æ³•ä¸­çš„æ‰§è¡Œä½ç½®ï¼Œä»¥åŠæ–°å»ºã€å‹å…¥å’Œå¼¹å‡ºæ–°æ–¹æ³•æ‰€ä½¿ç”¨çš„æ ˆå¸§ã€‚

  ```java
  private static int square(final int i) {
  	return i * i;
  }
  System.out.println(square(9));
  ```

  square æ˜¯çƒ­ç‚¹æ–¹æ³•ï¼Œä¼šè¿›è¡Œå†…è”ï¼ŒæŠŠæ–¹æ³•å†…ä»£ç æ‹·è´ç²˜è´´åˆ°è°ƒç”¨è€…çš„ä½ç½®ï¼š

  ```java
  System.out.println(9 * 9);
  ```

  è¿˜èƒ½å¤Ÿè¿›è¡Œå¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰çš„ä¼˜åŒ–ï¼š

  ```java
  System.out.println(81);
  ```

* å†—ä½™æ¶ˆé™¤ï¼šæ ¹æ®è¿è¡Œæ—¶çŠ¶å†µè¿›è¡Œä»£ç æŠ˜å æˆ–å‰Šé™¤

* å†…è”ç¼“å­˜ï¼šæ˜¯ä¸€ç§åŠ å¿«åŠ¨æ€ç»‘å®šçš„ä¼˜åŒ–æŠ€æœ¯ï¼ˆæ–¹æ³•è°ƒç”¨éƒ¨åˆ†è¯¦è§£ï¼‰

C2 ç¼–è¯‘å™¨è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ä»¥åŠæ¿€è¿›ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼Œå½“æ¿€è¿›ä¼˜åŒ–çš„å‡è®¾ä¸æˆç«‹æ—¶ï¼Œå†é€€å›ä½¿ç”¨ C1 ç¼–è¯‘ã€‚C2 çš„ä¼˜åŒ–ä¸»è¦æ˜¯åœ¨å…¨å±€å±‚é¢ï¼Œé€ƒé€¸åˆ†ææ˜¯ä¼˜åŒ–çš„åŸºç¡€ï¼šæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€åŒæ­¥æ¶ˆé™¤

VM å‚æ•°è®¾ç½®ï¼š

- -clientï¼šæŒ‡å®š Java è™šæ‹Ÿæœºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ C1 ç¼–è¯‘å™¨
- -serverï¼šæŒ‡å®š Java è™šæ‹Ÿæœºè¿è¡Œåœ¨ Server æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ C2 ç¼–è¯‘å™¨
- `-server -XX:+TieredCompilation`ï¼šåœ¨ 1.8 ä¹‹å‰ï¼Œåˆ†å±‚ç¼–è¯‘é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥æ·»åŠ è¯¥å‚æ•°å¼€å¯

åˆ†å±‚ç¼–è¯‘ç­–ç•¥ (Tiered Compilation)ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œå¯ä»¥è§¦å‘ C1 ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼ŒåŠ ä¸Šæ€§èƒ½ç›‘æ§ï¼ŒC2 ç¼–è¯‘ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ï¼ŒJVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

* 0 å±‚ï¼Œè§£é‡Šæ‰§è¡Œï¼ˆInterpreterï¼‰

* 1 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ profilingï¼‰

* 2 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„ profilingï¼‰

* 3 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„ profilingï¼‰

* 4 å±‚ï¼Œä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆC1 å’Œ C2 åä½œè¿è¡Œï¼‰

  è¯´æ˜ï¼šprofiling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ï¼Œå¾ªç¯çš„å›è¾¹æ¬¡æ•°ç­‰



***



### æ–¹æ³•è°ƒç”¨

#### æ–¹æ³•è¯†åˆ«

Java è™šæ‹Ÿæœºè¯†åˆ«æ–¹æ³•çš„å…³é”®åœ¨äºç±»åã€æ–¹æ³•åä»¥åŠæ–¹æ³•æè¿°ç¬¦ï¼ˆmethod descriptorï¼‰

* æ–¹æ³•æè¿°ç¬¦æ˜¯ç”±æ–¹æ³•çš„å‚æ•°ç±»å‹ä»¥åŠè¿”å›ç±»å‹æ‰€æ„æˆï¼Œä¹Ÿå«æ–¹æ³•ç‰¹å¾ç­¾å
* åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œå¦‚æœåŒæ—¶å‡ºç°å¤šä¸ªåå­—ç›¸åŒä¸”æè¿°ç¬¦ä¹Ÿç›¸åŒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºä¼šåœ¨ç±»çš„éªŒè¯é˜¶æ®µæŠ¥é”™

JVM æ ¹æ®åå­—å’Œæè¿°ç¬¦æ¥åˆ¤æ–­çš„ï¼Œåªè¦è¿”å›å€¼ä¸ä¸€æ ·ï¼Œå…¶å®ƒå®Œå…¨ä¸€æ ·ï¼Œåœ¨ JVM ä¸­æ˜¯å…è®¸çš„ï¼Œä½† Java è¯­è¨€ä¸å…è®¸

```java
// è¿”å›å€¼ç±»å‹ä¸åŒï¼Œç¼–è¯‘é˜¶æ®µç›´æ¥æŠ¥é”™
public static Integer invoke(Object... args) {
    return 1;
}
public static int invoke(Object... args) {
    return 2;
}
```



***



#### è°ƒç”¨æœºåˆ¶

æ–¹æ³•è°ƒç”¨å¹¶ä¸ç­‰äºæ–¹æ³•æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨é˜¶æ®µå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šè¢«è°ƒç”¨æ–¹æ³•çš„ç‰ˆæœ¬ï¼Œä¸æ˜¯æ–¹æ³•çš„å…·ä½“è¿è¡Œè¿‡ç¨‹

åœ¨ JVM ä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨æœ‰ä¸¤ç§æœºåˆ¶ï¼š

- é™æ€é“¾æ¥ï¼šå½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿› JVM å†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜ï¼Œå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥ï¼ˆç±»åŠ è½½çš„è§£æé˜¶æ®µï¼‰
- åŠ¨æ€é“¾æ¥ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤è¢«ç§°ä¸ºåŠ¨æ€é“¾æ¥ï¼ˆåˆå§‹åŒ–åçš„è§£æé˜¶æ®µï¼‰

å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šï¼ˆåˆ†é…ï¼‰æœºåˆ¶ä¸ºï¼šé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»ä»ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œä»…å‘ç”Ÿä¸€æ¬¡ï¼š

- é™æ€ç»‘å®šï¼šè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜ï¼Œå°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®š
- åŠ¨æ€ç»‘å®šï¼šè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•ç¡®å®šï¼Œåªèƒ½åœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•

* Java ç¼–è¯‘å™¨å·²ç»åŒºåˆ†äº†é‡è½½çš„æ–¹æ³•ï¼ˆé™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šï¼‰ï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºè™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨é‡è½½

éè™šæ–¹æ³•ï¼š

- éè™šæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„
- é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•
- æ‰€æœ‰æ™®é€šæˆå‘˜æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ã€è¢«é‡å†™çš„æ–¹æ³•éƒ½æ˜¯è™šæ–¹æ³•

åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€ï¼š

- åœ¨äºå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹åˆ™æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€

- é™æ€è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯

- **Java æ˜¯é™æ€ç±»å‹è¯­è¨€**ï¼ˆå°½ç®¡ lambda è¡¨è¾¾å¼ä¸ºå…¶å¢åŠ äº†åŠ¨æ€ç‰¹æ€§ï¼‰ï¼Œjsï¼Œpythonæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€

  ```java
  String s = "abc";   //Java
  info = "abc";       //Python
  ```



***



#### è°ƒç”¨æŒ‡ä»¤

##### äº”ç§æŒ‡ä»¤

æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š

- invokestaticï¼šè°ƒç”¨é™æ€æ–¹æ³•
- invokespecialï¼šè°ƒç”¨ç§æœ‰å®ä¾‹æ–¹æ³•ã€æ„é€ å™¨ï¼Œå’Œçˆ¶ç±»çš„å®ä¾‹æ–¹æ³•æˆ–æ„é€ å™¨ï¼Œä»¥åŠæ‰€å®ç°æ¥å£çš„é»˜è®¤æ–¹æ³•
- invokevirtualï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•ï¼ˆè™šæ–¹æ³•åˆ†æ´¾ï¼‰
- invokeinterfaceï¼šè°ƒç”¨æ¥å£æ–¹æ³•

åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š

- invokedynamicï¼šåŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œ
  - Java7 ä¸ºäº†å®ç°åŠ¨æ€ç±»å‹è¯­è¨€æ”¯æŒè€Œå¼•å…¥äº†è¯¥æŒ‡ä»¤ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æä¾›ç›´æ¥ç”Ÿæˆ invokedynamic æŒ‡ä»¤çš„æ–¹æ³•ï¼Œéœ€è¦å€ŸåŠ© ASM è¿™ç§åº•å±‚å­—èŠ‚ç å·¥å…·æ¥äº§ç”Ÿ invokedynamic æŒ‡ä»¤
  - Java8 çš„ lambda è¡¨è¾¾å¼çš„å‡ºç°ï¼Œinvokedynamic æŒ‡ä»¤åœ¨ Java ä¸­æ‰æœ‰äº†ç›´æ¥ç”Ÿæˆæ–¹å¼

æŒ‡ä»¤å¯¹æ¯”ï¼š

- æ™®é€šè°ƒç”¨æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯å¹²é¢„ï¼Œæ ¹æ®æ–¹æ³•çš„ç¬¦å·å¼•ç”¨é“¾æ¥åˆ°å…·ä½“çš„ç›®æ ‡æ–¹æ³•
- åŠ¨æ€è°ƒç”¨æŒ‡ä»¤æ”¯æŒç”¨æˆ·ç¡®å®šæ–¹æ³•
- invokestatic å’Œ invokespecial æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼Œè™šæ‹Ÿæœºèƒ½å¤Ÿç›´æ¥è¯†åˆ«å…·ä½“çš„ç›®æ ‡æ–¹æ³•
- invokevirtual å’Œ invokeinterface æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ï¼Œè™šæ‹Ÿæœºéœ€è¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ ¹æ®è°ƒç”¨è€…çš„åŠ¨æ€ç±»å‹æ¥ç¡®å®šç›®æ ‡æ–¹æ³•

æŒ‡ä»¤è¯´æ˜ï¼š

- å¦‚æœè™šæ‹Ÿæœºèƒ½å¤Ÿç¡®å®šç›®æ ‡æ–¹æ³•æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªï¼Œæ¯”å¦‚è¯´ç›®æ ‡æ–¹æ³•è¢«æ ‡è®°ä¸º finalï¼Œé‚£ä¹ˆå¯ä»¥ä¸é€šè¿‡åŠ¨æ€ç±»å‹ï¼Œç›´æ¥ç¡®å®šç›®æ ‡æ–¹æ³•
- æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äº**åŠ¨æ€ç»‘å®š**ï¼Œå³æ”¯æŒå¤šæ€



***



##### ç¬¦å·å¼•ç”¨

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè™šæ‹Ÿæœºå¹¶ä¸çŸ¥é“ç›®æ ‡æ–¹æ³•çš„å…·ä½“å†…å­˜åœ°å€ï¼ŒJava ç¼–è¯‘å™¨ä¼šæš‚æ—¶ç”¨ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºè¯¥ç›®æ ‡æ–¹æ³•ï¼Œè¿™ä¸€ç¬¦å·å¼•ç”¨åŒ…æ‹¬ç›®æ ‡æ–¹æ³•æ‰€åœ¨çš„ç±»æˆ–æ¥å£çš„åå­—ï¼Œä»¥åŠç›®æ ‡æ–¹æ³•çš„æ–¹æ³•åå’Œæ–¹æ³•æè¿°ç¬¦

* å¯¹äºé™æ€ç»‘å®šçš„æ–¹æ³•è°ƒç”¨è€Œè¨€ï¼Œå®é™…å¼•ç”¨æ˜¯ä¸€ä¸ªæŒ‡å‘æ–¹æ³•çš„æŒ‡é’ˆ
* å¯¹äºéœ€è¦åŠ¨æ€ç»‘å®šçš„æ–¹æ³•è°ƒç”¨è€Œè¨€ï¼Œå®é™…å¼•ç”¨åˆ™æ˜¯ä¸€ä¸ªæ–¹æ³•è¡¨çš„ç´¢å¼•

ç¬¦å·å¼•ç”¨å­˜å‚¨åœ¨æ–¹æ³•åŒºå¸¸é‡æ± ä¸­ï¼Œæ ¹æ®ç›®æ ‡æ–¹æ³•æ˜¯å¦ä¸ºæ¥å£æ–¹æ³•ï¼Œåˆ†ä¸ºæ¥å£ç¬¦å·å¼•ç”¨å’Œéæ¥å£ç¬¦å·å¼•ç”¨ï¼š

```java
Constant pool:
...
  #16 = InterfaceMethodref #27.#29	// æ¥å£
...
  #22 = Methodref          #1.#33	// éæ¥å£
...
```

å¯¹äºéæ¥å£ç¬¦å·å¼•ç”¨ï¼Œå‡å®šè¯¥ç¬¦å·å¼•ç”¨æ‰€æŒ‡å‘çš„ç±»ä¸º Cï¼Œåˆ™ Java è™šæ‹Ÿæœºä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡ŒæŸ¥æ‰¾ï¼š

1. åœ¨ C ä¸­æŸ¥æ‰¾ç¬¦åˆåå­—åŠæè¿°ç¬¦çš„æ–¹æ³•
2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåœ¨ C çš„çˆ¶ç±»ä¸­ç»§ç»­æœç´¢ï¼Œç›´è‡³ Object ç±»
3. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåœ¨ C æ‰€ç›´æ¥å®ç°æˆ–é—´æ¥å®ç°çš„æ¥å£ä¸­æœç´¢ï¼Œè¿™ä¸€æ­¥æœç´¢å¾—åˆ°çš„ç›®æ ‡æ–¹æ³•å¿…é¡»æ˜¯éç§æœ‰ã€éé™æ€çš„ã€‚å¦‚æœæœ‰å¤šä¸ªç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•ï¼Œåˆ™ä»»æ„è¿”å›å…¶ä¸­ä¸€ä¸ª

å¯¹äºæ¥å£ç¬¦å·å¼•ç”¨ï¼Œå‡å®šè¯¥ç¬¦å·å¼•ç”¨æ‰€æŒ‡å‘çš„æ¥å£ä¸º Iï¼Œåˆ™ Java è™šæ‹Ÿæœºä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡ŒæŸ¥æ‰¾ï¼š

1. åœ¨ I ä¸­æŸ¥æ‰¾ç¬¦åˆåå­—åŠæè¿°ç¬¦çš„æ–¹æ³•
2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåœ¨ Object ç±»ä¸­çš„å…¬æœ‰å®ä¾‹æ–¹æ³•ä¸­æœç´¢
3. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™åœ¨ I çš„è¶…æ¥å£ä¸­æœç´¢ï¼Œè¿™ä¸€æ­¥çš„æœç´¢ç»“æœçš„è¦æ±‚ä¸éæ¥å£ç¬¦å·å¼•ç”¨æ­¥éª¤ 3 çš„è¦æ±‚ä¸€è‡´



***



##### æ‰§è¡Œæµç¨‹

```java
public class Demo {
    public Demo() { }
    private void test1() { }
    private final void test2() { }

    public void test3() { }
    public static void test4() { }

    public static void main(String[] args) {
        Demo3_9 d = new Demo3_9();
        d.test1();
        d.test2();
        d.test3();
        d.test4();
        Demo.test4();
    }
}
```

å‡ ç§ä¸åŒçš„æ–¹æ³•è°ƒç”¨å¯¹åº”çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
0:  new             #2 // class cn/jvm/t3/bytecode/Demo
3:  dup
4:  invokespecial   #3 // Method "<init>":()V
7:  astore_1
8:  aload_1
9:  invokespecial   #4 // Method test1:()V
12: aload_1
13: invokespecial   #5 // Method test2:()V
16: aload_1
17: invokevirtual   #6 // Method test3:()V
20: aload_1
21: pop
22: invokestatic    #7 // Method test4:()V
25: invokestatic    #7 // Method test4:()V
28: return
```

- invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• <init>:()V 

- `d.test4()` æ˜¯é€šè¿‡**å¯¹è±¡å¼•ç”¨**è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œåœ¨è°ƒç”¨ invokestatic ä¹‹å‰æ‰§è¡Œäº† pop æŒ‡ä»¤ï¼ŒæŠŠå¯¹è±¡å¼•ç”¨ä»æ“ä½œæ•°æ ˆå¼¹æ‰
  - ä¸å»ºè®®ä½¿ç”¨ `å¯¹è±¡.é™æ€æ–¹æ³•()` çš„æ–¹å¼è°ƒç”¨é™æ€æ–¹æ³•ï¼Œå¤šäº†aload å’Œ pop æŒ‡ä»¤
  - æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„åŒºåˆ«æ˜¯ï¼šæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦å¯¹è±¡å¼•ç”¨



***



#### å¤šæ€åŸç†

##### æ‰§è¡ŒåŸç†

Java è™šæ‹Ÿæœºä¸­å…³äºæ–¹æ³•é‡å†™çš„åˆ¤å®šåŸºäºæ–¹æ³•æè¿°ç¬¦ï¼Œå¦‚æœå­ç±»å®šä¹‰äº†ä¸çˆ¶ç±»ä¸­éç§æœ‰ã€éé™æ€æ–¹æ³•åŒåçš„æ–¹æ³•ï¼Œåªæœ‰å½“è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹ä»¥åŠè¿”å›ç±»å‹ä¸€è‡´ï¼ŒJava è™šæ‹Ÿæœºæ‰ä¼šåˆ¤å®šä¸ºé‡å†™ã€‚

**ç†è§£å¤šæ€**ï¼š

- å¤šæ€æœ‰ç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€ï¼Œå³é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®š
- å‰è€…æ˜¯é€šè¿‡æ–¹æ³•é‡è½½å®ç°ï¼Œåè€…æ˜¯é€šè¿‡é‡å†™å®ç°ï¼ˆå­ç±»è¦†ç›–çˆ¶ç±»æ–¹æ³•ï¼Œè™šæ–¹æ³•è¡¨ï¼‰
- è™šæ–¹æ³•ï¼šè¿è¡Œæ—¶åŠ¨æ€ç»‘å®šçš„æ–¹æ³•ï¼Œå¯¹æ¯”é™æ€ç»‘å®šçš„éè™šæ–¹æ³•è°ƒç”¨æ¥è¯´ï¼Œè™šæ–¹æ³•è°ƒç”¨æ›´åŠ è€—æ—¶

æ–¹æ³•é‡å†™çš„æœ¬è´¨ï¼š

1. æ‰¾åˆ°æ“ä½œæ•°æ ˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°ä½œ C

2. å¦‚æœåœ¨ç±»å‹ C ä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦å’Œåç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å› java.lang.IllegalAccessError å¼‚å¸¸

   IllegalAccessErrorï¼šè¡¨ç¤ºç¨‹åºè¯•å›¾è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªå±æ€§æˆ–è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå±æ€§æˆ–æ–¹æ³•æ²¡æœ‰æƒé™è®¿é—®ï¼Œä¸€èˆ¬ä¼šå¼•èµ·ç¼–è¯‘å™¨å¼‚å¸¸ã€‚å¦‚æœè¿™ä¸ªé”™è¯¯å‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œå°±è¯´æ˜ä¸€ä¸ªç±»å‘ç”Ÿäº†ä¸å…¼å®¹çš„æ”¹å˜

3. æ‰¾ä¸åˆ°ï¼Œå°±ä¼šæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹ C çš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬äºŒæ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹

4. å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º java.lang.AbstractMethodError å¼‚å¸¸



***



##### è™šæ–¹æ³•è¡¨

åœ¨è™šæ‹Ÿæœºå·¥ä½œè¿‡ç¨‹ä¸­ä¼šé¢‘ç¹ä½¿ç”¨åˆ°åŠ¨æ€åˆ†é…ï¼Œæ¯æ¬¡åŠ¨æ€åˆ†é…çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚ç›®æ ‡ï¼Œå½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒJVM é‡‡å–äº†ä¸€ç§ç”¨**ç©ºé—´æ¢å–æ—¶é—´**çš„ç­–ç•¥æ¥å®ç°åŠ¨æ€ç»‘å®šï¼Œåœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼ˆvirtual method tableï¼‰ï¼Œå®ç°ä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ï¼Œå¯ä»¥å¿«é€Ÿå®šä½ç›®æ ‡æ–¹æ³•

* invokevirtual æ‰€ä½¿ç”¨çš„è™šæ–¹æ³•è¡¨ï¼ˆvirtual method tableï¼Œvtableï¼‰ï¼Œæ‰§è¡Œæµç¨‹
  1. å…ˆé€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨æ‰¾åˆ°å¯¹è±¡ï¼Œåˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡çš„å®é™… Class
  2. Class ç»“æ„ä¸­æœ‰ vtableï¼ŒæŸ¥è¡¨å¾—åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€ï¼Œæ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 
* invokeinterface æ‰€ä½¿ç”¨çš„æ¥å£æ–¹æ³•è¡¨ï¼ˆinterface method tableï¼Œitableï¼‰

è™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼Œjvmä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•

è™šæ–¹æ³•è¡¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

* å¯¹äºé™æ€ç»‘å®šçš„æ–¹æ³•è°ƒç”¨è€Œè¨€ï¼Œå®é™…å¼•ç”¨å°†æŒ‡å‘å…·ä½“çš„ç›®æ ‡æ–¹æ³•
* å¯¹äºåŠ¨æ€ç»‘å®šçš„æ–¹æ³•è°ƒç”¨è€Œè¨€ï¼Œå®é™…å¼•ç”¨åˆ™æ˜¯æ–¹æ³•è¡¨çš„ç´¢å¼•å€¼ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•çš„é—´æ¥åœ°å€ã€‚Java è™šæ‹Ÿæœºè·å–è°ƒç”¨è€…çš„å®é™…ç±»å‹ï¼Œå¹¶åœ¨è¯¥å®é™…ç±»å‹çš„è™šæ–¹æ³•è¡¨ä¸­ï¼Œæ ¹æ®ç´¢å¼•å€¼è·å¾—ç›®æ ‡æ–¹æ³•å†…å­˜åç§»é‡ï¼ˆæŒ‡é’ˆï¼‰

ä¸ºäº†ä¼˜åŒ–å¯¹è±¡è°ƒç”¨æ–¹æ³•çš„é€Ÿåº¦ï¼Œæ–¹æ³•åŒºçš„ç±»å‹ä¿¡æ¯ä¼šå¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªè®°å½•è¯¥ç±»æ–¹æ³•çš„æ–¹æ³•è¡¨ã€‚æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ æŒ‡å‘ä¸€ä¸ªå½“å‰ç±»åŠå…¶ç¥–å…ˆç±»ä¸­éç§æœ‰çš„å®ä¾‹æ–¹æ³•

æ–¹æ³•è¡¨æ»¡è¶³ä¸¤ä¸ªç‰¹è´¨ï¼š

* å…¶ä¸€ï¼Œå­ç±»æ–¹æ³•è¡¨ä¸­åŒ…å«çˆ¶ç±»æ–¹æ³•è¡¨ä¸­çš„æ‰€æœ‰æ–¹æ³•
* å…¶äºŒï¼Œå­ç±»æ–¹æ³•åœ¨æ–¹æ³•è¡¨ä¸­çš„ç´¢å¼•å€¼ï¼Œä¸å®ƒæ‰€é‡å†™çš„çˆ¶ç±»æ–¹æ³•çš„ç´¢å¼•å€¼ç›¸åŒ

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æ–¹æ³•è°ƒç”¨è™šæ–¹æ³•è¡¨.png" style="zoom: 80%;" />

Passenger ç±»çš„æ–¹æ³•è¡¨åŒ…æ‹¬ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº” 0 å·å’Œ 1 å·ã€‚æ–¹æ³•è¡¨è°ƒæ¢äº† toString æ–¹æ³•å’Œ passThroughImmigration æ–¹æ³•çš„ä½ç½®ï¼Œæ˜¯å› ä¸º toString æ–¹æ³•çš„ç´¢å¼•å€¼éœ€è¦ä¸ Object ç±»ä¸­åŒåæ–¹æ³•çš„ç´¢å¼•å€¼ä¸€è‡´ï¼Œä¸ºäº†ä¿æŒç®€æ´ï¼Œè¿™é‡Œä¸è€ƒè™‘ Object ç±»ä¸­çš„å…¶ä»–æ–¹æ³•ã€‚

è™šæ–¹æ³•è¡¨å¯¹æ€§èƒ½çš„å½±å“ï¼š

* ä½¿ç”¨äº†æ–¹æ³•è¡¨çš„åŠ¨æ€ç»‘å®šä¸é™æ€ç»‘å®šç›¸æ¯”ï¼Œä»…ä»…å¤šå‡ºå‡ ä¸ªå†…å­˜è§£å¼•ç”¨æ“ä½œï¼šè®¿é—®æ ˆä¸Šçš„è°ƒç”¨è€…ã€è¯»å–è°ƒç”¨è€…çš„åŠ¨æ€ç±»å‹ã€è¯»å–è¯¥ç±»å‹çš„æ–¹æ³•è¡¨ã€è¯»å–æ–¹æ³•è¡¨ä¸­æŸä¸ªç´¢å¼•å€¼æ‰€å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ï¼Œä½†æ˜¯ç›¸å¯¹äºåˆ›å»ºå¹¶åˆå§‹åŒ– Java æ ˆå¸§è¿™æ“ä½œçš„å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡
* ä¸Šè¿°ä¼˜åŒ–çš„æ•ˆæœçœ‹ä¸Šå»ä¸é”™ï¼Œä½†å®é™…ä¸Š**ä»…å­˜åœ¨äºè§£é‡Šæ‰§è¡Œ**ä¸­ï¼Œæˆ–è€…å³æ—¶ç¼–è¯‘ä»£ç çš„æœ€åæƒ…å†µã€‚å› ä¸ºå³æ—¶ç¼–è¯‘è¿˜æ‹¥æœ‰å¦å¤–ä¸¤ç§æ€§èƒ½æ›´å¥½çš„ä¼˜åŒ–æ‰‹æ®µï¼šå†…è”ç¼“å­˜ï¼ˆinlining cacheï¼‰å’Œæ–¹æ³•å†…è”ï¼ˆmethod inliningï¼‰

<img src="https://gitee.com/seazean/images/raw/master/Java/JVM-æ–¹æ³•è°ƒç”¨è™šæ–¹æ³•è¡¨å›¾.png" style="zoom: 67%;" />



***



##### å†…è”ç¼“å­˜

å†…è”ç¼“å­˜ï¼šæ˜¯ä¸€ç§åŠ å¿«åŠ¨æ€ç»‘å®šçš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ƒèƒ½å¤Ÿç¼“å­˜è™šæ–¹æ³•è°ƒç”¨ä¸­**è°ƒç”¨è€…çš„åŠ¨æ€ç±»å‹ä»¥åŠè¯¥ç±»å‹æ‰€å¯¹åº”çš„ç›®æ ‡æ–¹æ³•**ã€‚åœ¨ä¹‹åçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœç¢°åˆ°å·²ç¼“å­˜çš„ç±»å‹ï¼Œå†…è”ç¼“å­˜ä¾¿ä¼šç›´æ¥è°ƒç”¨è¯¥ç±»å‹æ‰€å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰ç¢°åˆ°å·²ç¼“å­˜çš„ç±»å‹ï¼Œå†…è”ç¼“å­˜åˆ™ä¼šé€€åŒ–è‡³ä½¿ç”¨åŸºäºæ–¹æ³•è¡¨çš„åŠ¨æ€ç»‘å®š

å¤šæ€çš„ä¸‰ä¸ªæœ¯è¯­ï¼š

* å•æ€ (monomorphic)ï¼šæŒ‡çš„æ˜¯ä»…æœ‰ä¸€ç§çŠ¶æ€çš„æƒ…å†µ
* å¤šæ€ (polymorphic)ï¼šæŒ‡çš„æ˜¯æœ‰é™æ•°é‡ç§çŠ¶æ€çš„æƒ…å†µï¼ŒäºŒæ€ï¼ˆbimorphicï¼‰æ˜¯å¤šæ€çš„å…¶ä¸­ä¸€ç§
* è¶…å¤šæ€ (megamorphic)ï¼šæŒ‡çš„æ˜¯æ›´å¤šç§çŠ¶æ€çš„æƒ…å†µï¼Œé€šå¸¸ç”¨ä¸€ä¸ªå…·ä½“æ•°å€¼æ¥åŒºåˆ†å¤šæ€å’Œè¶…å¤šæ€ï¼Œåœ¨è¿™ä¸ªæ•°å€¼ä¹‹ä¸‹ï¼Œç§°ä¹‹ä¸ºå¤šæ€ï¼Œå¦åˆ™ç§°ä¹‹ä¸ºè¶…å¤šæ€

å¯¹äºå†…è”ç¼“å­˜æ¥è¯´ï¼Œæœ‰å¯¹åº”çš„å•æ€å†…è”ç¼“å­˜ã€å¤šæ€å†…è”ç¼“å­˜ï¼š

* å•æ€å†…è”ç¼“å­˜ï¼šåªç¼“å­˜äº†ä¸€ç§åŠ¨æ€ç±»å‹ä»¥åŠæ‰€å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ï¼Œå®ç°ç®€å•ï¼Œæ¯”è¾ƒæ‰€ç¼“å­˜çš„åŠ¨æ€ç±»å‹ï¼Œå¦‚æœå‘½ä¸­ï¼Œåˆ™ç›´æ¥è°ƒç”¨å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ã€‚
* å¤šæ€å†…è”ç¼“å­˜ï¼šç¼“å­˜äº†å¤šä¸ªåŠ¨æ€ç±»å‹åŠå…¶ç›®æ ‡æ–¹æ³•ï¼Œéœ€è¦é€ä¸ªå°†æ‰€ç¼“å­˜çš„åŠ¨æ€ç±»å‹ä¸å½“å‰åŠ¨æ€ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘½ä¸­ï¼Œåˆ™è°ƒç”¨å¯¹åº”çš„ç›®æ ‡æ–¹æ³•

ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œ**Java è™šæ‹Ÿæœºåªé‡‡ç”¨å•æ€å†…è”ç¼“å­˜**ï¼Œæ²¡æœ‰å‘½ä¸­çš„å¤„ç†æ–¹æ³•ï¼š

* æ›¿æ¢å•æ€å†…è”ç¼“å­˜ä¸­çš„çºªå½•ï¼Œç±»ä¼¼äº CPU ä¸­çš„æ•°æ®ç¼“å­˜ï¼Œå¯¹æ•°æ®çš„å±€éƒ¨æ€§æœ‰è¦æ±‚ï¼Œå³åœ¨æ›¿æ¢å†…è”ç¼“å­˜ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…ï¼Œæ–¹æ³•è°ƒç”¨çš„è°ƒç”¨è€…çš„åŠ¨æ€ç±»å‹åº”å½“ä¿æŒä¸€è‡´ï¼Œä»è€Œèƒ½å¤Ÿæœ‰æ•ˆåœ°åˆ©ç”¨å†…è”ç¼“å­˜
* åŠ£åŒ–ä¸ºè¶…å¤šæ€çŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯ Java è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æ–¹å¼ï¼Œè¿™ç§çŠ¶æ€å®é™…ä¸Šæ”¾å¼ƒäº†ä¼˜åŒ–çš„æœºä¼šï¼Œå°†ç›´æ¥è®¿é—®æ–¹æ³•è¡¨æ¥åŠ¨æ€ç»‘å®šç›®æ ‡æ–¹æ³•ï¼Œä½†æ˜¯ä¸æ›¿æ¢å†…è”ç¼“å­˜çºªå½•ç›¸æ¯”èŠ‚çœäº†å†™ç¼“å­˜çš„é¢å¤–å¼€é”€

è™½ç„¶å†…è”ç¼“å­˜é™„å¸¦å†…è”äºŒå­—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å†…è”ç›®æ ‡æ–¹æ³•





***



### ä»£ç ä¼˜åŒ–

#### è¯­æ³•ç³–

è¯­æ³•ç³–ï¼šæŒ‡ java ç¼–è¯‘å™¨æŠŠ *.java æºç ç¼–è¯‘ä¸º *.class å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨ç”Ÿæˆå’Œè½¬æ¢çš„ä¸€äº›ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„è´Ÿæ‹…



#### æ„é€ å™¨

```java
public class Candy1 {
}
```

```java
public class Candy1 {
    // è¿™ä¸ªæ— å‚æ„é€ æ˜¯ç¼–è¯‘å™¨å¸®åŠ©æˆ‘ä»¬åŠ ä¸Šçš„
    public Candy1() {
        super(); // å³è°ƒç”¨çˆ¶ç±» Object çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå³è°ƒç”¨ java/lang/Object."
        <init>":()V
    }
}
```



***



#### æ‹†è£…ç®±

```java
Integer x = 1;
int y = x;
```

è¿™æ®µä»£ç åœ¨ JDK 5 ä¹‹å‰æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå¿…é¡»æ”¹å†™ä¸ºä»£ç ç‰‡æ®µ2ï¼š

```java
Integer x = Integer.valueOf(1);
int y = x.intValue();
```

JDK5 ä»¥åç¼–è¯‘é˜¶æ®µè‡ªåŠ¨è½¬æ¢æˆä¸Šè¿°ç‰‡æ®µ



***



#### æ³›å‹æ“¦é™¤

æ³›å‹ä¹Ÿæ˜¯åœ¨ JDK 5 å¼€å§‹åŠ å…¥çš„ç‰¹æ€§ï¼Œä½† java åœ¨ç¼–è¯‘æ³›å‹ä»£ç åä¼šæ‰§è¡Œ**æ³›å‹æ“¦é™¤**çš„åŠ¨ä½œï¼Œå³æ³›å‹ä¿¡æ¯
åœ¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ä¹‹åå°±ä¸¢å¤±äº†ï¼Œå®é™…çš„ç±»å‹éƒ½**å½“åšäº† Object ç±»å‹**æ¥å¤„ç†ï¼š

```java
List<Integer> list = new ArrayList<>();
list.add(10); // å®é™…è°ƒç”¨çš„æ˜¯ List.add(Object e)
Integer x = list.get(0); // å®é™…è°ƒç”¨çš„æ˜¯ Object obj = List.get(int index);
```

ç¼–è¯‘å™¨çœŸæ­£ç”Ÿæˆçš„å­—èŠ‚ç ä¸­ï¼Œè¿˜è¦é¢å¤–åšä¸€ä¸ªç±»å‹è½¬æ¢çš„æ“ä½œï¼š

```java
// éœ€è¦å°† Object è½¬ä¸º Integer
Integer x = (Integer)list.get(0);
```

å¦‚æœå‰é¢çš„ x å˜é‡ç±»å‹ä¿®æ”¹ä¸º int åŸºæœ¬ç±»å‹é‚£ä¹ˆæœ€ç»ˆç”Ÿæˆçš„å­—èŠ‚ç æ˜¯ï¼š

```java
// éœ€è¦å°† Object è½¬ä¸º Integer, å¹¶æ‰§è¡Œæ‹†ç®±æ“ä½œ
int x = ((Integer)list.get(0)).intValue();
```



***



#### å¯å˜å‚æ•°

```java
public class Candy4 {
    public static void foo(String... args) {
        String[] array = args; // ç›´æ¥èµ‹å€¼
        System.out.println(array);
    }
    public static void main(String[] args) {
    	foo("hello", "world");
    }
}
```

å¯å˜å‚æ•°`String... args`å…¶å®æ˜¯`String[] args` ï¼Œ java ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†ä¸Šè¿°ä»£ç å˜æ¢ä¸ºï¼š

```java
public static void main(String[] args) {
	foo(new String[]{"hello", "world"});
}
```

æ³¨æ„ï¼šå¦‚æœè°ƒç”¨äº†foo()åˆ™ç­‰ä»·ä»£ç ä¸º`foo(new String[]{})` ï¼Œåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œè€Œä¸ä¼šä¼ é€’ null è¿›å»



****



#### foreach

**æ•°ç»„çš„å¾ªç¯ï¼š**

```java
int[] array = {1, 2, 3, 4, 5}; // æ•°ç»„èµ‹åˆå€¼çš„ç®€åŒ–å†™æ³•ä¹Ÿæ˜¯è¯­æ³•ç³–å“¦
for (int e : array) {
	System.out.println(e);
}
```

ç¼–è¯‘åä¸ºå¾ªç¯å–æ•°ï¼š

```java
for(int i = 0; i < array.length; ++i) {
	int e = array[i];
	System.out.println(e);
}
```

**é›†åˆçš„å¾ªç¯ï¼š**

```java
List<Integer> list = Arrays.asList(1,2,3,4,5);
for (Integer i : list) {
	System.out.println(i);
}
```

ç¼–è¯‘åè½¬æ¢ä¸ºå¯¹è¿­ä»£å™¨çš„è°ƒç”¨ï¼š

```java
List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
Iterator iter = list.iterator();
while(iter.hasNext()) {
    Integer e = (Integer)iter.next();
    System.out.println(e);
}
```

æ³¨æ„ï¼šforeach å¾ªç¯å†™æ³•ï¼Œèƒ½å¤Ÿé…åˆæ•°ç»„ä»¥åŠæ‰€æœ‰å®ç°äº† Iterable æ¥å£çš„é›†åˆç±»ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­ Iterable ç”¨æ¥è·å–é›†åˆçš„è¿­ä»£å™¨ï¼ˆ Iterator ï¼‰



***



#### switch

##### å­—ç¬¦ä¸²

ä» JDK  å¼€å§‹ï¼Œswitch å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²å’Œæšä¸¾ç±»ï¼š

```java
switch (str) {
    case "hello": {
        System.out.println("h");
        break;
    }
    case "world": {
        System.out.println("w");
        break;
    }
}
```

æ³¨æ„ï¼šswitch é…åˆ String å’Œæšä¸¾ä½¿ç”¨æ—¶ï¼Œå˜é‡ä¸èƒ½ä¸ºnull

ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºï¼š

```java
byte x = -1;
switch(str.hashCode()) {
    case 99162322: // hello çš„ hashCode
        if (str.equals("hello")) {
        	x = 0;
        }
    	break;
    case 113318802: // world çš„ hashCode
        if (str.equals("world")) {
        	x = 1;
        }
}
switch(x) {
    case 0:
    	System.out.println("h");
    	break;
    case 1:
    	System.out.println("w");
        break;
}
```

æ€»ç»“ï¼š

* æ‰§è¡Œäº†ä¸¤é switchï¼Œç¬¬ä¸€éæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„ hashCode å’Œ equals å°†å­—ç¬¦ä¸²çš„è½¬æ¢ä¸ºç›¸åº” byte ç±»å‹ï¼Œç¬¬äºŒéæ‰æ˜¯åˆ©ç”¨ byte æ‰§è¡Œè¿›è¡Œæ¯”è¾ƒ
* hashCode æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå‡å°‘å¯èƒ½çš„æ¯”è¾ƒï¼›è€Œ equals æ˜¯ä¸ºäº†é˜²æ­¢ hashCode å†²çª



***



##### æšä¸¾

switch æšä¸¾çš„ä¾‹å­ï¼ŒåŸå§‹ä»£ç ï¼š

```java
enum Sex {
	MALE, FEMALE
}
public class Candy7 {
    public static void foo(Sex sex) {
        switch (sex) {
        case MALE:
        	System.out.println("ç”·"); 
            break;
        case FEMALE:
        	System.out.println("å¥³"); 
            break;
        }
	}
}
```

ç¼–è¯‘è½¬æ¢åçš„ä»£ç ï¼š

```java
/**
* å®šä¹‰ä¸€ä¸ªåˆæˆç±»ï¼ˆä»… jvm ä½¿ç”¨ï¼Œå¯¹æˆ‘ä»¬ä¸å¯è§ï¼‰
* ç”¨æ¥æ˜ å°„æšä¸¾çš„ ordinal ä¸æ•°ç»„å…ƒç´ çš„å…³ç³»
* æšä¸¾çš„ ordinal è¡¨ç¤ºæšä¸¾å¯¹è±¡çš„åºå·ï¼Œä» 0 å¼€å§‹
* å³ MALE çš„ ordinal()=0ï¼ŒFEMALE çš„ ordinal()=1
*/
static class $MAP {
    // æ•°ç»„å¤§å°å³ä¸ºæšä¸¾å…ƒç´ ä¸ªæ•°ï¼Œé‡Œé¢å­˜å‚¨caseç”¨æ¥å¯¹æ¯”çš„æ•°å­—
    static int[] map = new int[2];
    static {
    	map[Sex.MALE.ordinal()] = 1;
    	map[Sex.FEMALE.ordinal()] = 2;
	}
}
public static void foo(Sex sex) {
    int x = $MAP.map[sex.ordinal()];
    switch (x) {
        case 1:
        	System.out.println("ç”·");
        	break;
        case 2:
        	System.out.println("å¥³");
        	break;
    }
}
```



***



#### æšä¸¾ç±»

JDK 7 æ–°å¢äº†æšä¸¾ç±»ï¼š

```java
enum Sex {
	MALE, FEMALE
}
```

ç¼–è¯‘è½¬æ¢åï¼š

```java
public final class Sex extends Enum<Sex> {
    public static final Sex MALE;
    public static final Sex FEMALE;
    private static final Sex[] $VALUES;
    static {
        MALE = new Sex("MALE", 0);
        FEMALE = new Sex("FEMALE", 1);
        $VALUES = new Sex[]{MALE, FEMALE};
    }
    private Sex(String name, int ordinal) {
    	super(name, ordinal);
    }
    public static Sex[] values() {
    	return $VALUES.clone();
    }
    public static Sex valueOf(String name) {
    	return Enum.valueOf(Sex.class, name);
    }
}
```



#### try-w-r

JDK 7 å¼€å§‹æ–°å¢äº†å¯¹éœ€è¦å…³é—­çš„èµ„æºå¤„ç†çš„ç‰¹æ®Šè¯­æ³•`try-with-resources`ï¼Œæ ¼å¼ï¼š

```java
try(èµ„æºå˜é‡ = åˆ›å»ºèµ„æºå¯¹è±¡){
} catch( ) {
}
```

å…¶ä¸­èµ„æºå¯¹è±¡éœ€è¦å®ç° **AutoCloseable**æ¥å£ï¼Œä¾‹å¦‚ InputStreamã€OutputStreamã€Connectionã€Statementã€ResultSet ç­‰æ¥å£éƒ½å®ç°äº† AutoCloseable ï¼Œä½¿ç”¨ try-withresourceså¯ä»¥ä¸ç”¨å†™ finally è¯­å¥å—ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©ç”Ÿæˆå…³é—­èµ„æºä»£ç ï¼š

```java
try(InputStream is = new FileInputStream("d:\\1.txt")) {
	System.out.println(is);
} catch (IOException e) {
	e.printStackTrace();
}
```

è½¬æ¢æˆï¼š

`addSuppressed(Throwable e)`ï¼šæ·»åŠ è¢«å‹åˆ¶å¼‚å¸¸ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å¼‚å¸¸ä¿¡æ¯çš„ä¸¢å¤±ï¼ˆtry-with-resources ç”Ÿæˆçš„ fianlly ä¸­å¦‚æœæŠ›å‡ºäº†å¼‚å¸¸ï¼‰

```java
try {
    InputStream is = new FileInputStream("d:\\1.txt");
    Throwable t = null;
    try {
    	System.out.println(is);
    } catch (Throwable e1) {
    	// t æ˜¯æˆ‘ä»¬ä»£ç å‡ºç°çš„å¼‚å¸¸
    	t = e1;
    	throw e1;
    } finally {
        // åˆ¤æ–­äº†èµ„æºä¸ä¸ºç©º
        if (is != null) {
            // å¦‚æœæˆ‘ä»¬ä»£ç æœ‰å¼‚å¸¸
            if (t != null) {
                try {
                	is.close();
                } catch (Throwable e2) {
                    // å¦‚æœ close å‡ºç°å¼‚å¸¸ï¼Œä½œä¸ºè¢«å‹åˆ¶å¼‚å¸¸æ·»åŠ 
                    t.addSuppressed(e2);
                }
            } else {
                // å¦‚æœæˆ‘ä»¬ä»£ç æ²¡æœ‰å¼‚å¸¸ï¼Œclose å‡ºç°çš„å¼‚å¸¸å°±æ˜¯æœ€å catch å—ä¸­çš„ e
                is.close();
            }
		}
	}
} catch (IOException e) {
    e.printStackTrace();
}
```



***



#### æ–¹æ³•é‡å†™

æ–¹æ³•é‡å†™æ—¶å¯¹è¿”å›å€¼åˆ†ä¸¤ç§æƒ…å†µï¼š

* çˆ¶å­ç±»çš„è¿”å›å€¼å®Œå…¨ä¸€è‡´
* å­ç±»è¿”å›å€¼å¯ä»¥æ˜¯çˆ¶ç±»è¿”å›å€¼çš„å­ç±»

```java
class A {
    public Number m() {
		return 1;
    }
}
class B extends A {
    @Override
    // å­ç±»mæ–¹æ³•çš„è¿”å›å€¼æ˜¯Integeræ˜¯çˆ¶ç±»mæ–¹æ³•è¿”å›å€¼Numberçš„å­ç±»
    public Integer m() {
    	return 2;
    }
}
```

å¯¹äºå­ç±»ï¼Œjava ç¼–è¯‘å™¨ä¼šåšå¦‚ä¸‹å¤„ç†ï¼š

```java
class B extends A {
    public Integer m() {
    	return 2;
    }
	// æ­¤æ–¹æ³•æ‰æ˜¯çœŸæ­£é‡å†™äº†çˆ¶ç±» public Number m() æ–¹æ³•
	public synthetic bridge Number m() {
    	// è°ƒç”¨ public Integer m()
    	return m();
    }
}
```

å…¶ä¸­æ¡¥æ¥æ–¹æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œä»…å¯¹ java è™šæ‹Ÿæœºå¯è§ï¼Œå¹¶ä¸”ä¸åŸæ¥çš„ public Integer m() æ²¡æœ‰å‘½åå†²çª



***



#### åŒ¿åå†…éƒ¨ç±»

##### æ— å‚ä¼˜åŒ–

æºä»£ç ï¼š

```java
public class Candy11 {
    public static void main(String[] args) {
        Runnable runnable = new Runnable() {
            @Override
            public void run() {
            	System.out.println("ok");
            }
        };
    }
}
```

è½¬åŒ–åä»£ç ï¼š

```java
// é¢å¤–ç”Ÿæˆçš„ç±»
final class Candy11$1 implements Runnable {
    Candy11$1() {
    }
    public void run() {
    	System.out.println("ok");
    }
}
public class Candy11 {
    public static void main(String[] args) {
    	Runnable runnable = new Candy11$1();
    }
}
```



##### å¸¦å‚ä¼˜åŒ–

å¼•ç”¨å±€éƒ¨å˜é‡çš„åŒ¿åå†…éƒ¨ç±»ï¼Œæºä»£ç ï¼š

```java
public class Candy11 {
    public static void test(final int x) {
        Runnable runnable = new Runnable() {
            @Override
            public void run() {
            	System.out.println("ok:" + x);
            }
        };
    }
}
```

è½¬æ¢åä»£ç ï¼š

```java
final class Candy11$1 implements Runnable {
    int val$x;
    Candy11$1(int x) {
    	this.val$x = x;
    }
    public void run() {
    	System.out.println("ok:" + this.val$x);
    }
}
public class Candy11 {
    public static void test(final int x) {
    	Runnable runnable = new Candy11$1(x);
    }
}
```

å±€éƒ¨å˜é‡åœ¨åº•å±‚åˆ›å»ºä¸ºå†…éƒ¨ç±»çš„æˆå‘˜å˜é‡ï¼Œå¿…é¡»æ˜¯ final çš„åŸå› ï¼š

* åœ¨Javaä¸­æ–¹æ³•è°ƒç”¨æ˜¯å€¼ä¼ é€’çš„ï¼Œåœ¨åŒ¿åå†…éƒ¨ç±»ä¸­å¯¹å˜é‡çš„æ“ä½œéƒ½æ˜¯åŸºäºåŸå˜é‡çš„å‰¯æœ¬ï¼Œä¸ä¼šå½±å“åˆ°åŸå˜é‡çš„å€¼ï¼Œæ‰€ä»¥åŸå˜é‡çš„å€¼çš„æ”¹å˜ä¹Ÿæ— æ³•åŒæ­¥åˆ°å‰¯æœ¬ä¸­

* å¤–éƒ¨å˜é‡ä¸ºfinalæ˜¯åœ¨ç¼–è¯‘æœŸä»¥å¼ºåˆ¶æ‰‹æ®µç¡®ä¿ç”¨æˆ·ä¸ä¼šåœ¨å†…éƒ¨ç±»ä¸­åšä¿®æ”¹åŸå˜é‡å€¼çš„æ“ä½œï¼Œä¹Ÿæ˜¯é˜²æ­¢å¤–éƒ¨æ“ä½œä¿®æ”¹äº†å˜é‡è€Œå†…éƒ¨ç±»æ— æ³•éšä¹‹å˜åŒ–å‡ºç°çš„å½±å“

  åœ¨åˆ›å»º `Candy11$1 ` å¯¹è±¡æ—¶ï¼Œå°† x çš„å€¼èµ‹å€¼ç»™äº† `Candy11$1` å¯¹è±¡çš„ val å±æ€§ï¼Œx ä¸åº”è¯¥å†å‘ç”Ÿå˜åŒ–äº†ï¼Œå› ä¸ºå‘ç”Ÿå˜åŒ–ï¼Œthis.val$x å±æ€§æ²¡æœ‰æœºä¼šå†è·Ÿç€å˜åŒ–



***



#### åå°„ä¼˜åŒ–

```java
public class Reflect1 {
    public static void foo() {
    	System.out.println("foo...");
    }
    public static void main(String[] args) throws Exception {
        Method foo = Reflect1.class.getMethod("foo");
        for (int i = 0; i <= 16; i++) {
            System.out.printf("%d\t", i);
            foo.invoke(null);
        }
        System.in.read();
    }
}
```

foo.invoke 0 ~ 15æ¬¡è°ƒç”¨çš„æ˜¯ MethodAccessor çš„å®ç°ç±»`NativeMethodAccessorImpl.invoke0()`ï¼Œæœ¬åœ°æ–¹æ³•æ‰§è¡Œé€Ÿåº¦æ…¢ï¼›å½“è°ƒç”¨åˆ°ç¬¬ 16 æ¬¡æ—¶ï¼Œä¼šé‡‡ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»`sun.reflect.GeneratedMethodAccessor1`ä»£æ›¿

```java
public Object invoke(Object obj, Object[] args)throws Exception {
    // inflationThreshold è†¨èƒ€é˜ˆå€¼ï¼Œé»˜è®¤ 15
    if (++numInvocations > ReflectionFactory.inflationThreshold()
        && !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) {
        MethodAccessorImpl acc = (MethodAccessorImpl)
            new MethodAccessorGenerator().
            generateMethod(method.getDeclaringClass(),
                           method.getName(),
                           method.getParameterTypes(),
                           method.getReturnType(),
                           method.getExceptionTypes(),
                           method.getModifiers());
        parent.setDelegate(acc);
    }
    //è°ƒç”¨æœ¬åœ°æ–¹æ³•å®ç°
    return invoke0(method, obj, args);
}
private static native Object invoke0(Method m, Object obj, Object[] args);
```

```java
public class GeneratedMethodAccessor1 extends MethodAccessorImpl {
    // å¦‚æœæœ‰å‚æ•°ï¼Œé‚£ä¹ˆæŠ›éæ³•å‚æ•°å¼‚å¸¸
    block4 : {
        if (arrobject == null || arrobject.length == 0) break block4;
            throw new IllegalArgumentException();
    }
    try {
        // å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æ˜¯ç›´æ¥è°ƒç”¨æ–¹æ³•
        Reflect1.foo();
        // å› ä¸ºæ²¡æœ‰è¿”å›å€¼
        return null;
    }
   //....
}
```

é€šè¿‡æŸ¥çœ‹ ReflectionFactory æºç å¯çŸ¥ï¼š

* sun.reflect.noInflation å¯ä»¥ç”¨æ¥ç¦ç”¨è†¨èƒ€ï¼Œç›´æ¥ç”Ÿæˆ GeneratedMethodAccessor1ï¼Œä½†é¦–æ¬¡ç”Ÿæˆæ¯”è¾ƒè€—æ—¶ï¼Œå¦‚æœä»…åå°„è°ƒç”¨ä¸€æ¬¡ï¼Œä¸åˆ’ç®—
* sun.reflect.inflationThreshold å¯ä»¥ä¿®æ”¹è†¨èƒ€é˜ˆå€¼





***





## JVMè°ƒä¼˜

### æ€§èƒ½è°ƒä¼˜

#### æ€§èƒ½æŒ‡æ ‡

æ€§èƒ½æŒ‡æ ‡ä¸»è¦æ˜¯ååé‡ã€å“åº”æ—¶é—´ã€QPSã€TPS ç­‰ã€å¹¶å‘ç”¨æˆ·æ•°ç­‰ï¼Œè€Œè¿™äº›æ€§èƒ½æŒ‡æ ‡åˆä¾èµ–äºç³»ç»ŸæœåŠ¡å™¨çš„èµ„æºï¼Œå¦‚ CPUã€å†…å­˜ã€ç£ç›˜IOã€ç½‘ç»œIO ç­‰ï¼Œå¯¹äºè¿™äº›æŒ‡æ ‡æ•°æ®çš„æ”¶é›†ï¼Œé€šå¸¸å¯ä»¥æ ¹æ®Javaæœ¬èº«çš„å·¥å…·æˆ–æŒ‡ä»¤è¿›è¡ŒæŸ¥è¯¢

å‡ ä¸ªé‡è¦çš„æŒ‡æ ‡ï¼š

1. åœé¡¿æ—¶é—´ï¼ˆå“åº”æ—¶é—´ï¼‰ï¼šæäº¤è¯·æ±‚å’Œè¿”å›è¯¥è¯·æ±‚çš„å“åº”ä¹‹é—´ä½¿ç”¨çš„æ—¶é—´ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶ä¸­ STW çš„æ—¶é—´
2. ååé‡ï¼šå¯¹å•ä½æ—¶é—´å†…å®Œæˆçš„å·¥ä½œé‡ï¼ˆè¯·æ±‚ï¼‰çš„é‡åº¦ï¼ˆå¯ä»¥å¯¹æ¯” GC çš„æ€§èƒ½æŒ‡æ ‡ï¼‰
3. å¹¶å‘æ•°ï¼šåŒä¸€æ—¶åˆ»ï¼Œå¯¹æœåŠ¡å™¨æœ‰å®é™…äº¤äº’çš„è¯·æ±‚æ•°
4. QPSï¼šQueries Per Secondï¼Œæ¯ç§’å¤„ç†çš„æŸ¥è¯¢é‡
5. TPSï¼šTransactions Per Secondï¼Œæ¯ç§’äº§ç”Ÿçš„äº‹åŠ¡æ•°
6. å†…å­˜å ç”¨ï¼šJavaå †åŒºæ‰€å çš„å†…å­˜å¤§å°



***



#### ä¼˜åŒ–æ­¥éª¤

å¯¹äºä¸€ä¸ªç³»ç»Ÿè¦éƒ¨ç½²ä¸Šçº¿æ—¶ï¼Œåˆ™ä¸€å®šä¼šå¯¹ JVM è¿›è¡Œè°ƒæ•´ï¼Œä¸ç»è¿‡ä»»ä½•è°ƒæ•´ç›´æ¥ä¸Šçº¿ï¼Œå®¹æ˜“å‡ºç°çº¿ä¸Šç³»ç»Ÿé¢‘ç¹ FullGC é€ æˆç³»ç»Ÿå¡é¡¿ã€CPU ä½¿ç”¨é¢‘ç‡è¿‡é«˜ã€ç³»ç»Ÿæ— ååº”ç­‰é—®é¢˜

1. æ€§èƒ½ç›‘æ§ï¼šé€šè¿‡è¿è¡Œæ—¥å¿—ã€å †æ ˆä¿¡æ¯ã€çº¿ç¨‹å¿«ç…§ç­‰ä¿¡æ¯ç›‘æ§æ˜¯å¦å‡ºç° GC é¢‘ç¹ã€OOMã€å†…å­˜æ³„æ¼ã€æ­»é”ã€å“åº”æ—¶é—´è¿‡é•¿ç­‰æƒ…å†µ

2. æ€§èƒ½åˆ†æï¼š

   * æ‰“å° GC æ—¥å¿—ï¼Œé€šè¿‡ GCviewe ræˆ–è€… http://gceasy.io æ¥åˆ†æå¼‚å¸¸ä¿¡æ¯

   - è¿ç”¨å‘½ä»¤è¡Œå·¥å…·ã€jstackã€jmapã€jinfoç­‰

   - dump å‡ºå †æ–‡ä»¶ï¼Œä½¿ç”¨å†…å­˜åˆ†æå·¥å…·åˆ†ææ–‡ä»¶

   - ä½¿ç”¨é˜¿é‡Œ Arthasã€jconsoleã€JVisualVM æ¥å®æ—¶æŸ¥çœ‹ JVM çŠ¶æ€

   - jstack æŸ¥çœ‹å †æ ˆä¿¡æ¯

3. æ€§èƒ½è°ƒä¼˜ï¼š

   * é€‚å½“å¢åŠ å†…å­˜ï¼Œæ ¹æ®ä¸šåŠ¡èƒŒæ™¯é€‰æ‹©åƒåœ¾å›æ”¶å™¨

   - ä¼˜åŒ–ä»£ç ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨

   - å¢åŠ æœºå™¨ï¼Œåˆ†æ•£èŠ‚ç‚¹å‹åŠ›

   - åˆç†è®¾ç½®çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡

   - ä½¿ç”¨ä¸­é—´ä»¶æé«˜ç¨‹åºæ•ˆç‡ï¼Œæ¯”å¦‚ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰



***



#### å‚æ•°è°ƒä¼˜

å¯¹äº JVM è°ƒä¼˜ï¼Œä¸»è¦å°±æ˜¯è°ƒæ•´å¹´è½»ä»£ã€è€å¹´ä»£ã€å…ƒç©ºé—´çš„å†…å­˜ç©ºé—´å¤§å°åŠä½¿ç”¨çš„åƒåœ¾å›æ”¶å™¨ç±»å‹

* è®¾ç½®å †çš„åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ï¼Œä¸ºäº†é˜²æ­¢åƒåœ¾æ”¶é›†å™¨åœ¨åˆå§‹å¤§å°ã€æœ€å¤§å¤§å°ä¹‹é—´æ”¶ç¼©å †è€Œäº§ç”Ÿé¢å¤–çš„æ—¶é—´ï¼Œé€šå¸¸æŠŠæœ€å¤§ã€åˆå§‹å¤§å°è®¾ç½®ä¸ºç›¸åŒçš„å€¼

  ```sh
  -Xmsï¼šè®¾ç½®å †çš„åˆå§‹åŒ–å¤§å°
  -Xmxï¼šè®¾ç½®å †çš„æœ€å¤§å¤§å°
  ```

* è®¾ç½®å¹´è½»ä»£ä¸­ Eden åŒºå’Œä¸¤ä¸ª Survivor åŒºçš„å¤§å°æ¯”ä¾‹ã€‚è¯¥å€¼å¦‚æœä¸è®¾ç½®ï¼Œåˆ™é»˜è®¤æ¯”ä¾‹ä¸º 8:1:1ã€‚Java å®˜æ–¹é€šè¿‡å¢å¤§ Eden åŒºçš„å¤§å°ï¼Œæ¥å‡å°‘ YGC å‘ç”Ÿçš„æ¬¡æ•°ï¼Œè™½ç„¶æ¬¡æ•°å‡å°‘äº†ï¼Œä½† Eden åŒºæ»¡çš„æ—¶å€™ï¼Œç”±äºå ç”¨çš„ç©ºé—´è¾ƒå¤§ï¼Œå¯¼è‡´é‡Šæ”¾ç¼“æ…¢ï¼Œæ­¤æ—¶ STW çš„æ—¶é—´è¾ƒé•¿ï¼Œå› æ­¤éœ€è¦æŒ‰ç…§ç¨‹åºæƒ…å†µå»è°ƒä¼˜

  ```sh
  -XX:SurvivorRatio
  ```

* å¹´è½»ä»£å’Œè€å¹´ä»£é»˜è®¤æ¯”ä¾‹ä¸º 1:2ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´äºŒè€…ç©ºé—´å¤§å°æ¯”ç‡æ¥è®¾ç½®ä¸¤è€…çš„å¤§å°ã€‚

  ```sh
  -XX:newSize   è®¾ç½®å¹´è½»ä»£çš„åˆå§‹å¤§å°
  -XX:MaxNewSize   è®¾ç½®å¹´è½»ä»£çš„æœ€å¤§å¤§å°ï¼Œ  åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ä¸¤ä¸ªå€¼é€šå¸¸ç›¸åŒ
  ```

* çº¿ç¨‹å †æ ˆçš„è®¾ç½®ï¼š**æ¯ä¸ªçº¿ç¨‹é»˜è®¤ä¼šå¼€å¯ 1M çš„å †æ ˆ**ï¼Œç”¨äºå­˜æ”¾æ ˆå¸§ã€è°ƒç”¨å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ï¼Œä½†ä¸€èˆ¬ 256K å°±å¤Ÿç”¨ï¼Œé€šå¸¸å‡å°‘æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆï¼Œå¯ä»¥äº§ç”Ÿæ›´å¤šçš„çº¿ç¨‹ï¼Œä½†è¿™å®é™…ä¸Šè¿˜å—é™äºæ“ä½œç³»ç»Ÿ

  ```sh
  -Xss   å¯¹æ¯ä¸ªçº¿ç¨‹stackå¤§å°çš„è°ƒæ•´,-Xss128k
  ```

* ä¸€èˆ¬ä¸€å¤©è¶…è¿‡ä¸€æ¬¡ FullGC å°±æ˜¯æœ‰é—®é¢˜ï¼Œé¦–å…ˆé€šè¿‡å·¥å…·æŸ¥çœ‹æ˜¯å¦å‡ºç°å†…å­˜æ³„éœ²ï¼Œå¦‚æœå‡ºç°å†…å­˜æ³„éœ²åˆ™è°ƒæ•´ä»£ç ï¼Œæ²¡æœ‰çš„è¯åˆ™è°ƒæ•´ JVM å‚æ•°

* ç³»ç»Ÿ CPU æŒç»­é£™é«˜çš„è¯ï¼Œé¦–å…ˆå…ˆæ’æŸ¥ä»£ç é—®é¢˜ï¼Œå¦‚æœä»£ç æ²¡é—®é¢˜ï¼Œåˆ™å’¨è¯¢è¿ç»´æˆ–è€…äº‘æœåŠ¡å™¨ä¾›åº”å•†ï¼Œé€šå¸¸æœåŠ¡å™¨é‡å¯æˆ–è€…æœåŠ¡å™¨è¿ç§»å³å¯è§£å†³

* å¦‚æœæ•°æ®æŸ¥è¯¢æ€§èƒ½å¾ˆä½ä¸‹çš„è¯ï¼Œå¦‚æœç³»ç»Ÿå¹¶å‘é‡å¹¶æ²¡æœ‰å¤šå°‘ï¼Œåˆ™åº”æ›´åŠ å…³æ³¨æ•°æ®åº“çš„ç›¸å…³é—®é¢˜

* å¦‚æœæœåŠ¡å™¨é…ç½®è¿˜ä¸é”™ï¼ŒJDK8 å¼€å§‹å°½é‡ä½¿ç”¨ G1 æˆ–è€…æ–°ç”Ÿä»£å’Œè€å¹´ä»£ç»„åˆä½¿ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶å™¨





****





### å‘½ä»¤è¡Œç¯‡

#### jps

jpsï¼ˆJava Process Statuï¼‰ï¼šæ˜¾ç¤ºæŒ‡å®šç³»ç»Ÿå†…æ‰€æœ‰çš„ HotSpot è™šæ‹Ÿæœºè¿›ç¨‹ï¼ˆæŸ¥çœ‹è™šæ‹Ÿæœºè¿›ç¨‹ä¿¡æ¯ï¼‰ï¼Œå¯ç”¨äºæŸ¥è¯¢æ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œè¿›ç¨‹çš„æœ¬åœ°è™šæ‹Ÿæœº ID ä¸æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ ID æ˜¯ä¸€è‡´çš„ï¼Œæ˜¯å”¯ä¸€çš„

ä½¿ç”¨è¯­æ³•ï¼š`jps [options] [hostid]`

options å‚æ•°ï¼š

- -qï¼šä»…ä»…æ˜¾ç¤º LVMIDï¼ˆlocal virtual machine idï¼‰ï¼Œå³æœ¬åœ°è™šæ‹Ÿæœºå”¯ä¸€ idï¼Œä¸æ˜¾ç¤ºä¸»ç±»çš„åç§°ç­‰

- -lï¼šè¾“å‡ºåº”ç”¨ç¨‹åºä¸»ç±»çš„å…¨ç±»åæˆ–å¦‚æœè¿›ç¨‹æ‰§è¡Œçš„æ˜¯ jar åŒ…ï¼Œåˆ™è¾“å‡º jar å®Œæ•´è·¯å¾„

- -mï¼šè¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶ä¼ é€’ç»™ä¸»ç±» main()çš„å‚æ•°

- -vï¼šåˆ—å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶çš„JVMå‚æ•°ï¼Œæ¯”å¦‚ -Xms20m -Xmx50mæ˜¯å¯åŠ¨ç¨‹åºæŒ‡å®šçš„ jvm å‚æ•°

ostid å‚æ•°ï¼šRMIæ³¨å†Œè¡¨ä¸­æ³¨å†Œçš„ä¸»æœºåï¼Œå¦‚æœæƒ³è¦è¿œç¨‹ç›‘æ§ä¸»æœºä¸Šçš„ java ç¨‹åºï¼Œéœ€è¦å®‰è£… jstatd



****



#### jstat

jstatï¼ˆJVM Statistics Monitoring Toolï¼‰ï¼šç”¨äºç›‘è§† JVM å„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è€…è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»è£…è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ï¼Œåœ¨æ²¡æœ‰ GUI çš„å›¾å½¢ç•Œé¢ï¼Œåªæä¾›äº†çº¯æ–‡æœ¬æ§åˆ¶å°ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒæ˜¯è¿è¡ŒæœŸå®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜çš„é¦–é€‰å·¥å…·ï¼Œå¸¸ç”¨äºæ£€æµ‹åƒåœ¾å›æ”¶é—®é¢˜ä»¥åŠå†…å­˜æ³„æ¼é—®é¢˜

ä½¿ç”¨è¯­æ³•ï¼š`jstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]`

æŸ¥çœ‹å‘½ä»¤ç›¸å…³å‚æ•°ï¼šjstat-h æˆ– jstat-help

* vmid æ˜¯è¿›ç¨‹ id å·

* option å‚æ•°ï¼š

  ç±»è£…è½½ç›¸å…³ï¼š

  - -classï¼šæ˜¾ç¤ºClassLoaderçš„ç›¸å…³ä¿¡æ¯ï¼šç±»çš„è£…è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´ã€ç±»è£…è½½æ‰€æ¶ˆè€—çš„æ—¶é—´ç­‰

  åƒåœ¾å›æ”¶ç›¸å…³ï¼š

  - -gcï¼šæ˜¾ç¤ºä¸GCç›¸å…³çš„å †ä¿¡æ¯ï¼Œå¹´è½»ä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ç­‰çš„å®¹é‡ã€å·²ç”¨ç©ºé—´ã€GCæ—¶é—´åˆè®¡ç­‰ä¿¡æ¯

  - -gccapacityï¼šæ˜¾ç¤ºå†…å®¹ä¸ -gc åŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨ Java å †å„ä¸ªåŒºåŸŸä½¿ç”¨åˆ°çš„æœ€å¤§ã€æœ€å°ç©ºé—´

  - -gcutilï¼šæ˜¾ç¤ºå†…å®¹ä¸ -gc åŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨å·²ä½¿ç”¨ç©ºé—´å æ€»ç©ºé—´çš„ç™¾åˆ†æ¯”

  - -gccauseï¼šä¸ -gcutil åŠŸèƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé¢å¤–è¾“å‡ºå¯¼è‡´æœ€åä¸€æ¬¡æˆ–å½“å‰æ­£åœ¨å‘ç”Ÿçš„ GC äº§ç”Ÿçš„åŸå› 

  - -gcnewï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£ GC çŠ¶å†µ

  - -gcnewcapacityï¼šæ˜¾ç¤ºå†…å®¹ä¸ -gcnew åŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§ã€æœ€å°ç©ºé—´

  - -geoldï¼šæ˜¾ç¤ºè€å¹´ä»£ GC çŠ¶å†µ

  - -gcoldcapacityï¼šæ˜¾ç¤ºå†…å®¹ä¸ -gcold åŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§ã€æœ€å°ç©ºé—´

  - -gcpermcapacityï¼šæ˜¾ç¤ºæ°¸ä¹…ä»£ä½¿ç”¨åˆ°çš„æœ€å¤§ã€æœ€å°ç©ºé—´

  JIT ç›¸å…³ï¼š

  - -compilerï¼šæ˜¾ç¤º JIT ç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯

  - -printcompilationï¼šè¾“å‡ºå·²ç»è¢« JIT ç¼–è¯‘çš„æ–¹æ³•



****



#### jinfo

jinfoï¼ˆConfiguration Info for Javaï¼‰ï¼šæŸ¥çœ‹è™šæ‹Ÿæœºé…ç½®å‚æ•°ä¿¡æ¯ï¼Œä¹Ÿå¯ç”¨äºè°ƒæ•´è™šæ‹Ÿæœºçš„é…ç½®å‚æ•°ï¼Œå¼€å‘äººå‘˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ° Java è™šæ‹Ÿæœºå‚æ•°çš„å½“å‰å€¼

ä½¿ç”¨è¯­æ³•ï¼š`jinfo [options] pid`

options å‚æ•°ï¼š

* no optionï¼šè¾“å‡ºå…¨éƒ¨çš„å‚æ•°å’Œç³»ç»Ÿå±æ€§
* -flag nameï¼šè¾“å‡ºå¯¹åº”åç§°çš„å‚æ•°
* -flag [+-]nameï¼šå¼€å¯æˆ–è€…å…³é—­å¯¹åº”åç§°çš„å‚æ•° åªæœ‰è¢«æ ‡è®°ä¸ºmanageableçš„å‚æ•°æ‰å¯ä»¥è¢«åŠ¨æ€ä¿®æ”¹
* -flag name=valueï¼šè®¾å®šå¯¹åº”åç§°çš„å‚æ•°
* -flagsï¼šè¾“å‡ºå…¨éƒ¨çš„å‚æ•°
* -syspropsï¼šè¾“å‡ºç³»ç»Ÿå±æ€§



****



#### jmap

jmapï¼ˆJVM Memory Mapï¼‰ï¼šè·å– dump æ–‡ä»¶ï¼Œè¿˜å¯ä»¥è·å–ç›®æ ‡ Java è¿›ç¨‹çš„å†…å­˜ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Java å †å„åŒºåŸŸçš„ä½¿ç”¨æƒ…å†µã€å †ä¸­å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ã€ç±»åŠ è½½ä¿¡æ¯ç­‰

ä½¿ç”¨è¯­æ³•ï¼š

- `jmap [options] <pid>`

- `jmap [options] <executable <core>`

- `jmap [options] [server_id@] <remote server IP or hostname>`

option å‚æ•°ï¼š

* -dumpï¼šç”Ÿæˆ dump æ–‡ä»¶ï¼ˆJavaå †è½¬å‚¨å¿«ç…§ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œ-dump:live åªä¿å­˜å †ä¸­çš„å­˜æ´»å¯¹è±¡
* -heapï¼šè¾“å‡ºæ•´ä¸ªå †ç©ºé—´çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ GC çš„ä½¿ç”¨ã€å †é…ç½®ä¿¡æ¯ï¼Œä»¥åŠå†…å­˜çš„ä½¿ç”¨ä¿¡æ¯ç­‰
* -histoï¼šè¾“å‡ºå †ç©ºé—´ä¸­å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»ã€å®ä¾‹æ•°é‡å’Œåˆè®¡å®¹é‡ï¼Œ-histo:live åªç»Ÿè®¡å †ä¸­çš„å­˜æ´»å¯¹è±¡
* -J <flag>ï¼šä¼ é€’å‚æ•°ç»™ jmap å¯åŠ¨çš„ jvm
* -finalizerinfoï¼šæ˜¾ç¤ºåœ¨ F-Queue ä¸­ç­‰å¾… Finalizer çº¿ç¨‹æ‰§è¡Œ finalize æ–¹æ³•çš„å¯¹è±¡ï¼Œä»… linux/solaris å¹³å°æœ‰æ•ˆ
* -permstatï¼šä»¥ ClassLoader ä¸ºç»Ÿè®¡å£å¾„è¾“å‡ºæ°¸ä¹…ä»£çš„å†…å­˜çŠ¶æ€ä¿¡æ¯ï¼Œä»… linux/solaris å¹³å°æœ‰æ•ˆ
* -Fï¼šå½“è™šæ‹Ÿæœºè¿›ç¨‹å¯¹ -dump é€‰é¡¹æ²¡æœ‰ä»»ä½•å“åº”æ—¶ï¼Œå¼ºåˆ¶æ‰§è¡Œç”Ÿæˆ dump æ–‡ä»¶ï¼Œä»… linux/solaris å¹³å°æœ‰æ•ˆ



****



#### jhat

jhatï¼ˆJVM Heap Analysis Toolï¼‰ï¼šSun JDK æä¾›çš„ jhat å‘½ä»¤ä¸ jmap å‘½ä»¤æ­é…ä½¿ç”¨ï¼Œç”¨äºåˆ†æ jmap ç”Ÿæˆçš„ heap dump æ–‡ä»¶ï¼ˆå †è½¬å‚¨å¿«ç…§ï¼‰ï¼Œjhat å†…ç½®äº†ä¸€ä¸ªå¾®å‹çš„ HTTP/HTML æœåŠ¡å™¨ï¼Œç”Ÿæˆ dump æ–‡ä»¶çš„åˆ†æç»“æœåï¼Œç”¨æˆ·å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹åˆ†æç»“æœ

ä½¿ç”¨è¯­æ³•ï¼š`jhat <options> <dumpfile>`

options å‚æ•°ï¼š

* -stack falseï½œtrueï¼šå…³é—­ï½œæ‰“å¼€å¯¹è±¡åˆ†é…è°ƒç”¨æ ˆè·Ÿè¸ª
* -refs falseï½œtrueï¼šå…³é—­ï½œæ‰“å¼€å¯¹è±¡å¼•ç”¨è·Ÿè¸ª
* -port port-numberï¼šè®¾ç½® jhat HTTP Server çš„ç«¯å£å·ï¼Œé»˜è®¤ 7000
* -exclude exclude-fileï¼šæ‰§è¡Œå¯¹è±¡æŸ¥è¯¢æ—¶éœ€è¦æ’é™¤çš„æ•°æ®æˆå‘˜
* -baseline exclude-fileï¼šæŒ‡å®šä¸€ä¸ªåŸºå‡†å †è½¬å‚¨
* -debug intï¼šè®¾ç½® debug çº§åˆ«
* -versionï¼šå¯åŠ¨åæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯å°±é€€å‡º
* -J <flag>ï¼šä¼ å…¥å¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚ -J-Xmx512m



è¯´æ˜ï¼šjhat å‘½ä»¤åœ¨ JDK9ã€JDK10 ä¸­å·²ç»è¢«åˆ é™¤ï¼Œå®˜æ–¹å»ºè®®ç”¨ VisualVM ä»£æ›¿



****



#### jstack

jstackï¼ˆJVM Stack Traceï¼‰ï¼šç”¨äºç”Ÿæˆè™šæ‹ŸæœºæŒ‡å®šè¿›ç¨‹å½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ï¼ˆè™šæ‹Ÿæœºå †æ ˆè·Ÿè¸ªï¼‰ï¼Œçº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æŒ‡å®šè¿›ç¨‹çš„æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆ

çº¿ç¨‹å¿«ç…§çš„ä½œç”¨ï¼šå¯ç”¨äºå®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œå¦‚çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´ç­‰å¾…ç­‰é—®é¢˜ï¼Œç”¨ jstack æ˜¾ç¤ºå„ä¸ªçº¿ç¨‹è°ƒç”¨çš„å †æ ˆæƒ…å†µ

ä½¿ç”¨è¯­æ³•ï¼š`jstack [options] pid`

options å‚æ•°ï¼š

* -Fï¼šå½“æ­£å¸¸è¾“å‡ºçš„è¯·æ±‚ä¸è¢«å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆ
* -lï¼šé™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºé”çš„é™„åŠ ä¿¡æ¯
* -mï¼šå¦‚æœè°ƒç”¨æœ¬åœ°æ–¹æ³•çš„è¯ï¼Œå¯ä»¥æ˜¾ç¤º C/C++ çš„å †æ ˆ

åœ¨ thread dump ä¸­çš„å‡ ç§çŠ¶æ€ï¼š

- æ­»é”ï¼šDeadlock

- ç­‰å¾…èµ„æºï¼šWaiting on condition

- ç­‰å¾…è·å–ç›‘è§†å™¨ï¼šWaiting on monitor entry

- é˜»å¡ï¼šBlocked

- æ‰§è¡Œä¸­ï¼šRunnable

- æš‚åœï¼šSuspended

- å¯¹è±¡ç­‰å¾…ä¸­ï¼šObject.wait() æˆ– TIMEDï¼¿WAITING

- åœæ­¢ï¼Œï¼šParked



****



#### jcmd

jcmd æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥å®ç°å‰é¢é™¤äº† jstat ä¹‹å¤–æ‰€æœ‰å‘½ä»¤çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ dumpã€å†…å­˜ä½¿ç”¨ã€æŸ¥çœ‹ Java è¿›ç¨‹ã€å¯¼å‡ºçº¿ç¨‹ä¿¡æ¯ã€æ‰§è¡Œ GCã€JVM è¿è¡Œæ—¶é—´ç­‰

jcmd -lï¼šåˆ—å‡ºæ‰€æœ‰çš„JVMè¿›ç¨‹

jcmd è¿›ç¨‹å· helpï¼šé’ˆå¯¹æŒ‡å®šçš„è¿›ç¨‹ï¼Œåˆ—å‡ºæ”¯æŒçš„æ‰€æœ‰å…·ä½“å‘½ä»¤

* Thread.printï¼šå¯ä»¥æ›¿æ¢ jstack æŒ‡ä»¤

- GC.class_histogramï¼šå¯ä»¥æ›¿æ¢ jmap ä¸­çš„ -histo æ“ä½œ

- GC.heap_dumpï¼šå¯ä»¥æ›¿æ¢ jmap ä¸­çš„ -dump æ“ä½œ

- GC.runï¼šå¯ä»¥æŸ¥çœ‹GCçš„æ‰§è¡Œæƒ…å†µ

- VM.uptimeï¼šå¯ä»¥æŸ¥çœ‹ç¨‹åºçš„æ€»æ‰§è¡Œæ—¶é—´ï¼Œå¯ä»¥æ›¿æ¢ jstat æŒ‡ä»¤ä¸­çš„ -t  æ“ä½œ

- VM.system_propertiesï¼šå¯ä»¥æ›¿æ¢ jinfo -sysprops è¿›ç¨‹ id

- VM.flagsï¼šå¯ä»¥è·å– JVM çš„é…ç½®å‚æ•°ä¿¡æ¯



****



#### jstatd

jstatd æ˜¯ä¸€ä¸ª RMI æœåŠ¡ç«¯ç¨‹åºï¼Œç›¸å½“äºä»£ç†æœåŠ¡å™¨ï¼Œå»ºç«‹æœ¬åœ°è®¡ç®—æœºä¸è¿œç¨‹ç›‘æ§å·¥å…·çš„é€šä¿¡ï¼Œjstatd æœåŠ¡å™¨å°†æœ¬æœºçš„ Java åº”ç”¨ç¨‹åºä¿¡æ¯ä¼ é€’åˆ°è¿œç¨‹è®¡ç®—æœº

è¿œç¨‹ä¸»æœºä¿¡æ¯æ”¶é›†ï¼Œå‰é¢çš„æŒ‡ä»¤åªæ¶‰åŠåˆ°ç›‘æ§æœ¬æœºçš„ Java åº”ç”¨ç¨‹åºï¼Œè€Œåœ¨è¿™äº›å·¥å…·ä¸­ï¼Œä¸€äº›ç›‘æ§å·¥å…·ä¹Ÿæ”¯æŒå¯¹è¿œç¨‹è®¡ç®—æœºçš„ç›‘æ§ï¼ˆå¦‚ jpsã€jstatï¼‰ï¼Œä¸ºäº†å¯ç”¨è¿œç¨‹ç›‘æ§ï¼Œåˆ™éœ€è¦é…åˆä½¿ç”¨ jstatd å·¥å…·ã€‚

![](https://gitee.com/seazean/images/raw/master/Java/JVM-jstatdå›¾è§£.png)



****





### GUIå·¥å…·

å·¥å…·çš„ä½¿ç”¨æ­¤å¤„ä¸å†å¤šè¨€ï¼Œæ¨èä¸€ä¸ªå†™çš„éå¸¸å¥½çš„æ–‡ç« ï¼ŒJVM è°ƒä¼˜éƒ¨åˆ†çš„ç¬”è®°å…¨éƒ¨å‚è€ƒæ­¤æ–‡ç« ç¼–å†™ã€‚

è§†é¢‘é“¾æ¥ï¼šhttps://www.bilibili.com/video/BV1PJ411n7xZ?p=304

æ–‡ç« é“¾æ¥ï¼šhttps://www.yuque.com/u21195183/jvm/lv1zot





****



### è¿è¡Œå‚æ•°

#### å‚æ•°é€‰é¡¹

æ·»åŠ  JVM å‚æ•°é€‰é¡¹ï¼šè¿›å…¥ Run/Debug Configurations â†’ VM options è®¾ç½®å‚æ•°

* æ ‡å‡†å‚æ•°é€‰é¡¹ï¼š`java [-options] class [args...]` æˆ– `java [-options] -jar jarfile [args...]`

  å‘½ä»¤ï¼š`-? -help` å¯ä»¥è¾“å‡ºæ­¤å‘½ä»¤çš„ç›¸å…³é€‰é¡¹

  ```sh
  C:\Users\Seazean>java -version
  java version "1.8.0_221"
  Java(TM) SE Runtime Environment (build 1.8.0_221-b11)
  Java HotSpot(TM) 64-Bit Server VM (build 25.221-b11, mixed mode)
  # mixed mode å­—æ ·ï¼Œä»£è¡¨å½“å‰ç³»ç»Ÿä½¿ç”¨çš„æ˜¯æ··åˆæ¨¡å¼
  ```

  Hotspot JVM æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ Server å’Œ Clientï¼Œåˆ†åˆ«é€šè¿‡ -server å’Œ- client è®¾ç½®æ¨¡å¼ï¼š

  - 32 ä½ç³»ç»Ÿä¸Šï¼Œé»˜è®¤ä½¿ç”¨ Client ç±»å‹çš„ JVMï¼Œè¦ä½¿ç”¨ Server æ¨¡å¼ï¼Œæœºå™¨é…ç½®è‡³å°‘æœ‰ 2 ä¸ªä»¥ä¸Šçš„å†…æ ¸å’Œ 2G ä»¥ä¸Šçš„ç‰©ç†å†…å­˜ï¼ŒClient æ¨¡å¼é€‚ç”¨äºå¯¹å†…å­˜è¦æ±‚è¾ƒå°çš„æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œé»˜è®¤ä½¿ç”¨ Serial ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨

  - 64 ä½ç³»ç»Ÿä¸Šï¼Œåªæ”¯æŒ Server æ¨¡å¼çš„ JVMï¼Œé€‚ç”¨äºéœ€è¦å¤§å†…å­˜çš„åº”ç”¨ç¨‹åºï¼Œé»˜è®¤ä½¿ç”¨å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨

* -X å‚æ•°é€‰é¡¹ï¼š

  ```sh
  -Xmixed           æ··åˆæ¨¡å¼æ‰§è¡Œ (é»˜è®¤)
  -Xint             ä»…è§£é‡Šæ¨¡å¼æ‰§è¡Œ
  -Xbootclasspath:<ç”¨;åˆ†éš”çš„ç›®å½•å’Œzip/jaræ–‡ä»¶>è®¾ç½®æœç´¢è·¯å¾„ä»¥å¼•å¯¼ç±»å’Œèµ„æº
  -Xbootclasspath/a:<ç”¨;åˆ†éš”çš„ç›®å½•å’Œzip/jaræ–‡ä»¶>é™„åŠ åœ¨å¼•å¯¼ç±»è·¯å¾„æœ«å°¾
  -Xbootclasspath/p:<ç”¨;åˆ†éš”çš„ç›®å½•å’Œzip/jaræ–‡ä»¶>ç½®äºå¼•å¯¼ç±»è·¯å¾„ä¹‹å‰
  -Xdiag            æ˜¾ç¤ºé™„åŠ è¯Šæ–­æ¶ˆæ¯
  -Xnoclassgc       ç¦ç”¨ç±»åƒåœ¾æ”¶é›†
  -Xincgc           å¯ç”¨å¢é‡åƒåœ¾æ”¶é›†
  -Xloggc:<file>    å°† GC çŠ¶æ€è®°å½•åœ¨æ–‡ä»¶ä¸­ (å¸¦æ—¶é—´æˆ³)
  -Xbatch           ç¦ç”¨åå°ç¼–è¯‘
  -Xprof            è¾“å‡º cpu é…ç½®æ–‡ä»¶æ•°æ®
  -Xfuture          å¯ç”¨æœ€ä¸¥æ ¼çš„æ£€æŸ¥, é¢„æœŸå°†æ¥çš„é»˜è®¤å€¼
  -Xrs              å‡å°‘ Java/VM å¯¹æ“ä½œç³»ç»Ÿä¿¡å·çš„ä½¿ç”¨ (è¯·å‚é˜…æ–‡æ¡£)
  -Xcheck:jni       å¯¹ JNI å‡½æ•°æ‰§è¡Œå…¶ä»–æ£€æŸ¥
  -Xshare:off       ä¸å°è¯•ä½¿ç”¨å…±äº«ç±»æ•°æ®
  -Xshare:auto      åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨å…±äº«ç±»æ•°æ® (é»˜è®¤)
  -Xshare:on        è¦æ±‚ä½¿ç”¨å…±äº«ç±»æ•°æ®, å¦åˆ™å°†å¤±è´¥ã€‚
  -XshowSettings    æ˜¾ç¤ºæ‰€æœ‰è®¾ç½®å¹¶ç»§ç»­
  -XshowSettings:all			æ˜¾ç¤ºæ‰€æœ‰è®¾ç½®å¹¶ç»§ç»­
  -XshowSettings:vm 			æ˜¾ç¤ºæ‰€æœ‰ä¸ vm ç›¸å…³çš„è®¾ç½®å¹¶ç»§ç»­
  -XshowSettings:properties	æ˜¾ç¤ºæ‰€æœ‰å±æ€§è®¾ç½®å¹¶ç»§ç»­
  -XshowSettings:locale		æ˜¾ç¤ºæ‰€æœ‰ä¸åŒºåŸŸè®¾ç½®ç›¸å…³çš„è®¾ç½®å¹¶ç»§ç»­
  ```

* -XX å‚æ•°é€‰é¡¹ï¼š

  ```sh
  #Booleanç±»å‹æ ¼å¼
  -XX:+<option>  			å¯ç”¨optionå±æ€§
  -XX:-<option>  			ç¦ç”¨optionå±æ€§
  #éBooleanç±»å‹æ ¼å¼
  -XX:<option>=<number>  	è®¾ç½®optionæ•°å€¼ï¼Œå¯ä»¥å¸¦å•ä½å¦‚k/K/m/M/g/G
  -XX:<option>=<string>  	è®¾ç½®optionå­—ç¬¦å€¼
  ```


ç¨‹åºè¿è¡Œä¸­ï¼š

```sh
# è®¾ç½®Booleanç±»å‹å‚æ•°
jinfo -flag [+|-]<name> <pid>
# è®¾ç½®éBooleanç±»å‹å‚æ•°
jinfo -flag <name>=<value> <pid>
```



****



#### æ‰“å°å‚æ•°

```sh
-XX:+PrintCommandLineFlags 	ç¨‹åºè¿è¡Œæ—¶JVMé»˜è®¤è®¾ç½®æˆ–ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„XXé€‰é¡¹
-XX:+PrintFlagsInitial 		æ‰“å°æ‰€æœ‰XXé€‰é¡¹çš„é»˜è®¤å€¼
-XX:+PrintFlagsFinal 		æ‰“å°æ‰€æœ‰XXé€‰é¡¹çš„å®é™…å€¼
-XX:+PrintVMOptions 		æ‰“å°JVMçš„å‚æ•°
```



***



#### å†…å­˜å‚æ•°

```sh
# æ ˆ
-Xss128k <==> -XX:ThreadStackSize=128k 		è®¾ç½®çº¿ç¨‹æ ˆçš„å¤§å°ä¸º128K

# å †
-Xms2048m <==> -XX:InitialHeapSize=2048m 	è®¾ç½®JVMåˆå§‹å †å†…å­˜ä¸º2048Mï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼‰
-Xmx2048m <==> -XX:MaxHeapSize=2048m 		è®¾ç½®JVMæœ€å¤§å †å†…å­˜ä¸º2048Mï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼‰
-Xmn2g <==> -XX:NewSize=2g -XX:MaxNewSize=2g è®¾ç½®å¹´è½»ä»£å¤§å°ä¸º2G
-XX:SurvivorRatio=8 						è®¾ç½®EdenåŒºä¸SurvivoråŒºçš„æ¯”å€¼ï¼Œé»˜è®¤ä¸º8
-XX:NewRatio=2 								è®¾ç½®è€å¹´ä»£ä¸å¹´è½»ä»£çš„æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º2
-XX:+UseAdaptiveSizePolicy 					è®¾ç½®å¤§å°æ¯”ä¾‹è‡ªé€‚åº”ï¼Œé»˜è®¤å¼€å¯
-XX:PretenureSizeThreadshold=1024 			è®¾ç½®è®©å¤§äºæ­¤é˜ˆå€¼çš„å¯¹è±¡ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ï¼Œ
												åªå¯¹Serialã€ParNewæ”¶é›†å™¨æœ‰æ•ˆ
-XX:MaxTenuringThreshold=15 				è®¾ç½®æ–°ç”Ÿä»£æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é™åˆ¶ï¼Œé»˜è®¤ä¸º15
-XX:TargetSurvivorRatio 					è®¾ç½®MinorGCç»“æŸåSurvivoråŒºå ç”¨ç©ºé—´çš„æœŸæœ›æ¯”ä¾‹

# æ–¹æ³•åŒº
-XX:MetaspaceSize / -XX:PermSize=256m 		è®¾ç½®å…ƒç©ºé—´/æ°¸ä¹…ä»£åˆå§‹å€¼ä¸º256M
-XX:MaxMetaspaceSize / -XX:MaxPermSize=256m è®¾ç½®å…ƒç©ºé—´/æ°¸ä¹…ä»£æœ€å¤§å€¼ä¸º256M
-XX:+UseCompressedOops 						ä½¿ç”¨å‹ç¼©å¯¹è±¡
-XX:+UseCompressedClassPointers 			ä½¿ç”¨å‹ç¼©ç±»æŒ‡é’ˆ
-XX:CompressedClassSpaceSize 				è®¾ç½®Klass Metaspaceçš„å¤§å°ï¼Œé»˜è®¤1G

# ç›´æ¥å†…å­˜
-XX:MaxDirectMemorySize 					æŒ‡å®šDirectMemoryå®¹é‡ï¼Œé»˜è®¤ç­‰äºJavaå †æœ€å¤§å€¼
```

è¯´æ˜ï¼šå‚æ•°å‰é¢æ˜¯`+`å·è¯´æ˜æ˜¯å¼€å¯ï¼Œå¦‚æœæ˜¯`- `å·è¯´æ˜æ˜¯å…³é—­



****



#### OOMå‚æ•°

```sh
-XX:+HeapDumpOnOutMemoryError 	å†…å­˜å‡ºç°OOMæ—¶ç”ŸæˆHeapè½¬å‚¨æ–‡ä»¶ï¼Œä¸¤è€…äº’æ–¥
-XX:+HeapDumpBeforeFullGC 		å‡ºç°FullGCæ—¶ç”ŸæˆHeapè½¬å‚¨æ–‡ä»¶ï¼Œä¸¤è€…äº’æ–¥
-XX:HeapDumpPath=<path> 		æŒ‡å®šheapè½¬å‚¨æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤å½“å‰ç›®å½•
-XX:OnOutOfMemoryError=<path> 	æŒ‡å®šå¯è¡Œæ€§ç¨‹åºæˆ–è„šæœ¬çš„è·¯å¾„ï¼Œå½“å‘ç”ŸOOMæ—¶æ‰§è¡Œè„šæœ¬
```



***



#### æ—¥å¿—å‚æ•°

```sh
-XX:+PrintGC <==> -verbose:gc  	æ‰“å°ç®€è¦æ—¥å¿—ä¿¡æ¯
-XX:+PrintGCDetails            	æ‰“å°è¯¦ç»†æ—¥å¿—ä¿¡æ¯
-XX:+PrintGCTimeStamps  		æ‰“å°ç¨‹åºå¯åŠ¨åˆ°GCå‘ç”Ÿçš„æ—¶é—´ï¼Œæ­é…-XX:+PrintGCDetailsä½¿ç”¨
-XX:+PrintGCDateStamps  		æ‰“å°GCå‘ç”Ÿæ—¶çš„æ—¶é—´æˆ³ï¼Œæ­é…-XX:+PrintGCDetailsä½¿ç”¨
-XX:+PrintHeapAtGC 			 	æ‰“å°GCå‰åçš„å †ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾
-Xloggc:<file> 					è¾“å‡ºGCå¯¼æŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶ä¸­
-XX:+TraceClassLoading  		ç›‘æ§ç±»çš„åŠ è½½
-XX:+PrintTenuringDistribution	æ‰“å°JVMåœ¨æ¯æ¬¡MinorGCåå½“å‰ä½¿ç”¨çš„Survivorä¸­å¯¹è±¡çš„å¹´é¾„åˆ†å¸ƒ
-XX:+PrintGCApplicationStoppedTime  	æ‰“å°GCæ—¶çº¿ç¨‹çš„åœé¡¿æ—¶é—´
-XX:+PrintGCApplicationConcurrentTime  	æ‰“å°åƒåœ¾æ”¶é›†ä¹‹å‰åº”ç”¨æœªä¸­æ–­çš„æ‰§è¡Œæ—¶é—´
-XX:+PrintReferenceGC 					æ‰“å°å›æ”¶äº†å¤šå°‘ç§ä¸åŒå¼•ç”¨ç±»å‹çš„å¼•ç”¨
-XX:+UseGCLogFileRotation 				å¯ç”¨GCæ—¥å¿—æ–‡ä»¶çš„è‡ªåŠ¨è½¬å‚¨
-XX:NumberOfGCLogFiles=1  				è®¾ç½®GCæ—¥å¿—æ–‡ä»¶çš„å¾ªç¯æ•°ç›®
-XX:GCLogFileSize=1M  					è®¾ç½®GCæ—¥å¿—æ–‡ä»¶çš„å¤§å°
```



***



#### å…¶ä»–å‚æ•°

```sh
-XX:+DisableExplicitGC  	ç¦ç”¨hotspotæ‰§è¡ŒSystem.gc()ï¼Œé»˜è®¤ç¦ç”¨
-XX:+DoEscapeAnalysis  		å¼€å¯é€ƒé€¸åˆ†æ
-XX:+UseBiasedLocking  		å¼€å¯åå‘é”
-XX:+UseLargePages  		å¼€å¯ä½¿ç”¨å¤§é¡µé¢
-XX:+PrintTLAB  			æ‰“å°TLABçš„ä½¿ç”¨æƒ…å†µ
-XX:TLABSize  				è®¾ç½®TLABå¤§å°
-XX:ReservedCodeCacheSize=<n>[g|m|k]ã€-XX:InitialCodeCacheSize=<n>[g|m|k] æŒ‡å®šä»£ç ç¼“å­˜å¤§å°
-XX:+UseCodeCacheFlushing  	æ”¾å¼ƒä¸€äº›è¢«ç¼–è¯‘çš„ä»£ç ï¼Œé¿å…ä»£ç ç¼“å­˜è¢«å æ»¡æ—¶JVMåˆ‡æ¢åˆ°interpreted-onlyçš„æƒ…å†µ
```



****



#### ä»£ç è·å–

Java æä¾›äº† java.lang.management åŒ…ç”¨äºç›‘è§†å’Œç®¡ç† Java è™šæ‹Ÿæœºå’Œ Java è¿è¡Œæ—¶ä¸­çš„å…¶ä»–ç»„ä»¶ï¼Œå…è®¸æœ¬åœ°æˆ–è¿œç¨‹ç›‘æ§å’Œç®¡ç†è¿è¡Œçš„ Java è™šæ‹Ÿæœºã€‚ManagementFactory ç±»è¾ƒä¸ºå¸¸ç”¨ï¼ŒRuntime ç±»å¯è·å–å†…å­˜ã€CPU æ ¸æ•°ç­‰ç›¸å…³çš„æ•°æ®ï¼Œé€šè¿‡ä½¿ç”¨è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥ç›‘æ§åº”ç”¨æœåŠ¡å™¨çš„å †å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè®¾ç½®ä¸€äº›é˜ˆå€¼è¿›è¡ŒæŠ¥è­¦ç­‰å¤„ç†

```java
public class MemoryMonitor {
    public static void main(String[] args) {
        MemoryMXBean memorymbean = ManagementFactory.getMemoryMXBean();
        MemoryUsage usage = memorymbean.getHeapMemoryUsage();
        System.out.println("INIT HEAP: " + usage.getInit() / 1024 / 1024 + "m");
        System.out.println("MAX HEAP: " + usage.getMax() / 1024 / 1024 + "m");
        System.out.println("USE HEAP: " + usage.getUsed() / 1024 / 1024 + "m");
        System.out.println("\nFull Information:");
        System.out.println("Heap Memory Usage: " + memorymbean.getHeapMemoryUsage());
        System.out.println("Non-Heap Memory Usage: " + memorymbean.getNonHeapMemoryUsage());

        System.out.println("====é€šè¿‡javaæ¥è·å–ç›¸å…³ç³»ç»ŸçŠ¶æ€====");
        System.out.println("å½“å‰å †å†…å­˜å¤§å°totalMemory " + (int) Runtime.getRuntime().totalMemory() / 1024 / 1024 + "m");// å½“å‰å †å†…å­˜å¤§å°
        System.out.println("ç©ºé—²å †å†…å­˜å¤§å°freeMemory " + (int) Runtime.getRuntime().freeMemory() / 1024 / 1024 + "m");// ç©ºé—²å †å†…å­˜å¤§å°
        System.out.println("æœ€å¤§å¯ç”¨æ€»å †å†…å­˜maxMemory " + Runtime.getRuntime().maxMemory() / 1024 / 1024 + "m");// æœ€å¤§å¯ç”¨æ€»å †å†…å­˜å¤§å°

    }
}
```





****



### æ—¥å¿—åˆ†æ

#### æ—¥å¿—åˆ†ç±»

HotSpot VM çš„ GC æŒ‰ç…§å›æ”¶åŒºåŸŸåˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç§æ˜¯éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œä¸€ç§æ˜¯æ•´å †æ”¶é›†ï¼ˆFull GCï¼‰

- éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ª Java å †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­åˆåˆ†ä¸ºï¼š 
  - æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC/Young GCï¼‰ï¼šåªæ˜¯æ–°ç”Ÿä»£ï¼ˆEden/S0ã€S1ï¼‰çš„åƒåœ¾æ”¶é›†
  - è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC/Old GCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œåªæœ‰ CMS GC ä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸º

-  æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œåªæœ‰ G1 GC ä¼šæœ‰è¿™ç§è¡Œä¸º 

-  æ•´å †æ”¶é›†ï¼ˆFull GCï¼‰ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ã€‚

Minor GC/Young GC æ—¥å¿—ï¼š

```sh
[GC (Allocation Failure) [PSYoungGen: 31744K->2192K (36864K) ] 31744K->2200K (121856K), 0.0139308 secs] [Times: user=0.05 sys=0.01, real=0.01 secs]
```

Full GC æ—¥å¿—ï¼š

```sh
[Full GC (Metadata GC Threshold) [PSYoungGen: 5104K->0K (132096K) ] [Par01dGen: 416K->5453K (50176K) ]5520K->5453K (182272K), [Metaspace: 20637K->20637K (1067008K) ], 0.0245883 secs] [Times: user=0.06 sys=0.00, real=0.02 secs]
```



****



#### æ—¥å¿—è§£æ

é€šè¿‡æ—¥å¿—çœ‹åƒåœ¾æ”¶é›†å™¨ï¼š

-  Serial æ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ˜¾ç¤º `[DefNew`ï¼Œå³ `Default New Generation`

-  ParNew æ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ˜¾ç¤º `[ParNew`ï¼Œå³ `Parallel New Generation`

-  Parallel Scavenge æ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ˜¾ç¤º `[PSYoungGen`ï¼ŒJDK1.7 ä½¿ç”¨çš„ PSYoungGen 

-  Parallel Old æ”¶é›†å™¨ï¼šè€å¹´ä»£æ˜¾ç¤º `[ParoldGen`

-  G1 æ”¶é›†å™¨ï¼šæ˜¾ç¤º `garbage-first heap`

é€šè¿‡æ—¥å¿—çœ‹ GC åŸå› ï¼š

- Allocation Failureï¼šè¡¨æ˜æœ¬æ¬¡å¼•èµ· GC çš„åŸå› æ˜¯å› ä¸ºæ–°ç”Ÿä»£ä¸­æ²¡æœ‰è¶³å¤Ÿçš„åŒºåŸŸå­˜æ”¾éœ€è¦åˆ†é…çš„æ•°æ®

- Metadata GCThresholdï¼šMetaspace åŒºä¸è¶³

- FErgonomicsï¼šJVM è‡ªé€‚åº”è°ƒæ•´å¯¼è‡´çš„ GC

- Systemï¼šè°ƒç”¨äº† System.gc() æ–¹æ³•

é€šè¿‡æ—¥å¿—çœ‹ GC å‰åæƒ…å†µï¼šGC å‰å†…å­˜å ç”¨ -> GC åå†…å­˜å ç”¨ï¼ˆè¯¥åŒºåŸŸå†…å­˜æ€»å¤§å°ï¼‰

```sh
[PSYoungGen: 5986K->696K (8704K)] 5986K->704K (9216K)
```

-  ä¸­æ‹¬å·å†…ï¼šGC å›æ”¶å‰å¹´è½»ä»£å †å¤§å° -> å›æ”¶åå¤§å°ï¼ˆå¹´è½»ä»£å †æ€»å¤§å°ï¼‰ 

-  æ‹¬å·å¤–ï¼šGC å›æ”¶å‰å¹´è½»ä»£å’Œè€å¹´ä»£å¤§å° -> å›æ”¶åå¤§å°ï¼ˆå¹´è½»ä»£å’Œè€å¹´ä»£æ€»å¤§å°ï¼‰ 

* Minor GC å †å†…å­˜æ€»å®¹é‡ = 9/10 å¹´è½»ä»£ + è€å¹´ä»£ï¼ŒSurvivor åŒºåªè®¡ç®— from éƒ¨åˆ†ï¼Œè€Œ JVM é»˜è®¤å¹´è½»ä»£ä¸­ Eden åŒºå’Œ Survivor åŒºçš„æ¯”ä¾‹å…³ç³»ï¼šEden:S0:S1=8:1:1

é€šè¿‡æ—¥å¿—çœ‹ GC æ—¶é—´ï¼šGC æ—¥å¿—ä¸­æœ‰ä¸‰ä¸ªæ—¶é—´ userã€sysã€real

- userï¼šè¿›ç¨‹æ‰§è¡Œç”¨æˆ·æ€ä»£ç ï¼ˆæ ¸å¿ƒä¹‹å¤–ï¼‰æ‰€ä½¿ç”¨çš„æ—¶é—´ï¼Œè¿™æ˜¯æ‰§è¡Œæ­¤è¿›ç¨‹æ‰€ä½¿ç”¨çš„å®é™… CPU æ—¶é—´ï¼Œå…¶ä»–è¿›ç¨‹å’Œæ­¤è¿›ç¨‹é˜»å¡çš„æ—¶é—´å¹¶ä¸åŒ…æ‹¬åœ¨å†…ï¼Œåœ¨åƒåœ¾æ”¶é›†çš„æƒ…å†µä¸‹ï¼Œè¡¨ç¤º GC çº¿ç¨‹æ‰§è¡Œæ‰€ä½¿ç”¨çš„ CPU æ€»æ—¶é—´ã€‚

- sysï¼šè¿›ç¨‹åœ¨å†…æ ¸æ€æ¶ˆè€—çš„ CPU æ—¶é—´ï¼Œå³åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–ç­‰å¾…ç³»ç»Ÿäº‹ä»¶æ‰€ä½¿ç”¨çš„ CPU æ—¶é—´

- realï¼šç¨‹åºä»å¼€å§‹åˆ°ç»“æŸæ‰€ç”¨çš„æ—¶é’Ÿæ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´åŒ…æ‹¬å…¶ä»–è¿›ç¨‹ä½¿ç”¨çš„æ—¶é—´ç‰‡å’Œè¿›ç¨‹é˜»å¡çš„æ—¶é—´ï¼ˆæ¯”å¦‚ç­‰å¾… I/O å®Œæˆï¼‰ï¼Œå¯¹äºå¹¶è¡Œ GCï¼Œè¿™ä¸ªæ•°å­—åº”è¯¥æ¥è¿‘ï¼ˆç”¨æˆ·æ—¶é—´ï¼‹ç³»ç»Ÿæ—¶é—´ï¼‰é™¤ä»¥åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨çš„çº¿ç¨‹æ•°

ç”±äºå¤šæ ¸çš„åŸå› ï¼Œä¸€èˆ¬çš„ GC äº‹ä»¶ä¸­ï¼Œreal time å°äº sys timeï¼‹user timeï¼Œå› ä¸ºæ˜¯å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„å»åš GCã€‚å¦‚æœ realï¼sysï¼‹user çš„è¯ï¼Œåˆ™è¯´æ˜ IO è´Ÿè½½éå¸¸é‡æˆ– CPU ä¸å¤Ÿç”¨



****



#### åˆ†æå·¥å…·

GCEasy æ˜¯ä¸€æ¬¾åœ¨çº¿çš„GCæ—¥å¿—åˆ†æå™¨ï¼Œå¯ä»¥é€šè¿‡ GC æ—¥å¿—åˆ†æè¿›è¡Œå†…å­˜æ³„éœ²æ£€æµ‹ã€GC æš‚åœåŸå› åˆ†æã€JVM é…ç½®å»ºè®®ä¼˜åŒ–ç­‰åŠŸèƒ½ï¼Œå¤§å¤šæ•°åŠŸèƒ½æ˜¯å…è´¹çš„

* å®˜ç½‘åœ°å€ï¼šhttps://gceasy.io/

GCViewer æ˜¯ä¸€æ¬¾ç¦»çº¿çš„ GC æ—¥å¿—åˆ†æå™¨ï¼Œç”¨äºå¯è§†åŒ– Java VM é€‰é¡¹ -verbose:gc å’Œ .NET ç”Ÿæˆçš„æ•°æ® -Xloggc:<file>ï¼Œè¿˜å¯ä»¥è®¡ç®—ä¸åƒåœ¾å›æ”¶ç›¸å…³çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆååé‡ã€ç´¯ç§¯çš„æš‚åœã€æœ€é•¿çš„æš‚åœç­‰ï¼‰ï¼Œå½“é€šè¿‡æ›´æ”¹ä¸–ä»£å¤§å°æˆ–è®¾ç½®åˆå§‹å †å¤§å°æ¥è°ƒæ•´ç‰¹å®šåº”ç”¨ç¨‹åºçš„åƒåœ¾å›æ”¶æ—¶ï¼Œæ­¤åŠŸèƒ½éå¸¸æœ‰ç”¨

* æºç ä¸‹è½½ï¼šhttps://github.com/chewiebug/GCViewer

* è¿è¡Œç‰ˆæœ¬ä¸‹è½½ï¼šhttps://github.com/chewiebug/GCViewer/wiki/Changelog



å‚è€ƒæ–‡ç« ï¼šhttps://www.yuque.com/u21195183/jvm/ukmb3k





***





# ALG

## é€’å½’

### æ¦‚è¿°

ç®—æ³•ï¼šè§£é¢˜æ–¹æ¡ˆçš„å‡†ç¡®è€Œå®Œæ•´çš„æè¿°ï¼Œæ˜¯ä¸€ç³»åˆ—è§£å†³é—®é¢˜çš„æ¸…æ™°æŒ‡ä»¤ï¼Œä»£è¡¨ç€ç”¨ç³»ç»Ÿçš„æ–¹æ³•è§£å†³é—®é¢˜çš„ç­–ç•¥æœºåˆ¶

é€’å½’ï¼šç¨‹åºè°ƒç”¨è‡ªèº«çš„ç¼–ç¨‹æŠ€å·§

é€’å½’ï¼š

* ç›´æ¥é€’å½’ï¼šè‡ªå·±çš„æ–¹æ³•è°ƒç”¨è‡ªå·±
* é—´æ¥é€’å½’ï¼šè‡ªå·±çš„æ–¹æ³•è°ƒç”¨åˆ«çš„æ–¹æ³•ï¼Œåˆ«çš„æ–¹æ³•åˆè°ƒç”¨è‡ªå·±

é€’å½’å¦‚æœæ§åˆ¶çš„ä¸æ°å½“ï¼Œä¼šå½¢æˆé€’å½’çš„æ­»å¾ªç¯ï¼Œä»è€Œå¯¼è‡´æ ˆå†…å­˜æº¢å‡ºé”™è¯¯



æ¨èé˜…è¯»ï¼šhttps://time.geekbang.org/column/article/41440

å‚è€ƒä¹¦ç±ï¼šã€Šæ•°æ®ç»“æ„é«˜åˆ†ç¬”è®°ã€‹



***



### ç®—æ³•

#### æ ¸å¿ƒæ€æƒ³

é€’å½’çš„ä¸‰è¦ç´ ï¼ˆç†è®ºï¼‰ï¼š

1. é€’å½’çš„ç»ˆç»“ç‚¹
2. é€’å½’çš„å…¬å¼
3. é€’å½’çš„æ–¹å‘ï¼šå¿…é¡»èµ°å‘ç»ˆç»“ç‚¹

```java
//f(x)=f(x-1)+1;   f(1)=1;    f(10)=?
//1.é€’å½’çš„ç»ˆç»“ç‚¹ï¼š f(1)  = 1
//2.é€’å½’çš„å…¬å¼ï¼šf(x) = f(x - 1) + 1
//3.é€’å½’çš„æ–¹å‘ï¼šå¿…é¡»èµ°å‘ç»ˆç»“ç‚¹
public static int f(int x){
    if(x == 1){
        return 1;
    }else{
        return f(x-1) + 1;
    }
}
```



***



#### å…¬å¼è½¬æ¢

```java
//å·²çŸ¥ï¼š f(x) = f(x + 1) + 2,  f(1) = 1ã€‚æ±‚ï¼šf(10) = ?
//å…¬å¼è½¬æ¢
//f(x-1)=f(x-1+1)+2 => f(x)=f(x-1)+2
//ï¼ˆ1ï¼‰é€’å½’çš„å…¬å¼ï¼š   f(n) = f(n-1)- 2 ;
//ï¼ˆ2ï¼‰é€’å½’çš„ç»ˆç»“ç‚¹ï¼š  f(1) = 1
//ï¼ˆ3ï¼‰é€’å½’çš„æ–¹å‘ï¼šå¿…é¡»èµ°å‘ç»ˆç»“ç‚¹ã€‚
public static int f(int n){
    if(n == 1){
        return 1;
    }else{
        return f(n-1) - 2;
    }
}
```



#### æ³¨æ„äº‹é¡¹

ä»¥ä¸Šç†è®ºåªèƒ½é’ˆå¯¹äº**è§„å¾‹åŒ–é€’å½’**ï¼Œå¦‚æœæ˜¯éè§„å¾‹åŒ–æ˜¯ä¸èƒ½å¥—ç”¨ä»¥ä¸Šå…¬å¼çš„ï¼
éè§„å¾‹åŒ–é€’å½’çš„é—®é¢˜ï¼šæ–‡ä»¶æœç´¢ï¼Œå•¤é…’é—®é¢˜ã€‚



***



### åº”ç”¨

#### çŒ´å­åƒæ¡ƒ

çŒ´å­ç¬¬ä¸€å¤©æ‘˜äº†è‹¥å¹²ä¸ªæ¡ƒå­ï¼Œå½“å³åƒäº†ä¸€åŠï¼Œè§‰å¾—å¥½ä¸è¿‡ç˜¾ï¼Œç„¶ååˆå¤šåƒäº†ä¸€ä¸ªã€‚ç¬¬äºŒå¤©åˆåƒäº†å‰ä¸€å¤©å‰©ä¸‹çš„ä¸€åŠï¼Œè§‰å¾—å¥½ä¸è¿‡ç˜¾ï¼Œç„¶ååˆå¤šåƒäº†ä¸€ä¸ªã€‚ä»¥åæ¯å¤©éƒ½æ˜¯å¦‚æ­¤ã€‚ç­‰åˆ°ç¬¬åå¤©å†åƒçš„æ—¶å€™å‘ç°åªæœ‰1ä¸ªæ¡ƒå­ï¼Œé—®çŒ´å­ç¬¬ä¸€å¤©æ€»å…±æ‘˜äº†å¤šå°‘ä¸ªæ¡ƒå­ï¼Ÿ

```java
/*
ï¼ˆ1ï¼‰å…¬å¼ï¼š f(x+1)=f(x)-f(x)/2-1; ==> 2f(x+1) = f(x) - 2 ==> f(x)=2f(x+1)+2
ï¼ˆ2ï¼‰ç»ˆç»“ç‚¹ï¼šf(10) = 1
ï¼ˆ3ï¼‰é€’å½’çš„æ–¹å‘ï¼šèµ°å‘äº†ç»ˆç»“ç‚¹
*/

public static int f(int x){
    if(x == 10){
        return 1;
    } else {
        return 2*f(x+1)+2
    }
}
```



***



#### é€’å½’æ±‚å’Œ

```java
//ï¼ˆ1ï¼‰é€’å½’çš„ç»ˆç‚¹æ¥ï¼šf(1) = 1
//ï¼ˆ2ï¼‰é€’å½’çš„å…¬å¼ï¼š f(n) = f(n-1) + n
//ï¼ˆ3ï¼‰é€’å½’çš„æ–¹å‘å¿…é¡»èµ°å‘ç»ˆç»“ç‚¹ï¼š
public static int f(int n){
        if(n == 1 ) return 1;
        return f(n-1) + n;
}
```



****



#### æ±‰è¯ºå¡”

```java
public class Hanoi {
    public static void main(String[] args) {
        hanoi('X', 'Y', 'Z', 3);
    }

    //å°†nä¸ªå—åˆ†æ²»çš„ä»xç§»åŠ¨åˆ°zï¼Œyä¸ºè¾…åŠ©æŸ±
    private static void hanoi(char x, char y, char z, int n) {
        if (n == 1) {
            System.out.println(x + "â†’" + z);    //ç›´æ¥å°†xçš„å—ç§»åŠ¨åˆ°z
        } else {
            hanoi(x, z, y, n - 1);           //åˆ†æ²»å¤„ç†n-1ä¸ªå—ï¼Œå…ˆå°†n-1ä¸ªå—å€ŸåŠ©zç§»åˆ°y
            System.out.println(x + "â†’" + z);    //ç„¶åå°†xæœ€ä¸‹é¢çš„å—ï¼ˆæœ€å¤§çš„ï¼‰ç§»åŠ¨åˆ°z
            hanoi(y, x, z, n - 1);           //æœ€åå°†n-1ä¸ªå—ä»yç§»åŠ¨åˆ°zï¼Œxä¸ºè¾…åŠ©æŸ±
        }
    }
}
```

æ—¶é—´å¤æ‚åº¦ O(2^n)



****



#### å•¤é…’é—®é¢˜

éè§„å¾‹åŒ–é€’å½’é—®é¢˜ã€‚

å•¤é…’2å…ƒä¸€ç“¶ï¼Œ4ä¸ªç›–å­å¯ä»¥æ¢ä¸€ç“¶ï¼Œ2ä¸ªç©ºç“¶å¯ä»¥æ¢ä¸€ç“¶ã€‚

```java
public class BeerDemo{
    // å®šä¹‰ä¸€ä¸ªé™æ€å˜é‡å­˜å‚¨å¯ä»¥å–é…’çš„æ€»æ•°
    public static int totalNum;
    public static int lastBottleNum;
    public static int lastCoverNum;
    public static void main(String[] args) {
        buyBeer(10);
        System.out.println("æ€»æ•°ï¼š"+totalNum);
        System.out.println("å‰©ä½™ç›–å­ï¼š"+ lastCoverNum);
        System.out.println("å‰©ä½™ç“¶å­ï¼š"+ lastBottleNum);
    }
    public static void buyBeer(int money){
        int number = money / 2;
        totalNum += number;
        // ç®—å‡ºå½“å‰å‰©ä½™çš„å…¨éƒ¨ç›–å­å’Œç“¶å­æ•°ï¼Œæ¢ç®—æˆé‡‘é¢ç»§ç»­è´­ä¹°ã€‚
        int currentBottleNum = lastBottleNum + number ;
        int currentCoverNum = lastCoverNum + number ;
        // æŠŠä»–ä»¬æ¢ç®—æˆé‡‘é¢
        int totalMoney = 0 ;
        totalMoney += (currentBottleNum/2)*2;//é™¤2ä»£è¡¨å¯ä»¥æ¢å‡ ä¸ªç“¶å­ï¼Œä¹˜2ä»£è¡¨æ¢ç®—æˆé’±ï¼Œç§’ï¼
        lastBottleNum = currentBottleNum % 2 ;//å–ä½™//ç®—å‡ºå‰©ä½™çš„ç“¶å­
     
        totalMoney += (currentCoverNum / 4) * 2;
        lastCoverNum = currentCoverNum % 4 ;

        // ç»§ç»­æ‹¿é’±ä¹°é…’
        if(totalMoney >= 2){
            buyBeer(totalMoney);
        }
    }
}
```





***



## æ’åº

### å†’æ³¡æ’åº

å†’æ³¡æ’åºï¼ˆBubble Sortï¼‰ï¼šä¸¤ä¸ªæ•°æ¯”è¾ƒå¤§å°ï¼Œè¾ƒå¤§çš„æ•°ä¸‹æ²‰ï¼Œè¾ƒå°çš„æ•°å†’èµ·æ¥

ç®—æ³•æè¿°ï¼šæ¯æ¬¡ä»æ•°ç»„çš„ç¬¬ä¸€ä¸ªä½ç½®å¼€å§‹ä¸¤ä¸¤æ¯”è¾ƒï¼ŒæŠŠè¾ƒå¤§çš„å…ƒç´ ä¸è¾ƒå°çš„å…ƒç´ è¿›è¡Œå±‚å±‚äº¤æ¢ï¼Œæœ€ç»ˆæŠŠå½“å‰æœ€å¤§çš„ä¸€ä¸ªå…ƒç´ å­˜å…¥åˆ°æ•°ç»„å½“å‰çš„æœ«å°¾

å®ç°æ€è·¯ï¼š

1. ç¡®å®šæ€»å…±éœ€è¦å†’å‡ è½®ï¼šæ•°ç»„çš„é•¿åº¦-1
2. æ¯è½®ä¸¤ä¸¤æ¯”è¾ƒå‡ æ¬¡

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å†’æ³¡æ’åº.gif" style="zoom: 80%;" />

```java
// 0 1ä½ç½®æ¯”è¾ƒï¼Œå¤§çš„æ”¾åé¢ï¼Œç„¶å1 2ä½ç½®æ¯”è¾ƒï¼Œå¤§çš„ç»§ç»­æ”¾åé¢ï¼Œä¸€è½®å¾ªç¯æœ€åä¸€ä½æ˜¯æœ€å¤§å€¼
public class BubbleSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        int flag;//æ ‡è®°æœ¬è¶Ÿæ’åºæ˜¯å¦å‘ç”Ÿäº†äº¤æ¢
        //æ¯”è¾ƒiå’Œi+1ï¼Œä¸éœ€è¦å†æ¯”æœ€åä¸€ä¸ªä½ç½®
        for (int i = 0; i < arr.length - 1; i++) {
            flag = 0;
            //æœ€åiä½ä¸éœ€è¦æ¯”ï¼Œå·²ç»æ’åºå¥½
            for (int j = 0; j < arr.length - 1 - i; j++) {
                if (arr[j] > arr[j + 1]) {
                    int temp = arr[j];
                    arr[j] = arr[j + 1];
                    arr[j + 1] = temp;
                    flag = 1;//å‘ç”Ÿäº†äº¤æ¢
                }
            }
            //æ²¡æœ‰å‘ç”Ÿäº¤æ¢ï¼Œè¯æ˜å·²ç»æœ‰åºï¼Œä¸éœ€è¦ç»§ç»­æ’åºï¼ŒèŠ‚çœæ—¶é—´
            if(flag == 0) {
                break;
            }
        }
        System.out.println(Arrays.toString(arr));
    }
}
```

å†’æ³¡æ’åºæ—¶é—´å¤æ‚åº¦ï¼šæœ€åæƒ…å†µ

* å…ƒç´ æ¯”è¾ƒçš„æ¬¡æ•°ä¸ºï¼š`(N-1)+(N-2)+(N-3)+...+2+1=((N-1)+1)*(N-1)/2=N^2/2-N/2`
* å…ƒç´ äº¤æ¢çš„æ¬¡æ•°ä¸ºï¼š`(N-1)+(N-2)+(N-3)+...+2+1=((N-1)+1)*(N-1)/2=N^2/2-N/2`
* æ€»æ‰§è¡Œæ¬¡æ•°ä¸ºï¼š`(N^2/2-N/2)+(N^2/2-N/2)=N^2-N`

æŒ‰ç…§å¤§ O æ¨å¯¼æ³•åˆ™ï¼Œä¿ç•™å‡½æ•°ä¸­çš„æœ€é«˜é˜¶é¡¹é‚£ä¹ˆæœ€ç»ˆå†’æ³¡æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N^2)



***



### é€‰æ‹©æ’åº

#### ç®€å•é€‰æ‹©

é€‰æ‹©æ’åºï¼ˆSelection-sortï¼‰ï¼šä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•

ç®—æ³•æè¿°ï¼šé¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œç„¶åå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œç„¶åæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•

å®ç°æ€è·¯ï¼š

1. æ§åˆ¶é€‰æ‹©å‡ è½®ï¼šæ•°ç»„çš„é•¿åº¦-1
2. æ§åˆ¶æ¯è½®ä»å½“å‰ä½ç½®å¼€å§‹æ¯”è¾ƒå‡ æ¬¡

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-é€‰æ‹©æ’åº.gif" style="zoom: 80%;" />

```java
public class SelectSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        for (int i = 0; i < arr.length - 1; i++) {
            //è·å–æœ€å°ç´¢å¼•ä½ç½®
            int minIndex = i;
            for (int j = i + 1; j < arr.length; j++) {
                if (arr[minIndex] > arr[j]) {
                    minIndex = j;
                }
            }
            //äº¤æ¢å…ƒç´ 
            int temp = arr[i];
            arr[i] = arr[minIndex];
            arr[minIndex] = temp;
        }
        System.out.println(Arrays.toString(arr));
    }
}
```

é€‰æ‹©æ’åºæ—¶é—´å¤æ‚åº¦ï¼š

* æ•°æ®æ¯”è¾ƒæ¬¡æ•°ï¼š`(N-1)+(N-2)+(N-3)+...+2+1=((N-1)+1)*(N-1)/2=N^2/2-N/2`
* æ•°æ®äº¤æ¢æ¬¡æ•°ï¼š`N-1`
* æ—¶é—´å¤æ‚åº¦ï¼š`N^2/2-N/2+ï¼ˆN-1ï¼‰=N^2/2+N/2-1`

æ ¹æ®å¤§ O æ¨å¯¼æ³•åˆ™ï¼Œä¿ç•™æœ€é«˜é˜¶é¡¹ï¼Œå»é™¤å¸¸æ•°å› å­ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N^2)



***



#### å †æ’åº

å †æ’åºï¼ˆHeapsortï¼‰æ˜¯æŒ‡åˆ©ç”¨å †è¿™ç§æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ä¸€ç§æ’åºç®—æ³•ï¼Œå †ç»“æ„æ˜¯ä¸€ä¸ªè¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³å­ç»“ç‚¹çš„é”®å€¼æˆ–ç´¢å¼•æ€»æ˜¯å°äºï¼ˆæˆ–è€…å¤§äºï¼‰çˆ¶èŠ‚ç‚¹

ä¼˜å…ˆé˜Ÿåˆ—ï¼šå †æ’åºæ¯æ¬¡ä¸Šæµ®è¿‡ç¨‹éƒ½ä¼šå°†æœ€å¤§æˆ–è€…æœ€å°å€¼æ”¾åœ¨å †é¡¶ï¼Œåº”ç”¨äºä¼˜å…ˆé˜Ÿåˆ—å¯ä»¥å°†ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ æµ®åˆ°å †é¡¶

å®ç°æ€è·¯ï¼š

1. å°†åˆå§‹å¾…æ’åºå…³é”®å­—åºåˆ—ï¼ˆR1,R2â€¦.Rnï¼‰æ„å»ºæˆå¤§é¡¶å †ï¼Œå¹¶é€šè¿‡ä¸Šæµ®å¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œæ­¤å †ä¸ºåˆå§‹çš„æ— åºåŒºï¼Œå †é¡¶ä¸ºæœ€å¤§æ•°

2. å°†å †é¡¶å…ƒç´  R[1] ä¸æœ€åä¸€ä¸ªå…ƒç´  R[n] äº¤æ¢ï¼Œæ­¤æ—¶å¾—åˆ°æ–°çš„æ— åºåŒºï¼ˆR1,R2,â€¦â€¦Rn-1ï¼‰å’Œæ–°çš„æœ‰åºåŒº Rnï¼Œä¸”æ»¡è¶³ R[1,2â€¦n-1]<=R[n]

3. äº¤æ¢åæ–°çš„å †é¡¶ R[1] å¯èƒ½è¿åå †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦å¯¹å½“å‰æ— åºåŒºï¼ˆR1,R2,â€¦â€¦Rn-1ï¼‰è°ƒæ•´ä¸ºæ–°å †ï¼Œç„¶åå†æ¬¡å°† R[1] ä¸æ— åºåŒºæœ€åä¸€ä¸ªå…ƒç´ äº¤æ¢ï¼Œå¾—åˆ°æ–°çš„æ— åºåŒºï¼ˆR1,R2â€¦.Rn-2ï¼‰å’Œæ–°çš„æœ‰åºåŒºï¼ˆRn-1,Rnï¼‰ï¼Œä¸æ–­é‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æœ‰åºåŒºçš„å…ƒç´ ä¸ªæ•°ä¸º n-1ï¼Œåˆ™æ•´ä¸ªæ’åºè¿‡ç¨‹å®Œæˆ

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å †æ’åº.jpg" style="zoom:67%;" />

floorï¼šå‘ä¸‹å–æ•´

```java
public class HeapSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        heapSort(arr, arr.length - 1);
        System.out.println(Arrays.toString(arr));
    }

    //highä¸ºæ•°ç»„æœ€å¤§ç´¢å¼•
    private static void heapSort(int[] arr, int high) {
        //å»ºå †ï¼Œé€†æ’åºï¼Œå› ä¸ºå †æ’åºå®šä¹‰çš„äº¤æ¢é¡ºåºæ˜¯ä»å½“å‰ç»“ç‚¹å¾€ä¸‹äº¤æ¢ï¼Œé€†åºæ’å¯ä»¥é¿å…å¤šä½™çš„äº¤æ¢
        //iåˆå§‹å€¼æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœå‚æ•°æ˜¯æ•°ç»„é•¿åº¦lenï¼Œåˆ™ i = len / 2 -1
        for (int i = (high - 1) / 2; i >= 0; i--) {
            //è°ƒæ•´å‡½æ•°
            sift(arr, i, high);
        }
        //ä»å°¾ç´¢å¼•å¼€å§‹æ’åº
        for (int i = high; i > 0; i--) {
            //å°†æœ€å¤§çš„èŠ‚ç‚¹æ”¾å…¥æœ«å°¾
            int temp = arr[0];
            arr[0] = arr[i];
            arr[i] = temp;
            //ç»§ç»­å¯»æ‰¾æœ€å¤§çš„èŠ‚ç‚¹
            sift(arr, 0, i - 1);
        }
    }

    //è°ƒæ•´å‡½æ•°ï¼Œè°ƒæ•´arr[low]çš„å…ƒç´ ï¼Œä»ç´¢å¼•lowåˆ°highçš„èŒƒå›´è°ƒæ•´
    private static void sift(int[] arr, int low, int high) {
        //æš‚å­˜è°ƒæ•´å…ƒç´ 
        int temp = arr[low];
        int i = low, j = low * 2 + 1;//jæ˜¯å·¦èŠ‚ç‚¹
        while (j <= high) {
            //åˆ¤æ–­æ˜¯å¦æœ‰å³å­©å­ï¼Œå¹¶ä¸”æ¯”è¾ƒå·¦å³å­©å­ä¸­è¾ƒå¤§çš„èŠ‚ç‚¹
            if (j < high && arr[j] < arr[j + 1]) {
                j++;    //æŒ‡å‘å³å­©å­
            }
            if (temp < arr[j]) {
                arr[i] = arr[j];
                i = j;  //ç»§ç»­å‘ä¸‹è°ƒæ•´
                j = 2 * i + 1;
            } else {
                //temp > arr[j]ï¼Œè¯´æ˜ä¹Ÿå¤§äºjçš„å­©å­ï¼Œæ¢æµ‹ç»“æŸ
                break;
            }
        }
        //å°†è¢«è°ƒæ•´çš„èŠ‚ç‚¹æ”¾å…¥æœ€ç»ˆçš„ä½ç½®
        arr[i] = temp;
    }
}
```

å †æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(nlogn)



***



### æ’å…¥æ’åº

#### ç›´æ¥æ’å…¥

æ’å…¥æ’åºï¼ˆInsertion Sortï¼‰ï¼šåœ¨è¦æ’åºçš„ä¸€ç»„æ•°ä¸­ï¼Œå‡å®šå‰ n-1 ä¸ªæ•°å·²ç»æ’å¥½åºï¼Œç°åœ¨å°†ç¬¬ n ä¸ªæ•°æ’åˆ°è¿™ä¸ªæœ‰åºæ•°åˆ—ä¸­ï¼Œä½¿å¾—è¿™ n ä¸ªæ•°ä¹Ÿæ˜¯æ’å¥½é¡ºåºçš„ï¼Œå¦‚æ­¤åå¤å¾ªç¯ï¼Œç›´åˆ°å…¨éƒ¨æ’å¥½é¡ºåº

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-æ’å…¥æ’åº.png" style="zoom: 67%;" />

```java
public class InsertSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        for (int i = 1; i < arr.length; i++) {
            for (int j = i; j > 0; j--) {
                //æ¯”è¾ƒç´¢å¼•jå¤„çš„å€¼å’Œç´¢å¼•j-1å¤„çš„å€¼ï¼Œ
                //å¦‚æœç´¢å¼•j-1å¤„çš„å€¼æ¯”ç´¢å¼•jå¤„çš„å€¼å¤§ï¼Œåˆ™äº¤æ¢æ•°æ®ï¼Œ
                //å¦‚æœä¸å¤§ï¼Œé‚£ä¹ˆå°±æ‰¾åˆ°åˆé€‚çš„ä½ç½®äº†ï¼Œé€€å‡ºå¾ªç¯å³å¯ï¼›
                if (arr[j - 1] > arr[j]) {
                    int temp = arr[j];
                    arr[j] = arr[j - 1];
                    arr[j - 1] = temp;
                }
            }
        }
        System.out.println(Arrays.toString(arr));
    }
}
```

æ’å…¥æ’åºæ—¶é—´å¤æ‚åº¦ï¼š

* æ¯”è¾ƒçš„æ¬¡æ•°ä¸ºï¼š`(N-1)+(N-2)+(N-3)+...+2+1=((N-1)+1)*(N-1)/2=N^2/2-N/2`
* äº¤æ¢çš„æ¬¡æ•°ä¸ºï¼š`(N-1)+(N-2)+(N-3)+...+2+1=((N-1)+1)(N-1)/2=N^2/2-N/2`
* æ€»æ‰§è¡Œæ¬¡æ•°ä¸ºï¼š`(N^2/2-N/2)+(N^2/2-N/2)=N^2-N`

æŒ‰ç…§å¤§ O æ¨å¯¼æ³•åˆ™ï¼Œä¿ç•™å‡½æ•°ä¸­çš„æœ€é«˜é˜¶é¡¹é‚£ä¹ˆæœ€ç»ˆæ’å…¥æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N^2)



***



#### å¸Œå°”æ’åº

å¸Œå°”æ’åºï¼ˆShell Sortï¼‰ï¼šä¹Ÿæ˜¯ä¸€ç§æ’å…¥æ’åºï¼Œä¹Ÿç§°ä¸ºç¼©å°å¢é‡æ’åº

å®ç°æ€è·¯ï¼š

1. é€‰å®šä¸€ä¸ªå¢é•¿é‡ hï¼ŒæŒ‰ç…§å¢é•¿é‡ h ä½œä¸ºæ•°æ®åˆ†ç»„çš„ä¾æ®ï¼Œå¯¹æ•°æ®è¿›è¡Œåˆ†ç»„
2. å¯¹åˆ†å¥½ç»„çš„æ¯ä¸€ç»„æ•°æ®å®Œæˆæ’å…¥æ’åº
3. å‡å°å¢é•¿é‡ï¼Œæœ€å°å‡ä¸º 1ï¼Œé‡å¤ç¬¬äºŒæ­¥æ“ä½œ

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å¸Œå°”æ’åº.png" style="zoom:67%;" />

å¸Œå°”æ’åºçš„æ ¸å¿ƒåœ¨äºé—´éš”åºåˆ—çš„è®¾å®šï¼Œæ—¢å¯ä»¥æå‰è®¾å®šå¥½é—´éš”åºåˆ—ï¼Œä¹Ÿå¯ä»¥åŠ¨æ€çš„å®šä¹‰é—´éš”åºåˆ—ï¼Œå¸Œå°”æ’åºå°±æ˜¯æ’å…¥æ’åºå¢åŠ äº†é—´éš”

```java
public class ShellSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        //1. ç¡®å®šå¢é•¿é‡hçš„åˆå§‹å€¼
        int h = 1;
        while (h < arr.length / 2) {
            h = 2 * h + 1;
        }
        //2. å¸Œå°”æ’åº
        while (h >= 1) {
            //2.1 æ‰¾åˆ°å¾…æ’å…¥çš„å…ƒç´ 
            for (int i = h; i < arr.length; i++) {
                //2.2 æŠŠå¾…æ’å…¥çš„å…ƒç´ æ’åˆ°æœ‰åºæ•°åˆ—ä¸­
                for (int j = i; j >= h; j -= h) {
                    //å¾…æ’å…¥çš„å…ƒç´ æ˜¯arr[j]ï¼Œæ¯”è¾ƒarr[j]å’Œarr[j-h]
                    if (arr[j] < arr[j - h]) {
                        int temp = arr[j];
                        arr[j] = arr[j - h];
                        arr[j - h] = temp;
                    }
                }
            }
            //3. å‡å°hçš„å€¼ï¼Œå‡å°è§„åˆ™ä¸ºï¼š
            h = h / 2;
        }
        System.out.println(Arrays.toString(arr));
    }
}
```

åœ¨å¸Œå°”æ’åºä¸­ï¼Œå¢é•¿é‡ h å¹¶æ²¡æœ‰å›ºå®šçš„è§„åˆ™ï¼Œæœ‰å¾ˆå¤šè®ºæ–‡ç ”ç©¶äº†å„ç§ä¸åŒçš„é€’å¢åºåˆ—ï¼Œä½†éƒ½æ— æ³•è¯æ˜æŸä¸ªåºåˆ—æ˜¯æœ€å¥½çš„ï¼Œæ‰€ä»¥å¯¹äºå¸Œå°”æ’åºçš„æ—¶é—´å¤æ‚åº¦åˆ†æå°±è®¤ä¸º O(nlogn)



***



### å½’å¹¶æ’åº

#### å®ç°æ–¹å¼

å½’å¹¶æ’åºï¼ˆMerge Sortï¼‰ï¼šå»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ï¼Œè¯¥ç®—æ³•æ˜¯é‡‡ç”¨åˆ†æ²»æ³•çš„å…¸å‹çš„åº”ç”¨ã€‚å°†å·²æœ‰åºçš„å­åºåˆ—åˆå¹¶ï¼Œå¾—åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚è‹¥å°†ä¸¤ä¸ªæœ‰åºè¡¨åˆå¹¶æˆä¸€ä¸ªæœ‰åºè¡¨ï¼Œç§°ä¸ºäºŒè·¯å½’å¹¶ã€‚

å®ç°æ€è·¯ï¼š

1. ä¸€ç»„æ•°æ®æ‹†åˆ†æˆä¸¤ä¸ªå…ƒç´ ç›¸ç­‰çš„å­ç»„ï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªå­ç»„ç»§ç»­æ‹†åˆ†ï¼Œç›´åˆ°æ‹†åˆ†åçš„æ¯ä¸ªå­ç»„çš„å…ƒç´ ä¸ªæ•°æ˜¯1ä¸ºæ­¢
2. å°†ç›¸é‚»çš„ä¸¤ä¸ªå­ç»„è¿›è¡Œåˆå¹¶æˆä¸€ä¸ªæœ‰åºçš„å¤§ç»„
3. ä¸æ–­çš„é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°æœ€ç»ˆåªæœ‰ä¸€ä¸ªç»„ä¸ºæ­¢

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å½’å¹¶æ’åº.png" style="zoom:50%;" />

å½’å¹¶æ­¥éª¤ï¼šæ¯æ¬¡æ¯”è¾ƒä¸¤ç«¯æœ€å°çš„å€¼ï¼ŒæŠŠæœ€å°çš„å€¼æ”¾åœ¨è¾…åŠ©æ•°ç»„çš„å·¦è¾¹

![](https://gitee.com/seazean/images/raw/master/Java/Sort-å½’å¹¶æ­¥éª¤1.png)

![](https://gitee.com/seazean/images/raw/master/Java/Sort-å½’å¹¶æ­¥éª¤2.png)

![](https://gitee.com/seazean/images/raw/master/Java/Sort-å½’å¹¶æ­¥éª¤3.png)





***



#### å®ç°ä»£ç 

```java
public class MergeSort {
    public static void main(String[] args) {
        int[] arr = new int[]{55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        mergeSort(arr, 0, arr.length - 1);
        System.out.println(Arrays.toString(arr));
    }
	//low ä¸ºarræœ€å°ç´¢å¼•ï¼Œhighä¸ºæœ€å¤§ç´¢å¼•
    public static void mergeSort(int[] arr, int low, int high) {
        // low == high æ—¶è¯´æ˜åªæœ‰ä¸€ä¸ªå…ƒç´ äº†ï¼Œç›´æ¥è¿”å›
        if (low < high) {
            int mid = (low + high) / 2;
            mergeSort(arr, low, mid);//å½’å¹¶æ’åºå‰åŠæ®µ
            mergeSort(arr, mid + 1, high);//å½’å¹¶æ’åºååŠæ®µ
            merge(arr, low, mid, high);//å°†ä¸¤æ®µæœ‰åºæ®µåˆæˆä¸€æ®µæœ‰åºæ®µ
        }
    }

    private static void merge(int[] arr, int low, int mid, int high) {
        int index = 0;
        //å®šä¹‰å·¦å³æŒ‡é’ˆ
        int left = low, right = mid + 1;
        int[] assist = new int[high - low + 1];
        
        while (left <= mid && right <= high) {
            assist[index++] = arr[left] < arr[right] ? arr[left++] : arr[right++];
        }
        while (left <= mid) {
            assist[index++] = arr[left++];
        }
        while (right <= high) {
            assist[index++] = arr[right++];
        }

        for (int k = 0; k < assist.length; k++) {
            arr[low++] = assist[k];
        }
    }
}
```

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å½’å¹¶æ’åºæ—¶é—´å¤æ‚åº¦.png" style="zoom: 67%;" />

ç”¨æ ‘çŠ¶å›¾æ¥æè¿°å½’å¹¶ï¼Œå‡è®¾å…ƒç´ çš„ä¸ªæ•°ä¸º nï¼Œé‚£ä¹ˆä½¿ç”¨å½’å¹¶æ’åºæ‹†åˆ†çš„æ¬¡æ•°ä¸º `log2(n)`ï¼Œå³å±‚æ•°ï¼Œæ¯æ¬¡å½’å¹¶éœ€è¦åš n æ¬¡å¯¹æ¯”ï¼Œæœ€ç»ˆå¾—å‡ºçš„å½’å¹¶æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º `log2(n)*n`ï¼Œæ ¹æ®å¤§Oæ¨å¯¼æ³•åˆ™ï¼Œå¿½ç•¥åº•æ•°ï¼Œæœ€ç»ˆå½’å¹¶æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(nlogn)

å½’å¹¶æ’åºçš„ç¼ºç‚¹ï¼šéœ€è¦ç”³è¯·é¢å¤–çš„æ•°ç»„ç©ºé—´ï¼Œå¯¼è‡´ç©ºé—´å¤æ‚åº¦æå‡ï¼Œæ˜¯å…¸å‹çš„**ä»¥ç©ºé—´æ¢æ—¶é—´**çš„æ“ä½œ





****



### å¿«é€Ÿæ’åº

å¿«é€Ÿæ’åºï¼ˆQuick Sortï¼‰ï¼šé€šè¿‡**åˆ†æ²»æ€æƒ³**å¯¹å†’æ³¡æ’åºçš„æ”¹è¿›ï¼ŒåŸºæœ¬è¿‡ç¨‹æ˜¯é€šè¿‡ä¸€è¶Ÿæ’åºå°†è¦æ’åºçš„æ•°æ®åˆ†å‰²æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½æ¯”å¦å¤–ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½è¦å°ï¼Œç„¶åå†æŒ‰æ­¤æ–¹æ³•å¯¹è¿™ä¸¤éƒ¨åˆ†æ•°æ®åˆ†åˆ«è¿›è¡Œå¿«é€Ÿæ’åºï¼Œä»¥æ­¤è¾¾åˆ°æ•´ä¸ªæ•°æ®å˜æˆæœ‰åºåºåˆ—

å®ç°æ€è·¯ï¼š

1. ä»æ•°åˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¸ºåŸºå‡†ï¼ˆpivotï¼‰
2. é‡æ–°æ’åºæ•°åˆ—ï¼Œæ‰€æœ‰æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ï¼Œåœ¨è¿™ä¸ªåˆ†åŒºé€€å‡ºä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ï¼Œè¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆpartitionï¼‰æ“ä½œï¼›
3. é€’å½’åœ°ï¼ˆrecursiveï¼‰æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—æ’åº

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å¿«é€Ÿæ’åº.gif" style="zoom:80%;" />

```java
public class QuickSort {
    public static void main(String[] args) {
        int[] arr = {55, 22, 2, 5, 1, 3, 8, 5, 7, 4, 3, 99, 88};
        quickSort(arr, 0, arr.length - 1);
        System.out.println(Arrays.toString(arr));
    }

    public static void quickSort(int[] arr, int low, int high) {
        //é€’å½’ç»“æŸçš„æ¡ä»¶
        if (low >= high) {
            return;
        }
        
        int left = low;
        int right = high;
        
        int temp = arr[left];//åŸºå‡†æ•°
        while (left < right) {
            // ç”¨ >= å¯ä»¥é˜²æ­¢å¤šä½™çš„äº¤æ¢
            while (arr[right] >= temp && right > left) {
                right--;
            }
            // åšåˆ¤æ–­é˜²æ­¢ç›¸ç­‰
            if (right > left) {
                // åˆ°è¿™é‡Œè¯´æ˜ arr[right] < temp 
                arr[left] = arr[right];//æ­¤æ—¶æŠŠarr[right]å…ƒç´ è§†ä¸ºç©º
                left++;
            }
            while (arr[left] <= temp && left < right) {
                left++;
            }
            if (right > left) {
                arr[right] = arr[left];
                right--;
            }
        }
        // left == right
        arr[left] = temp;
        quickSort(arr, low, left-1);
        quickSort(arr, right + 1, high);
    }
}
```

å¿«é€Ÿæ’åºå’Œå½’å¹¶æ’åºçš„åŒºåˆ«ï¼š

* å¿«é€Ÿæ’åºæ˜¯å¦å¤–ä¸€ç§åˆ†æ²»çš„æ’åºç®—æ³•ï¼Œå°†ä¸€ä¸ªæ•°ç»„åˆ†æˆä¸¤ä¸ªå­æ•°ç»„ï¼Œå°†ä¸¤éƒ¨åˆ†ç‹¬ç«‹çš„æ’åº
* å½’å¹¶æ’åºçš„å¤„ç†è¿‡ç¨‹æ˜¯ç”±ä¸‹åˆ°ä¸Šçš„ï¼Œå…ˆå¤„ç†å­é—®é¢˜ï¼Œç„¶åå†åˆå¹¶ã€‚è€Œå¿«æ’æ­£å¥½ç›¸åï¼Œå®ƒçš„å¤„ç†è¿‡ç¨‹æ˜¯ç”±ä¸Šåˆ°ä¸‹çš„ï¼Œå…ˆåˆ†åŒºï¼Œç„¶åå†å¤„ç†å­é—®é¢˜
* å¿«é€Ÿæ’åºå’Œå½’å¹¶æ’åºæ˜¯äº’è¡¥çš„ï¼šå½’å¹¶æ’åºå°†æ•°ç»„åˆ†æˆä¸¤ä¸ªå­æ•°ç»„åˆ†åˆ«æ’åºï¼Œå¹¶å°†æœ‰åºçš„å­æ•°ç»„å½’å¹¶ä»è€Œå°†æ•´ä¸ªæ•°ç»„æ’åºï¼Œè€Œå¿«é€Ÿæ’åºçš„æ–¹å¼åˆ™æ˜¯å½“ä¸¤ä¸ªæ•°ç»„éƒ½æœ‰åºæ—¶ï¼Œæ•´ä¸ªæ•°ç»„è‡ªç„¶å°±æœ‰åºäº†
* åœ¨å½’å¹¶æ’åºä¸­ï¼Œä¸€ä¸ªæ•°ç»„è¢«ç­‰åˆ†ä¸ºä¸¤åŠï¼Œå½’å¹¶è°ƒç”¨å‘ç”Ÿåœ¨å¤„ç†æ•´ä¸ªæ•°ç»„ä¹‹å‰ï¼Œåœ¨å¿«é€Ÿæ’åºä¸­ï¼Œåˆ‡åˆ†æ•°ç»„çš„ä½ç½®å–å†³äºæ•°ç»„çš„å†…å®¹ï¼Œé€’å½’è°ƒç”¨å‘ç”Ÿåœ¨å¤„ç†æ•´ä¸ªæ•°ç»„ä¹‹å

æ—¶é—´å¤æ‚åº¦ï¼š

* æœ€ä¼˜æƒ…å†µï¼šæ¯ä¸€æ¬¡åˆ‡åˆ†é€‰æ‹©çš„åŸºå‡†æ•°å­—åˆšå¥½å°†å½“å‰åºåˆ—ç­‰åˆ†ã€‚æŠŠæ•°ç»„çš„åˆ‡åˆ†çœ‹åšæ˜¯ä¸€ä¸ªæ ‘ï¼Œå…±åˆ‡åˆ†äº† logn æ¬¡ï¼Œæ‰€ä»¥ï¼Œæœ€ä¼˜æƒ…å†µä¸‹å¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(nlogn)

* æœ€åæƒ…å†µï¼šæ¯ä¸€æ¬¡åˆ‡åˆ†é€‰æ‹©çš„åŸºå‡†æ•°å­—æ˜¯å½“å‰åºåˆ—ä¸­æœ€å¤§æ•°æˆ–è€…æœ€å°æ•°ï¼Œè¿™ä½¿å¾—æ¯æ¬¡åˆ‡åˆ†éƒ½ä¼šæœ‰ä¸€ä¸ªå­ç»„ï¼Œé‚£ä¹ˆæ€»å…±å°±å¾—åˆ‡åˆ†næ¬¡ï¼Œæ‰€ä»¥æœ€åæƒ…å†µä¸‹ï¼Œå¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(n^2)

  <img src="https://gitee.com/seazean/images/raw/master/Java/Sort-å¿«æ’æ—¶é—´å¤æ‚åº¦.png" style="zoom: 50%;" />

* å¹³å‡æƒ…å†µï¼šæ¯ä¸€æ¬¡åˆ‡åˆ†é€‰æ‹©çš„åŸºå‡†æ•°å­—ä¸æ˜¯æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œä¹Ÿä¸æ˜¯ä¸­å€¼ï¼Œè¿™ç§æƒ…å†µç”¨æ•°å­¦å½’çº³æ³•è¯æ˜ï¼Œå¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º O(nlogn)



æ¨èè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1b7411N798?t=1001&p=81

å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/nrsc272420199/article/details/82587933





****



### åŸºæ•°æ’åº

åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰ï¼šåˆå«æ¡¶æ’åºå’Œç®±æ’åºï¼Œå€ŸåŠ©å¤šå…³é”®å­—æ’åºçš„æ€æƒ³å¯¹å•é€»è¾‘å…³é”®å­—è¿›è¡Œæ’åºçš„æ–¹æ³•

è®¡æ•°æ’åºå…¶å®æ˜¯æ¡¶æ’åºçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå½“è¦æ’åºçš„ n ä¸ªæ•°æ®ï¼Œæ‰€å¤„çš„èŒƒå›´å¹¶ä¸å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚æœ€å¤§å€¼æ˜¯ kï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ•°æ®åˆ’åˆ†æˆ k ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶å†…çš„æ•°æ®å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œçœæ‰äº†æ¡¶å†…æ’åºçš„æ—¶é—´

æŒ‰ç…§ä½ä½å…ˆæ’åºï¼Œç„¶åæ”¶é›†ï¼›å†æŒ‰ç…§é«˜ä½æ’åºï¼Œç„¶åå†æ”¶é›†ï¼›ä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æœ€é«˜ä½ã€‚æœ‰æ—¶å€™æœ‰äº›å±æ€§æ˜¯æœ‰ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œå…ˆæŒ‰ä½ä¼˜å…ˆçº§æ’åºï¼Œå†æŒ‰é«˜ä¼˜å…ˆçº§æ’åºã€‚æœ€åçš„æ¬¡åºå°±æ˜¯é«˜ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ï¼Œé«˜ä¼˜å…ˆçº§ç›¸åŒçš„ä½ä¼˜å…ˆçº§é«˜çš„åœ¨å‰

è§£é‡Šï¼šå…ˆæ’ä½ä½å†æ’é«˜ä½ï¼Œå¯ä»¥è¯´æ˜åœ¨é«˜ä½ç›¸ç­‰çš„æƒ…å†µä¸‹ä½ä½æ˜¯é€’å¢çš„ï¼Œå¦‚æœé«˜ä½ä¹Ÿæ˜¯é€’å¢ï¼Œåˆ™æ•°æ®æœ‰åº

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-åŸºæ•°æ’åº.gif" style="zoom:67%;" />

å®ç°æ€è·¯ï¼š

- è·å¾—æœ€å¤§æ•°çš„ä½æ•°ï¼Œå¯ä»¥é€šè¿‡å°†æœ€å¤§æ•°å˜ä¸ºStringç±»å‹ï¼Œå†æ±‚é•¿åº¦
- å°†æ‰€æœ‰å¾…æ¯”è¾ƒæ•°å€¼ï¼ˆæ­£æ•´æ•°ï¼‰ç»Ÿä¸€ä¸ºåŒæ ·çš„æ•°ä½é•¿åº¦ï¼Œ**ä½æ•°è¾ƒçŸ­çš„æ•°å‰é¢è¡¥é›¶**
- ä»æœ€ä½ä½å¼€å§‹ï¼Œä¾æ¬¡è¿›è¡Œä¸€æ¬¡æ’åº
- ä»æœ€ä½ä½æ’åºä¸€ç›´åˆ°æœ€é«˜ä½ï¼ˆä¸ªä½ â†’ åä½ â†’ ç™¾ä½ â†’ â€¦ â†’æœ€é«˜ä½ï¼‰æ’åºå®Œæˆä»¥åï¼Œæ•°åˆ—å°±å˜æˆä¸€ä¸ªæœ‰åºåºåˆ—

```java
public class BucketSort {
    public static void main(String[] args) {
        int[] arr = new int[]{576, 22, 26, 548, 1, 3, 843, 536, 735, 43, 3, 912, 88};
        bucketSort(arr);
        System.out.println(Arrays.toString(arr));
    }

    private static void bucketSort(int[] arr) {
        // æ¡¶çš„ä¸ªæ•°å›ºå®šä¸º10ä¸ªï¼ˆä¸ªä½æ˜¯0~9ï¼‰ï¼Œæ•°ç»„é•¿åº¦ä¸ºäº†é˜²æ­¢æ‰€æœ‰çš„æ•°åœ¨åŒä¸€è¡Œ
        int[][] bucket = new int[10][arr.length];
        //è®°å½•æ¯ä¸ªæ¡¶ä¸­çš„æœ‰å¤šå°‘ä¸ªå…ƒç´ 
        int[] elementCounts = new int[10];

        //è·å–æ•°ç»„çš„æœ€å¤§å…ƒç´ 
        int max = arr[0];
        for (int i = 1; i < arr.length; i++) {
            max = max > arr[i] ? max : arr[i];
        }
        String maxEle = Integer.toString(max);
        //å°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾å…¥æ¡¶ä¸­ï¼Œæœ€å¤§æ•°çš„ä½æ•°ç›¸å½“äºéœ€è¦å‡ æ¬¡æ”¾å…¥æ¡¶ä¸­
        for (int i = 0, step = 1; i < maxEle.length(); i++, step *= 10) {
            for (int j = 0; j < arr.length; j++) {
                //è·å–æœ€åä¸€ä½çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç´¢å¼•
                int index = (arr[j] / step) % 10;
                //æ”¾å…¥å…·ä½“ä½ç½®
                bucket[index][elementCounts[index]] = arr[j];
                //å­˜å‚¨æ¯ä¸ªæ¡¶çš„æ•°é‡
                elementCounts[index]++;
            }
            //æ”¶é›†å›æ•°ç»„
            for (int j = 0, index = 0; j < 10; j++) {
                //å…ˆè¿›å…ˆå‡º
                int position = 0;
                //æ¡¶ä¸­æœ‰å…ƒç´ å°±å–å‡º
                while (elementCounts[j] > 0) {
                    arr[index] = bucket[j][position];
                    elementCounts[j]--;
                    position++;
                    index++;
                }
            }
        }
    }
}
```

ç©ºé—´æ¢æ—¶é—´



æ¨èè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1b7411N798?p=86

å‚è€ƒæ–‡ç« ï¼šhttps://www.toutiao.com/a6593273307280179715/?iid=6593273307280179715



***



### ç¨³å®šæ€§

ç¨³å®šæ€§ï¼šåœ¨å¾…æ’åºçš„è®°å½•åºåˆ—ä¸­ï¼Œå­˜åœ¨å¤šä¸ªå…·æœ‰ç›¸åŒçš„å…³é”®å­—çš„è®°å½•ï¼Œè‹¥ç»è¿‡æ’åºï¼Œè¿™äº›è®°å½•çš„ç›¸å¯¹æ¬¡åºä¿æŒä¸å˜ï¼Œå³åœ¨åŸåºåˆ—ä¸­ `r[i]=r[j]`ï¼Œä¸” r[i] åœ¨ r[j] ä¹‹å‰ï¼Œè€Œåœ¨æ’åºåçš„åºåˆ—ä¸­ï¼Œr[i] ä»åœ¨ r[j] ä¹‹å‰ï¼Œåˆ™ç§°è¿™ç§æ’åºç®—æ³•æ˜¯ç¨³å®šçš„ï¼Œå¦åˆ™ç§°ä¸ºä¸ç¨³å®šçš„

å¦‚æœä¸€ç»„æ•°æ®åªéœ€è¦ä¸€æ¬¡æ’åºï¼Œåˆ™ç¨³å®šæ€§ä¸€èˆ¬æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå¦‚æœä¸€ç»„æ•°æ®éœ€è¦å¤šæ¬¡æ’åºï¼Œç¨³å®šæ€§æ˜¯æœ‰æ„ä¹‰çš„ã€‚

<img src="https://gitee.com/seazean/images/raw/master/Java/Sort-ç¨³å®šæ€§.png" style="zoom:50%;" />

* å†’æ³¡æ’åºï¼šåªæœ‰å½“ `arr[i]>arr[i+1]` çš„æ—¶å€™ï¼Œæ‰ä¼šäº¤æ¢å…ƒç´ çš„ä½ç½®ï¼Œè€Œç›¸ç­‰çš„æ—¶å€™å¹¶ä¸äº¤æ¢ä½ç½®ï¼Œæ‰€ä»¥å†’æ³¡æ’åºæ˜¯ä¸€ç§ç¨³å®šæ’åºç®—æ³•
* é€‰æ‹©æ’åºï¼šæ˜¯ç»™æ¯ä¸ªä½ç½®é€‰æ‹©å½“å‰å…ƒç´ æœ€å°çš„ï¼Œä¾‹å¦‚æœ‰æ•°æ®{5(1)ï¼Œ8 ï¼Œ5(2)ï¼Œ 3ï¼Œ 9 }ï¼Œç¬¬ä¸€éé€‰æ‹©åˆ°çš„æœ€å°å…ƒç´ ä¸º3ï¼Œæ‰€ä»¥5(1)ä¼šå’Œ3è¿›è¡Œäº¤æ¢ä½ç½®ï¼Œæ­¤æ—¶5(1)åˆ°äº†5(2)åé¢ï¼Œç ´åäº†ç¨³å®šæ€§ï¼Œæ‰€ä»¥æ˜¯ä¸ç¨³å®šçš„æ’åºç®—æ³•
* æ’å…¥æ’åºï¼šæ¯”è¾ƒæ˜¯ä»æœ‰åºåºåˆ—çš„æœ«å°¾å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦æ’å…¥çš„å…ƒç´ å’Œå·²ç»æœ‰åºçš„æœ€å¤§è€…å¼€å§‹æ¯”èµ·ï¼Œå¦‚æœæ¯”å®ƒå¤§åˆ™ç›´æ¥æ’å…¥åœ¨å…¶åé¢ï¼Œå¦åˆ™ä¸€ç›´å¾€å‰æ‰¾ç›´åˆ°æ‰¾åˆ°å®ƒè¯¥æ’å…¥çš„ä½ç½®ã€‚å¦‚æœç¢°è§ä¸€ä¸ªå’Œæ’å…¥å…ƒç´ ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆæŠŠè¦æ’å…¥çš„å…ƒç´ æ”¾åœ¨ç›¸ç­‰å…ƒç´ çš„åé¢ã€‚ç›¸ç­‰å…ƒç´ çš„å‰åé¡ºåºæ²¡æœ‰æ”¹å˜ï¼Œä»åŸæ— åºåºåˆ—å‡ºå»çš„é¡ºåºå°±æ˜¯æ’å¥½åºåçš„é¡ºåºï¼Œæ‰€ä»¥æ’å…¥æ’åºæ˜¯ç¨³å®šçš„
* å¸Œå°”æ’åºï¼šæŒ‰ç…§ä¸åŒæ­¥é•¿å¯¹å…ƒç´ è¿›è¡Œæ’å…¥æ’åºï¼Œè™½ç„¶ä¸€æ¬¡æ’å…¥æ’åºæ˜¯ç¨³å®šçš„ï¼Œä½†åœ¨ä¸åŒçš„æ’å…¥æ’åºè¿‡ç¨‹ä¸­ï¼Œç›¸åŒçš„å…ƒç´ å¯èƒ½åœ¨å„è‡ªçš„æ’å…¥æ’åºä¸­ç§»åŠ¨ï¼Œæœ€åå…¶ç¨³å®šæ€§å°±ä¼šè¢«æ‰“ä¹±ï¼Œæ‰€ä»¥å¸Œå°”æ’åºæ˜¯ä¸ç¨³å®šçš„
* å½’å¹¶æ’åºåœ¨å½’å¹¶çš„è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ `arr[i]<arr[i+1]` çš„æ—¶å€™æ‰ä¼šäº¤æ¢ä½ç½®ï¼Œå¦‚æœä¸¤ä¸ªå…ƒç´ ç›¸ç­‰åˆ™ä¸ä¼šäº¤æ¢ä½ç½®ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸ä¼šç ´åç¨³å®šæ€§ï¼Œå½’å¹¶æ’åºæ˜¯ç¨³å®šçš„
* å¿«é€Ÿæ’åºï¼šå¿«æ’éœ€è¦ä¸€ä¸ªåŸºå‡†å€¼ï¼Œåœ¨åŸºå‡†å€¼çš„å³ä¾§æ‰¾ä¸€ä¸ªæ¯”åŸºå‡†å€¼å°çš„å…ƒç´ ï¼Œåœ¨åŸºå‡†å€¼çš„å·¦ä¾§æ‰¾ä¸€ä¸ªæ¯”åŸºå‡†å€¼å¤§çš„å…ƒç´ ï¼Œç„¶åäº¤æ¢è¿™ä¸¤ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶ä¼šç ´åç¨³å®šæ€§ï¼Œæ‰€ä»¥å¿«é€Ÿæ’åºæ˜¯ä¸€ç§ä¸ç¨³å®šçš„ç®—æ³•

è®°å¿†å£è¯€ï¼š

* æƒ…ç»ªä¸ç¨³å®šï¼Œå¿«äº›é€‰ä¸€å †å¥½å‹æ¥èŠå¤©

* å¿«ï¼šå¿«é€Ÿæ’åºã€äº›ï¼šå¸Œå°”æ’åºã€é€‰ï¼šé€‰æ‹©æ’åºã€å †ï¼šå †æ’åº





***



### ç®—æ³•å¯¹æ¯”

![](https://gitee.com/seazean/images/raw/master/Java/Sort-æ’åºç®—æ³•å¯¹æ¯”.png)





***



## æŸ¥æ‰¾

æ­£å¸¸æŸ¥æ‰¾ï¼šä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹éå†ï¼Œä¸€ä¸ªä¸€ä¸ªçš„å¾€åæ‰¾ï¼Œç»¼åˆæŸ¥æ‰¾æ¯”è¾ƒè€—æ—¶ã€‚

äºŒåˆ†æŸ¥æ‰¾ä¹Ÿç§°æŠ˜åŠæŸ¥æ‰¾ï¼ˆBinary Searchï¼‰æ˜¯ä¸€ç§æ•ˆç‡è¾ƒé«˜çš„æŸ¥æ‰¾æ–¹æ³•ï¼Œæ•°ç»„å¿…é¡»æ˜¯æœ‰åºæ•°ç»„

è¿‡ç¨‹ï¼šæ¯æ¬¡å…ˆä¸ä¸­é—´çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºå¾€å³è¾¹æ‰¾ï¼Œå¦‚æœå°äºå¾€å·¦è¾¹æ‰¾ï¼Œå¦‚æœç­‰äºå°±è¿”å›è¯¥å…ƒç´ ç´¢å¼•ä½ç½®ï¼å¦‚æœæ²¡æœ‰è¯¥å…ƒç´ ï¼Œè¿”å›-1

æ—¶é—´å¤æ‚åº¦ï¼šO(logn)

```java
/*å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œè®°å½•å¼€å§‹çš„ç´¢å¼•ä½ç½®å’Œç»“æŸçš„ç´¢å¼•ä½ç½®ã€‚
å–å‡ºä¸­é—´ç´¢å¼•ä½ç½®çš„å€¼ï¼Œæ‹¿å…ƒç´ ä¸ä¸­é—´ä½ç½®çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå°äºä¸­é—´å€¼ï¼Œç»“æŸä½ç½®=ä¸­é—´ç´¢å¼•-1.
å–å‡ºä¸­é—´ç´¢å¼•ä½ç½®çš„å€¼ï¼Œæ‹¿å…ƒç´ ä¸ä¸­é—´ä½ç½®çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºä¸­é—´å€¼ï¼Œå¼€å§‹ä½ç½®=ä¸­é—´ç´¢å¼•+1.
å¾ªç¯æ­£å¸¸æ‰§è¡Œçš„æ¡ä»¶ï¼šå¼€å§‹ä½ç½®ç´¢å¼•<=ç»“æŸä½ç½®ç´¢å¼•ã€‚å¦åˆ™è¯´æ˜å¯»æ‰¾å®Œæ¯•ä½†æ˜¯æ²¡æœ‰è¯¥å…ƒç´ å€¼è¿”å›-1.*/
public class binarySearch {
    public static void main(String[] args) {
        int[] arr = {10, 14, 21, 38, 45, 47, 53, 81, 87, 99};
        System.out.println("81çš„ç´¢å¼•æ˜¯ï¼š" + binarySearch(arr,81));

    }

    public static int binarySearch(int[] arr, int des) {
        int start = 0;
        int end = arr.length - 1;

        //ç¡®ä¿ä¸ä¼šå‡ºç°é‡å¤æŸ¥æ‰¾ï¼Œè¶Šç•Œ
        while (start <= end) {
            //è®¡ç®—å‡ºä¸­é—´ç´¢å¼•å€¼
            int mid = (start + end) / 2;
            if (des == arr[mid]) {
                return mid;
            } else if (des > arr[mid]) {
                start = mid + 1;
            } else if (des < arr[mid]) {
                end = mid - 1;
            }
        }
        // å¦‚æœä¸Šè¿°å¾ªç¯æ‰§è¡Œå®Œæ¯•è¿˜æ²¡æœ‰è¿”å›ç´¢å¼•ï¼Œè¯´æ˜æ ¹æœ¬ä¸å­˜åœ¨è¯¥å…ƒç´ å€¼ï¼Œç›´æ¥è¿”å›-1
        return -1;
    }
}
```

![](https://gitee.com/seazean/images/raw/master/Java/äºŒåˆ†æŸ¥æ‰¾.gif)

æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ ï¼š

```java
public static int binarySearch(int[] arr, int des) {
        int start = 0;
        int end = arr.length - 1;

        while (start <= end) {
            int mid = (start + end) / 2;
            if (des == arr[mid]) {
                //å¦‚æœ mid ç­‰äº 0ï¼Œé‚£è¿™ä¸ªå…ƒç´ å·²ç»æ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œé‚£è‚¯å®šæ˜¯æˆ‘è¦æ‰¾çš„
                if (mid == 0 || a[mid - 1] != des) {
                    return mid;
                } else {
                    //a[mid]å‰é¢çš„ä¸€ä¸ªå…ƒç´  a[mid-1]ä¹Ÿç­‰äº valueï¼Œ
                    //è¦æ‰¾çš„å…ƒç´ è‚¯å®šå‡ºç°åœ¨[low, mid-1]ä¹‹é—´
                    high = mid - 1
                }
            } else if (des > arr[mid]) {
                start = mid + 1;
            } else if (des < arr[mid]) {
                end = mid - 1;
            }
        }
        return -1;
    }
```





***



## åŒ¹é…

### BF

Brute Force æš´åŠ›åŒ¹é…ç®—æ³•ï¼š

```java
public static void main(String[] args) {
    String s = "seazean";
    String t = "az";
    System.out.println(match(s,t));//2
}

public static int match(String s,String t) {
    int k = 0;
    int i = k, j = 0;
    //é˜²æ­¢è¶Šç•Œ
    while (i < s.length() && j < t.length()) {
        if (s.charAt(i) == t.charAt(j)) {
            ++i;
            ++j;
        } else {
            k++;
            i = k;
            j = 0;
        }
    }
    //è¯´æ˜æ˜¯åŒ¹é…æˆåŠŸ
    if (j >= t.length()) {
        return k;
    }
    return 0;
}
```

å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼šO(m+n)ï¼Œæœ€åæ—¶é—´å¤æ‚åº¦ï¼šO(m*n)



***



### RK

æŠŠä¸»ä¸²å¾—é•¿åº¦è®°ä¸º nï¼Œæ¨¡å¼ä¸²å¾—é•¿åº¦è®°ä¸º mï¼Œé€šè¿‡å“ˆå¸Œç®—æ³•å¯¹ä¸»ä¸²ä¸­çš„ n-m+1 ä¸ªå­ä¸²åˆ†åˆ«æ±‚å“ˆå¸Œå€¼ï¼Œç„¶åé€ä¸ªä¸æ¨¡å¼ä¸²çš„å“ˆå¸Œå€¼æ¯”è¾ƒå¤§å°ï¼Œå¦‚æœæŸä¸ªå­ä¸²çš„å“ˆå¸Œå€¼ä¸æ¨¡å¼ä¸²ç›¸ç­‰ï¼Œå†å»å¯¹æ¯”å€¼æ˜¯å¦ç›¸ç­‰ï¼ˆé˜²æ­¢å“ˆå¸Œå†²çªï¼‰ï¼Œé‚£å°±è¯´æ˜å¯¹åº”çš„å­ä¸²å’Œæ¨¡å¼ä¸²åŒ¹é…äº†

å› ä¸ºå“ˆå¸Œå€¼æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ•°å­—ä¹‹é—´æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰æ˜¯éå¸¸å¿«é€Ÿçš„

ç¬¬ä¸€éƒ¨åˆ†è®¡ç®—å“ˆå¸Œå€¼çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œç¬¬äºŒéƒ¨åˆ†å¯¹æ¯”çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œæ•´ä½“å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œæœ€åä¸º O(n*m)



***



### KMP

KMP åŒ¹é…ï¼š

* next æ•°ç»„çš„æ ¸å¿ƒå°±æ˜¯è‡ªå·±åŒ¹é…è‡ªå·±ï¼Œä¸»ä¸²ä»£è¡¨åç¼€ï¼Œæ¨¡å¼ä¸²ä»£è¡¨å‰ç¼€
* nextVal æ•°ç»„çš„æ ¸å¿ƒå°±æ˜¯å›é€€å¤±é…

```java
public class Kmp {
    public static void main(String[] args) {
        String s = "acababaabc";
        String t = "abaabc";
        //[-1, 0, 0, 1, 1, 2]
        System.out.println(Arrays.toString(getNext(t)));
        //[-1, 0, -1, 1, 0, 2]
        System.out.println(Arrays.toString(getNextVal(t)));
        //5
        System.out.println(kmp(s, t));
    }

    private static int kmp(String s, String t) {
        int[] next = getNext(t);
        int i = 0, j = 0;
        while (i < s.length() && j < t.length()) {
            //j==-1æ—¶è¯´æ˜ç¬¬ä¸€ä¸ªä½ç½®åŒ¹é…å¤±è´¥ï¼Œæ‰€ä»¥å°†sçš„ä¸‹ä¸€ä¸ªå’Œtçš„é¦–å­—ç¬¦æ¯”è¾ƒ
            if (j == -1 || s.charAt(i) == t.charAt(j)) {
                i++;
                j++;
            } else {
                //æ¨¡å¼ä¸²å³ç§»ï¼Œæ¯”è¾ƒsçš„å½“å‰ä½ç½®ä¸tçš„next[j]ä½ç½®
                j = next[j];
            }
        }
        if (j >= t.length()) {
            return i - j + 1;
        }
        return -1;
    }
	//nextæ•°ç»„
    private static int[] getNext(String t) {
        int[] next = new int[t.length()];
        next[0] = -1;
        int j = -1;
        int i = 0;
        while (i < t.length() - 1) {
            // æ ¹æ®å·²çŸ¥çš„å‰jä½æ¨æµ‹ç¬¬j+1ä½
            // j=-1è¯´æ˜é¦–ä½å°±æ²¡æœ‰åŒ¹é…ï¼Œå³t[0]!=t[i]ï¼Œè¯´æ˜next[i+1]æ²¡æœ‰æœ€å¤§å‰ç¼€ï¼Œä¸º0
            if (j == -1 || t.charAt(i) == t.charAt(j)) {
                // å› ä¸ºæ¨¡å¼ä¸²å·²ç»åŒ¹é…åˆ°äº†ç´¢å¼•jå¤„ï¼Œè¯´æ˜ä¹‹å‰çš„ä½éƒ½æ˜¯ç›¸ç­‰çš„
                // å› ä¸ºæ˜¯è‡ªå·±åŒ¹é…è‡ªå·±ï¼Œæ‰€ä»¥æ¨¡å¼ä¸²å°±æ˜¯å‰ç¼€ï¼Œä¸»ä¸²å°±æ˜¯åç¼€ï¼Œjå°±æ˜¯æœ€é•¿å…¬å…±å‰ç¼€
                // å½“i+1ä½ç½®ä¸åŒ¹é…æ—¶ï¼ˆiä½ä¹‹å‰åŒ¹é…ï¼‰ï¼Œå¯ä»¥è·³è½¬åˆ°j+1ä½ç½®å¯¹æ¯”ï¼Œnext[i+1]=j+1
                i++;
                j++;
                next[i] = j;
            } else {
                //iä½ç½®çš„æ•°æ®å’Œjä½ç½®çš„ä¸ç›¸ç­‰ï¼Œæ‰€ä»¥å›é€€å¯¹æ¯”iå’Œnext[j]ä½ç½®çš„æ•°æ®
                j = next[j];
            }

        }
        return next;
    }
	//nextVal
    private static int[] getNextVal(String t) {
        int[] nextVal = new int[t.length()];
        nextVal[0] = -1;
        int j = -1;
        int i = 0;
        while (i < t.length() - 1) {
            if (j == -1 || t.charAt(i) == t.charAt(j)) {
                i++;
                j++;
                // å¦‚æœt[i+1] == t[next(i+1)]=next[j+1]ï¼Œå›é€€åä»ç„¶å¤±é…ï¼Œæ‰€ä»¥è¦ç»§ç»­å›é€€
                if (t.charAt(i) == t.charAt(j)) {
                    nextVal[i] = nextVal[j];
                } else {
                    nextVal[i] = j;
                }
            } else {
                j = nextVal[j];
            }
        }
        return nextVal;
    }
}
```

å¹³å‡å’Œæœ€åæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(m+n)



å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/tangzhengyue/p/4315393.html



***



## æ ‘

### äºŒå‰æ ‘

äºŒå‰æ ‘ä¸­ï¼Œä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„åº¦è¦å°äºç­‰äº 2

+ èŠ‚ç‚¹ï¼šåœ¨æ ‘ç»“æ„ä¸­,æ¯ä¸€ä¸ªå…ƒç´ ç§°ä¹‹ä¸ºèŠ‚ç‚¹
+ åº¦ï¼šæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°é‡ç§°ä¹‹ä¸ºåº¦

<img src="https://gitee.com/seazean/images/raw/master/Java/äºŒå‰æ ‘ç»“æ„å›¾.png" alt="äºŒå‰æ ‘ç»“æ„å›¾" style="zoom:80%;" />



****



### æ’åºæ ‘

#### å­˜å‚¨ç»“æ„

äºŒå‰æ’åºæ ‘ï¼ˆBSTï¼‰ï¼Œåˆç§°äºŒå‰æŸ¥æ‰¾æ ‘æˆ–è€…äºŒå‰æœç´¢æ ‘

+ æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæœ€å¤šæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹
+ å·¦å­æ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„å€¼éƒ½å°äºæ ¹èŠ‚ç‚¹çš„å€¼
+ å³å­æ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„å€¼éƒ½å¤§äºæ ¹èŠ‚ç‚¹çš„å€¼
+ ä¸å­˜åœ¨é‡å¤çš„èŠ‚ç‚¹

<img src="https://gitee.com/seazean/images/raw/master/Java/äºŒå‰æŸ¥æ‰¾æ ‘ç»“æ„å›¾.png" alt="äºŒå‰æŸ¥æ‰¾æ ‘" style="zoom: 80%;" />





***



#### ä»£ç å®ç°

* èŠ‚ç‚¹ç±»ï¼š

  ```java
  private static class TreeNode {
      int key;
      TreeNode left;  //å·¦èŠ‚ç‚¹
      TreeNode right; //å³èŠ‚ç‚¹
  
      private TreeNode(int key) {
          this.key = key;
      }
  }
  ```

* æŸ¥æ‰¾èŠ‚ç‚¹ï¼š

  ```java
   // é€’å½’æŸ¥æ‰¾
  private static TreeNode search(TreeNode root, int key) {
      //é€’å½’ç»“æŸçš„æ¡ä»¶
      if (root == null) {
          return null;
      }
      if (key == root.key) {
          return root;
      } else if (key > root.key) {
          return search(root.right, key);
      } else {
          return search(root.left, key);
      }
  }
  
  // éé€’å½’
  private static TreeNode search1(TreeNode root, int key) {
      while (root != null) {
          if (key == root.key) {
              return root;
          } else if (key > root.key) {
              root = root.right;
          } else {
              root = root.left;
          }
      }
      return null;
  }
  ```

* æ’å…¥èŠ‚ç‚¹ï¼š

  ```java
  private static int insert(TreeNode root, int key) {
      if (root == null) {
          root = new TreeNode(key);
          root.left = null;
          root.right = null;
          return 1;
      } else {
          if (key == root.key) {
              return 0;
          } else if (key > root.key) {
              return insert(root.right, key);
          } else {
              return insert(root.left, key);
          }
      }
  }
  ```

* æ„é€ å‡½æ•°ï¼š

  ```java
  // æ„é€ å‡½æ•°ï¼Œè¿”å›æ ¹èŠ‚ç‚¹
  private static TreeNode createBST(int[] arr) {
      if (arr.length > 0) {
          TreeNode root = new TreeNode(arr[0]);
          for (int i = 1; i < arr.length; i++) {
              insert(root, arr[i]);
          }
          return root;
      }
      return null;
  }
  ```

* åˆ é™¤èŠ‚ç‚¹ï¼šè¦åˆ é™¤èŠ‚ç‚¹12ï¼Œå…ˆæ‰¾åˆ°èŠ‚ç‚¹19ï¼Œç„¶åç§»åŠ¨å¹¶æ›¿æ¢èŠ‚ç‚¹12<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-äºŒå‰æŸ¥æ‰¾æ ‘åˆ é™¤èŠ‚ç‚¹.png" style="zoom: 50%;" />

  ä»£ç é“¾æ¥ï¼šhttps://leetcode-cn.com/submissions/detail/190232548/

  

å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1iJ411E7xW?t=756&p=86

å›¾ç‰‡æ¥æºï¼šhttps://leetcode-cn.com/problems/delete-node-in-a-bst/solution/tu-jie-yi-dong-jie-dian-er-bu-shi-xiu-ga-edtn/



***



### å¹³è¡¡æ ‘

å¹³è¡¡äºŒå‰æ ‘ï¼ˆAVLï¼‰çš„ç‰¹ç‚¹ï¼š

+ äºŒå‰æ ‘å·¦å³ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®ä¸è¶…è¿‡1
+ ä»»æ„èŠ‚ç‚¹çš„å·¦å³ä¸¤ä¸ªå­æ ‘éƒ½æ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘

å¹³è¡¡äºŒå‰æ ‘æ—‹è½¬ï¼š

+ æ—‹è½¬è§¦å‘æ—¶æœºï¼šå½“æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œè¯¥æ ‘ä¸å†æ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘

+ å¹³è¡¡äºŒå‰æ ‘å’ŒäºŒå‰æŸ¥æ‰¾æ ‘å¯¹æ¯”ç»“æ„å›¾

![å¹³è¡¡äºŒå‰æ ‘å’ŒäºŒå‰æŸ¥æ‰¾æ ‘å¯¹æ¯”](https://gitee.com/seazean/images/raw/master/Java/å¹³è¡¡äºŒå‰æ ‘å’ŒäºŒå‰æŸ¥æ‰¾æ ‘å¯¹æ¯”ç»“æ„å›¾.png)

+ å·¦æ—‹ï¼šå°†æ ¹èŠ‚ç‚¹çš„å³ä¾§å¾€å·¦æ‹‰ï¼ŒåŸå…ˆçš„å³å­èŠ‚ç‚¹å˜æˆæ–°çš„çˆ¶èŠ‚ç‚¹ï¼Œå¹¶æŠŠå¤šä½™çš„å·¦å­èŠ‚ç‚¹å‡ºè®©ï¼Œç»™å·²ç»é™çº§çš„æ ¹èŠ‚ç‚¹å½“å³å­èŠ‚ç‚¹

  ![å¹³è¡¡äºŒå‰æ ‘å·¦æ—‹](https://gitee.com/seazean/images/raw/master/Java/å¹³è¡¡äºŒå‰æ ‘å·¦æ—‹01.png)

* å³æ—‹ï¼šå°†æ ¹èŠ‚ç‚¹çš„å·¦ä¾§å¾€å³æ‹‰ï¼Œå·¦å­èŠ‚ç‚¹å˜æˆäº†æ–°çš„çˆ¶èŠ‚ç‚¹ï¼Œå¹¶æŠŠå¤šä½™çš„å³å­èŠ‚ç‚¹å‡ºè®©ï¼Œç»™å·²ç»é™çº§æ ¹èŠ‚ç‚¹å½“å·¦å­èŠ‚ç‚¹

  ![å¹³è¡¡äºŒå‰æ ‘å³æ—‹](https://gitee.com/seazean/images/raw/master/Java/å¹³è¡¡äºŒå‰æ ‘å³æ—‹01.png)

æ¨èæ–‡ç« ï¼šhttps://pdai.tech/md/algorithm/alg-basic-tree-balance.html




***



### çº¢é»‘æ ‘

çº¢é»‘æ ‘çš„ç‰¹ç‚¹ï¼š

* æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ˜¯çº¢æˆ–è€…é»‘

+ çº¢é»‘æ ‘ä¸æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå®ƒçš„å¹³è¡¡æ˜¯é€šè¿‡"è‡ªå·±çš„çº¢é»‘è§„åˆ™"è¿›è¡Œå®ç°çš„

çº¢é»‘æ ‘çš„çº¢é»‘è§„åˆ™æœ‰å“ªäº›ï¼š

1. æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ–æ˜¯çº¢è‰²çš„ï¼Œæˆ–è€…æ˜¯é»‘è‰²çš„
2. æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²
3. å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹æˆ–è€…çˆ¶èŠ‚ç‚¹ï¼Œåˆ™è¯¥èŠ‚ç‚¹ç›¸åº”çš„æŒ‡é’ˆå±æ€§å€¼ä¸º Nilï¼Œè¿™äº› Nil è§†ä¸ºå¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªå¶èŠ‚ç‚¹(Nil) æ˜¯é»‘è‰²çš„
4. å¦‚æœæŸä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²ï¼ˆä¸èƒ½å‡ºç°ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿çš„æƒ…å†µï¼‰
5. å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»è¯¥èŠ‚ç‚¹åˆ°å…¶æ‰€æœ‰åä»£å¶èŠ‚ç‚¹çš„ç®€å•è·¯å¾„ä¸Šï¼Œå‡åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹

çº¢é»‘æ ‘ä¸ AVL æ ‘çš„æ¯”è¾ƒï¼š

* AVL æ ‘æ˜¯æ›´åŠ ä¸¥æ ¼çš„å¹³è¡¡ï¼Œå¯ä»¥æä¾›æ›´å¿«çš„æŸ¥æ‰¾é€Ÿåº¦ï¼Œé€‚ç”¨äºè¯»å–æŸ¥æ‰¾å¯†é›†å‹ä»»åŠ¡
* çº¢é»‘æ ‘åªæ˜¯åšåˆ°äº†è¿‘ä¼¼å¹³è¡¡ï¼Œå¹¶ä¸æ˜¯ä¸¥æ ¼çš„å¹³è¡¡ï¼Œçº¢é»‘æ ‘çš„æ’å…¥åˆ é™¤æ¯” AVL æ ‘æ›´ä¾¿äºæ§åˆ¶æ“ä½œï¼Œçº¢é»‘æ ‘æ›´é€‚åˆäºæ’å…¥ä¿®æ”¹å¯†é›†å‹ä»»åŠ¡

- çº¢é»‘æ ‘æ•´ä½“æ€§èƒ½ç•¥ä¼˜äº AVL æ ‘ï¼ŒAVL æ ‘çš„æ—‹è½¬æ¯”çº¢é»‘æ ‘çš„æ—‹è½¬å¤šï¼Œæ›´åŠ éš¾ä»¥å¹³è¡¡å’Œè°ƒè¯•ï¼Œæ’å…¥å’Œåˆ é™¤çš„æ•ˆç‡æ¯”çº¢é»‘æ ‘æ…¢ã€‚

![çº¢é»‘æ ‘](https://gitee.com/seazean/images/raw/master/Java/çº¢é»‘æ ‘ç»“æ„å›¾.png)



çº¢é»‘æ ‘æ·»åŠ èŠ‚ç‚¹çš„é»˜è®¤é¢œè‰²ä¸ºçº¢è‰²ï¼Œæ•ˆç‡é«˜
![](https://gitee.com/seazean/images/raw/master/Java/çº¢é»‘æ ‘æ·»åŠ èŠ‚ç‚¹é¢œè‰².png)



**çº¢é»‘æ ‘æ·»åŠ èŠ‚ç‚¹åå¦‚ä½•ä¿æŒçº¢é»‘è§„åˆ™ï¼š**

+ æ ¹èŠ‚ç‚¹ä½ç½®
  + ç›´æ¥å˜ä¸ºé»‘è‰²
+ éæ ¹èŠ‚ç‚¹ä½ç½®
  + çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²
    + ä¸éœ€è¦ä»»ä½•æ“ä½œ,é»˜è®¤çº¢è‰²å³å¯
  + çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²
    + å”å”èŠ‚ç‚¹ä¸ºçº¢è‰²
      1. å°†"çˆ¶èŠ‚ç‚¹"è®¾ä¸ºé»‘è‰²,å°†"å”å”èŠ‚ç‚¹"è®¾ä¸ºé»‘è‰²
      2. å°†"ç¥–çˆ¶èŠ‚ç‚¹"è®¾ä¸ºçº¢è‰²
      3. å¦‚æœ"ç¥–çˆ¶èŠ‚ç‚¹"ä¸ºæ ¹èŠ‚ç‚¹,åˆ™å°†æ ¹èŠ‚ç‚¹å†æ¬¡å˜æˆé»‘è‰²
    + å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²
      1. å°†"çˆ¶èŠ‚ç‚¹"è®¾ä¸ºé»‘è‰²
      2. å°†"ç¥–çˆ¶èŠ‚ç‚¹"è®¾ä¸ºçº¢è‰²
      3. ä»¥"ç¥–çˆ¶èŠ‚ç‚¹"ä¸ºæ”¯ç‚¹è¿›è¡Œæ—‹è½¬





***



### å¹¶æŸ¥é›†

#### åŸºæœ¬å®ç°

å¹¶æŸ¥é›†æ˜¯ä¸€ç§æ ‘å‹çš„æ•°æ®ç»“æ„ï¼Œæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

* æ¯ä¸ªå…ƒç´ éƒ½å”¯ä¸€çš„å¯¹åº”ä¸€ä¸ªç»“ç‚¹
* æ¯ä¸€ç»„æ•°æ®ä¸­çš„å¤šä¸ªå…ƒç´ éƒ½åœ¨åŒä¸€é¢—æ ‘ä¸­
* ä¸€ä¸ªç»„ä¸­çš„æ•°æ®å¯¹åº”çš„æ ‘å’Œå¦å¤–ä¸€ä¸ªç»„ä¸­çš„æ•°æ®å¯¹åº”çš„æ ‘ä¹‹é—´æ²¡æœ‰ä»»ä½•è”ç³»
* å…ƒç´ åœ¨æ ‘ä¸­å¹¶æ²¡æœ‰å­çˆ¶çº§å…³ç³»çš„ç¡¬æ€§è¦æ±‚

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å¹¶æŸ¥é›†.png" style="zoom:50%;" />

å¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

* æŸ¥è¯¢å…ƒç´  p å’Œå…ƒç´  q æ˜¯å¦å±äºåŒä¸€ç»„
* åˆå¹¶å…ƒç´  p å’Œå…ƒç´  q æ‰€åœ¨çš„ç»„

å­˜å‚¨ç»“æ„ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å¹¶æŸ¥é›†å­˜å‚¨ç»“æ„.png" style="zoom:67%;" />

åˆå¹¶æ–¹å¼ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å¹¶æŸ¥é›†åˆå¹¶.png" style="zoom:67%;" />



ä»£ç å®ç°ï¼š

* ç±»å®ç°ï¼š

  ```java
  public class UF {
      //è®°å½•èŠ‚ç‚¹å…ƒç´ å’Œè¯¥å…ƒç´ æ‰€åœ¨åˆ†ç»„çš„æ ‡è¯†
      private int[] eleAndGroup;
      //è®°å½•åˆ†ç»„çš„ä¸ªæ•°
      private int count;
  
      //åˆå§‹åŒ–å¹¶æŸ¥é›†
      public UF(int N) {
          //åˆå§‹åŒ–åˆ†ç»„æ•°é‡
          this.count = N;
          //åˆå§‹åŒ–eleAndGroupæ•°é‡
          this.eleAndGroup = new int[N];
          //åˆå§‹åŒ–eleAndGroupä¸­çš„å…ƒç´ åŠå…¶æ‰€åœ¨åˆ†ç»„çš„æ ‡è¯†ç¬¦ï¼ŒeleAndGroupç´¢å¼•ä½œä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„å…ƒç´ 
          //æ¯ä¸ªç´¢å¼•å¤„çš„å€¼å°±æ˜¯è¯¥ç»„çš„ç´¢å¼•ï¼Œå°±æ˜¯è¯¥å…ƒç´ æ‰€åœ¨çš„ç»„çš„æ ‡è¯†ç¬¦
          for (int i = 0; i < eleAndGroup.length; i++) {
              eleAndGroup[i] = i;
          }
      }
  
      //æŸ¥è¯¢pæ‰€åœ¨çš„åˆ†ç»„çš„æ ‡è¯†ç¬¦
      public int find(int p) {
          return eleAndGroup[p];
      }
  
      //åˆ¤æ–­å¹¶æŸ¥é›†ä¸­å…ƒç´ på’Œå…ƒç´ qæ˜¯å¦åœ¨åŒä¸€åˆ†ç»„ä¸­
      public boolean connect(int p, int q) {
          return find(p) == find(q);
      }
  
      //æŠŠpå…ƒç´ æ‰€åœ¨åˆ†ç»„å’Œqå…ƒç´ æ‰€åœ¨åˆ†ç»„åˆå¹¶
      public void union(int p, int q) {
          //åˆ¤æ–­å…ƒç´ qå’Œpæ˜¯å¦å·²ç»åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­ï¼Œå¦‚æœå·²ç»åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­ï¼Œåˆ™ç»“æŸæ–¹æ³•å°±å¯ä»¥äº†
          if (connect(p, q)) {
              return;
          }
          int pGroup = find(p);//æ‰¾åˆ°pæ‰€åœ¨åˆ†ç»„çš„æ ‡è¯†ç¬¦
          int qGroup = find(q);//æ‰¾åˆ°qæ‰€åœ¨åˆ†ç»„çš„æ ‡è¯†ç¬¦
  
          //åˆå¹¶ç»„ï¼Œè®©pæ‰€åœ¨ç»„çš„ æ‰€æœ‰å…ƒç´  çš„ç»„æ ‡è¯†ç¬¦å˜ä¸ºqæ‰€åœ¨åˆ†ç»„çš„æ ‡è¯†ç¬¦
          for (int i = 0; i < eleAndGroup.length; i++) {
              if (eleAndGroup[i] == pGroup) {
                  eleAndGroup[i] = qGroup;
              }
          }
          //åˆ†ç»„ä¸ªæ•°-1
          this.count--;
      }
  }
  ```

* æµ‹è¯•ä»£ç ï¼š

  ```java
  public static void main(String[] args) {
      //åˆ›å»ºå¹¶æŸ¥é›†å¯¹è±¡
      UF uf = new UF(5);
      System.out.println(uf);
  
      //ä»æ§åˆ¶å°å½•å…¥ä¸¤ä¸ªåˆå¹¶çš„å…ƒç´ ï¼Œè°ƒç”¨unionæ–¹æ³•åˆå¹¶ï¼Œè§‚å¯Ÿåˆå¹¶åå¹¶æŸ¥é›†çš„åˆ†ç»„
      Scanner sc = new Scanner(System.in);
  
      while (true) {
          System.out.println("è¾“å…¥ç¬¬ä¸€ä¸ªè¦åˆå¹¶çš„å…ƒç´ ");
          int p = sc.nextInt();
          System.out.println("è¾“å…¥ç¬¬äºŒä¸ªè¦åˆå¹¶çš„å…ƒç´ ");
          int q = sc.nextInt();
          if (uf.connect(p, q)) {
              System.out.println(p + "å…ƒç´ å·²ç»å’Œ" + q + "å…ƒç´ å·²ç»åœ¨åŒä¸€ä¸ªç»„");
              continue;
          }
          uf.union(p, q);
          System.out.println("å½“å‰å¹¶æŸ¥é›†ä¸­è¿˜æœ‰ï¼š" + uf.count() + "ä¸ªåˆ†ç»„");
          System.out.println(uf);
          System.out.println("********************");
      }
  }
  ```

æœ€åæƒ…å†µä¸‹ union ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ O(N^2)



****



#### ä¼˜åŒ–å®ç°

è®©æ¯ä¸ªç´¢å¼•å¤„çš„èŠ‚ç‚¹éƒ½æŒ‡å‘å®ƒçš„çˆ¶èŠ‚ç‚¹ï¼Œå½“ eleGroup[i] = i æ—¶ï¼Œè¯´æ˜ i æ˜¯æ ¹èŠ‚ç‚¹

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å¹¶æŸ¥é›†ä¼˜åŒ–.png" style="zoom: 67%;" />

```java
//æŸ¥è¯¢pæ‰€åœ¨çš„åˆ†ç»„çš„æ ‡è¯†ç¬¦ï¼Œé€’å½’å¯»æ‰¾çˆ¶æ ‡è¯†ç¬¦ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹
public int findRoot(int p) {
    while (p != eleAndGroup[p]) {
        p = eleAndGroup[p];
    }
    //p == eleGroup[p]ï¼Œè¯´æ˜pæ˜¯æ ¹èŠ‚ç‚¹
    return p;
}

//åˆ¤æ–­å¹¶æŸ¥é›†ä¸­å…ƒç´ på’Œå…ƒç´ qæ˜¯å¦åœ¨åŒä¸€åˆ†ç»„ä¸­
public boolean connect(int p, int q) {
    return findRoot(p) == findRoot(q);
}

//æŠŠpå…ƒç´ æ‰€åœ¨åˆ†ç»„å’Œqå…ƒç´ æ‰€åœ¨åˆ†ç»„åˆå¹¶
public void union(int p, int q) {
    //æ‰¾åˆ°p qå¯¹åº”çš„æ ¹èŠ‚ç‚¹
    int pRoot = findRoot(p);
    int qRoot = findRoot(q);
    if (pRoot == qRoot) {
        return;
    }
    //è®©pæ‰€åœ¨æ ‘çš„èŠ‚ç‚¹æ ¹èŠ‚ç‚¹ä¸ºqçš„æ‰€åœ¨çš„æ ¹èŠ‚ç‚¹ï¼Œåªéœ€è¦æŠŠæ ¹èŠ‚ç‚¹æ”¹ä¸€ä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)
    eleAndGroup[pRoot] = qRoot;
    this.count-
}
```

å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œæœ€åæ—¶é—´å¤æ‚åº¦æ˜¯ O(N^2)

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å¹¶æŸ¥é›†æ—¶é—´å¤æ‚åº¦.png" style="zoom:67%;" />

ç»§ç»­ä¼˜åŒ–ï¼šè·¯å¾„å‹ç¼©ï¼Œä¿è¯æ¯æ¬¡æŠŠå°æ ‘åˆå¹¶åˆ°å¤§æ ‘

```java
public class UF_Tree_Weighted {
    private int[] eleAndGroup;
    private int count;
    private int[] size;//å­˜å‚¨æ¯ä¸€ä¸ªæ ¹ç»“ç‚¹å¯¹åº”çš„æ ‘ä¸­çš„ä¿å­˜çš„èŠ‚ç‚¹çš„ä¸ªæ•°

    //åˆå§‹åŒ–å¹¶æŸ¥é›†
    public UF_Tree_Weighted(int N) {
        this.count = N;
        this.eleAndGroup = new int[N];
        for (int i = 0; i < eleAndGroup.length; i++) {
            eleAndGroup[i] = i;
        }
        this.size = new int[N];
        //é»˜è®¤æƒ…å†µä¸‹ï¼Œsizeä¸­æ¯ä¸ªç´¢å¼•å¤„çš„å€¼éƒ½æ˜¯1
        for (int i = 0; i < size.length; i++) {
            size[i] = 1;
        }
    }
	//æŸ¥è¯¢pæ‰€åœ¨çš„åˆ†ç»„çš„æ ‡è¯†ç¬¦ï¼Œçˆ¶æ ‡è¯†ç¬¦
    public int findRoot(int p) {
        while (p != eleAndGroup[p]) {
            p = eleAndGroup[p];
        }
        return p;
    }

    //åˆ¤æ–­å¹¶æŸ¥é›†ä¸­å…ƒç´ på’Œå…ƒç´ qæ˜¯å¦åœ¨åŒä¸€åˆ†ç»„ä¸­
    public boolean connect(int p, int q) {
        return findRoot(p) == findRoot(q);
    }

    //æŠŠpå…ƒç´ æ‰€åœ¨åˆ†ç»„å’Œqå…ƒç´ æ‰€åœ¨åˆ†ç»„åˆå¹¶
    public void union(int p, int q) {
        //æ‰¾åˆ°p qå¯¹åº”çš„æ ¹èŠ‚ç‚¹
        int pRoot = findRoot(p);
        int qRoot = findRoot(q);
        if (pRoot == qRoot) {
            return;
        }
        //åˆ¤æ–­pRootå¯¹åº”çš„æ ‘å¤§è¿˜æ˜¯qRootå¯¹åº”çš„æ ‘å¤§ï¼Œæœ€ç»ˆéœ€è¦æŠŠè¾ƒå°çš„æ ‘åˆå¹¶åˆ°è¾ƒå¤§çš„æ ‘ä¸­
        if (size[pRoot] < size[qRoot]) {
            eleAndGroup[pRoot] = qRoot;
            size[qRoot] += size[pRoot];
        } else {
            eleAndGroup[qRoot] = pRoot;
            size[pRoot] += size[qRoot];
        }
        //ç»„çš„æ•°é‡-1ã€
        this.count--;
    }
}
```



***



#### åº”ç”¨åœºæ™¯

å¹¶æŸ¥é›†å­˜å‚¨çš„æ¯ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå¤§å‹è®¡ç®—æœºç½‘ç»œä¸­çš„è®¡ç®—æœºï¼š

* å¯ä»¥é€šè¿‡ connected(int p, int q) æ¥æ£€æµ‹è¯¥ç½‘ç»œä¸­çš„æŸä¸¤å°è®¡ç®—æœºä¹‹é—´æ˜¯å¦è¿é€š
* å¯ä»¥è°ƒç”¨ union(int p,int q) ä½¿å¾— p å’Œ q ä¹‹é—´è¿é€šï¼Œè¿™æ ·ä¸¤å°è®¡ç®—æœºä¹‹é—´å°±å¯ä»¥é€šä¿¡

ç•…é€šå·¥ç¨‹ï¼šæŸçœè°ƒæŸ¥åŸé•‡äº¤é€šçŠ¶å†µï¼Œå¾—åˆ°ç°æœ‰åŸé•‡é“è·¯ç»Ÿè®¡è¡¨ï¼Œè¡¨ä¸­åˆ—å‡ºäº†æ¯æ¡é“è·¯ç›´æ¥è¿é€šçš„åŸé•‡ã€‚çœæ”¿åºœç•…é€šå·¥ç¨‹çš„ç›®æ ‡æ˜¯ä½¿å…¨çœä»»ä½•ä¸¤ä¸ªåŸé•‡é—´éƒ½å¯ä»¥å®ç°äº¤é€šï¼Œä½†ä¸ä¸€å®šæœ‰ç›´æ¥çš„é“è·¯ç›¸è¿ï¼Œåªè¦äº’ç›¸é—´æ¥é€šè¿‡é“è·¯å¯è¾¾å³å¯ï¼Œé—®æœ€å°‘è¿˜éœ€è¦å»ºè®¾å¤šå°‘æ¡é“è·¯ï¼Ÿ

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-åº”ç”¨åœºæ™¯.png" style="zoom:67%;" />

è§£é¢˜æ€è·¯ï¼š

1. åˆ›å»ºä¸€ä¸ªå¹¶æŸ¥é›† UF_Tree_Weighted(20)
2. åˆ†åˆ«è°ƒç”¨ union(0,1)ã€union(6,9)ã€union(3,8)ã€union(5,11)ã€union(2,12)ã€union(6,10)ã€union(4,8)ï¼Œè¡¨ç¤ºå·²ç»ä¿®å»ºå¥½çš„é“è·¯æŠŠå¯¹åº”çš„åŸå¸‚è¿æ¥èµ·æ¥
3. å¦‚æœåŸå¸‚å…¨éƒ¨è¿æ¥èµ·æ¥ï¼Œé‚£ä¹ˆå¹¶æŸ¥é›†ä¸­å‰©ä½™çš„åˆ†ç»„æ•°ç›®ä¸º 1ï¼Œæ‰€æœ‰çš„åŸå¸‚éƒ½åœ¨ä¸€ä¸ªæ ‘ä¸­ï¼Œåªéœ€è¦è·å–å½“å‰å¹¶æŸ¥é›†ä¸­å‰©ä½™çš„æ•°ç›®å‡å» 1ï¼Œå°±æ˜¯è¿˜éœ€è¦ä¿®å»ºçš„é“è·¯æ•°ç›®

```java
public static void main(String[] args)throws Exception {
    Scanner sc = new Scanner(System.in);
    //è¯»å–åŸå¸‚æ•°ç›®ï¼Œåˆå§‹åŒ–å¹¶æŸ¥é›†
    int number = sc.nextInt();
    //è¯»å–å·²ç»ä¿®å»ºå¥½çš„é“è·¯æ•°ç›®
    int roadNumber = sc.nextInt();
    UF_Tree_Weighted uf = new UF_Tree_Weighted(number);
    //å¾ªç¯è¯»å–å·²ç»ä¿®å»ºå¥½çš„é“è·¯ï¼Œå¹¶è°ƒç”¨unionæ–¹æ³•
    for (int i = 0; i < roadNumber; i++) {
        int p = sc.nextInt();
        int q = sc.nextInt();
        uf.union(p,q);
    }
    //è·å–å‰©ä½™çš„åˆ†ç»„æ•°é‡
    int groupNumber = uf.count();
    //è®¡ç®—å‡ºè¿˜éœ€è¦ä¿®å»ºçš„é“è·¯
    System.out.println("è¿˜éœ€è¦ä¿®å»º"+(groupNumber-1)+"é“è·¯ï¼ŒåŸå¸‚æ‰èƒ½ç›¸é€š");
}
```



å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1iJ411E7xW?p=142



***



### å­—å…¸æ ‘

#### åŸºæœ¬ä»‹ç»

Trie æ ‘ï¼Œä¹Ÿå«å­—å…¸æ ‘ï¼Œæ˜¯ä¸€ç§ä¸“é—¨å¤„ç†å­—ç¬¦ä¸²åŒ¹é…çš„æ ‘å½¢ç»“æ„ï¼Œç”¨æ¥è§£å†³åœ¨ä¸€ç»„å­—ç¬¦ä¸²é›†åˆä¸­å¿«é€ŸæŸ¥æ‰¾æŸä¸ªå­—ç¬¦ä¸²çš„é—®é¢˜ï¼ŒTrie æ ‘çš„æœ¬è´¨å°±æ˜¯åˆ©ç”¨å­—ç¬¦ä¸²ä¹‹é—´çš„å…¬å…±å‰ç¼€ï¼Œå°†é‡å¤çš„å‰ç¼€åˆå¹¶åœ¨ä¸€èµ·

* æ ¹èŠ‚ç‚¹ä¸åŒ…å«ä»»ä½•ä¿¡æ¯
* æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼Œä»**æ ¹èŠ‚ç‚¹åˆ°çº¢è‰²èŠ‚ç‚¹çš„ä¸€æ¡è·¯å¾„è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²**
* çº¢è‰²èŠ‚ç‚¹å¹¶ä¸éƒ½æ˜¯å¶å­èŠ‚ç‚¹

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å­—å…¸æ ‘æ„é€ è¿‡ç¨‹1.png" style="zoom: 50%;" />

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å­—å…¸æ ‘æ„é€ è¿‡ç¨‹2.png" style="zoom:50%;" />

æ³¨æ„ï¼šè¦æŸ¥æ‰¾çš„æ˜¯å­—ç¬¦ä¸²â€œheâ€ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ²¿ç€æŸæ¡è·¯å¾„æ¥åŒ¹é…ï¼Œå¯ä»¥åŒ¹é…æˆåŠŸã€‚ä½†æ˜¯è·¯å¾„çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹â€œeâ€å¹¶ä¸æ˜¯çº¢è‰²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œheâ€æ˜¯æŸä¸ªå­—ç¬¦ä¸²çš„å‰ç¼€å­ä¸²ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨åŒ¹é…ä»»ä½•å­—ç¬¦ä¸²



***



#### å®ç°Trie

é€šè¿‡ä¸€ä¸ªä¸‹æ ‡ä¸å­—ç¬¦ä¸€ä¸€æ˜ å°„çš„æ•°ç»„ï¼Œæ¥å­˜å‚¨å­èŠ‚ç‚¹çš„æŒ‡é’ˆ

<img src="https://gitee.com/seazean/images/raw/master/Java/Tree-å­—å…¸æ ‘å­˜å‚¨ç»“æ„.png" style="zoom:50%;" />

æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼ˆn è¡¨ç¤ºè¦æŸ¥æ‰¾å­—ç¬¦ä¸²çš„é•¿åº¦ï¼‰

```java
public class Trie {
    private TrieNode root = new TrieNode('/');

    //æ’å…¥ä¸€ä¸ªå­—ç¬¦
    public void insert(char[] chars) {
        TrieNode p = root;
        for (int i = 0; i < chars.length; i++) {
            //è·å–å­—ç¬¦çš„ç´¢å¼•ä½ç½®
            int index = chars[i] - 'a';
            if (p.children[index] == null) {
                TrieNode node = new TrieNode(chars[i]);
                p.children[index] = node;
            }
            p = p.children[index];
        }
        p.isEndChar = true;
    }

    //æŸ¥æ‰¾ä¸€ä¸ªå­—ç¬¦ä¸²
    public boolean find(char[] chars) {
        TrieNode p = root;
        for (int i = 0; i < chars.length; i++) {
            int index = chars[i] - 'a';
            if (p.children[index] == null) {
                return false;
            }
            p = p.children[index];
        }
        if (p.isEndChar) {
            //å®Œå…¨åŒ¹é…
            return true;
        } else {
            // ä¸èƒ½å®Œå…¨åŒ¹é…ï¼Œåªæ˜¯å‰ç¼€
            return false;
        }
    }


    private class TrieNode {
        char data;
        TrieNode[] children = new TrieNode[26];//26ä¸ªè‹±æ–‡å­—æ¯
        boolean isEndChar = false;//ç»“å°¾å­—ç¬¦ä¸ºtrue
        public TrieNode(char data) {
            this.data = data;
        }
    }
}
```



***



#### ä¼˜åŒ–Trie

Trie æ ‘æ˜¯éå¸¸è€—å†…å­˜ï¼Œé‡‡å–ç©ºé—´æ¢æ—¶é—´çš„æ€è·¯ã€‚Trie æ ‘çš„å˜ä½“æœ‰å¾ˆå¤šï¼Œå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å†…å­˜æ¶ˆè€—çš„é—®é¢˜ã€‚æ¯”å¦‚ç¼©ç‚¹ä¼˜åŒ–ï¼Œå¯¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè€Œä¸”æ­¤èŠ‚ç‚¹ä¸æ˜¯ä¸€ä¸ªä¸²çš„ç»“æŸèŠ‚ç‚¹ï¼Œå¯ä»¥å°†æ­¤èŠ‚ç‚¹ä¸å­èŠ‚ç‚¹åˆå¹¶

![](https://gitee.com/seazean/images/raw/master/Java/Tree-å­—å…¸æ ‘ç¼©ç‚¹ä¼˜åŒ–.png)



å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/72414



***



## å›¾

å›¾çš„é‚»æ¥è¡¨å½¢å¼ï¼š

```java
public class AGraph {
    private VertexNode[] adjList;   //é‚»æ¥æ•°ç»„
    private int vLen, eLen;         //é¡¶ç‚¹æ•°å’Œè¾¹æ•°

    public AGraph(int vLen, int eLen) {
        this.vLen = vLen;
        this.eLen = eLen;
        adjList = new VertexNode[vLen];
    }
    //å¼§èŠ‚ç‚¹
    private class ArcNode {
        int adjVex;         //è¯¥è¾¹æ‰€æŒ‡å‘çš„é¡¶ç‚¹çš„ä½ç½®
        ArcNode nextArc;    //ä¸‹ä¸€æ¡è¾¹ï¼ˆå¼§ï¼‰
        //int info  		//æ·»åŠ æƒå€¼

        public ArcNode(int adjVex) {
            this.adjVex = adjVex;
            nextArc = null;
        }
    }

    //è¡¨é¡¶ç‚¹
    private class VertexNode {
        char data;      	//é¡¶ç‚¹ä¿¡æ¯
        ArcNode firstArc;  	//æŒ‡å‘ç¬¬ä¸€æ¡è¾¹çš„æŒ‡é’ˆ

        public VertexNode(char data) {
            this.data = data;
            firstArc = null;
        }
    }
}
```

å›¾çš„é‚»æ¥çŸ©é˜µå½¢å¼ï¼š

```java
public class MGraph {
    private int[][] edges;      //é‚»æ¥çŸ©é˜µå®šä¹‰ï¼Œæœ‰æƒå›¾å°†intæ”¹ä¸ºfloat
    private int vLen;           //é¡¶ç‚¹æ•°
    private int eLen;           //è¾¹æ•°
    private VertexNode[] vex;   //å­˜æ”¾èŠ‚ç‚¹ä¿¡æ¯

    public MGraph(int vLen, int eLen) {
        this.vLen = vLen;
        this.eLen = eLen;
        this.edges = new int[vLen][vLen];
        this.vex = new VertexNode[vLen];
    }

    private class VertexNode {
        int num;    //é¡¶ç‚¹ç¼–å·
        String info;  //é¡¶ç‚¹ä¿¡æ¯

        public VertexNode(int num) {
            this.num = num;
            this.info = null;
        }
    }
}
```



å›¾ç›¸å…³çš„ç®—æ³•éœ€è¦å¾ˆå¤šçš„æµç¨‹å›¾ï¼Œæ­¤å¤„ä¸å†ä¸€ä¸€åˆ—ä¸¾ï¼Œæ¨èå‚è€ƒä¹¦ç±ã€Šæ•°æ®ç»“æ„é«˜åˆ†ç¬”è®°ã€‹



***



## ä½å›¾

### åŸºæœ¬ä»‹ç»

å¸ƒéš†è¿‡æ»¤å™¨ï¼šä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡ï¼ˆä½æ•°ç»„ï¼‰å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°ï¼ˆå“ˆå¸Œå‡½æ•°ï¼‰ï¼Œæ—¢ç„¶æ˜¯äºŒè¿›åˆ¶ï¼Œæ¯ä¸ªç©ºé—´å­˜æ”¾çš„ä¸æ˜¯0å°±æ˜¯1ï¼Œä½†æ˜¯åˆå§‹é»˜è®¤å€¼éƒ½æ˜¯0ï¼Œæ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨ä¸å­˜æ•°æ®åªå­˜çŠ¶æ€

<img src="https://gitee.com/seazean/images/raw/master/DB/Redis-Bitmapsæ•°æ®ç»“æ„.png" style="zoom: 80%;" />

è¿™ç§æ•°æ®ç»“æ„æ˜¯é«˜æ•ˆä¸”æ€§èƒ½å¾ˆå¥½çš„ï¼Œä½†ç¼ºç‚¹æ˜¯å…·æœ‰ä¸€å®šçš„é”™è¯¯è¯†åˆ«ç‡å’Œåˆ é™¤éš¾åº¦ã€‚å¹¶ä¸”ï¼Œç†è®ºæƒ…å†µä¸‹ï¼Œæ·»åŠ åˆ°é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§å°±è¶Šå¤§



***



### å·¥ä½œæµç¨‹

å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´  key æ—¶ï¼Œä¼šé€šè¿‡å¤šä¸ª hash å‡½æ•°å¾—åˆ°å¤šä¸ªå“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º 1

![](https://gitee.com/seazean/images/raw/master/DB/Redis-å¸ƒéš†è¿‡æ»¤å™¨æ·»åŠ æ•°æ®.png)

å¸ƒéš†è¿‡æ»¤å™¨æŸ¥è¯¢ä¸€ä¸ªæ•°æ®ï¼Œæ˜¯å¦åœ¨äºŒè¿›åˆ¶çš„é›†åˆä¸­ï¼ŒæŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹ï¼š

- é€šè¿‡ K ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—è¯¥æ•°æ®ï¼Œå¯¹åº”è®¡ç®—å‡ºçš„ K ä¸ªhashå€¼
- é€šè¿‡ hash å€¼æ‰¾åˆ°å¯¹åº”çš„äºŒè¿›åˆ¶çš„æ•°ç»„ä¸‹æ ‡
- åˆ¤æ–­æ–¹æ³•ï¼šå¦‚æœå­˜åœ¨ä¸€å¤„ä½ç½®çš„äºŒè¿›åˆ¶æ•°æ®æ˜¯0ï¼Œé‚£ä¹ˆè¯¥æ•°æ®ä¸å­˜åœ¨ã€‚å¦‚æœéƒ½æ˜¯1ï¼Œè¯¥æ•°æ®å­˜åœ¨é›†åˆä¸­

å¸ƒéš†è¿‡æ»¤å™¨ä¼˜ç¼ºç‚¹ï¼š

* ä¼˜ç‚¹ï¼š
  * äºŒè¿›åˆ¶ç»„æˆçš„æ•°ç»„ï¼Œå ç”¨å†…å­˜æå°‘ï¼Œå¹¶ä¸”æ’å…¥å’ŒæŸ¥è¯¢é€Ÿåº¦éƒ½è¶³å¤Ÿå¿«
  * å»é‡æ–¹ä¾¿ï¼šå½“å­—ç¬¦ä¸²ç¬¬ä¸€æ¬¡å­˜å‚¨æ—¶å¯¹åº”çš„ä½æ•°ç»„ä¸‹æ ‡è®¾ç½®ä¸º 1ï¼Œå½“ç¬¬äºŒæ¬¡å­˜å‚¨ç›¸åŒå­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸ºå¯¹åº”ä½ç½®å·²è®¾ç½®ä¸º 1ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“çŸ¥é“æ­¤å€¼å·²ç»å­˜åœ¨
* ç¼ºç‚¹ï¼š
  * éšç€æ•°æ®çš„å¢åŠ ï¼Œè¯¯åˆ¤ç‡ä¼šå¢åŠ ï¼šæ·»åŠ æ•°æ®æ˜¯é€šè¿‡è®¡ç®—æ•°æ®çš„hashå€¼ï¼Œä¸åŒçš„å­—ç¬¦ä¸²å¯èƒ½å“ˆå¸Œå‡ºæ¥çš„ä½ç½®ç›¸åŒï¼Œå¯¼è‡´æ— æ³•ç¡®å®šåˆ°åº•æ˜¯å“ªä¸ªæ•°æ®å­˜åœ¨ï¼Œ**è¿™ç§æƒ…å†µå¯ä»¥é€‚å½“å¢åŠ ä½æ•°ç»„å¤§å°æˆ–è€…è°ƒæ•´å“ˆå¸Œå‡½æ•°**
  * æ— æ³•åˆ é™¤æ•°æ®ï¼šå¯èƒ½å­˜åœ¨å‡ ä¸ªæ•°æ®å æ®ç›¸åŒçš„ä½ç½®ï¼Œæ‰€ä»¥åˆ é™¤ä¸€ä½ä¼šå¯¼è‡´å¾ˆå¤šæ•°æ®å¤±æ•ˆ

* æ€»ç»“ï¼š**å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¦‚æœåˆ¤æ–­æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£è¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨**



å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ysocean/p/12594982.html



***



### Guava

å¼•å…¥ Guava çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>28.0-jre</version>
</dependency>
```

æŒ‡å®šè¯¯åˆ¤ç‡ä¸ºï¼ˆ0.01ï¼‰ï¼š

```java
public static void main(String[] args) {
    // åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨å¯¹è±¡
    BloomFilter<Integer> filter = BloomFilter.create(
        Funnels.integerFunnel(),
        1500,
        0.01);
    // åˆ¤æ–­æŒ‡å®šå…ƒç´ æ˜¯å¦å­˜åœ¨
    System.out.println(filter.mightContain(1));
    System.out.println(filter.mightContain(2));
    // å°†å…ƒç´ æ·»åŠ è¿›å¸ƒéš†è¿‡æ»¤å™¨
    filter.put(1);
    filter.put(2);
    System.out.println(filter.mightContain(1));
    System.out.println(filter.mightContain(2));
}
```



***



### å®ç°å¸ƒéš†

```java
class MyBloomFilter {
    //å¸ƒéš†è¿‡æ»¤å™¨å®¹é‡
    private static final int DEFAULT_SIZE = 2 << 28;
    //bitæ•°ç»„ï¼Œç”¨æ¥å­˜æ”¾key
    private static BitSet bitSet = new BitSet(DEFAULT_SIZE);
    //åé¢hashå‡½æ•°ä¼šç”¨åˆ°ï¼Œç”¨æ¥ç”Ÿæˆä¸åŒçš„hashå€¼ï¼Œéšæ„è®¾ç½®
    private static final int[] ints = {1, 6, 16, 38, 58, 68};

    //addæ–¹æ³•ï¼Œè®¡ç®—å‡ºkeyçš„hashå€¼ï¼Œå¹¶å°†å¯¹åº”ä¸‹æ ‡ç½®ä¸ºtrue
    public void add(Object key) {
        Arrays.stream(ints).forEach(i -> bitSet.set(hash(key, i)));
    }

    //åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œtrueä¸ä¸€å®šè¯´æ˜keyå­˜åœ¨ï¼Œä½†æ˜¯falseä¸€å®šè¯´æ˜ä¸å­˜åœ¨
    public boolean isContain(Object key) {
        boolean result = true;
        for (int i : ints) {
            //çŸ­è·¯ä¸ï¼Œåªè¦æœ‰ä¸€ä¸ªbitä½ä¸ºfalseï¼Œåˆ™è¿”å›false
            result = result && bitSet.get(hash(key, i));
        }
        return result;
    }

    //hashå‡½æ•°ï¼Œå€Ÿé‰´äº†hashmapçš„æ‰°åŠ¨ç®—æ³•
    private int hash(Object key, int i) {
        int h;
        return key == null ? 0 : (i * (DEFAULT_SIZE - 1) & ((h = key.hashCode()) ^ (h >>> 16)));
    }
}

```







****





# SDP

## è½¯ä»¶è®¾è®¡

### è®¾è®¡æ¨¡å¼

è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼ˆSoftware Design Patternï¼‰ï¼Œæœ¬è´¨æ˜¯é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™çš„å®é™…è¿ç”¨ï¼Œæ˜¯å¯¹ç±»çš„å°è£…æ€§ã€ç»§æ‰¿æ€§å’Œå¤šæ€æ€§ä»¥åŠç±»çš„å…³è”å…³ç³»å’Œç»„åˆå…³ç³»çš„å……åˆ†ç†è§£

- å¯ä»¥æé«˜ç¨‹åºå‘˜çš„æ€ç»´èƒ½åŠ›ã€ç¼–ç¨‹èƒ½åŠ›å’Œè®¾è®¡èƒ½åŠ›
- ä½¿ç¨‹åºè®¾è®¡æ›´åŠ æ ‡å‡†åŒ–ã€ä»£ç ç¼–åˆ¶æ›´åŠ å·¥ç¨‹åŒ–ï¼Œä½¿è½¯ä»¶å¼€å‘æ•ˆç‡å¤§å¤§æé«˜ï¼Œä»è€Œç¼©çŸ­è½¯ä»¶çš„å¼€å‘å‘¨æœŸ
- ä½¿è®¾è®¡çš„ä»£ç å¯é‡ç”¨æ€§é«˜ã€å¯è¯»æ€§å¼ºã€å¯é æ€§é«˜ã€çµæ´»æ€§å¥½ã€å¯ç»´æŠ¤æ€§å¼º

è®¾è®¡æ¨¡å¼åˆ†ç±»ï¼š

* **åˆ›å»ºå‹æ¨¡å¼**ï¼šç”¨äºæè¿°å¦‚ä½•åˆ›å»ºå¯¹è±¡ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯å°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨åˆ†ç¦»ã€‚GoF ä¹¦ä¸­æä¾›äº†å•ä¾‹ã€åŸå‹ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€å»ºé€ è€…ç­‰ 5 ç§åˆ›å»ºå‹æ¨¡å¼
* **ç»“æ„å‹æ¨¡å¼**ï¼šç”¨äºæè¿°å¦‚ä½•å°†ç±»æˆ–å¯¹è±¡æŒ‰æŸç§å¸ƒå±€ç»„æˆæ›´å¤§çš„ç»“æ„ï¼ŒGoF ä¹¦ä¸­æä¾›äº†ä»£ç†ã€é€‚é…å™¨ã€æ¡¥æ¥ã€è£…é¥°ã€å¤–è§‚ã€äº«å…ƒã€ç»„åˆç­‰ 7 ç§ç»“æ„å‹æ¨¡å¼
* **è¡Œä¸ºå‹æ¨¡å¼**ï¼šç”¨äºæè¿°ç±»æˆ–å¯¹è±¡ä¹‹é—´æ€æ ·ç›¸äº’åä½œå…±åŒå®Œæˆå•ä¸ªå¯¹è±¡æ— æ³•å•ç‹¬å®Œæˆçš„ä»»åŠ¡ï¼Œä»¥åŠæ€æ ·åˆ†é…èŒè´£ã€‚GoF ä¹¦ä¸­æä¾›äº†æ¨¡æ¿æ–¹æ³•ã€ç­–ç•¥ã€å‘½ä»¤ã€èŒè´£é“¾ã€çŠ¶æ€ã€è§‚å¯Ÿè€…ã€ä¸­ä»‹è€…ã€è¿­ä»£å™¨ã€è®¿é—®è€…ã€å¤‡å¿˜å½•ã€è§£é‡Šå™¨ç­‰ 11 ç§è¡Œä¸ºå‹æ¨¡å¼



å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1Np4y1z7BU



***



### UMLå›¾

#### åŸºæœ¬ä»‹ç»

ç»Ÿä¸€å»ºæ¨¡è¯­è¨€ï¼ˆUnified Modeling Languageï¼ŒUMLï¼‰æ˜¯ç”¨æ¥è®¾è®¡è½¯ä»¶çš„å¯è§†åŒ–å»ºæ¨¡è¯­è¨€ï¼Œç‰¹ç‚¹æ˜¯ç®€å•ã€ç»Ÿä¸€ã€å›¾å½¢åŒ–ã€èƒ½è¡¨è¾¾è½¯ä»¶è®¾è®¡ä¸­çš„åŠ¨æ€ä¸é™æ€ä¿¡æ¯

UML ä»ç›®æ ‡ç³»ç»Ÿçš„ä¸åŒè§’åº¦å‡ºå‘ï¼Œå®šä¹‰äº†ç”¨ä¾‹å›¾ã€ç±»å›¾ã€å¯¹è±¡å›¾ã€çŠ¶æ€å›¾ã€æ´»åŠ¨å›¾ã€æ—¶åºå›¾ã€åä½œå›¾ã€æ„ä»¶å›¾ã€éƒ¨ç½²å›¾ç­‰ 9 ç§å›¾

ç±»å›¾ï¼ˆClass diagramï¼‰æ˜¯æ˜¾ç¤ºäº†æ¨¡å‹çš„é™æ€ç»“æ„ï¼Œç‰¹åˆ«æ˜¯æ¨¡å‹ä¸­å­˜åœ¨çš„ç±»ã€ç±»çš„å†…éƒ¨ç»“æ„ä»¥åŠå®ƒä»¬ä¸å…¶ä»–ç±»çš„å…³ç³»ç­‰ï¼Œç±»å›¾ä¸æ˜¾ç¤ºæš‚æ—¶æ€§çš„ä¿¡æ¯ï¼Œç±»å›¾æ˜¯é¢å‘å¯¹è±¡å»ºæ¨¡çš„ä¸»è¦ç»„æˆéƒ¨åˆ†

ç±»å›¾çš„ä½œç”¨ï¼š

* åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œç±»å›¾æ˜¯ä¸€ç§é™æ€çš„ç»“æ„å›¾ï¼Œæè¿°äº†ç³»ç»Ÿçš„ç±»çš„é›†åˆï¼Œç±»çš„å±æ€§å’Œç±»ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥ç®€åŒ–äººä»¬å¯¹ç³»ç»Ÿçš„ç†è§£
* ç±»å›¾æ˜¯ç³»ç»Ÿåˆ†æå’Œè®¾è®¡é˜¶æ®µçš„é‡è¦äº§ç‰©ï¼Œæ˜¯ç³»ç»Ÿç¼–ç å’Œæµ‹è¯•çš„é‡è¦æ¨¡å‹



****



#### è¡¨ç¤ºæ–¹æ³•

åœ¨UMLç±»å›¾ä¸­ï¼Œç±»ä½¿ç”¨åŒ…å«ç±»åã€å±æ€§(field) å’Œæ–¹æ³•(method) ä¸”å¸¦æœ‰åˆ†å‰²çº¿çš„çŸ© å½¢æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ä¸‹å›¾è¡¨ç¤ºä¸€ä¸ªEmployee ç±»ï¼ŒåŒ…å« nameã€age å’Œ addressè¿™3ä¸ªå±æ€§ï¼Œä»¥åŠ work() æ–¹æ³•

![](https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å›¾çš„è¡¨ç¤ºæ–¹æ³•.jpg)

å±æ€§/æ–¹æ³•åç§°å‰åŠ çš„+å’Œ-è¡¨ç¤ºäº†è¿™ä¸ªå±æ€§/æ–¹æ³•çš„å¯è§æ€§ï¼ŒUMLç±»å›¾ä¸­è¡¨ç¤ºå¯è§æ€§çš„ç¬¦å·æœ‰ä¸‰ç§ï¼š

* +ï¼šè¡¨ç¤ºpublic

* -ï¼šè¡¨ç¤ºprivate

* #ï¼šè¡¨ç¤ºprotected

å±æ€§çš„å®Œæ•´è¡¨ç¤ºæ–¹å¼æ˜¯ï¼š **å¯è§æ€§  åç§° ï¼šç±»å‹ [ = ç¼ºçœå€¼]**  

æ–¹æ³•çš„å®Œæ•´è¡¨ç¤ºæ–¹å¼æ˜¯ï¼š **å¯è§æ€§  åç§°(å‚æ•°åˆ—è¡¨) [ : è¿”å›ç±»å‹]**

* ä¸­æ‹¬å·ä¸­çš„å†…å®¹è¡¨ç¤ºæ˜¯å¯é€‰çš„
* ä¹Ÿæœ‰å°†ç±»å‹æ”¾åœ¨å˜é‡åå‰é¢ï¼Œè¿”å›å€¼ç±»å‹æ”¾åœ¨æ–¹æ³•åå‰é¢



****



#### å…³è”å…³ç³»

å…³è”å…³ç³»æ˜¯å¯¹è±¡ä¹‹é—´çš„ä¸€ç§å¼•ç”¨å…³ç³»ï¼Œç”¨äºè¡¨ç¤ºä¸€ç±»å¯¹è±¡ä¸å¦ä¸€ç±»å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼Œå¦‚è€å¸ˆå’Œå­¦ç”Ÿã€‚å…³è”å…³ç³»æ˜¯ç±»ä¸ç±»ä¹‹é—´æœ€å¸¸ç”¨çš„ä¸€ç§å…³ç³»ï¼Œåˆ†ä¸ºä¸€èˆ¬å…³è”å…³ç³»ã€èšåˆå…³ç³»å’Œç»„åˆå…³ç³»

ä¸€èˆ¬å…³è”åˆå¯ä»¥åˆ†ä¸ºå•å‘å…³è”ï¼ŒåŒå‘å…³è”ï¼Œè‡ªå…³è”

* å•å‘å…³è”ï¼šåœ¨UMLç±»å›¾ä¸­å•å‘å…³è”ç”¨ä¸€ä¸ªå¸¦ç®­å¤´çš„å®çº¿è¡¨ç¤ºï¼Œä¸‹å›¾è¡¨ç¤ºæ¯ä¸ªé¡¾å®¢éƒ½æœ‰ä¸€ä¸ªåœ°å€ï¼Œé€šè¿‡è®© Customer ç±»æŒæœ‰ä¸€ä¸ªç±»å‹ä¸º Address çš„æˆå‘˜å˜é‡ç±»å®ç°

  <img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»å•å‘å…³è”.jpg" style="zoom: 80%;" />

* åŒå‘å…³è”ï¼šåŒæ–¹å„è‡ªæŒæœ‰å¯¹æ–¹ç±»å‹çš„æˆå‘˜å˜é‡

  <img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»åŒå‘å…³è”.jpg" style="zoom:80%;" />

* è‡ªå…³è”ï¼šåœ¨UMLç±»å›¾ä¸­ç”¨ä¸€ä¸ªå¸¦æœ‰ç®­å¤´ä¸”æŒ‡å‘è‡ªèº«çš„çº¿è¡¨ç¤ºï¼Œä¸‹å›¾çš„æ„æ€å°±æ˜¯Nodeç±»åŒ…å«ç±»å‹ä¸ºNodeçš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±åŒ…å«è‡ªå·±

  <img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»è‡ªå…³è”.jpg" style="zoom:80%;" />



****



#### èšåˆå…³ç³»

èšåˆå…³ç³»æ˜¯å…³è”å…³ç³»çš„ä¸€ç§ï¼Œæ˜¯å¼ºå…³è”å…³ç³»ï¼Œæ˜¯æ•´ä½“å’Œéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚èšåˆå…³ç³»é€šè¿‡æˆå‘˜å¯¹è±¡æ¥å®ç°ï¼Œå…¶ä¸­æˆå‘˜å¯¹è±¡æ˜¯æ•´ä½“å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯æˆå‘˜å¯¹è±¡å¯ä»¥è„±ç¦»æ•´ä½“å¯¹è±¡è€Œç‹¬ç«‹ å­˜åœ¨

åœ¨ UML ç±»å›¾ä¸­ï¼Œèšåˆå…³ç³»å¯ä»¥ç”¨å¸¦ç©ºå¿ƒè±å½¢çš„å®çº¿æ¥è¡¨ç¤ºï¼Œè±å½¢æŒ‡å‘æ•´ä½“ï¼Œä¸‹å›¾è¡¨ç¤ºå­¦æ ¡ä¸è€å¸ˆçš„å…³ç³»ï¼Œå­¦æ ¡åŒ…å«è€å¸ˆï¼Œä½†å¦‚æœå­¦æ ¡å€’é—­äº†ï¼Œè€å¸ˆä¾ç„¶å­˜åœ¨

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»èšåˆå…³ç³».jpg" style="zoom: 80%;" />



***



#### ç»„åˆå…³ç³»

ç»„åˆå…³ç³»è¡¨ç¤ºç±»ä¹‹é—´çš„æ•´ä½“ä¸éƒ¨åˆ†çš„å…³ç³»ï¼Œæ˜¯ä¸€ç§æ›´å¼ºçƒˆçš„èšåˆå…³ç³»ã€‚æ•´ä½“å¯¹è±¡å¯ä»¥æ§åˆ¶éƒ¨åˆ†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸€æ—¦æ•´ä½“å¯¹è±¡ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†å¯¹è±¡ä¹Ÿå°†ä¸å­˜åœ¨ï¼Œéƒ¨åˆ†å¯¹è±¡ä¸èƒ½è„±ç¦»æ•´ä½“å¯¹è±¡è€Œå­˜åœ¨

åœ¨ UML ç±»å›¾ä¸­ï¼Œç»„åˆå…³ç³»ç”¨å¸¦å®å¿ƒè±å½¢çš„å®çº¿æ¥è¡¨ç¤ºï¼Œè±å½¢æŒ‡å‘æ•´ä½“ï¼Œä¸‹å›¾æ‰€ç¤ºæ˜¯å¤´å’Œå˜´çš„å…³ç³»å›¾ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»ç»„åˆå…³ç³».png" style="zoom:80%;" />



***



#### ä¾èµ–å…³ç³»

ä¾èµ–å…³ç³»æ˜¯ä¸€ç§ä½¿ç”¨å…³ç³»ï¼Œå¯¹è±¡ä¹‹é—´è€¦åˆåº¦æœ€å¼±çš„ä¸€ç§å…³è”æ–¹å¼ï¼Œæ˜¯ä¸´æ—¶æ€§çš„å…³è”ã€‚åœ¨ä»£ç ä¸­ï¼ŒæŸä¸ªç±»çš„æ–¹æ³•é€šè¿‡å±€éƒ¨å˜é‡ã€æ–¹æ³•çš„å‚æ•°æˆ–è€…å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨æ¥è®¿é—®å¦ä¸€ä¸ªç±»ï¼ˆè¢«ä¾èµ–ç±»ï¼‰ä¸­çš„æŸäº›æ–¹æ³•æ¥å®Œæˆä¸€äº›èŒè´£

åœ¨ UML ç±»å›¾ä¸­ï¼Œä¾èµ–å…³ç³»ä½¿ç”¨å¸¦ç®­å¤´çš„è™šçº¿æ¥è¡¨ç¤ºï¼Œç®­å¤´ä»ä½¿ç”¨ç±»æŒ‡å‘è¢«ä¾èµ–çš„ç±»

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»ä¾èµ–å…³ç³».jpg" style="zoom:80%;" />



***



#### ç»§æ‰¿å…³ç³»

ç»§æ‰¿å…³ç³»æ˜¯å¯¹è±¡ä¹‹é—´è€¦åˆåº¦æœ€å¤§çš„ä¸€ç§å…³ç³»ï¼Œè¡¨ç¤ºä¸€èˆ¬ä¸ç‰¹æ®Šçš„å…³ç³»ï¼Œæ˜¯çˆ¶ç±»ä¸å­ç±»ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯ä¸€ç§ç»§æ‰¿å…³ç³»

åœ¨ UML ç±»å›¾ä¸­ï¼Œæ³›åŒ–å…³ç³»ç”¨å¸¦ç©ºå¿ƒä¸‰è§’ç®­å¤´çš„å®çº¿æ¥è¡¨ç¤ºï¼Œç®­å¤´ä»å­ç±»æŒ‡å‘çˆ¶ç±»ã€‚åœ¨ä»£ç å®ç°æ—¶ï¼Œä½¿ç”¨é¢å‘å¯¹è±¡çš„ç»§æ‰¿æœºåˆ¶æ¥å®ç°æ³›åŒ–å…³ç³»ã€‚ä¾‹å¦‚  Student ç±»å’Œ Teacher ç±»éƒ½æ˜¯ Person ç±»çš„å­ç±»ï¼Œå…¶ç±»å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»ç»§æ‰¿å…³ç³».jpg" style="zoom:80%;" />



****



#### å®ç°å…³ç³»

å®ç°å…³ç³»æ˜¯æ¥å£ä¸å®ç°ç±»ä¹‹é—´çš„å…³ç³»ï¼Œç±»å®ç°äº†æ¥å£ï¼Œç±»ä¸­çš„æ“ä½œå®ç°äº†æ¥å£ä¸­æ‰€å£°æ˜çš„æ‰€æœ‰çš„æŠ½è±¡æ“ä½œ

åœ¨ UML ç±»å›¾ä¸­ï¼Œå®ç°å…³ç³»ä½¿ç”¨å¸¦ç©ºå¿ƒä¸‰è§’ç®­å¤´çš„è™šçº¿æ¥è¡¨ç¤ºï¼Œç®­å¤´ä»å®ç°ç±»æŒ‡å‘æ¥å£ï¼Œæ¯”å¦‚æ±½è½¦å’Œèˆ¹å®ç°äº†äº¤é€šå·¥å…·ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç±»å…³ç³»å®ç°å…³ç³».jpg" style="zoom:80%;" />



***



### è®¾è®¡åŸåˆ™

#### å¼€é—­åŸåˆ™

**å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­**ï¼Œåœ¨ç¨‹åºéœ€è¦è¿›è¡Œæ‹“å±•çš„æ—¶å€™ï¼Œä¸èƒ½å»ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œå®ç°ä¸€ä¸ªçƒ­æ’æ‹”çš„æ•ˆæœï¼Œç®€è¨€ä¹‹ï¼Œæ˜¯ä¸ºäº†ä½¿ç¨‹åºçš„æ‰©å±•æ€§å¥½ï¼Œæ˜“äºç»´æŠ¤å’Œå‡çº§ï¼Œä½¿ç”¨æ¥å£å’ŒæŠ½è±¡ç±»

æŠ½è±¡çµæ´»æ€§å¥½ï¼Œé€‚åº”æ€§å¹¿ï¼Œåªè¦æŠ½è±¡çš„åˆç†ï¼Œå¯ä»¥åŸºæœ¬ä¿æŒè½¯ä»¶æ¶æ„çš„ç¨³å®šï¼Œè½¯ä»¶ä¸­æ˜“å˜çš„ç»†èŠ‚å¯ä»¥ä»æŠ½è±¡æ´¾ç”Ÿæ¥çš„å®ç°ç±»æ¥è¿›è¡Œæ‰©å±•ï¼Œå½“è½¯ä»¶éœ€è¦å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦æ ¹æ®éœ€æ±‚é‡æ–°æ´¾ç”Ÿä¸€ä¸ªå®ç°ç±»æ¥æ‰©å±•å°±å¯ä»¥ã€‚



***



#### é‡Œæ°ä»£æ¢

é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„åŸºæœ¬åŸåˆ™ä¹‹ä¸€

é‡Œæ°ä»£æ¢åŸåˆ™ï¼šä»»ä½•åŸºç±»å¯ä»¥å‡ºç°çš„åœ°æ–¹ï¼Œå­ç±»ä¸€å®šå¯ä»¥å‡ºç°ï¼Œå°±æ˜¯å­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œé™¤æ·»åŠ æ–°çš„æ–¹æ³•å®Œæˆæ–°å¢åŠŸèƒ½å¤–ï¼Œå°½é‡ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•

å¦‚æœé€šè¿‡é‡å†™çˆ¶ç±»çš„æ–¹æ³•æ¥å®Œæˆæ–°çš„åŠŸèƒ½ï¼Œè¿™æ ·å†™èµ·æ¥è™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ•´ä¸ªç»§æ‰¿ä½“ç³»çš„å¯å¤ç”¨æ€§ä¼šæ¯”è¾ƒå·®ï¼Œç‰¹åˆ«æ˜¯è¿ç”¨å¤šæ€æ¯”è¾ƒé¢‘ç¹æ—¶ï¼Œç¨‹åºè¿è¡Œå‡ºé”™çš„æ¦‚ç‡ä¼šéå¸¸å¤§



***



#### ä¾èµ–å€’è½¬

é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–å®ç°æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ï¼›æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚ç®€å•çš„è¯´å°±æ˜¯è¦æ±‚å¯¹æŠ½è±¡è¿›è¡Œç¼–ç¨‹ï¼Œä¸è¦å¯¹å®ç°è¿›è¡Œç¼–ç¨‹ï¼Œè¿™æ ·å°±é™ä½äº†å®¢æˆ·ä¸å®ç°æ¨¡å—é—´çš„è€¦åˆ

æ¯”å¦‚è¯´ç»„è£…ä¸€å°ç”µè„‘ï¼Œå¦‚æœç»„è£…çš„ç”µè„‘çš„cpuåªèƒ½æ˜¯Intelçš„ï¼Œå†…å­˜æ¡åªèƒ½æ˜¯é‡‘å£«é¡¿çš„ï¼Œç¡¬ç›˜åªèƒ½æ˜¯å¸Œæ·çš„ï¼Œè¿™å¯¹ç”¨æˆ·è‚¯å®šæ˜¯ä¸å‹å¥½çš„ï¼Œæ‰€ä»¥éœ€è¦æŠŠ CPUã€å†…å­˜ã€ç¡¬ç›˜æå–æˆæ¥å£ç±»



***



#### æ¥å£éš”ç¦»

å®¢æˆ·ç«¯ä¸åº”è¯¥è¢«è¿«ä¾èµ–äºä¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š

æ¯”å¦‚è¯´ Person ç±»æœ‰å§“åã€å¹´é¾„ã€æ”¶å…¥ï¼Œä½†æ˜¯å­ç±» Teacher ç±»æœ‰æ”¶å…¥ï¼ŒStudent æ²¡æœ‰ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®ä¸‰ä¸ªæ¥å£ã€‚



***



#### è¿ªç±³ç‰¹

è¿ªç±³ç‰¹æ³•åˆ™åˆå«æœ€å°‘çŸ¥è¯†åŸåˆ™ï¼Œå¦‚æœä¸¤ä¸ªè½¯ä»¶å®ä½“æ— é¡»ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆå°±ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹è½¬å‘è¯¥è°ƒç”¨ï¼Œå…¶ç›®çš„æ˜¯é™ä½ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæé«˜æ¨¡å—çš„ç›¸å¯¹ç‹¬ç«‹

æ¯”å¦‚æ˜æ˜Ÿä¸ç»çºªäººçš„å…³ç³»ï¼š

![](https://gitee.com/seazean/images/raw/master/Java/Design-è¿ªç±³ç‰¹æ³•åˆ™.png)



***



#### åˆæˆå¤ç”¨

åˆæˆå¤ç”¨åŸåˆ™ï¼šå°½é‡å…ˆä½¿ç”¨ç»„åˆæˆ–è€…èšåˆç­‰å…³è”å…³ç³»æ¥å®ç°ï¼Œå…¶æ¬¡æ‰è€ƒè™‘ä½¿ç”¨ç»§æ‰¿å…³ç³»æ¥å®ç°

ç±»çš„å¤ç”¨åˆ†ä¸ºç»§æ‰¿å¤ç”¨å’Œåˆæˆå¤ç”¨ä¸¤ç§

* ç»§æ‰¿å¤ç”¨çš„ç¼ºç‚¹ï¼š
  1. ç»§æ‰¿å¤ç”¨ç ´åäº†ç±»çš„å°è£…æ€§ï¼Œç»§æ‰¿ä¼šå°†çˆ¶ç±»çš„å®ç°ç»†èŠ‚æš´éœ²ç»™å­ç±»ï¼Œçˆ¶ç±»å¯¹å­ç±»æ˜¯é€æ˜çš„ï¼Œæ‰€ä»¥è¿™ç§å¤ç”¨åˆç§°ä¸ºâ€œç™½ç®±å¤ç”¨â€
  2. å­ç±»ä¸çˆ¶ç±»çš„è€¦åˆåº¦é«˜ï¼Œçˆ¶ç±»çš„å®ç°çš„ä»»ä½•æ”¹å˜éƒ½ä¼šå¯¼è‡´å­ç±»çš„å®ç°å‘ç”Ÿå˜åŒ–ï¼Œä¸åˆ©äºç±»çš„æ‰©å±•ä¸ç»´æŠ¤
  3. é™åˆ¶äº†å¤ç”¨çš„çµæ´»æ€§ï¼Œä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥çš„å®ç°æ˜¯éè™šæ–¹æ³•ï¼Œåœ¨ç¼–è¯‘æ—¶å·²ç»ç»‘å®šï¼Œåœ¨è¿è¡Œæ—¶ä¸èƒ½å‘ç”Ÿå˜åŒ–

* é‡‡ç”¨ç»„åˆæˆ–èšåˆå¤ç”¨ï¼Œå°†å·²æœ‰å¯¹è±¡çº³å…¥æ–°å¯¹è±¡ä¸­ï¼Œä½¿ä¹‹æˆä¸ºæ–°å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œæ–°å¯¹è±¡å¯ä»¥è°ƒç”¨å·²æœ‰å¯¹è±¡çš„åŠŸèƒ½
  1. ç»´æŒäº†ç±»çš„å°è£…æ€§ï¼Œå› ä¸ºæˆåˆ†å¯¹è±¡çš„å†…éƒ¨ç»†èŠ‚æ˜¯æ–°å¯¹è±¡çœ‹ä¸è§çš„ï¼Œæ‰€ä»¥è¿™ç§å¤ç”¨åˆç§°ä¸ºâ€œé»‘ç®±â€å¤ç”¨
  2. å¯¹è±¡é—´çš„è€¦åˆåº¦ä½ï¼Œå¯ä»¥åœ¨ç±»çš„æˆå‘˜ä½ç½®å£°æ˜æŠ½è±¡
  3. å¤ç”¨çš„çµæ´»æ€§é«˜ï¼Œè¿™ç§å¤ç”¨å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è¿›è¡Œï¼Œæ–°å¯¹è±¡å¯ä»¥åŠ¨æ€åœ°å¼•ç”¨ä¸æˆåˆ†å¯¹è±¡ç±»å‹ç›¸åŒçš„å¯¹è±¡

æ¯”å¦‚ï¼šæ±½è½¦æŒ‰åŠ¨åŠ›æºåˆ†ä¸ºæ±½æ²¹æ±½è½¦ã€ç”µåŠ¨æ±½è½¦ç­‰ï¼›æŒ‰é¢œè‰²åˆ’åˆ†å¯åˆ†ä¸ºç™½è‰²æ±½è½¦ã€é»‘è‰²æ±½è½¦å’Œçº¢è‰²æ±½è½¦ç­‰

* ç±»å›¾ï¼š

  <img src="https://gitee.com/seazean/images/raw/master/Java/Design-åˆæˆå¤ç”¨åŸåˆ™1.png" style="zoom: 67%;" />

* å°†ç»§æ‰¿å¤ç”¨æ”¹ä¸ºèšåˆå¤ç”¨ï¼ŒæŠŠé¢œè‰²å½“ä½œå±æ€§ï¼š

  <img src="https://gitee.com/seazean/images/raw/master/Java/Design-åˆæˆå¤ç”¨åŸåˆ™2.png" style="zoom: 80%;" />





****





## åˆ›å»ºå‹

### å•ä¾‹æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

åˆ›å»ºå‹æ¨¡å¼çš„ä¸»è¦å…³æ³¨ç‚¹æ˜¯æ€æ ·åˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨åˆ†ç¦»ï¼Œé™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³æ³¨å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚

åˆ›å»ºå‹æ¨¡å¼åˆ†ä¸ºï¼šå•ä¾‹æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥ç¨‹æ¨¡å¼ã€åŸå‹æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼

å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯ Java ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼

å•ä¾‹è®¾è®¡æ¨¡å¼åˆ†ç±»ä¸¤ç§ï¼š

* é¥¿æ±‰å¼ï¼šç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»º	

* æ‡’æ±‰å¼ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šåˆ›å»º



***



#### é¥¿æ±‰å¼

é¥¿æ±‰å¼åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹å¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè™šæ‹Ÿæœºä¼šä¿è¯ç±»åŠ è½½çš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯å¦‚æœåªæ˜¯ä¸ºäº†åŠ è½½è¯¥ç±»ä¸éœ€è¦å®ä¾‹ï¼Œåˆ™ä¼šé€ æˆå†…å­˜çš„æµªè´¹

* é™æ€å˜é‡çš„æ–¹å¼ï¼š

  ```java
  public class Singleton {
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
      //åœ¨æˆå‘˜ä½ç½®åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡
      private static final Singleton instance = new Singleton();
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          return instance;
      }
      
      //è§£å†³åºåˆ—åŒ–é—®é¢˜
      protected Object readResolve() {
      	return INSTANCE;
      }
  }
  ```

  * é—®é¢˜1ï¼šä¸ºä»€ä¹ˆç±»åŠ  final ä¿®é¥°ï¼Ÿ
    ä¸è¢«å­ç±»ç»§æ‰¿ï¼Œé˜²æ­¢å­ç±»ä¸­ä¸é€‚å½“çš„è¡Œä¸ºè¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ï¼Œç ´åäº†å•ä¾‹

  * é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£ï¼Œæ€ä¹ˆé˜²æ­¢é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹ï¼Ÿ

    * å¯¹å•ä¾‹å£°æ˜ transientï¼Œç„¶åå®ç° readObject(ObjectInputStream in) æ–¹æ³•ï¼Œå¤ç”¨åŸæ¥çš„å•ä¾‹

      æ¡ä»¶ï¼šè®¿é—®æƒé™ä¸ºprivate/protectedã€è¿”å›å€¼å¿…é¡»æ˜¯Objectã€å¼‚å¸¸å¯ä»¥ä¸æŠ›

    * å®ç°readResolve()æ–¹æ³•ï¼Œå½“ JVM ä»å†…å­˜ä¸­ååºåˆ—åŒ–åœ°"ç»„è£…"ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨readResolveæ–¹æ³•è¿”å›åŸæ¥å•ä¾‹

  * é—®é¢˜3ï¼šä¸ºä»€ä¹ˆæ„é€ æ–¹æ³•è®¾ç½®ä¸ºç§æœ‰? æ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹?
    é˜²æ­¢å…¶ä»–ç±»æ— é™åˆ›å»ºå¯¹è±¡ï¼›ä¸èƒ½é˜²æ­¢åå°„ç ´å

  * é—®é¢˜4ï¼šè¿™ç§æ–¹å¼æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨?
    èƒ½ï¼Œé™æ€å˜é‡åˆå§‹åŒ–åœ¨ç±»åŠ è½½æ—¶å®Œæˆï¼Œç”±JVMä¿è¯çº¿ç¨‹å®‰å…¨

  * é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º publicï¼Ÿ
    æ›´å¥½çš„å°è£…æ€§ã€æä¾›æ³›å‹æ”¯æŒã€å¯ä»¥æ”¹è¿›æˆæ‡’æ±‰å•ä¾‹è®¾è®¡

* é™æ€ä»£ç å—çš„æ–¹å¼ï¼š

  ```java
  public class Singleton {
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
      
      //åœ¨æˆå‘˜ä½ç½®åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡
      private static Singleton instance;
      static {
          instance = new Singleton();
      }
      
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          return instance;
      }
  }
  ```

* æšä¸¾æ–¹å¼ï¼šæšä¸¾ç±»å‹æ˜¯æ‰€ç”¨å•ä¾‹å®ç°ä¸­**å”¯ä¸€ä¸€ç§**ä¸ä¼šè¢«ç ´åçš„å•ä¾‹å®ç°æ¨¡å¼

  ```java
  public enum Singleton {
      INSTANCE;
      public void doSomething() {
          System.out.println("doSomething");
      }
  }
  public static void main(String[] args) {
      Singleton.INSTANCE.doSomething();
  }
  ```

  * é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ï¼Ÿæ¯ä¸ªæšä¸¾é¡¹éƒ½æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡
  * é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜ï¼Ÿå¦
  * é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹ï¼Ÿå¦ï¼Œåå°„åˆ›å»ºå¯¹è±¡æ—¶åˆ¤æ–­æ˜¯æšä¸¾ç±»å‹å°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸
  * é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹ï¼Ÿå¦
  * é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼ï¼Ÿ**é¥¿æ±‰å¼**
  * é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åšï¼Ÿæ·»åŠ æ„é€ æ–¹æ³•

  åç¼–è¯‘ç»“æœï¼š

  ```java
  public final class Singleton extends java.lang.Enum<Singleton> {//Enumå®ç°åºåˆ—åŒ–æ¥å£
  	public static final Singleton INSTANCE = new Singleton();
  }
  ```

  



***



#### æ‡’æ±‰å¼

* çº¿ç¨‹ä¸å®‰å…¨

  ```java
  public class Singleton {
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
  
      //åœ¨æˆå‘˜ä½ç½®åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡
      private static Singleton instance;
  
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          if(instance == null) {
              //å¤šçº¿ç¨‹ç¯å¢ƒï¼Œä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥è¿™é‡Œ
              instance = new Singleton();
          }
          return instance;
      }
  }
  ```

* åŒç«¯æ£€é”æœºåˆ¶

  åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°ç©ºæŒ‡é’ˆé—®é¢˜ï¼Œå‡ºç°é—®é¢˜çš„åŸå› æ˜¯JVMåœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ä¼šè¿›è¡Œä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’åºæ“ä½œï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ `volatile` å…³é”®å­—

  ```java
  public class Singleton { 
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
      private static volatile Singleton instance;
  
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          //ç¬¬ä¸€æ¬¡åˆ¤æ–­ï¼Œå¦‚æœinstanceä¸ä¸ºnullï¼Œä¸è¿›å…¥æŠ¢é”é˜¶æ®µï¼Œç›´æ¥è¿”å›å®ä¾‹
          if(instance == null) {
              synchronized (Singleton.class) {
                  //æŠ¢åˆ°é”ä¹‹åå†æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºnull
                  if(instance == null) {
                      instance = new Singleton();
                  }
              }
          }
          return instance;
      }
  }
  ```

* é™æ€å†…éƒ¨ç±»æ–¹å¼

  ```java
  public class Singleton {
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
  
      private static class SingletonHolder {
          private static final Singleton INSTANCE = new Singleton();
      }
  
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          return SingletonHolder.INSTANCE;
      }
  }
  ```

  * å†…éƒ¨ç±»å±äºæ‡’æ±‰å¼ï¼Œç±»åŠ è½½æœ¬èº«å°±æ˜¯æ‡’æƒ°çš„ï¼Œé¦–æ¬¡è°ƒç”¨æ—¶åŠ è½½ï¼Œç„¶åå¯¹å•ä¾‹è¿›è¡Œåˆå§‹åŒ–
  
    ç±»åŠ è½½çš„æ—¶å€™æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ getInstance æ–¹æ³•è°ƒç”¨ invokestatic æŒ‡ä»¤å¯¹å†…éƒ¨ç±»è¿›è¡ŒåŠ è½½ï¼›åŠ è½½çš„æ—¶å€™å­—èŠ‚ç å¸¸é‡æ± ä¼šè¢«åŠ å…¥ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œè§£æå·¥ä½œæ˜¯å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è§£ææˆç›´æ¥å¼•ç”¨ï¼Œä½†æ˜¯è§£æè¿‡ç¨‹ä¸ä¸€å®šéå¾—åœ¨ç±»åŠ è½½æ—¶å®Œæˆï¼Œå¯ä»¥å»¶è¿Ÿåˆ°è¿è¡Œæ—¶è¿›è¡Œï¼Œæ‰€ä»¥é™æ€å†…éƒ¨ç±»å®ç°å•ä¾‹ä¼š**å»¶è¿ŸåŠ è½½**
  
  * æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé™æ€å˜é‡åˆå§‹åŒ–åœ¨ç±»åŠ è½½æ—¶å®Œæˆï¼Œç”± JVM ä¿è¯çº¿ç¨‹å®‰å…¨



***



#### ç ´åå•ä¾‹

##### åºåˆ—åŒ–

å°†å•ä¾‹å¯¹è±¡åºåˆ—åŒ–å†ååºåˆ—åŒ–ï¼Œå¯¹è±¡ä»å†…å­˜ååºåˆ—åŒ–åˆ°ç¨‹åºä¸­ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œè€Œä¸”å¾—åˆ°çš„å¯¹è±¡ä¸æ˜¯é€šè¿‡æ„é€ å™¨å¾—åˆ°çš„ï¼Œååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ä¸æ‰§è¡Œæ„é€ å™¨

* Singleton

  ```java
  public class Singleton implements Serializable {	//å®ç°åºåˆ—åŒ–æ¥å£
      //ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {}
      private static class SingletonHolder {
          private static final Singleton INSTANCE = new Singleton();
      }
  
      //å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          return SingletonHolder.INSTANCE;
      }
  }
  ```

* åºåˆ—åŒ–

  ```java
  public class Test {
      public static void main(String[] args) throws Exception {
          //å¾€æ–‡ä»¶ä¸­å†™å¯¹è±¡
          //writeObject2File();
          //ä»æ–‡ä»¶ä¸­è¯»å–å¯¹è±¡
          Singleton s1 = readObjectFromFile();
          Singleton s2 = readObjectFromFile();
          //åˆ¤æ–­ä¸¤ä¸ªååºåˆ—åŒ–åçš„å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
          System.out.println(s1 == s2);
      }
  
      private static Singleton readObjectFromFile() throws Exception {
          //åˆ›å»ºå¯¹è±¡è¾“å…¥æµå¯¹è±¡
          ObjectInputStream ois = new ObjectInputStream(new FileInputStream("C:\a.txt"));
          //ç¬¬ä¸€ä¸ªè¯»å–Singletonå¯¹è±¡
          Singleton instance = (Singleton) ois.readObject();
          return instance;
      }
      
      public static void writeObject2File() throws Exception {
          //è·å–Singletonç±»çš„å¯¹è±¡
          Singleton instance = Singleton.getInstance();
          //åˆ›å»ºå¯¹è±¡è¾“å‡ºæµ
          ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("C:\a.txt"));
          //å°†instanceå¯¹è±¡å†™å‡ºåˆ°æ–‡ä»¶ä¸­
          oos.writeObject(instance);
      }
  }
  ```

* è§£å†³æ–¹æ³•ï¼š

  åœ¨ Singleton ç±»ä¸­æ·»åŠ `readResolve()`æ–¹æ³•ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è¢«åå°„è°ƒç”¨ï¼Œå¦‚æœå®šä¹‰äº†è¿™ä¸ªæ–¹æ³•ï¼Œå°±è¿”å›è¿™ä¸ªæ–¹æ³•çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œåˆ™è¿”å›æ–°åˆ›å»ºçš„å¯¹è±¡

  ```java
  private Object readResolve() {
      return SingletonHolder.INSTANCE;
  }
  ```

  ObjectInputStreamç±»æºç åˆ†æï¼š

  ```java
  public final Object readObject() throws IOException, ClassNotFoundException{
      //...
        Object obj = readObject0(false);//é‡ç‚¹æŸ¥çœ‹readObject0æ–¹æ³•
  }
  
  private Object readObject0(boolean unshared) throws IOException {
      try {
  		switch (tc) {
  			case TC_OBJECT:
  				return checkResolve(readOrdinaryObject(unshared));
                  //é‡ç‚¹æŸ¥çœ‹readOrdinaryObjectæ–¹æ³•
          }
      } 
  }
  private Object readOrdinaryObject(boolean unshared) throws IOException {
  	//isInstantiable è¿”å›trueï¼Œæ‰§è¡Œ desc.newInstance()ï¼Œé€šè¿‡åå°„åˆ›å»ºæ–°çš„å•ä¾‹ç±»
      obj = desc.isInstantiable() ? desc.newInstance() : null; 
      //æ·»åŠ  readResolve æ–¹æ³•å desc.hasReadResolveMethod() æ–¹æ³•æ‰§è¡Œç»“æœä¸ºtrue
      if (obj != null && handles.lookupException(passHandle) == null && desc.hasReadResolveMethod()) {
      	// é€šè¿‡åå°„è°ƒç”¨ Singleton ç±»ä¸­çš„ readResolve æ–¹æ³•ï¼Œå°†è¿”å›å€¼èµ‹å€¼ç»™repå˜é‡
      	// å¤šæ¬¡è°ƒç”¨ObjectInputStreamç±»ä¸­çš„readObjectæ–¹æ³•ï¼Œæœ¬è´¨è°ƒç”¨å®šä¹‰çš„readResolveæ–¹æ³•ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚
      	Object rep = desc.invokeReadResolve(obj);
      }
      return obj;
  }
  ```



***



##### åå°„

* åå°„

  ```java
  public class Test {
      public static void main(String[] args) throws Exception {
          //è·å–Singletonç±»çš„å­—èŠ‚ç å¯¹è±¡
          Class clazz = Singleton.class;
          //è·å–Singletonç±»çš„ç§æœ‰æ— å‚æ„é€ æ–¹æ³•å¯¹è±¡
          Constructor constructor = clazz.getDeclaredConstructor();
          //å–æ¶ˆè®¿é—®æ£€æŸ¥
          constructor.setAccessible(true);
  
          //åˆ›å»ºSingletonç±»çš„å¯¹è±¡s1
          Singleton s1 = (Singleton) constructor.newInstance();
          //åˆ›å»ºSingletonç±»çš„å¯¹è±¡s2
          Singleton s2 = (Singleton) constructor.newInstance();
  
          //åˆ¤æ–­é€šè¿‡åå°„åˆ›å»ºçš„ä¸¤ä¸ªSingletonå¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
          System.out.println(s1 == s2);	//false
      }
  }
  ```

* åå°„æ–¹å¼ç ´è§£å•ä¾‹çš„è§£å†³æ–¹æ³•ï¼š

  ```java
  public class Singleton {
      private static volatile Singleton instance;
      
      // ç§æœ‰æ„é€ æ–¹æ³•
      private Singleton() {
          // åå°„ç ´è§£å•ä¾‹æ¨¡å¼éœ€è¦æ·»åŠ çš„ä»£ç 
          if(instance != null) {
              throw new RuntimeException();
          }
      }
      
      // å¯¹å¤–æä¾›é™æ€æ–¹æ³•è·å–è¯¥å¯¹è±¡
      public static Singleton getInstance() {
          if(instance != null) {
              return instance;
          }
          synchronized (Singleton.class) {
              if(instance != null) {
                  return instance;
              }
              instance = new Singleton();
              return instance;
          }
      }
  }
  ```





***



#### Runtime

Runtime ç±»å°±æ˜¯ä½¿ç”¨çš„å•ä¾‹è®¾è®¡æ¨¡å¼ä¸­çš„é¥¿æ±‰å¼

```java
public class Runtime {    
    private static Runtime currentRuntime = new Runtime();    
    public static Runtime getRuntime() {        
        return currentRuntime;    
    }   
    private Runtime() {}    
    ...
}
```

ä½¿ç”¨ Runtime

```java
public class RuntimeDemo {
    public static void main(String[] args) throws IOException {
        //è·å–Runtimeç±»å¯¹è±¡
        Runtime runtime = Runtime.getRuntime();

        //è¿”å› Java è™šæ‹Ÿæœºä¸­çš„å†…å­˜æ€»é‡ã€‚
        System.out.println(runtime.totalMemory());
        //è¿”å› Java è™šæ‹Ÿæœºè¯•å›¾ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ã€‚
        System.out.println(runtime.maxMemory());

        //åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ‰§è¡ŒæŒ‡å®šçš„å­—ç¬¦ä¸²å‘½ä»¤ï¼Œè¿”å›è¿›ç¨‹å¯¹è±¡
        Process process = runtime.exec("ipconfig");
        //è·å–å‘½ä»¤æ‰§è¡Œåçš„ç»“æœï¼Œé€šè¿‡è¾“å…¥æµè·å–
        InputStream inputStream = process.getInputStream();
        byte[] arr = new byte[1024 * 1024* 100];
        int b = inputStream.read(arr);
        System.out.println(new String(arr,0,b,"gbk"));
    }
}
```





****



### å·¥å‚æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

å·¥å‚æ¨¡å¼ï¼šä½¿ç”¨å·¥å‚æ¥ç”Ÿäº§å¯¹è±¡ï¼Œå½»åº•å’Œå¯¹è±¡è§£è€¦ï¼Œå¦‚æœè¦æ›´æ¢å¯¹è±¡ï¼Œç›´æ¥åœ¨å·¥å‚é‡Œæ›´æ¢è¯¥å¯¹è±¡å³å¯

ä¸‰ç§å·¥å‚ï¼š

* ç®€å•å·¥å‚æ¨¡å¼ï¼ˆä¸å±äº GOF çš„23ç§ç»å…¸è®¾è®¡æ¨¡å¼ï¼‰
* å·¥å‚æ–¹æ³•æ¨¡å¼
* æŠ½è±¡å·¥å‚æ¨¡å¼



***



#### ç®€å•å·¥å‚

ç®€å•å·¥å‚ï¼Œä¹Ÿç§°ä¸ºé™æ€å·¥å‚æ¨¡å¼ï¼ŒåŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡äº§å“ ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½
* å…·ä½“äº§å“ ï¼šå®ç°æˆ–è€…ç»§æ‰¿æŠ½è±¡äº§å“çš„å­ç±»
* å…·ä½“å·¥å‚ ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œè°ƒç”¨è€…é€šè¿‡è¯¥æ–¹æ³•æ¥è·å–äº§å“

å®ç°ä»£ç ï¼š

* æŠ½è±¡ç±»ï¼š

  ```java
  public abstract class Coffee {
      public abstract String getName();
  }
  ```

* å®ç°ç±»ï¼š

  ```java
  public class AmericanCoffee extends Coffee {
      public String getName() {
          return "ç¾å¼å’–å•¡";
      }
  }
  public class LatteCoffee extends Coffee {
      public String getName() {
          return "æ‹¿é“å’–å•¡";
      }
  }
  ```

* ç®€å•å·¥å‚ç±»ï¼Œåœ¨ createCoffee æ–¹æ³•åŠ  static

  ```java
  public class SimpleCoffeeFactory {
      public Coffee createCoffee(String type) {
          //å£°æ˜Coffeeç±»å‹çš„å˜é‡ï¼Œæ ¹æ®ä¸åŒç±»å‹åˆ›å»ºä¸åŒçš„coffeeå­ç±»å¯¹è±¡
          Coffee coffee = null;
          if("american".equals(type)) {
              coffee = new AmericanCoffee();
          } else if("latte".equals(type)) {
              coffee = new LatteCoffee();
          } else {
              throw new RuntimeException("å¯¹ä¸èµ·ï¼Œæ‚¨æ‰€ç‚¹çš„å’–å•¡æ²¡æœ‰");
          }
  
          return coffee;
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class Client {
      public static void main(String[] args) {
          SimpleCoffeeFactory factory = new SimpleCoffeeFactory();
          Coffee coffee = factory.createCoffee("latte");
  
          System.out.println(coffee.getName());
      }
  }
  ```

ä¼˜ç‚¹ï¼š

* å°è£…äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å‚æ•°ç›´æ¥è·å–å¯¹è±¡ã€‚
* æŠŠå¯¹è±¡çš„åˆ›å»ºå’Œä¸šåŠ¡é€»è¾‘å±‚åˆ†å¼€ï¼Œå¦‚æœè¦å®ç°æ–°äº§å“ç›´æ¥ä¿®æ”¹å·¥å‚ç±»ï¼Œè€Œä¸éœ€è¦åœ¨åŸä»£ç ä¸­ä¿®æ”¹ï¼Œæ‰©å±•æ€§é«˜

ç¼ºç‚¹ï¼šå®ç°æ–°äº§å“éœ€è¦ä¿®æ”¹ SimpleCoffeeFactory çš„ä»£ç ï¼Œè¿åäº†å¼€é—­åŸåˆ™



***



#### å·¥å‚æ–¹æ³•

å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸ªäº§å“ç±»å¯¹è±¡ï¼Œå·¥å‚æ–¹æ³•ä½¿ä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å·¥å‚çš„å­ç±»

å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡å·¥å‚ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œè°ƒç”¨è€…é€šè¿‡å®ƒè®¿é—®å…·ä½“å·¥å‚çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºäº§å“
* å…·ä½“å·¥å‚ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚
* æŠ½è±¡äº§å“ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚
* å…·ä½“äº§å“ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼ŒåŒå…·ä½“å·¥å‚ä¹‹é—´ä¸€ä¸€å¯¹åº”

ä»£ç å®ç°ï¼š

* æŠ½è±¡å·¥å‚ï¼š

  ```java
  public interface CoffeeFactory {    
      Coffee createCoffee();
  }
  ```

* å…·ä½“å·¥å‚ï¼š

  ```java
  public class LatteCoffeeFactory implements CoffeeFactory {
      public Coffee createCoffee() {
          return new LatteCoffee();
      }
  }
  
  public class AmericanCoffeeFactory implements CoffeeFactory {
      public Coffee createCoffee() {
          return new AmericanCoffee();
      }
  }
  ```

ä¼˜ç‚¹ï¼š

- ç”¨æˆ·åªéœ€è¦çŸ¥é“å…·ä½“å·¥å‚çš„åç§°å°±å¯å¾—åˆ°æ‰€è¦çš„äº§å“ï¼Œæ— é¡»çŸ¥é“äº§å“çš„å…·ä½“åˆ›å»ºè¿‡ç¨‹
- å¢åŠ æ–°çš„äº§å“åªéœ€è¦æ·»åŠ å…·ä½“äº§å“ç±»å’Œå¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œæ— é¡»å¯¹åŸå·¥å‚è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™

ç¼ºç‚¹ï¼š

* æ¯å¢åŠ ä¸€ä¸ªäº§å“å°±è¦å¢åŠ ä¸€ä¸ªå…·ä½“äº§å“ç±»å’Œä¸€ä¸ªå¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦



***



#### æŠ½è±¡å·¥å‚

æŠ½è±¡å·¥å‚ï¼šæ˜¯ä¸€ç§ä¸ºè®¿é—®ç±»æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç»„ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œä¸”è®¿é—®ç±»æ— é¡»æŒ‡å®šæ‰€è¦äº§å“çš„å…·ä½“ç±»å°±èƒ½å¾—åˆ°åŒæ—çš„ä¸åŒç­‰çº§çš„äº§å“çš„æ¨¡å¼ç»“æ„

æŠ½è±¡å·¥å‚æ˜¯å·¥å‚æ–¹æ³•çš„å‡çº§ç‰ˆï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åªç”Ÿäº§ä¸€ä¸ªç­‰çº§çš„äº§å“ï¼Œè€ŒæŠ½è±¡å·¥å‚æ¨¡å¼å¯ç”Ÿäº§å¤šä¸ªç­‰çº§çš„äº§å“

å·¥å‚æ–¹æ³•åªèƒ½åŠ å’–å•¡ï¼Œä¸èƒ½æ‹“å±•å…¶ä»–ä¸šåŠ¡ï¼Œæ‰€ä»¥ä½¿ç”¨æŠ½è±¡å·¥å‚

* æŠ½è±¡å·¥å‚ï¼š

  ```java
  public interface DessertFactory {    
      Coffee createCoffee();    
      Dessert createDessert();
  }
  ```

* å…·ä½“å·¥å‚ï¼š

  ```java
  //ç¾å¼ç”œç‚¹å·¥å‚
  public class AmericanDessertFactory implements DessertFactory {
      public Coffee createCoffee() {
          return new AmericanCoffee();
      }
      public Dessert createDessert() {
          return new MatchaMousse();
      }
  }
  //æ„å¤§åˆ©é£å‘³ç”œç‚¹å·¥å‚
  public class ItalyDessertFactory implements DessertFactory {
  
      public Coffee createCoffee() {
          return new LatteCoffee();
      }
  
      public Dessert createDessert() {
          return new Tiramisu();
      }
  }
  ```

ä¼˜ç‚¹ï¼šå½“ä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡è¢«è®¾è®¡æˆä¸€èµ·å·¥ä½œæ—¶ï¼Œèƒ½ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“æ—ä¸­çš„å¯¹è±¡

ç¼ºç‚¹ï¼šå½“äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—¶ï¼Œæ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹



***



#### æ¨¡å¼æ‹“å±•

é€šè¿‡å·¥å‚æ¨¡å¼+é…ç½®æ–‡ä»¶çš„æ–¹å¼è§£é™¤å·¥å‚å¯¹è±¡å’Œäº§å“å¯¹è±¡çš„è€¦åˆï¼Œåœ¨å·¥å‚ç±»ä¸­åŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„å…¨ç±»åï¼Œå¹¶åˆ›å»ºå¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œå®¢æˆ·ç«¯å¦‚æœéœ€è¦å¯¹è±¡ï¼Œç›´æ¥è¿›è¡Œè·å–å³å¯

* å®šä¹‰é…ç½®æ–‡ä»¶ bean.propertiesï¼š

  ```properties
  american=pattern.factory.config_factory.AmericanCoffee
  latte=pattern.factory.config_factory.LatteCoffee
  ```

* æ”¹è¿›å·¥å‚ç±»ï¼š

  ```java
  public class CoffeeFactory {
      private static Map<String,Coffee> map = new HashMap();
      static {
          Properties p = new Properties();
          InputStream is = CoffeeFactory.class.getClassLoader().getResourceAsStream("bean.properties");
          try {
              p.load(is);
              //éå†Propertiesé›†åˆå¯¹è±¡
              Set<Object> keys = p.keySet();
              for (Object key : keys) {
                  //æ ¹æ®é”®è·å–å€¼ï¼ˆå…¨ç±»åï¼‰
                  String className = p.getProperty((String) key);
                  //è·å–å­—èŠ‚ç å¯¹è±¡
                  Class clazz = Class.forName(className);
                  Coffee obj = (Coffee) clazz.newInstance();
                  map.put((String)key,obj);
              }
          } catch (Exception e) {
              e.printStackTrace();
          }
      }
  
      public static Coffee createCoffee(String name) {
          return map.get(name);
      }
  }
  ```

  é™æ€æˆå‘˜å˜é‡ç”¨æ¥å­˜å‚¨åˆ›å»ºçš„å¯¹è±¡ï¼ˆé”®å­˜å‚¨çš„æ˜¯åç§°ï¼Œå€¼å­˜å‚¨çš„æ˜¯å¯¹åº”çš„å¯¹è±¡ï¼‰ï¼Œè€Œè¯»å–é…ç½®æ–‡ä»¶ä»¥åŠåˆ›å»ºå¯¹è±¡å†™åœ¨é™æ€ä»£ç å—ä¸­ï¼Œç›®çš„å°±æ˜¯åªéœ€è¦æ‰§è¡Œä¸€æ¬¡



***



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

ä½¿ç”¨åœºæ™¯ï¼š

* å½“éœ€è¦åˆ›å»ºçš„å¯¹è±¡æ˜¯ä¸€ç³»åˆ—ç›¸äº’å…³è”æˆ–ç›¸äº’ä¾èµ–çš„äº§å“æ—æ—¶ï¼Œå¦‚ç”µå™¨å·¥å‚ä¸­çš„ç”µè§†æœºã€æ´—è¡£æœºã€ç©ºè°ƒç­‰
* ç³»ç»Ÿä¸­æœ‰å¤šä¸ªäº§å“æ—ï¼Œä½†æ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„æŸä¸€æ—äº§å“ï¼Œå¦‚æœ‰äººåªå–œæ¬¢ç©¿æŸä¸€ä¸ªå“ç‰Œçš„è¡£æœå’Œé‹
* ç³»ç»Ÿä¸­æä¾›äº†äº§å“çš„ç±»åº“ï¼Œä¸”æ‰€æœ‰äº§å“çš„æ¥å£ç›¸åŒï¼Œå®¢æˆ·ç«¯ä¸ä¾èµ–äº§å“å®ä¾‹çš„åˆ›å»ºç»†èŠ‚å’Œå†…éƒ¨ç»“æ„



##### æºç åº”ç”¨

iterator

```java
public class Demo {
    public static void main(String[] args) {
        List<String> list = new ArrayList<>();
        list.add("ä»¤ç‹å†²");
        list.add("é£æ¸…æ‰¬");
        list.add("ä»»æˆ‘è¡Œ");

        //è·å–è¿­ä»£å™¨å¯¹è±¡
        Iterator<String> it = list.iterator();
        //ä½¿ç”¨è¿­ä»£å™¨éå†
        while(it.hasNext()) {
            String ele = it.next();
            System.out.println(ele);
        }
    }
}
```

ä½¿ç”¨è¿­ä»£å™¨éå†é›†åˆï¼Œè·å–é›†åˆä¸­çš„å…ƒç´ ï¼Œè€Œå•åˆ—é›†åˆè·å–è¿­ä»£å™¨çš„æ–¹æ³•å°±ä½¿ç”¨åˆ°äº†å·¥å‚æ–¹æ³•æ¨¡å¼

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-iteratoræºç è§£æ.png" style="zoom:80%;" />

Collection æ¥å£æ˜¯æŠ½è±¡å·¥å‚ç±»ï¼ŒArrayList æ˜¯å…·ä½“çš„å·¥å‚ç±»ï¼ŒIterator æ¥å£æ˜¯æŠ½è±¡å•†å“ç±»ï¼ŒArrayList ç±»ä¸­çš„ Iter å†…éƒ¨ç±»æ˜¯å…·ä½“çš„å•†å“ç±»ï¼Œåœ¨å…·ä½“çš„å·¥å‚ç±»ä¸­ iterator() æ–¹æ³•åˆ›å»ºå…·ä½“çš„å•†å“ç±»çš„å¯¹è±¡



***



### åŸå‹æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

ç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å®ä¾‹ä½œä¸ºåŸå‹ï¼Œé€šè¿‡å¤åˆ¶è¯¥åŸå‹å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå’ŒåŸå‹å¯¹è±¡ç›¸åŒçš„æ–°å¯¹è±¡

åŸå‹æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡åŸå‹ç±»ï¼šè§„å®šäº†å…·ä½“åŸå‹å¯¹è±¡å¿…é¡»å®ç°çš„çš„ clone() æ–¹æ³•ã€‚
* å…·ä½“åŸå‹ç±»ï¼šå®ç°æŠ½è±¡åŸå‹ç±»çš„ clone() æ–¹æ³•ï¼Œå®ƒæ˜¯å¯è¢«å¤åˆ¶çš„å¯¹è±¡ã€‚
* è®¿é—®ç±»ï¼šä½¿ç”¨å…·ä½“åŸå‹ç±»ä¸­çš„ clone() æ–¹æ³•æ¥å¤åˆ¶æ–°çš„å¯¹è±¡

æ¥å£ç±»å›¾å¦‚ä¸‹ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-åŸå‹æ¨¡å¼.png" style="zoom:80%;" />



***



#### ä»£ç å®ç°

åŸå‹æ¨¡å¼çš„å…‹éš†åˆ†ä¸ºæµ…å…‹éš†å’Œæ·±å…‹éš†ï¼Œå…·ä½“ä»‹ç»å‚è€ƒ Object ç±»ä»‹ç»éƒ¨åˆ†çš„ç¬”è®°

Javaä¸­ çš„ Object ç±»ä¸­æä¾›äº† `clone()` æ–¹æ³•æ¥å®ç°æµ…å…‹éš†ï¼Œå®ç° Cloneable æ¥å£çš„ç±»æ‰å¯ä»¥è¢«å…‹éš†

* å…·ä½“åŸå‹ç±»ï¼š

  ```java
  public class Citation implements Cloneable {
      private String name;
      public void setName(String name) {
          this.name = name;
      }
  
      public String getName() {
          return (this.name);
      }
  
      public void show() {
          System.out.println(name + "åŒå­¦ï¼šç¬¬ä¸€å­¦æœŸè¢«è¯„ä¸ºä¸‰å¥½å­¦ç”Ÿã€‚ç‰¹å‘æ­¤çŠ¶ï¼");
      }
  
      @Override
      public Citation clone() throws CloneNotSupportedException {
          return (Citation) super.clone();
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class CitationTest {
      public static void main(String[] args) throws CloneNotSupportedException {
          Citation c1 = new Citation();
          c1.setName("å¼ ä¸‰");
          //å¤åˆ¶å¥–çŠ¶
          Citation c2 = c1.clone();
          c2.setName("æå››");
  
          c1.show();// å¼ ä¸‰
          c2.show();// æå››
      }
  }
  ```

  

****



#### æ¨¡å¼æ‹“å±•

æ·±å…‹éš†æ¡ˆä¾‹ï¼š

* åŸä»£ç ï¼š

  ```java
  public class Citation implements Cloneable {
      private Student stu;
  	// get + set
      
      public void show() {
          System.out.println(stu.getName() + "åŒå­¦ï¼šåœ¨ç¬¬ä¸€å­¦æœŸè¢«è¯„ä¸ºä¸‰å¥½å­¦ç”Ÿã€‚ç‰¹å‘æ­¤çŠ¶ï¼");
      }
  
      @Override
      public Citation clone() throws CloneNotSupportedException {
          return (Citation) super.clone();
      }
  }
  //å­¦ç”Ÿç±»
  public class Student {
      private String name;
  }
  ```

* æµ‹è¯•ä»£ç 

  ```java
  public static void main(String[] args) throws CloneNotSupportedException {
      Citation c1 = new Citation();
      Student stu1 = new Student();
      stu1.setName("å¼ ä¸‰");
      c1.setStu(stu);
      
      Citation c2 = citation.clone();
      Student stu2 = c2.getStu();
      stu2.setName("æå››");
  
      citation.show();	//æå››...
      citation1.show();	//æå››...
  }
  ```

  stu1 å¯¹è±¡å’Œ stu2 å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå°† stu2 å¯¹è±¡ä¸­ name å±æ€§æ”¹ä¸ºæå››ï¼Œä¸¤ä¸ªCitationå¯¹è±¡ä¸­éƒ½æ˜¯æå››ï¼Œè¿™å°±æ˜¯æµ…å…‹éš†çš„æ•ˆæœ

* åºåˆ—åŒ–å®ç°æ·±å…‹éš†ï¼Œæˆ–è€…é‡å†™å…‹éš†æ–¹æ³•ï¼š

  åºåˆ—åŒ–ï¼š

  ```java
  public class CitationTest1 {
      public static void main(String[] args) throws Exception {
          Citation c1 = new Citation();
          Student stu = new Student("å¼ ä¸‰");
          c1.setStu(stu);
  
          //åˆ›å»ºå¯¹è±¡è¾“å‡ºæµå¯¹è±¡
          ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("C:\\b.txt"));
          //å°†c1å¯¹è±¡å†™å‡ºåˆ°æ–‡ä»¶ä¸­
          oos.writeObject(c1);
          oos.close();
  
          //åˆ›å»ºå¯¹è±¡è¾“å…¥æµå¯¹è±¡
          ObjectInputStream ois = new ObjectInputStream(new FileInputStream("C:\\b.txt"));
          //è¯»å–å¯¹è±¡
          Citation c2 = (Citation) ois.readObject();
          //è·å–c2å¥–çŠ¶æ‰€å±å­¦ç”Ÿå¯¹è±¡
          Student stu1 = c2.getStu();
          stu1.setName("æå››");
  
          //åˆ¤æ–­stuå¯¹è±¡å’Œstu1å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
          System.out.println("stuå’Œstu1æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ" + (stu == stu1));//false
          c1.show();//å¼ ä¸‰
          c2.show();//æå››
      }
  }
  ```

  é‡å†™ï¼š

  ```java
  @Override
  public Citation clone() throws CloneNotSupportedException {
      Citation clone = (Citation) super.clone();
      Student o = (Student) stu.clone();
      clone.setStu(o);
      return clone;
  }
  ```



***



### å»ºé€ è€…

#### åŸºæœ¬ä»‹ç»

å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤º

* åˆ†ç¦»äº†éƒ¨ä»¶çš„æ„é€ ï¼ˆç”±Builderæ¥è´Ÿè´£ï¼‰å’Œè£…é…ï¼ˆç”±Directorè´Ÿè´£ï¼‰ï¼Œä»è€Œå¯ä»¥æ„é€ å‡ºå¤æ‚çš„å¯¹è±¡ï¼Œè¿™ä¸ªæ¨¡å¼é€‚ç”¨äºæŸä¸ªå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å¤æ‚çš„æƒ…å†µ
* ç”±äºå®ç°äº†æ„å»ºå’Œè£…é…çš„è§£è€¦ã€‚ä¸åŒçš„æ„å»ºå™¨ï¼Œç›¸åŒçš„è£…é…ï¼Œä¹Ÿå¯ä»¥åšå‡ºä¸åŒçš„å¯¹è±¡ï¼›ç›¸åŒçš„æ„å»ºå™¨ï¼Œä¸åŒçš„è£…é…é¡ºåºä¹Ÿå¯ä»¥åšå‡ºä¸åŒçš„å¯¹è±¡ï¼Œå®ç°äº†æ›´å¥½çš„å¤ç”¨ã€‚
* å»ºé€ è€…æ¨¡å¼å¯ä»¥å°†éƒ¨ä»¶å’Œå…¶ç»„è£…è¿‡ç¨‹åˆ†å¼€ï¼Œä¸€æ­¥ä¸€æ­¥åˆ›å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ã€‚ç”¨æˆ·åªéœ€è¦æŒ‡å®šå¤æ‚å¯¹è±¡çš„ç±»å‹å°±å¯ä»¥å¾—åˆ°è¯¥å¯¹è±¡ï¼Œè€Œæ— é¡»çŸ¥é“å…¶å†…éƒ¨çš„å…·ä½“æ„é€ ç»†èŠ‚

å»ºé€ è€…ï¼ˆBuilderï¼‰æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡å»ºé€ è€…ç±» (Builder)ï¼šè¿™ä¸ªæ¥å£å®šä¹‰è¦å®ç°å¤æ‚å¯¹è±¡çš„å“ªäº›éƒ¨åˆ†çš„åˆ›å»ºï¼Œå¹¶ä¸æ¶‰åŠå…·ä½“çš„éƒ¨ä»¶å¯¹è±¡çš„åˆ›å»º

* å…·ä½“å»ºé€ è€…ç±» (ConcreteBuilder)ï¼šå®ç° Builder æ¥å£ï¼Œå®Œæˆå¤æ‚äº§å“çš„å„ä¸ªéƒ¨ä»¶çš„å…·ä½“åˆ›å»ºæ–¹æ³•ï¼Œåœ¨æ„é€ è¿‡ç¨‹å®Œæˆåï¼Œæä¾›äº§å“çš„å®ä¾‹ã€‚ 

* äº§å“ç±» (Product)ï¼šè¦åˆ›å»ºçš„å¤æ‚å¯¹è±¡

* æŒ‡æŒ¥è€…ç±» (Director)ï¼šè°ƒç”¨å…·ä½“å»ºé€ è€…æ¥åˆ›å»ºå¤æ‚å¯¹è±¡çš„å„ä¸ªéƒ¨åˆ†ï¼Œåœ¨æŒ‡å¯¼è€…ä¸­ä¸æ¶‰åŠå…·ä½“äº§å“çš„ä¿¡æ¯ï¼Œåªè´Ÿè´£ä¿è¯å¯¹è±¡å„éƒ¨åˆ†å®Œæ•´åˆ›å»ºæˆ–æŒ‰æŸç§é¡ºåºåˆ›å»º

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-å»ºé€ è€…æ¨¡å¼.png" style="zoom:80%;" />

æ¨¡å¼ä¼˜ç‚¹ï¼š

- å»ºé€ è€…æ¨¡å¼çš„å°è£…æ€§å¾ˆå¥½ï¼Œä½¿ç”¨å»ºé€ è€…æ¨¡å¼å¯ä»¥æœ‰æ•ˆçš„å°è£…å˜åŒ–ï¼Œå°†ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘å°è£…åœ¨æŒ‡æŒ¥è€…ç±»ä¸­å¯¹æ•´ä½“è€Œè¨€å¯ä»¥å–å¾—æ¯”è¾ƒå¥½çš„ç¨³å®šæ€§
- åœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯ä¸å¿…çŸ¥é“äº§å“å†…éƒ¨ç»„æˆçš„ç»†èŠ‚ï¼Œå°†äº§å“æœ¬èº«ä¸äº§å“çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ï¼Œä½¿å¾—ç›¸åŒçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“å¯¹è±¡
- å¯ä»¥æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶äº§å“çš„åˆ›å»ºè¿‡ç¨‹ ï¼Œå°†å¤æ‚äº§å“çš„åˆ›å»ºæ­¥éª¤åˆ†è§£åœ¨ä¸åŒçš„æ–¹æ³•ä¸­ï¼Œæ›´æ–¹ä¾¿ä½¿ç”¨ç¨‹åºæ¥æ§åˆ¶åˆ›å»ºè¿‡ç¨‹
- å»ºé€ è€…æ¨¡å¼å¾ˆå®¹æ˜“è¿›è¡Œæ‰©å±•ï¼Œå¦‚æœæœ‰æ–°çš„éœ€æ±‚ï¼Œé€šè¿‡å®ç°ä¸€ä¸ªæ–°çš„å»ºé€ è€…ç±»å°±å¯ä»¥å®Œæˆï¼ŒåŸºæœ¬ä¸Šä¸ç”¨ä¿®æ”¹ä¹‹å‰å·²ç»æµ‹è¯•é€šè¿‡çš„ä»£ç ï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šå¯¹åŸæœ‰åŠŸèƒ½å¼•å…¥é£é™©ï¼Œç¬¦åˆå¼€é—­åŸåˆ™

æ¨¡å¼ç¼ºç‚¹ï¼šé€ è€…æ¨¡å¼æ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œå¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚æ€§å¾ˆå¤§ï¼Œåˆ™ä¸é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œå› æ­¤å…¶ä½¿ç”¨èŒƒå›´å—åˆ°ä¸€å®šçš„é™åˆ¶

åº”ç”¨åœºæ™¯ï¼š

* åˆ›å»ºçš„å¯¹è±¡è¾ƒå¤æ‚ï¼Œç”±å¤šä¸ªéƒ¨ä»¶æ„æˆï¼Œå„éƒ¨ä»¶é¢ä¸´ç€å¤æ‚çš„å˜åŒ–ï¼Œä½†æ„ä»¶é—´çš„å»ºé€ é¡ºåºæ˜¯ç¨³å®šçš„
* åˆ›å»ºå¤æ‚å¯¹è±¡çš„ç®—æ³•ç‹¬ç«‹äºè¯¥å¯¹è±¡çš„ç»„æˆéƒ¨åˆ†ä»¥åŠè£…é…æ–¹å¼ï¼Œå³äº§å“çš„æ„å»ºè¿‡ç¨‹å’Œæœ€ç»ˆçš„è¡¨ç¤ºæ˜¯ç‹¬ç«‹çš„



****



#### ä»£ç å®ç°

ç”Ÿäº§è‡ªè¡Œè½¦æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå®ƒåŒ…å«äº†è½¦æ¶ï¼Œè½¦åº§ç­‰ç»„ä»¶çš„ç”Ÿäº§ã€‚è€Œè½¦æ¶åˆæœ‰å¤šç§æè´¨çš„ï¼Œè½¦åº§æœ‰å¤šç§æè´¨ï¼Œå¯¹äºè‡ªè¡Œè½¦çš„ç”Ÿäº§å°±å¯ä»¥ä½¿ç”¨å»ºé€ è€…æ¨¡å¼

* è‡ªè¡Œè½¦ç±»ï¼š

  ```java
  public class Bike {   
      private String frame;    
      private String seat;	
      // ...
  }
  ```

* æŠ½è±¡ builder ç±»ï¼š

  ```java
  public abstract class Builder {
      protected Bike bike = new Bike();
  
      public abstract void buildFrame();
      public abstract void buildSeat();
      public abstract Bike createBike();
  }
  ```

* å…·ä½“ builder ç±»ï¼š

  ```java
  //æ‘©æ‹œå•è½¦Builderç±»
  public class MobikeBuilder extends Builder {
      @Override
      public void buildFrame() {
          bike.setFrame("é“åˆé‡‘è½¦æ¶");
      }
      @Override
      public void buildSeat() {
          bike.setSeat("çœŸçš®è½¦åº§");
      }
      @Override
      public Bike createBike() {
          return bike;
      }
  }
  //ofoå•è½¦Builderç±»
  public class OfoBuilder extends Builder {
      @Override
      public void buildFrame() {
          bike.setFrame("ç¢³çº¤ç»´è½¦æ¶");
      }
      @Override
      public void buildSeat() {
          bike.setSeat("æ©¡èƒ¶è½¦åº§");
      }
      @Override
      public Bike createBike() {
          return bike;
      }
  }
  ```

* æŒ‡æŒ¥è€…ç±»ï¼š

  ```java
  public class Director {
      private Builder builder;
  
      public Director(Builder builder) {
          this.builder = builder;
      }
  
      public Bike construct() {
          builder.buildFrame();
          builder.buildSeat();
          return builder.createBike();
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      Director director = new Director(new MobileBuilder());
      // æŒ‡æŒ¥è€…æŒ‡æŒ¥è£…é…è‡ªè¡Œè½¦
      Bike bike = director.construct();
      System.out.println(bike.getFrame() + bike.getSeat());
  }
  ```



****



#### æ¨¡å¼æ‹“å±•

å½“ä¸€ä¸ªç±»æ„é€ å™¨éœ€è¦ä¼ å…¥å¾ˆå¤šå‚æ•°æ—¶ï¼Œå¦‚æœåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ï¼Œä»£ç å¯è¯»æ€§ä¼šéå¸¸å·®ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å¼•å…¥é”™è¯¯ï¼Œæ­¤æ—¶å°±å¯ä»¥åˆ©ç”¨å»ºé€ è€…æ¨¡å¼è¿›è¡Œé‡æ„

* é‡æ„å‰ä»£ç ï¼š

  ```java
  public class Phone {
      private String cpu;
      private String screen;
      private String memory;
      private String mainboard;
  }
  public static void main(String[] args) {
      //æ„å»ºPhoneå¯¹è±¡
      Phone phone = new Phone("intel","ä¸‰æ˜Ÿå±å¹•","é‡‘å£«é¡¿","åç¡•");
      System.out.println(phone);
  }
  ```

* é‡æ„åçš„ä»£ç ï¼š

  ````java
  public class Phone {
      private String cpu;
      private String screen;
      private String memory;
      private String mainboard;
  
      private Phone(Builder builder) {
          cpu = builder.cpu;
          screen = builder.screen;
          memory = builder.memory;
          mainboard = builder.mainboard;
      }
  
      public static final class Builder {
          private String cpu;
          private String screen;
          private String memory;
          private String mainboard;
  
          public Builder() {}
  		//è¿”å›å€¼ä¸ºthis æ‰€ä»¥æ”¯æŒé“¾å¼ç¼–ç¨‹
          public Builder cpu(String val) {
              cpu = val;
              return this;
          }
          public Builder screen(String val) {
              screen = val;
              return this;
          }
          public Builder memory(String val) {
              memory = val;
              return this;
          }
          public Builder mainboard(String val) {
              mainboard = val;
              return this;
          }
          public Phone build() {
              return new Phone(this);
          }
      }
  }
  
  public static void main(String[] args) {
      Phone phone = new Phone.Builder()
          .cpu("intel")
          .mainboard("åç¡•")
          .memory("é‡‘å£«é¡¿")
          .screen("ä¸‰æ˜Ÿ")
          .build();
      System.out.println(phone);
  }
  ````

  



***



#### æ¨¡å¼å¯¹æ¯”

å·¥å‚æ–¹æ³•æ¨¡å¼å¯¹æ¯”å»ºé€ è€…æ¨¡å¼

* å·¥å‚æ–¹æ³•æ¨¡å¼æ³¨é‡çš„æ˜¯æ•´ä½“å¯¹è±¡çš„åˆ›å»ºæ–¹å¼
* å»ºé€ è€…æ¨¡å¼æ³¨é‡çš„æ˜¯éƒ¨ä»¶æ„å»ºçš„è¿‡ç¨‹ï¼Œæ„åœ¨é€šè¿‡ä¸€æ­¥ä¸€æ­¥åœ°ç²¾ç¡®æ„é€ åˆ›å»ºå‡ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡

æŠ½è±¡å·¥å‚æ¨¡å¼å¯¹æ¯”å»ºé€ è€…æ¨¡å¼

* æŠ½è±¡å·¥å‚æ¨¡å¼å®ç°å¯¹äº§å“å®¶æ—çš„åˆ›å»ºï¼Œä¸€ä¸ªäº§å“å®¶æ—æ˜¯è¿™æ ·çš„ä¸€ç³»åˆ—äº§å“ï¼Œä¸éœ€è¦å…³å¿ƒæ„å»ºè¿‡ç¨‹ï¼Œåªå…³å¿ƒä»€ä¹ˆäº§å“ç”±ä»€ä¹ˆå·¥å‚ç”Ÿäº§å³å¯

* å»ºé€ è€…æ¨¡å¼åˆ™æ˜¯è¦æ±‚æŒ‰ç…§æŒ‡å®šçš„è“å›¾å»ºé€ äº§å“ï¼Œä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç»„è£…é›¶é…ä»¶è€Œäº§ç”Ÿä¸€ä¸ªæ–°äº§å“

  å¦‚æœå°†æŠ½è±¡å·¥å‚æ¨¡å¼çœ‹æˆæ±½è½¦é…ä»¶ç”Ÿäº§å·¥å‚ï¼Œç”Ÿäº§ä¸€ä¸ªäº§å“æ—çš„äº§å“ï¼Œé‚£ä¹ˆå»ºé€ è€…æ¨¡å¼å°±æ˜¯ä¸€ä¸ªæ±½è½¦ç»„è£…å·¥å‚ï¼Œé€šè¿‡å¯¹éƒ¨ä»¶çš„ç»„è£…å¯ä»¥è¿”å›ä¸€è¾†å®Œæ•´çš„æ±½è½¦





****





## ç»“æ„å‹

### æ¨¡å¼åˆ†ç±»

ç»“æ„å‹æ¨¡å¼æè¿°å¦‚ä½•å°†ç±»æˆ–å¯¹è±¡æŒ‰æŸç§å¸ƒå±€ç»„æˆæ›´å¤§çš„ç»“æ„ï¼Œåˆ†ä¸ºç±»ç»“æ„å‹æ¨¡å¼å’Œå¯¹è±¡ç»“æ„å‹æ¨¡å¼ï¼Œå‰è€…é‡‡ç”¨ç»§æ‰¿æœºåˆ¶æ¥ç»„ç»‡æ¥å£å’Œç±»ï¼Œåè€…é‡†ç”¨ç»„åˆæˆ–èšåˆæ–¹å¼æ¥ç»„åˆå¯¹è±¡ã€‚ç”±äºç»„åˆå…³ç³»æˆ–èšåˆå…³ç³»æ¯”ç»§æ‰¿å…³ç³»è€¦åˆåº¦ä½ï¼Œæ»¡è¶³åˆæˆå¤ç”¨åŸåˆ™ï¼Œæ‰€ä»¥å¯¹è±¡ç»“æ„å‹æ¨¡å¼æ¯”ç±»ç»“æ„å‹æ¨¡å¼å…·æœ‰æ›´å¤§çš„çµæ´»æ€§

ç»“æ„å‹æ¨¡å¼åˆ†ä¸º 7 ç§ï¼šä»£ç†æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€è£…é¥°è€…æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€äº«å…ƒæ¨¡å¼



***



### ä»£ç†æ¨¡å¼

#### é™æ€ä»£ç†

ä»£ç†æ¨¡å¼ï¼šç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œè®¿é—®å¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨ä¸ºç›®æ ‡å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„ä¸­ä»‹

Java ä¸­çš„ä»£ç†æŒ‰ç…§ä»£ç†ç±»ç”Ÿæˆæ—¶æœºä¸åŒåˆåˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œé™æ€ä»£ç†ä»£ç†ç±»åœ¨ç¼–è¯‘æœŸå°±ç”Ÿæˆï¼Œè€ŒåŠ¨æ€ä»£ç†ä»£ç†ç±»åˆ™æ˜¯åœ¨ Java è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆï¼ŒåŠ¨æ€ä»£ç†åˆæœ‰ JDK ä»£ç†å’Œ CGLib ä»£ç†ä¸¤ç§

ä»£ç†ï¼ˆProxyï¼‰æ¨¡å¼åˆ†ä¸ºä¸‰ç§è§’è‰²ï¼š

* æŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰ç±»ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•
* çœŸå®ä¸»é¢˜ï¼ˆReal Subjectï¼‰ç±»ï¼š å®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡æ‰€ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡
* ä»£ç†ï¼ˆProxyï¼‰ç±»ï¼šæä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½

ä¹°ç¥¨æ¡ˆä¾‹ï¼Œç«è½¦ç«™æ˜¯ç›®æ ‡å¯¹è±¡ï¼Œä»£å”®ç‚¹æ˜¯ä»£ç†å¯¹è±¡

* å–ç¥¨æ¥å£ï¼š

  ```java
  public interface SellTickets {
      void sell();
  }
  ```

* ç«è½¦ç«™ï¼Œå…·æœ‰å–ç¥¨åŠŸèƒ½ï¼Œéœ€è¦å®ç°SellTicketsæ¥å£

  ```java
  public class TrainStation implements SellTickets {
      public void sell() {
          System.out.println("ç«è½¦ç«™å–ç¥¨");
      }
  }
  ```
  
* ä»£å”®ç‚¹ï¼š

  ```java
  public class ProxyPoint implements SellTickets {
      private TrainStation station = new TrainStation();
  
      public void sell() {
          System.out.println("ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨");
          station.sell();
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class Client {
      public static void main(String[] args) {
          ProxyPoint pp = new ProxyPoint();
          pp.sell();
      }
  }
  ```

  æµ‹è¯•ç±»ç›´æ¥è®¿é—®çš„æ˜¯ ProxyPoint ç±»å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ ProxyPoint ä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡çš„ä¸­ä»‹



****



#### JDK

##### ä½¿ç”¨æ–¹å¼

Java ä¸­æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±» Proxyï¼ŒProxy å¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡çš„ç±»ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªåˆ›å»ºä»£ç†å¯¹è±¡çš„é™æ€æ–¹æ³• newProxyInstance() æ¥è·å–ä»£ç†å¯¹è±¡

`static Object newProxyInstance(ClassLoader loader,Class[] interfaces,InvocationHandler h) `

* å‚æ•°ä¸€ï¼šç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ä»£ç†ç±»
* å‚æ•°äºŒï¼šè¢«ä»£ç†ä¸šåŠ¡å¯¹è±¡çš„**å…¨éƒ¨å®ç°çš„æ¥å£**ï¼Œä»£ç†å¯¹è±¡ä¸çœŸå®å¯¹è±¡å®ç°ç›¸åŒæ¥å£ï¼ŒçŸ¥é“ä¸ºå“ªäº›æ–¹æ³•åšä»£ç†
* å‚æ•°ä¸‰ï¼šä»£ç†çœŸæ­£çš„æ‰§è¡Œæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä»£ç†çš„å¤„ç†é€»è¾‘

ä»£ç å®ç°ï¼š

* ä»£ç†å·¥å‚ï¼šåˆ›å»ºä»£ç†å¯¹è±¡

  ```java
  public class ProxyFactory {
      private TrainStation station = new TrainStation();
  	//ä¹Ÿå¯ä»¥åœ¨å‚æ•°ä¸­æä¾› getProxyObject(TrainStation station)
      public SellTickets getProxyObject() {
          //ä½¿ç”¨Proxyè·å–ä»£ç†å¯¹è±¡
          SellTickets sellTickets = (SellTickets) Proxy.newProxyInstance(
              	station.getClass().getClassLoader(),
                  station.getClass().getInterfaces(),
                  new InvocationHandler() {
                      public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                          System.out.println("ä»£ç†ç‚¹(JDKåŠ¨æ€ä»£ç†æ–¹å¼)");
                          //æ‰§è¡ŒçœŸå®å¯¹è±¡
                          Object result = method.invoke(station, args);
                          return result;
                      }
                  });
          return sellTickets;
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class Client {
      public static void main(String[] args) {
          //è·å–ä»£ç†å¯¹è±¡
          ProxyFactory factory = new ProxyFactory();
          SellTickets proxyObject = factory.getProxyObject();
          proxyObject.sell();
      }
  }
  ```



***



##### åŸç†è§£æ

JDK åŠ¨æ€ä»£ç†æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š

- ä¼˜ç‚¹ï¼šå¯ä»¥ä¸ºä»»æ„çš„æ¥å£å®ç°ç±»å¯¹è±¡åšä»£ç†ï¼Œä¹Ÿå¯ä»¥ä¸ºè¢«ä»£ç†å¯¹è±¡çš„æ‰€æœ‰æ¥å£çš„æ‰€æœ‰æ–¹æ³•åšä»£ç†ï¼ŒåŠ¨æ€ä»£ç†å¯ä»¥åœ¨ä¸æ”¹å˜æ–¹æ³•æºç çš„æƒ…å†µä¸‹ï¼Œå®ç°å¯¹æ–¹æ³•åŠŸèƒ½çš„å¢å¼ºï¼Œæé«˜äº†è½¯ä»¶çš„å¯æ‰©å±•æ€§ï¼ŒJava åå°„æœºåˆ¶å¯ä»¥ç”Ÿæˆä»»æ„ç±»å‹çš„åŠ¨æ€ä»£ç†ç±»
- ç¼ºç‚¹ï¼š**åªèƒ½é’ˆå¯¹æ¥å£æˆ–è€…æ¥å£çš„å®ç°ç±»å¯¹è±¡åšä»£ç†å¯¹è±¡**ï¼Œæ™®é€šç±»æ˜¯ä¸èƒ½åšä»£ç†å¯¹è±¡çš„
- åŸå› ï¼š**ç”Ÿæˆçš„ä»£ç†ç±»ç»§æ‰¿äº† Proxy**ï¼Œjava æ˜¯å•ç»§æ‰¿çš„ï¼Œæ‰€ä»¥ JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£

ProxyFactory ä¸æ˜¯ä»£ç†æ¨¡å¼ä¸­çš„ä»£ç†ç±»ï¼Œè€Œä»£ç†ç±»æ˜¯ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆçš„ç±»ï¼Œå¯ä»¥é€šè¿‡ Arthas å·¥å…·æŸ¥çœ‹ä»£ç†ç±»ç»“æ„ï¼š

* ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰å®ç°äº† SellTickets æ¥å£ï¼ŒçœŸå®ç±»å’Œä»£ç†ç±»å®ç°åŒæ ·çš„æ¥å£
* ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰å°†æä¾›äº†çš„åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ä¼ é€’ç»™äº†çˆ¶ç±»

```java
//ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»
public final class $Proxy0 extends Proxy implements SellTickets {
    private static Method m3;

    public $Proxy0(InvocationHandler invocationHandler) {
        super(invocationHandler);//InvocationHandlerå¯¹è±¡ä¼ é€’ç»™çˆ¶ç±»
    }

    static {
        m3 = Class.forName("proxy.dynamic.jdk.SellTickets").getMethod("sell", new Class[0]);
    }

    public final void sell() {
        // è°ƒç”¨InvocationHandlerçš„invokeæ–¹æ³•
        this.h.invoke(this, m3, null);
    }
}

//Javaæä¾›çš„åŠ¨æ€ä»£ç†ç›¸å…³ç±»
public class Proxy implements java.io.Serializable {
	protected InvocationHandler h;
	 
	protected Proxy(InvocationHandler h) {
        this.h = h;
    }
}
```

æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. åœ¨æµ‹è¯•ç±»ä¸­é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ sell() æ–¹æ³•
2. æ ¹æ®å¤šæ€çš„ç‰¹æ€§ï¼Œæ‰§è¡Œçš„æ˜¯ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰ä¸­çš„ sell() æ–¹æ³•
3. ä»£ç†ç±»ï¼ˆ$Proxy0ï¼‰ä¸­çš„ sell() æ–¹æ³•ä¸­åˆè°ƒç”¨äº† InvocationHandler æ¥å£çš„å­å®ç°ç±»å¯¹è±¡çš„ invoke æ–¹æ³•
4. invoke æ–¹æ³•é€šè¿‡åå°„æ‰§è¡Œäº†çœŸå®å¯¹è±¡æ‰€å±ç±»ï¼ˆTrainStationï¼‰ä¸­çš„ sell() æ–¹æ³•



***



#### CGLIB

##### ä½¿ç”¨æ–¹å¼

CGLIB æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ï¼Œé«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ï¼Œä¸ºæ²¡æœ‰å®ç°æ¥å£çš„ç±»æä¾›ä»£ç†ï¼Œä¸º JDK åŠ¨æ€ä»£ç†æä¾›äº†è¡¥å……

* CGLIB æ˜¯ç¬¬ä¸‰æ–¹æä¾›çš„åŒ…ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥ jar åŒ…çš„åæ ‡ï¼š

  ```xml
  <dependency>
      <groupId>cglib</groupId>
      <artifactId>cglib</artifactId>
      <version>2.2.2</version>
  </dependency>
  ```

* ä»£ç†å·¥å‚ç±»ï¼š

  ```java
  public class ProxyFactory implements MethodInterceptor {
      private TrainStation target = new TrainStation();
  
      public TrainStation getProxyObject() {
          //åˆ›å»ºEnhancerå¯¹è±¡ï¼Œç±»ä¼¼äºJDKåŠ¨æ€ä»£ç†çš„Proxyç±»ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è®¾ç½®å‡ ä¸ªå‚æ•°
          Enhancer enhancer =new Enhancer();
          //è®¾ç½®çˆ¶ç±»çš„å­—èŠ‚ç å¯¹è±¡
          enhancer.setSuperclass(target.getClass());
          //è®¾ç½®å›è°ƒå‡½æ•°
          enhancer.setCallback(new MethodInterceptor() {
              @Override
              public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
  				System.out.println("ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨(CGLIBåŠ¨æ€ä»£ç†æ–¹å¼)");
          		Object o = methodProxy.invokeSuper(obj, args);
          		return null;//å› ä¸ºè¿”å›å€¼ä¸ºvoid
              }
          });
          //åˆ›å»ºä»£ç†å¯¹è±¡
          TrainStation obj = (TrainStation) enhancer.create();
          return obj;
      }
  }
  ```



***



##### åŸç†åˆ†æ

CGLIB çš„ä¼˜ç¼ºç‚¹

* ä¼˜ç‚¹ï¼š
  * CGLIB åŠ¨æ€ä»£ç†**ä¸é™å®š**æ˜¯å¦å…·æœ‰æ¥å£ï¼Œå¯ä»¥å¯¹ä»»æ„æ“ä½œè¿›è¡Œå¢å¼º
  * CGLIB åŠ¨æ€ä»£ç†æ— éœ€è¦åŸå§‹è¢«ä»£ç†å¯¹è±¡ï¼ŒåŠ¨æ€åˆ›å»ºå‡ºæ–°çš„ä»£ç†å¯¹è±¡
  * JDKProxy ä»…å¯¹æ¥å£æ–¹æ³•åšå¢å¼ºï¼ŒCGLIB å¯¹æ‰€æœ‰æ–¹æ³•åšå¢å¼ºï¼ŒåŒ…æ‹¬ Object ç±»ä¸­çš„æ–¹æ³•ï¼ŒtoStringã€hashCode ç­‰
* ç¼ºç‚¹ï¼šCGLIB ä¸èƒ½å¯¹å£°æ˜ä¸º final çš„ç±»æˆ–è€…æ–¹æ³•è¿›è¡Œä»£ç†ï¼Œå› ä¸º CGLIB åŸç†æ˜¯**åŠ¨æ€ç”Ÿæˆè¢«ä»£ç†ç±»çš„å­ç±»ï¼Œç»§æ‰¿è¢«ä»£ç†ç±»**





****



#### æ–¹å¼å¯¹æ¯”

ä¸‰ç§æ–¹å¼å¯¹æ¯”ï¼š

* JDK ä»£ç†å’Œ CGLIB ä»£ç†

  ä½¿ç”¨ CGLIB å®ç°åŠ¨æ€ä»£ç†ï¼ŒCGLIB åº•å±‚é‡‡ç”¨ ASM å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œä½¿ç”¨å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä»£ç†ç±»ï¼Œåœ¨ JDK1.6ä¹‹å‰æ¯”ä½¿ç”¨ Java åå°„æ•ˆç‡è¦é«˜ï¼Œåˆ° JDK1.8 çš„æ—¶å€™ï¼ŒJDK ä»£ç†æ•ˆç‡é«˜äº CGLIB ä»£ç†ã€‚æ‰€ä»¥å¦‚æœæœ‰æ¥å£ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ä½¿ç”¨ CGLIB ä»£ç†

* åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†

  * åŠ¨æ€ä»£ç†å°†æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•éƒ½è¢«è½¬ç§»åˆ°ä¸€ä¸ªé›†ä¸­çš„æ–¹æ³•ä¸­å¤„ç†ï¼ˆInvocationHandler.invokeï¼‰ï¼Œåœ¨æ¥å£æ–¹æ³•æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œçµæ´»å¤„ç†ï¼Œä¸éœ€è¦åƒé™æ€ä»£ç†é‚£æ ·æ¯ä¸€ä¸ªæ–¹æ³•è¿›è¡Œä¸­è½¬

  * é™æ€ä»£ç†æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å°†æ¥å£ã€ä»£ç†ç±»ã€è¢«ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ç¡®å®šä¸‹æ¥
  * åŠ¨æ€ä»£ç†æ˜¯ç¨‹åºåœ¨è¿è¡Œåé€šè¿‡åå°„åˆ›å»ºå­—èŠ‚ç æ–‡ä»¶äº¤ç”± JVM åŠ è½½

ä»£ç†æ¨¡å¼çš„ä¼˜ç¼ºç‚¹ï¼š

* ä¼˜ç‚¹ï¼š
  * ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨
  * ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½
  * ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦

* ç¼ºç‚¹ï¼šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦

ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ï¼š

* è¿œç¨‹ï¼ˆRemoteï¼‰ä»£ç†

  æœ¬åœ°æœåŠ¡é€šè¿‡ç½‘ç»œè¯·æ±‚è¿œç¨‹æœåŠ¡ï¼Œéœ€è¦å®ç°ç½‘ç»œé€šä¿¡ï¼Œå¤„ç†å…¶ä¸­å¯èƒ½çš„å¼‚å¸¸ã€‚ä¸ºäº†è‰¯å¥½çš„ä»£ç è®¾è®¡å’Œå¯ç»´æŠ¤æ€§ï¼Œå°†ç½‘ç»œé€šä¿¡éƒ¨åˆ†éšè—èµ·æ¥ï¼Œåªæš´éœ²ç»™æœ¬åœ°æœåŠ¡ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡è¯¥æ¥å£å³å¯è®¿é—®è¿œç¨‹æœåŠ¡æä¾›çš„åŠŸèƒ½

* é˜²ç«å¢™ï¼ˆFirewallï¼‰ä»£ç†

  å½“ä½ å°†æµè§ˆå™¨é…ç½®æˆä½¿ç”¨ä»£ç†åŠŸèƒ½æ—¶ï¼Œé˜²ç«å¢™å°±å°†ä½ çš„æµè§ˆå™¨çš„è¯·æ±‚è½¬ç»™äº’è”ç½‘ï¼Œå½“äº’è”ç½‘è¿”å›å“åº”æ—¶ï¼Œä»£ç†æœåŠ¡å™¨å†æŠŠå®ƒè½¬ç»™ä½ çš„æµè§ˆå™¨

* ä¿æŠ¤ï¼ˆProtect or Accessï¼‰ä»£ç†

  æ§åˆ¶å¯¹ä¸€ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥ç»™ä¸åŒçš„ç”¨æˆ·æä¾›ä¸åŒçº§åˆ«çš„ä½¿ç”¨æƒé™





***



### é€‚é…å™¨

#### åŸºæœ¬ä»‹ç»

é€‚é…å™¨ï¼šå°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œï¼Œæ¯”å¦‚ Type-C è½¬æ¥å¤´

é€‚é…å™¨æ¨¡å¼åˆ†ä¸ºç±»é€‚é…å™¨æ¨¡å¼å’Œå¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼Œå‰è€…ç±»ä¹‹é—´çš„è€¦åˆåº¦æ¯”åè€…é«˜ï¼Œä¸”è¦æ±‚äº†è§£ç°æœ‰ç»„ä»¶åº“ä¸­çš„ç›¸å…³ç»„ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œæ‰€ä»¥åº”ç”¨ç›¸å¯¹è¾ƒå°‘

è¿˜æœ‰ä¸€ä¸ªé€‚é…å™¨æ¨¡å¼æ˜¯æ¥å£é€‚é…å™¨æ¨¡å¼ï¼Œå½“ä¸å¸Œæœ›å®ç°ä¸€ä¸ªæ¥å£ä¸­æ‰€æœ‰çš„æ–¹æ³•æ—¶ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæŠ½è±¡ç±»Adapter å®ç°æ‰€æœ‰æ–¹æ³•ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬åªéœ€è¦ç»§æ‰¿è¯¥æŠ½è±¡ç±»å®ç°è‡ªå·±æƒ³å®ç°çš„åŠŸèƒ½å³å¯

é€‚é…å™¨æ¨¡å¼ï¼ˆAdapterï¼‰åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* ç›®æ ‡ï¼ˆTargetï¼‰æ¥å£ï¼šå½“å‰ç³»ç»Ÿä¸šåŠ¡æ‰€æœŸå¾…çš„æ¥å£ï¼Œå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£
* é€‚é…è€…ï¼ˆAdapteeï¼‰ç±»ï¼šè¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£
* é€‚é…å™¨ï¼ˆAdapterï¼‰ç±»ï¼šæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œé€šè¿‡ç»§æ‰¿æˆ–å¼•ç”¨é€‚é…è€…çš„å¯¹è±¡ï¼ŒæŠŠé€‚é…è€…æ¥å£è½¬æ¢æˆç›®æ ‡æ¥å£ï¼Œè®©å¼€å‘äººå‘˜æŒ‰ç›®æ ‡æ¥å£çš„æ ¼å¼è®¿é—®é€‚é…è€…



****



#### ç±»é€‚é…å™¨

å®ç°æ–¹å¼ï¼šå®šä¹‰ä¸€ä¸ªé€‚é…å™¨ç±»æ¥å®ç°å½“å‰ç³»ç»Ÿçš„ä¸šåŠ¡æ¥å£ï¼ŒåŒæ—¶åˆç»§æ‰¿ç°æœ‰ç»„ä»¶åº“ä¸­å·²ç»å­˜åœ¨çš„ç»„ä»¶

ä¾‹å¦‚ï¼šç°æœ‰ä¸€å°ç”µè„‘åªèƒ½è¯»å– SD å¡ï¼Œè€Œè¦è¯»å– TF å¡ä¸­çš„å†…å®¹çš„è¯å°±éœ€è¦ä½¿ç”¨åˆ°é€‚é…å™¨æ¨¡å¼

* SDå¡ï¼š

  ```java
  //æ¥å£
  public interface SDCard {
      //è¯»å–SDå¡æ–¹æ³•
      String readSD();
      //å†™å…¥SDå¡åŠŸèƒ½
      void writeSD(String msg);
  }
  //å®ç°ç±»
  public class SDCardImpl implements SDCard {
      public String readSD() {
          String msg = "sd card read a msg :hello word SD";
          return msg;
      }
      public void writeSD(String msg) {
          System.out.println("sd card write msg : " + msg);
      }
  }
  ```

* ç”µè„‘ç±»ï¼š

  ```java
  public class Computer {
      public String readSD(SDCard sdCard) {
          if(sdCard == null) {
              throw new NullPointerException("sd card null");
          }
          return sdCard.readSD();
      }
  }
  ```

* TFå¡ï¼š

  ```java
  //æ¥å£
  public interface TFCard {
      //è¯»å–TFå¡æ–¹æ³•
      String readTF();
      //å†™å…¥TFå¡åŠŸèƒ½
      void writeTF(String msg);
  }
  //å®ç°ç±»
  public class TFCardImpl implements TFCard {
      public String readTF() {
          String msg ="tf card read msg : hello word tf card";
          return msg;
      }
      public void writeTF(String msg) {
          System.out.println("tf card write a msg : " + msg);
      }
  }
  ```

* å®šä¹‰é€‚é…å™¨ç±»ï¼ˆSDå…¼å®¹TFï¼‰ï¼š

  ```java
  public class SDAdapterTF extends TFCardImpl implements SDCard {
      public String readSD() {
          System.out.println("adapter read tf card ");
          return readTF();
      }
  
      public void writeSD(String msg) {
          System.out.println("adapter write tf card");
          writeTF(msg);
      }
  }
  ```

* æµ‹è¯•ç±»ï¼Œå¯ä»¥è¯»å– TF å¡ä¸­çš„æ•°æ®äº†ï¼š

  ```java
  public static void main(String[] args) {
      Computer computer = new Computer();
      SDAdapterTF adapter = new SDAdapterTF();
      System.out.println(computer.readSD(adapter));
  }
  ```

ç±»é€‚é…å™¨æ¨¡å¼è¿èƒŒäº†åˆæˆå¤ç”¨åŸåˆ™ï¼Œç±»é€‚é…å™¨æ˜¯å®¢æˆ·ç±»æœ‰ä¸€ä¸ªæ¥å£è§„èŒƒçš„æƒ…å†µä¸‹å¯ç”¨ï¼Œåä¹‹ä¸å¯ç”¨



***



#### å¯¹è±¡é€‚é…

å¯¹è±¡é€‚é…å™¨æ¨¡å¼å¯é‡†ç”¨å°†ç°æœ‰ç»„ä»¶åº“ä¸­å·²ç»å®ç°çš„ç»„ä»¶å¼•å…¥é€‚é…å™¨ç±»ä¸­ï¼Œè¯¥ç±»åŒæ—¶å®ç°å½“å‰ç³»ç»Ÿçš„ä¸šåŠ¡æ¥å£

ä½¿ç”¨å¯¹è±¡é€‚é…å™¨æ¨¡å¼å°†è¯»å¡å™¨çš„æ¡ˆä¾‹è¿›è¡Œæ”¹å†™ï¼š

* é€‚é…å™¨ç±»ï¼š

  ```java
  public class SDAdapterTF  implements SDCard {
      private TFCard tfCard;
      public SDAdapterTF(TFCard tfCard) {
          this.tfCard = tfCard;
      }
      
      public String readSD() {
          System.out.println("adapter read tf card ");
          return tfCard.readTF();
      }
      
      public void writeSD(String msg) {
          System.out.println("adapter write tf card");
          tfCard.writeTF(msg);
      }
  }
  ```



***



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* å¼€å‘çš„ç³»ç»Ÿå­˜åœ¨æ»¡è¶³æ–°ç³»ç»ŸåŠŸèƒ½éœ€æ±‚çš„ç±»ï¼Œä½†å…¶æ¥å£åŒæ–°ç³»ç»Ÿçš„æ¥å£ä¸ä¸€è‡´
* ä½¿ç”¨ç¬¬ä¸‰æ–¹æä¾›çš„ç»„ä»¶ï¼Œä½†ç»„ä»¶æ¥å£å®šä¹‰å’Œè‡ªå·±è¦æ±‚çš„æ¥å£å®šä¹‰ä¸åŒ



##### æºç åº”ç”¨

Readerï¼ˆå­—ç¬¦æµï¼‰ã€InputStreamï¼ˆå­—èŠ‚æµï¼‰çš„é€‚é…ä½¿ç”¨çš„æ˜¯InputStreamReader

```java
public int read() throws IOException {
    return sd.read();// sd StreamDecoder
}
```

StreamDecoder ç”¨æ¥ç¼–ç è§£ç ï¼Œç¼–ç ï¼šå­—ç¬¦è½¬ä¸ºå­—èŠ‚ï¼›è§£ç ï¼šå­—èŠ‚è½¬å­—ç¬¦

<img src="https://gitee.com/seazean/images/raw/master/Java/é€‚é…å™¨æ¨¡å¼-å­—ç¬¦æµä¸å­—èŠ‚æµæºç è§£æ.png" style="zoom:80%;" />



****



### è£…é¥°è€…

#### åŸºæœ¬ä»‹ç»

è£…é¥°è€…æ¨¡å¼ï¼šæŒ‡åœ¨ä¸æ”¹å˜ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™è¯¥å¯¹è±¡å¢åŠ ä¸€äº›èŒè´£ï¼ˆå³å¢åŠ å…¶é¢å¤–åŠŸèƒ½ï¼‰çš„æ¨¡å¼

ä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼å­˜åœ¨çš„é—®é¢˜ï¼šæ‰©å±•æ€§ä¸å¥½ã€äº§ç”Ÿè¿‡å¤šçš„å­ç±»

è£…é¥°ï¼ˆDecoratorï¼‰æ¨¡å¼ä¸­çš„è§’è‰²ï¼š

* æŠ½è±¡æ„ä»¶ï¼ˆComponentï¼‰è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥æ”¶é™„åŠ è´£ä»»çš„å¯¹è±¡
* å…·ä½“æ„ä»¶ï¼ˆConcrete  Componentï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡æ„ä»¶ï¼Œé€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£
* æŠ½è±¡è£…é¥°ï¼ˆDecoratorï¼‰è§’è‰²ï¼šç»§æ‰¿æˆ–å®ç°æŠ½è±¡æ„ä»¶ï¼Œå¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½
* å…·ä½“è£…é¥°ï¼ˆConcreteDecoratorï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»




***



#### ä»£ç å®ç°

å¯¹å¿«é¤è¿›è¡Œè£…é¥°ï¼Œå¢åŠ é¸¡è›‹æˆ–è€…åŸ¹æ ¹

* å¿«é¤ç±»ï¼š

  ```java
  public abstract class FastFood {
      private float price;
      private String desc;
  	// set + get
      public abstract float cost();  //è·å–ä»·æ ¼
  }
  
  //ç‚’é¥­
  public class FriedRice extends FastFood {
      public FriedRice() {
          super(10, "ç‚’é¥­");
      }
      public float cost() {
          return getPrice();
      }
  }
  ```

* é…æ–™ç±»ï¼š

  ```java
  public abstract class Garnish extends FastFood {
      private FastFood fastFood;
      //get + set 
      
      public Garnish(FastFood fastFood, float price, String desc) {
          super(price,desc);
          this.fastFood = fastFood;
      }
  }
  //é¸¡è›‹é…æ–™
  public class Egg extends Garnish {
      public Egg(FastFood fastFood) {
          super(fastFood, 1, "é¸¡è›‹");
      }
      public float cost() {
          return getPrice() + getFastFood().getPrice();
      }
      @Override
      public String getDesc() {
          return super.getDesc() + getFastFood().getDesc();
      }
  }
  //åŸ¹æ ¹é…æ–™
  public class Bacon extends Garnish {
      public Bacon(FastFood fastFood) {
          super(fastFood, 2, "åŸ¹æ ¹");
      }
      @Override
      public float cost() {
          return getPrice() + getFastFood().getPrice();
      }
      @Override
      public String getDesc() {
          return super.getDesc() + getFastFood().getDesc();
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class Client {
      public static void main(String[] args) {
          //ç‚¹ä¸€ä»½ç‚’é¥­
          FastFood food = new FriedRice();
          //èŠ±è´¹çš„ä»·æ ¼
          System.out.println(food.getDesc() + " " + food.cost() + "å…ƒ");
  
          System.out.println("========");
          //ç‚¹ä¸€ä»½åŠ é¸¡è›‹çš„ç‚’é¥­
          FastFood food1 = new FriedRice();
          food1 = new Egg(food1);
          //èŠ±è´¹çš„ä»·æ ¼
          System.out.println(food1.getDesc() + " " + food1.cost() + "å…ƒ");
      }
  }
  ```



****



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* å½“ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æ–¹å¼å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……æˆ–è€…é‡‡ç”¨ç»§æ‰¿ä¸åˆ©äºç³»ç»Ÿæ‰©å±•å’Œç»´æŠ¤æ—¶

  ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç±»ï¼š

  * ç¬¬ä¸€ç±»æ˜¯ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡ç‹¬ç«‹çš„æ‰©å±•ï¼Œä¸ºæ”¯æŒæ¯ä¸€ç§ç»„åˆå°†äº§ç”Ÿå¤§é‡çš„å­ç±»ï¼Œä½¿å¾—å­ç±»æ•°ç›®å¢é•¿å¾ˆå¤š
  * ç¬¬äºŒç±»æ˜¯å› ä¸ºç±»å®šä¹‰ä¸èƒ½ç»§æ‰¿ï¼ˆå¦‚finalç±»ï¼‰

* åœ¨ä¸å½±å“å…¶ä»–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä»¥åŠ¨æ€ã€é€æ˜çš„æ–¹å¼ç»™å•ä¸ªå¯¹è±¡æ·»åŠ èŒè´£

  å½“å¯¹è±¡çš„åŠŸèƒ½è¦æ±‚å¯ä»¥åŠ¨æ€åœ°æ·»åŠ ï¼Œä¹Ÿå¯ä»¥å†åŠ¨æ€åœ°æ’¤é”€æ—¶



##### æºç åº”ç”¨

IOæµä¸­çš„åŒ…è£…ç±»ä½¿ç”¨åˆ°äº†è£…é¥°è€…æ¨¡å¼ï¼ŒBufferedInputStreamï¼ŒBufferedOutputStreamï¼ŒBufferedReaderï¼ŒBufferedWriter

ä¸¾ä¾‹ï¼š

```java
public class Demo {
    public static void main(String[] args) throws Exception{
        //åˆ›å»ºFileWriterå¯¹è±¡
        FileWriter fw = new FileWriter("C:\\Users\\Think\\Desktop\\a.txt");
        //åˆ›å»ºBufferedWriterå¯¹è±¡
        BufferedWriter bw = new BufferedWriter(fw);
        //å†™æ•°æ®
        bw.write("hello Buffered");
        bw.close();
    }
}
```

<img src="https://gitee.com/seazean/images/raw/master/Java/è£…é¥°è€…æ¨¡å¼-ç¼“å†²æµæºç .png" style="zoom:67%;" />

â€‹	BufferedWriter ä½¿ç”¨è£…é¥°è€…æ¨¡å¼å¯¹ Writer å­å®ç°ç±»è¿›è¡Œäº†å¢å¼ºï¼Œæ·»åŠ äº†ç¼“å†²åŒºï¼Œæé«˜äº†è¯»å†™æ•°æ®çš„æ•ˆç‡



***



#### æ¨¡å¼å¯¹æ¯”

é™æ€ä»£ç†å’Œè£…é¥°è€…æ¨¡å¼çš„åŒºåˆ«ï¼š

* ç›¸åŒç‚¹ï¼š
  * éƒ½è¦å®ç°ä¸ç›®æ ‡ç±»ç›¸åŒçš„ä¸šåŠ¡æ¥å£
  * åœ¨ä¸¤ä¸ªç±»ä¸­éƒ½è¦å£°æ˜ç›®æ ‡å¯¹è±¡
  * éƒ½å¯ä»¥åœ¨ä¸ä¿®æ”¹ç›®æ ‡ç±»çš„å‰æä¸‹å¢å¼ºç›®æ ‡æ–¹æ³•
* ä¸åŒç‚¹ï¼š
  * ç›®çš„ä¸åŒï¼šè£…é¥°è€…æ˜¯ä¸ºäº†å¢å¼ºç›®æ ‡å¯¹è±¡ï¼Œé™æ€ä»£ç†æ˜¯ä¸ºäº†ä¿æŠ¤å’Œéšè—ç›®æ ‡å¯¹è±¡
  * è·å–ç›®æ ‡å¯¹è±¡æ„å»ºçš„åœ°æ–¹ä¸åŒï¼šè£…é¥°è€…æ˜¯ç”±å¤–ç•Œä¼ é€’è¿›æ¥ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•ä¼ é€’ï¼›é™æ€ä»£ç†æ˜¯åœ¨ä»£ç†ç±»å†…éƒ¨åˆ›å»ºï¼Œä»¥æ­¤æ¥éšè—ç›®æ ‡å¯¹è±¡



***



### æ¡¥æ¥æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

æ¡¥æ¥æ¨¡å¼ï¼šå°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ï¼Œç”¨ç»„åˆå…³ç³»ä»£æ›¿ç»§æ‰¿å…³ç³»å®ç°ï¼Œä»è€Œé™ä½äº†æŠ½è±¡å’Œå®ç°è¿™ä¸¤ä¸ªå¯å˜ç»´åº¦çš„è€¦åˆåº¦

æ¡¥æ¥ï¼ˆBridgeï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡åŒ–ï¼ˆAbstractionï¼‰è§’è‰² ï¼šå®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨
* æ‰©å±•æŠ½è±¡åŒ–ï¼ˆRefined  Abstractionï¼‰è§’è‰² ï¼šæ˜¯æŠ½è±¡åŒ–è§’è‰²çš„å­ç±»ï¼Œå®ç°çˆ¶ç±»ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå¹¶é€šè¿‡ç»„åˆå…³ç³»è°ƒç”¨å®ç°åŒ–è§’è‰²ä¸­çš„ä¸šåŠ¡æ–¹æ³•
* å®ç°åŒ–ï¼ˆImplementorï¼‰è§’è‰² ï¼šå®šä¹‰å®ç°åŒ–è§’è‰²çš„æ¥å£ï¼Œä¾›æ‰©å±•æŠ½è±¡åŒ–è§’è‰²è°ƒç”¨
* å…·ä½“å®ç°åŒ–ï¼ˆConcrete Implementorï¼‰è§’è‰² ï¼šç»™å‡ºå®ç°åŒ–è§’è‰²æ¥å£çš„å…·ä½“å®ç°

åº”ç”¨åœºæ™¯ï¼š

* å½“ä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œä¸”è¿™ä¸¤ä¸ªç»´åº¦éƒ½éœ€è¦è¿›è¡Œæ‰©å±•æ—¶
* å½“ä¸€ä¸ªç³»ç»Ÿä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿æˆ–å› ä¸ºå¤šå±‚æ¬¡ç»§æ‰¿å¯¼è‡´ç³»ç»Ÿç±»çš„æ•°é‡å¢åŠ æ—¶
* å½“ä¸€ä¸ªç³»ç»Ÿéœ€è¦åœ¨æ„ä»¶çš„æŠ½è±¡åŒ–è§’è‰²å’Œå…·ä½“åŒ–è§’è‰²ä¹‹é—´å¢åŠ æ›´å¤šçš„çµæ´»æ€§æ—¶ï¼Œé¿å…åœ¨ä¸¤ä¸ªå±‚æ¬¡ä¹‹é—´å»ºç«‹é™æ€çš„ç»§æ‰¿è”ç³»ï¼Œé€šè¿‡æ¡¥æ¥æ¨¡å¼å¯ä»¥ä½¿å®ƒä»¬åœ¨æŠ½è±¡å±‚å»ºç«‹ä¸€ä¸ªå…³è”å…³ç³»

ä¼˜ç‚¹ï¼šæ¡¥æ¥æ¨¡å¼æé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å……æ€§ï¼Œåœ¨ä¸¤ä¸ªå˜åŒ–ç»´åº¦ä¸­ä»»æ„æ‰©å±•ä¸€ä¸ªç»´åº¦ï¼Œéƒ½ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ç³»ç»Ÿã€‚å¦‚æœç°åœ¨è¿˜æœ‰ä¸€ç§è§†é¢‘æ–‡ä»¶ç±»å‹ wmvï¼Œåªéœ€å†å®šä¹‰ä¸€ä¸ªç±»å®ç° VideoFile æ¥å£å³å¯ï¼Œå…¶ä»–ç±»ä¸éœ€è¦å‘ç”Ÿå˜åŒ–



***



#### ä»£ç å®ç°

å¼€å‘ä¸€ä¸ªè·¨å¹³å°è§†é¢‘æ’­æ”¾å™¨ï¼Œå¯ä»¥åœ¨ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ï¼ˆå¦‚Windowsã€Macã€Linuxç­‰ï¼‰ä¸Šæ’­æ”¾å¤šç§æ ¼å¼çš„è§†é¢‘æ–‡ä»¶ï¼Œå¸¸è§çš„è§†é¢‘æ ¼å¼åŒ…æ‹¬RMVBã€AVIã€WMVç­‰ï¼Œè¯¥æ’­æ”¾å™¨åŒ…å«äº†ä¸¤ä¸ªç»´åº¦ï¼Œé€‚åˆä½¿ç”¨æ¡¥æ¥æ¨¡å¼

* è§†é¢‘æ–‡ä»¶ç±»ï¼š

  ```java
  //è§†é¢‘æ–‡ä»¶
  public interface VideoFile {
      void decode(String fileName);
  }
  
  //aviæ–‡ä»¶
  public class AVIFile implements VideoFile {
      public void decode(String fileName) {
          System.out.println("aviè§†é¢‘æ–‡ä»¶:" + fileName);
      }
  }
  
  //rmvbæ–‡ä»¶
  public class REVBBFile implements VideoFile {
      public void decode(String fileName) {
          System.out.println("rmvbæ–‡ä»¶:" + fileName);
      }
  }
  ```

* æ“ä½œç³»ç»Ÿç±»ï¼š

  ```java
  //æ“ä½œç³»ç»Ÿç‰ˆæœ¬
  public abstract class OperatingSystemVersion {
      protected VideoFile videoFile;
  
      public OperatingSystemVersion(VideoFile videoFile) {
          this.videoFile = videoFile;
      }
      
      public abstract void play(String fileName);
  }
  
  //Windowsç‰ˆæœ¬
  public class Windows extends OperatingSystem {
      public Windows(VideoFile videoFile) {
          super(videoFile);
      }
      public void play(String fileName) {
          videoFile.decode(fileName);
      }
  }
  
  //macç‰ˆæœ¬
  public class Mac extends OperatingSystemVersion {
      public Mac(VideoFile videoFile) {
          super(videoFile);
      }
      public void play(String fileName) {
  		videoFile.decode(fileName);
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public class Client {
      public static void main(String[] args) {
          OperatingSystem os = new Windows(new AVIFile());
          os.play("The Godfather");
      }
  }
  ```





***



### å¤–è§‚æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

å¤–è§‚æ¨¡å¼ï¼šåˆåé—¨é¢æ¨¡å¼ï¼Œæ˜¯ä¸€ç§é€šè¿‡ä¸ºå¤šä¸ªå¤æ‚çš„å­ç³»ç»Ÿæä¾›ä¸€ä¸ªä¸€è‡´çš„æ¥å£ï¼Œè€Œä½¿è¿™äº›å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“è¢«è®¿é—®çš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼å¯¹å¤–æœ‰ä¸€ä¸ªç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨åº”ç”¨ç¨‹åºä¸ç”¨å…³å¿ƒå†…éƒ¨å­ç³»ç»Ÿçš„å…·ä½“çš„ç»†èŠ‚ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„å¤æ‚åº¦ï¼Œæé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§ï¼Œæ˜¯â€œè¿ªç±³ç‰¹æ³•åˆ™â€çš„å…¸å‹åº”ç”¨

å¤–è§‚ï¼ˆFacadeï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* å¤–è§‚ï¼ˆFacadeï¼‰è§’è‰²ï¼šä¸ºå¤šä¸ªå­ç³»ç»Ÿå¯¹å¤–æä¾›ä¸€ä¸ªå…±åŒçš„æ¥å£
* å­ç³»ç»Ÿï¼ˆSub Systemï¼‰è§’è‰²ï¼šå®ç°ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤–è§‚è§’è‰²è®¿é—®å®ƒ

æ¨¡å¼ä¼˜ç‚¹ï¼š

* é™ä½äº†å­ç³»ç»Ÿä¸å®¢æˆ·ç«¯ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä½¿å¾—å­ç³»ç»Ÿçš„å˜åŒ–ä¸ä¼šå½±å“è°ƒç”¨å®ƒçš„å®¢æˆ·ç±»
* å¯¹å®¢æˆ·å±è”½äº†å­ç³»ç»Ÿç»„ä»¶ï¼Œå‡å°‘äº†å®¢æˆ·å¤„ç†çš„å¯¹è±¡æ•°ç›®ï¼Œå¹¶ä½¿å¾—å­ç³»ç»Ÿä½¿ç”¨èµ·æ¥æ›´åŠ å®¹æ˜“

æ¨¡å¼ç¼ºç‚¹ï¼šä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œä¿®æ”¹å¾ˆéº»çƒ¦



***



#### ä»£ç å®ç°

æ™ºèƒ½å®¶ç”µæ§åˆ¶ï¼Œä¸€é”®å…³é—­æˆ–è€…å¼€å¯æ‰€æœ‰å®¶ç”µ

* å­ç³»ç»Ÿè§’è‰²ï¼š

  ```java
  //ç¯ç±»
  public class Light {
      public void on() {
          System.out.println("æ‰“å¼€äº†ç¯....");
      }
      public void off() {
          System.out.println("å…³é—­äº†ç¯....");
      }
  }
  //ç”µè§†ç±»
  public class TV {
      public void on() {
          System.out.println("æ‰“å¼€äº†ç”µè§†....");
      }
  
      public void off() {
          System.out.println("å…³é—­äº†ç”µè§†....");
      }
  }
  //ç©ºè°ƒç±»
  public class AirCondition {
      public void on() {
          System.out.println("æ‰“å¼€äº†ç©ºè°ƒ....");
      }
      public void off() {
          System.out.println("å…³é—­äº†ç©ºè°ƒ....");
      }
  }
  ```

* å¤–è§‚è§’è‰²ï¼š

  ```java
  //æ™ºèƒ½éŸ³ç®±
  public class SmartAppliancesFacade {
      private Light light;
      private TV tv;
      private AirCondition airCondition;
  
      public SmartAppliancesFacade() {
          light = new Light();
          tv = new TV();
          airCondition = new AirCondition();
      }
  
      public void say(String message) {
          if(message.contains("æ‰“å¼€")) {
              on();
          } else if(message.contains("å…³é—­")) {
              off();
          } else {
              System.out.println("æˆ‘è¿˜å¬ä¸æ‡‚ä½ è¯´çš„ï¼ï¼ï¼");
          }
      }
  
      //èµ·åºŠåä¸€é”®å¼€ç”µå™¨
      private void on() {
          System.out.println("èµ·åºŠäº†");
          light.on();
          tv.on();
          airCondition.on();
      }
  
      //ç¡è§‰ä¸€é”®å…³ç”µå™¨
      private void off() {
          System.out.println("ç¡è§‰äº†");
          light.off();
          tv.off();
          airCondition.off();
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //åˆ›å»ºå¤–è§‚å¯¹è±¡
      SmartAppliancesFacade facade = new SmartAppliancesFacade();
      //å®¢æˆ·ç«¯ç›´æ¥ä¸å¤–è§‚å¯¹è±¡è¿›è¡Œäº¤äº’
      facade.say("æ‰“å¼€å®¶ç”µ");
      facade.say("å…³é—­å®¶ç”µ");
  }
  ```



***



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* å¯¹åˆ†å±‚ç»“æ„ç³»ç»Ÿæ„å»ºæ—¶ï¼Œä½¿ç”¨å¤–è§‚æ¨¡å¼å®šä¹‰å­ç³»ç»Ÿä¸­æ¯å±‚çš„å…¥å£ç‚¹å¯ä»¥ç®€åŒ–å­ç³»ç»Ÿä¹‹é—´çš„ä¾èµ–å…³ç³»
* å½“ä¸€ä¸ªå¤æ‚ç³»ç»Ÿçš„å­ç³»ç»Ÿå¾ˆå¤šæ—¶ï¼Œå¤–è§‚æ¨¡å¼å¯ä»¥ä¸ºç³»ç»Ÿè®¾è®¡ä¸€ä¸ªç®€å•çš„æ¥å£ä¾›å¤–ç•Œè®¿é—®
* å½“å®¢æˆ·ç«¯ä¸å¤šä¸ªå­ç³»ç»Ÿä¹‹é—´å­˜åœ¨å¾ˆå¤§çš„è”ç³»æ—¶ï¼Œå¼•å…¥å¤–è§‚æ¨¡å¼å¯å°†å®ƒä»¬åˆ†ç¦»ï¼Œä»è€Œæé«˜å­ç³»ç»Ÿçš„ç‹¬ç«‹æ€§å’Œå¯ç§»æ¤æ€§



##### æºç åº”ç”¨

RequestFacade ç±»ä½¿ç”¨äº†å¤–è§‚æ¨¡å¼

<img src="https://gitee.com/seazean/images/raw/master/Java/å¤–è§‚æ¨¡å¼-Servletæºç è§£æ.png" style="zoom:67%;" />

å®šä¹‰ RequestFacade ç±»ï¼Œåˆ†åˆ«å®ç° ServletRequest ï¼ŒåŒæ—¶å®šä¹‰ç§æœ‰æˆå‘˜å˜é‡ Requestï¼Œå¹¶ä¸”æ–¹æ³•çš„å®ç°è°ƒç”¨ Request  çš„å®ç°ã€‚ç„¶åå°† RequestFacade ä¸Šè½¬ä¸º ServletRequest  ä¼ ç»™ servlet çš„ service æ–¹æ³•ï¼Œè¿™æ ·å³ä½¿åœ¨ servlet ä¸­è¢«ä¸‹è½¬ä¸º RequestFacade ï¼Œä¹Ÿä¸èƒ½è®¿é—®ç§æœ‰æˆå‘˜å˜é‡å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚æ—¢ç”¨äº† Request åˆèƒ½é˜²æ­¢å…¶ä¸­æ–¹æ³•è¢«ä¸åˆç†çš„è®¿é—®



***



### ç»„åˆæ¨¡å¼

#### åŸºæœ¬ä»‹ç»

ç»„åˆæ¨¡å¼ï¼šéƒ¨åˆ†æ•´ä½“æ¨¡å¼ï¼Œç”¨äºæŠŠä¸€ç»„ç›¸ä¼¼çš„å¯¹è±¡å½“ä½œä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ï¼Œç»„åˆæ¨¡å¼ä¾æ®æ ‘å½¢ç»“æ„æ¥ç»„åˆå¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºéƒ¨åˆ†ä»¥åŠæ•´ä½“å±‚æ¬¡ï¼Œåˆ›å»ºäº†å¯¹è±¡ç»„çš„æ ‘å½¢ç»“æ„ï¼Œç±»æ¯” Linux æ ‘å½¢æ–‡ä»¶å›¾

ç»„åˆæ¨¡å¼ä¸»è¦åŒ…å«ä¸‰ç§è§’è‰²ï¼š

* æŠ½è±¡æ ¹èŠ‚ç‚¹ï¼ˆComponentï¼‰ï¼šå®šä¹‰ç³»ç»Ÿå„å±‚æ¬¡å¯¹è±¡çš„å…±æœ‰æ–¹æ³•å’Œå±æ€§ï¼Œå¯ä»¥é¢„å…ˆå®šä¹‰ä¸€äº›é»˜è®¤è¡Œä¸ºå’Œå±æ€§
* æ ‘æèŠ‚ç‚¹ï¼ˆCompositeï¼‰ï¼šå®šä¹‰æ ‘æèŠ‚ç‚¹çš„è¡Œä¸ºï¼Œå­˜å‚¨å­èŠ‚ç‚¹ï¼Œç»„åˆæ ‘æèŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹å½¢æˆä¸€ä¸ªæ ‘å½¢ç»“æ„
* å¶å­èŠ‚ç‚¹ï¼ˆLeafï¼‰ï¼šå¶å­èŠ‚ç‚¹å¯¹è±¡ï¼Œå…¶ä¸‹å†æ— åˆ†æ”¯ï¼Œæ˜¯ç³»ç»Ÿå±‚æ¬¡éå†çš„æœ€å°å•ä½

åº”ç”¨åœºæ™¯ï¼šç»„åˆæ¨¡å¼åº”æ ‘å½¢ç»“æ„è€Œç”Ÿï¼Œæ‰€ä»¥ç»„åˆæ¨¡å¼çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯å‡ºç°æ ‘å½¢ç»“æ„çš„åœ°æ–¹ï¼Œæ¯”å¦‚æ–‡ä»¶ç›®å½•æ˜¾ç¤ºï¼Œå¤šçº§ç›®å½•å‘ˆç°ç­‰æ ‘å½¢ç»“æ„æ•°æ®çš„æ“ä½œ

åœ¨ä½¿ç”¨ç»„åˆæ¨¡å¼æ—¶ï¼Œæ ¹æ®æŠ½è±¡æ„ä»¶ç±»çš„å®šä¹‰å½¢å¼ï¼Œå¯å°†ç»„åˆæ¨¡å¼åˆ†ä¸ºé€æ˜ç»„åˆæ¨¡å¼å’Œå®‰å…¨ç»„åˆæ¨¡å¼ä¸¤ç§å½¢å¼ï¼š

* é€æ˜ç»„åˆæ¨¡å¼

  é€æ˜ç»„åˆæ¨¡å¼ä¸­ï¼ŒæŠ½è±¡æ ¹èŠ‚ç‚¹è§’è‰²ä¸­å£°æ˜äº†æ‰€æœ‰ç”¨äºç®¡ç†æˆå‘˜å¯¹è±¡çš„æ–¹æ³•ï¼Œæ¯”å¦‚åœ¨ç¤ºä¾‹ä¸­ `MenuComponent` å£°æ˜äº† `add`ã€`remove` ã€`getChild` æ–¹æ³•ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ç¡®ä¿æ‰€æœ‰çš„æ„ä»¶ç±»éƒ½æœ‰ç›¸åŒçš„æ¥å£ï¼Œé€æ˜ç»„åˆæ¨¡å¼ä¹Ÿæ˜¯ç»„åˆæ¨¡å¼çš„æ ‡å‡†å½¢å¼

  é€æ˜ç»„åˆæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä¸å¤Ÿå®‰å…¨ï¼Œå› ä¸ºå¶å­å¯¹è±¡å’Œå®¹å™¨å¯¹è±¡åœ¨æœ¬è´¨ä¸Šæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¶å­å¯¹è±¡ä¸å¯èƒ½æœ‰ä¸‹ä¸€ä¸ªå±‚æ¬¡çš„å¯¹è±¡ï¼Œå³ä¸å¯èƒ½åŒ…å«æˆå‘˜å¯¹è±¡ï¼Œå› æ­¤ä¸ºå…¶æä¾› add()ã€remove() ç­‰æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™åœ¨ç¼–è¯‘é˜¶æ®µä¸ä¼šå‡ºé”™ï¼Œä½†åœ¨è¿è¡Œé˜¶æ®µå¦‚æœè°ƒç”¨è¿™äº›æ–¹æ³•å¯èƒ½ä¼šå‡ºé”™ï¼ˆå¦‚æœæ²¡æœ‰æä¾›ç›¸åº”çš„é”™è¯¯å¤„ç†ä»£ç ï¼‰

* å®‰å…¨ç»„åˆæ¨¡å¼

  åœ¨å®‰å…¨ç»„åˆæ¨¡å¼ä¸­ï¼Œåœ¨æŠ½è±¡æ„ä»¶è§’è‰²ä¸­æ²¡æœ‰å£°æ˜ä»»ä½•ç”¨äºç®¡ç†æˆå‘˜å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨æ ‘æèŠ‚ç‚¹ `Menu` ç±»ä¸­å£°æ˜å¹¶å®ç°è¿™äº›æ–¹æ³•ã€‚å®‰å…¨ç»„åˆæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä¸å¤Ÿé€æ˜ï¼Œå› ä¸ºå¶å­æ„ä»¶å’Œå®¹å™¨æ„ä»¶å…·æœ‰ä¸åŒçš„æ–¹æ³•ï¼Œä¸”å®¹å™¨æ„ä»¶ä¸­é‚£äº›ç”¨äºç®¡ç†æˆå‘˜å¯¹è±¡çš„æ–¹æ³•æ²¡æœ‰åœ¨æŠ½è±¡æ„ä»¶ç±»ä¸­å®šä¹‰ï¼Œå› æ­¤å®¢æˆ·ç«¯ä¸èƒ½å®Œå…¨é’ˆå¯¹æŠ½è±¡ç¼–ç¨‹ï¼Œå¿…é¡»æœ‰åŒºåˆ«åœ°å¯¹å¾…å¶å­æ„ä»¶å’Œå®¹å™¨æ„ä»¶

ç»„åˆæ¨¡å¼çš„ä¼˜ç‚¹ï¼š

* ç»„åˆæ¨¡å¼å¯ä»¥æ¸…æ¥šåœ°å®šä¹‰åˆ†å±‚æ¬¡çš„å¤æ‚å¯¹è±¡ï¼Œè¡¨ç¤ºå¯¹è±¡çš„å…¨éƒ¨æˆ–éƒ¨åˆ†å±‚æ¬¡ï¼Œè®©å®¢æˆ·ç«¯å¿½ç•¥äº†å±‚æ¬¡çš„å·®å¼‚ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå±‚æ¬¡ç»“æ„è¿›è¡Œæ§åˆ¶
* å®¢æˆ·ç«¯å¯ä»¥ä¸€è‡´åœ°ä½¿ç”¨ä¸€ä¸ªç»„åˆç»“æ„æˆ–å…¶ä¸­å•ä¸ªå¯¹è±¡ï¼Œä¸å¿…å…³å¿ƒå¤„ç†çš„æ˜¯å•ä¸ªå¯¹è±¡è¿˜æ˜¯æ•´ä¸ªç»„åˆç»“æ„ï¼Œç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç 
* åœ¨ç»„åˆæ¨¡å¼ä¸­å¢åŠ æ–°çš„æ ‘æèŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ— é¡»å¯¹ç°æœ‰ç±»åº“è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€
* ç»„åˆæ¨¡å¼ä¸ºæ ‘å½¢ç»“æ„çš„é¢å‘å¯¹è±¡å®ç°æä¾›äº†ä¸€ç§çµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å¶å­èŠ‚ç‚¹å’Œæ ‘æèŠ‚ç‚¹çš„é€’å½’ç»„åˆï¼Œå¯ä»¥å½¢æˆå¤æ‚çš„æ ‘å½¢ç»“æ„ï¼Œä½†å¯¹æ ‘å½¢ç»“æ„çš„æ§åˆ¶å´éå¸¸ç®€å•



***



#### ä»£ç å®ç°

ä¸ç®¡æ˜¯èœå•è¿˜æ˜¯èœå•é¡¹ï¼Œéƒ½åº”è¯¥ç»§æ‰¿è‡ªç»Ÿä¸€çš„æ¥å£ï¼Œå°†è¿™ä¸ªç»Ÿä¸€çš„æ¥å£ç§°ä¸ºèœå•ç»„ä»¶

* èœå•ç»„ä»¶ï¼š

  MenuComponent å®šä¹‰ä¸ºæŠ½è±¡ç±»ï¼Œæœ‰ä¸€äº›å…±æœ‰çš„å±æ€§å’Œè¡Œä¸ºè¦åœ¨è¯¥ç±»ä¸­å®ç°ï¼Œå…¶ä»–ç±»å°±å¯ä»¥åªè¦†ç›–è‡ªå·±éœ€è¦çš„æ–¹æ³•ã€‚è¿™é‡Œç»™å‡ºçš„é»˜è®¤å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ”¹å†™é»˜è®¤å®ç°

  ```java
  public abstract class MenuComponent {
      protected String name;
      protected int level;	//å±‚çº§ å‡ çº§èœå•
  
      //æ·»åŠ èœå•
      public void add(MenuComponent menuComponent){
          throw new UnsupportedOperationException();
      }
  
      //ç§»é™¤èœå•
      public void remove(MenuComponent menuComponent){
          throw new UnsupportedOperationException();
      }
  
      //è·å–æŒ‡å®šçš„å­èœå•
      public MenuComponent getChild(int i){
          throw new UnsupportedOperationException();
      }
  
      //è·å–èœå•åç§°
      public String getName(){
          return name;
      }
  
      public void print(){
          throw new UnsupportedOperationException();
      }
  }
  ```

* èœå•ï¼š

  Menu ç±»å…·æœ‰æ·»åŠ èœå•ï¼Œç§»é™¤èœå•å’Œè·å–å­èœå•çš„åŠŸèƒ½

  ```java
  public class Menu extends MenuComponent {
      private List<MenuComponent> menuComponentList;
  
      public Menu(String name,int level){
          this.level = level;
          this.name = name;
          menuComponentList = new ArrayList<MenuComponent>();
      }
  
      @Override
      public void add(MenuComponent menuComponent) {
          menuComponentList.add(menuComponent);
      }
  
      @Override
      public void remove(MenuComponent menuComponent) {
          menuComponentList.remove(menuComponent);
      }
  
      @Override
      public MenuComponent getChild(int i) {
          return menuComponentList.get(i);
      }
  
      @Override
      public void print() {
          for (int i = 1; i < level; i++) {
              System.out.print("--");
          }
          System.out.println(name);
          for (MenuComponent menuComponent : menuComponentList) {
              menuComponent.print();
          }
      }
  }
  ```

* èœå•é¡¹ï¼š

  MenuItem æ˜¯èœå•é¡¹ï¼Œä¸èƒ½å†æœ‰å­èœå•ï¼Œæ‰€ä»¥æ·»åŠ èœå•ï¼Œç§»é™¤èœå•å’Œè·å–å­èœå•çš„åŠŸèƒ½å¹¶ä¸èƒ½å®ç°

  ```java
  public class MenuItem extends MenuComponent {
      public MenuItem(String name, int level) {
          this.name = name;
          this.level = level;
      }
  
      @Override
      public void print() {
          for (int i = 1; i < level; i++) {
              System.out.print("--");
          }
          System.out.println(name);
      }
  }
  ```



***



### äº«å…ƒæ¨¡å¼

#### åŸºæœ¬ä»‹ç»

äº«å…ƒæ¨¡å¼ï¼šè¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ï¼Œå…±äº«å·²ç»å­˜åœ¨çš„å¯¹è±¡æ¥å¤§å¹…åº¦å‡å°‘å¤§é‡ç›¸ä¼¼å¯¹è±¡çš„å¼€é”€ï¼Œä»è€Œæé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡

äº«å…ƒï¼ˆFlyweight ï¼‰æ¨¡å¼ä¸­å­˜åœ¨ä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š

* å†…éƒ¨çŠ¶æ€ï¼Œä¸ä¼šéšç€ç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜çš„å¯å…±äº«éƒ¨åˆ†
* å¤–éƒ¨çŠ¶æ€ï¼Œéšç€ç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„ä¸å¯ä»¥å…±äº«çš„éƒ¨åˆ†ï¼Œäº«å…ƒæ¨¡å¼çš„å®ç°è¦é¢†å°±æ˜¯åŒºåˆ†åº”ç”¨ä¸­çš„è¿™ä¸¤ç§çŠ¶æ€ï¼Œå¹¶å°†å¤–éƒ¨çŠ¶æ€å¤–éƒ¨åŒ–

äº«å…ƒæ¨¡å¼çš„ä¸»è¦æœ‰ä»¥ä¸‹è§’è‰²ï¼š

* æŠ½è±¡äº«å…ƒè§’è‰²ï¼ˆFlyweightï¼‰ï¼šé€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œåœ¨æŠ½è±¡äº«å…ƒç±»ä¸­å£°æ˜å…·ä½“äº«å…ƒç±»å…¬å…±çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥å‘å¤–ç•Œæä¾›äº«å…ƒå¯¹è±¡çš„å†…éƒ¨æ•°æ®ï¼ˆå†…éƒ¨çŠ¶æ€ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™äº›æ–¹æ³•æ¥è®¾ç½®å¤–éƒ¨æ•°æ®ï¼ˆå¤–éƒ¨çŠ¶æ€ï¼‰
* å…·ä½“äº«å…ƒï¼ˆConcrete Flyweightï¼‰è§’è‰² ï¼šå®ç°äº†æŠ½è±¡äº«å…ƒç±»ï¼Œç§°ä¸ºäº«å…ƒå¯¹è±¡ï¼Œåœ¨å…·ä½“äº«å…ƒç±»ä¸­ä¸ºå†…éƒ¨çŠ¶æ€æä¾›äº†å­˜å‚¨ç©ºé—´ã€‚é€šå¸¸ç»“åˆå•ä¾‹æ¨¡å¼æ¥è®¾è®¡å…·ä½“äº«å…ƒç±»ï¼Œä¸ºæ¯ä¸€ä¸ªå…·ä½“äº«å…ƒç±»æä¾›å”¯ä¸€çš„äº«å…ƒå¯¹è±¡
* éäº«å…ƒï¼ˆUnsharable Flyweightï¼‰è§’è‰² ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„æŠ½è±¡äº«å…ƒç±»çš„å­ç±»éƒ½éœ€è¦è¢«å…±äº«ï¼Œä¸èƒ½è¢«å…±äº«çš„å­ç±»å¯è®¾è®¡ä¸ºéå…±äº«å…·ä½“äº«å…ƒç±»ï¼Œå½“éœ€è¦ä¸€ä¸ªéå…±äº«å…·ä½“äº«å…ƒç±»çš„å¯¹è±¡æ—¶å¯ä»¥ç›´æ¥é€šè¿‡å®ä¾‹åŒ–åˆ›å»º
* äº«å…ƒå·¥å‚ï¼ˆFlyweight Factoryï¼‰è§’è‰² ï¼šè´Ÿè´£åˆ›å»ºå’Œç®¡ç†äº«å…ƒè§’è‰²ã€‚å½“ç”¨æˆ·è¯·æ±‚ä¸€ä¸ªäº«å…ƒå¯¹è±¡æ—¶ï¼Œäº«å…ƒå·¥å‚æ£€æŸ»ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„äº«å…ƒå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™æä¾›ç»™ç”¨æˆ·ï¼›å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº«å…ƒå¯¹è±¡

æ¨¡å¼ä¼˜ç‚¹ï¼š

- æå¤§å‡å°‘å†…å­˜ä¸­ç›¸ä¼¼æˆ–ç›¸åŒå¯¹è±¡æ•°é‡ï¼ŒèŠ‚çº¦ç³»ç»Ÿèµ„æºï¼Œæä¾›ç³»ç»Ÿæ€§èƒ½
- äº«å…ƒæ¨¡å¼ä¸­çš„å¤–éƒ¨çŠ¶æ€ç›¸å¯¹ç‹¬ç«‹ï¼Œä¸”ä¸å½±å“å†…éƒ¨çŠ¶æ€

æ¨¡å¼ç¼ºç‚¹ï¼šä¸ºäº†ä½¿å¯¹è±¡å¯ä»¥å…±äº«ï¼Œéœ€è¦å°†äº«å…ƒå¯¹è±¡çš„éƒ¨åˆ†çŠ¶æ€å¤–éƒ¨åŒ–ï¼Œåˆ†ç¦»å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ï¼Œä½¿ç¨‹åºé€»è¾‘å¤æ‚



****



#### ä»£ç å®ç°

ä¿„ç½—æ–¯æ–¹å—ï¼Œç±»å›¾ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-äº«å…ƒæ¨¡å¼ä¿„ç½—æ–¯æ–¹å—.png" style="zoom:67%;" />

* æŠ½è±¡äº«å…ƒè§’è‰²ï¼š

  ```java
  public abstract class AbstractBox {
      public abstract String getShape();
  
      public void display(String color) {
          System.out.println("æ–¹å—å½¢çŠ¶ï¼š" + this.getShape() + " é¢œè‰²ï¼š" + color);
      }
  }
  ```

* å…·ä½“äº«å…ƒè§’è‰²ï¼š

  ```java
  public class IBox extends AbstractBox {
      @Override
      public String getShape() {
          return "I";
      }
  }
  public class LBox extends AbstractBox {
      @Override
      public String getShape() {
          return "L";
      }
  }
  public class OBox extends AbstractBox {
      @Override
      public String getShape() {
          return "O";
      }
  }
  ```

* äº«å…ƒå·¥å‚è§’è‰²ï¼š

  ```java
  public class BoxFactory {
      private static HashMap<String, AbstractBox> map;
  
      private BoxFactory() {
          map = new HashMap<String, AbstractBox>();
          AbstractBox iBox = new IBox();
          AbstractBox lBox = new LBox();
          AbstractBox oBox = new OBox();
          map.put("I", iBox);
          map.put("L", lBox);
          map.put("O", oBox);
      }
  
      public static final BoxFactory getInstance() {
          return SingletonHolder.INSTANCE;
      }
      private static class SingletonHolder {
          private static final BoxFactory INSTANCE = new BoxFactory();
      }
      public AbstractBox getBox(String key) {
          return map.get(key);
      }
  }
  ```

  

****



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* ä¸€ä¸ªç³»ç»Ÿæœ‰å¤§é‡ç›¸åŒæˆ–è€…ç›¸ä¼¼çš„å¯¹è±¡ï¼Œé€ æˆå†…å­˜çš„å¤§é‡è€—è´¹
* å¯¹è±¡çš„å¤§éƒ¨åˆ†çŠ¶æ€éƒ½å¯ä»¥å¤–éƒ¨åŒ–ï¼Œå¯ä»¥å°†è¿™äº›å¤–éƒ¨çŠ¶æ€ä¼ å…¥å¯¹è±¡ä¸­
* åœ¨ä½¿ç”¨äº«å…ƒæ¨¡å¼æ—¶éœ€è¦ç»´æŠ¤ä¸€ä¸ªå­˜å‚¨äº«å…ƒå¯¹è±¡çš„äº«å…ƒæ± ï¼Œè€Œè¿™éœ€è¦è€—è´¹ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œåº”å½“åœ¨éœ€è¦å¤šæ¬¡é‡å¤ä½¿ç”¨äº«å…ƒå¯¹è±¡æ—¶æ‰å€¼å¾—ä½¿ç”¨äº«å…ƒæ¨¡å¼



##### æºç åº”ç”¨

Integerç±»ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼ï¼š

```java
public class Demo {
    public static void main(String[] args) {
        Integer i1 = 127;
        Integer i2 = 127;
        System.out.println("i1å’Œi2å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ" + (i1 == i2));//true

        Integer i3 = 128;
        Integer i4 = 128;
        System.out.println("i3å’Œi4å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ" + (i3 == i4));//false
    }
}
```

åç¼–è¯‘åå‘ç°ç›´æ¥ç»™ Integer ç±»å‹çš„å˜é‡èµ‹å€¼åŸºæœ¬æ•°æ®ç±»å‹æ•°æ®çš„æ“ä½œåº•å±‚ä½¿ç”¨çš„æ˜¯ `valueOf()`

`Integer` é»˜è®¤å…ˆåˆ›å»ºå¹¶ç¼“å­˜ `-128 ~ 127` ä¹‹é—´æ•°çš„ `Integer` å¯¹è±¡ï¼Œå½“è°ƒç”¨ `valueOf` æ—¶å¦‚æœå‚æ•°åœ¨ `-128 ~ 127` ä¹‹é—´åˆ™è®¡ç®—ä¸‹æ ‡å¹¶ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ `Integer` å¯¹è±¡





****





## è¡Œä¸ºå‹

### æ¨¡å¼åˆ†ç±»

è¡Œä¸ºå‹æ¨¡å¼ç”¨äºæè¿°ç¨‹åºåœ¨è¿è¡Œæ—¶å¤æ‚çš„æµç¨‹æ§åˆ¶ï¼Œå³æè¿°å¤šä¸ªç±»æˆ–å¯¹è±¡ä¹‹é—´æ€æ ·ç›¸äº’åä½œå…±åŒå®Œæˆå•ä¸ªå¯¹è±¡éƒ½æ— æ³•å•ç‹¬å®Œæˆçš„ä»»åŠ¡ï¼Œæ¶‰åŠç®—æ³•ä¸å¯¹è±¡é—´èŒè´£çš„åˆ†é…

è¡Œä¸ºå‹æ¨¡å¼åˆ†ä¸ºç±»è¡Œä¸ºæ¨¡å¼å’Œå¯¹è±¡è¡Œä¸ºæ¨¡å¼ï¼Œå‰è€…é‡‡ç”¨ç»§æ‰¿æœºåˆ¶æ¥åœ¨ç±»é—´åˆ†æ´¾è¡Œä¸ºï¼Œåè€…é‡‡ç”¨ç»„åˆæˆ–èšåˆåœ¨å¯¹è±¡é—´åˆ†é…è¡Œä¸ºï¼Œç”±äºç»„åˆå…³ç³»æˆ–èšåˆå…³ç³»æ¯”ç»§æ‰¿å…³ç³»è€¦åˆåº¦ä½ï¼Œæ»¡è¶³â€œåˆæˆå¤ç”¨åŸåˆ™â€ï¼Œæ‰€ä»¥å¯¹è±¡è¡Œä¸ºæ¨¡å¼æ¯”ç±»è¡Œä¸ºæ¨¡å¼å…·æœ‰æ›´å¤§çš„çµæ´»æ€§

é™¤äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼å’Œè§£é‡Šå™¨æ¨¡å¼æ˜¯ç±»è¡Œä¸ºå‹æ¨¡å¼ï¼Œå…¶ä»–çš„å…¨éƒ¨å±äºå¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼



***



### æ¨¡æ¿æ–¹æ³•

#### åŸºæœ¬ä»‹ç»

æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè€Œå°†ç®—æ³•çš„ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜è¯¥ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤

æ¨¡æ¿æ–¹æ³•ï¼ˆTemplate Methodï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡ç±»ï¼ˆAbstract Classï¼‰ï¼šè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ï¼Œç”±ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•å’Œè‹¥å¹²ä¸ªåŸºæœ¬æ–¹æ³•æ„æˆ

  * æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼ŒæŒ‰æŸç§é¡ºåºè°ƒç”¨å…¶åŒ…å«çš„åŸºæœ¬æ–¹æ³•

  * åŸºæœ¬æ–¹æ³•ï¼šæ˜¯å®ç°ç®—æ³•å„ä¸ªæ­¥éª¤çš„æ–¹æ³•ï¼Œæ˜¯æ¨¡æ¿æ–¹æ³•çš„ç»„æˆéƒ¨åˆ†ï¼ŒåŸºæœ¬æ–¹æ³•åˆå¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š

    * æŠ½è±¡æ–¹æ³•(Abstract Method)ï¼šä¸€ä¸ªæŠ½è±¡æ–¹æ³•ç”±æŠ½è±¡ç±»å£°æ˜ï¼Œç”±å…¶å…·ä½“å­ç±»å®ç°

    * å…·ä½“æ–¹æ³•(Concrete Method)ï¼šä¸€ä¸ªå…·ä½“æ–¹æ³•ç”±ä¸€ä¸ªæŠ½è±¡ç±»æˆ–å…·ä½“ç±»å£°æ˜å¹¶å®ç°ï¼Œå…¶å­ç±»å¯ä»¥è¿›è¡Œè¦†ç›–ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿

    * é’©å­æ–¹æ³•(Hook Method)ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•å’Œéœ€è¦å­ç±»é‡å†™çš„ç©ºæ–¹æ³•

      ä¸€èˆ¬é’©å­æ–¹æ³•æ˜¯ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•ï¼Œè¿™ç±»æ–¹æ³•åä¸€èˆ¬ä¸ºisXxxï¼Œè¿”å›å€¼ç±»å‹ä¸ºbooleanç±»å‹

* å…·ä½“å­ç±»ï¼ˆConcrete Classï¼‰ï¼šå®ç°æŠ½è±¡ç±»ä¸­æ‰€å®šä¹‰çš„æŠ½è±¡æ–¹æ³•å’Œé’©å­æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªé¡¶çº§é€»è¾‘çš„ç»„æˆæ­¥éª¤

æ¨¡å¼ä¼˜ç‚¹ï¼š

* æé«˜ä»£ç å¤ç”¨æ€§ï¼Œå°†ç›¸åŒéƒ¨åˆ†çš„ä»£ç æ”¾åœ¨æŠ½è±¡çš„çˆ¶ç±»ä¸­ï¼Œè€Œå°†ä¸åŒçš„ä»£ç æ”¾å…¥ä¸åŒçš„å­ç±»ä¸­
* å®ç°åå‘æ§åˆ¶ï¼Œé€šè¿‡ä¸€ä¸ªçˆ¶ç±»è°ƒç”¨å…¶å­ç±»çš„æ“ä½œï¼Œé€šè¿‡å¯¹å­ç±»çš„å…·ä½“å®ç°æ‰©å±•ä¸åŒçš„è¡Œä¸ºï¼Œå®ç°äº†åå‘æ§åˆ¶ï¼Œå¹¶ç¬¦åˆå¼€é—­åŸåˆ™


æ¨¡å¼ç¼ºç‚¹ï¼š

* å¯¹æ¯ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œè¿™ä¼šå¯¼è‡´ç±»çš„ä¸ªæ•°å¢åŠ ï¼Œç³»ç»Ÿæ›´åŠ åºå¤§ï¼Œè®¾è®¡ä¹Ÿæ›´åŠ æŠ½è±¡
* çˆ¶ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ç”±å­ç±»å®ç°ï¼Œå­ç±»æ‰§è¡Œçš„ç»“æœä¼šå½±å“çˆ¶ç±»çš„ç»“æœï¼Œè¿™å¯¼è‡´ä¸€ç§åå‘çš„æ§åˆ¶ç»“æ„ï¼Œæé«˜äº†ä»£ç é˜…è¯»çš„éš¾åº¦



****



#### ä»£ç å®ç°

ç‚’èœæ­¥éª¤æ˜¯å›ºå®šçš„ï¼Œç°é€šè¿‡æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ¥ç”¨ä»£ç æ¨¡æ‹Ÿ

* æŠ½è±¡ç±»ï¼š

  æ³¨æ„ï¼šä¸ºé˜²æ­¢æ¶æ„æ“ä½œï¼Œä¸€èˆ¬æ¨¡æ¿æ–¹æ³•éƒ½åŠ ä¸Š final å…³é”®è¯

  ```java
  public abstract class AbstractClass {
      public final void cookProcess() {
          //ç¬¬ä¸€æ­¥ï¼šå€’æ²¹
          this.pourOil();
          //ç¬¬äºŒæ­¥ï¼šçƒ­æ²¹
          this.heatOil();
          //ç¬¬ä¸‰æ­¥ï¼šå€’è”¬èœ
          this.pourVegetable();
          //ç¬¬å››æ­¥ï¼šå€’è°ƒå‘³æ–™
          this.pourSauce();
          //ç¬¬äº”æ­¥ï¼šç¿»ç‚’
          this.fry();
      }
  	//ç¬¬ä¸€æ­¥ï¼šå€’æ²¹
      public void pourOil() {
          System.out.println("å€’æ²¹");
      }
      //ç¬¬äºŒæ­¥ï¼šçƒ­æ²¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç›´æ¥å®ç°
      public void heatOil() {
          System.out.println("çƒ­æ²¹");
      }
      //ç¬¬ä¸‰æ­¥ï¼šå€’è”¬èœæ˜¯ä¸ä¸€æ ·çš„
      public abstract void pourVegetable();
      //ç¬¬å››æ­¥ï¼šå€’è°ƒå‘³æ–™æ˜¯ä¸ä¸€æ ·
      public abstract void pourSauce();
  
      //ç¬¬äº”æ­¥ï¼šç¿»ç‚’æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç›´æ¥å®ç°
      public void fry(){
          System.out.println("ç‚’å•Šç‚’å•Šç‚’åˆ°ç†Ÿå•Š");
      }
  }
  ```

* å…·ä½“å­ç±»ï¼š

  ```java
  public class ConcreteClass_BaoCai extends AbstractClass {
      @Override
      public void pourVegetable() {
          System.out.println("ä¸‹é”…çš„è”¬èœæ˜¯åŒ…èœ");
      }
  
      @Override
      public void pourSauce() {
          System.out.println("ä¸‹é”…çš„é…±æ–™æ˜¯è¾£æ¤’");
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //ç‚’æ‰‹æ’•åŒ…èœ
      ConcreteClass_BaoCai baoCai = new ConcreteClass_BaoCai();
      baoCai.cookProcess();
  }
  ```

  

***



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* ç®—æ³•çš„æ•´ä½“æ­¥éª¤å¾ˆå›ºå®šï¼Œä½†å…¶ä¸­ä¸ªåˆ«éƒ¨åˆ†æ˜“å˜æ—¶ï¼Œè¿™æ—¶ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°†æ˜“å˜çš„éƒ¨åˆ†æŠ½è±¡å‡ºæ¥ï¼Œä¾›å­ç±»å®ç°
* éœ€è¦é€šè¿‡å­ç±»æ¥å†³å®šçˆ¶ç±»ç®—æ³•ä¸­æŸä¸ªæ­¥éª¤æ˜¯å¦æ‰§è¡Œï¼Œå®ç°å­ç±»å¯¹çˆ¶ç±»çš„åå‘æ§åˆ¶





##### æºç åº”ç”¨

InputStreamç±»å°±ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œåœ¨InputStreamç±»ä¸­å®šä¹‰äº†å¤šä¸ª read() æ–¹æ³•ï¼š

```java
public abstract class InputStream implements Closeable {
    //æŠ½è±¡æ–¹æ³•ï¼Œè¦æ±‚å­ç±»å¿…é¡»é‡å†™
    public abstract int read() throws IOException;
    public int read(byte b[]) throws IOException {...}
    public int read(byte b[], int off, int len) throws IOException {
        //...
        int c = read(); //è°ƒç”¨äº†æ— å‚çš„readæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®
        //...
    }
}
```

åœ¨ InputStream çˆ¶ç±»ä¸­å·²ç»å®šä¹‰å¥½äº†è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°ç»„æ•°æ®çš„æ–¹æ³•æ˜¯æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°æ•°ç»„çš„ç¬¬ä¸€ä¸ªç´¢å¼•ä½ç½®ï¼Œè¯»å– len ä¸ªå­—èŠ‚æ•°æ®ï¼Œå…·ä½“å¦‚ä½•è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®ç”±å­ç±»å®ç°



***



### ç­–ç•¥æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

ç­–ç•¥æ¨¡å¼ï¼šå®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ã€‚ç­–ç•¥æ¨¡å¼å±äºå¯¹è±¡è¡Œä¸ºæ¨¡å¼ï¼Œé€šè¿‡å¯¹ç®—æ³•è¿›è¡Œå°è£…ï¼ŒæŠŠä½¿ç”¨ç®—æ³•å’Œç®—æ³•çš„å®ç°åˆ†å‰²å¼€æ¥ï¼Œå¹¶å§”æ´¾ç»™ä¸åŒçš„å¯¹è±¡å¯¹è¿™äº›ç®—æ³•è¿›è¡Œç®¡ç†

ç­–ç•¥æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š

* æŠ½è±¡ç­–ç•¥ï¼ˆStrategyï¼‰ç±»ï¼šä¸€ä¸ªæŠ½è±¡è§’è‰²ï¼Œé€šå¸¸ç”±ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»å®ç°ï¼Œç»™å‡ºæ‰€æœ‰çš„å…·ä½“ç­–ç•¥ç±»æ‰€éœ€çš„æ¥å£
* å…·ä½“ç­–ç•¥ï¼ˆConcrete Strategyï¼‰ç±»ï¼šå®ç°äº†æŠ½è±¡ç­–ç•¥å®šä¹‰çš„æ¥å£ï¼Œæä¾›å…·ä½“çš„ç®—æ³•å®ç°æˆ–è¡Œä¸º
* ç¯å¢ƒï¼ˆContextï¼‰ç±»ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥ç±»çš„å¼•ç”¨ï¼Œæœ€ç»ˆç»™å®¢æˆ·ç«¯è°ƒç”¨

æ¨¡å¼ä¼˜ç‚¹ï¼š

* ç­–ç•¥ç±»ä¹‹é—´å¯ä»¥è‡ªç”±åˆ‡æ¢ï¼Œç”±äºç­–ç•¥ç±»éƒ½å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä½¿å®ƒä»¬ä¹‹é—´å¯ä»¥è‡ªç”±åˆ‡æ¢
* æ˜“äºæ‰©å±•ï¼Œå¢åŠ ä¸€ä¸ªæ–°çš„ç­–ç•¥åªéœ€è¦æ·»åŠ ä¸€ä¸ªå…·ä½“çš„ç­–ç•¥ç±»ï¼ŒåŸºæœ¬ä¸éœ€è¦æ”¹å˜åŸæœ‰çš„ä»£ç ï¼Œç¬¦åˆå¼€é—­åŸåˆ™
* é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶é€‰æ‹©è¯­å¥ï¼ˆif elseï¼‰ï¼Œå……åˆ†ä½“ç°é¢å‘å¯¹è±¡è®¾è®¡æ€æƒ³

ç¼ºç‚¹ï¼š

* å®¢æˆ·ç«¯å¿…é¡»çŸ¥é“æ‰€æœ‰çš„ç­–ç•¥ç±»ï¼Œå¹¶è‡ªè¡Œå†³å®šä½¿ç”¨å“ªä¸€ä¸ªç­–ç•¥ç±»
* ç­–ç•¥æ¨¡å¼å°†é€ æˆäº§ç”Ÿå¾ˆå¤šç­–ç•¥ç±»ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨äº«å…ƒæ¨¡å¼åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘å¯¹è±¡çš„æ•°é‡



***



#### ä»£ç å®ç°

ä¿ƒé”€æ´»åŠ¨ï¼Œé’ˆå¯¹ä¸åŒçš„èŠ‚æ—¥æ¨å‡ºä¸åŒçš„ä¿ƒé”€æ´»åŠ¨ï¼Œç”±ä¿ƒé”€å‘˜å°†ä¿ƒé”€æ´»åŠ¨å±•ç¤ºç»™å®¢æˆ·

* æŠ½è±¡ç­–ç•¥ç±»ï¼š

  ```java
  public interface Strategy {    
      void show();
  }
  ```

* å…·ä½“ç­–ç•¥ç±»ï¼š

  ```java
  //ä¸ºæ˜¥èŠ‚å‡†å¤‡çš„ä¿ƒé”€æ´»åŠ¨A
  public class StrategyA implements Strategy {
      public void show() {
          System.out.println("ä¹°ä¸€é€ä¸€");
      }
  }
  
  //ä¸ºä¸­ç§‹å‡†å¤‡çš„ä¿ƒé”€æ´»åŠ¨B
  public class StrategyB implements Strategy {
  
      public void show() {
          System.out.println("æ»¡200å…ƒå‡50å…ƒ");
      }
  }
  ```
  
* ç¯å¢ƒç±»ï¼šç”¨äºè¿æ¥ä¸Šä¸‹æ–‡ï¼Œå³æŠŠä¿ƒé”€æ´»åŠ¨æ¨é”€ç»™å®¢æˆ·ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºä¿ƒé”€å‘˜

  ```java
  public class SalesMan {                        
      //æŒæœ‰æŠ½è±¡ç­–ç•¥è§’è‰²çš„å¼•ç”¨                              
      private Strategy strategy;                 
                                   
      public SalesMan(Strategy strategy) {       
          this.strategy = strategy;              
      }                                          
                            
      //å‘å®¢æˆ·å±•ç¤ºä¿ƒé”€æ´»åŠ¨                                
      public void salesManShow(){                
          strategy.show();                       
      }                                          
  }                                              
  ```



***



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* ä¸€ä¸ªç³»ç»Ÿéœ€è¦åŠ¨æ€åœ°åœ¨å‡ ç§ç®—æ³•ä¸­é€‰æ‹©ä¸€ç§æ—¶ï¼Œå¯å°†æ¯ä¸ªç®—æ³•å°è£…åˆ°ç­–ç•¥ç±»ä¸­
* ä¸€ä¸ªç±»å®šä¹‰äº†å¤šç§è¡Œä¸ºï¼Œå¹¶ä¸”è¿™äº›è¡Œä¸ºåœ¨è¿™ä¸ªç±»çš„æ“ä½œä¸­ä»¥å¤šä¸ªæ¡ä»¶è¯­å¥çš„å½¢å¼å‡ºç°ï¼Œå¯å°†æ¯ä¸ªæ¡ä»¶åˆ†æ”¯ç§»å…¥å„è‡ªçš„ç­–ç•¥ç±»ä¸­ä»¥ä»£æ›¿è¿™äº›æ¡ä»¶è¯­å¥
* ç³»ç»Ÿä¸­å„ç®—æ³•å½¼æ­¤å®Œå…¨ç‹¬ç«‹ï¼Œä¸”è¦æ±‚å¯¹å®¢æˆ·éšè—å…·ä½“ç®—æ³•çš„å®ç°ç»†èŠ‚æ—¶
* ç³»ç»Ÿè¦æ±‚ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ä¸åº”è¯¥çŸ¥é“å…¶æ“ä½œçš„æ•°æ®æ—¶ï¼Œå¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥éšè—ä¸ç®—æ³•ç›¸å…³çš„æ•°æ®ç»“æ„
* å¤šä¸ªç±»åªåŒºåˆ«åœ¨è¡¨ç°è¡Œä¸ºä¸åŒï¼Œå¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©å…·ä½“è¦æ‰§è¡Œçš„è¡Œä¸º



***



##### æºç åº”ç”¨

Comparator ä¸­çš„ç­–ç•¥æ¨¡å¼ï¼Œåœ¨ Arrays ç±»ä¸­æœ‰ä¸€ä¸ª sort() æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
public static <T> void sort(T[] a, Comparator<? super T> c) {
    if (c == null) {
        sort(a);
    } else {
        if (LegacyMergeSort.userRequested)
            legacyMergeSort(a, c);
        else
            TimSort.sort(a, 0, a.length, c, null, 0, 0);
    }
}
```

Arrays å°±æ˜¯ä¸€ä¸ªç¯å¢ƒè§’è‰²ç±»ï¼Œè¿™ä¸ª sort æ–¹æ³•å¯ä»¥ä¼ ä¸€ä¸ªæ–°ç­–ç•¥è®©Arraysæ ¹æ®è¿™ä¸ªç­–ç•¥æ¥è¿›è¡Œæ’åºï¼ŒComparatorå……å½“çš„æ˜¯æŠ½è±¡ç­–ç•¥è§’è‰²ï¼Œè€Œå…·ä½“çš„å­å®ç°ç±»å……å½“çš„æ˜¯å…·ä½“ç­–ç•¥è§’è‰²

é€šè¿‡ TimSort ç±»çš„ sort() æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè·‘åˆ° `countRunAndMakeAscending()` è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œåªç”¨äº† compare æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ Arrays.sort æ–¹æ³•åªä¼ å…·ä½“ compare é‡å†™æ–¹æ³•çš„ç±»å¯¹è±¡å°±å¯ä»¥ï¼Œè¿™ä¹Ÿæ˜¯ Comparator æ¥å£ä¸­å¿…é¡»è¦å­ç±»å®ç°çš„ä¸€ä¸ªæ–¹æ³•

```java
private static <T> int countRunAndMakeAscending(T[] a, int lo, int hi,Comparator<? super T> c) {
    assert lo < hi;
    int runHi = lo + 1;
    if (runHi == hi)
        return 1;

    // Find end of run, and reverse range if descending
    if (c.compare(a[runHi++], a[lo]) < 0) { // Descending
        while (runHi < hi && c.compare(a[runHi], a[runHi - 1]) < 0)
            runHi++;
        reverseRange(a, lo, runHi);
    } else {                              // Ascending
        while (runHi < hi && c.compare(a[runHi], a[runHi - 1]) >= 0)
            runHi++;
    }

    return runHi - lo;
}
```





***



### å‘½ä»¤æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

å‘½ä»¤æ¨¡å¼ï¼šå°†ä¸€ä¸ªè¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä½¿å‘å‡ºè¯·æ±‚çš„è´£ä»»å’Œæ‰§è¡Œè¯·æ±‚çš„è´£ä»»åˆ†å‰²å¼€ï¼Œè¿™æ ·ä¸¤è€…ä¹‹é—´é€šè¿‡å‘½ä»¤å¯¹è±¡è¿›è¡Œæ²Ÿé€šï¼Œæ–¹ä¾¿å°†å‘½ä»¤å¯¹è±¡è¿›è¡Œå­˜å‚¨ã€ä¼ é€’ã€è°ƒç”¨ã€å¢åŠ ä¸ç®¡ç†

å‘½ä»¤æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡å‘½ä»¤ç±»ï¼ˆCommandï¼‰è§’è‰²ï¼šå®šä¹‰å‘½ä»¤çš„æ¥å£ï¼Œå£°æ˜æ‰§è¡Œçš„æ–¹æ³•ã€‚
* å…·ä½“å‘½ä»¤ï¼ˆConcrete  Commandï¼‰è§’è‰²ï¼šå…·ä½“çš„å‘½ä»¤ï¼Œå®ç°å‘½ä»¤æ¥å£ï¼Œé€šå¸¸ä¼šæŒæœ‰æ¥æ”¶è€…ï¼Œå¹¶è°ƒç”¨æ¥æ”¶è€…çš„åŠŸèƒ½æ¥å®Œæˆå‘½ä»¤è¦æ‰§è¡Œçš„æ“ä½œ
* å®ç°è€…/æ¥æ”¶è€…ï¼ˆReceiverï¼‰è§’è‰²ï¼šæ¥æ”¶è€…ï¼ŒçœŸæ­£æ‰§è¡Œå‘½ä»¤çš„å¯¹è±¡ï¼Œä»»ä½•ç±»éƒ½å¯èƒ½æˆä¸ºä¸€ä¸ªæ¥æ”¶è€…ï¼Œåªè¦èƒ½å¤Ÿå®ç°å‘½ä»¤è¦æ±‚å®ç°çš„ç›¸åº”åŠŸèƒ½
* è°ƒç”¨è€…/è¯·æ±‚è€…ï¼ˆInvokerï¼‰è§’è‰²ï¼šè¦æ±‚å‘½ä»¤å¯¹è±¡æ‰§è¡Œè¯·æ±‚ï¼Œé€šå¸¸ä¼šæŒæœ‰å‘½ä»¤å¯¹è±¡ï¼Œå¯ä»¥æŒæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡ã€‚è¿™ä¸ªæ˜¯å®¢æˆ·ç«¯çœŸæ­£è§¦å‘å‘½ä»¤å¹¶è¦æ±‚å‘½ä»¤æ‰§è¡Œç›¸åº”æ“ä½œçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´ç›¸å½“äºä½¿ç”¨å‘½ä»¤å¯¹è±¡çš„å…¥å£

æ¨¡å¼ä¼˜ç‚¹ï¼š

* é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œå‘½ä»¤æ¨¡å¼èƒ½å°†è°ƒç”¨æ“ä½œçš„å¯¹è±¡ä¸å®ç°è¯¥æ“ä½œçš„å¯¹è±¡è§£è€¦
* å¢åŠ æˆ–åˆ é™¤å‘½ä»¤éå¸¸æ–¹ä¾¿ï¼Œé‡‡ç”¨å‘½ä»¤æ¨¡å¼å¢åŠ ä¸åˆ é™¤å‘½ä»¤ä¸ä¼šå½±å“å…¶ä»–ç±»ï¼Œæ»¡è¶³â€œå¼€é—­åŸåˆ™â€ï¼Œå¯¹æ‰©å±•æ¯”è¾ƒçµæ´»
* å¯ä»¥å®ç°å®å‘½ä»¤ï¼Œå‘½ä»¤æ¨¡å¼å¯ä»¥ä¸ç»„åˆæ¨¡å¼ç»“åˆï¼Œå°†å¤šä¸ªå‘½ä»¤è£…é…æˆä¸€ä¸ªç»„åˆå‘½ä»¤ï¼Œå³å®å‘½ä»¤
* æ–¹ä¾¿å®ç° Undo å’Œ Redo æ“ä½œï¼Œå‘½ä»¤æ¨¡å¼å¯ä»¥ä¸å¤‡å¿˜å½•æ¨¡å¼ç»“åˆï¼Œå®ç°å‘½ä»¤çš„æ’¤é”€ä¸æ¢å¤

æ¨¡å¼ç¼ºç‚¹ï¼š

* ä½¿ç”¨å‘½ä»¤æ¨¡å¼å¯èƒ½ä¼šå¯¼è‡´æŸäº›ç³»ç»Ÿæœ‰è¿‡å¤šçš„å…·ä½“å‘½ä»¤ç±»ã€‚
* ç³»ç»Ÿç»“æ„æ›´åŠ å¤æ‚



****



#### ä»£ç å®ç°

é¥­åº—æ¡ˆä¾‹

* æŠ½è±¡å‘½ä»¤ç±»ï¼š

  ```java
  public interface Command {    
      void execute();//åªéœ€è¦å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„æ‰§è¡Œæ–¹æ³•
  }
  ```

* å…·ä½“å‘½ä»¤è§’è‰²ï¼š

  ```java
  public class Order {
      // é¤æ¡Œå·ç 
      private int diningTable;
      //set + get
  
      // ç”¨æ¥å­˜å‚¨é¤åå¹¶è®°å½•ä»½æ•°
      private Map<String, Integer> foodDic = new HashMap<String, Integer>();
  
      public Map<String, Integer> getFoodDic() {
          return foodDic;
      }
  
      public void setFoodDic(String name, int num) {
          foodDic.put(name,num);
      }
  }
  ```

  ```java
  public class OrderCommand implements Command {
      //æŒæœ‰æ¥å—è€…å¯¹è±¡
      private SeniorChef receiver;
      private Order order;
  
      public OrderCommand(SeniorChef receiver, Order order){
          this.receiver = receiver;
          this.order = order;
      }
  
      public void execute()  {
          System.out.println(order.getDiningTable() + "æ¡Œçš„è®¢å•ï¼š");
          Set<String> keys = order.getFoodDic().keySet();
          for (String key : keys) {
              receiver.makeFood(order.getFoodDic().get(key),key);
          }
          try {
              Thread.sleep(100);//åœé¡¿ä¸€ä¸‹ æ¨¡æ‹Ÿåšé¥­çš„è¿‡ç¨‹
          } catch (InterruptedException e) {
              e.printStackTrace();
          }
          System.out.println(order.getDiningTable() + "æ¡Œçš„é¥­å¼„å¥½äº†");
      }
  }
  ```

* æ¥æ”¶è€…ï¼š

  ```java
  // å¨å¸ˆç±»
  public class SeniorChef {
      public void makeFood(int num, String foodName) {
          System.out.println(num + "ä»½" + foodName);
      }
  }
  ```

* è¯·æ±‚è€…ï¼š

  ```java
  //æœåŠ¡å‘˜ç±»
  public class Waitor {
      private ArrayList<Command> commands;//å¯ä»¥æŒæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡
      public Waitor() {
          commands = new ArrayList();
      }
      
      public void setCommand(Command cmd){
          //å­˜å‚¨d
          commands.add(cmd);
      }
      // å‘å‡ºå‘½ä»¤ å–Š è®¢å•æ¥äº†ï¼Œå¨å¸ˆå¼€å§‹æ‰§è¡Œ
      public void orderUp() {
          System.out.println("æœåŠ¡å‘˜ï¼šå¤§å¨ï¼Œæ–°è®¢å•æ¥äº†.......");
          for (int i = 0; i < commands.size(); i++) {
              Command cmd = commands.get(i);
              if (cmd != null) {
                  cmd.execute();
              }
          }
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //åˆ›å»º1ä¸ªorder
      Order order = new Order();
      order.setDiningTable(1);
      order.getFoodDic().put("è¥¿çº¢æŸ¿é¸¡è›‹é¢",1);
      order.getFoodDic().put("å°æ¯å¯ä¹",2);
  
      //åˆ›å»ºæ¥æ”¶è€…
      SeniorChef receiver=new SeniorChef();
      //å°†è®¢å•å’Œæ¥æ”¶è€…å°è£…æˆå‘½ä»¤å¯¹è±¡
      OrderCommand cmd = new OrderCommand(receiver, order1);
      //åˆ›å»ºè°ƒç”¨è€… waitor
      Waitor invoker = new Waitor();
      invoker.setCommand(cmd);
  
      //å°†è®¢å•å¸¦åˆ°æŸœå° å¹¶å‘å¨å¸ˆå–Š è®¢å•æ¥äº†
      invoker.orderUp();
  }
  ```

  

****



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* ç³»ç»Ÿéœ€è¦å°†è¯·æ±‚è°ƒç”¨è€…å’Œè¯·æ±‚æ¥æ”¶è€…è§£è€¦ï¼Œä½¿å¾—è°ƒç”¨è€…å’Œæ¥æ”¶è€…ä¸ç›´æ¥äº¤äº’
* ç³»ç»Ÿéœ€è¦åœ¨ä¸åŒçš„æ—¶é—´æŒ‡å®šè¯·æ±‚ã€å°†è¯·æ±‚æ’é˜Ÿå’Œæ‰§è¡Œè¯·æ±‚
* ç³»ç»Ÿéœ€è¦æ”¯æŒå‘½ä»¤çš„æ’¤é”€(Undo)æ“ä½œå’Œæ¢å¤(Redo)æ“ä½œ



##### æºç åº”ç”¨

Runable æ˜¯ä¸€ä¸ªå…¸å‹å‘½ä»¤æ¨¡å¼ï¼ŒRunnable æ‹…å½“å‘½ä»¤çš„è§’è‰²ï¼ŒThread å……å½“çš„æ˜¯è°ƒç”¨è€…ï¼Œstart æ–¹æ³•å°±æ˜¯å…¶æ‰§è¡Œæ–¹æ³•

```java
//å‘½ä»¤æ¥å£(æŠ½è±¡å‘½ä»¤è§’è‰²)
public interface Runnable {
	public abstract void run();
}
//è°ƒç”¨è€…
public class Thread implements Runnable {
    private Runnable target;
    public synchronized void start() {
        //...
        start0();
       //....
    }
    private native void start0();
}
```

è°ƒç”¨ä¸€ä¸ª native æ–¹æ³• start0()ï¼Œè°ƒç”¨ç³»ç»Ÿæ–¹æ³•ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ã€‚è€Œæ¥æ”¶è€…æ˜¯å¯¹ç¨‹åºå‘˜å¼€æ”¾çš„ï¼Œå¯ä»¥è‡ªå®šä¹‰æ¥æ”¶è€…



****



### è´£ä»»é“¾

#### åŸºæœ¬ä»‹ç»

è´£ä»»é“¾æ¨¡å¼ï¼šä¸ºäº†é¿å…è¯·æ±‚å‘é€è€…ä¸å¤šä¸ªè¯·æ±‚å¤„ç†è€…è€¦åˆåœ¨ä¸€èµ·ï¼Œå°†æ‰€æœ‰è¯·æ±‚çš„å¤„ç†è€…é€šè¿‡å‰ä¸€å¯¹è±¡è®°ä½å…¶ä¸‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è€Œè¿æˆä¸€æ¡é“¾ï¼Œå½“æœ‰è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå¯å°†è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¼ é€’ï¼Œç›´åˆ°æœ‰å¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢

èŒè´£é“¾æ¨¡å¼ä¸»è¦åŒ…å«ä»¥ä¸‹è§’è‰²ï¼š

* æŠ½è±¡å¤„ç†è€…ï¼ˆHandlerï¼‰è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ï¼ŒåŒ…å«æŠ½è±¡å¤„ç†æ–¹æ³•å’Œä¸€ä¸ªåç»§è¿æ¥
* å…·ä½“å¤„ç†è€…ï¼ˆConcrete Handlerï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡å¤„ç†è€…çš„å¤„ç†æ–¹æ³•ï¼Œåˆ¤æ–­èƒ½å¦å¤„ç†æœ¬æ¬¡è¯·æ±‚ï¼Œå¦‚æœå¯ä»¥å¤„ç†è¯·æ±‚åˆ™å¤„ç†ï¼Œå¦åˆ™å°†è¯¥è¯·æ±‚è½¬ç»™åç»§è€…
* å®¢æˆ·ç±»ï¼ˆClientï¼‰è§’è‰²ï¼šåˆ›å»ºå¤„ç†é“¾ï¼Œå¹¶å‘é“¾å¤´çš„å…·ä½“å¤„ç†è€…å¯¹è±¡æäº¤è¯·æ±‚ï¼Œä¸å…³å¿ƒå¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’è¿‡ç¨‹

æ¨¡å¼ä¼˜ç‚¹ï¼š

* é™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œé™ä½äº†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…çš„è€¦åˆåº¦

* å¢å¼ºäº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¢åŠ æ–°çš„è¯·æ±‚å¤„ç†ç±»ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™

* å¢å¼ºäº†ç»™å¯¹è±¡æŒ‡æ´¾èŒè´£çš„çµæ´»æ€§ï¼Œå½“å·¥ä½œæµç¨‹å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥åŠ¨æ€åœ°æ”¹å˜é“¾å†…çš„æˆå‘˜æˆ–è€…ä¿®æ”¹å®ƒä»¬çš„æ¬¡åºï¼Œä¹Ÿå¯åŠ¨æ€åœ°æ–°å¢æˆ–è€…åˆ é™¤è´£ä»»

* è´£ä»»é“¾ç®€åŒ–äº†å¯¹è±¡ä¹‹é—´çš„è¿æ¥ï¼Œä¸€ä¸ªå¯¹è±¡åªéœ€ä¿æŒä¸€ä¸ªæŒ‡å‘å…¶åç»§è€…çš„å¼•ç”¨ï¼Œä¸éœ€ä¿æŒå…¶ä»–æ‰€æœ‰å¤„ç†è€…çš„å¼•ç”¨ï¼Œè¿™é¿å…äº†ä½¿ç”¨ä¼—å¤šçš„ if æˆ–è€… ifÂ·Â·Â·else è¯­å¥ã€‚

* è´£ä»»åˆ†æ‹…ï¼Œæ¯ä¸ªç±»åªéœ€è¦å¤„ç†è‡ªå·±è¯¥å¤„ç†çš„å·¥ä½œï¼Œä¸èƒ½å¤„ç†çš„ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¯¹è±¡å®Œæˆï¼Œæ˜ç¡®å„ç±»çš„è´£ä»»èŒƒå›´ï¼Œç¬¦åˆç±»çš„å•ä¸€èŒè´£åŸåˆ™


æ¨¡å¼ç¼ºç‚¹ï¼š

* ä¸èƒ½ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸€å®šè¢«å¤„ç†ï¼Œç”±äºä¸€ä¸ªè¯·æ±‚æ²¡æœ‰æ˜ç¡®çš„æ¥æ”¶è€…ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯ä¸€å®šä¼šè¢«å¤„ç†ï¼Œè¯¥è¯·æ±‚å¯èƒ½ä¸€ç›´ä¼ åˆ°é“¾çš„æœ«ç«¯éƒ½å¾—ä¸åˆ°å¤„ç†
* å¯¹æ¯”è¾ƒé•¿çš„èŒè´£é“¾ï¼Œè¯·æ±‚çš„å¤„ç†å¯èƒ½æ¶‰åŠå¤šä¸ªå¤„ç†å¯¹è±¡ï¼Œç³»ç»Ÿæ€§èƒ½å°†å—åˆ°ä¸€å®šå½±å“
* èŒè´£é“¾å»ºç«‹çš„åˆç†æ€§è¦é å®¢æˆ·ç«¯æ¥ä¿è¯ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ï¼Œå¯èƒ½ä¼šç”±äºèŒè´£é“¾çš„é”™è¯¯è®¾ç½®è€Œå¯¼è‡´ç³»ç»Ÿå‡ºé”™ï¼Œå¦‚å¯èƒ½ä¼šé€ æˆå¾ªç¯è°ƒç”¨



****



#### ä»£ç å®ç°

å¼€å‘ä¸€ä¸ªè¯·å‡æµç¨‹æ§åˆ¶ç³»ç»Ÿï¼Œè¯·å‡ä¸€å¤©ä»¥ä¸‹çš„å‡åªéœ€è¦å°ç»„é•¿åŒæ„å³å¯ï¼Œè¯·å‡1å¤©åˆ°3å¤©çš„å‡è¿˜éœ€è¦éƒ¨é—¨ç»ç†åŒæ„ï¼Œè¯·æ±‚3å¤©åˆ°7å¤©è¿˜éœ€è¦æ€»ç»ç†åŒæ„æ‰è¡Œ

* è¯·å‡ç±»ï¼š

  ```java
  public class LeaveRequest {
      private String name;//å§“å
      private int num;//è¯·å‡å¤©æ•°
      private String content;//è¯·å‡å†…å®¹
  	// constructor + set + get
  }
  ```

* æŠ½è±¡å¤„ç†è€…ï¼š

  ```java
  //å¤„ç†è€…æŠ½è±¡ç±»
  public abstract class Handler {
      protected final static int NUM_ONE = 1;
      protected final static int NUM_THREE = 3;
      protected final static int NUM_SEVEN = 7;
  
      //è¯¥é¢†å¯¼å¤„ç†çš„è¯·å‡å¤©æ•°åŒºé—´
      private int numStart;
      private int numEnd;
  
      //é¢†å¯¼ä¸Šé¢è¿˜æœ‰é¢†å¯¼
      private Handler nextHandler;
  
      //è®¾ç½®è¯·å‡å¤©æ•°èŒƒå›´ ä¸Šä¸å°é¡¶
      public Handler(int numStart) {
          this.numStart = numStart;
      }
  
      //è®¾ç½®è¯·å‡å¤©æ•°èŒƒå›´
      public Handler(int numStart, int numEnd) {
          this.numStart = numStart;
          this.numEnd = numEnd;
      }
  
      //è®¾ç½®ä¸Šçº§é¢†å¯¼
      public void setNextHandler(Handler nextHandler){
          this.nextHandler = nextHandler;
      }
  
      //æäº¤è¯·å‡æ¡
      public final void submit(LeaveRequest leave){
          if(0 == this.numStart){
              return;
          }
  
          //å¦‚æœè¯·å‡å¤©æ•°è¾¾åˆ°è¯¥é¢†å¯¼è€…çš„å¤„ç†è¦æ±‚
          if(leave.getNum() >= this.numStart){
              this.handleLeave(leave);
  
              //å¦‚æœè¿˜æœ‰ä¸Šçº§ å¹¶ä¸”è¯·å‡å¤©æ•°è¶…è¿‡äº†å½“å‰é¢†å¯¼çš„å¤„ç†èŒƒå›´
              if(null != this.nextHandler && leave.getNum() > numEnd){
                  this.nextHandler.submit(leave);//ç»§ç»­æäº¤
              } else {
                  System.out.println("æµç¨‹ç»“æŸ");
              }
          }
      }
      //å„çº§é¢†å¯¼å¤„ç†è¯·å‡æ¡æ–¹æ³•
      protected abstract void handleLeave(LeaveRequest leave);
  }
  ```

* å…·ä½“å¤„ç†è€…ï¼š

  ```java
  public class GroupLeader extends Handler {
      public GroupLeader() {
          //å°ç»„é•¿å¤„ç†1-3å¤©çš„è¯·å‡
          super(Handler.NUM_ONE, Handler.NUM_THREE);
      }
      @Override
      protected void handleLeave(LeaveRequest leave) {
          System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
          System.out.println("å°ç»„é•¿å®¡æ‰¹ï¼šåŒæ„ã€‚");
      }
  }
  //éƒ¨é—¨ç»ç†
  public class Manager extends Handler {
      public Manager() {
          //éƒ¨é—¨ç»ç†å¤„ç†3-7å¤©çš„è¯·å‡
          super(Handler.NUM_THREE, Handler.NUM_SEVEN);
      }
      @Override
      protected void handleLeave(LeaveRequest leave) {
          System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
          System.out.println("éƒ¨é—¨ç»ç†å®¡æ‰¹ï¼šåŒæ„ã€‚");
      }
  }
  //æ€»ç»ç†
  public class GeneralManager extends Handler {
      public GeneralManager() {
          //éƒ¨é—¨ç»ç†å¤„ç†7å¤©ä»¥ä¸Šçš„è¯·å‡
          super(Handler.NUM_SEVEN);
      }
      @Override
      protected void handleLeave(LeaveRequest leave) {
          System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
          System.out.println("æ€»ç»ç†å®¡æ‰¹ï¼šåŒæ„ã€‚");
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //è¯·å‡æ¡æ¥ä¸€å¼ 
      LeaveRequest leave = new LeaveRequest("å°èŠ±",5,"èº«ä½“ä¸é€‚");
  
      //å„ä½é¢†å¯¼
      GroupLeader groupLeader = new GroupLeader();
      Manager manager = new Manager();
      GeneralManager generalManager = new GeneralManager();
  
      groupLeader.setNextHandler(manager);//å°ç»„é•¿çš„é¢†å¯¼æ˜¯éƒ¨é—¨ç»ç†
      manager.setNextHandler(generalManager);//éƒ¨é—¨ç»ç†çš„é¢†å¯¼æ˜¯æ€»ç»ç†
      //ä¹‹æ‰€ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸Šçº§é¢†å¯¼ï¼Œæ˜¯å› ä¸ºå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ¥æ›´æ”¹è®¾ç½®ï¼Œå¦‚æœå®æˆ˜ä¸­ä¸Šçº§é¢†å¯¼äººéƒ½æ˜¯å›ºå®šçš„ï¼Œåˆ™å¯ä»¥ç§»åˆ°é¢†å¯¼å®ç°ç±»ä¸­ã€‚
  
      //æäº¤ç”³è¯·
      groupLeader.submit(leave);
  }
  ```



***



#### åº”ç”¨åœºæ™¯

åœ¨ JavaWeb åº”ç”¨å¼€å‘ä¸­ï¼ŒFilterChainæ˜¯èŒè´£é“¾ï¼ˆè¿‡æ»¤å™¨ï¼‰æ¨¡å¼çš„å…¸å‹åº”ç”¨ï¼Œä»¥ä¸‹æ˜¯ Filter çš„æ¨¡æ‹Ÿå®ç°ï¼š

ç±»ä¼¼äºæ ˆçš„æ‰§è¡Œæµç¨‹ï¼Œå…ˆè¿›å…ˆå‡º

* æ¨¡æ‹Ÿ web è¯·æ±‚ Request ä»¥åŠ web å“åº” Responseï¼š

  ```java
  public interface Request{
  }
  public interface Response{
  }
  ```

* æ¨¡æ‹Ÿ web è¿‡æ»¤å™¨ Filterï¼š

  ```java
  public interface Filter {
      public void doFilter(Request req, Response res, FilterChain c);
  }
  ```

* æ¨¡æ‹Ÿå®ç°å…·ä½“è¿‡æ»¤å™¨  ï¼š

  ```java
  public class FirstFilter implements Filter {
      @Override
      public void doFilter(Request request, Response response, FilterChain chain) {
          System.out.println("è¿‡æ»¤å™¨1 å‰ç½®å¤„ç†");
          // å…ˆæ‰§è¡Œæ‰€æœ‰requestå†å€’åºæ‰§è¡Œæ‰€æœ‰response
          chain.doFilter(request, response);
          System.out.println("è¿‡æ»¤å™¨1 åç½®å¤„ç†");
      }
  }
  
  public class SecondFilter implements Filter {
      @Override
      public void doFilter(Request request, Response response, FilterChain chain) {
          System.out.println("è¿‡æ»¤å™¨2 å‰ç½®å¤„ç†");
          // å…ˆæ‰§è¡Œæ‰€æœ‰requestå†å€’åºæ‰§è¡Œæ‰€æœ‰response
          chain.doFilter(request, response);
          System.out.println("è¿‡æ»¤å™¨2 åç½®å¤„ç†");
      }
  }
  ```

* æ¨¡æ‹Ÿå®ç°è¿‡æ»¤å™¨é“¾FilterChain  

  ```java
  public class FilterChain {
      private List<Filter> filters = new ArrayList<Filter>();
      private int index = 0;
  
      // é“¾å¼è°ƒç”¨
      public FilterChain addFilter(Filter filter) {
          this.filters.add(filter);
          return this;
      }
  
      public void doFilter(Request request, Response response) {
          if (index == filters.size()) {
              return;
          }
          Filter filter = filters.get(index);
          index++;
          filter.doFilter(request, response, this);
      }
  }
  ```

* æµ‹è¯•ç±»

  ```java
  public class Client {
      public static void main(String[] args) {
          Request  req = null;
          Response res = null ;
  
          FilterChain filterChain = new FilterChain();
          filterChain.addFilter(new FirstFilter()).addFilter(new SecondFilter());
          filterChain.doFilter(req,res);
      }
  }
  /*
  è¿‡æ»¤å™¨1 å‰ç½®å¤„ç†
  è¿‡æ»¤å™¨2 å‰ç½®å¤„ç†
  è¿‡æ»¤å™¨2 åç½®å¤„ç†
  è¿‡æ»¤å™¨1 åç½®å¤„ç†
  */
  ```



****



### çŠ¶æ€æ¨¡å¼

#### åŸºæœ¬ä»‹ç»

åœ¨çŠ¶æ€æ¨¡å¼ï¼ˆState Patternï¼‰ä¸­ï¼Œç±»çš„è¡Œä¸ºæ˜¯åŸºäºå®ƒçš„çŠ¶æ€æ”¹å˜çš„

çŠ¶æ€æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ã€‚

* ç¯å¢ƒï¼ˆContextï¼‰è§’è‰²ï¼šä¹Ÿç§°ä¸ºä¸Šä¸‹æ–‡ï¼Œå®ƒå®šä¹‰äº†å®¢æˆ·ç¨‹åºéœ€è¦çš„æ¥å£ï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰çŠ¶æ€ï¼Œå¹¶å°†ä¸çŠ¶æ€ç›¸å…³çš„æ“ä½œå§”æ‰˜ç»™å½“å‰çŠ¶æ€å¯¹è±¡æ¥å¤„ç†
* æŠ½è±¡çŠ¶æ€ï¼ˆStateï¼‰è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç”¨ä»¥å°è£…ç¯å¢ƒå¯¹è±¡ä¸­çš„ç‰¹å®šçŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸º
* å…·ä½“çŠ¶æ€ï¼ˆConcrete  Stateï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡çŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸º

æ¨¡å¼ä¼˜ç‚¹ï¼š

* å°†æ‰€æœ‰ä¸æŸä¸ªçŠ¶æ€æœ‰å…³çš„è¡Œä¸ºæ”¾åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°å¢åŠ æ–°çš„çŠ¶æ€ï¼Œåªéœ€è¦æ”¹å˜å¯¹è±¡çŠ¶æ€å³å¯æ”¹å˜å¯¹è±¡çš„è¡Œä¸º
* å…è®¸çŠ¶æ€è½¬æ¢é€»è¾‘ä¸çŠ¶æ€å¯¹è±¡åˆæˆä¸€ä½“ï¼Œè€Œä¸æ˜¯æŸä¸€ä¸ªå·¨å¤§çš„æ¡ä»¶è¯­å¥å—

æ¨¡å¼ç¼ºç‚¹ï¼š

* çŠ¶æ€æ¨¡å¼çš„ä½¿ç”¨å¿…ç„¶ä¼šå¢åŠ ç³»ç»Ÿç±»å’Œå¯¹è±¡çš„ä¸ªæ•°ã€‚ 
* çŠ¶æ€æ¨¡å¼çš„ç»“æ„ä¸å®ç°éƒ½è¾ƒä¸ºå¤æ‚ï¼Œå¦‚æœä½¿ç”¨ä¸å½“å°†å¯¼è‡´ç¨‹åºç»“æ„å’Œä»£ç çš„æ··ä¹±
* çŠ¶æ€æ¨¡å¼å¯¹å¼€é—­åŸåˆ™çš„æ”¯æŒå¹¶ä¸å¤ªå¥½

ä½¿ç”¨åœºæ™¯ï¼š

- å½“ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºå–å†³äºå®ƒçš„çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒå¿…é¡»åœ¨è¿è¡Œæ—¶æ ¹æ®çŠ¶æ€æ”¹å˜å®ƒçš„è¡Œä¸ºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨çŠ¶æ€æ¨¡å¼
- ä¸€ä¸ªæ“ä½œä¸­å«æœ‰åºå¤§çš„åˆ†æ”¯ç»“æ„ï¼Œå¹¶ä¸”è¿™äº›åˆ†æ”¯å†³å®šäºå¯¹è±¡çš„çŠ¶æ€æ—¶



***



#### ä»£ç å®ç°

é€šè¿‡æŒ‰é’®æ¥æ§åˆ¶ä¸€ä¸ªç”µæ¢¯çš„çŠ¶æ€ï¼Œä¸€ä¸ªç”µæ¢¯æœ‰å¼€é—¨çŠ¶æ€ï¼Œå…³é—¨çŠ¶æ€ï¼Œåœæ­¢çŠ¶æ€ï¼Œè¿è¡ŒçŠ¶æ€ï¼Œæ¯ä¸€ç§çŠ¶æ€æ”¹å˜ï¼Œéƒ½æœ‰å¯èƒ½è¦æ ¹æ®å…¶ä»–çŠ¶æ€æ¥æ›´æ–°å¤„ç†

* æŠ½è±¡çŠ¶æ€è§’è‰²ï¼š

  ```java
  public abstract class LiftState {    
      //å®šä¹‰ä¸€ä¸ªç¯å¢ƒè§’è‰²ï¼Œä¹Ÿå°±æ˜¯å°è£…çŠ¶æ€çš„å˜åŒ–å¼•èµ·çš„åŠŸèƒ½å˜åŒ–    
      protected Context context;    
      public void setContext(Context context) {        
          this.context = context;    
      }    
      //ç”µæ¢¯å¼€é—¨åŠ¨ä½œ    
      public abstract void open();    
      //ç”µæ¢¯å…³é—¨åŠ¨ä½œ    
      public abstract void close();    
      //ç”µæ¢¯è¿è¡ŒåŠ¨ä½œ    
      public abstract void run();    
      //ç”µæ¢¯åœæ­¢åŠ¨ä½œ    
      public abstract void stop();
  }
  ```

* ç”µæ¢¯é—¨å¼€å¯çŠ¶æ€ï¼š

  ```java
  public class OpenningState extends LiftState {        
      @Override    
      public void open() {        
          System.out.println("ç”µæ¢¯é—¨å¼€å¯...");    
      }	
      //å¼€å¯äº†å°±å¯ä»¥å…³é—­äº†    
      @Override    
      public void close() {        
          //çŠ¶æ€ä¿®æ”¹        
          super.context.setLiftState(Context.closeingState);        
          //åŠ¨ä½œå§”æ‰˜ä¸ºCloseStateæ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å§”æ‰˜ç»™äº†ClosingStateå­ç±»æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œ        
          super.context.getLiftState().close();    
      }    
      //ç”µæ¢¯é—¨ä¸èƒ½å¼€ç€å°±è·‘ï¼Œè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš    
      @Override    public void run() {       
          //do nothing    
      }    
      //å¼€é—¨çŠ¶æ€å·²ç»æ˜¯åœæ­¢çš„äº†    
      @Override    
      public void stop() {        
          //do nothing    
      }
  }
  //ç”µæ¢¯é—¨å…³é—­çŠ¶æ€ çœç•¥
  ```

* ç”µæ¢¯è¿è¡ŒçŠ¶æ€ï¼š

  ```java
  public class RunningState extends LiftState {    
      //è¿è¡Œçš„æ—¶å€™ä¸èƒ½å¼€ç”µæ¢¯é—¨    
      @Override    
      public void open() {        
          //do nothing    
      }    
      //ç”µæ¢¯é—¨å…³é—­ï¼Ÿè¿™æ˜¯è‚¯å®šäº†    
      @Override    
      public void close() {
          //è™½ç„¶å¯ä»¥å…³é—¨ï¼Œä½†è¿™ä¸ªåŠ¨ä½œä¸å½’æˆ‘æ‰§è¡Œ        
          //do nothing    
      }    
      //è¿™æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸‹è¦å®ç°çš„æ–¹æ³•    
      @Override    
      public void run() {        
          System.out.println("ç”µæ¢¯æ­£åœ¨è¿è¡Œ...");    
      }    
      //è¿™ä¸ªäº‹æ˜¯åˆç†çš„    
      @Override    
      public void stop() {        
          super.context.setLiftState(Context.stoppingState);        
          super.context.stop();    
      }
  }
  //ç”µæ¢¯åœæ­¢çŠ¶æ€ çœç•¥
  ```

* ç¯å¢ƒè§’è‰²ç±»ï¼š

  ```java
  public class Context {    
      //å®šä¹‰å‡ºæ‰€æœ‰çš„ç”µæ¢¯çŠ¶æ€ï¼Œå¼€é—¨çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯åªèƒ½å…³é—­    
      public final static OpenningState openningState = new OpenningState();    
      //å…³é—­çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯å¯ä»¥è¿è¡Œã€åœæ­¢å’Œå¼€é—¨    
      public final static ClosingState closeingState = new ClosingState();    
      //è¿è¡ŒçŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯åªèƒ½åœæ­¢    
      public final static RunningState runningState = new RunningState();    
      //åœæ­¢çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯å¯ä»¥å¼€é—¨ã€è¿è¡Œ    
      public final static StoppingState stoppingState = new StoppingState();    
      //å®šä¹‰ä¸€ä¸ªå½“å‰ç”µæ¢¯çŠ¶æ€    
      private LiftState liftState;    
      public LiftState getLiftState() {        
          return this.liftState;    
      }   
      public void setLiftState(LiftState liftState) {        
          //å½“å‰ç¯å¢ƒæ”¹å˜        
          this.liftState = liftState;        
          //æŠŠå½“å‰çš„ç¯å¢ƒé€šçŸ¥åˆ°å„ä¸ªå®ç°ç±»ä¸­        
          this.liftState.setContext(this);    
      }    
      public void open() {        
          this.liftState.open();    
      }    
      public void close() {        
          this.liftState.close();    
      }    
      public void run() {        
          this.liftState.run();    
      }    
      public void stop() {        
          this.liftState.stop();    
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {    
      Context context = new Context();    
      context.setLiftState(new ClosingState());    
      context.open();    
      context.close();    
      context.run();    
      context.stop();
  }
  ```
  
  

*****



### è§‚å¯Ÿè€…

#### åŸºæœ¬ä»‹ç»

è§‚å¯Ÿè€…æ¨¡å¼ï¼šåˆç§°ä¸ºå‘å¸ƒ-è®¢é˜…ï¼ˆPublish/Subscribeï¼‰æ¨¡å¼ï¼Œå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ã€‚è¿™ä¸ªä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±

åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­æœ‰å¦‚ä¸‹è§’è‰²ï¼š

* Subjectï¼šæŠ½è±¡ä¸»é¢˜ï¼ˆæŠ½è±¡è¢«è§‚å¯Ÿè€…ï¼‰ï¼ŒæŠ½è±¡ä¸»é¢˜è§’è‰²æŠŠæ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ä¿å­˜åœ¨ä¸€ä¸ªé›†åˆé‡Œï¼Œæ¯ä¸ªä¸»é¢˜éƒ½å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„è§‚å¯Ÿè€…ï¼ŒæŠ½è±¡ä¸»é¢˜æä¾›ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥å¢åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…å¯¹è±¡
* ConcreteSubjectï¼šå…·ä½“ä¸»é¢˜ï¼ˆå…·ä½“è¢«è§‚å¯Ÿè€…ï¼‰ï¼Œè¯¥è§’è‰²å°†æœ‰å…³çŠ¶æ€å­˜å…¥å…·ä½“è§‚å¯Ÿè€…å¯¹è±¡ï¼Œåœ¨å…·ä½“ä¸»é¢˜çš„å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç»™æ‰€æœ‰æ³¨å†Œè¿‡çš„è§‚å¯Ÿè€…å‘é€é€šçŸ¥
* Observerï¼šæŠ½è±¡è§‚å¯Ÿè€…ï¼Œæ˜¯è§‚å¯Ÿè€…çš„æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†ä¸€ä¸ªæ›´æ–°æ¥å£ï¼Œåœ¨å¾—åˆ°ä¸»é¢˜æ›´æ”¹é€šçŸ¥æ—¶æ›´æ–°è‡ªå·±
* ConcrereObserverï¼šå…·ä½“è§‚å¯Ÿè€…ï¼Œå®ç°æŠ½è±¡è§‚å¯Ÿè€…å®šä¹‰çš„æ›´æ–°æ¥å£ï¼Œåœ¨å¾—åˆ°ä¸»é¢˜æ›´æ”¹é€šçŸ¥æ—¶æ›´æ–°è‡ªèº«çŠ¶æ€

æ¨¡å¼ä¼˜ç‚¹ï¼š

* é™ä½äº†ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œä¸¤è€…ä¹‹é—´æ˜¯æŠ½è±¡è€¦åˆå…³ç³»
* è¢«è§‚å¯Ÿè€…å‘é€é€šçŸ¥ï¼Œæ‰€æœ‰æ³¨å†Œçš„è§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œå¯ä»¥å®ç°**å¹¿æ’­**æœºåˆ¶

æ¨¡å¼ç¼ºç‚¹ï¼š

* å¦‚æœè§‚å¯Ÿè€…éå¸¸å¤šçš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è§‚å¯Ÿè€…æ”¶åˆ°è¢«è§‚å¯Ÿè€…å‘é€çš„é€šçŸ¥ä¼šæ¯”è¾ƒè€—æ—¶
* å¦‚æœè¢«è§‚å¯Ÿè€…æœ‰å¾ªç¯ä¾èµ–çš„è¯ï¼Œé‚£ä¹ˆè¢«è§‚å¯Ÿè€…å‘é€é€šçŸ¥ä¼šä½¿è§‚å¯Ÿè€…å¾ªç¯è°ƒç”¨ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ



****



#### ä»£ç å®ç°

å¾®ä¿¡å…¬ä¼—å·è®¢é˜…ï¼Œå¾®ä¿¡ç”¨æˆ·å°±æ˜¯è§‚å¯Ÿè€…ï¼Œå¾®ä¿¡å…¬ä¼—å·æ˜¯è¢«è§‚å¯Ÿè€…

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-è§‚å¯Ÿè€…æ¨¡å¼.png" style="zoom: 80%;" />

* æŠ½è±¡è§‚å¯Ÿè€…ç±»ï¼š

  ```java
  public interface Observer {    
      void update(String message);
  }
  ```

* å…·ä½“è§‚å¯Ÿè€…ç±»ï¼Œå¾®ä¿¡ç”¨æˆ·æ˜¯è§‚å¯Ÿè€…ï¼š

  ```java
  public class WeixinUser implements Observer {    
      // å¾®ä¿¡ç”¨æˆ·å    
      private String name;    
      public WeixinUser(String name) {        
          this.name = name;    
      }    
      @Override    
      public void update(String message) {        
          System.out.println(name + "-" + message);    
      }
  }
  ```

* æŠ½è±¡ä¸»é¢˜ç±»ï¼š

  ```java
  public interface Subject {    
      //å¢åŠ è®¢é˜…è€…    
      public void attach(Observer observer);    
      //åˆ é™¤è®¢é˜…è€…    
      public void detach(Observer observer);    
      //é€šçŸ¥è®¢é˜…è€…æ›´æ–°æ¶ˆæ¯    
      public void notify(String message);
  }
  ```

* å¾®ä¿¡å…¬ä¼—å·æ˜¯å…·ä½“ä¸»é¢˜ï¼ˆå…·ä½“è¢«è§‚å¯Ÿè€…ï¼‰ï¼š

  ```java
  public class SubscriptionSubject implements Subject {    
      //å‚¨å­˜è®¢é˜…å…¬ä¼—å·çš„å¾®ä¿¡ç”¨æˆ·    
      private List<Observer> weixinUserlist = new ArrayList<Observer>();    
      @Override    
      public void attach(Observer observer) {        
          weixinUserlist.add(observer);    
      }    
      @Override    
      public void detach(Observer observer) {        
          weixinUserlist.remove(observer);    
      }    
      @Override    
      public void notify(String message) {        
          for (Observer observer : weixinUserlist) {            
              observer.update(message);        
          }    
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {    
      SubscriptionSubject mSubscriptionSubject = new SubscriptionSubject();    
      //åˆ›å»ºå¾®ä¿¡ç”¨æˆ·    
      WeixinUser user1 = new WeixinUser("å­™æ‚Ÿç©º");    
      WeixinUser user2 = new WeixinUser("çŒªæ‚Ÿèƒ½");    
      WeixinUser user3 = new WeixinUser("æ²™æ‚Ÿå‡€");    
      //è®¢é˜…å…¬ä¼—å·    
      mSubscriptionSubject.attach(user1);    
      mSubscriptionSubject.attach(user2);    
      mSubscriptionSubject.attach(user3);    
      //å…¬ä¼—å·æ›´æ–°å‘å‡ºæ¶ˆæ¯ç»™è®¢é˜…çš„å¾®ä¿¡ç”¨æˆ·    
      mSubscriptionSubject.notify("å”åƒ§çš„ä¸“æ æ›´æ–°äº†");
  }
  ```



****



#### åº”ç”¨åœºæ™¯

##### ä½¿ç”¨åœºæ™¯

* å¯¹è±¡é—´å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ä¼šå½±å“å…¶ä»–å¯¹è±¡
* å½“ä¸€ä¸ªæŠ½è±¡æ¨¡å‹æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹é¢ä¾èµ–äºå¦ä¸€æ–¹é¢æ—¶



##### æºç åº”ç”¨

åœ¨ Java ä¸­ï¼Œé€šè¿‡ java.util.Observable ç±»å’Œ java.util.Observer æ¥å£å®šä¹‰äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œåªè¦å®ç°å®ƒä»¬çš„å­ç±»å°±å¯ä»¥ç¼–å†™è§‚å¯Ÿè€…æ¨¡å¼å®ä¾‹

* Observableç±»æ˜¯æŠ½è±¡ç›®æ ‡ç±»ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰ï¼Œæœ‰ä¸€ä¸ª Vector é›†åˆæˆå‘˜å˜é‡ï¼Œä¿å­˜æ‰€æœ‰è¦é€šçŸ¥çš„è§‚å¯Ÿè€…å¯¹è±¡
  * `void addObserver(Observer o)`ï¼šç”¨äºå°†æ–°çš„è§‚å¯Ÿè€…å¯¹è±¡æ·»åŠ åˆ°é›†åˆä¸­

  * `void notifyObservers(Object arg)`ï¼šè°ƒç”¨é›†åˆä¸­çš„æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„ update æ–¹æ³•ï¼Œé€šçŸ¥å®ƒä»¬æ•°æ®å‘ç”Ÿæ”¹å˜ï¼Œé€šå¸¸è¶Šæ™šåŠ å…¥é›†åˆçš„è§‚å¯Ÿè€…è¶Šå…ˆå¾—åˆ°é€šçŸ¥ï¼ˆä»åå‘å‰éå†ï¼‰

  * `void setChange()`ï¼šç”¨æ¥è®¾ç½®ä¸€ä¸ª boolean ç±»å‹çš„å†…éƒ¨æ ‡å¿—ï¼Œæ³¨æ˜ç›®æ ‡å¯¹è±¡å‘ç”Ÿäº†å˜åŒ–ï¼Œå½“å®ƒä¸ºtrueæ—¶ï¼ŒnotifyObservers() å°±ä¼šé€šçŸ¥è§‚å¯Ÿè€…

* Observer æ¥å£æ˜¯æŠ½è±¡è§‚å¯Ÿè€…ï¼Œç›‘è§†ç›®æ ‡å¯¹è±¡çš„å˜åŒ–ï¼Œå½“ç›®æ ‡å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å¾—åˆ°é€šçŸ¥ï¼Œå¹¶è°ƒç”¨ update æ–¹æ³•ï¼Œè¿›è¡Œç›¸åº”çš„å·¥ä½œ

å®ä¾‹ï¼šè­¦å¯ŸæŠ“å°å·ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

* å°å·æ˜¯ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ï¼Œéœ€è¦ç»§æ‰¿Observableç±»ï¼š

  ```java
  public class Thief extends Observable {
      private String name;
  	// construct + set + get
  
      public void steal() {
          System.out.println("å°å·ï¼šæˆ‘å·ä¸œè¥¿äº†ï¼Œæœ‰æ²¡æœ‰äººæ¥æŠ“æˆ‘ï¼ï¼ï¼");
          super.setChanged(); //changed  = true
          super.notifyObservers();
      }
  }
  ```

* è­¦å¯Ÿæ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œéœ€è¦å®ç°Observeræ¥å£ï¼š

  ```java
  public class Policemen implements Observer {
      private String name;
  	// construct + set + get
  
      @Override
      public void update(Observable o, Object arg) {
          System.out.println("è­¦å¯Ÿï¼š" + ((Thief) o).getName() + "ï¼Œæˆ‘ç›¯ä½ å¾ˆä¹…äº†");
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //åˆ›å»ºå°å·å¯¹è±¡
      Thief t = new Thief("12");
      //åˆ›å»ºè­¦å¯Ÿå¯¹è±¡
      Policemen p = new Policemen("66");
      //è®©è­¦å¯Ÿç›¯ç€å°å·
      t.addObserver(p);
      //å°å·å·ä¸œè¥¿
      t.steal();
  }
  ```

  

***



### ä¸­ä»‹è€…

#### åŸºæœ¬ä»‹ç»

ä¸­ä»‹è€…æ¨¡å¼ï¼šåˆå«è°ƒåœæ¨¡å¼ï¼Œå®šä¹‰ä¸€ä¸ªä¸­ä»‹è§’è‰²æ¥å°è£…ä¸€ç³»åˆ—å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œä½¿åŸæœ‰å¯¹è±¡ä¹‹é—´çš„è€¦åˆæ¾æ•£ï¼Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’
<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ä¸­ä»‹è€…æ¨¡å¼.png" style="zoom:67%;" />

ä¸­ä»‹è€…æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡ä¸­ä»‹è€…ï¼ˆMediatorï¼‰è§’è‰²ï¼šä¸­ä»‹è€…çš„æ¥å£ï¼Œæä¾›äº†åŒäº‹å¯¹è±¡æ³¨å†Œä¸è½¬å‘åŒäº‹å¯¹è±¡ä¿¡æ¯çš„æŠ½è±¡æ–¹æ³•
* å…·ä½“ä¸­ä»‹è€…ï¼ˆConcreteMediatorï¼‰è§’è‰²ï¼šå®ç°ä¸­ä»‹è€…æ¥å£ï¼Œå®šä¹‰ä¸€ä¸ª List æ¥ç®¡ç†åŒäº‹å¯¹è±¡ï¼Œåè°ƒå„ä¸ªåŒäº‹è§’è‰²ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œå› æ­¤ä¾èµ–äºåŒäº‹è§’è‰²
* æŠ½è±¡åŒäº‹ç±»ï¼ˆColleagueï¼‰è§’è‰²ï¼šå®šä¹‰åŒäº‹ç±»çš„æ¥å£ï¼Œä¿å­˜ä¸­ä»‹è€…å¯¹è±¡ï¼Œæä¾›åŒäº‹å¯¹è±¡äº¤äº’çš„æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ‰€æœ‰ç›¸äº’å½±å“çš„åŒäº‹ç±»çš„å…¬å…±åŠŸèƒ½
* å…·ä½“åŒäº‹ç±»ï¼ˆConcrete Colleagueï¼‰è§’è‰²ï¼šæ˜¯æŠ½è±¡åŒäº‹ç±»çš„å®ç°è€…ï¼Œå½“éœ€è¦ä¸å…¶ä»–åŒäº‹å¯¹è±¡äº¤äº’æ—¶ï¼Œç”±ä¸­ä»‹è€…å¯¹è±¡è´Ÿè´£åç»­çš„äº¤äº’

æ¨¡å¼ä¼˜ç‚¹ï¼š

* æ¾æ•£è€¦åˆï¼šä¸­ä»‹è€…æ¨¡å¼é€šè¿‡æŠŠå¤šä¸ªåŒäº‹å¯¹è±¡ä¹‹é—´çš„äº¤äº’å°è£…åˆ°ä¸­ä»‹è€…å¯¹è±¡é‡Œé¢ï¼Œä»è€Œä½¿å¾—åŒäº‹å¯¹è±¡ä¹‹é—´æ¾æ•£è€¦åˆï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åšåˆ°äº’è¡¥ä¾èµ–ï¼ŒåŒäº‹å¯¹è±¡å°±å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–å’Œå¤ç”¨

* é›†ä¸­æ§åˆ¶äº¤äº’ï¼šå¤šä¸ªåŒäº‹å¯¹è±¡çš„äº¤äº’ï¼Œè¢«å°è£…åœ¨ä¸­ä»‹è€…å¯¹è±¡é‡Œé¢é›†ä¸­ç®¡ç†ï¼Œä½¿å¾—è¿™äº›äº¤äº’è¡Œä¸ºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹ä¸­ä»‹è€…å¯¹è±¡å°±å¯ä»¥ï¼Œå¦‚æœæ˜¯å·²ç»åšå¥½çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆå°±æ‰©å±•ä¸­ä»‹è€…å¯¹è±¡ï¼Œè€Œå„ä¸ªåŒäº‹ç±»ä¸éœ€è¦åšä¿®æ”¹

* ä¸€å¯¹å¤šå…³è”è½¬å˜ä¸ºä¸€å¯¹ä¸€çš„å…³è”ï¼šæ²¡æœ‰ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼çš„æ—¶å€™ï¼ŒåŒäº‹å¯¹è±¡ä¹‹é—´çš„å…³ç³»é€šå¸¸æ˜¯ä¸€å¯¹å¤šçš„ï¼Œå¼•å…¥ä¸­ä»‹è€…å¯¹è±¡ä»¥åï¼Œä¸­ä»‹è€…å¯¹è±¡å’ŒåŒäº‹å¯¹è±¡çš„å…³ç³»é€šå¸¸å˜æˆåŒå‘çš„ä¸€å¯¹ä¸€ï¼Œè¿™ä¼šè®©å¯¹è±¡çš„å…³ç³»æ›´å®¹æ˜“ç†è§£å’Œå®ç°

æ¨¡å¼ç¼ºç‚¹ï¼šå½“åŒäº‹ç±»å¤ªå¤šæ—¶ï¼Œä¸­ä»‹è€…çš„èŒè´£å°†å¾ˆå¤§ï¼Œä¼šå˜å¾—å¤æ‚è€Œåºå¤§ï¼Œä»¥è‡³äºç³»ç»Ÿéš¾ä»¥ç»´æŠ¤

åº”ç”¨åœºæ™¯ï¼š

* ç³»ç»Ÿä¸­å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤æ‚çš„å¼•ç”¨å…³ç³»ï¼Œç³»ç»Ÿç»“æ„æ··ä¹±ä¸”éš¾ä»¥ç†è§£ã€‚
* å½“æƒ³åˆ›å»ºä¸€ä¸ªè¿è¡Œäºå¤šä¸ªç±»ä¹‹é—´çš„å¯¹è±¡ï¼Œåˆä¸æƒ³ç”Ÿæˆæ–°çš„å­ç±»æ—¶



****



#### ä»£ç å®ç°

æ¡ˆä¾‹ï¼šé€šè¿‡æˆ¿å±‹ä¸­ä»‹ç§Ÿæˆ¿

* æŠ½è±¡ä¸­ä»‹è€…ï¼š

  ```java
  public abstract class Mediator {
      //ç”³æ˜ä¸€ä¸ªè”ç»œæ–¹æ³•
      public abstract void constact(String message,Person person);
  }
  ```

* æŠ½è±¡åŒäº‹ç±»ï¼š

  ```java
  public abstract class Person {
      protected String name;
      protected Mediator mediator;
  
      public Person(String name, Mediator mediator){
          this.name = name;
          this.mediator = mediator;
      }
  }
  ```

* å…·ä½“åŒäº‹ç±»ï¼š

  ```java
  // æˆ¿å±‹æ‹¥æœ‰è€…
  public class HouseOwner extends Person {
      public HouseOwner(String name, Mediator mediator) {
          super(name, mediator);
      }
      //ä¸ä¸­ä»‹è€…è”ç³»
      public void constact(String message){
          mediator.constact(message, this);
      }
      //è·å–ä¿¡æ¯
      public void getMessage(String message){
          System.out.println("æˆ¿ä¸»" + name +"è·å–åˆ°çš„ä¿¡æ¯ï¼š" + message);
      }
  }
  //æ‰¿ç§Ÿäºº
  public class Tenant extends Person {
      public Tenant(String name, Mediator mediator) {
          super(name, mediator);
      }
      //ä¸ä¸­ä»‹è€…è”ç³»
      public void constact(String message){
          mediator.constact(message, this);
      }
      //è·å–ä¿¡æ¯
      public void getMessage(String message){
          System.out.println("ç§Ÿæˆ¿è€…" + name +"è·å–åˆ°çš„ä¿¡æ¯ï¼š" + message);
      }
  }
  ```

* å…·ä½“ä¸­ä»‹è€…ï¼š

  ```java
  public class MediatorStructure extends Mediator {
      //é¦–å…ˆä¸­ä»‹ç»“æ„å¿…é¡»çŸ¥é“æ‰€æœ‰æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…çš„ä¿¡æ¯
      private HouseOwner houseOwner;
      private Tenant tenant;
  	//set + get
      
      public void constact(String message, Person person) {
          if (person == houseOwner) {		//å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œåˆ™ç§Ÿæˆ¿è€…è·å¾—ä¿¡æ¯
              tenant.getMessage(message);
          } else {       //åæ­£åˆ™æ˜¯æˆ¿ä¸»è·å¾—ä¿¡æ¯
              houseOwner.getMessage(message);
          }
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //ä¸€ä¸ªæˆ¿ä¸»ã€ä¸€ä¸ªç§Ÿæˆ¿è€…ã€ä¸€ä¸ªä¸­ä»‹æœºæ„
      MediatorStructure mediator = new MediatorStructure();
  
      //æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…åªéœ€è¦çŸ¥é“ä¸­ä»‹æœºæ„å³å¯
      HouseOwner houseOwner = new HouseOwner("å¼ ä¸‰", mediator);
      Tenant tenant = new Tenant("æå››", mediator);
  
      //ä¸­ä»‹ç»“æ„è¦çŸ¥é“æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…
      mediator.setHouseOwner(houseOwner);
      mediator.setTenant(tenant);
  
      tenant.constact("éœ€è¦ç§Ÿä¸‰å®¤çš„æˆ¿å­");
      houseOwner.constact("æˆ‘è¿™æœ‰ä¸‰å®¤çš„æˆ¿å­ï¼Œä½ éœ€è¦ç§Ÿå—ï¼Ÿ");
  }
  ```



****



### è¿­ä»£å™¨

#### åŸºæœ¬ä»‹ç»

è¿­ä»£å™¨æ¨¡å¼ï¼šæä¾›ä¸€ä¸ªå¯¹è±¡æ¥é¡ºåºè®¿é—®èšåˆå¯¹è±¡ä¸­çš„ä¸€ç³»åˆ—æ•°æ®ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤º

è¿­ä»£å™¨æ¨¡å¼ä¸»è¦åŒ…å«ä»¥ä¸‹è§’è‰²ï¼š

* æŠ½è±¡èšåˆï¼ˆAggregateï¼‰è§’è‰²ï¼šå®šä¹‰å­˜å‚¨ã€æ·»åŠ ã€åˆ é™¤èšåˆå…ƒç´ ä»¥åŠåˆ›å»ºè¿­ä»£å™¨å¯¹è±¡çš„æ¥å£

* å…·ä½“èšåˆï¼ˆConcreteAggregateï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡èšåˆç±»ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“è¿­ä»£å™¨çš„å®ä¾‹
* æŠ½è±¡è¿­ä»£å™¨ï¼ˆIteratorï¼‰è§’è‰²ï¼šå®šä¹‰è®¿é—®å’Œéå†èšåˆå…ƒç´ çš„æ¥å£ï¼Œé€šå¸¸åŒ…å« hasNext()ã€next() ç­‰æ–¹æ³•
* å…·ä½“è¿­ä»£å™¨ï¼ˆConcretelteratorï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡è¿­ä»£å™¨æ¥å£ä¸­æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå®Œæˆå¯¹èšåˆå¯¹è±¡çš„éå†ï¼Œè®°å½•éå†çš„å½“å‰ä½ç½®

æ¨¡å¼ä¼˜ç‚¹ï¼š

* æ”¯æŒä»¥ä¸åŒçš„æ–¹å¼éå†ä¸€ä¸ªèšåˆå¯¹è±¡ï¼Œåœ¨è¿­ä»£å™¨æ¨¡å¼ä¸­åªè¦ç”¨ä¸€ä¸ªä¸åŒçš„è¿­ä»£å™¨æ¥æ›¿æ¢åŸæœ‰è¿­ä»£å™¨å³å¯æ”¹å˜éå†ç®—æ³•ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰è¿­ä»£å™¨çš„å­ç±»ä»¥æ”¯æŒæ–°çš„éå†æ–¹å¼
* è¿­ä»£å™¨ç®€åŒ–äº†èšåˆç±»ï¼Œåœ¨åŸæœ‰çš„èšåˆå¯¹è±¡ä¸­ä¸éœ€è¦å†è‡ªè¡Œæä¾›æ•°æ®éå†ç­‰æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–èšåˆç±»çš„è®¾è®¡
* åœ¨è¿­ä»£å™¨æ¨¡å¼ä¸­ï¼Œç”±äºå¼•å…¥äº†æŠ½è±¡å±‚ï¼Œå¢åŠ æ–°çš„èšåˆç±»å’Œè¿­ä»£å™¨ç±»éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰ä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™çš„è¦æ±‚

æ¨¡å¼ç¼ºç‚¹ï¼šå¢åŠ äº†ç±»çš„ä¸ªæ•°ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚



****



#### ä»£ç å®ç°

å®šä¹‰ä¸€ä¸ªå¯ä»¥å­˜å‚¨å­¦ç”Ÿå¯¹è±¡çš„å®¹å™¨å¯¹è±¡ï¼Œå°†éå†è¯¥å®¹å™¨çš„åŠŸèƒ½äº¤ç”±è¿­ä»£å™¨å®ç°

* è¿­ä»£å™¨æ¥å£ï¼š

  ```java
  public interface StudentIterator {
      //åˆ¤æ–­æ˜¯å¦è¿˜æœ‰å…ƒç´ 
      boolean hasNext();
      //è·å–ä¸‹ä¸€ä¸ªå…ƒç´ 
      Student next();
  }
  ```

* å…·ä½“çš„è¿­ä»£å™¨ç±»ï¼Œé‡å†™æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•ï¼š

  ```java
  public class StudentIteratorImpl implements StudentIterator {
      private List<Student> list;
      private int position = 0;//ç”¨æ¥è®°å½•éå†æ—¶çš„ä½ç½®
  
      public StudentIteratorImpl(List<Student> list) {
          this.list = list;
      }
  
      @Override
      public boolean hasNext() {
          return position < list.size();
      }
  
      @Override
      public Student next() {
          Student currentStudent = list.get(position);
          position ++;
          return currentStudent;
      }
  }
  ```

* æŠ½è±¡å®¹å™¨ç±»ï¼š

  ```java
  public interface StudentAggregate {
      void addStudent(Student student);
      void removeStudent(Student student);
      StudentIterator getStudentIterator();
  }
  ```

* å…·ä½“å®¹å™¨ç±»ï¼š

  ```java
  public class StudentAggregateImpl implements StudentAggregate {
      private List<Student> list = new ArrayList<Student>();  // å­¦ç”Ÿåˆ—è¡¨
  
      @Override
      public void addStudent(Student student) {
          this.list.add(student);
      }
  
      @Override
      public void removeStudent(Student student) {
          this.list.remove(student);
      }
  
      @Override
      public StudentIterator getStudentIterator() {
          return new StudentIteratorImpl(list);
      }
  }
  ```



***



#### åº”ç”¨åœºæ™¯

ä½¿ç”¨åœºæ™¯ï¼š

* éœ€è¦ä¸ºèšåˆå¯¹è±¡æä¾›å¤šç§éå†æ–¹å¼
* éœ€è¦ä¸ºéå†ä¸åŒçš„èšåˆç»“æ„æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£
* è®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡çš„å†…å®¹è€Œæ— é¡»æš´éœ²å…¶å†…éƒ¨ç»†èŠ‚çš„è¡¨ç¤º

ä½¿ç”¨ JAVA å¼€å‘çš„æ—¶å€™ï¼Œæƒ³ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼ï¼Œåªè¦è®©è‡ªå®šä¹‰çš„å®¹å™¨ç±»å®ç° `java.util.Iterable` å¹¶å®ç°å…¶ä¸­çš„iterator() æ–¹æ³•ä½¿å…¶è¿”å›ä¸€ä¸ª `java.util.Iterator` çš„å®ç°ç±»å°±å¯ä»¥



****



### è®¿é—®è€…

#### åŸºæœ¬ä»‹ç»

è®¿é—®è€…æ¨¡å¼ï¼šå°è£…ä¸€äº›ä½œç”¨äºæŸç§æ•°æ®ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜è¿™ä¸ªæ•°æ®ç»“æ„çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œ

è®¿é—®è€…æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²:

* æŠ½è±¡è®¿é—®è€…ï¼ˆVisitorï¼‰è§’è‰²ï¼šå®šä¹‰äº†å¯¹æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆElementï¼‰è®¿é—®çš„è¡Œä¸ºï¼Œå®ƒçš„å‚æ•°å°±æ˜¯å¯ä»¥è®¿é—®çš„å…ƒç´ ï¼Œå®ƒçš„æ–¹æ³•ä¸ªæ•°ç†è®ºä¸Šæ¥è®²ä¸å…ƒç´ ç±»ä¸ªæ•°ï¼ˆElement çš„å®ç°ç±»ä¸ªæ•°ï¼‰æ˜¯ä¸€æ ·çš„ï¼Œä»è¿™ç‚¹ä¸éš¾çœ‹å‡ºï¼Œè®¿é—®è€…æ¨¡å¼è¦æ±‚å…ƒç´ ç±»çš„ä¸ªæ•°ä¸èƒ½æ”¹å˜
* å…·ä½“è®¿é—®è€…ï¼ˆConcreteVisitorï¼‰è§’è‰²ï¼šç»™å‡ºå¯¹æ¯ä¸€ä¸ªå…ƒç´ ç±»è®¿é—®æ—¶æ‰€äº§ç”Ÿçš„å…·ä½“è¡Œä¸º
* æŠ½è±¡å…ƒç´ ï¼ˆElementï¼‰è§’è‰²ï¼šå®šä¹‰äº†ä¸€ä¸ªæ¥å—è®¿é—®è€…çš„æ–¹æ³•ï¼ˆacceptï¼‰ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½å¯ä»¥è¢«è®¿é—®è€…è®¿é—®
* å…·ä½“å…ƒç´ ï¼ˆConcreteElementï¼‰è§’è‰²ï¼š æä¾›æ¥å—è®¿é—®æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œè€Œè¿™ä¸ªå…·ä½“çš„å®ç°ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯ä½¿ç”¨è®¿é—®è€…æä¾›çš„è®¿é—®è¯¥å…ƒç´ ç±»çš„æ–¹æ³•
* å¯¹è±¡ç»“æ„ï¼ˆObject Structureï¼‰è§’è‰²ï¼šå®šä¹‰å½“ä¸­æ‰€æåˆ°çš„å¯¹è±¡ç»“æ„ï¼Œå¯¹è±¡ç»“æ„æ˜¯ä¸€ä¸ªæŠ½è±¡è¡¨è¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…·æœ‰å®¹å™¨æ€§è´¨æˆ–è€…å¤åˆå¯¹è±¡ç‰¹æ€§çš„ç±»ï¼Œå®ƒå«æœ‰ä¸€ç»„å…ƒç´ å¹¶ä¸”å¯ä»¥è¿­ä»£è¿™äº›å…ƒç´ ï¼Œä¾›è®¿é—®è€…è®¿é—®

æ¨¡å¼ä¼˜ç‚¹ï¼š

* æ‰©å±•æ€§å¥½ï¼Œåœ¨ä¸ä¿®æ”¹å¯¹è±¡ç»“æ„ä¸­çš„å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œä¸ºå¯¹è±¡ç»“æ„ä¸­çš„å…ƒç´ æ·»åŠ æ–°çš„åŠŸèƒ½

* å¤ç”¨æ€§å¥½ï¼Œé€šè¿‡è®¿é—®è€…æ¥å®šä¹‰æ•´ä¸ªå¯¹è±¡ç»“æ„é€šç”¨çš„åŠŸèƒ½ï¼Œä»è€Œæé«˜å¤ç”¨ç¨‹åº¦

* åˆ†ç¦»æ— å…³è¡Œä¸ºï¼Œé€šè¿‡è®¿é—®è€…æ¥åˆ†ç¦»æ— å…³çš„è¡Œä¸ºï¼ŒæŠŠç›¸å…³çš„è¡Œä¸ºå°è£…åœ¨ä¸€èµ·æ„æˆä¸€ä¸ªè®¿é—®è€…ï¼Œè¿™æ ·æ¯ä¸€ä¸ªè®¿é—®è€…çš„åŠŸèƒ½éƒ½æ¯”è¾ƒå•ä¸€

æ¨¡å¼ç¼ºç‚¹ï¼š

* å¯¹è±¡ç»“æ„å˜åŒ–å¾ˆå›°éš¾ï¼Œåœ¨è®¿é—®è€…æ¨¡å¼ä¸­ï¼Œæ¯å¢åŠ ä¸€ä¸ªæ–°çš„å…ƒç´ ç±»ï¼Œéƒ½è¦åœ¨æ¯ä¸€ä¸ªå…·ä½“è®¿é—®è€…ç±»ä¸­å¢åŠ ç›¸åº”çš„å…·ä½“æ“ä½œï¼Œè¿™è¿èƒŒäº†å¼€é—­åŸåˆ™
* è¿åäº†ä¾èµ–å€’ç½®åŸåˆ™ï¼Œè®¿é—®è€…æ¨¡å¼ä¾èµ–äº†å…·ä½“ç±»ï¼Œè€Œæ²¡æœ‰ä¾èµ–æŠ½è±¡ç±»

åº”ç”¨åœºæ™¯ï¼š

* å¯¹è±¡ç»“æ„ç›¸å¯¹ç¨³å®šï¼Œä½†å…¶æ“ä½œç®—æ³•ç»å¸¸å˜åŒ–çš„ç¨‹åº

* å¯¹è±¡ç»“æ„ä¸­çš„å¯¹è±¡éœ€è¦æä¾›å¤šç§ä¸åŒä¸”ä¸ç›¸å…³çš„æ“ä½œï¼Œè€Œä¸”è¦é¿å…è®©è¿™äº›æ“ä½œçš„å˜åŒ–å½±å“å¯¹è±¡çš„ç»“æ„



***



#### ä»£ç å®ç°

ä»¥ç»™å® ç‰©å–‚é£Ÿä¸ºä¾‹ï¼Œå½“ç„¶å® ç‰©è¿˜åˆ†ä¸ºç‹—ï¼ŒçŒ«ç­‰ï¼Œè¦ç»™å® ç‰©å–‚é£Ÿçš„è¯ï¼Œä¸»äººå¯ä»¥å–‚ï¼Œå…¶ä»–äººä¹Ÿå¯ä»¥å–‚é£Ÿ

- è®¿é—®è€…è§’è‰²ï¼šç»™å® ç‰©å–‚é£Ÿçš„äºº
- å…·ä½“è®¿é—®è€…è§’è‰²ï¼šä¸»äººã€å…¶ä»–äºº
- æŠ½è±¡å…ƒç´ è§’è‰²ï¼šåŠ¨ç‰©æŠ½è±¡ç±»
- å…·ä½“å…ƒç´ è§’è‰²ï¼šå® ç‰©ç‹—ã€å® ç‰©çŒ«
- ç»“æ„å¯¹è±¡è§’è‰²ï¼šä¸»äººå®¶

![](https://gitee.com/seazean/images/raw/master/Java/Design-è®¿é—®è€…æ¨¡å¼.png)

* æŠ½è±¡è®¿é—®è€…æ¥å£ï¼š

  ```java
  public interface Person {
      void feed(Cat cat);
      void feed(Dog dog);
  }
  ```

* å…·ä½“è®¿é—®è€…è§’è‰²ï¼Œéœ€è¦å®ç° Person æ¥å£ï¼š

  ```java
  public class Owner implements Person {
      @Override
      public void feed(Cat cat) {
          System.out.println("ä¸»äººå–‚é£ŸçŒ«");
      }
      @Override
      public void feed(Dog dog) {
          System.out.println("ä¸»äººå–‚é£Ÿç‹—");
      }
  }
  ```

* æŠ½è±¡å…ƒç´ æ¥å£ï¼š

  ```java
  public interface Animal {
      void accept(Person person);
  }
  ```

* å…·ä½“å…ƒç´ è§’è‰²ï¼š

  ```java
  public class Dog implements Animal {
      @Override
      public void accept(Person person) {
          person.feed(this);
          System.out.println("æ±ªæ±ªæ±ªï¼ï¼ï¼");
      }
  }
  
  public class Cat implements Animal {
      @Override
      public void accept(Person person) {
          person.feed(this);
          System.out.println("å–µå–µå–µï¼ï¼ï¼");
      }
  }
  ```

* å¯¹è±¡ç»“æ„ï¼Œæ­¤æ¡ˆä¾‹ä¸­æ˜¯ä¸»äººçš„å®¶ï¼š

  ```java
  public class Home {
      private List<Animal> nodeList = new ArrayList<Animal>();
      
      public void action(Person person) {
          for (Animal node : nodeList) {
              node.accept(person);
          }
      }
      //æ·»åŠ æ“ä½œ
      public void add(Animal animal) {
          nodeList.add(animal);
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      Home home = new Home();
      home.add(new Dog());
      home.add(new Cat());
  
      Owner owner = new Owner();
      home.action(owner);
  }
  ```

  

***



#### åˆ†æ´¾æœºåˆ¶

è®¿é—®è€…æ¨¡å¼ç”¨åˆ°äº†ä¸€ç§åŒåˆ†æ´¾çš„æŠ€æœ¯

å˜é‡è¢«å£°æ˜æ—¶çš„ç±»å‹å«åšå˜é‡çš„é™æ€ç±»å‹ï¼Œä¹Ÿå«åšæ˜æ˜¾ç±»å‹ï¼›è€Œå˜é‡æ‰€å¼•ç”¨çš„å¯¹è±¡çš„çœŸå®ç±»å‹åˆå«åšå˜é‡çš„å®é™…ç±»å‹ã€‚æ¯”å¦‚ `Map map = new HashMap()` ï¼Œmapå˜é‡çš„é™æ€ç±»å‹æ˜¯ `Map` ï¼Œå®é™…ç±»å‹æ˜¯ `HashMap` ã€‚æ ¹æ®å¯¹è±¡çš„ç±»å‹è€Œå¯¹æ–¹æ³•è¿›è¡Œçš„é€‰æ‹©ï¼Œå°±æ˜¯åˆ†æ´¾(Dispatch)ï¼Œåˆ†æ´¾(Dispatch)åˆåˆ†ä¸ºä¸¤ç§ï¼Œå³é™æ€åˆ†æ´¾å’ŒåŠ¨æ€åˆ†æ´¾

* é™æ€åˆ†æ´¾(Static Dispatch)ï¼šå‘ç”Ÿåœ¨ç¼–è¯‘æ—¶æœŸï¼Œæ ¹æ®é™æ€ç±»å‹ä¿¡æ¯åˆ†æ´¾ï¼Œæ–¹æ³•é‡è½½å°±æ˜¯é™æ€åˆ†æ´¾
* åŠ¨æ€åˆ†æ´¾(Dynamic Dispatch)ï¼šå‘ç”Ÿåœ¨è¿è¡Œæ—¶æœŸï¼ŒåŠ¨æ€åœ°ç½®æ¢æ‰æŸä¸ªæ–¹æ³•ï¼Œé€šè¿‡æ–¹æ³•é‡å†™æ”¯æŒåŠ¨æ€åˆ†æ´¾

åŒåˆ†æ´¾æŠ€æœ¯æ˜¯åœ¨é€‰æ‹©ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä¸ä»…è¦æ ¹æ®æ¶ˆæ¯æ¥æ”¶è€…çš„è¿è¡Œæ—¶åŒºåˆ«ï¼Œè¿˜è¦æ ¹æ®å‚æ•°çš„è¿è¡Œæ—¶åŒºåˆ«ã€‚åŒåˆ†æ´¾å®ç°åŠ¨æ€ç»‘å®šçš„æœ¬è´¨ï¼Œå°±æ˜¯åœ¨é‡è½½æ–¹æ³•å§”æ´¾çš„å‰åŠ ä¸Šç»§æ‰¿ä½“ç³»ä¸­è¦†ç›–çš„ç¯èŠ‚ï¼Œç”±äºè¦†ç›–æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥é‡è½½æ˜¯åŠ¨æ€çš„



***



### å¤‡å¿˜å½•

#### åŸºæœ¬ä»‹ç»

å¤‡å¿˜å½•æ¨¡å¼ï¼šåˆå«å¿«ç…§æ¨¡å¼ï¼Œåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä»¥åå½“éœ€è¦æ—¶èƒ½å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€

å¤‡å¿˜å½•æ¨¡å¼æä¾›äº†ä¸€ç§çŠ¶æ€æ¢å¤çš„å®ç°æœºåˆ¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°å›åˆ°ä¸€ä¸ªç‰¹å®šçš„å†å²æ­¥éª¤ï¼Œå½“æ–°çš„çŠ¶æ€æ— æ•ˆæˆ–è€…å­˜åœ¨é—®é¢˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æš‚æ—¶å­˜å‚¨èµ·æ¥çš„å¤‡å¿˜å½•å°†çŠ¶æ€å¤åŸã€‚å¾ˆå¤šè½¯ä»¶éƒ½æä¾›äº†æ’¤é”€ï¼ˆUndoï¼‰æ“ä½œï¼Œä½¿æ–‡æ¡£æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼›æ¯”å¦‚æ•°æ®åº“äº‹åŠ¡ç®¡ç†ä¸­çš„å›æ»šæ“ä½œã€ç©æ¸¸æˆæ—¶çš„å­˜æ¡£åŠŸèƒ½ã€æ£‹ç±»æ¸¸æˆä¸­çš„æ‚”æ£‹åŠŸèƒ½ç­‰éƒ½å±äºè¿™ç±»

å¤‡å¿˜å½•æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š

* å‘èµ·äººï¼ˆOriginatorï¼‰è§’è‰²ï¼šè®°å½•å½“å‰æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼Œæä¾›åˆ›å»ºå¤‡å¿˜å½•å’Œæ¢å¤å¤‡å¿˜å½•æ•°æ®çš„åŠŸèƒ½ï¼Œå®ç°å…¶ä»–ä¸šåŠ¡åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è®¿é—®å¤‡å¿˜å½•é‡Œçš„æ‰€æœ‰ä¿¡æ¯
* å¤‡å¿˜å½•ï¼ˆMementoï¼‰è§’è‰²ï¼šè´Ÿè´£å­˜å‚¨å‘èµ·äººçš„å†…éƒ¨çŠ¶æ€ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æä¾›è¿™äº›å†…éƒ¨çŠ¶æ€ç»™å‘èµ·äºº
* ç®¡ç†è€…ï¼ˆCaretakerï¼‰è§’è‰²ï¼šå¯¹å¤‡å¿˜å½•è¿›è¡Œç®¡ç†ï¼Œæä¾›ä¿å­˜ä¸è·å–å¤‡å¿˜å½•çš„åŠŸèƒ½ï¼Œä½†å…¶ä¸èƒ½å¯¹å¤‡å¿˜å½•çš„å†…å®¹è¿›è¡Œè®¿é—®ä¸ä¿®æ”¹

å¤‡å¿˜å½•æœ‰ä¸¤ä¸ªç­‰æ•ˆçš„æ¥å£ï¼š

* çª„æ¥å£ï¼šç®¡ç†è€…å¯¹è±¡çœ‹åˆ°çš„æ˜¯å¤‡å¿˜å½•çš„çª„æ¥å£(narror Interface)ï¼Œåªå…è®¸ä»–æŠŠå¤‡å¿˜å½•å¯¹è±¡ä¼ ç»™å…¶ä»–çš„å¯¹è±¡
* å®½æ¥å£ï¼šä¸ç®¡ç†è€…çœ‹åˆ°çš„çª„æ¥å£ç›¸åï¼Œå‘èµ·äººå¯¹è±¡å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå®½æ¥å£(wide Interface)ï¼Œè¿™ä¸ªå®½æ¥å£å…è®¸å®ƒè¯»å–æ‰€æœ‰çš„æ•°æ®ï¼Œä»¥ä¾¿æ ¹æ®è¿™äº›æ•°æ®æ¢å¤è¿™ä¸ªå‘èµ·äººå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€

æ¨¡å¼ä¼˜ç‚¹ï¼š

- æä¾›äº†ä¸€ç§å¯ä»¥æ¢å¤çŠ¶æ€çš„æœºåˆ¶ï¼Œå½“ç”¨æˆ·éœ€è¦æ—¶èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å°†æ•°æ®æ¢å¤åˆ°æŸä¸ªå†å²çš„çŠ¶æ€
- å®ç°äº†å†…éƒ¨çŠ¶æ€çš„å°è£…ï¼Œé™¤äº†åˆ›å»ºå®ƒçš„å‘èµ·äººä¹‹å¤–ï¼Œå…¶ä»–å¯¹è±¡éƒ½ä¸èƒ½å¤Ÿè®¿é—®è¿™äº›çŠ¶æ€ä¿¡æ¯
- ç®€åŒ–äº†å‘èµ·äººç±»ï¼Œå‘èµ·äººä¸éœ€è¦ç®¡ç†å’Œä¿å­˜å…¶å†…éƒ¨çŠ¶æ€çš„å„ä¸ªå¤‡ä»½ï¼Œæ‰€æœ‰çŠ¶æ€ä¿¡æ¯éƒ½ä¿å­˜åœ¨å¤‡å¿˜å½•ä¸­ï¼Œå¹¶ç”±ç®¡ç†è€…è¿›è¡Œç®¡ç†ï¼Œè¿™ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

æ¨¡å¼ç¼ºç‚¹ï¼šèµ„æºæ¶ˆè€—å¤§ï¼Œå¦‚æœè¦ä¿å­˜çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯è¿‡å¤šæˆ–è€…ç‰¹åˆ«é¢‘ç¹ï¼Œå°†ä¼šå ç”¨æ¯”è¾ƒå¤§çš„å†…å­˜èµ„æº

ä½¿ç”¨åœºæ™¯ï¼š

* éœ€è¦ä¿å­˜ä¸æ¢å¤æ•°æ®çš„åœºæ™¯ï¼Œå¦‚ç©æ¸¸æˆæ—¶çš„ä¸­é—´ç»“æœçš„å­˜æ¡£åŠŸèƒ½

* éœ€è¦æä¾›ä¸€ä¸ªå¯å›æ»šæ“ä½œçš„åœºæ™¯ï¼Œå¦‚æŒ‰ Ctrl+Z ç»„åˆé”®



***



#### ä»£ç å®ç°

##### ç™½ç®±æ¨¡å¼

å¤‡å¿˜å½•è§’è‰²å¯¹ä»»ä½•å¯¹è±¡éƒ½æä¾›ä¸€ä¸ªæ¥å£ï¼Œå³å®½æ¥å£ï¼Œå¤‡å¿˜å½•è§’è‰²çš„å†…éƒ¨æ‰€å­˜å‚¨çš„çŠ¶æ€å°±å¯¹æ‰€æœ‰å¯¹è±¡å…¬å¼€

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-ç™½ç®±å¤‡å¿˜å½•æ¨¡å¼.png" style="zoom: 67%;" />

* å‘èµ·äººç±»ï¼Œæ¸¸æˆè§’è‰²ç±»ï¼š

  ```java
  public class GameRole {
      private int vit; //ç”Ÿå‘½åŠ›
      private int atk; //æ”»å‡»åŠ›
      private int def; //é˜²å¾¡åŠ›
      // set + get 
  
      //åˆå§‹åŒ–çŠ¶æ€
      public void initState() {
          this.vit = 100;
          this.atk = 100;
          this.def = 100;
      }
      //æˆ˜æ–—åçš„çŠ¶æ€
      public void fight() {
          this.vit = 0;
          this.atk = 0;
          this.def = 0;
      }
  
      //ä¿å­˜è§’è‰²çŠ¶æ€
      public RoleStateMemento saveState() {
          return new RoleStateMemento(vit, atk, def);
      }
      //æ¢å¤è§’è‰²çŠ¶æ€
      public void recoverState(RoleStateMemento roleStateMemento) {
          this.vit = roleStateMemento.getVit();
          this.atk = roleStateMemento.getAtk();
          this.def = roleStateMemento.getDef();
      }
  	//å±•ç¤ºè§’è‰²çŠ¶æ€
      public void stateDisplay() {
          System.out.println("è§’è‰²ç”Ÿå‘½åŠ›ï¼š" + vit);
          System.out.println("è§’è‰²æ”»å‡»åŠ›ï¼š" + atk);
          System.out.println("è§’è‰²é˜²å¾¡åŠ›ï¼š" + def);
      }
  }
  ```

* å¤‡å¿˜å½•ç±»ï¼Œæ¸¸æˆçŠ¶æ€å­˜å‚¨ç±»ï¼š

  ```java
  public class RoleStateMemento {
      private int vit;
      private int atk;
      private int def;
      // construct +set + get 
  }
  ```

* è§’è‰²çŠ¶æ€ç®¡ç†è€…ç±»ï¼š

  ```java
  public class RoleStateCaretaker {
      private RoleStateMemento roleStateMemento;
      // get + set
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
  public static void main(String[] args) {
      //å¤§æˆ˜Bosså‰
      GameRole gameRole = new GameRole();
      gameRole.initState();
  
      //ä¿å­˜è¿›åº¦
      RoleStateCaretaker roleStateCaretaker = new RoleStateCaretaker();
      roleStateCaretaker.setRoleStateMemento(gameRole.saveState());
      
      //å¤§æˆ˜Bossæ—¶
      gameRole.fight();
  
      //æ¢å¤ä¹‹å‰çŠ¶æ€
      gameRole.recoverState(roleStateCaretaker.getRoleStateMemento());
      gameRole.stateDisplay();
  }
  ```

ç™½ç®±å¤‡å¿˜å½•æ¨¡å¼æ˜¯ç ´åå°è£…æ€§çš„ï¼Œä½†æ˜¯é€šè¿‡ç¨‹åºå‘˜è‡ªå¾‹ï¼ŒåŒæ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°æ¨¡å¼çš„å¤§éƒ¨åˆ†ç›®çš„



***



##### é»‘ç®±æ¨¡å¼

å¤‡å¿˜å½•è§’è‰²å¯¹å‘èµ·äººå¯¹è±¡æä¾›ä¸€ä¸ªå®½æ¥å£ï¼Œè€Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªçª„æ¥å£ã€‚åœ¨Javaè¯­è¨€ä¸­ï¼Œå®ç°åŒé‡æ¥å£çš„åŠæ³•å°±æ˜¯å°†å¤‡å¿˜å½•ç±»è®¾è®¡æˆå‘èµ·äººç±»çš„å†…éƒ¨æˆå‘˜ç±»

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-é»‘ç®±å¤‡å¿˜å½•æ¨¡å¼.png" style="zoom: 67%;" />

* çª„æ¥å£ Mementoï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼š

  ```java
  public interface Memento {}
  ```

* å‘èµ·äººç±» GameRoleï¼Œå¹¶åœ¨å†…éƒ¨å®šä¹‰å¤‡å¿˜å½•å†…éƒ¨ç±» RoleStateMementoï¼ˆè¯¥å†…éƒ¨ç±»è®¾ç½®ä¸ºç§æœ‰çš„ï¼‰ï¼š

  ```java
  public class GameRole {
      //.......
      private class RoleStateMemento implements Memento {
          private int vit;
          private int atk;
          private int def;
          // set + get
      }
  }
  ```

* è´Ÿè´£äººè§’è‰²ç±» RoleStateCaretaker å¾—åˆ°çš„å¤‡å¿˜å½•å¯¹è±¡æ˜¯ä»¥ Memento ä¸ºæ¥å£çš„ï¼Œç”±äºè¿™ä¸ªæ¥å£ä»…ä»…æ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œè´Ÿè´£äººè§’è‰²ä¸å¯èƒ½æ”¹å˜è¿™ä¸ªå¤‡å¿˜å½•å¯¹è±¡çš„å†…å®¹

  ```java
  public class RoleStateCaretaker {
      private Memento memento;
  	// set + get
  }
  ```



***



### è§£é‡Šå™¨

#### åŸºæœ¬ä»‹ç»

è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreter Patternï¼‰æä¾›äº†è¯„ä¼°è¯­è¨€çš„è¯­æ³•æˆ–è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­

è§£é‡Šå™¨æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ã€‚

* æŠ½è±¡è¡¨è¾¾å¼ï¼ˆAbstract Expressionï¼‰è§’è‰²ï¼šå®šä¹‰è§£é‡Šå™¨çš„æ¥å£ï¼Œçº¦å®šè§£é‡Šå™¨çš„è§£é‡Šæ“ä½œï¼Œä¸»è¦åŒ…å«è§£é‡Šæ–¹æ³• interpret()

* ç»ˆç»“ç¬¦è¡¨è¾¾å¼ï¼ˆTerminal  Expressionï¼‰è§’è‰²ï¼šæ˜¯æŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸ç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯ä¸€ä¸ªç»ˆç»“ç¬¦éƒ½æœ‰ä¸€ä¸ªå…·ä½“ç»ˆç»“è¡¨è¾¾å¼ä¸ä¹‹ç›¸å¯¹åº”
* éç»ˆç»“ç¬¦è¡¨è¾¾å¼ï¼ˆNonterminal Expressionï¼‰è§’è‰²ï¼šæŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸éç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡è§„åˆ™éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼
* ç¯å¢ƒï¼ˆContextï¼‰è§’è‰²ï¼šé€šå¸¸åŒ…å«å„ä¸ªè§£é‡Šå™¨éœ€è¦çš„æ•°æ®æˆ–æ˜¯å…¬å…±çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ é€’è¢«æ‰€æœ‰è§£é‡Šå™¨å…±äº«çš„æ•°æ®ï¼Œåé¢çš„è§£é‡Šå™¨å¯ä»¥ä»è¿™é‡Œè·å–è¿™äº›å€¼
* å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼šä¸»è¦ä»»åŠ¡æ˜¯å°†éœ€è¦åˆ†æçš„å¥å­æˆ–è¡¨è¾¾å¼è½¬æ¢æˆä½¿ç”¨è§£é‡Šå™¨å¯¹è±¡æè¿°çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åè°ƒç”¨è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒè§’è‰²é—´æ¥è®¿é—®è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•

æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstractSyntaxTreeï¼ŒASTï¼‰ï¼Œæˆ–ç®€ç§°è¯­æ³•æ ‘ï¼ˆSyntax treeï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºï¼Œä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„

ç”¨æ ‘å½¢æ¥è¡¨ç¤ºç¬¦åˆæ–‡æ³•è§„åˆ™çš„å¥å­ï¼š

<img src="https://gitee.com/seazean/images/raw/master/Java/Design-è§£é‡Šå™¨æ¨¡å¼è¯­æ³•æ ‘.png" style="zoom:33%;" />

æ¨¡å¼ä¼˜ç‚¹ï¼š

* æ˜“äºæ”¹å˜å’Œæ‰©å±•æ–‡æ³•ï¼Œç”±äºåœ¨è§£é‡Šå™¨æ¨¡å¼ä¸­ä½¿ç”¨ç±»æ¥è¡¨ç¤ºè¯­è¨€çš„æ–‡æ³•è§„åˆ™ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç»§æ‰¿ç­‰æœºåˆ¶æ¥æ”¹å˜æˆ–æ‰©å±•æ–‡æ³•ï¼Œæ¯ä¸€æ¡æ–‡æ³•è§„åˆ™éƒ½å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªç±»ï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿åœ°å®ç°ä¸€ä¸ªç®€å•çš„è¯­è¨€

* å®ç°æ–‡æ³•è¾ƒä¸ºå®¹æ˜“ï¼Œåœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸­æ¯ä¸€ä¸ªè¡¨è¾¾å¼èŠ‚ç‚¹ç±»çš„å®ç°æ–¹å¼éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œä»£ç ç¼–å†™ä¸ä¼šç‰¹åˆ«å¤æ‚

* å¢åŠ æ–°çš„è§£é‡Šè¡¨è¾¾å¼è¾ƒä¸ºæ–¹ä¾¿ï¼Œå¦‚æœç”¨æˆ·éœ€è¦å¢åŠ æ–°çš„è§£é‡Šè¡¨è¾¾å¼åªéœ€è¦å¯¹åº”å¢åŠ ä¸€ä¸ªæ–°çš„ç»ˆç»“ç¬¦è¡¨è¾¾å¼æˆ–éç»ˆç»“ç¬¦è¡¨è¾¾å¼ç±»ï¼ŒåŸæœ‰è¡¨è¾¾å¼ç±»ä»£ç æ— é¡»ä¿®æ”¹ï¼Œç¬¦åˆå¼€é—­åŸåˆ™

æ¨¡å¼ç¼ºç‚¹ï¼š

- å¯¹äºå¤æ‚æ–‡æ³•éš¾ä»¥ç»´æŠ¤ï¼Œåœ¨è§£é‡Šå™¨æ¨¡å¼ä¸­ï¼Œæ¯ä¸€æ¡è§„åˆ™è‡³å°‘éœ€è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œå› æ­¤å¦‚æœä¸€ä¸ªè¯­è¨€åŒ…å«å¤ªå¤šæ–‡æ³•è§„åˆ™ï¼Œç±»çš„ä¸ªæ•°å°†ä¼šæ€¥å‰§å¢åŠ ï¼Œå¯¼è‡´ç³»ç»Ÿéš¾ä»¥ç®¡ç†å’Œç»´æŠ¤
- æ‰§è¡Œæ•ˆç‡è¾ƒä½ï¼Œåœ¨è§£é‡Šå™¨æ¨¡å¼ä¸­ä½¿ç”¨äº†å¤§é‡çš„å¾ªç¯å’Œé€’å½’è°ƒç”¨ï¼Œå› æ­¤åœ¨è§£é‡Šè¾ƒä¸ºå¤æ‚çš„å¥å­æ—¶å…¶é€Ÿåº¦å¾ˆæ…¢ï¼Œè€Œä¸”ä»£ç çš„è°ƒè¯•è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒéº»çƒ¦

ä½¿ç”¨åœºæ™¯ï¼š

* å½“è¯­è¨€çš„æ–‡æ³•è¾ƒä¸ºç®€å•ï¼Œä¸”æ‰§è¡Œæ•ˆç‡ä¸æ˜¯å…³é”®é—®é¢˜æ—¶
* å½“é—®é¢˜é‡å¤å‡ºç°ï¼Œä¸”å¯ä»¥ç”¨ä¸€ç§ç®€å•çš„è¯­è¨€æ¥è¿›è¡Œè¡¨è¾¾æ—¶
* å½“ä¸€ä¸ªè¯­è¨€éœ€è¦è§£é‡Šæ‰§è¡Œï¼Œå¹¶ä¸”è¯­è¨€ä¸­çš„å¥å­å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘çš„æ—¶å€™



***



#### ä»£ç å®ç°

è®¾è®¡å®ç°åŠ å‡æ³•çš„è½¯ä»¶

* æŠ½è±¡è§’è‰²ç±»ï¼š

  ```java
  public abstract class AbstractExpression {
      public abstract int interpret(Context context);
  }
  ```

* ç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰²ï¼Œå˜é‡è¡¨è¾¾å¼ï¼š

  ```java
  public class Variable extends AbstractExpression {
      private String name;
  
      public Variable(String name) {
          this.name = name;
      }
  
      @Override
      public int interpret(Context ctx) {
          return ctx.getValue(this);
      }
  
      @Override
      public String toString() {
          return name;
      }
  }
  ```

* éç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰²ï¼š

  ```java
  //åŠ æ³•è¡¨è¾¾å¼
  public class Plus extends AbstractExpression {
      private AbstractExpression left;	// + å·¦è¾¹çš„è¡¨è¾¾å¼
      private AbstractExpression right;	// + å³è¾¹çš„è¡¨è¾¾å¼
  
      public Plus(AbstractExpression left, AbstractExpression right) {
          this.left = left;
          this.right = right;
      }
  
      @Override
      public int interpret(Context context) {
          return left.interpret(context) + right.interpret(context);
      }
  
      @Override
      public String toString() {
          return "(" + left.toString() + " + " + right.toString() + ")";
      }
  }
  // å‰‘æ³•ä»¿ç…§åŠ æ³•
  public class Minus extends AbstractExpression {...}
  ```

* ç¯å¢ƒç±»ï¼š

  ```java
  public class Context {
      private Map<Variable, Integer> map = new HashMap<Variable, Integer>();
  
      public void assign(Variable var, Integer value) {
          map.put(var, value);
      }
  
      public int getValue(Variable var) {
          Integer value = map.get(var);
          return value;
      }
  }
  ```

* æµ‹è¯•ç±»ï¼š

  ```java
   public static void main(String[] args) {
       Context context = new Context();
  
       Variable a = new Variable("a");
       Variable b = new Variable("b");
       Variable c = new Variable("c");
       Variable d = new Variable("d");
       Variable e = new Variable("e");
  
       context.assign(a, 1);
       context.assign(b, 2);
       context.assign(c, 3);
       context.assign(d, 4);
       context.assign(e, 5);
  
       AbstractExpression expression = new Minus(new Plus(new Plus(new Plus(a, b), c), d), e);
  
       System.out.println(expression + "= " + expression.interpret(context));
   }
  ```

  





